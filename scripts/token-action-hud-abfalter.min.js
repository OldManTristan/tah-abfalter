const e={ID:"token-action-hud-abfalter"},t={ID:"token-action-hud-core"},i="2.0",n={item:"tokenActionHud.template.item",utility:"tokenActionHud.utility"},s={armor:{id:"armor",name:"tokenActionHud.template.armor",type:"system"},equipment:{id:"equipment",name:"tokenActionHud.template.equipment",type:"system"},consumables:{id:"consumables",name:"tokenActionHud.template.consumables",type:"system"},containers:{id:"containers",name:"tokenActionHud.template.containers",type:"system"},treasure:{id:"treasure",name:"tokenActionHud.template.treasure",type:"system"},weapons:{id:"weapons",name:"tokenActionHud.template.weapons",type:"system"},combat:{id:"combat",name:"tokenActionHud.combat",type:"system"},token:{id:"token",name:"tokenActionHud.token",type:"system"},utility:{id:"utility",name:"tokenActionHud.utility",type:"system"},abilities:{id:"abilities",name:"tokenActionHud.abfalter.abilities",type:"system"},"fav-abilities":{id:"fav_abilities",name:"tokenActionHud.abfalter.abilities",type:"system"}},o={advantage:{groupId:"advantage"},disadvantage:{groupId:"disadvantage"},elan:{groupId:"elan"},proficiency:{groupId:"proficiency"},spell:{groupId:"spell"},spellPath:{groupId:"spellPath"},turnMaint:{groupId:"turnMaint"},dailyMaint:{groupId:"dailyMaint"},incarnation:{groupId:"incarnation"},invocation:{groupId:"invocation"},mentalPattern:{groupId:"mentalPattern"},psychicMatrix:{groupId:"psychicMatrix"},maintPower:{groupId:"maintPower"},discipline:{groupId:"discipline"},arsMagnus:{groupId:"arsMagnus"},martialArt:{groupId:"martialArt"},kiTechnique:{groupId:"kiTechnique"},kiSealCreature:{groupId:"kiSealCreature"},armor:{groupId:"armor"},armorHelmet:{groupId:"armorHelmet"},weapon:{groupId:"weapon"},ammo:{groupId:"ammo"},inventory:{groupId:"inventory"},currency:{groupId:"currency"},class:{groupId:"class"}};let r=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{r=class Utils{static getSetting(i,n=null){let s=n??null;try{s=game.settings.get(e.ID,i)}catch{t.api.Logger.debug(`Setting '${i}' not found`)}return s}static async setSetting(i,n){try{n=await game.settings.set(e.ID,i,n),t.api.Logger.debug(`Setting '${i}' set to '${n}'`)}catch{t.api.Logger.debug(`Setting '${i}' not found`)}}}}));let a=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{a=class ActionHandler extends e.api.ActionHandler{actors=null;actorId=null;actorType=null;tokenId=null;items=null;regAbilities=[];athAbilities=[];creaAbilities=[];intAbilities=[];perAbilities=[];socAbilities=[];subAbilities=[];vigAbilities=[];custAbilities=[];favAbilities=[];groupIds=null;activationGroupIds=null;effectGroupIds=null;inventoryGroupIds=null;spellGroupIds=null;featureActions=null;inventoryActions=null;spellActions=null;async buildSystemActions(e){console.log("Starting building system actions"),this.actors=this.actor?[this.actor]:this.#e(),this.actorType=this.actor?.type;if(!this.actorType||["character"].includes(this.actorType)){if(this.actor,this.actor){let e=this.actor.system.secondary,t=e.acrobatics;this.regAbilities.push(t),this.athAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.alchemy,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.animals,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.animism,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.appraisal,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.architecture,this.regAbilities.push(t),this.athAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.art,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.athleticism,this.regAbilities.push(t),this.athAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.climb,this.regAbilities.push(t),this.athAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.composure,this.regAbilities.push(t),this.vigAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.cooking,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.dance,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.disguise,this.regAbilities.push(t),this.subAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.etiquette,this.regAbilities.push(t),this.socAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.featsofstr,this.regAbilities.push(t),this.vigAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.forging,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.herballore,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.hide,this.regAbilities.push(t),this.subAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.history,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.intimidate,this.regAbilities.push(t),this.socAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.jewelry,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.jump,this.regAbilities.push(t),this.athAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.kiconceal,t||(this.regAbilities.push(t),this.subAbilities.push(t),t.fav&&this.favAbilities.push(t)),t=e.kidetection,t||(this.regAbilities.push(t),this.perAbilities.push(t),t.fav&&this.favAbilities.push(t)),t=e.law,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.leadership,this.regAbilities.push(t),this.socAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.lockpicking,this.regAbilities.push(t),this.subAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.magicappr,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.medicine,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.memorize,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.music,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.navigation,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.notice,this.regAbilities.push(t),this.perAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.occult,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.persuasion,this.regAbilities.push(t),this.socAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.piloting,this.regAbilities.push(t),this.athAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.poisons,this.regAbilities.push(t),this.subAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.ride,this.regAbilities.push(t),this.athAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.ritualcalig,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.runes,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.science,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.search,this.regAbilities.push(t),this.perAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.slofhand,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.stealth,this.regAbilities.push(t),this.subAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.streetwise,this.regAbilities.push(t),this.socAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.style,this.regAbilities.push(t),this.socAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.swin,this.regAbilities.push(t),this.athAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.tactics,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.tailoring,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.technomagic,this.regAbilities.push(t),this.intAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.theft,this.regAbilities.push(t),this.subAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.toymaking,this.regAbilities.push(t),this.creaAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.track,this.regAbilities.push(t),this.perAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.trading,this.regAbilities.push(t),this.socAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.traplore,this.regAbilities.push(t),this.subAbilities.push(t),t.fav&&this.favAbilities.push(t),t=e.withstpain,this.regAbilities.push(t),this.vigAbilities.push(t),t.fav&&this.favAbilities.push(t),this.actor.items.values().toArray().forEach((e=>{this.custAbilities.push(e),this.regAbilities.push(e)}))}this.displayUnequipped=r.getSetting("displayUnequipped"),"character"===this.actorType?this.#t():this.actor||this.#i()}}async#t(){console.log("Starting building character actions"),await Promise.all([this.#n()])}#i(){}async#s(){if(0===this.items.size)return;const t="item",i=new Map;for(const[e,t]of this.items){const n=t.type;if(t.equipped||this.displayUnequipped){const s=i.get(n)??new Map;s.set(e,t),i.set(n,s)}}for(const[s,r]of i){const i=o[s]?.groupId;if(!i)continue;const a={id:i,type:"system"},l=[...r].map((([i,s])=>{const o=i,r=s.name,a=e.api.Utils.i18n(n[t]),l=`${a?`${a}: `:""}${r}`,c=[t,o].join(this.delimiter);return{id:o,name:r,listName:l,encodedValue:c}}));this.addActions(l,a)}}async#n(){if(console.log("Starting building abilities actions"),0===this.abilities.size)return;const e="abilities",t=new Map;this.regAbilities.forEach((e=>{const i=e.type;let n=this.#o(e);const s=t.get(abilityType)??new Map;if(s.set(n,e),t.set(abilityType,s),isEquippedItem){const s=t.get(i)??new Map;s.set(n,e),t.set(i,s)}}));for(const[i,n]of t){const t=o[i]?.groupId;if(!t)continue;const s={id:t,type:"system"},r=await Promise.all([...n].map((async([t,i])=>{const n=this.#r(i),s=this.#a(i),o=this.#l(i,e),r=[e,n].join(this.delimiter);return{id:n,name:s,encodedValue:r,cssClass:cssClass,img:img,icon1:icon1,icon2:icon2,info:info,listName:o,tooltip:tooltip}})));this.addActions(r,s)}}#r(e,t,i){return`${e.id??e._id}`}#a(e){return e?.name??e?.label??""}#l(t,i){const s=this.#a(t),o=`${e.api.Utils.i18n(n[i])}: `??"";return t.listName??`${o}${s}`}#c(e,t,i){const n=e?.spellcasting?.id;return[t,"spell"===t?`${n}>${i}>${e.id??e._id}`:this.#r(e,t,i)].join(this.delimiter)}#e(){const e=["character"],t=canvas.tokens.controlled.map((e=>e.actor));if(t.every((t=>e.includes(t.type))))return t}#d(e){return{info1:{text:this.#u(e)??""}}}#u(e){const t=e?.system?.quantity?.value;return t>1?t:""}async#h(e,t,i=null){if("none"===this.tooltipsSetting||!e)return"";if("nameOnly"===this.tooltipsSetting)return e.name??"";let n;if(n=["elementalBlast","strike"].includes(t)?await e.item.getChatData():await e.getChatData(),!n)return"";switch(t){case"item":return{name:e.name,description:n.description?.value,rarity:n.rarity,traits:n.traits,traits2:n.properties};case"spell":return{name:e.name,description:n.description?.value,properties:n.properties,rarity:n.rarity,traits:n.traits,traitsAlt:n.spellTraits};case"strike":return{name:e.label,descriptionLocalised:"",modifiers:e.modifiers,properties:n.properties?.filter((e=>"PF2E.WeaponTypeMartial"!==e)),traits:e.traits,traitsAlt:e.weaponTraits};default:return{name:"elementalBlast"===t?e.item.name:e.name,description:n.description?.value,properties:n.properties,rarity:n.rarity,traits:n.traits}}}async#p(t,i){if("none"===this.tooltipsSetting)return"";const n=e.api.Utils.i18n(i.name);if("nameOnly"===this.tooltipsSetting)return n;if("string"==typeof i)return i;const s=`<h3>${n}</h3>`,o=e.api.Utils.i18n(i?.description??i?.descriptionLocalised??""),r=i?.rarity?`<span class="tag ${i.rarity.name}">${e.api.Utils.i18n(i.rarity.label)}</span>`:"",a=i?.properties?`<div class="tah-properties">${i.properties.map((t=>`<span class="tah-property">${e.api.Utils.i18n(t)}</span>`)).join("")}</div>`:"",l=i?.traits?i.traits.map((t=>`<span class="tag">${e.api.Utils.i18n(t.label)}</span>`)).join(""):"",c=i?.traits2?i.traits2.map((t=>`<span class="tag tag_secondary">${e.api.Utils.i18n(t.label??t)}</span>`)).join(""):"",d=i?.traitsAlt?i.traitsAlt.map((t=>`<span class="tag tag_alt">${e.api.Utils.i18n(t.label)}</span>`)).join(""):"",u=i?.modifiers?`<div class="tags">${i.modifiers.filter((e=>e.enabled)).map((t=>`<span class="tag tag_transparent">${e.api.Utils.i18n(t.label)} ${`${t.modifier>=0?"+":""}${t.modifier??""}`}</span>`)).join("")}</div>`:"",h=[r,l,c,d].join(""),p=h?`<div class="tags">${h}</div>`:"";if(!o&&!p&&!u)return n;const g=`<div>${s}${p||u?`<div class="tah-tags-wrapper">${p}${u}</div>`:""}${o}${a}</div>`;return await TextEditor.enrichHTML(g,{async:!0})}#o(e){let t=0,i=JSON.stringify(e);for(let e=0;e<i.length;e++){t=(t<<5)-t+i.charCodeAt(e)}return(t>>>0).toString(36).padStart(7,"0")}}}));const l=globalThis.vtt="Foundry VTT";let c=globalThis.game={};PIXI.LegacyGraphics=PIXI.Graphics,PIXI.Graphics=PIXI.smooth.SmoothGraphics,globalThis.SIGNED_EULA=SIGNED_EULA,globalThis.ROUTE_PREFIX=ROUTE_PREFIX,globalThis.MESSAGES=MESSAGES||[],globalThis.ui={windows:{}},logger=globalThis.logger=console,globalThis.Color=foundry.utils.Color;class ClipboardHelper{constructor(){if(c.clipboard instanceof this.constructor)throw new Error("You may not re-initialize the singleton ClipboardHelper. Use game.clipboard instead.")}async copyPlainText(e){try{const t=await navigator.permissions.query({name:"clipboard-write"});if(["granted","prompt"].includes(t.state))return navigator.clipboard.writeText(e)}catch(e){}document.addEventListener("copy",(t=>{t.clipboardData.setData("text/plain",e),t.preventDefault()}),{once:!0}),document.execCommand("copy")}}class DocumentIndex{constructor(){Object.defineProperty(this,"trees",{value:{}}),Object.defineProperty(this,"uuids",{value:{}})}#g=null;get ready(){return this.#g}async index(){await this.#g;const e=CONST.WORLD_DOCUMENT_TYPES.filter((e=>{const t=getDocumentClass(e);return t.metadata.indexed&&t.schema.has("name")})),t=performance.now();return this.#g=new Promise((i=>{for(const t of e)this._indexWorldCollection(t);for(const t of c.packs)e.includes(t.documentName)&&this._indexCompendium(t);i(),console.debug(`${l} | Document indexing complete in ${performance.now()-t}ms.`)}))}lookup(e,{limit:t=10,documentTypes:i=[],ownership:n,filterEntries:s}={}){const o=i.length?i:Object.keys(this.trees);if(void 0!==n){const e=s??(()=>!0);s=t=>e(t)&&DocumentIndex.#m(t,n)}const r={};for(const i of o){r[i]=[];const n=this.trees[i];n&&r[i].push(...n.lookup(e,{limit:t,filterEntries:s}))}return r}addDocument(e){if(e.pack){if(e.isEmbedded)return;const t=c.packs.get(e.pack),i=t.index.get(e.id);i&&this._addLeaf(i,{pack:t})}else this._addLeaf(e)}removeDocument(e){const t=this.uuids[e.uuid];t&&(t[foundry.utils.StringTree.leaves].findSplice((t=>t.uuid===e.uuid)),delete this.uuids[e.uuid])}replaceDocument(e){this.removeDocument(e),this.addDocument(e)}_addLeaf(e,{pack:t}={}){const i={entry:e,documentName:e.documentName,uuid:e.uuid};t&&foundry.utils.mergeObject(i,{documentName:t.documentName,uuid:`Compendium.${t.collection}.${e._id}`,pack:t.collection});const n=this.trees[i.documentName]??=new foundry.utils.WordTree;this.uuids[i.uuid]=n.addLeaf(e.name,i)}_indexCompendium(e){for(const t of e.index)this._addLeaf(t,{pack:e})}_indexEmbeddedDocuments(e){const t=e.constructor.metadata.embedded;for(const i of Object.keys(t))if(g[i].documentClass.metadata.indexed)for(const n of e[t[i]])this._addLeaf(n)}_indexWorldCollection(e){const t=g[e].documentClass.metadata.collection;for(const e of c[t])this._addLeaf(e),this._indexEmbeddedDocuments(e)}static#m({uuid:e,pack:t},i){return t?c.packs.get(t)?.testUserPermission(c.user,i):fromUuidSync(e)?.testUserPermission(c.user,i)}}class GamepadManager{constructor(){this._gamepadPoller=null,this._connectedGamepads=new Map}static GAMEPAD_POLLER_INTERVAL_MS=100;_activateListeners(){window.addEventListener("gamepadconnected",this._onGamepadConnect.bind(this)),window.addEventListener("gamepaddisconnected",this._onGamepadDisconnect.bind(this))}_onGamepadConnect(e){g.debug.gamepad&&console.log(`Gamepad ${e.gamepad.id} connected`),this._connectedGamepads.set(e.gamepad.id,{axes:new Map,activeButtons:new Set}),this._gamepadPoller||(this._gamepadPoller=setInterval((()=>{this._pollGamepads()}),GamepadManager.GAMEPAD_POLLER_INTERVAL_MS)),this._pollGamepads()}_onGamepadDisconnect(e){g.debug.gamepad&&console.log(`Gamepad ${e.gamepad.id} disconnected`),this._connectedGamepads.delete(e.gamepad.id),0===this._connectedGamepads.length&&(clearInterval(this._gamepadPoller),this._gamepadPoller=null)}_pollGamepads(){for(let e of navigator.getGamepads()){if(!e||!this._connectedGamepads.has(e?.id))continue;const t=e.id;let i=this._connectedGamepads.get(t);for(let n=0;n<e.axes.length;n++){let s=e.axes[n];if(Math.abs(s)>1)continue;Math.abs(s)<=.15&&(s=0);const o=`${t}_AXIS${n}`,r=i.axes.get(o)??0;if(0!==s){const e=Math.sign(s),t=e===Math.sign(r),i=`${o}_${e>0?"POSITIVE":"NEGATIVE"}`;this._handleGamepadInput(i,!1,t)}else if(0!==r){const e=`${o}_${Math.sign(r)>0?"POSITIVE":"NEGATIVE"}`;this._handleGamepadInput(e,!0)}i.axes.set(o,s)}for(let n=0;n<e.buttons.length;n++){const s=`${t}_BUTTON${n}_PRESSED`;if(e.buttons[n].pressed){const e=i.activeButtons.has(s);e||i.activeButtons.add(s),this._handleGamepadInput(s,!1,e)}else i.activeButtons.has(s)&&(i.activeButtons.delete(s),this._handleGamepadInput(s,!0))}}}_handleGamepadInput(e,t,i=!1){const n=e.replaceAll(" ","").toUpperCase().trim(),s=new KeyboardEvent("key"+(t?"up":"down"),{code:n,bubbles:!0});window.dispatchEvent(s),$(".binding-input:focus").get(0)?.dispatchEvent(s)}}class Hooks$1{static get events(){return this.#f}static#f={};static#v=new Map;static#y=1;static on(e,t,{once:i=!1}={}){console.debug(`${l} | Registered callback for ${e} hook`);const n=this.#y++;e in this.#f||Object.defineProperty(this.#f,e,{value:[],writable:!1});const s={hook:e,id:n,fn:t,once:i};return this.#f[e].push(s),this.#v.set(n,s),n}static once(e,t){return this.on(e,t,{once:!0})}static off(e,t){let i;if("number"==typeof t){const e=t;if(i=this.#v.get(e),!i)return;this.#v.delete(e);this.#f[i.hook].findSplice((t=>t.id===e))}else{const i=this.#f[e].findSplice((e=>e.fn===t));if(!i)return;this.#v.delete(i.id)}console.debug(`${l} | Unregistered callback for ${e} hook`)}static callAll(e,...t){if(g.debug.hooks&&(console.log(`DEBUG | Calling ${e} hook with args:`),console.log(t)),!(e in this.#f))return!0;for(const i of Array.from(this.#f[e]))this.#b(i,t);return!0}static call(e,...t){if(g.debug.hooks&&(console.log(`DEBUG | Calling ${e} hook with args:`),console.log(t)),!(e in this.#f))return!0;for(const i of Array.from(this.#f[e])){if(!1===this.#b(i,t))return!1}return!0}static#b(e,t){const{hook:i,id:n,fn:s,once:o}=e;o&&this.off(i,n);try{return e.fn(...t)}catch(e){const t=`Error thrown in hooked function '${s?.name}' for hook '${i}'`;console.warn(`${l} | ${t}`),"error"!==i&&this.onError("Hooks.#call",e,{msg:t,hook:i,fn:s,log:"error"})}}static onError(e,t,{msg:i="",notify:n=null,log:s=null,...o}={}){t instanceof Error&&(i&&(t=new Error(`${i}. ${t.message}`,{cause:t})),s&&console[s]?.(t),n&&ui.notifications[n]?.(i||t.message),Hooks$1.callAll("error",e,t,o))}}class ImageHelper{static async createThumbnail(e,{width:t,height:i,tx:n,ty:s,center:o,format:r,quality:a}){if(!e)return null;let l=e;if(!(e instanceof PIXI.DisplayObject)){const t=await loadTexture(e);l=PIXI.Sprite.from(t)}!canvas.ready&&canvas.initializing&&await canvas.initializing;const c=this.compositeCanvasTexture(l,{width:t,height:i,tx:n,ty:s,center:o}),d=await this.textureToImage(c,{format:r,quality:a});return c.destroy(!0),{src:e,texture:c,thumb:d,width:l.width,height:l.height}}static hasImageExtension(e){return foundry.data.validators.hasFileExtension(e,Object.keys(CONST.IMAGE_FILE_EXTENSIONS))}static compositeCanvasTexture(e,{width:t,height:i,tx:n=0,ty:s=0,center:o=!0}={}){if(!canvas.app?.renderer)throw new Error("Unable to compose texture because there is no game canvas");t=t??e.width,i=i??e.height;const r=e.width/e.height>t/i?i/e.height:t/e.width,a=PIXI.Matrix.IDENTITY.clone();a.scale(r,r),o?(n=(t-e.width*r)/2,s=(i-e.height*r)/2):(n*=r,s*=r),a.translate(n,s);const l=PIXI.RenderTexture.create({width:t,height:i,scaleMode:PIXI.SCALE_MODES.LINEAR,resolution:canvas.app.renderer.resolution});return canvas.app.renderer.render(e,{renderTexture:l,transform:a}),l}static async textureToImage(e,{format:t,quality:i}={}){const n=new PIXI.Sprite(e);return canvas.app.renderer.extract.base64(n,t,i)}static async pixiToBase64(e,t,i){const n=canvas.app.renderer.extract.canvas(e);return this.canvasToBase64(n,t,i)}static async canvasToBase64(e,t,i){return new Promise(((n,s)=>{e.toBlob((e=>{const t=new FileReader;t.onload=()=>n(t.result),t.onerror=s,t.readAsDataURL(e)}),t,i)}))}static async uploadBase64(e,t,i,{storage:n="data",type:s,notify:o=!0}={}){s||=e.split(";")[0].split("data:")[1];const r=await fetch(e).then((e=>e.blob())),a=new File([r],t,{type:s});return FilePicker.upload(n,i,a,{},{notify:o})}static pixelsToCanvas(e,t,i,{element:n,ew:s,eh:o}={}){n??=document.createElement("canvas"),n.width=s??t,n.height=o??i;const r=n.getContext("2d"),a=new ImageData(e,t,i);return r.putImageData(a,0,0),n}}class ClientIssues{#S=new Map;#T={};#E={};static#C={WIDTH:1024,HEIGHT:700};static#_={Electron:{minimum:29,match:/Electron\/(\d+)\./,message:"ERROR.ElectronVersion"},Chromium:{minimum:105,match:/Chrom(?:e|ium)\/(\d+)\./,message:"ERROR.BrowserVersion"},Firefox:{minimum:121,match:/Firefox\/(\d+)\./,message:"ERROR.BrowserVersion"},Safari:{minimum:15.4,match:/Version\/(\d+)\..*Safari\//,message:"ERROR.BrowserVersion"}};#I(e,t,{decrement:i=!1}={}){if("string"!=typeof t||!t.includes("."))return;const[n,...s]=t.split(".");t=s.join("."),this.#S.has(n)||this.#S.set(n,{});const o=this.#S.get(n),r=o[e]??={};r[t]??=0,i?r[t]=Math.max(r[t]-1,0):r[t]++}#w(){for(const[e,{minimum:t,match:i,message:n}]of Object.entries(ClientIssues.#_)){const[,s]=navigator.userAgent.match(i)??[];if(Number.isNumeric(s)){if(Number(s)<t){const i=c.i18n.format(n,{browser:e,version:s,minimum:t});ui.notifications?.error(i,{permanent:!0,console:!0}),this.#E.browserVersionIncompatible={message:n,severity:"error",params:{browser:e,version:s,minimum:t}}}break}}}#D;#O(){const{WIDTH:e,HEIGHT:t}=ClientIssues.#C,{innerWidth:i,innerHeight:n}=window;n<t||i<e?(ui.notifications&&!this.#D&&(this.#D=ui.notifications.error(c.i18n.format("ERROR.LowResolution",{width:i,reqWidth:e,height:n,reqHeight:t}),{permanent:!0})),this.#E.resolutionTooLow={message:"ERROR.LowResolution",severity:"error",params:{width:i,reqWidth:e,height:n,reqHeight:t}}):(this.#D&&(this.#D=ui.notifications.remove(this.#D)),delete this.#E.resolutionTooLow)}_detectWebGLIssues(){const e=canvas.app.renderer.context;try{const t=SupportDetails.getWebGLRendererInfo(e.gl);/swiftshader/i.test(t)&&(ui.notifications.warn("ERROR.NoHardwareAcceleration",{localize:!0,permanent:!0}),this.#E.hardwareAccel={message:"ERROR.NoHardwareAcceleration",severity:"error"})}catch(e){ui.notifications.warn("ERROR.RendererNotDetected",{localize:!0,permanent:!0}),this.#E.noRenderer={message:"ERROR.RendererNotDetected",severity:"warning"}}canvas.supported.webGL2||(ui.notifications.error("ERROR.NoWebGL2",{localize:!0,permanent:!0}),this.#E.webgl2={message:"ERROR.NoWebGL2",severity:"error"})}_countDocumentSubType(e,t,i={}){e.hasTypeData&&this.#I(e.documentName,t.type,i);for(const[n,s]of Object.entries(e.hierarchy))if(s instanceof foundry.data.fields.EmbeddedCollectionField)for(const e of t[n])this._countDocumentSubType(s.model,e,i)}_trackValidationFailure(e,t,i){if(!(e instanceof WorldCollection))return;if(!(i instanceof foundry.data.validation.DataModelValidationError))return;const n=e.documentName;this.#T[n]??={},this.#T[n][t._id]={name:t.name,error:i}}_detectUsabilityIssues(){this.#O(),this.#w(),window.addEventListener("resize",foundry.utils.debounce(this.#O.bind(this),250),{passive:!0})}getSubTypeCountsFor(e){return this.#S.get(e.id??e)}getAllSubTypeCounts(){return this.#S.entries()}get validationFailures(){return this.#T}get usabilityIssues(){return this.#E}get packageCompatibilityIssues(){return c.data.packageWarnings}}class ClientKeybindings{constructor(){this.actions=new Map,this.activeKeys=new Map,this.bindings=void 0,this._registered=0,this._moveTime=0}static MOVEMENT_DIRECTIONS={UP:"up",LEFT:"left",DOWN:"down",RIGHT:"right"};static ZOOM_DIRECTIONS={IN:"in",OUT:"out"};get moveKeys(){return c.keyboard.moveKeys}initialize(){this.bindings=new Map(Object.entries(c.settings.get("core","keybindings")));for(let e of Array.from(this.bindings.keys()))this.actions.has(e)||this.bindings.delete(e);for(let[e,t]of this.actions){let i=t.uneditable;i=t.uneditable.concat(this.bindings.get(e)??t.editable),this.bindings.set(e,i)}this.activeKeys=new Map;for(let[e,t]of this.actions){let i=this.bindings.get(e);for(let n of i){if(!n)continue;this.activeKeys.has(n.key)||this.activeKeys.set(n.key,[]);let i=this.activeKeys.get(n.key);i.push({action:e,key:n.key,name:t.name,requiredModifiers:n.modifiers,optionalModifiers:t.reservedModifiers,onDown:t.onDown,onUp:t.onUp,precedence:t.precedence,order:t.order,repeat:t.repeat,restricted:t.restricted}),this.activeKeys.set(n.key,i.sort(this.constructor._compareActions))}}}register(e,t,i){if(this.bindings)throw new Error("You cannot register a Keybinding after the init hook");if(!e||!t)throw new Error("You must specify both the namespace and action portion of the Keybinding action");t=`${e}.${t}`,i.namespace=e,i.precedence=i.precedence??CONST.KEYBINDING_PRECEDENCE.NORMAL,i.order=this._registered++,i.uneditable=this.constructor._validateBindings(i.uneditable??[]),i.editable=this.constructor._validateBindings(i.editable??[]),i.repeat=i.repeat??!1,i.reservedModifiers=this.constructor._validateModifiers(i.reservedModifiers??[]),this.actions.set(t,i)}get(e,t){if(!e||!t)throw new Error("You must specify both namespace and key portions of the keybind");t=`${e}.${t}`;if(!this.actions.get(t))throw new Error("This is not a registered keybind action");return this.bindings.get(t)||[]}async set(e,t,i){if(!e||!t)throw new Error("You must specify both namespace and action portions of the Keybind");t=`${e}.${t}`;const n=this.actions.get(t);if(!n)throw new Error("This is not a registered keybind");if(n.restricted&&!c.user.isGM)throw new Error("Only a GM can edit this keybind");const s=c.settings.get("core","keybindings");if(void 0===i)return delete s[t],c.settings.set("core","keybindings",s);i=this.constructor._validateBindings(i);for(let e of i)if(n.reservedModifiers.includes(e.key))throw new Error(c.i18n.format("KEYBINDINGS.ErrorReservedModifier",{key:e.key}));s[t]=i,await c.settings.set("core","keybindings",s)}async resetDefaults(){const e=c.settings.settings.get("core.keybindings");return c.settings.set("core","keybindings",e.default)}static _validateBindings(e){if(!(e instanceof Array))throw new Error(c.i18n.localize("KEYBINDINGS.MustBeArray"));for(let t of e){if(!t.key)throw new Error("Each KeybindingActionBinding must contain a valid key designation");if(KeyboardManager.PROTECTED_KEYS.includes(t.key))throw new Error(c.i18n.format("KEYBINDINGS.ErrorProtectedKey",{key:t.key}));t.modifiers=this._validateModifiers(t.modifiers??[])}return e}static _validateModifiers(e){const t=[];for(let i of e){if(i in KeyboardManager.MODIFIER_KEYS&&(i=KeyboardManager.MODIFIER_KEYS[i]),!Object.values(KeyboardManager.MODIFIER_KEYS).includes(i))throw new Error(c.i18n.format("KEYBINDINGS.ErrorIllegalModifier",{key:i,allowed:t.join(",")}));t.push(i)}return t}static _compareActions(e,t){return e.precedence===t.precedence?e.order-t.order:e.precedence-t.precedence}_registerCoreKeybindings(e){const{SHIFT:t,CONTROL:i,ALT:n}=KeyboardManager.MODIFIER_KEYS;if(c.keybindings.register("core","dismiss",{name:"KEYBINDINGS.Dismiss",uneditable:[{key:"Escape"}],onDown:ClientKeybindings._onDismiss,precedence:CONST.KEYBINDING_PRECEDENCE.DEFERRED}),"game"===e){c.keybindings.register("core","cycleView",{name:"KEYBINDINGS.CycleView",editable:[{key:"Tab"}],onDown:ClientKeybindings._onCycleView,reservedModifiers:[t],repeat:!0}),c.keybindings.register("core","measuredRulerMovement",{name:"KEYBINDINGS.MoveAlongMeasuredRuler",editable:[{key:"Space"}],onDown:ClientKeybindings._onMeasuredRulerMovement,precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,reservedModifiers:[t,i]}),c.keybindings.register("core","pause",{name:"KEYBINDINGS.Pause",restricted:!0,editable:[{key:"Space"}],onDown:ClientKeybindings._onPause,precedence:CONST.KEYBINDING_PRECEDENCE.DEFERRED}),c.keybindings.register("core","delete",{name:"KEYBINDINGS.Delete",uneditable:[{key:"Delete"}],editable:[{key:"Backspace"}],onDown:ClientKeybindings._onDelete}),c.keybindings.register("core","highlight",{name:"KEYBINDINGS.Highlight",editable:[{key:"AltLeft"},{key:"AltRight"}],onUp:ClientKeybindings._onHighlight,onDown:ClientKeybindings._onHighlight}),c.keybindings.register("core","selectAll",{name:"KEYBINDINGS.SelectAll",uneditable:[{key:"KeyA",modifiers:[i]}],onDown:ClientKeybindings._onSelectAllObjects}),c.keybindings.register("core","undo",{name:"KEYBINDINGS.Undo",uneditable:[{key:"KeyZ",modifiers:[i]}],onDown:ClientKeybindings._onUndo}),c.keybindings.register("core","copy",{name:"KEYBINDINGS.Copy",uneditable:[{key:"KeyC",modifiers:[i]}],onDown:ClientKeybindings._onCopy}),c.keybindings.register("core","paste",{name:"KEYBINDINGS.Paste",uneditable:[{key:"KeyV",modifiers:[i]}],onDown:ClientKeybindings._onPaste,reservedModifiers:[n,t]}),c.keybindings.register("core","sendToBack",{name:"KEYBINDINGS.SendToBack",editable:[{key:"BracketLeft"}],onDown:ClientKeybindings.#x}),c.keybindings.register("core","bringToFront",{name:"KEYBINDINGS.BringToFront",editable:[{key:"BracketRight"}],onDown:ClientKeybindings.#N}),c.keybindings.register("core","target",{name:"KEYBINDINGS.Target",editable:[{key:"KeyT"}],onDown:ClientKeybindings._onTarget,reservedModifiers:[t]}),c.keybindings.register("core","characterSheet",{name:"KEYBINDINGS.ToggleCharacterSheet",editable:[{key:"KeyC"}],onDown:ClientKeybindings._onToggleCharacterSheet,precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY}),c.keybindings.register("core","panUp",{name:"KEYBINDINGS.PanUp",uneditable:[{key:"ArrowUp"},{key:"Numpad8"}],editable:[{key:"KeyW"}],onUp:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.UP]),onDown:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.UP]),reservedModifiers:[i,t],repeat:!0}),c.keybindings.register("core","panLeft",{name:"KEYBINDINGS.PanLeft",uneditable:[{key:"ArrowLeft"},{key:"Numpad4"}],editable:[{key:"KeyA"}],onUp:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.LEFT]),onDown:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.LEFT]),reservedModifiers:[i,t],repeat:!0}),c.keybindings.register("core","panDown",{name:"KEYBINDINGS.PanDown",uneditable:[{key:"ArrowDown"},{key:"Numpad2"}],editable:[{key:"KeyS"}],onUp:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.DOWN]),onDown:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.DOWN]),reservedModifiers:[i,t],repeat:!0}),c.keybindings.register("core","panRight",{name:"KEYBINDINGS.PanRight",uneditable:[{key:"ArrowRight"},{key:"Numpad6"}],editable:[{key:"KeyD"}],onUp:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.RIGHT]),onDown:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.RIGHT]),reservedModifiers:[i,t],repeat:!0}),c.keybindings.register("core","panUpLeft",{name:"KEYBINDINGS.PanUpLeft",uneditable:[{key:"Numpad7"}],onUp:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.UP,ClientKeybindings.MOVEMENT_DIRECTIONS.LEFT]),onDown:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.UP,ClientKeybindings.MOVEMENT_DIRECTIONS.LEFT]),reservedModifiers:[i,t],repeat:!0}),c.keybindings.register("core","panUpRight",{name:"KEYBINDINGS.PanUpRight",uneditable:[{key:"Numpad9"}],onUp:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.UP,ClientKeybindings.MOVEMENT_DIRECTIONS.RIGHT]),onDown:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.UP,ClientKeybindings.MOVEMENT_DIRECTIONS.RIGHT]),reservedModifiers:[i,t],repeat:!0}),c.keybindings.register("core","panDownLeft",{name:"KEYBINDINGS.PanDownLeft",uneditable:[{key:"Numpad1"}],onUp:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.DOWN,ClientKeybindings.MOVEMENT_DIRECTIONS.LEFT]),onDown:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.DOWN,ClientKeybindings.MOVEMENT_DIRECTIONS.LEFT]),reservedModifiers:[i,t],repeat:!0}),c.keybindings.register("core","panDownRight",{name:"KEYBINDINGS.PanDownRight",uneditable:[{key:"Numpad3"}],onUp:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.DOWN,ClientKeybindings.MOVEMENT_DIRECTIONS.RIGHT]),onDown:e=>this._onPan(e,[ClientKeybindings.MOVEMENT_DIRECTIONS.DOWN,ClientKeybindings.MOVEMENT_DIRECTIONS.RIGHT]),reservedModifiers:[i,t],repeat:!0}),c.keybindings.register("core","zoomIn",{name:"KEYBINDINGS.ZoomIn",uneditable:[{key:"NumpadAdd"}],editable:[{key:"PageUp"}],onDown:e=>{ClientKeybindings._onZoom(e,ClientKeybindings.ZOOM_DIRECTIONS.IN)},repeat:!0}),c.keybindings.register("core","zoomOut",{name:"KEYBINDINGS.ZoomOut",uneditable:[{key:"NumpadSubtract"}],editable:[{key:"PageDown"}],onDown:e=>{ClientKeybindings._onZoom(e,ClientKeybindings.ZOOM_DIRECTIONS.OUT)},repeat:!0});for(const e of Array.fromRange(9,1).concat([0]))c.keybindings.register("core",`executeMacro${e}`,{name:c.i18n.format("KEYBINDINGS.ExecuteMacro",{number:e}),editable:[{key:`Digit${e}`}],onDown:t=>ClientKeybindings._onMacroExecute(t,e),precedence:CONST.KEYBINDING_PRECEDENCE.DEFERRED});for(const e of Array.fromRange(5,1))c.keybindings.register("core",`swapMacroPage${e}`,{name:c.i18n.format("KEYBINDINGS.SwapMacroPage",{page:e}),editable:[{key:`Digit${e}`,modifiers:[n]}],onDown:t=>ClientKeybindings._onMacroPageSwap(t,e),precedence:CONST.KEYBINDING_PRECEDENCE.DEFERRED});c.keybindings.register("core","pushToTalk",{name:"KEYBINDINGS.PTTKey",editable:[{key:"Backquote"}],onDown:c.webrtc._onPTTStart.bind(c.webrtc),onUp:c.webrtc._onPTTEnd.bind(c.webrtc),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,repeat:!1}),c.keybindings.register("core","focusChat",{name:"KEYBINDINGS.FocusChat",editable:[{key:"KeyC",modifiers:[t]}],onDown:ClientKeybindings._onFocusChat,precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,repeat:!1})}}static _onSelectAllObjects(e){return!!canvas.ready&&(canvas.activeLayer.controlAll(),!0)}static _onCycleView(e){if(!canvas.ready)return!1;if(canvas.tokens.active){canvas.tokens.cycleTokens(!e.isShift,!1)||canvas.recenter()}return!0}static async _onDismiss(e){if(canvas.ready&&canvas.fog.commit(),ui.context&&ui.context.menu.length)return await ui.context.close(),!0;if(Tour.tourInProgress)return Tour.activeTour.exit(),!0;const t=[];for(const e of Object.values(ui.windows))t.push(e.close({closeKey:!0}).then((()=>!e.rendered)));for(const e of foundry.applications.instances.values())e.hasFrame&&t.push(e.close({closeKey:!0}).then((()=>!e.rendered)));return!!(await Promise.all(t)).some((e=>e))||("game"===c.view?c.user.isGM&&canvas.activeLayer instanceof PlaceablesLayer&&canvas.activeLayer.controlled.length?(canvas.activeLayer.preview?.children.length||canvas.activeLayer.releaseAll(),!0):(ui.menu.toggle(),canvas.ready&&await canvas.fog.save(),!0):void 0)}static _onToggleCharacterSheet(e){return c.toggleCharacterSheet()}static _onTarget(e){if(!canvas.ready)return!1;const t=canvas.activeLayer;if(!(t instanceof TokenLayer))return!1;const i=t.hover;return!(!i||i.document.isSecret)&&(i.setTarget(!i.isTargeted,{releaseOthers:!e.isShift}),!0)}static#x(e){return!!canvas.ready&&(canvas.activeLayer?._sendToBackOrBringToFront(!1)??!1)}static#N(e){return!!canvas.ready&&(canvas.activeLayer?._sendToBackOrBringToFront(!0)??!1)}static _onDelete(e){return ui.hotbar._hover?(c.user.assignHotbarMacro(null,ui.hotbar._hover),!0):canvas.ready&&canvas.activeLayer instanceof PlaceablesLayer?(canvas.activeLayer._onDeleteKey(e.event),!0):void 0}_handleMovement(e,t){if(!this.moveKeys.size)return;if(0===t.placeables.filter((e=>e.controlled)).length)return;let i=this.moveKeys;const n=canvas.grid;n.type!==CONST.GRID_TYPES.SQUARE||n.diagonals!==CONST.GRID_DIAGONALS.ILLEGAL||(i=new Set(Array.from(i).slice(-1)));let s=0,o=0;i.has(ClientKeybindings.MOVEMENT_DIRECTIONS.LEFT)&&(s-=1),i.has(ClientKeybindings.MOVEMENT_DIRECTIONS.RIGHT)&&(s+=1),i.has(ClientKeybindings.MOVEMENT_DIRECTIONS.UP)&&(o-=1),i.has(ClientKeybindings.MOVEMENT_DIRECTIONS.DOWN)&&(o+=1),t.moveMany({dx:s,dy:o,rotate:e.isShift})}_handleCanvasPan(){let e=0,t=0;this.moveKeys.has(ClientKeybindings.MOVEMENT_DIRECTIONS.LEFT)&&(e-=1),this.moveKeys.has(ClientKeybindings.MOVEMENT_DIRECTIONS.UP)&&(t-=1),this.moveKeys.has(ClientKeybindings.MOVEMENT_DIRECTIONS.RIGHT)&&(e+=1),this.moveKeys.has(ClientKeybindings.MOVEMENT_DIRECTIONS.DOWN)&&(t+=1),this.moveKeys.clear();const i=canvas.dimensions.size;return canvas.animatePan({x:canvas.stage.pivot.x+e*i,y:canvas.stage.pivot.y+t*i,duration:100})}static _onMeasuredRulerMovement(e){if(!canvas.ready)return;const t=canvas.controls.ruler;return t.state===Ruler.STATES.MEASURING?(t._onMoveKeyDown(e),!0):void 0}static _onPause(e){return c.togglePause(void 0,!0),!0}static _onHighlight(e){return!!canvas.ready&&(canvas.highlightObjects(!e.up),!0)}_onPan(e,t){if(Tour.tourInProgress&&!e.repeat&&!e.up)return Tour.onMovementAction(t),!0;if(!canvas.ready)return!1;if(e.up){for(let e of t)this.moveKeys.delete(e);return!0}const i=Date.now(),n=i-this._moveTime;for(let e of t)this.moveKeys.add(e);if(e.isControl)return!["KeyW","KeyA","KeyS","KeyD"].includes(e.key)&&(this._handleCanvasPan(),!0);const s=canvas.activeLayer;if(s===canvas.tokens||s===canvas.tiles){if(n<100)return!0;setTimeout((()=>this._handleMovement(e,s)),50)}return this._moveTime=i,!0}static _onMacroExecute(e,t){const i=ui.hotbar.macros.find((e=>e.key===t));return!!i.macro&&(i.macro.execute(),!0)}static _onMacroPageSwap(e,t){return ui.hotbar.changePage(t),!0}static _onCopy(e){if(""!==window.getSelection().toString())return!1;if(!canvas.ready)return!1;let t=canvas.activeLayer;return t instanceof PlaceablesLayer&&t.copyObjects(),!0}static _onPaste(e){if(!canvas.ready)return!1;let t=canvas.activeLayer;if(t instanceof PlaceablesLayer&&t._copy.length){const i=canvas.mousePosition;return t.pasteObjects(i,{hidden:e.isAlt,snap:!e.isShift}),!0}}static _onUndo(e){if(!canvas.ready)return!1;const t=canvas.activeLayer;return t instanceof PlaceablesLayer&&(t.undoHistory(),!0)}static _onZoom(e,t){if(!canvas.ready)return!1;const i=t===ClientKeybindings.ZOOM_DIRECTIONS.IN?1.05:.95;return canvas.animatePan({scale:i*canvas.stage.scale.x,duration:100}),!0}static _onFocusChat(e){const t=ui.sidebar._element[0];if(ui.sidebar.activateTab(ui.chat.tabName),t.classList.contains("collapsed")&&!ui.chat._popout){const e=ui.chat.createPopout();e._render(!0).then((()=>{e.element.find("#chat-message").focus()}))}else ui.chat.element.find("#chat-message").focus();return!0}}class KeyboardManager{constructor(){this._reset()}_activateListeners(){window.addEventListener("keydown",(e=>this._handleKeyboardEvent(e,!1))),window.addEventListener("keyup",(e=>this._handleKeyboardEvent(e,!0))),window.addEventListener("visibilitychange",this._reset.bind(this)),window.addEventListener("compositionend",this._onCompositionEnd.bind(this)),window.addEventListener("focusin",this._onFocusIn.bind(this))}downKeys=new Set;moveKeys=new Set;static MODIFIER_KEYS={CONTROL:"Control",SHIFT:"Shift",ALT:"Alt"};static MODIFIER_CODES={[this.MODIFIER_KEYS.ALT]:["AltLeft","AltRight"],[this.MODIFIER_KEYS.CONTROL]:["ControlLeft","ControlRight","MetaLeft","MetaRight","Meta","OsLeft","OsRight"],[this.MODIFIER_KEYS.SHIFT]:["ShiftLeft","ShiftRight"]};static PROTECTED_KEYS=["F5","F11","F12","PrintScreen","ScrollLock","NumLock","CapsLock"];static CONTROL_KEY_STRING=navigator.appVersion.includes("Mac")?"âŒ˜":"Control";static KEYCODE_DISPLAY_MAPPING=(()=>{const e=navigator.appVersion.includes("Mac");return{ArrowLeft:e?"â†":"ðŸ¡¸",ArrowRight:e?"â†’":"ðŸ¡º",ArrowUp:e?"â†‘":"ðŸ¡¹",ArrowDown:e?"â†“":"ðŸ¡»",Backquote:"`",Backslash:"\\",BracketLeft:"[",BracketRight:"]",Comma:",",Control:this.CONTROL_KEY_STRING,Equal:"=",Meta:e?"âŒ˜":"âŠž",MetaLeft:e?"âŒ˜":"âŠž",MetaRight:e?"âŒ˜":"âŠž",OsLeft:e?"âŒ˜":"âŠž",OsRight:e?"âŒ˜":"âŠž",Minus:"-",NumpadAdd:"Numpad+",NumpadSubtract:"Numpad-",Period:".",Quote:"'",Semicolon:";",Slash:"/"}})();get hasFocus(){return document.querySelector(":focus")instanceof HTMLElement}static emulateKeypress(e,t,{altKey:i=!1,ctrlKey:n=!1,shiftKey:s=!1,repeat:o=!1,force:r=!1}={}){const a=new KeyboardEvent("key"+(e?"up":"down"),{code:t,altKey:i,ctrlKey:n,shiftKey:s,repeat:o}),l=this.getKeyboardEventContext(a,e);return c.keyboard._processKeyboardContext(l,{force:r}),c.keyboard.downKeys.delete(l.key),l}static getKeycodeDisplayString(e){return e in this.KEYCODE_DISPLAY_MAPPING?this.KEYCODE_DISPLAY_MAPPING[e]:e.startsWith("Digit")?e.replace("Digit",""):e.startsWith("Key")?e.replace("Key",""):e}static getKeyboardEventContext(e,t=!1){let i={event:e,key:e.code,isShift:e.shiftKey,isControl:e.ctrlKey||e.metaKey,isAlt:e.altKey,hasModifier:e.shiftKey||e.ctrlKey||e.metaKey||e.altKey,modifiers:[],up:t,repeat:e.repeat};return i.isShift&&i.modifiers.push(this.MODIFIER_KEYS.SHIFT),i.isControl&&i.modifiers.push(this.MODIFIER_KEYS.CONTROL),i.isAlt&&i.modifiers.push(this.MODIFIER_KEYS.ALT),i}isModifierActive(e){return this.constructor.MODIFIER_CODES[e].some((e=>this.downKeys.has(e)))}isCoreActionKeyActive(e){const t=c.keybindings.get("core",e);return!!t?.some((e=>this.downKeys.has(e.key)))}static _getContextDisplayString(e,t=!0){const i=[this.getKeycodeDisplayString(e.key)];return t&&e.hasModifier&&(e.isShift&&"Shift"!==e.event.key&&i.unshift(this.MODIFIER_KEYS.SHIFT),e.isControl&&"Control"!==e.event.key&&i.unshift(this.MODIFIER_KEYS.CONTROL),e.isAlt&&"Alt"!==e.event.key&&i.unshift(this.MODIFIER_KEYS.ALT)),i.join("+")}static _getMatchingActions(e){let t=c.keybindings.activeKeys.get(e.key)??[];return g.debug.keybindings&&console.dir(t),t.filter((t=>KeyboardManager._testContext(t,e)))}static _testContext(e,t){if(t.repeat&&!e.repeat)return!1;if(e.restricted&&!c.user.isGM)return!1;if(!t.hasModifier)return 0===e.requiredModifiers.length;const i=this.MODIFIER_KEYS,n={[i.CONTROL]:t.isControl,[i.SHIFT]:t.isShift,[i.ALT]:t.isAlt};for(let[i,s]of Object.entries(n))if(!this.MODIFIER_CODES[i].includes(t.key))if(e.requiredModifiers.includes(i)){if(!s)return!1}else if(!t.up&&!e.optionalModifiers.includes(i)&&s)return!1;return!0}static _executeKeybind(e,t){g.debug.keybindings&&console.log("Executing "+c.i18n.localize(e.name)),t.action=e.action;let i=!1;return t.up&&e.onUp?i=e.onUp(t):!t.up&&e.onDown&&(i=e.onDown(t)),i}_processKeyboardContext(e,{force:t=!1}={}){if(e.up?this.downKeys.delete(e.key):this.downKeys.add(e.key),this.hasFocus&&!t)return;g.debug.keybindings&&(console.group(`[${e.up?"UP":"DOWN"}] Checking for keybinds that respond to ${e.modifiers}+${e.key}`),console.dir(e));const i=KeyboardManager._getMatchingActions(e);if(0===i.length)return void(g.debug.keybindings&&(console.log("No matching keybinds"),console.groupEnd()));let n;for(const t of i)if(n=KeyboardManager._executeKeybind(t,e),n)break;n&&e.event&&(g.debug.keybindings&&console.log("Event was consumed"),e.event?.preventDefault(),e.event?.stopPropagation()),g.debug.keybindings&&console.groupEnd()}_reset(){this.downKeys=new Set,this.moveKeys=new Set}releaseKeys({force:e=!0}={}){const t=Array.from(this.downKeys).reverse();for(const i of t)this.constructor.emulateKeypress(!0,i,{force:e,ctrlKey:this.isModifierActive(this.constructor.MODIFIER_KEYS.CONTROL),shiftKey:this.isModifierActive(this.constructor.MODIFIER_KEYS.SHIFT),altKey:this.isModifierActive(this.constructor.MODIFIER_KEYS.ALT)})}_handleKeyboardEvent(e,t){if(e.isComposing)return;if(!e.key&&!e.code)return;let i=KeyboardManager.getKeyboardEventContext(e,t);this._processKeyboardContext(i)}_onCompositionEnd(e){return this._handleKeyboardEvent(e,!1)}_onFocusIn(e){const t=[HTMLInputElement,HTMLSelectElement,HTMLTextAreaElement,HTMLOptionElement,HTMLButtonElement];(e.target.isContentEditable||t.some((t=>e.target instanceof t)))&&this.releaseKeys()}}class MouseManager{constructor(){this._wheelTime=0}static MOUSE_WHEEL_RATE_LIMIT=50;_activateListeners(){window.addEventListener("wheel",this._onWheel.bind(this),{passive:!1})}_onWheel(e){e.ctrlKey&&e.preventDefault();let t=e.delta=e.deltaY;if(e.shiftKey&&0===t&&(t=e.delta=e.deltaX),0===t)return;if(!canvas.ready)return;const i=document.elementFromPoint(e.clientX,e.clientY);if(!i||"board"!==i.id)return;e.preventDefault();const n=e.ctrlKey||e.metaKey,s=e.shiftKey,o=canvas.activeLayer;if(o?.options?.rotatableObjects&&(n||s)){if(o.options?.controllableObjects?o.controlled.length:!!o.hover){const t=Date.now();if(t-this._wheelTime<this.constructor.MOUSE_WHEEL_RATE_LIMIT)return;return this._wheelTime=t,o._onMouseWheel(e)}}canvas._onMouseWheel(e)}}class NewUserExperience{constructor(){Hooks$1.on("renderChatMessage",this._activateListeners.bind(this))}initialize(){!(c.actors.size+c.scenes.size+c.items.size+c.journal.size)&&(this._createInitialChatMessages(),this._showNewWorldTour())}_createInitialChatMessages(){if(c.settings.get("core","nue.shownTips"))return;const e=ChatMessage.getWhisperRecipients("GM"),t=[`\n      <h3 class="nue">${c.i18n.localize("NUE.FirstLaunchHeader")}</h3>\n      <p class="nue">${c.i18n.localize("NUE.FirstLaunchBody")}</p>\n      <p class="nue">${c.i18n.localize("NUE.FirstLaunchKB")}</p>\n      <footer class="nue">${c.i18n.localize("NUE.FirstLaunchHint")}</footer>\n    `,`\n      <h3 class="nue">${c.i18n.localize("NUE.FirstLaunchInvite")}</h3>\n      <p class="nue">${c.i18n.localize("NUE.FirstLaunchInviteBody")}</p>\n      <p class="nue">${c.i18n.localize("NUE.FirstLaunchTroubleshooting")}</p>\n      <footer class="nue">${c.i18n.localize("NUE.FirstLaunchHint")}</footer>\n    `].map((t=>({whisper:e,speaker:{alias:c.i18n.localize("Foundry Virtual Tabletop")},flags:{core:{nue:!0,canPopout:!0}},content:t})));ChatMessage.implementation.createDocuments(t),c.settings.set("core","nue.shownTips",!0)}async _createDefaultScene(){if(!c.user.isGM)return;const e=foundry.utils.getRoute("/nue/defaultscene/scene.json"),t=await foundry.utils.fetchWithTimeout(e,{method:"GET"}),i=await t.json(),n=await Scene.create(i);await n.activate(),canvas.animatePan({scale:.7,duration:100})}async _showNewWorldTour(){const e=c.tours.get("core.welcome");e?.status===Tour.STATUS.UNSTARTED&&(await this._createDefaultScene(),e.start())}_activateListeners(e,t){e.getFlag("core","nue")&&(t.find(".nue-tab").click(this._onTabLink.bind(this)),t.find(".nue-action").click(this._onActionLink.bind(this)))}_onActionLink(e){e.preventDefault();if("invite"===e.currentTarget.dataset.action)return(new InvitationLinks).render(!0)}_onTabLink(e){e.preventDefault();const t=e.currentTarget.dataset.tab;ui.sidebar.activateTab(t)}}function ClientPackageMixin(e){return class ClientPackage extends e{favorite=!1;getVersionBadge(){return this.constructor.getVersionBadge(this.availability,this)}static getVersionBadge(e,t,{modules:i,systems:n}={}){i??=c.modules,n??=c.systems;const s=CONST.PACKAGE_AVAILABILITY_CODES,{compatibility:o,version:r,relationships:a}=t;switch(e){case s.UNKNOWN:case s.REQUIRES_CORE_DOWNGRADE:case s.REQUIRES_CORE_UPGRADE_STABLE:case s.REQUIRES_CORE_UPGRADE_UNSTABLE:const l={[s.UNKNOWN]:"SETUP.CompatibilityUnknown",[s.REQUIRES_CORE_DOWNGRADE]:"SETUP.RequireCoreDowngrade",[s.REQUIRES_CORE_UPGRADE_STABLE]:"SETUP.RequireCoreUpgrade",[s.REQUIRES_CORE_UPGRADE_UNSTABLE]:"SETUP.RequireCoreUnstable"};return{type:"error",tooltip:c.i18n.localize(l[e]),label:r,icon:"fa fa-file-slash"};case s.MISSING_SYSTEM:return{type:"error",tooltip:c.i18n.format("SETUP.RequireDep",{dependencies:t.system}),label:r,icon:"fa fa-file-slash"};case s.MISSING_DEPENDENCY:case s.REQUIRES_DEPENDENCY_UPDATE:return{type:"error",label:r,icon:"fa fa-file-slash",tooltip:this._formatBadDependenciesTooltip(e,t,a.requires,{modules:i,systems:n})};case s.UNVERIFIED_GENERATION:return{type:"warning",tooltip:c.i18n.format("SETUP.CompatibilityRiskWithVersion",{version:o.verified}),label:r,icon:"fas fa-exclamation-triangle"};case s.UNVERIFIED_SYSTEM:return{type:"warning",label:r,icon:"fas fa-exclamation-triangle",tooltip:this._formatIncompatibleSystemsTooltip(t,a.systems,{systems:n})};case s.UNVERIFIED_BUILD:return{type:"neutral",tooltip:c.i18n.format("SETUP.CompatibilityRiskWithVersion",{version:o.verified}),label:r,icon:"fas fa-code-branch"};case s.VERIFIED:return{type:"success",tooltip:c.i18n.localize("SETUP.Verified"),label:r,icon:"fas fa-code-branch"}}return null}static _formatBadDependenciesTooltip(e,t,i,{modules:n,systems:s}={}){n??=c.modules,s??=c.systems;const o=CONST.PACKAGE_AVAILABILITY_CODES,r=new Set,a=[];for(const t of i)if("module"===t.type&&!r.has(t.id)){if(n.has(t.id)){if(e===o.REQUIRES_DEPENDENCY_UPDATE){n.get(t.id).availability!==o.VERIFIED&&a.push(t.id)}}else a.push(t.id);r.add(t.id)}const l=e===o.MISSING_DEPENDENCY?"SETUP.RequireDep":"SETUP.IncompatibleDep",d=c.i18n.getListFormatter({style:"short",type:"unit"});return c.i18n.format(l,{dependencies:d.format(a)})}static _formatIncompatibleSystemsTooltip(e,t,{systems:i}={}){i??=c.systems;const n=[];for(const{id:e,compatibility:s}of t){const t=i.get(e);t&&(this.testDependencyCompatibility(s,t)&&!t.unavailable||n.push(e))}const s=n.length?"SETUP.IncompatibleSystems":"SETUP.NoSupportedSystem",o=c.i18n.getListFormatter({style:"short",type:"unit"});return c.i18n.format(s,{systems:o.format(n)})}install(){const e=this.constructor.collection;c.data[e].push(this.toObject()),c[e].set(this.id,this)}uninstall(){this.constructor.uninstall(this.id)}static uninstall(e){c.data[this.collection].findSplice((t=>t.id===e)),c[this.collection].delete(e)}static async fromRemoteManifest(e,{strict:t=!1}={}){try{return new this(await Setup.post({action:"getPackageFromRemoteManifest",type:this.type,manifest:e}),{installed:!1,strict:t})}catch(e){return null}}}}class Module extends(ClientPackageMixin(foundry.packages.BaseModule)){constructor(e,t={}){const{active:i}=e;super(e,t),Object.defineProperty(this,"active",{value:i,writable:!1})}}class System extends(ClientPackageMixin(foundry.packages.BaseSystem)){constructor(e,t={}){t.strictDataCleaning=e.strictDataCleaning,super(e,t)}_configure(e){super._configure(e),this.strictDataCleaning=!!e.strictDataCleaning}get template(){return foundry.utils.logCompatibilityWarning("System#template is deprecated in favor of System#documentTypes",{since:12,until:14}),c.model}}class World extends(ClientPackageMixin(foundry.packages.BaseWorld)){static getVersionBadge(e,t,{modules:i,systems:n}={}){i??=c.modules,n??=c.systems;const s=super.getVersionBadge(e,t,{modules:i,systems:n});if(!s)return s;const o=CONST.PACKAGE_AVAILABILITY_CODES;if(e===o.VERIFIED){n.get(t.system).availability!==o.VERIFIED&&(s.type="neutral")}return t.manifest||(s.label=""),s}getSystemBadge(e){if(e??=c.systems.get(this.system),!e)return{type:"error",tooltip:c.i18n.format("SETUP.RequireSystem",{system:this.system}),label:this.system,icon:"fa fa-file-slash"};const t=e.getVersionBadge();return"safe"===t.type&&(t.type="neutral",t.icon=null),t.tooltip=`<p>${e.title}</p><p>${t.tooltip}</p>`,t.label=e.id,t}static _formatBadDependenciesTooltip(e,t,i){const n=c.systems.get(t.system);return n&&(i??=[...t.relationships.requires.values(),...n.relationships.requires.values()]),super._formatBadDependenciesTooltip(e,t,i)}}class ClientSettings{constructor(e){this.settings=new Map,this.menus=new Map,this.storage=new Map([["client",window.localStorage],["world",new WorldSettings(e)]])}get sheet(){return this._sheet||(this._sheet=new SettingsConfig),this._sheet}register(e,t,i){if(!e||!t)throw new Error("You must specify both namespace and key portions of the setting");if(i.key=t,i.namespace=e,i.scope=["client","world"].includes(i.scope)?i.scope:"client",t=`${e}.${t}`,i.type){if(![foundry.data.fields.DataField,foundry.abstract.DataModel,Function].some((e=>i.type instanceof e)))throw new Error(`Setting ${t} type must be a DataField, DataModel, or callable function`);i.type instanceof foundry.data.fields.DataField&&(i.default??=i.type.initial,i.type.name=t,i.type.label??=i.label,i.type.hint??=i.hint)}i.default??=null,this.settings.set(t,i),"world"===i.scope&&this.storage.get("world").getSetting(t)?.reset()}registerMenu(e,t,i){if(!e||!t)throw new Error("You must specify both namespace and key portions of the menu");if(i.key=`${e}.${t}`,i.namespace=e,!(i.type?.prototype instanceof FormApplication||i.type?.prototype instanceof foundry.applications.api.ApplicationV2))throw new Error("You must provide a menu type that is a FormApplication or ApplicationV2 instance or subclass");this.menus.set(i.key,i)}get(e,t){t=this.#A(e,t);const i=this.settings.get(t),n=this.storage.get(i.scope);let s;switch(i.scope){case"client":s=new Setting({key:t,value:n.getItem(t)??i.default});break;case"world":s=n.getSetting(t),s||(s=new Setting({key:t,value:i.default}))}return s.value}async set(e,t,i,n={}){t=this.#A(e,t);const s=this.settings.get(t);if(void 0===i&&(i=s.default),s.type instanceof foundry.data.fields.DataField){const e=s.type.validate(i,{fallback:!1});if(e instanceof foundry.data.validation.DataModelValidationFailure)throw e.asError()}return foundry.utils.isSubclass(s.type,foundry.abstract.DataModel)&&(i=s.type.fromSource(i,{strict:!0})),"world"===s.scope?await this.#R(t,i,n):this.#P(t,i,s.onChange),i}#A(e,t){const i=`${e}.${t}`;if(!e||!t)throw new Error(`You must specify both namespace and key portions of thesetting, you provided "${i}"`);if(!this.settings.has(i))throw new Error(`"${i}" is not a registered game setting`);return i}async#R(e,t,i){if(!c.ready)throw new Error("You may not set a World-level Setting before the Game is ready.");const n=this.storage.get("world").getSetting(e),s=JSON.stringify(t);return n?n.update({value:s},i):Setting.create({key:e,value:s},i)}#P(e,t,i){const n=this.storage.get("client"),s=JSON.stringify(t);let o;if(e in n){o=new Setting({key:e,value:n.getItem(e)});const t=o.updateSource({value:s});if(foundry.utils.isEmpty(t))return o}else o=new Setting({key:e,value:s});return n.setItem(e,s),i instanceof Function&&i(t),o}}class SocketInterface{static dispatch(e,t){return new Promise(((i,n)=>{c.socket.emit(e,t,(e=>{if(e.error){const t=SocketInterface.#k(e.error);n(t)}else i(e)}))}))}static#k(e){let t=e instanceof Error?e:new Error(e.message);return e.stack&&(t.stack=e.stack),ui.notifications&&ui.notifications.error(t.message),t}}class SortingHelpers{static performIntegerSort(e,{target:t=null,siblings:i=[],sortKey:n="sort",sortBefore:s}={}){void 0===s&&(s=(e[n]||0)>(t?.[n]||0)),(i=Array.from(i)).sort(((e,t)=>e[n]-t[n]));let o,r,a=s?i.length:0,l=t?i.findIndex((e=>e===t)):a;return[o,r]=s?this._sortBefore(i,l,n):this._sortAfter(i,l,n),0===i.length?[{target:e,update:{[n]:CONST.SORT_INTEGER_DENSITY}}]:Number.isFinite(r)&&null===o?[{target:e,update:{[n]:r-CONST.SORT_INTEGER_DENSITY}}]:Number.isFinite(o)&&null===r?[{target:e,update:{[n]:o+CONST.SORT_INTEGER_DENSITY}}]:Number.isFinite(o)&&Number.isFinite(r)&&Math.abs(r-o)>1?[{target:e,update:{[n]:Math.round(.5*(o+r))}}]:(i.splice(l+(s?0:1),0,e),i.map(((e,t)=>({target:e,update:{[n]:(t+1)*CONST.SORT_INTEGER_DENSITY}}))))}static _sortBefore(e,t,i){let n=e[t]?e[t][i]:null;return[e[t-1]?e[t-1][i]:null,n]}static _sortAfter(e,t,i){return[e[t]?e[t][i]:null,e[t+1]?e[t+1][i]:null]}}class GameTime{constructor(e){this._time={},this._dt=0,this._dts=[],e&&this.sync(e)}static SYNC_INTERVAL_MS=3e5;get serverTime(){const e=Date.now()-this._time.clientTime;return e>GameTime.SYNC_INTERVAL_MS&&this.sync(),this._time.serverTime+e}get worldTime(){return this._time.worldTime}async advance(e,t){return c.settings.set("core","time",this.worldTime+e,t)}async sync(e){e=e??c.socket;const t=Date.now(),i=await new Promise((t=>e.emit("time",t))),n=Date.now();return this._dts.length>=5&&this._dts.unshift(),this._dts.push(n-t),this._dt=Math.round(this._dts.reduce(((e,t)=>e+t),0)/(2*this._dts.length)),i.clientTime=n-this._dt,this._time=i,console.log(`${l} | Synchronized official game time in ${this._dt}ms`),this}onUpdateWorldTime(e,t,i){const n=e-this._time.worldTime;this._time.worldTime=e,Hooks$1.callAll("updateWorldTime",e,n,t,i),g.debug.time&&console.log(`The world time advanced by ${n} seconds, and is now ${e}.`)}}class TooltipManager{tooltip=document.getElementById("tooltip");element=null;static TOOLTIP_MARGIN_PX=5;static TOOLTIP_ACTIVATION_MS=500;static TOOLTIP_DIRECTIONS={UP:"UP",DOWN:"DOWN",LEFT:"LEFT",RIGHT:"RIGHT",CENTER:"CENTER"};static LOCKED_TOOLTIP_BUFFER_PX=50;#M=!1;#L;#F;#U;#B={elements:new Set,boundingBox:{}};activateEventListeners(){document.body.addEventListener("pointerenter",this.#G.bind(this),!0),document.body.addEventListener("pointerleave",this.#j.bind(this),!0),document.body.addEventListener("pointerup",this._onLockTooltip.bind(this),!0),document.body.addEventListener("pointermove",this.#$.bind(this),{capture:!0,passive:!0})}#G(e){if(Tour.tourInProgress)return;const t=e.target;t.closest(".editor-content.ProseMirror")||(t.dataset.tooltip?t.matches("#context-menu")||t.querySelector("#context-menu")||(this.#M?this.activate(t):(this.#H(),this.#U=t,this.#L=window.setTimeout((()=>{this.#L=null,this.#U&&this.activate(this.#U)}),this.constructor.TOOLTIP_ACTIVATION_MS))):this.#M&&!this.element.contains(t)&&this.#z())}#j(e){if(e.target!==(this.element??this.#U))return;const t=e.target.parentElement.closest("[data-tooltip]");t?this.activate(t):this.#z()}#z(){this.#F||(this.clearPending(),this.#F=window.setTimeout((()=>{this.#F=null,this.#U||this.deactivate()}),this.constructor.TOOLTIP_ACTIVATION_MS))}#H(){window.clearTimeout(this.#F),this.#F=null}activate(e,{text:t,direction:i,cssClass:n,locked:s=!1,content:o}={}){if(t&&o)throw new Error("Cannot provide both text and content options to TooltipManager#activate.");this.deactivate(),document.body.contains(e)&&(this.#M=!0,this.element=e,e.setAttribute("aria-describedby","tooltip"),o?(this.tooltip.innerHTML="",this.tooltip.appendChild(o)):this.tooltip.innerHTML=t||c.i18n.localize(e.dataset.tooltip),this.tooltip.removeAttribute("class"),this.tooltip.classList.add("active"),n??=e.closest("[data-tooltip-class]")?.dataset.tooltipClass,n&&this.tooltip.classList.add(...n.split(" ")),i??=e.closest("[data-tooltip-direction]")?.dataset.tooltipDirection,i||(i=this._determineDirection()),this._setAnchor(i),(s||e.dataset.hasOwnProperty("locked"))&&this.lockTooltip())}deactivate(){this.#M=!1,this.tooltip.classList.remove("active"),this.clearPending(),this.#H(),this.element&&(this.element.removeAttribute("aria-describedby"),this.element=null)}clearPending(){window.clearTimeout(this.#L),this.#U=this.#L=null}lockTooltip(){const e=this.tooltip.cloneNode(!1);for(;this.tooltip.firstChild;)e.appendChild(this.tooltip.firstChild);return e.removeAttribute("id"),e.classList.add("locked-tooltip","active"),document.body.appendChild(e),this.deactivate(),e.addEventListener("contextmenu",this._onLockedTooltipDismiss.bind(this)),this.#B.elements.add(e),requestAnimationFrame((()=>this.#V())),e}_onLockTooltip(e){1===e.button&&this.#M&&!Tour.tourInProgress&&(e.preventDefault(),this.lockTooltip())}_onLockedTooltipDismiss(e){e.preventDefault();const t=e.currentTarget;this.dismissLockedTooltip(t)}dismissLockedTooltip(e){this.#B.elements.delete(e),e.remove(),this.#V()}#V(){let e=null;for(const t of this.#B.elements.values()){const{x:i,y:n,width:s,height:o}=t.getBoundingClientRect(),r=new PIXI.Rectangle(i,n,s,o);e?e.enlarge(r):e=r}this.#B.boundingBox=e}#$(e){if(!this.#B.elements.size)return;const{clientX:t,clientY:i,movementX:n,movementY:s}=e,o=this.#B.boundingBox?.clone?.().pad(this.constructor.LOCKED_TOOLTIP_BUFFER_PX);o&&!o.contains(t,i)&&Number.isFinite(n)&&Number.isFinite(s)&&(n>0&&t>o.right||n<0&&t<o.x||s>0&&i>o.bottom||s<0&&i<o.y)&&this.dismissLockedTooltips()}dismissLockedTooltips(){for(const e of this.#B.elements.values())e.remove();this.#B.elements=new Set}createLockedTooltip(e,t,{cssClass:i}={}){this.#H(),this.tooltip.innerHTML=t,this.tooltip.style.top=e.top||"",this.tooltip.style.right=e.right||"",this.tooltip.style.bottom=e.bottom||"",this.tooltip.style.left=e.left||"";const n=this.lockTooltip();return i&&n.classList.add(...i.split(" ")),n}_determineDirection(){const e=this.element.getBoundingClientRect();return this.constructor.TOOLTIP_DIRECTIONS[e.y+this.tooltip.offsetHeight>window.innerHeight?"UP":"DOWN"]}_setAnchor(e){const t=this.constructor.TOOLTIP_DIRECTIONS,i=this.constructor.TOOLTIP_MARGIN_PX,n=this.element.getBoundingClientRect();let s={};switch(e){case t.DOWN:s.textAlign="center",s.left=n.left-this.tooltip.offsetWidth/2+n.width/2,s.top=n.bottom+i;break;case t.LEFT:s.textAlign="left",s.right=window.innerWidth-n.left+i,s.top=n.top+n.height/2-this.tooltip.offsetHeight/2;break;case t.RIGHT:s.textAlign="right",s.left=n.right+i,s.top=n.top+n.height/2-this.tooltip.offsetHeight/2;break;case t.UP:s.textAlign="center",s.left=n.left-this.tooltip.offsetWidth/2+n.width/2,s.bottom=window.innerHeight-n.top+i;break;case t.CENTER:s.textAlign="center",s.left=n.left-this.tooltip.offsetWidth/2+n.width/2,s.top=n.top+n.height/2-this.tooltip.offsetHeight/2}return this._setStyle(s)}_setStyle(e={}){const t=this.constructor.TOOLTIP_MARGIN_PX;e={top:null,right:null,bottom:null,left:null,textAlign:"left",...e};const i=this.tooltip.style,n=window.innerWidth-this.tooltip.offsetWidth;e.left&&(e.left=Math.clamp(e.left,t,n-t)),e.right&&(e.right=Math.clamp(e.right,t,n-t));const s=window.innerHeight-this.tooltip.offsetHeight;e.top&&(e.top=Math.clamp(e.top,t,s-t)),e.bottom&&(e.bottom=Math.clamp(e.bottom,t,s-t));for(let t of["top","right","bottom","left"]){const n=e[t];i[t]=n?`${n}px`:null}this.tooltip.classList.remove(...["center","left","right"].map((e=>`text-${e}`))),this.tooltip.classList.add(`text-${e.textAlign}`)}}class Tour{constructor(e,{id:t,namespace:i}={}){this.config=foundry.utils.deepClone(e),this.config.localization&&foundry.utils.mergeObject(c.i18n._fallback,this.config.localization),this.#y=t??e.id,this.#W=i??e.namespace,this.#X=this._loadProgress()}static#Y=null;static STATUS={UNSTARTED:"unstarted",IN_PROGRESS:"in-progress",COMPLETED:"completed"};static get tourInProgress(){return!!Tour.#Y}static get activeTour(){return Tour.#Y}static onMovementAction(e){return e.includes(ClientKeybindings.MOVEMENT_DIRECTIONS.RIGHT)&&Tour.activeTour.hasNext?(Tour.activeTour.next(),!0):e.includes(ClientKeybindings.MOVEMENT_DIRECTIONS.LEFT)&&Tour.activeTour.hasPrevious?(Tour.activeTour.previous(),!0):void 0}config;targetElement;fadeElement;overlayElement;static HIGHLIGHT_PADDING=10;get id(){return this.#y}set id(e){if(this.#y)throw new Error("The Tour has already been assigned an ID");this.#y=e}#y;get title(){return c.i18n.localize(this.config.title)}get description(){return c.i18n.localize(this.config.description)}get namespace(){return this.#W}set namespace(e){if(this.#W)throw new Error("The Tour has already been assigned a namespace");this.#W=e}#W;get key(){return`${this.#W}.${this.#y}`}get steps(){return this.config.steps.filter((e=>!e.restricted||c.user.isGM))}get currentStep(){return this.steps[this.#X]??null}get stepIndex(){return this.#X}#X=-1;get hasNext(){return this.#X<this.steps.length-1}get hasPrevious(){return this.#X>0}get canStart(){return!0}get status(){return-1===this.#X?Tour.STATUS.UNSTARTED:this.#X===this.steps.length?Tour.STATUS.COMPLETED:Tour.STATUS.IN_PROGRESS}async complete(){return this.progress(this.steps.length)}exit(){this.currentStep&&this._postStep(),Tour.#Y=null}async reset(){return this.progress(-1)}async start(){switch(c.tooltip.clearPending(),this.status){case Tour.STATUS.IN_PROGRESS:return this.progress(this.config.canBeResumed&&this.hasPrevious?this.#X:0);case Tour.STATUS.UNSTARTED:case Tour.STATUS.COMPLETED:return this.progress(0)}}async next(){if(this.status===Tour.STATUS.COMPLETED)throw new Error(`Tour ${this.id} has already been completed`);return this.hasNext?this.progress(this.#X+1):this.complete()}async previous(){if(this.hasPrevious)return this.progress(this.#X-1)}async progress(e){if(!Number.between(e,-1,this.steps.length))throw new Error(`Step index ${e} is not valid for Tour ${this.id} with ${this.steps.length} steps.`);if(Tour.#Y&&Tour.#Y!==this){if(-1!==e&&e!==this.steps.length)throw new Error(`You cannot begin the ${this.title} Tour because the ${Tour.#Y.title} Tour is already in progress`);Tour.#Y=null}else Tour.#Y=this;e>0&&(await this._postStep(),console.debug(`Tour [${this.namespace}.${this.id}] | Completed step ${this.#X+1} of ${this.steps.length}`)),this.#X=e,this._saveProgress();const t=Object.values(ui.windows).find((e=>e instanceof ToursManagement));if(t&&(t._cachedData=null,t._render(!0)),this.status===Tour.STATUS.UNSTARTED)return Tour.#Y=null;if(this.status===Tour.STATUS.COMPLETED){Tour.#Y=null;const e=c.tours.get((this.config.suggestedNextTours||[]).find((e=>{const t=c.tours.get(e);return t&&t.status!==Tour.STATUS.COMPLETED})));if(!e)return;return Dialog.confirm({title:c.i18n.localize("TOURS.SuggestedTitle"),content:c.i18n.format("TOURS.SuggestedDescription",{currentTitle:this.title,nextTitle:e.title}),yes:()=>e.start(),defaultYes:!0})}await this._preStep(),this.targetElement=null;const i=this.currentStep;i.selector&&(this.targetElement=this._getTargetElement(i.selector),this.targetElement||console.warn(`Tour [${this.id}] target element "${i.selector}" was not found`));try{await this._renderStep()}catch(e){throw this.exit(),e}}_getTargetElement(e){return document.querySelector(e)}static async fromJSON(e){return new this(await foundry.utils.fetchJsonWithTimeout(foundry.utils.getRoute(e,{prefix:ROUTE_PREFIX})))}async _preStep(){}async _postStep(){this.currentStep&&!this.currentStep.selector?this.targetElement?.remove():c.tooltip.deactivate(),this.fadeElement&&(this.fadeElement.remove(),this.fadeElement=void 0),this.overlayElement&&(this.overlayElement=this.overlayElement.remove())}async _renderStep(){const e=this.currentStep,t={title:c.i18n.localize(e.title),content:c.i18n.localize(e.content).split("\n"),step:this.#X+1,totalSteps:this.steps.length,hasNext:this.hasNext,hasPrevious:this.hasPrevious},i=await renderTemplate("templates/apps/tour-step.html",t);if(e.selector){if(!this.targetElement)throw new Error(`The expected targetElement ${e.selector} does not exist`);this.targetElement.scrollIntoView(),c.tooltip.activate(this.targetElement,{text:i,cssClass:"tour",direction:e.tooltipDirection})}else{const e=document.createElement("aside");e.innerHTML=i,e.classList.add("tour-center-step"),e.classList.add("tour"),document.body.appendChild(e),this.targetElement=e}this.fadeElement=document.createElement("div"),this.fadeElement.classList.add("tour-fadeout");const n=this.targetElement.getBoundingClientRect();this.fadeElement.style.width=`${n.width+(e.selector?Tour.HIGHLIGHT_PADDING:0)}px`,this.fadeElement.style.height=`${n.height+(e.selector?Tour.HIGHLIGHT_PADDING:0)}px`,this.fadeElement.style.top=n.top-(e.selector?Tour.HIGHLIGHT_PADDING:0)/2+"px",this.fadeElement.style.left=n.left-(e.selector?Tour.HIGHLIGHT_PADDING:0)/2+"px",document.body.appendChild(this.fadeElement),this.overlayElement=document.createElement("div"),this.overlayElement.classList.add("tour-overlay"),document.body.appendChild(this.overlayElement);const s=e.selector?c.tooltip.tooltip.querySelectorAll(".step-button"):this.targetElement.querySelectorAll(".step-button");for(let e of s)e.addEventListener("click",(e=>this._onButtonClick(e,s)))}_onButtonClick(e,t){e.preventDefault();for(let e of t)e.classList.add("disabled");const i=e.currentTarget.dataset.action;switch(i){case"exit":return this.exit();case"previous":return this.previous();case"next":return this.next();default:throw new Error(`Unexpected Tour button action - ${i}`)}}_saveProgress(){let e=c.settings.get("core","tourProgress");this.namespace in e||(e[this.namespace]={}),e[this.namespace][this.id]=this.#X,c.settings.set("core","tourProgress",e)}_loadProgress(){let e=c.settings.get("core","tourProgress");return e?.[this.namespace]?.[this.id]??-1}_reloadProgress(){this.#X=this._loadProgress()}}class Tours extends foundry.utils.Collection{constructor(){if(super(),c.tours)throw new Error("You can only have one TourManager instance")}register(e,t,i){if(!e||!t)throw new Error("You must specify both the namespace and id portion of the Tour");if(!(i instanceof Tour))throw new Error("You must pass in a Tour instance");if(t&&!i.id&&(i.id=t),e&&!i.namespace&&(i.namespace=e),i._reloadProgress(),this.has(i.key))throw new Error(`Tour "${key}" has already been registered`);this.set(`${e}.${t}`,i)}set(e,t){if(e!==t.key)throw new Error(`The key "${e}" does not match what has been configured for the Tour`);return super.set(e,t)}}function saveDataToFile(e,t,i){const n=new Blob([e],{type:t});let s=document.createElement("a");s.href=window.URL.createObjectURL(n),s.download=i,s.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window})),setTimeout((()=>window.URL.revokeObjectURL(s.href)),100)}async function fromUuid(e,t={}){if(!e)return null;"Object"!==foundry.utils.getType(t)&&(foundry.utils.logCompatibilityWarning("Passing a relative document as the second parameter to fromUuid is deprecated. Please pass it within an options object instead.",{since:11,until:13}),t={relative:t});const{relative:i,invalid:n=!1}=t;let{type:s,id:o,primaryId:r,collection:a,embedded:l,doc:c}=foundry.utils.parseUuid(e,{relative:i});if(a instanceof CompendiumCollection){if("Folder"===s)return a.folders.get(o);c=await a.getDocument(r??o)}else c=c??a?.get(r??o,{invalid:n});return l.length&&(c=_resolveEmbedded(c,l,{invalid:n})),c||null}function fromUuidSync(e,t={}){if(!e)return null;"Object"!==foundry.utils.getType(t)&&(foundry.utils.logCompatibilityWarning("Passing a relative document as the second parameter to fromUuidSync is deprecated. Please pass it within an options object instead.",{since:11,until:13}),t={relative:t});const{relative:i,invalid:n=!1,strict:s=!0}=t;let{type:o,id:r,primaryId:a,collection:l,embedded:c,doc:d}=foundry.utils.parseUuid(e,{relative:i});if(l instanceof CompendiumCollection&&c.length){if(!s)return null;throw new Error(`fromUuidSync was invoked on UUID '${e}' which references an Embedded Document and cannot be retrieved synchronously.`)}const u=a??r;if(l instanceof CompendiumCollection){if("Folder"===o)return l.folders.get(r);d=d??l.get(u,{invalid:n})??l.index.get(u),d&&(d.pack=l.collection)}else d=d??l?.get(u,{invalid:n}),c.length&&(d=_resolveEmbedded(d,c,{invalid:n}));return d||null}function _resolveEmbedded(e,t,{invalid:i=!1}={}){let n=e;for(;n&&t.length>1;){const[e,s]=t.splice(0,2);n=n.getEmbeddedDocument(e,s,{invalid:i})}return n}function getDocumentClass(e){return g[e]?.documentClass}class VideoHelper{constructor(){if(c.video instanceof this.constructor)throw new Error("You may not re-initialize the singleton VideoHelper. Use game.video instead.");this.pending=new Set,this.thumbs=new Map,this.locked=!0}#K;#q=/^https:\/\/(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=([^&]+)|(?:embed\/)?([^?]+))/;getSourceElement(e){return e.texture.valid?e.texture.baseTexture.resource.source:null}getVideoSource(e){if(!e)return null;const t=e.texture||e;if(!t.valid)return null;const i=t.baseTexture.resource.source;return"VIDEO"===i?.tagName?i:null}async cloneTexture(e){const t=e.cloneNode(!0),i=new PIXI.VideoResource(t,{autoPlay:!1});return i.internal=!0,await i.load(),new PIXI.Texture(new PIXI.BaseTexture(i,{alphaMode:await PIXI.utils.detectVideoAlphaMode()}))}static hasVideoExtension(e){return new RegExp(`(\\.${Object.keys(CONST.VIDEO_FILE_EXTENSIONS).join("|\\.")})(\\?.*)?`,"i").test(e)}async play(e,{playing:t=!0,loop:i=!0,offset:n,volume:s}={}){return e.loop=i,n??=e.currentTime,void 0!==s&&(e.volume=s),t?this.locked?this.pending.add([e,n]):(e.currentTime=Math.clamp(n,0,e.duration),e.play()):e.pause()}stop(e){e.pause(),e.currentTime=0}awaitFirstGesture(){if(!this.locked)return;["contextmenu","auxclick","pointerdown","pointerup","keydown"].forEach((e=>document.addEventListener(e,this._onFirstGesture.bind(this),{once:!0})))}_onFirstGesture(e){if(this.locked=!1,this.pending.size){console.log(`${l} | Activating pending video playback with user gesture.`);for(const[e,t]of Array.from(this.pending))this.play(e,{offset:t,loop:e.loop});this.pending.clear()}}async createThumbnail(e,t){if(c.settings.get("core","noCanvas"))return"icons/svg/video.svg";const i=await ImageHelper.createThumbnail(e,t);return this.thumbs.set(e,i.thumb),i.thumb}async getYouTubePlayer(e,t={}){return this.#K??=this.#J(),await this.#K,new Promise((i=>new YT.Player(e,foundry.utils.mergeObject(t,{events:{onReady:e=>i(e.target)}}))))}getYouTubeId(e){const[,t,i]=e?.match(this.#q)||[];return t||i||""}getYouTubeEmbedURL(e,t={}){const i=this.getYouTubeId(e);if(!i)return"";const n=new URL(`https://www.youtube.com/embed/${i}`);return n.searchParams.append("enablejsapi","1"),Object.entries(t).forEach((([e,t])=>n.searchParams.append(e,t))),t.loop&&n.searchParams.append("playlist",i),n.href}isYouTubeURL(e=""){return this.#q.test(e)}#J(){const e=document.createElement("script");return e.src="https://www.youtube.com/iframe_api",document.head.appendChild(e),new Promise((e=>{window.onYouTubeIframeAPIReady=()=>{delete window.onYouTubeIframeAPIReady,e()}}))}}class AsyncWorker extends Worker{constructor(e,{debug:t=!1,loadPrimitives:i=!1,scripts:n}={}){super(AsyncWorker.WORKER_HARNESS_JS),this.name=e,this.addEventListener("message",this.#Q.bind(this)),this.addEventListener("error",this.#Z.bind(this)),this.#g=this.#ee({action:WorkerManager.WORKER_TASK_ACTIONS.INIT,workerName:e,debug:t,loadPrimitives:i,scripts:n})}static WORKER_HARNESS_JS="scripts/worker.js";#te=new Map;#ie=0;get ready(){return this.#g}#g;async loadFunction(e,t){return this.#ee({action:WorkerManager.WORKER_TASK_ACTIONS.LOAD,functionName:e,functionBody:t.toString()})}async executeFunction(e,t=[],i=[]){const n=WorkerManager.WORKER_TASK_ACTIONS.EXECUTE;return this.#ee({action:n,functionName:e,args:t},i)}async#ee(e={},t=[]){const i=e.taskId=this.#ie++;return new Promise(((n,s)=>{this.#te.set(i,{resolve:n,reject:s}),this.postMessage(e,t)}))}#Q(e){const t=e.data,i=this.#te.get(t.taskId);if(i)return this.#te.delete(t.taskId),t.error?i.reject(t.error):i.resolve(t.result)}#Z(e){e.message=`An error occurred in Worker ${this.name}: ${e.message}`,console.error(e)}}class WorkerManager extends Map{constructor(){if(c.workers instanceof WorkerManager)throw new Error("The singleton WorkerManager instance has already been constructed as Game#workers");super()}static WORKER_TASK_ACTIONS=Object.freeze({INIT:"init",LOAD:"load",EXECUTE:"execute"});async createWorker(e,t={}){if(this.has(e))throw new Error(`A Worker already exists with the name "${e}"`);const i=new AsyncWorker(e,t);return this.set(e,i),await i.ready,i}retireWorker(e){const t=this.get(e);t&&(t.terminate(),this.delete(e))}getWorker(e){foundry.utils.logCompatibilityWarning("WorkerManager#getWorker is deprecated in favor of WorkerManager#get",{since:11,until:13});const t=this.get(e);if(!t)throw new Error(`No worker with name ${e} currently exists!`);return t}}let d=globalThis._appId=0,u=Number(getComputedStyle(document.body).getPropertyValue("--z-index-window")??100);class Application{constructor(e={}){this.options=foundry.utils.mergeObject(this.constructor.defaultOptions,e,{insertKeys:!0,insertValues:!0,overwrite:!0,inplace:!1}),this._element=null,this.position={width:this.options.width,height:this.options.height,left:this.options.left,top:this.options.top,scale:this.options.scale,zIndex:0},this._dragDrop=this._createDragDropHandlers(),this._tabs=this._createTabHandlers(),this._searchFilters=this._createSearchFilters(),this._minimized=!1,this._state=Application.RENDER_STATES.NONE,this._priorState=this._state,this._scrollPositions=null}appId;static RENDER_STATES=Object.freeze({ERROR:-3,CLOSING:-2,CLOSED:-1,NONE:0,RENDERING:1,RENDERED:2});_createDragDropHandlers(){return this.options.dragDrop.map((e=>(e.permissions={dragstart:this._canDragStart.bind(this),drop:this._canDragDrop.bind(this)},e.callbacks={dragstart:this._onDragStart.bind(this),dragover:this._onDragOver.bind(this),drop:this._onDrop.bind(this)},new DragDrop(e))))}_createTabHandlers(){return this.options.tabs.map((e=>(e.callback=this._onChangeTab.bind(this),new Tabs(e))))}_createSearchFilters(){return this.options.filters.map((e=>(e.callback=this._onSearchFilter.bind(this),new SearchFilter(e))))}static get defaultOptions(){return{baseApplication:null,width:null,height:null,top:null,left:null,scale:null,popOut:!0,minimizable:!0,resizable:!1,id:"",classes:[],dragDrop:[],tabs:[],filters:[],title:"",template:null,scrollY:[]}}get id(){return this.options.id?this.options.id:`app-${this.appId}`}get element(){if(this._element)return this._element;let e=`#${this.id}`;return $(e)}get template(){return this.options.template}get popOut(){return this.options.popOut??!0}get rendered(){return this._state===Application.RENDER_STATES.RENDERED}get closing(){return this._state===Application.RENDER_STATES.CLOSING}get title(){return c.i18n.localize(this.options.title)}getData(e={}){return{}}render(e=!1,t={}){return this._render(e,t).catch((e=>{this._state=Application.RENDER_STATES.ERROR,Hooks$1.onError("Application#render",e,{msg:`An error occurred while rendering ${this.constructor.name} ${this.appId}`,log:"error",...t})})),this}async _render(e=!1,t={}){const i=Application.RENDER_STATES;if(this._priorState=this._state,[i.CLOSING,i.RENDERING].includes(this._state))return;if(!e&&this._state<=i.NONE)return;[i.NONE,i.CLOSED,i.ERROR].includes(this._state)&&console.log(`${l} | Rendering ${this.constructor.name}`),this._state=i.RENDERING,foundry.utils.mergeObject(this.options,t,{insertKeys:!1}),t.focus??=e;const n=this.element;this.appId=n.data("appid")??++d,this.popOut&&(ui.windows[this.appId]=this);const s=await this.getData(this.options);n.length&&this.options.scrollY&&this._saveScrollPositions(n);const o=await this._renderInner(s);let r=o;n.length?this._replaceHTML(n,r):(this.popOut&&(r=await this._renderOuter(),r.find(".window-content").append(o)),this._injectHTML(r)),!this.popOut&&this.options.resizable&&new Draggable(this,r,!1,this.options.resizable),this._activateCoreListeners(o),this.activateListeners(o),this._minimized||(foundry.utils.mergeObject(this.position,t,{insertKeys:!1}),this.setPosition(this.position)),this.popOut&&!0===t.focus&&this.maximize().then((()=>this.bringToTop())),this._callHooks("render",r,s),this.options.scrollY&&this._restoreScrollPositions(r),this._state=i.RENDERED}static _getInheritanceChain(){const e=foundry.utils.getParentClasses(this),t=this.defaultOptions.baseApplication,i=[this];for(let n of e)if(i.push(n),n.name===t)break;return i}_callHooks(e,...t){const i="string"==typeof e?t=>`${e}${t}`:e;for(const e of this.constructor._getInheritanceChain())e.name&&Hooks$1.callAll(i(e.name),this,...t)}_saveScrollPositions(e){const t=this.options.scrollY||[];this._scrollPositions=t.reduce(((t,i)=>{const n=e.find(i);return t[i]=Array.from(n).map((e=>e.scrollTop)),t}),{})}_restoreScrollPositions(e){const t=this.options.scrollY||[],i=this._scrollPositions||{};for(let n of t){e.find(n).each(((e,t)=>t.scrollTop=i[n]?.[e]||0))}}async _renderOuter(){const e=this.options.classes,t={id:this.id,classes:e.join(" "),appId:this.appId,title:this.title,headerButtons:this._getHeaderButtons()};let i=await renderTemplate("templates/app-window.html",t);i=$(i),setTimeout((()=>{i.find(".header-button").click((e=>{e.preventDefault();t.headerButtons.find((t=>e.currentTarget.classList.contains(t.class))).onclick(e)}))}),500);const n=i.find("header")[0];return new Draggable(this,i,n,this.options.resizable),this.options.minimizable&&n.addEventListener("dblclick",this._onToggleMinimize.bind(this)),this.position.zIndex=Math.min(++u,99999),i[0].style.zIndex=this.position.zIndex,ui.activeWindow=this,i}async _renderInner(e){let t=await renderTemplate(this.template,e);if(""===t)throw new Error(`No data was returned from template ${this.template}`);return $(t)}_replaceHTML(e,t){if(e.length)if(this.popOut){e.find(".window-content").html(t);let i=e.find(".window-title")[0];i.hasChildNodes()&&(i=i.childNodes[0]),i.textContent=this.title}else e.replaceWith(t),this._element=t}_injectHTML(e){$("body").append(e),this._element=e,e.hide().fadeIn(200)}_getHeaderButtons(){const e=[{label:"Close",class:"close",icon:"fas fa-times",onclick:()=>this.close()}];return this._callHooks((e=>`get${e}HeaderButtons`),e),e}_contextMenu(e){}_activateCoreListeners(e){const t=this.popOut?e[0].parentElement:e[0];this._tabs.forEach((e=>e.bind(t))),this._dragDrop.forEach((e=>e.bind(t))),this._searchFilters.forEach((e=>e.bind(t)))}activateListeners(e){}activateTab(e,{group:t,triggerCallback:i=!0}={}){if(!this._tabs.length)throw new Error(`${this.constructor.name} does not define any tabs`);const n=t?this._tabs.find((e=>e.group===t)):this._tabs[0];if(!n)throw new Error(`Tab group "${t}" not found in ${this.constructor.name}`);n.activate(e,{triggerCallback:i})}_onChangeTab(e,t,i){this.setPosition()}_onSearchFilter(e,t,i,n){}_canDragStart(e){return c.user.isGM}_canDragDrop(e){return c.user.isGM}_onDragStart(e){}_onDragOver(e){}_onDrop(e){}bringToTop(){if(ui.activeWindow===this)return;const e=this.element[0];document.defaultView.getComputedStyle(e).zIndex<u&&(this.position.zIndex=Math.min(++u,99999),e.style.zIndex=this.position.zIndex,ui.activeWindow=this)}async close(e={}){const t=Application.RENDER_STATES;if(!e.force&&![t.RENDERED,t.ERROR].includes(this._state))return;this._state=t.CLOSING;let i=this.element;return i?(i.css({minHeight:0}),this._callHooks("close",i),new Promise((e=>{i.slideUp(200,(()=>{i.remove(),this._element=null,delete ui.windows[this.appId],this._minimized=!1,this._scrollPositions=null,this._state=t.CLOSED,e()}))}))):this._state=t.CLOSED}async minimize(){if(!this.rendered||!this.popOut||[!0,null].includes(this._minimized))return;this._minimized=null;const e=this.element,t=e.find(".window-header"),i=e.find(".window-content");return this._saveScrollPositions(e),e.css({minWidth:100,minHeight:30}),i.slideUp(100),new Promise((i=>{e.animate({height:`${t[0].offsetHeight+1}px`},100,(()=>{e.animate({width:200},100,(()=>{e.addClass("minimized"),this._minimized=!0,i()}))}))}))}async maximize(){if(!this.popOut||[!1,null].includes(this._minimized))return;this._minimized=null;let e=this.element,t=e.find(".window-content");return new Promise((i=>{e.animate({width:this.position.width,height:this.position.height},100,(()=>{t.slideDown(100,(()=>{e.removeClass("minimized"),this._minimized=!1,e.css({minWidth:"",minHeight:""}),t.css({display:""}),this.setPosition(this.position),this._restoreScrollPositions(e),i()}))}))}))}setPosition({left:e,top:t,width:i,height:n,scale:s}={}){if(!this.popOut&&!this.options.resizable)return;const o=this.element[0],r=this.position,a=this.popOut,l=window.getComputedStyle(o);if(null===s&&(s=1),s=s??r.scale??1,"auto"!==n&&"auto"!==this.options.height||(o.style.height="",n=null),!o.style.width||i){const t=i||o.offsetWidth,n=parseInt(l.minWidth)||(a?200:0),c=o.style.maxWidth||window.innerWidth/s;r.width=i=Math.clamp(t,n,c),o.style.width=`${i}px`,i*s+r.left>window.innerWidth&&(e=r.left)}if(i=o.offsetWidth,!o.style.height||n){const e=n||o.offsetHeight+1,i=parseInt(l.minHeight)||(a?50:0),c=o.style.maxHeight||window.innerHeight/s;r.height=n=Math.clamp(e,i,c),o.style.height=`${n}px`,n*s+r.top>window.innerHeight+1&&(t=r.top-1)}if(n=o.offsetHeight,a&&!o.style.left||Number.isFinite(e)){const t=i*s,n=Number.isFinite(e)?e:(window.innerWidth-t)/2,a=Math.max(window.innerWidth-t,0);r.left=e=Math.clamp(n,0,a),o.style.left=`${e}px`}if(a&&!o.style.top||Number.isFinite(t)){const e=n*s,i=Number.isFinite(t)?t:(window.innerHeight-e)/2,a=Math.max(window.innerHeight-e,0);r.top=Math.clamp(i,0,a),o.style.top=`${r.top}px`}return s&&(r.scale=Math.max(s,0),o.style.transform=1===s?"":`scale(${s})`),r}_onToggleMinimize(e){e.preventDefault(),this._minimized?this.maximize(e):this.minimize(e)}_onResize(e){}_waitForImages(){return new Promise((e=>{let t=0;const i=Array.from(this.element.find("img")).filter((e=>!e.complete));i.length||e();for(const n of i)n.onload=n.onerror=()=>{t++,n.onload=n.onerror=null,t>=i.length&&e()}}))}}class FormApplication extends Application{constructor(e={},t={}){super(t),this.object=e,this.form=null,this.editors={}}static _customElements=Object.values(foundry.applications.elements).reduce(((e,t)=>(t.tagName&&e.push(t.tagName),e)),[]);static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["form"],closeOnSubmit:!0,editable:!0,sheetConfig:!1,submitOnChange:!1,submitOnClose:!1})}get isEditable(){return this.options.editable}getData(e={}){return{object:this.object,options:this.options,title:this.title}}async _render(e,t){let i=this.element.find(":focus");if(i=i.length?i[0]:null,await super._render(e,t),i&&i.name){const e=this.form?.[i.name];e&&e.focus instanceof Function&&e.focus()}}async _renderInner(...e){const t=await super._renderInner(...e);return this.form=t.filter(((e,t)=>t instanceof HTMLFormElement))[0],this.form||(this.form=t.find("form")[0]),t}_activateCoreListeners(e){if(super._activateCoreListeners(e),this.form)return this.isEditable?void(this.form.onsubmit=this._onSubmit.bind(this)):this._disableFields(this.form)}activateListeners(e){if(super.activateListeners(e),!this.isEditable)return;const t=["input","select","textarea"].concat(this.constructor._customElements);e.on("change",t.join(","),this._onChangeInput.bind(this)),e.find(".editor-content[data-edit]").each(((e,t)=>this._activateEditor(t))),e.find("button.file-picker").click(this._activateFilePicker.bind(this)),this._priorState<=this.constructor.RENDER_STATES.NONE&&e.find("[autofocus]")[0]?.focus()}_disableFields(e){const t=["INPUT","SELECT","TEXTAREA","BUTTON"];for(let i of t)for(let t of e.getElementsByTagName(i))"TEXTAREA"===i?t.readOnly=!0:t.disabled=!0}async _onSubmit(e,{updateData:t=null,preventClose:i=!1,preventRender:n=!1}={}){e.preventDefault();const s=this.constructor.RENDER_STATES;if(this._state===s.NONE||!this.isEditable||this._submitting)return!1;this._submitting=!0;const o=this._getSubmitData(t);let r=this.options.closeOnSubmit&&!i;const a=this._state;n&&(this._state=s.RENDERING),r&&(this._state=s.CLOSING);try{await this._updateObject(e,o)}catch(e){console.error(e),r=!1,this._state=a}return this._submitting=!1,n&&(this._state=a),r&&await this.close({submit:!1,force:!0}),o}_getSubmitData(e={}){if(!this.form)throw new Error("The FormApplication subclass has no registered form element");let t=new FormDataExtended(this.form,{editors:this.editors}).object;return e&&(t=foundry.utils.flattenObject(foundry.utils.mergeObject(t,e))),t}async _onChangeInput(e){if(e.currentTarget.matches("prose-mirror"))return this._onSubmit(e);if(e.currentTarget.closest(".editor"))return;const t=e.target;return"color"===t.type&&t.dataset.edit?this._onChangeColorPicker(e):"range"===t.type&&this._onChangeRange(e),this.options.submitOnChange?this._onSubmit(e):void 0}_onChangeColorPicker(e){const t=e.target;t.form[t.dataset.edit].value=t.value}_onChangeRange(e){const t=e.target.parentElement.querySelector(".range-value");t&&("INPUT"===t.tagName?t.value=e.target.value:t.innerHTML=e.target.value)}async _updateObject(e,t){throw new Error("A subclass of the FormApplication must implement the _updateObject method.")}async activateEditor(e,t={},i=""){const n=this.editors[e];if(!n)throw new Error(`${e} is not a registered editor name!`);(t=foundry.utils.mergeObject(n.options,t)).fitToSize||(t.height=t.target.offsetHeight),n.hasButton&&(n.button.style.display="none");const s=n.instance=n.mce=await TextEditor$1.create(t,i||n.initial);return t.target.closest(".editor")?.classList.add(t.engine??"tinymce"),n.changed=!1,n.active=!0,"prosemirror"!==t.engine&&(s.focus(),s.on("change",(()=>n.changed=!0))),s}async saveEditor(e,{remove:t=!0,preventRender:i}={}){const n=this.editors[e];if(!n||!n.instance)throw new Error(`${e} is not an active editor name!`);n.active=!1;const s=n.instance;await this._onSubmit(new Event("submit"),{preventRender:i}),t&&(s.destroy(),n.instance=n.mce=null,n.hasButton&&(n.button.style.display="block"),this.render()),n.changed=!1}_activateEditor(e){const t=e.dataset.edit,i=e.dataset.engine||"tinymce",n="true"===e.dataset.collaborate,s=e.previousElementSibling,o=s&&s.classList.contains("editor-edit"),r=e.parentElement.parentElement,a=e.closest(".window-content"),l=[r.offsetHeight,a?a.offsetHeight:null];e.offsetHeight>0&&l.push(e.offsetHeight);const c=Math.min(...l.filter((e=>Number.isFinite(e)))),d={target:e,fieldName:t,save_onsavecallback:()=>this.saveEditor(t),height:c,engine:i,collaborate:n};"prosemirror"===i&&(d.plugins=this._configureProseMirrorPlugins(t,{remove:o}));const u=foundry.utils.getProperty(this.object,t),h=this.editors[t]={options:d,target:t,button:s,hasButton:o,mce:null,instance:null,active:!o,changed:!1,initial:u},activate=()=>{h.initial=foundry.utils.getProperty(this.object,t),this.activateEditor(t,{},h.initial)};o?s.onclick=activate:activate()}_configureProseMirrorPlugins(e,{remove:t=!0}={}){return{menu:ProseMirror.ProseMirrorMenu.build(ProseMirror.defaultSchema,{destroyOnSave:t,onSave:()=>this.saveEditor(e,{remove:t})}),keyMaps:ProseMirror.ProseMirrorKeyMaps.build(ProseMirror.defaultSchema,{onSave:()=>this.saveEditor(e,{remove:t})})}}async close(e={}){const t=Application.RENDER_STATES;if(!e.force&&![t.RENDERED,t.ERROR].includes(this._state))return;(e.submit??this.options.submitOnClose)&&await this.submit({preventClose:!0,preventRender:!0});for(let e of this.#ne)e.close();this.#ne.length=0;for(const e of this.element[0].querySelectorAll("file-picker"))e.picker?.close();for(let e of Object.values(this.editors))e.mce&&e.mce.destroy();return this.editors={},super.close(e)}async submit(e={}){if(this._submitting)return this;const t=new Event("submit");return await this._onSubmit(t,e),this}get filepickers(){return foundry.utils.logCompatibilityWarning("FormApplication#filepickers is deprecated and replaced by the <file-picker>HTML element",{since:12,until:14,once:!0}),this.#ne}#ne=[];_activateFilePicker(e){foundry.utils.logCompatibilityWarning("FormApplication#_activateFilePicker is deprecated without replacement",{since:12,until:14,once:!0}),e.preventDefault();const t=this._getFilePickerOptions(e),i=new FilePicker(t);return this.#ne.push(i),i.browse()}_getFilePickerOptions(e){foundry.utils.logCompatibilityWarning("FormApplication#_getFilePickerOptions is deprecated without replacement",{since:12,until:14,once:!0});const t=e.currentTarget,i=t.dataset.target,n=t.form[i]||null;return{field:n,type:t.dataset.type,current:n?.value??"",button:t,callback:this._onSelectFile.bind(this)}}_onSelectFile(e,t){}}class DocumentSheet extends FormApplication{constructor(e,t={}){super(e,t),this._secrets=this._createSecretHandlers()}_secrets=[];static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet"],template:`templates/sheets/${this.name.toLowerCase()}.html`,viewPermission:CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED,sheetConfig:!0,secrets:[]})}get document(){return this.object}get id(){return`${this.constructor.name}-${this.document.uuid.replace(/\./g,"-")}`}get isEditable(){let e=this.options.editable&&this.document.isOwner;if(this.document.pack){c.packs.get(this.document.pack).locked&&(e=!1)}return e}get title(){const e=this.document.name?`: ${this.document.name}`:"";return`${c.i18n.localize(this.document.constructor.metadata.label)}${e}`}async close(e={}){await super.close(e),delete this.object.apps?.[this.appId]}getData(e={}){const t=this.document.toObject(!1),i=this.isEditable;return{cssClass:i?"editable":"locked",editable:i,document:this.document,data:t,limited:this.document.limited,options:this.options,owner:this.document.isOwner,title:this.title}}_activateCoreListeners(e){super._activateCoreListeners(e),this.isEditable&&e.find("img[data-edit]").on("click",this._onEditImage.bind(this)),this.document.isOwner&&this._secrets.forEach((t=>t.bind(e[0])))}async activateEditor(e,t={},i=""){const n=this.editors[e];return t.document=this.document,"prosemirror"===n?.options.engine&&(t.plugins=foundry.utils.mergeObject({highlightDocumentMatches:ProseMirror.ProseMirrorHighlightMatchesPlugin.build(ProseMirror.defaultSchema)},t.plugins)),super.activateEditor(e,t,i)}async _render(e,t={}){if(this._canUserView(c.user))t.editable=t.editable??this.object.isOwner,await super._render(e,t),this.object.apps[this.appId]=this;else{if(!e)return;const t=c.i18n.format("SHEETS.DocumentSheetPrivate",{type:c.i18n.localize(this.object.constructor.metadata.label)});ui.notifications.warn(t)}}async _renderOuter(){const e=await super._renderOuter();return this._createDocumentIdLink(e),e}_createDocumentIdLink(e){if(!(this.object instanceof foundry.abstract.Document&&this.object.id))return;const t=e.find(".window-title"),i=c.i18n.localize(this.object.constructor.metadata.label),n=document.createElement("a");n.classList.add("document-id-link"),n.ariaLabel=c.i18n.localize("SHEETS.CopyUuid"),n.dataset.tooltip="SHEETS.CopyUuid",n.dataset.tooltipDirection="UP",n.innerHTML='<i class="fa-solid fa-passport"></i>',n.addEventListener("click",(e=>{e.preventDefault(),c.clipboard.copyPlainText(this.object.uuid),ui.notifications.info(c.i18n.format("DOCUMENT.IdCopiedClipboard",{label:i,type:"uuid",id:this.object.uuid}))})),n.addEventListener("contextmenu",(e=>{e.preventDefault(),c.clipboard.copyPlainText(this.object.id),ui.notifications.info(c.i18n.format("DOCUMENT.IdCopiedClipboard",{label:i,type:"id",id:this.object.id}))})),t.append(n)}_canUserView(e){return this.object.testUserPermission(e,this.options.viewPermission)}_createSecretHandlers(){return!this.document.isOwner||this.document.compendium?.locked?[]:this.options.secrets.map((e=>(e.callbacks={content:this._getSecretContent.bind(this),update:this._updateSecret.bind(this)},new HTMLSecret(e))))}_getHeaderButtons(){let e=super._getHeaderButtons();return"Folder"!==this.document.constructor.name&&!this.document.isEmbedded&&this.document.compendium&&this.document.constructor.canUserCreate(c.user)&&e.unshift({label:"Import",class:"import",icon:"fas fa-download",onclick:async()=>(await this.close(),this.document.collection.importFromCompendium(this.document.compendium,this.document.id))}),this.options.sheetConfig&&this.isEditable&&!0!==this.document.getFlag("core","sheetLock")&&e.unshift({label:"Sheet",class:"configure-sheet",icon:"fas fa-cog",onclick:e=>this._onConfigureSheet(e)}),e}_getSecretContent(e){const t=e.closest("[data-edit]")?.dataset.edit;if(t)return foundry.utils.getProperty(this.document,t)}_updateSecret(e,t){const i=e.closest("[data-edit]")?.dataset.edit;if(i)return this.document.update({[i]:t})}_onConfigureSheet(e){e.preventDefault(),new DocumentSheetConfig(this.document,{top:this.position.top+40,left:this.position.left+(this.position.width-DocumentSheet.defaultOptions.width)/2}).render(!0)}_onEditImage(e){const t=e.currentTarget.dataset.edit,i=foundry.utils.getProperty(this.object,t),{img:n}=this.document.constructor.getDefaultArtwork?.(this.document.toObject())??{};return new FilePicker({current:i,type:"image",redirectToRoot:n?[n]:[],callback:t=>{if(e.currentTarget.src=t,this.options.submitOnChange)return this._onSubmit(e)},top:this.position.top+40,left:this.position.left+10}).browse()}async _updateObject(e,t){if(this.object.id)return this.object.update(t)}}class Localization{constructor(e){const[t,i]=(e||"en.core").split(".");this.lang=t,this.defaultModule=i,this.translations={},this._fallback={}}#se={};async initialize(){const e=await c.settings.get("core","language")||this.lang;if(this._discoverSupportedLanguages(),e!==this.lang&&(this.defaultModule="core"),await this.setLanguage(e||this.lang),c.system)for(let[e,t]of Object.entries(c.documentTypes)){const i=g[e];i.typeLabels=i.typeLabels||{};for(const n of t){if(i.typeLabels[n])continue;const t=n===CONST.BASE_DOCUMENT_TYPE?"TYPES.Base":`TYPES.${e}.${n}`;i.typeLabels[n]=t;const s=`${e.toUpperCase()}.Type${n.titleCase()}`;!this.has(t)&&this.has(s)&&(foundry.utils.logCompatibilityWarning(`You are using the '${s}' localization key which has been deprecated. Please define a '${t}' key instead.`,{since:11,until:13}),i.typeLabels[n]=s)}}Localization.#oe(),Hooks$1.callAll("i18nInit")}static localizeDataModel(e,{prefixes:t,prefixPath:i}={}){t||=e.LOCALIZATION_PREFIXES,Localization.#re(e.schema,t,{prefixPath:i})}static#oe(){for(const e of Object.values(foundry.documents)){const t=e.implementation;Localization.localizeDataModel(t);for(const e of Object.values(g[t.documentName].dataModels??{}))Localization.localizeDataModel(e,{prefixPath:"system."})}}static#re(e,t=[],{prefixPath:i=""}={}){const getRules=e=>{const t={};for(const i of e){if("en"!==c.i18n.lang){const e=foundry.utils.getProperty(c.i18n._fallback,`${i}.FIELDS`);Object.assign(t,e)}Object.assign(t,foundry.utils.getProperty(c.i18n.translations,`${i}.FIELDS`))}return t},n=getRules(t);e.apply((function(){this instanceof foundry.data.fields.EmbeddedDataField&&this.model.LOCALIZATION_PREFIXES.length&&foundry.utils.setProperty(n,this.fieldPath,getRules(this.model.LOCALIZATION_PREFIXES));let e=this.fieldPath;i&&(e=e.replace(i,""));const t=foundry.utils.getProperty(n,e);t?.label&&(this.label=c.i18n.localize(t.label)),t?.hint&&(this.hint=c.i18n.localize(t.hint))}))}async setLanguage(e){Object.keys(g.supportedLanguages).includes(e)||(console.error(`Cannot set language ${e}, as it is not in the supported set. Falling back to English`),e="en"),this.lang=e,document.documentElement.setAttribute("lang",this.lang),this.translations=await this._getTranslations(e),"en"!==e&&(this._fallback=await this._getTranslations("en"))}_discoverSupportedLanguages(){const e=g.supportedLanguages,t=Array.from(c.modules.values());c.world&&t.push(c.world),c.system&&t.push(c.system),c.worlds&&t.push(...c.worlds.values()),c.systems&&t.push(...c.systems.values());const register=t=>{if(t.languages.size)for(let i of t.languages)e.hasOwnProperty(i.lang)||(e[i.lang]=i.name)};for(let e of c.modules)e.coreTranslation&&register(e);for(let e of t)e.coreTranslation||"module"===e.type&&!e.active||register(e);return e}async _getTranslations(e){const t={},i=[];CONST.CORE_SUPPORTED_LANGUAGES.includes(e)&&i.push(this._loadTranslationFile(`lang/${e}.json`)),c.system&&this._filterLanguagePaths(c.system,e).forEach((e=>{i.push(this._loadTranslationFile(e))}));for(let t of c.modules.values())(t.active||t.id===this.defaultModule)&&this._filterLanguagePaths(t,e).forEach((e=>{i.push(this._loadTranslationFile(e))}));c.world&&this._filterLanguagePaths(c.world,e).forEach((e=>{i.push(this._loadTranslationFile(e))})),await Promise.all(i);for(let e of i){let i=await e;foundry.utils.mergeObject(t,i,{inplace:!0})}return t}_filterLanguagePaths(e,t){return e.languages.reduce(((e,i)=>{if(i.lang!==t)return e;let n=!i.system||c.system&&i.system===c.system.id,s=!i.module||c.modules.get(i.module)?.active;return n&&s&&e.push(i.path),e}),[])}async _loadTranslationFile(e){let t;const i=await fetch(e).catch((e=>(t=e,{})));if(200!==i.status){const i=`Unable to load requested localization file ${e}`;return console.error(`${l} | ${i}`),t&&Hooks$1.onError("Localization#_loadTranslationFile",t,{msg:i,src:e}),{}}let n;try{n=await i.json(),console.log(`${l} | Loaded localization file ${e}`),n=foundry.utils.expandObject(n)}catch(t){Hooks$1.onError("Localization#_loadTranslationFile",t,{msg:`Unable to parse localization file ${e}`,log:"error",src:e}),n={}}return n}has(e,t=!0){let i=foundry.utils.getProperty(this.translations,e);return"string"==typeof i||!!t&&(i=foundry.utils.getProperty(this._fallback,e),"string"==typeof i)}localize(e){let t=foundry.utils.getProperty(this.translations,e);return"string"==typeof t?t:(t=foundry.utils.getProperty(this._fallback,e),"string"==typeof t?t:e)}format(e,t={}){let i=this.localize(e);return i=i.replace(/{[^}]+}/g,(e=>t[e.slice(1,-1)])),i}getListFormatter({style:e="long",type:t="conjunction"}={}){const i=`${e}${t}`;return this.#se[i]??=new Intl.ListFormat(this.lang,{style:e,type:t}),this.#se[i]}sortObjects(e,t){const i=new Intl.Collator(this.lang);return e.sort(((e,n)=>i.compare(foundry.utils.getProperty(e,t),foundry.utils.getProperty(n,t)))),e}}async function getTemplate(e,t){if(e in Handlebars.partials)return Handlebars.partials[e];const i=await new Promise(((t,i)=>{c.socket.emit("template",e,(e=>e.error?i(new Error(e.error)):t(e.html)))})),n=Handlebars.compile(i);return Handlebars.registerPartial(t??e,n),console.log(`Foundry VTT | Retrieved and compiled template ${e}`),n}async function loadTemplates(e){let t;return t="Object"===foundry.utils.getType(e)?Object.entries(e).map((([e,t])=>getTemplate(t,e))):e.map((e=>getTemplate(e))),Promise.all(t)}async function renderTemplate(e,t){return(await getTemplate(e))(t||{},{allowProtoMethodsByDefault:!0,allowProtoPropertiesByDefault:!0})}HandlebarsIntl.registerWith(Handlebars);class HandlebarsHelpers{static checked(e){return Boolean(e)?"checked":""}static disabled(e){return e?"disabled":""}static concat(...e){const t=e.pop(),i=t.hash?.join||"";return new Handlebars.SafeString(e.join(i))}static editor(e,t){const{target:i,editable:n=!0,button:s,engine:o="tinymce",collaborate:r=!1,class:a}=t.hash,l={name:i,value:e,button:s,collaborate:r,editable:n,engine:o},c=foundry.applications.fields.createEditorInput(l);return a&&c.querySelector(".editor-content").classList.add(a),new Handlebars.SafeString(c.outerHTML)}static ifThen(e,t,i){return e?t:i}static localize(e,t){e instanceof Handlebars.SafeString&&(e=e.toString());const i=t.hash;return foundry.utils.isEmpty(i)?c.i18n.localize(e):c.i18n.format(e,i)}static numberFormat(e,t){const i=e,n=t.hash.decimals??0,s=t.hash.sign||!1;"string"!=typeof e&&null!=e||(e=parseFloat(e)),Number.isNaN(e)&&console.warn("An invalid value was passed to numberFormat:",{originalValue:i,valueType:typeof i,options:t});let o=s&&e>=0?`+${e.toFixed(n)}`:e.toFixed(n);return new Handlebars.SafeString(o)}static numberInput(e,t){const{class:i,...n}=t.hash;n.value=e;const s=foundry.applications.fields.createNumberInput(n);return i&&(s.className=i),new Handlebars.SafeString(s.outerHTML)}static radioBoxes(e,t,i){const n=i.hash.checked||null,s=i.hash.localize||!1;let o="";for(let[i,r]of Object.entries(t)){s&&(r=c.i18n.localize(r));o+=`<label class="checkbox"><input type="radio" name="${e}" value="${i}" ${n===i?"checked":""}> ${r}</label>`}return new Handlebars.SafeString(o)}static rangePicker(e){let{name:t,value:i,min:n,max:s,step:o}=e.hash;t=t||"range",i=i??"",Number.isNaN(i)&&(i="");const r=`<input type="range" name="${t}" value="${i}" min="${n}" max="${s}" step="${o}"/>\n     <span class="range-value">${i}</span>`;return new Handlebars.SafeString(r)}static selectOptions(e,t){let{localize:i=!1,selected:n,blank:s,sort:o,nameAttr:r,valueAttr:a,labelAttr:l,inverted:c,groups:d}=t.hash;null==n?n=[]:n instanceof Array||(n=[n]),r&&!a&&(foundry.utils.logCompatibilityWarning('The "nameAttr" property of the {{selectOptions}} handlebars helper is \n        renamed to "valueAttr" for consistency with other methods.',{since:12,until:14}),a=r);const u=[];if(e instanceof Array)for(const[t,i]of e.entries())"object"==typeof i?u.push(i):u.push({value:t,label:i});else for(const t of Object.entries(e)){const[e,i]=c?t.reverse():t,n=a?i[a]:e;"object"==typeof i?u.push({value:n,...i}):u.push({value:n,label:i})}const h=foundry.applications.fields.createSelectInput({options:u,value:n,blank:s,groups:d,labelAttr:l,localize:i,sort:o,valueAttr:a});return new Handlebars.SafeString(h.innerHTML)}static formInput(e,t){const i=e.toInput(t.hash);return new Handlebars.SafeString(i.outerHTML)}static formGroup(e,t){const{classes:i,label:n,hint:s,rootId:o,stacked:r,units:a,widget:l,...c}=t.hash,d={label:n,hint:s,rootId:o,stacked:r,widget:l,localize:c.localize,units:a,classes:"string"==typeof i?i.split(" "):[]},u=e.toFormGroup(d,c);return new Handlebars.SafeString(u.outerHTML)}static filePicker(e){foundry.utils.logCompatibilityWarning("The {{filePicker}} Handlebars helper is deprecated and replaced by use of the <file-picker> custom HTML element",{since:12,until:14,once:!0});const t=e.hash.type,i=e.hash.target;if(!i)throw new Error("You must define the name of the target field.");if(c.world&&!c.user.can("FILES_BROWSE"))return"";const n=c.i18n.localize("FILES.BrowseTooltip");return new Handlebars.SafeString(`\n    <button type="button" class="file-picker" data-type="${t}" data-target="${i}" title="${n}" tabindex="-1">\n        <i class="fas fa-file-import fa-fw"></i>\n    </button>`)}static colorPicker(e){foundry.utils.logCompatibilityWarning("The {{colorPicker}} Handlebars helper is deprecated and replaced by use of the <color-picker> custom HTML element",{since:12,until:14,once:!0});let{name:t,default:i,value:n}=e.hash;t=t||"color",n=n||i||"";const s=`<color-picker name="${t}" value="${n}"></color-picker>`;return new Handlebars.SafeString(s)}static select(e,t){foundry.utils.logCompatibilityWarning("The {{select}} handlebars helper is deprecated in favor of using the {{selectOptions}} helper or the foundry.applications.fields.createSelectInput, foundry.applications.fields.createMultiSelectElement, or foundry.applications.fields.prepareSelectOptionGroups methods.",{since:12,until:14});const i=RegExp.escape(Handlebars.escapeExpression(e)),n=new RegExp(` value=["']${i}["']`);return t.fn(this).replace(n,"$& selected")}}Handlebars.registerHelper({checked:HandlebarsHelpers.checked,disabled:HandlebarsHelpers.disabled,colorPicker:HandlebarsHelpers.colorPicker,concat:HandlebarsHelpers.concat,editor:HandlebarsHelpers.editor,formInput:HandlebarsHelpers.formInput,formGroup:HandlebarsHelpers.formGroup,formField:HandlebarsHelpers.formGroup,filePicker:HandlebarsHelpers.filePicker,ifThen:HandlebarsHelpers.ifThen,numberFormat:HandlebarsHelpers.numberFormat,numberInput:HandlebarsHelpers.numberInput,localize:HandlebarsHelpers.localize,radioBoxes:HandlebarsHelpers.radioBoxes,rangePicker:HandlebarsHelpers.rangePicker,select:HandlebarsHelpers.select,selectOptions:HandlebarsHelpers.selectOptions,timeSince:foundry.utils.timeSince,eq:(e,t)=>e===t,ne:(e,t)=>e!==t,lt:(e,t)=>e<t,gt:(e,t)=>e>t,lte:(e,t)=>e<=t,gte:(e,t)=>e>=t,not:e=>!e,and(){return Array.prototype.every.call(arguments,Boolean)},or(){return Array.prototype.slice.call(arguments,0,-1).some(Boolean)}});class Game{constructor(e,t,i,n){Object.defineProperties(this,{view:{value:e,enumerable:!0},sessionId:{value:i,enumerable:!0},socket:{value:n,enumerable:!0},userId:{value:t.userId||null,enumerable:!0},data:{value:t,enumerable:!0},release:{value:new foundry.config.ReleaseData(t.release),enumerable:!0}}),this.setupPackages(t),Object.defineProperties(this,{audio:{value:new foundry.audio.AudioHelper,enumerable:!0},canvas:{value:new Canvas,enumerable:!0},clipboard:{value:new ClipboardHelper,enumerable:!0},collections:{value:new foundry.utils.Collection,enumerable:!0},compendiumArt:{value:new foundry.helpers.CompendiumArt,enumerable:!0},documentIndex:{value:new DocumentIndex,enumerable:!0},i18n:{value:new Localization(t?.options?.language),enumerable:!0},issues:{value:new ClientIssues,enumerable:!0},gamepad:{value:new GamepadManager,enumerable:!0},keyboard:{value:new KeyboardManager,enumerable:!0},mouse:{value:new MouseManager,enumerable:!0},nue:{value:new NewUserExperience,enumerable:!0},packs:{value:new CompendiumPacks,enumerable:!0},settings:{value:new ClientSettings(t.settings||[]),enumerable:!0},time:{value:new GameTime(n),enumerable:!0},tooltip:{value:new TooltipManager,configurable:!0,enumerable:!0},tours:{value:new Tours,enumerable:!0},video:{value:new VideoHelper,enumerable:!0},workers:{value:new WorkerManager,enumerable:!0},keybindings:{value:new ClientKeybindings,enumerable:!0}}),Object.defineProperty(globalThis,"canvas",{value:this.canvas,writable:!0})}view;data;sessionId;socket;userId;world;system;modules;packs;get model(){return this.#ae}#ae;get documentTypes(){return this.#le}#le;documentIndex;compendiumUUIDRedirects;collections;actors;cards;combats;folders;items;journal;macros;messages;playlists;scenes;tables;users;release;get version(){return this.release.version}debug=!1;loading=!1;permissions;ready=!1;static#ce=[];compendiumArt;audio;canvas;clipboard;i18n;issues;gamepad;keyboard;keybindings;mouse;nue;settings;time;tooltip;tours;video;workers;static async create(e,t){const i=t?await this.connect(t):null;return new this(e,i?await this.getData(i,e):{},t,i)}static async connect(e){const t=await new Promise(((t,i)=>{const n=io.connect({path:foundry.utils.getRoute("socket.io"),transports:["websocket"],upgrade:!1,reconnection:!0,reconnectionDelay:500,reconnectionAttempts:10,reconnectionDelayMax:500,query:{session:e},cookie:!1});n.on("session",(i=>{n.session=i;const s=i.sessionId;if(!s||e&&e!==s)return foundry.utils.debouncedReload();console.log(`${l} | Connected to server socket using session ${s}`),t(n)})),n.on("connectTimeout",(()=>{i(new Error("Failed to establish a socket connection within allowed timeout."))})),n.on("connectError",(e=>i(e)))}));t.prependAny(Game.#de);let i=0;t.on("disconnect",(()=>{i=Date.now(),ui.notifications.error("You have lost connection to the server, attempting to re-establish.")})),t.io.on("reconnect_attempt",(()=>{const e=Date.now();console.log(`${l} | Attempting to re-connect: ${((e-i)/1e3).toFixed(2)} seconds`)})),t.io.on("reconnect_failed",(()=>{ui.notifications.error(`${l} | Server connection lost.`),window.location.href=foundry.utils.getRoute("no")}));return t.io.on("reconnect",(()=>{ui.notifications.info(`${l} | Server connection re-established.`),Date.now()-i>=5e3&&foundry.utils.debouncedReload()})),t}static#de(...e){Game.#ce.push(Object.freeze(e))}static#ue(){for(;Game.#ce.length;){const e=Game.#ce.shift();console.log(`Applying buffered socket event: ${e[0]}`),c.socket.emitEvent(e)}}static getCookies(){const e={};for(let t of document.cookie.split("; ")){let[i,n]=t.split("=");e[i]=decodeURIComponent(n)}return e}static async getData(e,t){return e.session.userId||(e.disconnect(),window.location.href=foundry.utils.getRoute("join")),new Promise((t=>{e.emit("world",t)}))}static async getWorldStatus(e){const t=await new Promise((t=>{e.emit("getWorldStatus",t)}));return console.log(`${l} | The game World is currently ${t?"active":"not active"}`),t}setupPackages(e){e.world&&(this.world=new World(e.world)),e.system&&(this.system=new System(e.system),this.#ae=Object.freeze(e.model),this.#he=Object.freeze(e.template),this.#le=Object.freeze(Object.entries(this.model).reduce(((e,[t,i])=>(e[t]=Object.keys(i),e)),{}))),this.modules=new foundry.utils.Collection(e.modules.map((e=>[e.id,new Module(e)])))}getPackageScopes(){return g.DatabaseBackend.getFlagScopes()}async initialize(){console.log(`${l} | Initializing Foundry Virtual Tabletop Game`),this.ready=!1,Hooks$1.callAll("init"),this.registerSettings(),await this.i18n.initialize(),await this.registerTours(),this.activateListeners(),await this._initializeView(),this.issues._detectUsabilityIssues()}async shutDown(){if(!c.user?.isGM&&!c.data.isAdmin)throw new Error("Only a Gamemaster User or server Administrator may shut down the currently active world");const e=c.users.filter((e=>e.active&&!e.isSelf)).length;if(e){const t=e>1?"GAME.ReturnSetupActiveUsers":"GAME.ReturnSetupActiveUser";if(!await Dialog.confirm({title:c.i18n.localize("GAME.ReturnSetup"),content:`<p>${c.i18n.format(t,{number:e})}</p>`}))return}const t=foundry.utils.getRoute("setup"),i=await foundry.utils.fetchWithTimeout(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shutdown:!0}),redirect:"manual"});setTimeout((()=>window.location.href=i.url),1e3)}async setupGame(){this.permissions=await this.settings.get("core","permissions"),this.initializeConfig(),this.initializePacks(),this.initializeDocuments(),foundry.abstract.EmbeddedCollection.prototype.search=DocumentCollection.prototype.search,Hooks$1.callAll("setup"),this.playlists.initialize(),this.initializeRTC(),this.initializeMouse(),this.initializeGamepads(),this.initializeKeyboard(),this.#pe(),foundry.canvas.tokens.TokenRingConfig.initialize(),this.canvas.initializing=this.initializeCanvas(),this.initializeUI(),DocumentSheetConfig.initializeSheets(),this.user.isGM||this.user.character||this.user.sheet.render(!0),await this.documentIndex.index(),await this.canvas.initializing,this.ready=!0,this.activateSocketListeners(),Hooks$1.callAll("ready"),this.nue.initialize()}initializeConfig(){Object.assign(g.Token.ring.subjectPaths,this.system.flags?.tokenRingSubjectMappings);for(const e of this.modules)e.active&&Object.assign(g.Token.ring.subjectPaths,e.flags?.tokenRingSubjectMappings);this.compendiumArt._registerArt()}initializeDocuments(){const e=["FogExploration","Setting"],t=["User","Folder","Actor","Item","Scene","Combat","JournalEntry","Macro","Playlist","RollTable","Cards","ChatMessage"];if(!new Set(t).equals(new Set(CONST.WORLD_DOCUMENT_TYPES.filter((t=>!e.includes(t))))))throw new Error("Missing Document initialization type!");const i=[];for(const e of t){const t=getDocumentClass(e);for(const e of t.schema.keys())if(e in t.prototype){const n=`The ${t.name} class defines the "${e}" attribute which collides with the "${e}" key in the ${t.documentName} data schema`;i.push(n)}}if(i.length)throw i.unshift("Version 10 Compatibility Failure","-".repeat(90),"Several Document class definitions include properties which collide with the new V10 DataModel:","-".repeat(90)),new Error(i.join("\n"));this._documentsReady=!1;const n=performance.now();for(let e of t){const t=g[e].documentClass,i=g[e].collection,n=t.metadata.collection;this[n]=new i(this.data[n]),this.collections.set(e,this[n])}this._documentsReady=!0;for(const e of this.collections.values())for(let t of e)t._safePrepareData();this.collections.set("Setting",this.settings.storage.get("world"));const s=g.FogExploration.collection;this.collections.set("FogExploration",new s);const o=performance.now()-n;console.debug(`${l} | Prepared World Documents in ${Math.round(o)}ms`)}initializePacks(){for(let e of this.data.packs){let t=this.packs.get(e.id);t||(t=new CompendiumCollection(e)),this.packs.set(t.collection,t);for(let e of t.contents)e.render(!1,{editable:!t.locked});t.apps.forEach((e=>e.render(!1)))}return this.packs}initializeRTC(){return this.webrtc=new AVMaster,this.webrtc.connect()}initializeUI(){matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(()=>this.#ge())),this.#ge();for(let[e,t]of Object.entries(g.ui))ui[e]=new t;for(let e of this.packs.values())if(Application.isPrototypeOf(e.applicationClass)){const t=new e.applicationClass({collection:e});e.apps.push(t)}ui.nav.render(!0),ui.notifications.render(!0),ui.sidebar.render(!0),ui.players.render(!0),ui.hotbar.render(!0),ui.webrtc.render(!0),ui.pause.render(!0),ui.controls.render(!0),this.scaleFonts()}async initializeCanvas(){await FontConfig._loadFonts();const e=c.scenes.current;try{this.canvas.initialize(),e?await e.view():this.canvas.initialized&&await this.canvas.draw(null)}catch(e){Hooks$1.onError("Game#initializeCanvas",e,{msg:"Failed to render WebGL canvas",log:"error"})}}initializeKeyboard(){Object.defineProperty(globalThis,"keyboard",{value:this.keyboard,writable:!1,enumerable:!0}),this.keyboard._activateListeners();try{c.keybindings._registerCoreKeybindings(this.view),c.keybindings.initialize()}catch(e){console.error(e)}}initializeMouse(){this.mouse._activateListeners()}initializeGamepads(){this.gamepad._activateListeners()}registerSettings(){c.settings.registerMenu("core","permissions",{name:"PERMISSION.Configure",label:"PERMISSION.ConfigureLabel",hint:"PERMISSION.ConfigureHint",icon:"fas fa-user-lock",type:foundry.applications.apps.PermissionConfig,restricted:!0}),c.settings.register("core","permissions",{name:"Permissions",scope:"world",default:{},type:Object,config:!1,onChange:e=>{c.permissions=e,ui.controls&&ui.controls.initialize(),ui.sidebar&&ui.sidebar.render(),canvas.ready&&canvas.controls.drawCursors()}}),c.settings.registerMenu("core","webrtc",{name:"WEBRTC.Title",label:"WEBRTC.MenuLabel",hint:"WEBRTC.MenuHint",icon:"fas fa-headset",type:AVConfig,restricted:!1}),c.settings.register("core","rtcWorldSettings",{name:"WebRTC (Audio/Video Conferencing) World Settings",scope:"world",default:AVSettings.DEFAULT_WORLD_SETTINGS,type:Object,onChange:()=>c.webrtc.settings.changed()}),c.settings.register("core","rtcClientSettings",{name:"WebRTC (Audio/Video Conferencing) Client specific Configuration",scope:"client",default:AVSettings.DEFAULT_CLIENT_SETTINGS,type:Object,onChange:()=>c.webrtc.settings.changed()}),c.settings.registerMenu("core",DefaultTokenConfig.SETTING,{name:"SETTINGS.DefaultTokenN",label:"SETTINGS.DefaultTokenL",hint:"SETTINGS.DefaultTokenH",icon:"fas fa-user-alt",type:DefaultTokenConfig,restricted:!0}),c.settings.register("core",DefaultTokenConfig.SETTING,{name:"SETTINGS.DefaultTokenN",hint:"SETTINGS.DefaultTokenL",scope:"world",type:Object,default:{},requiresReload:!0}),c.settings.registerMenu("core",FontConfig.SETTING,{name:"SETTINGS.FontConfigN",label:"SETTINGS.FontConfigL",hint:"SETTINGS.FontConfigH",icon:"fa-solid fa-font",type:FontConfig,restricted:!0}),c.settings.register("core",FontConfig.SETTING,{scope:"world",type:Object,default:{}}),c.settings.registerMenu("core",Combat.CONFIG_SETTING,{name:"SETTINGS.CombatConfigN",label:"SETTINGS.CombatConfigL",hint:"SETTINGS.CombatConfigH",icon:"fa-solid fa-swords",type:CombatTrackerConfig}),c.settings.register("core","noCanvas",{name:"SETTINGS.NoCanvasN",hint:"SETTINGS.NoCanvasL",scope:"client",config:!0,type:new foundry.data.fields.BooleanField({initial:!1}),requiresReload:!0}),c.settings.register("core","language",{name:"SETTINGS.LangN",hint:"SETTINGS.LangL",scope:"client",config:!0,type:new foundry.data.fields.StringField({required:!0,blank:!1,initial:c.i18n.lang,choices:g.supportedLanguages}),requiresReload:!0}),c.settings.register("core","colorScheme",{name:"SETTINGS.ColorSchemeN",hint:"SETTINGS.ColorSchemeH",scope:"client",config:!0,type:new foundry.data.fields.StringField({required:!0,blank:!0,initial:"",choices:{"":"SETTINGS.ColorSchemeDefault",dark:"SETTINGS.ColorSchemeDark",light:"SETTINGS.ColorSchemeLight"}}),onChange:()=>this.#ge()}),foundry.canvas.tokens.TokenRingConfig.registerSettings(),c.settings.register("core","rollMode",{name:"Default Roll Mode",scope:"client",config:!1,type:new foundry.data.fields.StringField({required:!0,blank:!1,initial:CONST.DICE_ROLL_MODES.PUBLIC,choices:g.Dice.rollModes}),onChange:ChatLog._setRollMode}),c.settings.register("core","diceConfiguration",{config:!1,default:{},type:Object,scope:"client"}),c.settings.registerMenu("core","diceConfiguration",{name:"DICE.CONFIG.Title",label:"DICE.CONFIG.Label",hint:"DICE.CONFIG.Hint",icon:"fas fa-dice-d20",type:DiceConfig,restricted:!1}),c.settings.register("core",this.compendiumArt.SETTING,{config:!1,default:{},type:Object,scope:"world"}),c.settings.registerMenu("core",this.compendiumArt.SETTING,{name:"COMPENDIUM.ART.SETTING.Title",label:"COMPENDIUM.ART.SETTING.Label",hint:"COMPENDIUM.ART.SETTING.Hint",icon:"fas fa-palette",type:foundry.applications.apps.CompendiumArtConfig,restricted:!0}),c.settings.register("core","time",{name:"World Time",scope:"world",config:!1,type:new foundry.data.fields.NumberField({required:!0,nullable:!1,initial:0}),onChange:this.time.onUpdateWorldTime.bind(this.time)}),c.settings.register("core",ModuleManagement.CONFIG_SETTING,{name:"Module Configuration Settings",scope:"world",config:!1,default:{},type:Object,requiresReload:!0}),c.settings.register("core",CompendiumCollection.CONFIG_SETTING,{name:"Compendium Configuration",scope:"world",config:!1,default:{},type:Object,onChange:()=>{this.initializePacks(),ui.compendium.render()}}),c.settings.register("core",Combat.CONFIG_SETTING,{name:"Combat Tracker Configuration",scope:"world",config:!1,default:{},type:Object,onChange:()=>{c.combat&&(c.combat.reset(),c.combats.render())}}),c.settings.register("core","sheetClasses",{name:"Sheet Class Configuration",scope:"world",config:!1,default:{},type:Object,onChange:e=>DocumentSheetConfig.updateDefaultSheets(e)}),c.settings.registerMenu("core","sheetClasses",{name:"SETTINGS.DefaultSheetsN",label:"SETTINGS.DefaultSheetsL",hint:"SETTINGS.DefaultSheetsH",icon:"fa-solid fa-scroll",type:DefaultSheetsConfig,restricted:!0}),c.settings.register("core","chatBubbles",{name:"SETTINGS.CBubN",hint:"SETTINGS.CBubL",scope:"client",config:!0,type:new foundry.data.fields.BooleanField({initial:!0})}),c.settings.register("core","chatBubblesPan",{name:"SETTINGS.CBubPN",hint:"SETTINGS.CBubPL",scope:"client",config:!0,type:new foundry.data.fields.BooleanField({initial:!0})}),c.settings.register("core","scrollingStatusText",{name:"SETTINGS.ScrollStatusN",hint:"SETTINGS.ScrollStatusL",scope:"world",config:!0,type:new foundry.data.fields.BooleanField({initial:!0})}),c.settings.register("core","pixelRatioResolutionScaling",{name:"SETTINGS.ResolutionScaleN",hint:"SETTINGS.ResolutionScaleL",scope:"client",config:!0,type:new foundry.data.fields.BooleanField({initial:!0}),requiresReload:!0}),c.settings.register("core","leftClickRelease",{name:"SETTINGS.LClickReleaseN",hint:"SETTINGS.LClickReleaseL",scope:"client",config:!0,type:new foundry.data.fields.BooleanField({initial:!1})}),c.settings.register("core","performanceMode",{name:"SETTINGS.PerformanceModeN",hint:"SETTINGS.PerformanceModeL",scope:"client",config:!0,type:new foundry.data.fields.NumberField({required:!0,nullable:!0,initial:null,choices:{[CONST.CANVAS_PERFORMANCE_MODES.LOW]:"SETTINGS.PerformanceModeLow",[CONST.CANVAS_PERFORMANCE_MODES.MED]:"SETTINGS.PerformanceModeMed",[CONST.CANVAS_PERFORMANCE_MODES.HIGH]:"SETTINGS.PerformanceModeHigh",[CONST.CANVAS_PERFORMANCE_MODES.MAX]:"SETTINGS.PerformanceModeMax"}}),requiresReload:!0,onChange:()=>(canvas._configurePerformanceMode(),canvas.ready?canvas.draw():null)}),c.settings.register("core","maxFPS",{name:"SETTINGS.MaxFPSN",hint:"SETTINGS.MaxFPSL",scope:"client",config:!0,type:new foundry.data.fields.NumberField({required:!0,min:10,max:60,step:10,initial:60}),onChange:()=>(canvas._configurePerformanceMode(),canvas.ready?canvas.draw():null)}),c.settings.register("core","fpsMeter",{name:"SETTINGS.FPSMeterN",hint:"SETTINGS.FPSMeterL",scope:"client",config:!0,type:new foundry.data.fields.BooleanField({initial:!1}),onChange:e=>e?canvas.activateFPSMeter():canvas.deactivateFPSMeter()}),c.settings.register("core","fontSize",{name:"SETTINGS.FontSizeN",hint:"SETTINGS.FontSizeL",scope:"client",config:!0,type:new foundry.data.fields.NumberField({required:!0,min:1,max:10,step:1,initial:5}),onChange:()=>c.scaleFonts()}),c.settings.register("core","photosensitiveMode",{name:"SETTINGS.PhotosensitiveModeN",hint:"SETTINGS.PhotosensitiveModeL",scope:"client",config:!0,type:new foundry.data.fields.BooleanField({initial:!1}),requiresReload:!0}),c.settings.register("core","tokenDragPreview",{name:"SETTINGS.TokenDragPreviewN",hint:"SETTINGS.TokenDragPreviewL",scope:"world",config:!0,type:new foundry.data.fields.BooleanField({initial:!1})}),c.settings.register("core","visionAnimation",{name:"SETTINGS.AnimVisionN",hint:"SETTINGS.AnimVisionL",config:!0,type:new foundry.data.fields.BooleanField({initial:!0})}),c.settings.register("core","lightAnimation",{name:"SETTINGS.AnimLightN",hint:"SETTINGS.AnimLightL",config:!0,type:new foundry.data.fields.BooleanField({initial:!0}),onChange:()=>canvas.effects?.activateAnimation()}),c.settings.register("core","mipmap",{name:"SETTINGS.MipMapN",hint:"SETTINGS.MipMapL",config:!0,type:new foundry.data.fields.BooleanField({initial:!0}),onChange:()=>canvas.ready?canvas.draw():null}),c.settings.register("core",DrawingsLayer.DEFAULT_CONFIG_SETTING,{name:"Default Drawing Configuration",scope:"client",config:!1,default:{},type:Object}),c.settings.register("core","keybindings",{scope:"client",config:!1,type:Object,default:{},onChange:()=>c.keybindings.initialize()}),c.settings.register("core","nue.shownTips",{scope:"world",type:new foundry.data.fields.BooleanField({initial:!1}),config:!1}),c.settings.register("core","tourProgress",{scope:"client",config:!1,type:Object,default:{}}),c.settings.register("core","editorAutosaveSecs",{name:"SETTINGS.EditorAutosaveN",hint:"SETTINGS.EditorAutosaveH",scope:"world",config:!0,type:new foundry.data.fields.NumberField({required:!0,min:30,max:300,step:10,initial:60})}),c.settings.register("core","pmHighlightDocumentMatches",{name:"SETTINGS.EnableHighlightDocumentMatches",hint:"SETTINGS.EnableHighlightDocumentMatchesH",scope:"world",config:!1,type:new foundry.data.fields.BooleanField({initial:!0})}),c.settings.register("core","combatTheme",{name:"SETTINGS.CombatThemeN",hint:"SETTINGS.CombatThemeL",scope:"client",config:!1,type:new foundry.data.fields.StringField({required:!0,blank:!1,initial:"none",choices:()=>Object.entries(g.Combat.sounds).reduce(((e,t)=>(e[t[0]]=c.i18n.localize(t[1].label),e)),{none:c.i18n.localize("SETTINGS.None")})})}),c.settings.register("core","showToolclips",{name:"SETTINGS.ShowToolclips",hint:"SETTINGS.ShowToolclipsH",scope:"client",config:!0,type:new foundry.data.fields.BooleanField({initial:!0}),requiresReload:!0}),c.settings.register("core","favoritePaths",{scope:"client",config:!1,type:Object,default:{"data-/":{source:"data",path:"/",label:"root"}}}),c.settings.register("core","collectionSortingModes",{scope:"client",config:!1,type:Object,default:{}}),c.settings.register("core","collectionSearchModes",{scope:"client",config:!1,type:Object,default:{}}),c.settings.register("core","hotbarLock",{scope:"client",config:!1,type:new foundry.data.fields.BooleanField({initial:!1})}),c.settings.register("core","adventureImports",{scope:"world",config:!1,type:Object,default:{}}),RollTables.registerSettings(),foundry.audio.AudioHelper.registerSettings(),NotesLayer.registerSettings(),c.settings.register("core","gridDiagonals",{name:"SETTINGS.GridDiagonalsN",hint:"SETTINGS.GridDiagonalsL",scope:"world",config:!0,type:new foundry.data.fields.NumberField({required:!0,initial:c.system?.grid.diagonals??CONST.GRID_DIAGONALS.EQUIDISTANT,choices:{[CONST.GRID_DIAGONALS.EQUIDISTANT]:"SETTINGS.GridDiagonalsEquidistant",[CONST.GRID_DIAGONALS.EXACT]:"SETTINGS.GridDiagonalsExact",[CONST.GRID_DIAGONALS.APPROXIMATE]:"SETTINGS.GridDiagonalsApproximate",[CONST.GRID_DIAGONALS.RECTILINEAR]:"SETTINGS.GridDiagonalsRectilinear",[CONST.GRID_DIAGONALS.ALTERNATING_1]:"SETTINGS.GridDiagonalsAlternating1",[CONST.GRID_DIAGONALS.ALTERNATING_2]:"SETTINGS.GridDiagonalsAlternating2",[CONST.GRID_DIAGONALS.ILLEGAL]:"SETTINGS.GridDiagonalsIllegal"}}),requiresReload:!0}),TemplateLayer.registerSettings()}async registerTours(){try{c.tours.register("core","welcome",await SidebarTour.fromJSON("/tours/welcome.json")),c.tours.register("core","installingASystem",await SetupTour.fromJSON("/tours/installing-a-system.json")),c.tours.register("core","creatingAWorld",await SetupTour.fromJSON("/tours/creating-a-world.json")),c.tours.register("core","backupsOverview",await SetupTour.fromJSON("/tours/backups-overview.json")),c.tours.register("core","compatOverview",await SetupTour.fromJSON("/tours/compatibility-preview-overview.json")),c.tours.register("core","uiOverview",await Tour.fromJSON("/tours/ui-overview.json")),c.tours.register("core","sidebar",await SidebarTour.fromJSON("/tours/sidebar.json")),c.tours.register("core","canvasControls",await CanvasTour.fromJSON("/tours/canvas-controls.json"))}catch(e){console.error(e)}}get isAdmin(){return this.data.isAdmin}get user(){return this.users?this.users.current:null}get combat(){return this.combats?.viewed}get paused(){return this.data.paused}get activeTool(){return ui.controls?.activeTool??"select"}togglePause(e,t=!1){return this.data.paused=e??!this.data.paused,t&&c.user.isGM&&c.socket.emit("pause",this.data.paused),ui.pause.render(),Hooks$1.callAll("pauseGame",this.data.paused),this.data.paused}toggleCharacterSheet(){const e=canvas.ready&&1===canvas.tokens.controlled.length?canvas.tokens.controlled[0]:null,t=e?e.actor:c.user.character;if(!t)return null;const i=t.sheet;return i.rendered?i._minimized?i.maximize():i.close():i.render(!0),i}logOut(){this.socket&&this.socket.disconnect(),window.location.href=foundry.utils.getRoute("join")}scaleFonts(e){const t=[8,10,12,14,16,18,20,24,28,32][(e=e??c.settings.get("core","fontSize"))-1]||16;document.documentElement.style.fontSize=`${t}px`}#ge(){let e;const t=c.settings.get("core","colorScheme");t?e=`theme-${t}`:matchMedia("(prefers-color-scheme: dark)").matches?e="theme-dark":matchMedia("(prefers-color-scheme: light)").matches&&(e="theme-light"),document.body.classList.remove("theme-light","theme-dark"),e&&document.body.classList.add(e);for(const e of c.users)document.documentElement.style.setProperty(`--user-color-${e.id}`,e.color.css);document.documentElement.style.setProperty("--user-color",c.user.color.css)}#pe(){this.compendiumUUIDRedirects=new foundry.utils.StringTree;for(const[e,t]of Object.entries(g.compendium.uuidRedirects))e.startsWith("Compendium.")&&this.compendiumUUIDRedirects.addLeaf(e.split("."),t.split("."))}activateSocketListeners(){c.socket.offAny(Game.#de),this.socket.on("pause",(e=>{c.togglePause(e,!1)})),this.socket.on("shutdown",(()=>{ui.notifications.info("The game world is shutting down and you will be returned to the server homepage.",{permanent:!0}),setTimeout((()=>window.location.href=foundry.utils.getRoute("/")),1e3)})),this.socket.on("reload",(()=>foundry.utils.debouncedReload())),this.socket.on("hotReload",this.#me.bind(this)),g.DatabaseBackend.activateSocketListeners(this.socket),foundry.audio.AudioHelper._activateSocketListeners(this.socket),Users._activateSocketListeners(this.socket),Scenes._activateSocketListeners(this.socket),Journal._activateSocketListeners(this.socket),FogExplorations._activateSocketListeners(this.socket),ChatBubbles._activateSocketListeners(this.socket),ProseMirrorEditor._activateSocketListeners(this.socket),CompendiumCollection._activateSocketListeners(this.socket),RegionDocument._activateSocketListeners(this.socket),foundry.data.regionBehaviors.TeleportTokenRegionBehaviorType._activateSocketListeners(this.socket),Game.#ue(),c.socket.emit("getUserActivity")}#me(e){if(!1!==Hooks$1.call("hotReload",e))switch(e.extension){case"css":return this.#fe(e);case"html":case"hbs":return this.#ve(e);case"json":return this.#ye(e)}}#fe(e){const t=document.querySelectorAll("link"),i=Array.from(t).find((t=>{let i=t.getAttribute("href");if(i.includes("?")){const[e,t]=i.split("?");i=e}return i===e.path}));if(!i)return;const n=i.getAttribute("href");i.setAttribute("href",`${n}?${Date.now()}`)}#ve(e){let t;try{t=Handlebars.compile(e.content)}catch(e){return console.error(e)}Handlebars.registerPartial(e.path,t);for(const e of Object.values(ui.windows))e.render();for(const e of foundry.applications.instances.values())e.render()}#ye(e){const t=c.i18n.lang;if("core"===e.packageId){if(!e.path.endsWith(`lang/${t}.json`))return}else{if(!("system"===e.packageType?c.system:c.modules.get(e.packageId)).languages.find((i=>i.path===e.path&&i.lang===t)))return}let i={};try{i=JSON.parse(e.content)}catch(e){return console.error(e)}foundry.utils.mergeObject(c.i18n.translations,i);for(const e of Object.values(ui.windows))e.render();for(const e of foundry.applications.instances.values())e.render()}activateListeners(){document.addEventListener("touchmove",(e=>{void 0!==e.scale&&1!==e.scale&&e.preventDefault()}),{passive:!1}),document.addEventListener("contextmenu",(e=>e.preventDefault())),document.addEventListener("pointerdown",this._onPointerDown),document.addEventListener("pointerup",this._onPointerUp),document.addEventListener("dragstart",this._onPreventDragstart),document.addEventListener("dragover",this._onPreventDragover),document.addEventListener("drop",this._onPreventDrop),window.addEventListener("wheel",Game._handleMouseWheelInputChange,{passive:!1}),this.tooltip.activateEventListeners(),TextEditor$1.activateListeners(),c.video.awaitFirstGesture(),window.addEventListener("beforeunload",this._onWindowBeforeUnload),window.addEventListener("blur",this._onWindowBlur),window.addEventListener("resize",this._onWindowResize),"game"===this.view&&(history.pushState(null,null,location.href),window.addEventListener("popstate",this._onWindowPopState)),document.addEventListener("click",this._onClickHyperlink)}static _handleMouseWheelInputChange(e){const t=e.target;if("INPUT"!==t.tagName||"range"!==t.type||t.disabled||t.readOnly)return;e.preventDefault(),e.stopPropagation();const i=(parseFloat(t.step)||1)*Math.sign(-1*e.deltaY);t.value=Math.clamp(parseFloat(t.value)+i,parseFloat(t.min),parseFloat(t.max)),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))}_onClickHyperlink(e){const t=e.target.closest("a[href]");t&&"javascript:void(0)"!==t.href&&!t.closest(".editor-content.ProseMirror")&&(e.preventDefault(),window.open(t.href,"_blank"))}_onPreventDragstart(e){const t=e.target,i=t.nodeType===Node.TEXT_NODE&&t.parentElement.closest(".ProseMirror");if("true"!==t.getAttribute?.("draggable")&&!i)return e.preventDefault(),!1}_onPreventDragover(e){const t=e.target;"INPUT"===t.tagName&&"file"===t.type||e.preventDefault()}_onPreventDrop(e){const t=e.target;"INPUT"===t.tagName&&"file"===t.type||e.preventDefault()}_onPointerDown(e){[3,4,5].includes(e.button)&&e.preventDefault();const t=document.querySelector(".inline-roll.expanded");if(t&&!e.target.closest(".inline-roll"))return Roll.defaultImplementation.collapseInlineResult(t)}_onPointerUp(e){const t=canvas.currentMouseManager;t&&!e.defaultPrevented&&t.cancel(e)}_onWindowResize(e){for(const e of Object.values(ui.windows))e.setPosition({top:e.position.top,left:e.position.left});for(const e of foundry.applications.instances.values())e.setPosition();if(ui.webrtc?.setPosition({height:"auto"}),canvas&&canvas.ready)return canvas._onResize(e)}_onWindowBeforeUnload(e){if(canvas.ready)return canvas.fog.commit(),canvas.fog.save()}_onWindowBlur(e){c.keyboard?.releaseKeys()}_onWindowPopState(e){c._goingBack||(history.pushState(null,null,location.href),confirm(c.i18n.localize("APP.NavigateBackConfirm"))&&(c._goingBack=!0,history.back(),history.back()))}async _initializeView(){switch(this.view){case"game":return this._initializeGameView();case"stream":return this._initializeStreamView();default:throw new Error(`Unknown view URL ${this.view} provided`)}}async _initializeGameView(){globalThis.SIGNED_EULA||(window.location.href=foundry.utils.getRoute("license")),this.userId||(console.error("Invalid user session provided - returning to login screen."),this.logOut()),await this.setupGame(),this.data.demoMode&&!this.user.isGM&&setTimeout((()=>{console.log(`${l} | Ending demo session after 10 minutes. Thanks for testing!`),this.logOut()}),6e5),ContextMenu.eventListeners(),ProseMirror.ProseMirrorMenu.eventListeners()}async _initializeStreamView(){globalThis.SIGNED_EULA||(window.location.href=foundry.utils.getRoute("license")),this.initializeDocuments(),ui.chat=new ChatLog({stream:!0}),ui.chat.render(!0),g.DatabaseBackend.activateSocketListeners(this.socket)}get template(){return foundry.utils.logCompatibilityWarning("Game#template is deprecated and will be removed in Version 14. Use cases for Game#template should be refactored to instead use System#documentTypes or Game#model",{since:12,until:14,once:!0}),this.#he}#he}function CanvasDocumentMixin(e){return class CanvasDocument extends(ClientDocumentMixin(e)){get object(){return this._object||this._destroyed?this._object:this.parent?.isView&&this.layer?this._object=this.layer.createObject(this):null}_object=this._object??null;_destroyed=!1;get layer(){return canvas.getLayerByEmbeddedName(this.documentName)}get rendered(){return this._object&&!this._object.destroyed}async _preCreate(e,t,i){if(!1===await super._preCreate(e,t,i))return!1;if(!this.schema.has("sort")||"sort"in e)return;let n=0;for(const e of this.collection)n=Math.max(n,e.sort+1);this.updateSource({sort:n})}_onCreate(e,t,i){super._onCreate(e,t,i);const n=this.object;n&&(this.layer.objects.addChild(n),n.draw().then((()=>{n?._onCreate(e,t,i)})))}_onUpdate(e,t,i){super._onUpdate(e,t,i),this._object?._onUpdate(e,t,i)}_onDelete(e,t){super._onDelete(e,t),this._object?._onDelete(e,t)}}}function ClientDocumentMixin(e){return class ClientDocument extends e{constructor(e,t){super(e,t),Object.defineProperty(this,"apps",{value:{},writable:!1,enumerable:!1}),Object.defineProperty(this,"_sheet",{value:null,writable:!0,enumerable:!1})}static name="ClientDocumentMixin";_initialize(e={}){if(super._initialize(e),c._documentsReady)return this._safePrepareData()}get collection(){return this.isEmbedded?this.parent[this.parentCollection]:g[this.documentName].collection.instance}get compendium(){return c.packs.get(this.pack)}get isOwner(){return this.testUserPermission(c.user,"OWNER")}get hasPlayerOwner(){return c.users.some((e=>!e.isGM&&this.testUserPermission(e,"OWNER")))}get limited(){return this.testUserPermission(c.user,"LIMITED",{exact:!0})}get link(){return`@UUID[${this.uuid}]{${this.name}}`}get permission(){return c.user.isGM?CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER:this.isEmbedded?this.parent.permission:this.getUserLevel(c.user)}get sheet(){if(!this._sheet){const e=this._getSheetClass();foundry.utils.isSubclass(e,Application)?this._sheet=new e(this,{editable:this.isOwner}):foundry.utils.isSubclass(e,foundry.applications.api.DocumentSheetV2)?this._sheet=new e({document:this}):this._sheet=null}return this._sheet}get visible(){return this.isEmbedded?this.parent.visible:this.testUserPermission(c.user,"LIMITED")}_getSheetClass(){const e=g[this.documentName],t=this.type??CONST.BASE_DOCUMENT_TYPE,i=e.sheetClasses[t]||{},n=this.getFlag("core","sheetClass")??null;if(null!==n&&n in i)return i[n].cls;const s=Object.values(i);return s.length?(s.find((e=>e.default))??s.pop()).cls:BaseSheet}_safePrepareData(){try{this.prepareData()}catch(e){Hooks$1.onError("ClientDocumentMixin#_initialize",e,{msg:`Failed data preparation for ${this.uuid}`,log:"error",uuid:this.uuid})}}prepareData(){const e=this.system instanceof foundry.abstract.TypeDataModel;e&&this.system.prepareBaseData(),this.prepareBaseData(),this.prepareEmbeddedDocuments(),e&&this.system.prepareDerivedData(),this.prepareDerivedData()}prepareBaseData(){}prepareEmbeddedDocuments(){for(const e of Object.keys(this.constructor.hierarchy||{}))for(let t of this.getEmbeddedCollection(e))t._safePrepareData()}prepareDerivedData(){}render(e=!1,t={}){for(let i of Object.values(this.apps))i.render(e,foundry.utils.deepClone(t))}async sortRelative({updateData:e={},...t}={}){const i=SortingHelpers.performIntegerSort(this,t),n=[];for(let t of i){const i=t.target,s=foundry.utils.mergeObject(e,t.update,{inplace:!1});s._id=i._id,i.sheet&&i.sheet.rendered?await i.sheet.submit({updateData:s}):n.push(s)}return n.length&&await this.constructor.updateDocuments(n,{parent:this.parent,pack:this.pack}),this}getRelativeUUID(e){if(this.compendium&&this.compendium!==e.compendium)return this.uuid;if(this.isEmbedded&&this.collection===e.collection)return`.${this.id}`;const t=[this.documentName,this.id];let i=this.parent;for(;i&&i!==e;)t.unshift(i.documentName,i.id),i=i.parent;return i===e?`.${t.join(".")}`:this.uuid}_createDocumentLink(e,{relativeTo:t,label:i}={}){return t||i?(i??=this.name,t?`@UUID[${this.getRelativeUUID(t)}]{${i}}`:`@UUID[${this.uuid}]{${i}}`):this.link}_onClickDocumentLink(e){return this.sheet.render(!0)}async _preCreate(e,t,i){return!1!==await super._preCreate(e,t,i)&&(this.system instanceof foundry.abstract.TypeDataModel?this.system._preCreate(e,t,i):void 0)}_onCreate(e,t,i){if(super._onCreate(e,t,i),t.renderSheet&&i===c.user.id&&this.sheet){const t={renderContext:`create${this.documentName}`,renderData:e};Object.defineProperties(t,{action:{get:()=>(foundry.utils.logCompatibilityWarning("The render options 'action' property is deprecated. Please use 'renderContext' instead.",{since:12,until:14}),"create")},data:{get:()=>(foundry.utils.logCompatibilityWarning("The render options 'data' property is deprecated. Please use 'renderData' instead.",{since:12,until:14}),e)}}),this.sheet.render(!0,t)}this.pack&&!this.isEmbedded&&(this instanceof Folder?this.compendium.folders.set(this.id,this):this.compendium.indexDocument(this)),this.constructor.metadata.indexed&&c.documentIndex.addDocument(this),c.issues._countDocumentSubType(this.constructor,this._source),this.system instanceof foundry.abstract.TypeDataModel&&this.system._onCreate(e,t,i)}async _preUpdate(e,t,i){return!1!==await super._preUpdate(e,t,i)&&(this.system instanceof foundry.abstract.TypeDataModel?this.system._preUpdate(e,t,i):void 0)}_onUpdate(e,t,i){super._onUpdate(e,t,i);const n="type"in e||"sheetClass"in(e.flags?.core||{});if(!t.preview&&n)this._onSheetChange();else if(!1!==t.render){const t={renderContext:`update${this.documentName}`,renderData:e};Object.defineProperties(t,{action:{get:()=>(foundry.utils.logCompatibilityWarning("The render options 'action' property is deprecated. Please use 'renderContext' instead.",{since:12,until:14}),"update")},data:{get:()=>(foundry.utils.logCompatibilityWarning("The render options 'data' property is deprecated. Please use 'renderData' instead.",{since:12,until:14}),e)}}),this.render(!1,t)}this.pack&&!this.isEmbedded&&(this instanceof Folder?this.compendium.folders.set(this.id,this):this.compendium.indexDocument(this)),"name"in e&&c.documentIndex.replaceDocument(this),this.system instanceof foundry.abstract.TypeDataModel&&this.system._onUpdate(e,t,i)}async _preDelete(e,t){return!1!==await super._preDelete(e,t)&&(this.system instanceof foundry.abstract.TypeDataModel?this.system._preDelete(e,t):void 0)}_onDelete(e,t){super._onDelete(e,t);const i={submit:!1,renderContext:`delete${this.documentName}`,renderData:this};Object.defineProperties(i,{action:{get:()=>(foundry.utils.logCompatibilityWarning("The render options 'action' property is deprecated. Please use 'renderContext' instead.",{since:12,until:14}),"delete")},data:{get(){return foundry.utils.logCompatibilityWarning("The render options 'data' property is deprecated. Please use 'renderData' instead.",{since:12,until:14}),this}}}),Object.values(this.apps).forEach((e=>e.close(i))),this.pack&&!this.isEmbedded&&(this instanceof Folder?this.compendium.folders.delete(this.id):this.compendium.index.delete(this.id)),c.documentIndex.removeDocument(this),c.issues._countDocumentSubType(this.constructor,this._source,{decrement:!0}),this.system instanceof foundry.abstract.TypeDataModel&&this.system._onDelete(e,t)}_dispatchDescendantDocumentEvents(e,t,i,n){n||=this;const s=this[`_${e}DescendantDocuments`];if(!(s instanceof Function))throw new Error(`Invalid descendant document event "${e}"`);if(s.call(this,n,t,...i),n===this){const n=`_${e}EmbeddedDocuments`;if("ClientDocumentMixin"!==foundry.utils.getDefiningClass(this,n)?.name&&this[n]instanceof Function){const s=this.constructor.hierarchy[t].model.documentName,o=`The ${this.documentName} class defines the _${e}EmbeddedDocuments method which is deprecated in favor of a new _${e}DescendantDocuments method.`;foundry.utils.logCompatibilityWarning(o,{since:11,until:13}),this[n](s,...i)}}const o=this.parent;o&&o._dispatchDescendantDocumentEvents(e,t,i,n)}_preCreateDescendantDocuments(e,t,i,n,s){}_onCreateDescendantDocuments(e,t,i,n,s,o){!1!==s.render&&this.render(!1,{renderContext:`create${t}`,renderData:n})}_preUpdateDescendantDocuments(e,t,i,n,s){}_onUpdateDescendantDocuments(e,t,i,n,s,o){!1!==s.render&&this.render(!1,{renderContext:`update${t}`,renderData:n})}_preDeleteDescendantDocuments(e,t,i,n,s){}_onDeleteDescendantDocuments(e,t,i,n,s,o){!1!==s.render&&this.render(!1,{renderContext:`delete${t}`,renderData:n})}async _onSheetChange({sheetOpen:e}={}){e??=this.sheet.rendered,await Promise.all(Object.values(this.apps).map((e=>e.close()))),this._sheet=null,e&&this.sheet.render(!0),this.parent?.sheet?.render(!1)}static defaultName({type:e,parent:t,pack:i}={}){const n=this.metadata.name;let s;s=t?t.getEmbeddedCollection(n):i?c.packs.get(i):c.collections.get(n);const o=new Set;for(const e of s)o.add(e.name);let r=this.metadata.label;if(e&&this.hasTypeData){const t=g[n].typeLabels?.[e];t&&c.i18n.has(t)&&(r=t)}const a=c.i18n.localize(r);let l=a,d=1;for(;o.has(l);)l=`${a} (${++d})`;return l}static async createDialog(e={},{parent:t=null,pack:i=null,types:n,...s}={}){const o=this.implementation;let r,a=[],l=g[this.documentName]?.defaultType,d=!1,u=!1;if(this.TYPES.length>1){if(0===n?.length)throw new Error("The array of sub-types to restrict to must not be empty");for(const e of this.TYPES){if(e===CONST.BASE_DOCUMENT_TYPE)continue;if(n&&!n.includes(e))continue;let t=g[this.documentName]?.typeLabels?.[e];t=t&&c.i18n.has(t)?c.i18n.localize(t):e,a.push({value:e,label:t}),e===l&&(d=!0)}if(!a.length)throw new Error("No document types were permitted to be created");d||(l=a[0].value),a.sort(((e,t)=>e.label.localeCompare(t.label,c.i18n.lang))),u=!0}t||(r=i?c.packs.get(i):c.collections.get(this.documentName));const h=r?._formatFolderSelectOptions()??[],p=c.i18n.localize(this.metadata.label),m=c.i18n.format("DOCUMENT.Create",{type:p}),v=e.type||l,y=await renderTemplate("templates/sidebar/document-create.html",{folders:h,name:e.name||"",defaultName:o.defaultName({type:v,parent:t,pack:i}),folder:e.folder,hasFolders:h.length>=1,hasTypes:u,type:v,types:a});return Dialog.prompt({title:m,content:y,label:m,render:e=>{u&&e[0].querySelector('[name="type"]').addEventListener("change",(n=>{e[0].querySelector('[name="name"]').placeholder=o.defaultName({type:n.target.value,parent:t,pack:i})}))},callback:n=>{const s=n[0].querySelector("form"),r=new FormDataExtended(s);return foundry.utils.mergeObject(e,r.object,{inplace:!0}),e.folder||delete e.folder,e.name?.trim()||(e.name=o.defaultName({type:e.type,parent:t,pack:i})),o.create(e,{parent:t,pack:i,renderSheet:!0})},rejectClose:!1,options:s})}async deleteDialog(e={}){const t=c.i18n.localize(this.constructor.metadata.label);return Dialog.confirm({title:`${c.i18n.format("DOCUMENT.Delete",{type:t})}: ${this.name}`,content:`<h4>${c.i18n.localize("AreYouSure")}</h4><p>${c.i18n.format("SIDEBAR.DeleteWarning",{type:t})}</p>`,yes:()=>this.delete(),options:e})}exportToJSON(e){if(!CONST.WORLD_DOCUMENT_TYPES.includes(this.documentName))throw new Error("Only world Documents may be exported");const t=this.toCompendium(null,e);t.flags.exportSource={world:c.world.id,system:c.system.id,coreVersion:c.version,systemVersion:c.system.version};const i=["fvtt",this.documentName,this.name?.slugify(),this.id].filterJoin("-");saveDataToFile(JSON.stringify(t,null,2),"text/json",`${i}.json`)}toDragData(){const e={type:this.documentName};return this.id?e.uuid=this.uuid:e.data=this.toObject(),e}static async fromDropData(e,t={}){let i=null;if(e.data?i=new this(e.data):e.uuid&&(i=await fromUuid(e.uuid)),!i)throw new Error("Failed to resolve Document from provided DragData. Either data or a UUID must be provided.");if(i.documentName!==this.documentName)throw new Error(`Invalid Document type '${i.type}' provided to ${this.name}.fromDropData.`);return i.id&&!i._stats?.compendiumSource&&i.updateSource({"_stats.compendiumSource":i.uuid}),i}static async fromImport(e,t){if(!CONST.PRIMARY_DOCUMENT_TYPES.includes(this.documentName))throw new Error("Only primary Documents may be imported");const i=e._stats?.coreVersion;if(i&&foundry.utils.isNewerVersion(i,c.version))throw new Error("Documents from a core version newer than the running version cannot be imported");if(i!==c.version){const t=await new Promise((t=>{c.socket.emit("migrateDocumentData",this.documentName,e,t)}));if(t.error)throw new Error(t.error);e=t.source}return this.fromSource(e,{strict:!0,...t})}async importFromJSON(e){if(!CONST.WORLD_DOCUMENT_TYPES.includes(this.documentName))throw new Error("Only world Documents may be imported");const t=JSON.parse(e),i=await this.constructor.fromImport(t),n=this.collection.fromCompendium(i),s=Object.fromEntries(this.constructor.metadata.preserveOnImport.map((e=>[e,foundry.utils.getProperty(this,e)])));return s.folder=this.folder?.id,foundry.utils.mergeObject(n,s),await this.update(n,{diff:!1,recursive:!1,noHook:!0}),ui.notifications.info(c.i18n.format("DOCUMENT.Imported",{document:this.documentName,name:this.name})),this}async importFromJSONDialog(){new Dialog({title:`Import Data: ${this.name}`,content:await renderTemplate("templates/apps/import-data.html",{hint1:c.i18n.format("DOCUMENT.ImportDataHint1",{document:this.documentName}),hint2:c.i18n.format("DOCUMENT.ImportDataHint2",{name:this.name})}),buttons:{import:{icon:'<i class="fas fa-file-import"></i>',label:"Import",callback:e=>{const t=e.find("form")[0];if(!t.data.files.length)return ui.notifications.error("You did not upload a data file!");(function readTextFromFile(e){const t=new FileReader;return new Promise(((i,n)=>{t.onload=e=>{i(t.result)},t.onerror=e=>{t.abort(),n()},t.readAsText(e)}))})(t.data.files[0]).then((e=>this.importFromJSON(e)))}},no:{icon:'<i class="fas fa-times"></i>',label:"Cancel"}},default:"import"},{width:400}).render(!0)}toCompendium(e,{clearSort:t=!0,clearFolder:i=!1,clearFlags:n=!1,clearSource:s=!0,clearOwnership:o=!0,clearState:r=!0,keepId:a=!1}={}){const l=this.toObject();return a||delete l._id,t&&delete l.sort,i&&delete l.folder,n&&delete l.flags,s&&(delete l._stats?.compendiumSource,delete l._stats?.duplicateSource),o&&delete l.ownership,r&&delete l.active,l}toAnchor({attrs:e={},dataset:t={},classes:i=[],name:n,icon:s}={}){const o=g[this.documentName],r=c.i18n.localize(`DOCUMENT.${this.documentName}`);let a=s??o.sidebarIcon;if(i.includes("content-link")||i.unshift("content-link"),e=foundry.utils.mergeObject({draggable:"true"},e),t=foundry.utils.mergeObject({link:"",uuid:this.uuid,id:this.id,type:this.documentName,pack:this.pack,tooltip:r},t),this.type){const e=o.typeLabels[this.type],i=c.i18n.has(e)?`${c.i18n.localize(e)}`:"";t.tooltip=i?c.i18n.format("DOCUMENT.TypePageFormat",{type:i,page:r}):r,a=s??o.typeIcons?.[this.type]??o.sidebarIcon}return n??=this.name,TextEditor$1.createAnchor({attrs:e,dataset:t,name:n,classes:i,icon:a})}async toEmbed(e,t={}){const i=await this._buildEmbedHTML(e,t);if(!i)return null;let n;return n=e.inline?await this._createInlineEmbed(i,e,t):await this._createFigureEmbed(i,e,t),n&&(n.classList.add("content-embed"),n.dataset.uuid=this.uuid,n.dataset.contentEmbed="",e.classes&&n.classList.add(...e.classes.split(" "))),n}async _buildEmbedHTML(e,t={}){return this.system instanceof foundry.abstract.TypeDataModel?this.system.toEmbed(e,t):null}async _createInlineEmbed(e,t,i){const n=document.createElement("section");return e instanceof HTMLCollection?n.append(...e):n.append(e),n}async _createFigureEmbed(e,{cite:t,caption:i,captionPosition:n="bottom",label:s},o){const r=document.createElement("figure");if(e instanceof HTMLCollection?r.append(...e):r.append(e),t||i){const e=document.createElement("figcaption");i&&(e.innerHTML+=`<strong class="embed-caption">${s||this.name}</strong>`),t&&(e.innerHTML+=`<cite>${this.toAnchor().outerHTML}</cite>`),r.insertAdjacentElement("bottom"===n?"beforeend":"afterbegin",e),"top"===n&&r.append(e.querySelector(":scope > cite"))}return r}_preCreateEmbeddedDocuments(){}_preUpdateEmbeddedDocuments(){}_preDeleteEmbeddedDocuments(){}_onCreateEmbeddedDocuments(){}_onUpdateEmbeddedDocuments(){}_onDeleteEmbeddedDocuments(){}}}function DirectoryCollectionMixin(e){return class DirectoryCollection extends e{get folders(){throw new Error("You must implement the folders getter for this DirectoryCollection")}get tree(){return this.#be||this.initializeTree(),this.#be}#be;get searchMode(){return c.settings.get("core","collectionSearchModes")[this.collection??this.name]||CONST.DIRECTORY_SEARCH_MODES.NAME}toggleSearchMode(){const e=this.collection??this.name,t=c.settings.get("core","collectionSearchModes");t[e]=t[e]===CONST.DIRECTORY_SEARCH_MODES.FULL?CONST.DIRECTORY_SEARCH_MODES.NAME:CONST.DIRECTORY_SEARCH_MODES.FULL,c.settings.set("core","collectionSearchModes",t)}get sortingMode(){return c.settings.get("core","collectionSortingModes")[this.collection??this.name]||"a"}toggleSortingMode(){const e=this.collection??this.name,t=c.settings.get("core","collectionSortingModes"),i="a"===t[e]?"m":"a";t[e]=i,c.settings.set("core","collectionSortingModes",t),this.initializeTree()}get maxFolderDepth(){return CONST.FOLDER_MAX_DEPTH}_getVisibleTreeContents(){return this.contents}initializeTree(){const e=this.folders.contents,t=this._getVisibleTreeContents();this.#be=this.#Se(e,t)}#Se(e,t){const i=new Set,createNode=(e,t,i)=>({root:e,folder:t,depth:i,visible:!1,children:[],entries:[]}),n=createNode(!0,null,0),s=[[n]];for(let n=1;n<=this.maxFolderDepth+1;n++){const o=n<=this.maxFolderDepth;s[n]=[];const r=s[n-1];if(!r.length)break;for(const a of r){const r=a.folder;if(!a.root){if(i.has(r.id))continue;i.add(r.id)}const l=this.#Te(r,e,t,{allowChildren:o});a.entries=l.entries,a.children=l.folders.map((e=>createNode(!1,e,n))),s[n].push(...a.children),e=l.unassignedFolders,t=l.unassignedEntries}}for(const i of e){const n=createNode(!1,i,1),o=this.#Te(i,e,t,{allowChildren:!1});n.entries=o.entries,t=o.unassignedEntries,s[1].push(n)}t.length&&n.entries.push(...t);const o="a"===this.sortingMode?this.constructor._sortAlphabetical:this.constructor._sortStandard;n.entries.sort(o),n.children.sort(((e,t)=>o(e.folder,t.folder)));const filterChildren=e=>{e.children=e.children.filter((e=>(filterChildren(e),e.visible))),e.visible=e.root||c.user.isGM||e.children.length+e.entries.length>0,e.folder&&(e.folder.displayed=e.visible,e.folder.depth=e.depth,e.folder.children=e.children)};return filterChildren(n),n}_formatFolderSelectOptions(){const e=[],traverse=t=>{if(!t)return;const i=t.folder;i?.visible&&e.push({id:i.id,name:`${"â”€".repeat(i.depth-1)} ${i.name}`.trim()}),t.children.forEach(traverse)};return traverse(this.tree),e}#Te(e,t,i,{allowChildren:n=!0}={}){const s="a"===e?.sorting?this.constructor._sortAlphabetical:this.constructor._sortStandard;function folderMatches(t){return t.folder?._id?t.folder._id===e?._id:t.folder===e||t.folder===e?._id}const[o,r]=t.partition((e=>n&&folderMatches(e)));r.sort(s);const[a,l]=i.partition((e=>folderMatches(e)));return l.sort(s),{folders:r,entries:l,unassignedFolders:o,unassignedEntries:a}}static _sortAlphabetical(e,t){if(void 0===e.name)throw new Error(`Missing name property for ${e.constructor.name} ${e.id}`);if(void 0===t.name)throw new Error(`Missing name property for ${t.constructor.name} ${t.id}`);return e.name.localeCompare(t.name,c.i18n.lang)}static _sortStandard(e,t){if(void 0===e.sort)throw new Error(`Missing sort property for ${e.constructor.name} ${e.id}`);if(void 0===t.sort)throw new Error(`Missing sort property for ${t.constructor.name} ${t.id}`);return e.sort-t.sort}}}class DocumentCollection extends foundry.utils.Collection{constructor(e=[]){super(),Object.defineProperty(this,"_source",{value:e,writable:!1}),this.apps=[],this._initialize()}_initialize(){this.clear();for(let e of this._source){let t;c.issues&&c.issues._countDocumentSubType(this.documentClass,e);try{t=this.documentClass.fromSource(e,{strict:!0,dropInvalidEmbedded:!0}),super.set(t.id,t)}catch(t){this.invalidDocumentIds.add(e._id),c.issues&&c.issues._trackValidationFailure(this,e,t),Hooks$1.onError(`${this.constructor.name}#_initialize`,t,{msg:`Failed to initialize ${this.documentName} [${e._id}]`,log:"error",id:e._id})}}}get documentClass(){return getDocumentClass(this.documentName)}get documentName(){const e=this.constructor.documentName;if(!e)throw new Error("A subclass of DocumentCollection must define its static documentName");return e}static documentName;invalidDocumentIds=new Set;get name(){return this.constructor.name}createDocument(e,t={}){return new this.documentClass(e,t)}getInvalid(e,{strict:t=!0}={}){if(!this.invalidDocumentIds.has(e)){if(t)throw new Error(`${this.constructor.documentName} id [${e}] is not in the set of invalid ids`);return}const i=this._source.find((t=>t._id===e));return this.documentClass.fromSource(foundry.utils.deepClone(i))}get(e,{invalid:t=!1,strict:i=!1}={}){let n=super.get(e);if(!n&&t&&(n=this.getInvalid(e,{strict:!1})),!n&&i)throw new Error(`${this.constructor.documentName} id [${e}] does not exist in the ${this.constructor.name} collection.`);return n}set(e,t){const i=this.documentClass;if(!(t instanceof i))throw new Error(`You may only push instances of ${i.documentName} to the ${this.name} collection`);const n=this.has(t.id);super.set(t.id,t),n?this._source.findSplice((t=>t._id===e),t.toObject()):this._source.push(t.toObject())}delete(e){super.delete(e);return!!this._source.findSplice((t=>t._id===e))}render(e,t){for(let i of this.apps)i.render(e,t)}static#Ee=new Map;static getSearchableFields(e,t="",i=!1){const n=!!t,s=n?`${e}.${t}`:e;if(DocumentCollection.#Ee.has(s))return DocumentCollection.#Ee.get(s);const o=g[e];if(!o)throw new Error(`Could not find configuration for ${e}`);const r=new Set(n?this.getSearchableFields(e):[]),a=n?o.dataModels?.[t]:o.documentClass;return a?.schema.apply((function(){this instanceof foundry.data.fields.StringField&&this.textSearch&&r.add(n&&!a.schema.name?`system.${this.fieldPath}`:this.fieldPath)})),DocumentCollection.#Ee.set(s,r),r}search({query:e="",filters:t=[],exclude:i=[]}){e=SearchFilter.cleanQuery(e);const n=new RegExp(RegExp.escape(e),"i"),s=[],o=!foundry.utils.isEmpty(t);let r;for(const a of this.index??this.contents){if(i.includes(a._id))continue;let l=!e;if(e){const e=DocumentCollection.getSearchableFields(a.constructor.documentName??this.documentName,a.type,!!a.parentCollection);for(const t of e){let e=foundry.utils.getProperty(a,t);if(e){let i;t.startsWith("system.")?a.system instanceof foundry.abstract.DataModel&&(i=a.system.schema.getField(t.slice(7))):i=a.schema.getField(t),i instanceof foundry.data.fields.HTMLField&&(r??=new DOMParser,e=r.parseFromString(e,"text/html").body.textContent)}if(e&&n.test(SearchFilter.cleanQuery(e))){l=!0;break}}}if(o)for(const e of t)if(!SearchFilter.evaluateFilter(a,e)){l=!1;break}l&&s.push(a)}return s}async updateAll(e,t=null,i={}){const n=e instanceof Function;if(!n&&"Object"!==foundry.utils.getType(e))throw new Error("You must provide a data object or transformation function");const s=t instanceof Function,o=[];for(let i of this){if(s&&!t(i))continue;const r=n?e(i):foundry.utils.deepClone(e);r._id=i.id,o.push(r)}return this.documentClass.updateDocuments(o,i)}_onModifyContents(e,t,i,n,s){n.render&&this.render(!1,{renderContext:`${e}${this.documentName}`,renderData:i})}}class WorldCollection extends(DirectoryCollectionMixin(DocumentCollection)){get folders(){return c.folders.reduce(((e,t)=>(t.type===this.documentName&&e.set(t.id,t),e)),new foundry.utils.Collection)}get directory(){const e=getDocumentClass(this.constructor.documentName);return ui[e.metadata.collection]}static get instance(){return c.collections.get(this.documentName)}_getVisibleTreeContents(e){return this.contents.filter((e=>e.visible))}async importFromCompendium(e,t,i={},n={}){const s=this.documentClass;if(e.documentName!==s.documentName)throw new Error(`The ${e.documentName} Document type provided by Compendium ${e.collection} is incorrect for this Collection`);const o=await e.getDocument(t),r=this.fromCompendium(o,n),a=foundry.utils.mergeObject(r,i);return console.log(`${l} | Importing ${s.documentName} ${o.name} from ${e.collection}`),this.directory.activate(),n.fromCompendium=!0,this.documentClass.create(a,n)}fromCompendium(e,{clearFolder:t=!1,clearSort:i=!0,clearOwnership:n=!0,keepId:s=!1,...o}={}){"addFlags"in o&&foundry.utils.logCompatibilityWarning("The addFlags option for WorldCompendium#fromCompendium has been removed. ",{since:12,until:14});let r=e;return e instanceof foundry.abstract.Document&&(r=e.toObject(),e.pack&&foundry.utils.setProperty(r,"_stats.compendiumSource",e.uuid)),s||delete r._id,t&&delete r.folder,i&&delete r.sort,n&&"ownership"in r&&(r.ownership={default:CONST.DOCUMENT_OWNERSHIP_LEVELS.NONE,[c.user.id]:CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER}),r}static registerSheet(...e){DocumentSheetConfig.registerSheet(getDocumentClass(this.documentName),...e)}static unregisterSheet(...e){DocumentSheetConfig.unregisterSheet(getDocumentClass(this.documentName),...e)}static get registeredSheets(){const e=new Set;for(let t of Object.values(g[this.documentName].sheetClasses))for(let i of Object.values(t))e.add(i.cls);return Array.from(e)}}class CombatEncounters extends WorldCollection{static documentName="Combat";static get settings(){return c.settings.get("core",Combat.CONFIG_SETTING)}get directory(){return ui.combat}get combats(){return this.filter((e=>null===e.scene||e.scene===c.scenes.current))}get active(){return this.combats.find((e=>e.active))}get viewed(){return ui.combat?.viewed??null}async _onDeleteToken(e,t){for(let i of this){const n=[];for(let s of i.combatants)s.sceneId===e&&s.tokenId===t&&n.push(s.id);n.length&&await i.deleteEmbeddedDocuments("Combatant",n)}}}class CompendiumCollection extends(DirectoryCollectionMixin(DocumentCollection)){constructor(e){super([]),this.metadata=e,this.index=new foundry.utils.Collection,this.#Ce=new CompendiumFolderCollection(this),this._flush=foundry.utils.debounce(this.clear.bind(this),1e3*this.constructor.CACHE_LIFETIME_SECONDS),this.#_e=new Set(this.documentClass.metadata.compendiumIndexFields);for(let t of e.index)t.uuid=this.getUuid(t._id),this.index.set(t._id,t);delete e.index;for(let t of e.folders.sort(((e,t)=>e.sort-t.sort)))this.#Ce.set(t._id,new Folder.implementation(t,{pack:this.collection}));delete e.folders}static CACHE_LIFETIME_SECONDS=300;static CONFIG_SETTING="compendiumConfiguration";get collection(){return this.metadata.id}get banner(){return void 0===this.metadata.banner?g[this.metadata.type]?.compendiumBanner:this.metadata.banner}applicationClass=Compendium;#Ce;get folders(){return this.#Ce}get maxFolderDepth(){return super.maxFolderDepth-1}get folder(){return c.folders.get(this.config.folder)??null}async setFolder(e){const t=this.config.folder;if(null===e){if(null===t)return;return this.configure({folder:null})}if("string"==typeof e&&(e=c.folders.get(e)),!(e instanceof Folder))throw new Error("You must pass a valid Folder or Folder ID.");if("Compendium"!==e.type)throw new Error(`Folder "${e.id}" is not of the required Compendium type`);e.id!==t&&await this.configure({folder:e.id})}get sort(){return this.config.sort??0}_getVisibleTreeContents(){return this.index.contents}static _sortStandard(e,t){return e.sort-t.sort}get config(){const e=c.settings.get("core","compendiumConfiguration")[this.collection]||{};return"private"in e&&(!0===e.private&&(e.ownership={PLAYER:"LIMITED",ASSISTANT:"OWNER"}),delete e.private),e}get documentName(){return this.metadata.type}get locked(){return this.config.locked??"world"!==this.metadata.packageType}get ownership(){return this.config.ownership??this.metadata.ownership??{...Module.schema.getField("packs.ownership").initial}}get visible(){return this.getUserLevel()>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER}get title(){return this.metadata.label}get indexFields(){const e=this.documentClass.metadata.compendiumIndexFields,t=g[this.documentName].compendiumIndexFields||[];return new Set([...e,...t])}#_e;get indexed(){return this.indexFields.isSubset(this.#_e)}get(e,t){return this._flush(),super.get(e,t)}set(e,t){return t instanceof Folder?this.#Ce.set(e,t):(this._flush(),this.indexDocument(t),super.set(e,t))}delete(e){return this.index.delete(e),super.delete(e)}clear(){for(const e of this.values())Object.values(e.apps).some((e=>e.rendered))||super.delete(e.id)}async getIndex({fields:e=[]}={}){const t=this.documentClass,i=new Set([...this.indexFields,...e]);if(i.isSubset(this.#_e))return this.index;const n=await t.database.get(t,{query:{},index:!0,indexFields:Array.from(i),pack:this.collection},c.user);for(let e of n){const t=this.index.get(e._id),i=t?foundry.utils.mergeObject(t,e):e;i.uuid=this.getUuid(i._id),this.index.set(e._id,i)}return console.log(`${l} | Constructed index of ${this.collection} Compendium containing ${this.index.size} entries`),this.#_e=i,this.index}async getDocument(e){if(!e)return;const t=this.get(e);if(t instanceof foundry.abstract.Document)return t;const i=await this.getDocuments({_id:e});return i.length?i.shift():null}async getDocuments(e={}){const t=this.documentClass,i=await t.database.get(t,{query:e,pack:this.collection},c.user);for(let e of i)e.invalid&&!this.invalidDocumentIds.has(e.id)?(this.invalidDocumentIds.add(e.id),this._source.push(e)):this.set(e.id,e);return i}getUserLevel(e=c.user){const t=CONST.DOCUMENT_OWNERSHIP_LEVELS;let i=t.NONE;for(const[n,s]of Object.entries(this.ownership))e.hasRole(n)&&(i=Math.max(i,t[s]));return i}testUserPermission(e,t,{exact:i=!1}={}){const n=CONST.DOCUMENT_OWNERSHIP_LEVELS,s=e.isGM?n.OWNER:this.getUserLevel(e),o="string"==typeof t?n[t]??n.OWNER:t;return i?s===o:s>=o}async importDocument(e,t={}){if(!(e instanceof this.documentClass||e instanceof Folder)){const t=Error(`You may not import a ${e.constructor.name} Document into the ${this.collection} Compendium which contains ${this.documentClass.name} Documents.`);throw ui.notifications.error(t.message),t}t.clearOwnership=t.clearOwnership??"world"===this.metadata.packageType;const i=e.toCompendium(this,t);return e.constructor.create(i,{pack:this.collection})}async importFolder(e,{importParents:t=!0,...i}={}){if(!(e instanceof Folder)){const t=Error(`You may not import a ${e.constructor.name} Document into the folders collection of the ${this.collection} Compendium.`);throw ui.notifications.error(t.message),t}const n=[e];t&&n.push(...e.getParentFolders().filter((e=>!this.folders.has(e.id)))),await Folder.createDocuments(n,{pack:this.collection,keepId:!0})}async importFolders(e,{importParents:t=!0,...i}={}){if(e.some((e=>!(e instanceof Folder)))){const e=Error(`You can only import Folder documents into the folders collection of the ${this.collection} Compendium.`);throw ui.notifications.error(e.message),e}const n=new Set(e);if(t)for(const t of e)for(const e of t.getParentFolders())this.folders.has(e.id)||n.add(e);await Folder.createDocuments(Array.from(n),{pack:this.collection,keepId:!0})}async importAll({folderId:e=null,folderName:t="",...i}={}){let n;CONST.FOLDER_DOCUMENT_TYPES.includes(this.documentName)&&(e&&(n=c.folders.get(e,{strict:!0})),n||(n=await Folder.create({name:t||this.title,type:this.documentName,parent:null,color:this.folder?.color??null})));const s=this.folders,o=await this.getDocuments();ui.notifications.info(c.i18n.format("COMPENDIUM.ImportAllStart",{number:o.length,folderNumber:s.size,type:c.i18n.localize(this.documentClass.metadata.label),folder:n.name}));const r=s.map((e=>{if(c.folders.has(e.id))return null;const t=e.toObject();return t.folder||(t.folder=n.id),t})).filter((e=>e));await Folder.createDocuments(r,{keepId:!0});const a=c.collections.get(this.documentName),l=o.map((e=>{const t=a.fromCompendium(e,i);return t.folder||(t.folder=n.id),t})),d=Math.ceil(l.length/100);let u=[];for(let e=0;e<d;e++){const t=l.slice(100*e,100*(e+1)),n=await this.documentClass.createDocuments(t,i);u=u.concat(n)}return ui.notifications.info(c.i18n.format("COMPENDIUM.ImportAllFinish",{number:u.length,folderNumber:s.size,type:c.i18n.localize(this.documentClass.metadata.label),folder:n.name})),u}async importDialog(e={}){const t=g[this.documentName]?.collection?.instance,i=await renderTemplate("templates/sidebar/apps/compendium-import.html",{folderName:this.title,keepId:e.keepId??!1,folders:t?._formatFolderSelectOptions()??[]});return e.jQuery=!1,Dialog.confirm({title:`${c.i18n.localize("COMPENDIUM.ImportAll")}: ${this.title}`,content:i,render:e=>{const t=e.querySelector("form");t.elements.folder.addEventListener("change",(e=>{t.elements.folderName.disabled=!!e.currentTarget.value}),{passive:!0})},yes:e=>{const t=e.querySelector("form");return this.importAll({folderId:t.elements.folder.value,folderName:t.folderName.value,keepId:t.keepId.checked})},options:e})}indexDocument(e){let t=this.index.get(e.id);const i=e.toObject();t?foundry.utils.mergeObject(t,i,{insertKeys:!1,insertValues:!1}):t=this.#_e.reduce(((e,t)=>(foundry.utils.setProperty(e,t,foundry.utils.getProperty(i,t)),e)),{}),t.img=i.thumb??i.img,t._id=i._id,t.uuid=e.uuid,this.index.set(e.id,t)}async configureOwnershipDialog(){if(!c.user.isGM)throw new Error("You do not have permission to configure ownership for this Compendium pack");const e=this.ownership,t={"":c.i18n.localize("COMPENDIUM.OwnershipInheritBelow"),NONE:c.i18n.localize("OWNERSHIP.NONE"),LIMITED:c.i18n.localize("OWNERSHIP.LIMITED"),OBSERVER:c.i18n.localize("OWNERSHIP.OBSERVER"),OWNER:c.i18n.localize("OWNERSHIP.OWNER")},i={ASSISTANT:{label:"USER.RoleAssistant",value:e.ASSISTANT,levels:{...t}},TRUSTED:{label:"USER.RoleTrusted",value:e.TRUSTED,levels:{...t}},PLAYER:{label:"USER.RolePlayer",value:e.PLAYER,levels:{...t}}};return delete i.PLAYER.levels[""],await Dialog.wait({title:`${c.i18n.localize("OWNERSHIP.Title")}: ${this.metadata.label}`,content:await renderTemplate("templates/sidebar/apps/compendium-ownership.hbs",{roles:i}),default:"ok",close:()=>null,buttons:{reset:{label:c.i18n.localize("COMPENDIUM.OwnershipReset"),icon:'<i class="fas fa-undo"></i>',callback:()=>this.configure({ownership:void 0})},ok:{label:c.i18n.localize("OWNERSHIP.Configure"),icon:'<i class="fas fa-check"></i>',callback:async e=>{const t=new FormDataExtended(e.querySelector("form.compendium-ownership-dialog"));let i=Object.entries(t.object).reduce(((e,[t,i])=>(i&&(e[t]=i),e)),{});i.GAMEMASTER="OWNER",await this.configure({ownership:i})}}}},{jQuery:!1}),this.ownership}static _activateSocketListeners(e){e.on("manageCompendium",(e=>{const{request:t}=e;switch(t.action){case"create":CompendiumCollection.#Ie(e);break;case"delete":CompendiumCollection.#we(e);break;default:throw new Error(`Invalid Compendium modification action ${t.action} provided.`)}}))}static async createCompendium(e,t={}){if(!c.user.isGM)return ui.notifications.error("You do not have permission to modify this compendium pack");const i=await SocketInterface.dispatch("manageCompendium",{action:"create",data:e,options:t});return this.#Ie(i)}getUuid(e){return`Compendium.${this.collection}.${this.documentName}.${e}`}configure(e={}){const t=c.settings.get("core","compendiumConfiguration"),i=this.config;for(const[t,n]of Object.entries(e))void 0===n?delete i[t]:i[t]=n;return t[this.collection]=i,c.settings.set("core",this.constructor.CONFIG_SETTING,t)}async deleteCompendium(){this.#De(),this.apps.forEach((e=>e.close()));const e=await SocketInterface.dispatch("manageCompendium",{action:"delete",data:this.metadata.name});return CompendiumCollection.#we(e)}async duplicateCompendium({label:e}={}){this.#De({requireUnlocked:!1}),e=e||this.title;const t=foundry.utils.mergeObject(this.metadata,{name:e.slugify({strict:!0}),label:e},{inplace:!1});return this.constructor.createCompendium(t,{source:this.collection})}#De({requireUnlocked:e=!0}={}){const t=this.config;let i;if(c.user.isGM||(i=new Error("You do not have permission to modify this compendium pack")),e&&t.locked&&(i=new Error("You cannot modify content in this compendium pack because it is locked.")),i)throw ui.notifications.error(i.message),i;return!0}async migrate(){return this.#De(),ui.notifications.info(`Beginning migration for Compendium pack ${this.collection}, please be patient.`),await SocketInterface.dispatch("manageCompendium",{type:this.collection,action:"migrate",data:this.collection,options:{broadcast:!1}}),ui.notifications.info(`Successfully migrated Compendium pack ${this.collection}.`),this}async updateAll(e,t=null,i={}){return await this.getDocuments(),i.pack=this.collection,super.updateAll(e,t,i)}_onModifyContents(e,t,i,n,s){super._onModifyContents(e,t,i,n,s),Hooks$1.callAll("updateCompendium",this,t,n,s.id)}static#Ie({result:e}){c.data.packs.push(e);const t=new this(e);return c.packs.set(t.collection,t),t.apps.push(new Compendium({collection:t})),ui.compendium.render(),t}static#we({result:e}){const t=c.packs.get(e);if(!t)throw new Error(`Compendium pack '${e}' did not exist to be deleted.`);return c.data.packs.findSplice((t=>t.id===e)),c.packs.delete(e),ui.compendium.render(),t}get private(){return foundry.utils.logCompatibilityWarning("CompendiumCollection#private is deprecated in favor of the new CompendiumCollection#ownership, CompendiumCollection#getUserLevel, CompendiumCollection#visible properties"),!this.visible}get isOpen(){return foundry.utils.logCompatibilityWarning("CompendiumCollection#isOpen is deprecated and will be removed in V13"),this.apps.some((e=>e._state>Application.RENDER_STATES.NONE))}}class CompendiumFolderCollection extends DocumentCollection{constructor(e,t=[]){super(t),this.pack=e}pack;get documentName(){return"Folder"}render(e,t){this.pack.render(e,t)}async updateAll(e,t=null,i={}){return i.pack=this.collection,super.updateAll(e,t,i)}}class CompendiumPacks extends(DirectoryCollectionMixin(Collection)){get folders(){return c.folders.reduce(((e,t)=>("Compendium"===t.type&&e.set(t.id,t),e)),new foundry.utils.Collection)}_getVisibleTreeContents(){return this.contents.filter((e=>e.visible))}static _sortAlphabetical(e,t){return e.metadata&&t.metadata?e.metadata.label.localeCompare(t.metadata.label,c.i18n.lang):super._sortAlphabetical(e,t)}}class FogExplorations extends WorldCollection{static documentName="FogExploration";static _activateSocketListeners(e){e.on("resetFog",(({sceneId:e})=>{e===canvas.id&&canvas.fog._handleReset()}))}}class Journal extends WorldCollection{static documentName="JournalEntry";static async showDialog(e){if(!(e instanceof JournalEntry||e instanceof JournalEntryPage))return;if(!e.isOwner)return ui.notifications.error("JOURNAL.ShowBadPermissions",{localize:!0});if(c.users.size<2)return ui.notifications.warn("JOURNAL.ShowNoPlayers",{localize:!0});const t=c.users.filter((e=>e.id!==c.userId)),i=Object.entries(CONST.DOCUMENT_OWNERSHIP_LEVELS);e.isEmbedded||i.shift();const n=[{level:CONST.DOCUMENT_META_OWNERSHIP_LEVELS.NOCHANGE,label:"OWNERSHIP.NOCHANGE"},...i.map((([e,t])=>({level:t,label:`OWNERSHIP.${e}`})))],s=e instanceof JournalEntryPage&&"image"===e.type,o=await renderTemplate("templates/journal/dialog-show.html",{users:t,levels:n,isImage:s});return Dialog.prompt({title:c.i18n.format("JOURNAL.ShowEntry",{name:e.name}),label:c.i18n.localize("JOURNAL.ActionShow"),content:o,render:e=>{const t=e.querySelector("form");t.elements.allPlayers.addEventListener("change",(e=>{const i=e.currentTarget.checked;t.querySelectorAll('[name="players"]').forEach((e=>{e.checked=i,e.disabled=i}))}))},callback:async t=>{const i=t.querySelector("form"),n=new FormDataExtended(i).object,s=n.allPlayers?c.users.filter((e=>!e.isSelf)):n.players.reduce(((e,t)=>{const i=c.users.get(t);return i&&!i.isSelf&&e.push(i),e}),[]);if(!s.length)return;const o=s.map((e=>e.id));if(n.ownership>-2){const t=e.ownership;n.allPlayers&&(t.default=n.ownership);for(const e of o)n.allPlayers?e in t&&t[e]<=n.ownership&&delete t[e]:(t[e]===CONST.DOCUMENT_OWNERSHIP_LEVELS.NONE&&(t[e]=n.ownership),t[e]=Math.max(t[e]??-1/0,n.ownership));await e.update({ownership:t},{diff:!1,recursive:!1,noHook:!0})}return n.imageOnly?this.showImage(e.src,{users:o,title:e.name,caption:n.showImageCaption?e.image.caption:void 0,showTitle:n.showImageTitle,uuid:e.uuid}):this.show(e,{force:!0,users:o})},rejectClose:!1,options:{jQuery:!1}})}static show(e,{force:t=!1,users:i=[]}={}){if(!(e instanceof JournalEntry||e instanceof JournalEntryPage))return;if(!e.isOwner)throw new Error(c.i18n.localize("JOURNAL.ShowBadPermissions"));const n=Object.fromEntries(["all","authorized","selected"].map((e=>[e,c.i18n.localize(e)])));return new Promise((s=>{c.socket.emit("showEntry",e.uuid,{force:t,users:i},(()=>(Journal._showEntry(e.uuid,t),ui.notifications.info(c.i18n.format("JOURNAL.ActionShowSuccess",{title:e.name,which:i.length?n.selected:t?n.all:n.authorized})),s(e))))}))}static showImage(e,{users:t=[],...i}={}){c.socket.emit("shareImage",{image:e,users:t,...i});const n=Object.fromEntries(["all","selected"].map((e=>[e,c.i18n.localize(e)])));ui.notifications.info(c.i18n.format("JOURNAL.ImageShowSuccess",{which:t.length?n.selected:n.all}))}static _activateSocketListeners(e){e.on("showEntry",this._showEntry.bind(this)),e.on("shareImage",ImagePopout._handleShareImage)}static async _showEntry(e,t=!1){let i=await fromUuid(e);const n={tempOwnership:t,mode:JournalSheet.VIEW_MODES.MULTIPLE,pageIndex:0},{OBSERVER:s}=CONST.DOCUMENT_OWNERSHIP_LEVELS;if(i instanceof JournalEntryPage)n.mode=JournalSheet.VIEW_MODES.SINGLE,n.pageId=i.id,i.getUserLevel(c.user)<s&&(i.ownership[c.userId]=s),i=i.parent;else{if(!(i instanceof JournalEntry))return;i.getUserLevel(c.user)<s&&(i.ownership[c.userId]=s)}(t||i.visible)&&i.sheet.render(!0,n)}}class Scenes extends WorldCollection{static documentName="Scene";get active(){return this.find((e=>e.active))}get current(){return canvas.ready||c.settings.get("core","noCanvas")?this.viewed:this.active}get viewed(){return this.find((e=>e.isView))}async preload(e,t=!1){if(t)return c.socket.emit("preloadScene",e,(()=>this.preload(e)));let i=this.get(e);const n=[];if(i.playlistSound?.path)n.push(foundry.audio.AudioHelper.preloadSound(i.playlistSound.path));else if(i.playlist?.playbackOrder.length){const e=i.playlist.sounds.get(i.playlist.playbackOrder[0]);e&&n.push(foundry.audio.AudioHelper.preloadSound(e.path))}return n.push(TextureLoader.loadSceneTextures(i,{expireCache:!1})),Promise.all(n)}static _activateSocketListeners(e){e.on("preloadScene",(e=>this.instance.preload(e))),e.on("pullToScene",this._pullToScene)}static _pullToScene(e){const t=c.scenes.get(e);t&&t.view()}fromCompendium(e,{clearState:t=!0,clearSort:i=!0,...n}={}){const s=super.fromCompendium(e,{clearSort:i,...n});return t&&delete s.active,i&&(s.navigation=!1,delete s.navOrder),s}}class WorldSettings extends WorldCollection{static documentName="Setting";get directory(){return null}getSetting(e){return this.find((t=>t.key===e))}getItem(e){return this.getSetting(e)?.value??null}}class RollTables extends WorldCollection{static documentName="RollTable";get directory(){return ui.tables}static registerSettings(){c.settings.register("core","animateRollTable",{name:"TABLE.AnimateSetting",hint:"TABLE.AnimateSettingHint",scope:"world",config:!0,type:new foundry.data.fields.BooleanField({initial:!0})})}}class Users extends WorldCollection{constructor(...e){super(...e),this.current=this.current||null}_initialize(){super._initialize(),this.current=this.get(c.data.userId)||null,this.current&&(this.current.active=!0);for(let e of c.data.activeUsers||[])this.get(e).active=!0}static documentName="User";get players(){return this.filter((e=>!e.isGM&&e.hasRole("PLAYER")))}get activeGM(){const e=c.users.filter((e=>e.active&&e.isGM));return e.sort(((e,t)=>t.role-e.role||e.id.compare(t.id))),e[0]||null}static _activateSocketListeners(e){e.on("userActivity",this._handleUserActivity)}static _handleUserActivity(e,t={}){const i=c.users.get(e);if(!i||i.isSelf)return;const n=!("active"in t)||t.active;if(i.active!==n&&(i.active=n,c.users.render(),ui.nav.render(),Hooks$1.callAll("userConnected",i,n)),!c.ready)return;if("sceneId"in t&&t.sceneId!==i.viewedScene&&(i.viewedScene=t.sceneId,ui.nav.render()),"av"in t&&c.webrtc.settings.handleUserActivity(e,t.av),canvas.ready){if(!1===n||i.viewedScene!==canvas.id)return canvas.controls.updateCursor(i,null),canvas.controls.updateRuler(i,null),void i.updateTokenTargets([]);"cursor"in t&&canvas.controls.updateCursor(i,t.cursor),"ping"in t&&canvas.controls.handlePing(i,t.cursor,t.ping),"ruler"in t&&canvas.controls.updateRuler(i,t.ruler),"targets"in t&&i.updateTokenTargets(t.targets)}}}class ActiveEffect extends(ClientDocumentMixin(foundry.documents.BaseActiveEffect)){static async fromStatusEffect(e,t={}){const i=g.statusEffects.find((t=>t.id===e));if(!i)throw new Error(`Invalid status ID "${e}" provided to ActiveEffect#fromStatusEffect`);for(const[e,t]of Object.entries({label:"name",icon:"img"}))if(!(t in i)&&e in i){const i=`StatusEffectConfig#${e} has been deprecated in favor of StatusEffectConfig#${t}`;foundry.utils.logCompatibilityWarning(i,{since:12,until:14,once:!0})}const{id:n,label:s,icon:o,hud:r,...a}=foundry.utils.deepClone(i);if(a.name=c.i18n.localize(a.name??s),a.img??=o,a.statuses=Array.from(new Set([n,...a.statuses??[]])),a.statuses.length>1&&!i._id)throw new Error("Status effects with implicit statuses must have a static _id");return ActiveEffect.implementation._fromStatusEffect(e,a,t)}static async _fromStatusEffect(e,t,i){return new this(t,i)}get isSuppressed(){return!1}get target(){return this.parent instanceof Actor?this.parent:g.ActiveEffect.legacyTransferral?this.transfer?null:this.parent:this.transfer?this.parent.parent??null:this.parent}get active(){return!this.disabled&&!this.isSuppressed}get modifiesActor(){return!!this.active&&(g.ActiveEffect.legacyTransferral?this.parent instanceof Actor:this.target instanceof Actor)}prepareBaseData(){const e=this.flags.core?.statusId;"string"==typeof e&&""!==e&&this.statuses.add(e)}prepareDerivedData(){this.updateDuration()}updateDuration(){const{remaining:e,label:t,...i}=this._prepareDuration();Object.assign(this.duration,i);const getOrUpdate=(e,t)=>this._requiresDurationUpdate()?this.updateDuration()[e]:t;return Object.defineProperties(this.duration,{remaining:{get:getOrUpdate.bind(this,"remaining",e),configurable:!0},label:{get:getOrUpdate.bind(this,"label",t),configurable:!0}}),this.duration}_requiresDurationUpdate(){const{_worldTime:e,_combatTime:t,type:i}=this.duration;if("seconds"===i)return c.time.worldTime!==e;if("turns"===i&&c.combat){return this._getCombatTime(c.combat.round,c.combat.turn)!==t&&!!this.target?.inCombat}return!1}_prepareDuration(){const e=this.duration;if(Number.isNumeric(e.seconds)){const t=c.time.worldTime,i=t-(e.startTime||t),n=e.seconds-i;return{type:"seconds",duration:e.seconds,remaining:n,label:`${n} ${c.i18n.localize("Seconds")}`,_worldTime:t}}if(e.rounds||e.turns){const t=c.combat;if(!t)return{type:"turns",_combatTime:void 0};const i={round:t.round??0,turn:t.turn??0,nTurns:t.turns.length||1},n=this._getCombatTime(i.round,i.turn),s=this._getCombatTime(e.rounds,e.turns),o=this._getCombatTime(e.startRound,e.startTurn,i.nTurns);if(n<=o)return{type:"turns",duration:s,remaining:s,label:this._getDurationLabel(e.rounds,e.turns),_combatTime:n};const r=Math.max((o+s-n).toNearest(.01),0),a=Math.floor(r);let l=0;if(r>0){let t=i.turn-e.startTurn;for(;t<0;)t+=i.nTurns;l=t>0?i.nTurns-t:0}return{type:"turns",duration:s,remaining:r,label:this._getDurationLabel(a,l),_combatTime:n}}return{type:"none",duration:null,remaining:null,label:c.i18n.localize("None")}}_getCombatTime(e,t,i){return void 0!==i&&(t=Math.min(t,i)),((e=Math.max(e,0))||0)+((t=Math.max(t,0))||0)/100}_getDurationLabel(e,t){const i=[];return e>0&&i.push(`${e} ${c.i18n.localize(1===e?"COMBAT.Round":"COMBAT.Rounds")}`),t>0&&i.push(`${t} ${c.i18n.localize(1===t?"COMBAT.Turn":"COMBAT.Turns")}`),e+t===0&&i.push(c.i18n.localize("None")),i.filterJoin(", ")}get isTemporary(){return(this.duration.seconds??(this.duration.rounds||this.duration.turns)??0)>0||this.statuses.size>0}get sourceName(){if(!this.origin)return c.i18n.localize("None");let e;try{e=fromUuidSync(this.origin)?.name}catch(e){}return e||c.i18n.localize("Unknown")}static applyField(e,t,i){i??=e.schema.getField(t.key);const n=foundry.utils.getProperty(e,t.key),s=i.applyChange(n,e,t);return foundry.utils.setProperty(e,t.key,s),s}apply(e,t){let i;const n={};return t.key.startsWith("system.")?e.system instanceof foundry.abstract.DataModel&&(i=e.system.schema.getField(t.key.slice(7))):i=e.schema.getField(t.key),i?n[t.key]=this.constructor.applyField(e,t,i):this._applyLegacy(e,t,n),n}_applyLegacy(e,t,i){const n=foundry.utils.getProperty(e,t.key)??null;let s=n;if(null===n){const i=c.model.Actor[e.type]||{};s=foundry.utils.getProperty(i,t.key)??null}let o,r=foundry.utils.getType(s);try{if("Array"===r){const e=s.length?foundry.utils.getType(s[0]):"string";o=this._castArray(t.value,e)}else o=this._castDelta(t.value,r)}catch(i){return void console.warn(`Actor [${e.id}] | Unable to parse active effect change for ${t.key}: "${t.value}"`)}const a=CONST.ACTIVE_EFFECT_MODES;switch(t.mode){case a.ADD:this._applyAdd(e,t,n,o,i);break;case a.MULTIPLY:this._applyMultiply(e,t,n,o,i);break;case a.OVERRIDE:this._applyOverride(e,t,n,o,i);break;case a.UPGRADE:case a.DOWNGRADE:this._applyUpgrade(e,t,n,o,i);break;default:this._applyCustom(e,t,n,o,i)}foundry.utils.mergeObject(e,i)}_castDelta(e,t){let i;switch(t){case"boolean":i=Boolean(this._parseOrString(e));break;case"number":i=Number.fromString(e),Number.isNaN(i)&&(i=0);break;case"string":i=String(e);break;default:i=this._parseOrString(e)}return i}_castArray(e,t){let i;try{i=this._parseOrString(e),i=i instanceof Array?i:[i]}catch(t){i=[e]}return i.map((e=>this._castDelta(e,t)))}_parseOrString(e){try{return JSON.parse(e)}catch(t){return e}}_applyAdd(e,t,i,n,s){let o;switch(foundry.utils.getType(i)){case"boolean":o=i||n;break;case"null":o=n;break;case"Array":o=i.concat(n);break;default:o=i+n}s[t.key]=o}_applyMultiply(e,t,i,n,s){let o;switch(foundry.utils.getType(i)){case"boolean":o=i&&n;break;case"number":o=i*n}s[t.key]=o}_applyOverride(e,t,i,n,s){return s[t.key]=n}_applyUpgrade(e,t,i,n,s){let o;switch(foundry.utils.getType(i)){case"boolean":case"number":(t.mode===CONST.ACTIVE_EFFECT_MODES.UPGRADE&&n>i||t.mode===CONST.ACTIVE_EFFECT_MODES.DOWNGRADE&&n<i)&&(o=n)}s[t.key]=o}_applyCustom(e,t,i,n,s){const o=foundry.utils.getProperty(e,t.key);Hooks$1.call("applyActiveEffect",e,t,i,n,s);const r=foundry.utils.getProperty(e,t.key);r!==o&&(s[t.key]=r)}static getInitialDuration(){const e={duration:{startTime:c.time.worldTime}};return c.combat&&(e.duration.startRound=c.combat.round,e.duration.startTurn=c.combat.turn??0),e}getFlag(e,t){return"core"===e&&"statusId"===t&&foundry.utils.logCompatibilityWarning("You are setting flags.core.statusId on an Active Effect. This flag is deprecated in favor of the statuses set.",{since:11,until:13}),super.getFlag(e,t)}async _preCreate(e,t,i){if(!1===await super._preCreate(e,t,i))return!1;if(foundry.utils.hasProperty(e,"flags.core.statusId")&&foundry.utils.logCompatibilityWarning("You are setting flags.core.statusId on an Active Effect. This flag is deprecated in favor of the statuses set.",{since:11,until:13}),this.parent instanceof Actor){const t=this.constructor.getInitialDuration();for(const i of Object.keys(t.duration))Number.isNumeric(e.duration?.[i])&&delete t.duration[i];t.transfer=!1,this.updateSource(t)}}_onCreate(e,t,i){super._onCreate(e,t,i),this.modifiesActor&&!1!==t.animate&&this._displayScrollingStatus(!0)}async _preUpdate(e,t,i){return(foundry.utils.hasProperty(e,"flags.core.statusId")||foundry.utils.hasProperty(e,"flags.core.-=statusId"))&&foundry.utils.logCompatibilityWarning("You are setting flags.core.statusId on an Active Effect. This flag is deprecated in favor of the statuses set.",{since:11,until:13}),"statuses"in e&&void 0!==this._source.flags.core?.statusId&&foundry.utils.setProperty(e,"flags.core.-=statusId",null),super._preUpdate(e,t,i)}_onUpdate(e,t,i){if(super._onUpdate(e,t,i),!(this.target instanceof Actor))return;"disabled"in e&&!1!==t.animate&&this._displayScrollingStatus(this.active)}_onDelete(e,t){super._onDelete(e,t),this.modifiesActor&&!1!==e.animate&&this._displayScrollingStatus(!1)}_displayScrollingStatus(e){if(!this.statuses.size&&!this.changes.length)return;const t=this.target.getActiveTokens(!0),i=`${e?"+":"-"}(${this.name})`;for(let n of t)n.visible&&!n.document.isSecret&&canvas.interface.createScrollingText(n.center,i,{anchor:CONST.TEXT_ANCHOR_POINTS.CENTER,direction:e?CONST.TEXT_ANCHOR_POINTS.TOP:CONST.TEXT_ANCHOR_POINTS.BOTTOM,distance:2*n.h,fontSize:28,stroke:0,strokeThickness:4,jitter:.25})}async _getSourceName(){if(foundry.utils.logCompatibilityWarning("You are accessing ActiveEffect._getSourceName which is deprecated.",{since:11,until:13}),!this.origin)return c.i18n.localize("None");const e=await fromUuid(this.origin);return e?.name??c.i18n.localize("Unknown")}}class ActorDelta extends(ClientDocumentMixin(foundry.documents.BaseActorDelta)){_configure(e={}){super._configure(e),this._createSyntheticActor()}_initialize({sceneReset:e=!1,...t}={}){e||(super._initialize(t),this.parent.isLinked||this.syntheticActor?.id===this.parent.actorId||this._createSyntheticActor({reinitializeCollections:!0}))}get type(){return this.syntheticActor?.type??this._type??this._source.type}set type(e){this._type=e}_type;apply(e={}){return this.constructor.applyDelta(this,this.parent.baseActor,e)}prepareEmbeddedDocuments(){}updateSource(e={},t={}){if(!this.syntheticActor||!this.parent.baseActor)return{};let i=foundry.utils.deepClone(e);if(delete i._id,i.type??=this.syntheticActor.type,i.name??=this.syntheticActor.name,!1===t.recursive){const e=new ActorDelta.implementation(i,{parent:this.parent}),t=this.constructor.applyDelta(e,this.parent.baseActor);t&&(i=t.toObject())}this.syntheticActor.updateSource(i,{...t});const n=super.updateSource(e,t),s=Object.keys(this.constructor.hierarchy).some((t=>t in e)),o=Object.keys(foundry.utils.flattenObject(e)).some((e=>e.includes("-=")));return this.parent.isLinked||!s&&!o||this.updateSyntheticActor(),n}reset(){super.reset(),this.parent.isLinked||this.syntheticActor?.reset()}_createSyntheticActor({reinitializeCollections:e=!1}={}){if(Object.defineProperty(this,"syntheticActor",{value:this.apply({strict:!1}),configurable:!0}),e)for(const e of Object.values(this.collections))e.initialize({full:!0})}updateSyntheticActor(){if(this.parent.isLinked)return;const e=this.apply();e&&this.syntheticActor.updateSource(e.toObject(),{diff:!1,recursive:!1})}async restore(){return this.parent.isLinked||await Promise.all(Object.values(this.syntheticActor.apps).map((e=>e.close()))),await this.delete({diff:!1,recursive:!1,restoreDelta:!0}),this.parent.actor}_handleDeltaCollectionUpdates(e){if(!e)return;if(e.parent!==this)return this._handleDeltaCollectionUpdates(e.parent);const t=this.getEmbeddedCollection(e.parentCollection);t.manages(e.id)||t.set(e.id,e)}async _preDelete(e,t){if(this.parent.isLinked)return super._preDelete(e,t);const i=this.parent.baseActor.toObject();let n=await this.syntheticActor._preUpdate(i,e,t)??!0;return n&&=e.noHook||Hooks$1.call("preUpdateActor",this.syntheticActor,i,e,t.id),!1===n?(console.debug(`${l} | Actor update prevented during pre-update`),!1):super._preDelete(e,t)}_onUpdate(e,t,i){super._onUpdate(e,t,i),this.parent.isLinked||(this.syntheticActor._onUpdate(e,t,i),Hooks$1.callAll("updateActor",this.syntheticActor,e,t,i))}_onDelete(e,t){super._onDelete(e,t),this.parent.baseActor&&(this.parent.updateSource({delta:{_id:this.parent.id}}),this.parent.delta._onUpdate(this.parent.baseActor.toObject(),e,t))}_dispatchDescendantDocumentEvents(e,t,i,n){if(super._dispatchDescendantDocumentEvents(e,t,i,n),!n){const n=this.syntheticActor[`_${e}DescendantDocuments`];n?.call(this.syntheticActor,this.syntheticActor,t,...i);const s=`_${e}EmbeddedDocuments`,o=foundry.utils.getDefiningClass(this.syntheticActor,s);if("ClientDocumentMixin"!==o?.name&&this.syntheticActor[s]instanceof Function){const n=this.syntheticActor.constructor.hierarchy[t].model.documentName,o=`The Actor class defines ${s} method which is deprecated in favor of a new _${e}DescendantDocuments method.`;foundry.utils.logCompatibilityWarning(o,{since:11,until:13}),this.syntheticActor[s](n,...i)}}}}class Actor extends(ClientDocumentMixin(foundry.documents.BaseActor)){_configure(e={}){super._configure(e),Object.defineProperty(this,"_dependentTokens",{value:new foundry.utils.IterableWeakMap})}_initializeSource(e,t={}){e=super._initializeSource(e,t);const i=c.packs.get(t.pack);if(!e._id||!i||!c.compendiumArt.enabled)return e;const n=i.getUuid(e._id),s=c.compendiumArt.get(n)??{};return s.actor||s.token?(s.actor&&(e.img=s.actor),"string"==typeof token?e.prototypeToken.texture.src=s.token:s.token&&foundry.utils.mergeObject(e.prototypeToken,s.token),Hooks$1.callAll("applyCompendiumArt",this.constructor,e,i,s),e):e}overrides=this.overrides??{};statuses=this.statuses??new Set;_tokenImages=null;_lastWildcard=null;get thumbnail(){return this.img}get itemTypes(){const e=Object.fromEntries(c.documentTypes.Item.map((e=>[e,[]])));for(const t of this.items.values())e[t.type].push(t);return e}get isToken(){return!!this.parent&&this.parent instanceof TokenDocument}get appliedEffects(){const e=[];for(const t of this.allApplicableEffects())t.active&&e.push(t);return e}get temporaryEffects(){const e=[];for(const t of this.allApplicableEffects())t.active&&t.isTemporary&&e.push(t);return e}get token(){return this.parent instanceof TokenDocument?this.parent:null}get inCombat(){return!!c.combat?.getCombatantsByActor(this).length}applyActiveEffects(){const e={};this.statuses.clear();const t=[];for(const e of this.allApplicableEffects())if(e.active){t.push(...e.changes.map((t=>{const i=foundry.utils.deepClone(t);return i.effect=e,i.priority=i.priority??10*i.mode,i})));for(const t of e.statuses)this.statuses.add(t)}t.sort(((e,t)=>e.priority-t.priority));for(let i of t){if(!i.key)continue;const t=i.effect.apply(this,i);Object.assign(e,t)}this.overrides=foundry.utils.expandObject(e)}getActiveTokens(e=!1,t=!1){if(!canvas.ready)return[];const i=[];for(const n of this.getDependentTokens({linked:e,scenes:canvas.scene}))n===canvas.scene.tokens.get(n.id)&&(t?i.push(n):n.rendered&&i.push(n.object));return i}*allApplicableEffects(){for(const e of this.effects)yield e;if(!g.ActiveEffect.legacyTransferral)for(const e of this.items)for(const t of e.effects)t.transfer&&(yield t)}getRollData(){return this.system}async getTokenDocument(e={},t={}){const i=this.prototypeToken.toObject();if(i.actorId=this.id,i.randomImg&&!e.texture?.src){let e=await this.getTokenImages();e.length>1&&this._lastWildcard&&(e=e.filter((e=>e!==this._lastWildcard)));const t=e[Math.floor(Math.random()*e.length)];i.texture.src=this._lastWildcard=t}if(!i.actorLink){if(i.appendNumber){const e=canvas.scene.tokens.filter((e=>e.actorId===this.id)).length+1;i.name=`${i.name} (${e})`}if(i.prependAdjective){const e=Object.values(foundry.utils.getProperty(c.i18n.translations,g.Token.adjectivesPrefix)||foundry.utils.getProperty(c.i18n._fallback,g.Token.adjectivesPrefix)||{}),t=e[Math.floor(Math.random()*e.length)];i.name=`${t} ${i.name}`}}foundry.utils.mergeObject(i,e);return new(getDocumentClass("Token"))(i,t)}async getTokenImages(){if(!this.prototypeToken.randomImg)return[this.prototypeToken.texture.src];if(this._tokenImages)return this._tokenImages;try{this._tokenImages=await this.constructor._requestTokenImages(this.id,{pack:this.pack})}catch(e){this._tokenImages=[],Hooks$1.onError("Actor#getTokenImages",e,{msg:"Error retrieving wildcard tokens",log:"error",notify:"error"})}return this._tokenImages}async modifyTokenAttribute(e,t,i=!1,n=!0){const s=foundry.utils.getProperty(this.system,e),o=n?s.value:s,r=i?o+t:t;if(r===o)return this;let a;a=n?{[`system.${e}.value`]:Math.clamp(r,0,s.max)}:{[`system.${e}`]:r};return!1!==Hooks$1.call("modifyTokenAttribute",{attribute:e,value:t,isDelta:i,isBar:n},a)?this.update(a):this}prepareData(){this.statuses??=new Set;const e=new Map;for(const t of Object.values(g.specialStatusEffects))e.set(t,this.statuses.has(t));let t;super.prepareData();for(const[i,n]of e){const e=this.statuses.has(i);if(e!==n){t??=this.getDependentTokens({scenes:canvas.scene}).filter((e=>e.rendered)).map((e=>e.object));for(const n of t)n._onApplyStatusEffect(i,e)}}}prepareEmbeddedDocuments(){super.prepareEmbeddedDocuments(),this.applyActiveEffects()}async rollInitiative({createCombatants:e=!1,rerollInitiative:t=!1,initiativeOptions:i={}}={}){let n=c.combat;if(!n){if(!c.user.isGM||!canvas.scene)return ui.notifications.warn("COMBAT.NoneActive",{localize:!0}),null;{const e=getDocumentClass("Combat");n=await e.create({scene:canvas.scene.id,active:!0})}}if(e){const e=this.getActiveTokens(),t=[];if(e.length)for(let i of e)i.inCombat||t.push({tokenId:i.id,sceneId:i.scene.id,actorId:this.id,hidden:i.document.hidden});else t.push({actorId:this.id,hidden:!1});await n.createEmbeddedDocuments("Combatant",t)}const s=n.combatants.reduce(((e,i)=>this.isToken&&i.token!==this.token?e:(this.isToken||i.actor===this)&&(t||null===i.initiative)?(e.push(i.id),e):e),[]);return await n.rollInitiative(s,i),n}async toggleStatusEffect(e,{active:t,overlay:i=!1}={}){const n=g.statusEffects.find((t=>t.id===e));if(!n)throw new Error(`Invalid status ID "${e}" provided to Actor#toggleStatusEffect`);const s=[];if(n._id){const e=this.effects.get(n._id);e&&s.push(e.id)}else for(const e of this.effects){const t=e.statuses;1===t.size&&t.has(n.id)&&s.push(e.id)}if(s.length)return!!t||(await this.deleteEmbeddedDocuments("ActiveEffect",s),!1);if(!t&&void 0!==t)return;const o=await ActiveEffect.implementation.fromStatusEffect(e);return i&&o.updateSource({"flags.core.overlay":!0}),ActiveEffect.implementation.create(o,{parent:this,keepId:!0})}static _requestTokenImages(e,t={}){return new Promise(((i,n)=>{c.socket.emit("requestTokenImages",e,t,(e=>{if(e.error)return n(new Error(e.error));i(e.files)}))}))}getDependentTokens({scenes:e,linked:t=!1}={}){if(this.isToken&&!e)return[this.token];if(e=e?Array.isArray(e)?e:[e]:Array.from(this._dependentTokens.keys()),this.isToken){const t=this.token.parent;return e.includes(t)?[this.token]:[]}const i=[];for(const n of e){if(!n)continue;const e=this._dependentTokens.get(n);for(const n of e??[])t&&!n.actorLink||i.push(n)}return i}_registerDependentToken(e){if(!e?.parent)return;this._dependentTokens.has(e.parent)||this._dependentTokens.set(e.parent,new foundry.utils.IterableWeakSet);this._dependentTokens.get(e.parent).add(e)}_unregisterDependentToken(e){if(!e?.parent)return;const t=this._dependentTokens.get(e.parent);t?.delete(e)}_unregisterDependentScene(e){this._dependentTokens.delete(e)}_onUpdate(e,t,i){Object.values(this.apps).forEach((t=>{t instanceof TokenConfig&&(t.object=this.prototypeToken,t._previewChanges(e.prototypeToken??{}))})),super._onUpdate(e,t,i),this.isToken||(this._updateDependentTokens(e,t),"prototypeToken"in e&&(this._tokenImages=null),"permission"in e&&tokens.length&&(canvas.tokens.releaseAll(),canvas.tokens.cycleTokens(!0,!0)))}_onCreateDescendantDocuments(e,t,i,n,s,o){!g.ActiveEffect.legacyTransferral&&e instanceof Item&&this.reset(),super._onCreateDescendantDocuments(e,t,i,n,s,o),this._onEmbeddedDocumentChange()}_onUpdateDescendantDocuments(e,t,i,n,s,o){!g.ActiveEffect.legacyTransferral&&e instanceof Item&&this.reset(),super._onUpdateDescendantDocuments(e,t,i,n,s,o),this._onEmbeddedDocumentChange()}_onDeleteDescendantDocuments(e,t,i,n,s,o){!g.ActiveEffect.legacyTransferral&&e instanceof Item&&this.reset(),super._onDeleteDescendantDocuments(e,t,i,n,s,o),this._onEmbeddedDocumentChange()}_onEmbeddedDocumentChange(){this.isToken||this._updateDependentTokens()}_updateDependentTokens(...e){for(const t of this.getDependentTokens())t._onUpdateBaseActor(...e)}}class Adventure extends(ClientDocumentMixin(foundry.documents.BaseAdventure)){static fromSource(e,t={}){const i=c.packs.get(t.pack);return i&&!i.metadata.system&&(e.actors=[],e.items=[],e.folders=e.folders.filter((e=>!CONST.SYSTEM_SPECIFIC_COMPENDIUM_TYPES.includes(e.type)))),super.fromSource(e,t)}async import({dialog:e=!0,...t}={}){const i=await this.prepareImport(t);if(!1===Hooks$1.call("preImportAdventure",this,t,i.toCreate,i.toUpdate))return console.log(`"${this.name}" Adventure import was prevented by the "preImportAdventure" hook`),{created:[],updated:[]};if(!foundry.utils.isEmpty(i.toUpdate)&&e){if(!await Dialog.confirm({title:c.i18n.localize("ADVENTURE.ImportOverwriteTitle"),content:`<h4><strong>${c.i18n.localize("Warning")}:</strong></h4>\n        <p>${c.i18n.format("ADVENTURE.ImportOverwriteWarning",{name:this.name})}</p>`}))return{created:[],updated:[]}}const{created:n,updated:s}=await this.importContent(i);ui.sidebar.render(),Hooks$1.callAll("importAdventure",this,t,n,s);const o=c.settings.get("core","adventureImports");return o[this.uuid]=!0,await c.settings.set("core","adventureImports",o),{created:n,updated:s}}async prepareImport({importFields:e=[]}={}){e=new Set(e);const t=this.toObject(),i={},n={};let s=0;const o=!e.size||e.has("all"),r=new Set;for(const[a,l]of Object.entries(Adventure.contentFields)){if(!o&&!e.has(a))continue;r.add(l.documentName);const d=c.collections.get(l.documentName);let[u,h]=t[a].partition((e=>d.has(e._id)));"folders"!==a||o||(u=u.filter((e=>r.has(e.type))),h=h.filter((e=>r.has(e.type)))),u.length&&(i[l.documentName]=u,s+=u.length),h.length&&(n[l.documentName]=h,s+=h.length)}return{toCreate:i,toUpdate:n,documentCount:s}}async importContent({toCreate:e,toUpdate:t,documentCount:i}={}){const n={},s={},o=c.i18n.localize("ADVENTURE.ImportProgress");let r=0;SceneNavigation.displayProgressBar({label:o,pct:1});for(const[t,s]of Object.entries(e)){const e=getDocumentClass(t),a=await e.createDocuments(s,{keepId:!0,keepEmbeddedId:!0,renderSheet:!1});n[t]=a,r+=a.length,SceneNavigation.displayProgressBar({label:o,pct:Math.floor(100*r/i)})}for(const[e,n]of Object.entries(t)){const t=getDocumentClass(e),a=await t.updateDocuments(n,{diff:!1,recursive:!1,noHook:!0});s[e]=a,r+=a.length,SceneNavigation.displayProgressBar({label:o,pct:Math.floor(100*r/i)})}return SceneNavigation.displayProgressBar({label:o,pct:100}),{created:n,updated:s}}}class AmbientLightDocument extends(CanvasDocumentMixin(foundry.documents.BaseAmbientLight)){_onUpdate(e,t,i){const n=Object.values(this.apps).filter((e=>e instanceof foundry.applications.sheets.AmbientLightConfig));n.forEach((i=>{i.preview&&(t.animate=!1),i._previewChanges(e)})),super._onUpdate(e,t,i),n.forEach((e=>e._previewChanges()))}get isGlobal(){return!this.walls}}class AmbientSoundDocument extends(CanvasDocumentMixin(foundry.documents.BaseAmbientSound)){}class Card extends(ClientDocumentMixin(foundry.documents.BaseCard)){get currentFace(){if(null===this.face)return null;const e=Math.clamp(this.face,0,this.faces.length-1);return this.faces[e]||null}get img(){return this.currentFace?.img||this.back.img||Card.DEFAULT_ICON}get source(){return"deck"===this.parent?.type?this.parent:this.origin}get isHome(){return"deck"===this.parent?.type||this.origin===this.parent}get showFace(){return void 0!==this.faces[this.face]}get hasNextFace(){return null===this.face||this.face<this.faces.length-1}get hasPreviousFace(){return null!==this.face}prepareDerivedData(){super.prepareDerivedData(),this.back.img||=this.source?.img||Card.DEFAULT_ICON,this.name=(this.showFace?this.currentFace.name||this._source.name:this.back.name)||c.i18n.format("CARD.Unknown",{source:this.source?.name||c.i18n.localize("Unknown")})}async flip(e){return Number.isNumeric(e)||null===e?this.update({face:e}):this.update({face:null===this.face?0:null})}async pass(e,{updateData:t={},...i}={}){return(await this.parent.pass(e,[this.id],{updateData:t,action:"pass",...i}))[0]}async play(e,{updateData:t={},...i}={}){return(await this.parent.pass(e,[this.id],{updateData:t,action:"play",...i}))[0]}async discard(e,{updateData:t={},...i}={}){return(await this.parent.pass(e,[this.id],{updateData:t,action:"discard",...i}))[0]}async recall(e={}){const t=this.isHome?this:this.source?.cards.get(this.id);return t&&await t.update({drawn:!1}),this.isHome||await this.delete(),t}async toMessage(e={},t={}){return e=foundry.utils.mergeObject({content:`<div class="card-draw flexrow">\n        <img class="card-face" src="${this.img}" alt="${this.name}"/>\n        <h4 class="card-name">${this.name}</h4>\n      </div>`},e),ChatMessage.implementation.create(e,t)}}class Cards extends(ClientDocumentMixin(foundry.documents.BaseCards)){get thumbnail(){return this.img}get availableCards(){return this.cards.filter((e=>"deck"!==this.type||!e.drawn))}get drawnCards(){return this.cards.filter((e=>e.drawn))}get typeLabel(){switch(this.type){case"deck":return c.i18n.localize("CARDS.TypeDeck");case"hand":return c.i18n.localize("CARDS.TypeHand");case"pile":return c.i18n.localize("CARDS.TypePile");default:throw new Error(`Unexpected type ${this.type}`)}}get canClone(){return"deck"===this.type||0===this.cards.size}static async createDocuments(e=[],t={}){return void 0===t.keepEmbeddedIds&&(t.keepEmbeddedIds=!1),super.createDocuments(e,t)}async deal(e,t=1,{action:i="deal",how:n=0,updateData:s={},chatNotification:o=!0}={}){if(!e.every((e=>e instanceof Cards)))throw new Error("You must provide an array of Cards documents as the destinations for the Cards#deal operation");const r=t*e.length,a=this._drawCards(r,n),c=e.map((()=>[])),d=[],u=[];for(let t=0;t<r;t++){const i=t%e.length,n=a[t],o=foundry.utils.mergeObject(n.toObject(),s);!n.isHome&&o.origin||(o.origin=this.id),o.drawn=!0,c[i].push(o),n.isHome?d.push({_id:n.id,drawn:!0}):u.push(n.id)}if(!1===Hooks$1.call("dealCards",this,e,{action:i,toCreate:c,fromUpdate:d,fromDelete:u}))return console.debug(`${l} | The Cards#deal operation was prevented by a hooked function`),this;const h=e.map(((e,t)=>e.createEmbeddedDocuments("Card",c[t],{keepId:!0})));if(h.push(this.updateEmbeddedDocuments("Card",d)),h.push(this.deleteEmbeddedDocuments("Card",u)),await Promise.all(h),o){const n={deal:"CARDS.NotifyDeal",pass:"CARDS.NotifyPass"};this._postChatNotification(this,n[i],{number:t,link:e.map((e=>e.link)).join(", ")})}return this}async pass(e,t,{updateData:i={},action:n="pass",chatNotification:s=!0}={}){if(!(e instanceof Cards))throw new Error("You must provide a Cards document as the recipient for the Cards#pass operation");const o=[],r=[],a=[],c=[];for(let n of t){const t=this.cards.get(n,{strict:!0}),s=t.origin&&!t.origin.cards.get(n);if("deck"===this.type&&t.isHome&&t.drawn)throw new Error(`You may not pass Card ${n} which has already been drawn`);if(t.origin!==e||s){const n=foundry.utils.mergeObject(t.toObject(),i),r=t.isHome&&"deck"===e.type;r?n.origin=e.id:!t.isHome&&n.origin||(n.origin=this.id),n.drawn=!r&&!s,o.push(n)}else r.push({_id:t.id,drawn:!1});t.isHome&&"deck"!==e.type?a.push({_id:t.id,drawn:!0}):t.isHome||c.push(t.id)}if(!1===Hooks$1.call("passCards",this,e,{action:n,toCreate:o,toUpdate:r,fromUpdate:a,fromDelete:c}))return console.debug(`${l} | The Cards#pass operation was prevented by a hooked function`),[];const d=e.createEmbeddedDocuments("Card",o,{keepId:!0});if(await Promise.all([d,e.updateEmbeddedDocuments("Card",r),this.updateEmbeddedDocuments("Card",a),this.deleteEmbeddedDocuments("Card",c)]),s){const i={pass:"CARDS.NotifyPass",play:"CARDS.NotifyPlay",discard:"CARDS.NotifyDiscard",draw:"CARDS.NotifyDraw"},s="draw"===n?e:this,o="draw"===n?this:e;this._postChatNotification(s,i[n],{number:t.length,link:o.link})}return d}async draw(e,t=1,{how:i=0,updateData:n={},...s}={}){if(!(e instanceof Cards)||e===this)throw new Error("You must provide some other Cards document as the source for the Cards#draw operation");const o=e._drawCards(t,i);return e.pass(this,o.map((e=>e.id)),{updateData:n,action:"draw",...s})}async shuffle({updateData:e={},chatNotification:t=!0}={}){const i=this.cards.map((e=>[foundry.dice.MersenneTwister.random(),e]));i.sort(((e,t)=>e[0]-t[0]));const n=i.map(((t,i)=>{const n=t[1];return foundry.utils.mergeObject({_id:n.id,sort:i},e)}));return await this.updateEmbeddedDocuments("Card",n),t&&this._postChatNotification(this,"CARDS.NotifyShuffle",{link:this.link}),this}async recall(e){return"deck"===this.type?this._resetDeck(e):this._resetStack(e)}async _resetDeck({updateData:e={},chatNotification:t=!0}={}){for(let e of c.cards){if(e===this)continue;const t=[];for(let i of e.cards)i.origin===this&&t.push(i.id);t.length&&await e.deleteEmbeddedDocuments("Card",t)}const i=this.cards.contents;i.sort(this.sortStandard.bind(this));const n=i.map((t=>foundry.utils.mergeObject({_id:t.id,drawn:!1},e)));return await this.updateEmbeddedDocuments("Card",n),t&&this._postChatNotification(this,"CARDS.NotifyReset",{link:this.link}),this}async _resetStack({updateData:e={},chatNotification:t=!0}={}){const i={},n=[];for(const t of this.cards)if(!t.isHome&&t.origin){if(t.origin.cards.get(t.id)){i[t.origin.id]||(i[t.origin.id]=[]);const n=foundry.utils.mergeObject(e,{_id:t.id,drawn:!1},{inplace:!1});i[t.origin.id].push(n)}n.push(t.id)}if(!1===Hooks$1.call("returnCards",this,n.map((e=>this.cards.get(e))),{toUpdate:i,fromDelete:n}))return console.debug(`${l} | The Cards#return operation was prevented by a hooked function.`),this;const s=Object.entries(i).map((([e,t])=>c.cards.get(e).updateEmbeddedDocuments("Card",t)));return await Promise.all([...s,this.deleteEmbeddedDocuments("Card",n)]),t&&this._postChatNotification(this,"CARDS.NotifyReturn",{link:this.link}),this}sortStandard(e,t){return(e.suit??"")===(t.suit??"")?(e.value??-1/0)-(t.value??-1/0)||0:(e.suit??"").compare(t.suit??"")}sortShuffled(e,t){return e.sort-t.sort}_drawCards(e,t){let i,n=this.availableCards;if(n.length<e)throw new Error(`There are not ${e} available cards remaining in Cards [${this.id}]`);switch(t){case CONST.CARD_DRAW_MODES.FIRST:n.sort(this.sortShuffled.bind(this)),i=n.slice(0,e);break;case CONST.CARD_DRAW_MODES.LAST:n.sort(this.sortShuffled.bind(this)),i=n.slice(-e);break;case CONST.CARD_DRAW_MODES.RANDOM:const t=n.map((e=>[Math.random(),e]));t.sort(((e,t)=>e[0]-t[0])),i=t.slice(-e).map((e=>e[1]))}return i}_postChatNotification(e,t,i){const n={style:CONST.CHAT_MESSAGE_STYLES.OTHER,speaker:{user:c.user},content:`\n      <div class="cards-notification flexrow">\n        <img class="icon" src="${e.thumbnail}" alt="${e.name}">\n        <p>${c.i18n.format(t,i)}</p>\n      </div>`};return ChatMessage.applyRollMode(n,c.settings.get("core","rollMode")),ChatMessage.implementation.create(n)}async _preCreate(e,t,i){if(!1===await super._preCreate(e,t,i))return!1;for(const e of this.cards)e.updateSource({drawn:!1})}_onUpdate(e,t,i){"type"in e&&(this.sheet?.close(),this._sheet=void 0),super._onUpdate(e,t,i)}async _preDelete(e,t){return await this.recall(),super._preDelete(e,t)}async dealDialog(){const e=c.cards.filter((e=>"deck"!==e.type&&e.testUserPermission(c.user,"LIMITED")));if(!e.length)return ui.notifications.warn("CARDS.DealWarnNoTargets",{localize:!0}),this;const t=await renderTemplate("templates/cards/dialog-deal.html",{hands:e,modes:{[CONST.CARD_DRAW_MODES.TOP]:"CARDS.DrawModeTop",[CONST.CARD_DRAW_MODES.BOTTOM]:"CARDS.DrawModeBottom",[CONST.CARD_DRAW_MODES.RANDOM]:"CARDS.DrawModeRandom"}});return Dialog.prompt({title:c.i18n.localize("CARDS.DealTitle"),label:c.i18n.localize("CARDS.Deal"),content:t,callback:e=>{const t=e.querySelector("form.cards-dialog"),i=new FormDataExtended(t).object;if(!i.to)return this;const n=(i.to instanceof Array?i.to:[i.to]).reduce(((e,t)=>{const i=c.cards.get(t);return i&&e.push(i),e}),[]),s={how:i.how,updateData:i.down?{face:null}:{}};return this.deal(n,i.number,s).catch((e=>(ui.notifications.error(e.message),this)))},rejectClose:!1,options:{jQuery:!1}})}async drawDialog(){const e=c.cards.filter((e=>"deck"===e.type&&e.testUserPermission(c.user,"LIMITED")));if(!e.length)return ui.notifications.warn("CARDS.DrawWarnNoSources",{localize:!0}),[];const t=await renderTemplate("templates/cards/dialog-draw.html",{decks:e,modes:{[CONST.CARD_DRAW_MODES.TOP]:"CARDS.DrawModeTop",[CONST.CARD_DRAW_MODES.BOTTOM]:"CARDS.DrawModeBottom",[CONST.CARD_DRAW_MODES.RANDOM]:"CARDS.DrawModeRandom"}});return Dialog.prompt({title:c.i18n.localize("CARDS.DrawTitle"),label:c.i18n.localize("CARDS.Draw"),content:t,callback:e=>{const t=e.querySelector("form.cards-dialog"),i=new FormDataExtended(t).object,n=c.cards.get(i.from),s={how:i.how,updateData:i.down?{face:null}:{}};return this.draw(n,i.number,s).catch((e=>(ui.notifications.error(e.message),[])))},rejectClose:!1,options:{jQuery:!1}})}async passDialog(){const e=c.cards.filter((e=>e!==this&&"deck"!==e.type&&e.testUserPermission(c.user,"LIMITED")));if(!e.length)return ui.notifications.warn("CARDS.PassWarnNoTargets",{localize:!0}),this;const t=await renderTemplate("templates/cards/dialog-pass.html",{cards:e,modes:{[CONST.CARD_DRAW_MODES.TOP]:"CARDS.DrawModeTop",[CONST.CARD_DRAW_MODES.BOTTOM]:"CARDS.DrawModeBottom",[CONST.CARD_DRAW_MODES.RANDOM]:"CARDS.DrawModeRandom"}});return Dialog.prompt({title:c.i18n.localize("CARDS.PassTitle"),label:c.i18n.localize("CARDS.Pass"),content:t,callback:e=>{const t=e.querySelector("form.cards-dialog"),i=new FormDataExtended(t).object,n=c.cards.get(i.to),s={action:"pass",how:i.how,updateData:i.down?{face:null}:{}};return this.deal([n],i.number,s).catch((e=>(ui.notifications.error(e.message),this)))},rejectClose:!1,options:{jQuery:!1}})}async playDialog(e){const t=c.cards.filter((e=>e!==this&&"deck"!==e.type&&e.testUserPermission(c.user,"LIMITED")));if(!t.length)return ui.notifications.warn("CARDS.PassWarnNoTargets",{localize:!0}),[];const i=await renderTemplate("templates/cards/dialog-play.html",{card:e,cards:t});return Dialog.prompt({title:c.i18n.localize("CARD.Play"),label:c.i18n.localize("CARD.Play"),content:i,callback:t=>{const i=t.querySelector("form.cards-dialog"),n=new FormDataExtended(i).object,s=c.cards.get(n.to),o={action:"play",updateData:n.down?{face:null}:{}};return this.pass(s,[e.id],o).catch((e=>(ui.notifications.error(e.message),[])))},rejectClose:!1,options:{jQuery:!1}})}async resetDialog(){return Dialog.confirm({title:c.i18n.localize("CARDS.Reset"),content:`<p>${c.i18n.format(`CARDS.${"deck"===this.type?"Reset":"Return"}Confirm`,{name:this.name})}</p>`,yes:()=>this.recall()})}async deleteDialog(e={}){if(!this.drawnCards.length)return super.deleteDialog(e);const t=this.typeLabel;return new Promise((i=>{new Dialog({title:`${c.i18n.format("DOCUMENT.Delete",{type:t})}: ${this.name}`,content:`\n          <h4>${c.i18n.localize("CARDS.DeleteCannot")}</h4>\n          <p>${c.i18n.format("CARDS.DeleteMustReset",{type:t})}</p>\n        `,buttons:{reset:{icon:'<i class="fas fa-undo"></i>',label:c.i18n.localize("CARDS.DeleteReset"),callback:()=>i(this.delete())},cancel:{icon:'<i class="fas fa-times"></i>',label:c.i18n.localize("Cancel"),callback:()=>i(!1)}},close:()=>i(null),default:"reset"},e).render(!0)}))}static async createDialog(e={},{parent:t=null,pack:i=null,types:n,...s}={}){if(n){if(0===n.length)throw new Error("The array of sub-types to restrict to must not be empty");for(const e of n)if(!this.TYPES.includes(e))throw new Error(`Invalid ${this.documentName} sub-type: "${e}"`)}const o=this.TYPES.filter((e=>!1!==n?.includes(e)));let r;t||(r=i?c.packs.get(i):c.collections.get(this.documentName));const a=r?._formatFolderSelectOptions()??[],l=c.i18n.localize(this.metadata.label),d=c.i18n.format("DOCUMENT.Create",{type:l}),u=e.type||o[0],h=await renderTemplate("templates/sidebar/cards-create.html",{folders:a,name:e.name||"",defaultName:this.implementation.defaultName({type:u,parent:t,pack:i}),folder:e.folder,hasFolders:a.length>=1,type:u,types:Object.fromEntries(o.map((e=>{const t=g[this.documentName]?.typeLabels?.[e];return[e,t&&c.i18n.has(t)?c.i18n.localize(t):e]})).sort(((e,t)=>e[1].localeCompare(t[1],c.i18n.lang)))),hasTypes:!0,presets:g.Cards.presets});return Dialog.prompt({title:d,content:h,label:d,render:e=>{e[0].querySelector('[name="type"]').addEventListener("change",(n=>{e[0].querySelector('[name="name"]').placeholder=this.implementation.defaultName({type:n.target.value,parent:t,pack:i})}))},callback:async n=>{const s=n[0].querySelector("form"),o=new FormDataExtended(s);foundry.utils.mergeObject(e,o.object,{inplace:!0}),e.folder||delete e.folder,e.name?.trim()||(e.name=this.implementation.defaultName({type:e.type,parent:t,pack:i}));const r=g.Cards.presets[e.preset];if(r&&r.type===e.type){const t=await fetch(r.src).then((e=>e.json()));e=foundry.utils.mergeObject(t,e)}return this.implementation.create(e,{parent:t,pack:i,renderSheet:!0})},rejectClose:!1,options:s})}}class ChatMessage extends(ClientDocumentMixin(foundry.documents.BaseChatMessage)){_rollExpanded=!1;logged=!1;get alias(){const e=this.speaker;return e.alias?e.alias:c.actors.has(e.actor)?c.actors.get(e.actor).name:this.author?.name??c.i18n.localize("CHAT.UnknownUser")}get isAuthor(){return c.user===this.author}get isContentVisible(){if(this.isRoll){const e=this.whisper||[],t=e.length&&this.blind;return!e.length||(e.includes(c.user.id)||this.isAuthor&&!t)}return this.visible}get isRoll(){return this.rolls.length>0}get visible(){return!this.whisper.length||(!!this.isRoll||(this.isAuthor||-1!==this.whisper.indexOf(c.user.id)))}prepareDerivedData(){super.prepareDerivedData(),this.rolls=this.rolls.reduce(((e,t)=>{try{e.push(Roll.fromData(t))}catch(e){Hooks$1.onError("ChatMessage#rolls",e,{rollData:t,log:"error"})}return e}),[])}static applyRollMode(e,t){const i=CONST.DICE_ROLL_MODES;return"roll"===t&&(t=c.settings.get("core","rollMode")),[i.PRIVATE,i.BLIND].includes(t)?e.whisper=ChatMessage.getWhisperRecipients("GM").map((e=>e.id)):t===i.SELF?e.whisper=[c.user.id]:t===i.PUBLIC&&(e.whisper=[]),e.blind=t===i.BLIND,e}applyRollMode(e){const t={};this.constructor.applyRollMode(t,e),this.updateSource(t)}static getSpeaker({scene:e,actor:t,token:i,alias:n}={}){if(i instanceof Token||i instanceof TokenDocument)return this._getSpeakerFromToken({token:i,alias:n});const s=t instanceof Actor;if(s&&t.isToken)return this._getSpeakerFromToken({token:t.token,alias:n});if(s){n=n||t.name;const s=t.getActiveTokens();if(!s.length)return this._getSpeakerFromActor({scene:e,actor:t,alias:n});const o=s.filter((e=>e.controlled));return i=o.length?o.shift():s.shift(),this._getSpeakerFromToken({token:i.document,alias:n})}if(e instanceof Scene&&!e.isView){const t=c.user.character;return t?this._getSpeakerFromActor({scene:e,actor:t,alias:n}):this._getSpeakerFromUser({scene:e,user:c.user,alias:n})}if(canvas.ready){let e=canvas.tokens.controlled;if(e.length)return this._getSpeakerFromToken({token:e.shift().document,alias:n})}const o=c.user.character;if(o){const e=o.getActiveTokens(!1,!0);return e.length?this._getSpeakerFromToken({token:e.shift(),alias:n}):this._getSpeakerFromActor({actor:o,alias:n})}return this._getSpeakerFromUser({scene:e,user:c.user,alias:n})}static _getSpeakerFromToken({token:e,alias:t}){return{scene:e.parent?.id||null,token:e.id,actor:e.actor?.id||null,alias:t||e.name}}static _getSpeakerFromActor({scene:e,actor:t,alias:i}){return{scene:(e||canvas.scene)?.id||null,actor:t.id,token:null,alias:i||t.name}}static _getSpeakerFromUser({scene:e,user:t,alias:i}){return{scene:(e||canvas.scene)?.id||null,actor:null,token:null,alias:i||t.name}}static getSpeakerActor(e){if(!e)return null;let t=null;if(e.scene&&e.token){const i=c.scenes.get(e.scene),n=i?i.tokens.get(e.token):null;t=n?.actor}return e.actor&&!t&&(t=c.actors.get(e.actor)),t||null}getRollData(){const e=this.constructor.getSpeakerActor(this.speaker)??this.author?.character;return e?e.getRollData():{}}static getWhisperRecipients(e){if(["GM","DM"].includes(e.toUpperCase()))return c.users.filter((e=>e.isGM));if("players"===e.toLowerCase())return c.users.players;const t=e.toLowerCase(),i=c.users.filter((e=>e.name.toLowerCase()===t));if(i.length)return i;const n=c.users.filter((e=>e.character&&e.character.name.toLowerCase()===t));return n.length?n:[]}async getHTML(){const e=this.toObject(!1);e.content=await TextEditor$1.enrichHTML(this.content,{rollData:this.getRollData()});const t=this.whisper.length,i={message:e,user:c.user,author:this.author,alias:this.alias,cssClass:[this.style===CONST.CHAT_MESSAGE_STYLES.IC?"ic":null,this.style===CONST.CHAT_MESSAGE_STYLES.EMOTE?"emote":null,t?"whisper":null,this.blind?"blind":null].filterJoin(" "),isWhisper:this.whisper.length,canDelete:c.user.isGM,whisperTo:this.whisper.map((e=>{let t=c.users.get(e);return t?t.name:null})).filterJoin(", ")};this.isRoll&&await this._renderRollContent(i),this.style===CONST.CHAT_MESSAGE_STYLES.OOC&&(i.borderColor=this.author?.color.css);let n=await renderTemplate(g.ChatMessage.template,i);return n=$(n),this._rollExpanded&&n.find(".dice-tooltip").addClass("expanded"),Hooks$1.call("renderChatMessage",this,n,i),n}async _renderRollContent(e){const t=e.message,renderRolls=async e=>{let t="";for(const i of this.rolls)t+=await i.render({isPrivate:e});return t};if((this.blind||this.whisper.length)&&(e.isWhisper=!1),this.isContentVisible){const e=document.createElement("div");e.innerHTML=t.content,!e.childElementCount&&this.rolls.length&&(t.content=await this._renderRollHTML(!1))}else{const i=this.author?.name??c.i18n.localize("CHAT.UnknownUser");t.flavor=c.i18n.format("CHAT.PrivateRollContent",{user:i}),t.content=await renderRolls(!0),e.alias=i}}async _renderRollHTML(e){let t="";for(const i of this.rolls)t+=await i.render({isPrivate:e});return t}async _preCreate(e,t,i){if(!1===await super._preCreate(e,t,i))return!1;if("string"===foundry.utils.getType(e.content)){const t=e.content.matchAll(/\[\[[^/].*?]{2,3}/g);let i=e.content;for(const[e]of t)i=i.replace(e,await TextEditor$1.enrichHTML(e,{documents:!1,secrets:!1,links:!1,rolls:!0,rollData:this.getRollData()}));this.updateSource({content:i})}this.isRoll&&("sound"in e||this.updateSource({sound:g.sounds.dice}),!t.rollMode&&e.whisper?.length>0||this.applyRollMode(t.rollMode||"roll"))}_onCreate(e,t,i){super._onCreate(e,t,i),ui.chat.postOne(this,{notify:!0}),t.chatBubble&&canvas.ready&&c.messages.sayBubble(this)}_onUpdate(e,t,i){this.visible?ui.chat.updateMessage(this):ui.chat.deleteMessage(this.id),super._onUpdate(e,t,i)}_onDelete(e,t){ui.chat.deleteMessage(this.id,e),super._onDelete(e,t)}export(){let e=[];if(this.content){const t=$("<article>").html(this.content.replace(/<\/div>/g,"</div>|n"));e=(t.length?t.text():this.content).replace(/\n/g,"").split("  ").filter((e=>""!==e)).join(" ").split("|n").map((e=>e.trim()))}for(const t of this.rolls)e.push(`${t.formula} = ${t.result} = ${t.total}`);return`[${new Date(this.timestamp).toLocaleDateString("en-US",{hour:"numeric",minute:"numeric",second:"numeric"})}] ${this.alias}\n${e.filterJoin("\n")}`}}class Combat extends(ClientDocumentMixin(foundry.documents.BaseCombat)){turns=this.turns||[];current=this._getCurrentState();previous=void 0;static CONFIG_SETTING="combatTrackerConfig";get combatant(){return this.turns[this.turn]}get nextCombatant(){return this.turn===this.turns.length-1?this.turns[0]:this.turns[this.turn+1]}get settings(){return CombatEncounters.settings}get started(){return this.round>0}get visible(){return!0}get isActive(){return this.scene?this.scene.isView&&this.active:this.active}async activate(e){const t=this.collection.reduce(((e,t)=>(t.isActive&&e.push({_id:t.id,active:!1}),e)),[]);return t.push({_id:this.id,active:!0}),this.constructor.updateDocuments(t,e)}prepareDerivedData(){this.combatants.size&&!this.turns?.length&&this.setupTurns()}getCombatantsByToken(e){const t=e instanceof TokenDocument?e.id:e;return this.combatants.filter((e=>e.tokenId===t))}getCombatantsByActor(e){const t=e instanceof Actor;if(t&&e.isToken)return this.getCombatantsByToken(e.token);const i=t?e.id:e;return this.combatants.filter((e=>e.actorId===i))}async startCombat(){this._playCombatSound("startEncounter");const e={round:1,turn:0};return Hooks$1.callAll("combatStart",this,e),this.update(e)}async nextRound(){let e=null===this.turn?null:0;this.settings.skipDefeated&&null!==e&&(e=this.turns.findIndex((e=>!e.isDefeated)),-1===e&&(ui.notifications.warn("COMBAT.NoneRemaining",{localize:!0}),e=0));let t=Math.max(this.turns.length-this.turn,0)*g.time.turnTime;t+=g.time.roundTime;const i={round:this.round+1,turn:e},n={direction:1,worldTime:{delta:t}};return Hooks$1.callAll("combatRound",this,i,n),this.update(i,n)}async previousRound(){let e=0===this.round?0:Math.max(this.turns.length-1,0);null===this.turn&&(e=null);let t=Math.max(this.round-1,0);0===t&&(e=null);let i=-1*(this.turn||0)*g.time.turnTime;t>0&&(i-=g.time.roundTime);const n={round:t,turn:e},s={direction:-1,worldTime:{delta:i}};return Hooks$1.callAll("combatRound",this,n,s),this.update(n,s)}async nextTurn(){let e=this.turn??-1,t=null;if(this.settings.skipDefeated){for(let[i,n]of this.turns.entries())if(!(i<=e||n.isDefeated)){t=i;break}}else t=e+1;let i=this.round;if(0===this.round||null===t||t>=this.turns.length)return this.nextRound();const n={round:i,turn:t},s={direction:1,worldTime:{delta:g.time.turnTime}};return Hooks$1.callAll("combatTurn",this,n,s),this.update(n,s)}async previousTurn(){if(0===this.turn&&0===this.round)return this;if(this.turn<=0&&null!==this.turn)return this.previousRound();let e=(this.turn??this.turns.length)-1;const t={round:this.round,turn:e},i={direction:-1,worldTime:{delta:-1*g.time.turnTime}};return Hooks$1.callAll("combatTurn",this,t,i),this.update(t,i)}async endCombat(){return Dialog.confirm({title:c.i18n.localize("COMBAT.EndTitle"),content:`<p>${c.i18n.localize("COMBAT.EndConfirmation")}</p>`,yes:()=>this.delete()})}async toggleSceneLink(){const e=this.scene?null:c.scenes.current?.id||null;return null!==e&&this.combatants.some((t=>t.sceneId&&t.sceneId!==e))?(ui.notifications.error("COMBAT.CannotLinkToScene",{localize:!0}),this):this.update({scene:e})}async resetAll(){for(let e of this.combatants)e.updateSource({initiative:null});return this.update({turn:this.started?0:null,combatants:this.combatants.toObject()},{diff:!1})}async rollInitiative(e,{formula:t=null,updateTurn:i=!0,messageOptions:n={}}={}){e="string"==typeof e?[e]:e;const s=this.combatant?.id,o=c.settings.get("core","rollMode"),r=[],a=[];for(let[i,s]of e.entries()){const e=this.combatants.get(s);if(!e?.isOwner)continue;const l=e.getInitiativeRoll(t);await l.evaluate(),r.push({_id:s,initiative:l.total});let d=foundry.utils.mergeObject({speaker:ChatMessage.getSpeaker({actor:e.actor,token:e.token,alias:e.name}),flavor:c.i18n.format("COMBAT.RollsInitiative",{name:e.name}),flags:{"core.initiativeRoll":!0}},n);const u=await l.toMessage(d,{create:!1});u.rollMode="rollMode"in n?n.rollMode:e.hidden?CONST.DICE_ROLL_MODES.PRIVATE:o,i>0&&(u.sound=null),a.push(u)}return r.length?(await this.updateEmbeddedDocuments("Combatant",r),i&&s&&await this.update({turn:this.turns.findIndex((e=>e.id===s))}),await ChatMessage.implementation.create(a),this):this}async rollAll(e){const t=this.combatants.reduce(((e,t)=>(t.isOwner&&null===t.initiative&&e.push(t.id),e)),[]);return this.rollInitiative(t,e)}async rollNPC(e={}){const t=this.combatants.reduce(((e,t)=>(t.isOwner&&t.isNPC&&null===t.initiative&&e.push(t.id),e)),[]);return this.rollInitiative(t,e)}async setInitiative(e,t){const i=this.combatants.get(e,{strict:!0});await i.update({initiative:t})}setupTurns(){this.turns||=[];const e=this.combatants.contents.sort(this._sortCombatants);null!==this.turn&&(this.turn=Math.clamp(this.turn,0,e.length-1));let t=e[this.turn];return this.current=this._getCurrentState(t),this.previous||(this.previous=this.current),this.turns=e}debounceSetup=foundry.utils.debounce((()=>{this.current.round=this.round,this.current.turn=this.turn,this.setupTurns(),ui.combat.viewed===this&&ui.combat.render()}),50);updateCombatantActors(){for(const e of this.combatants)e.actor?.render(!1,{renderContext:"updateCombat"})}_playCombatSound(e){if(!CONST.COMBAT_ANNOUNCEMENTS.includes(e))throw new Error(`"${e}" is not a valid Combat announcement type`);const t=g.Combat.sounds[c.settings.get("core","combatTheme")];if(!t||"none"===t)return;const i=t[e];if(!i)return;const n=i[Math.floor(Math.random()*i.length)];c.audio.play(n,{context:c.audio.interface})}_sortCombatants(e,t){const i=Number.isNumeric(e.initiative)?e.initiative:-1/0;return(Number.isNumeric(t.initiative)?t.initiative:-1/0)-i||(e.id>t.id?1:-1)}_refreshTokenHUD(e){e.some((e=>e.token?.object?.hasActiveHUD))&&canvas.tokens.hud.render()}_onCreate(e,t,i){super._onCreate(e,t,i),!this.collection.viewed&&this.collection.combats.includes(this)&&ui.combat.initialize({combat:this,render:!1}),this._manageTurnEvents()}_onUpdate(e,t,i){super._onUpdate(e,t,i);const n=foundry.utils.deepClone(this.current);this.previous||(this.previous=n),"combatants"in e?this.setupTurns():this.current=this._getCurrentState();if(this.#Oe(n)&&!1!==t.turnEvents&&this._manageTurnEvents(),this.updateCombatantActors(),!0===e.active&&this.isActive?ui.combat.initialize({combat:this}):"scene"in e&&ui.combat.initialize(),this.active&&this.started&&n.round){const play=e=>e&&(c.user.isGM?!e.hasPlayerOwner:e.isOwner);play(this.combatant)?this._playCombatSound("yourTurn"):play(this.nextCombatant)&&this._playCombatSound("nextUp")}}_onDelete(e,t){super._onDelete(e,t),this.collection.viewed===this&&ui.combat.initialize(),t===c.userId&&this.collection.viewed?.activate()}_onCreateDescendantDocuments(e,t,i,n,s,o){super._onCreateDescendantDocuments(e,t,i,n,s,o),this.#xe(e,i,s)}_onUpdateDescendantDocuments(e,t,i,n,s,o){super._onUpdateDescendantDocuments(e,t,i,n,s,o),this.#xe(e,i,s)}_onDeleteDescendantDocuments(e,t,i,n,s,o){super._onDeleteDescendantDocuments(e,t,i,n,s,o),this.#xe(e,i,s)}#xe(e,t,i){const{combatTurn:n,turnEvents:s,render:o}=i;e===this&&this._refreshTokenHUD(t);const r=foundry.utils.deepClone(this.current);"number"==typeof n&&this.updateSource({turn:n}),this.setupTurns();this.#Oe(r)&&!1!==s&&this._manageTurnEvents(),ui.combat.viewed===e&&!1!==o&&ui.combat.render()}_getCurrentState(e){return e||=this.combatant,{round:this.round,turn:this.turn??null,combatantId:e?.id||null,tokenId:e?.tokenId||null}}#Oe(e){const{round:t,combatantId:i}=this.current,n=i!==e.combatantId||t!==e.round;return Object.assign(this.previous,e),n}async _manageTurnEvents(){if(this.started){if(c.users.activeGM?.isSelf){const e=this.current.round>(this.previous.round??-1),t=e||this.current.turn>(this.previous.turn??-1),i=this.current.combatantId!==this.previous.combatantId;if(!(t||e||i))return;const n=this.combatants.get(this.previous.combatantId);(t||i)&&n&&await this._onEndTurn(n),e&&this.previous.round&&await this._onEndRound(),e&&await this._onStartRound();const s=this.combatant;(t||i)&&s&&await this._onStartTurn(this.combatant)}Hooks$1.callAll("combatTurnChange",this,this.previous,this.current)}}async _onEndTurn(e){g.debug.combat&&console.debug(`${l} | Combat End Turn: ${this.combatants.get(this.previous.combatantId).name}`),this.#Ne(CONST.REGION_EVENTS.TOKEN_TURN_END,[e])}async _onEndRound(){g.debug.combat&&console.debug(`${l} | Combat End Round: ${this.previous.round}`),this.#Ne(CONST.REGION_EVENTS.TOKEN_ROUND_END,this.combatants)}async _onStartRound(){g.debug.combat&&console.debug(`${l} | Combat Start Round: ${this.round}`),this.#Ne(CONST.REGION_EVENTS.TOKEN_ROUND_START,this.combatants)}async _onStartTurn(e){g.debug.combat&&console.debug(`${l} | Combat Start Turn: ${this.combatant.name}`),this.#Ne(CONST.REGION_EVENTS.TOKEN_TURN_START,[e])}async#Ne(e,t){const i=[];for(const n of t){const t=n.token;if(t)for(const s of t.regions)i.push(s._triggerEvent(e,{token:t,combatant:n}))}await Promise.allSettled(i)}updateEffectDurations(){return foundry.utils.logCompatibilityWarning("Combat#updateEffectDurations is renamed to Combat#updateCombatantActors",{since:11,until:13}),this.updateCombatantActors()}getCombatantByActor(e){const t=this.getCombatantsByActor(e);return t?.[0]||null}getCombatantByToken(e){const t=this.getCombatantsByToken(e);return t?.[0]||null}}class Combatant extends(ClientDocumentMixin(foundry.documents.BaseCombatant)){_videoSrc=null;resource=null;get combat(){return this.parent}get isNPC(){return!this.actor||!this.hasPlayerOwner}get permission(){return c.user.isGM?CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER:this.getUserLevel(c.user)}get visible(){return this.isOwner||!this.hidden}get actor(){return this.token?this.token.actor:c.actors.get(this.actorId)||null}get token(){const e=this.sceneId?c.scenes.get(this.sceneId):this.parent?.scene;return e?.tokens.get(this.tokenId)||null}get players(){return c.users.filter((e=>!e.isGM&&this.testUserPermission(e,"OWNER")))}get isDefeated(){return this.defeated||!!this.actor?.statuses.has(g.specialStatusEffects.DEFEATED)}testUserPermission(e,t,{exact:i=!1}={}){return!!e.isGM||(this.actor?.canUserModify(e,"update")||!1)}getInitiativeRoll(e){e=e||this._getInitiativeFormula();const t=this.actor?.getRollData()||{};return Roll.create(e,t)}async rollInitiative(e){const t=this.getInitiativeRoll(e);return await t.evaluate(),this.update({initiative:t.total})}prepareDerivedData(){this._videoSrc=VideoHelper.hasVideoExtension(this.token?.texture.src)?this.token.texture.src:null,this.img||=this._videoSrc?void 0:this.token?.texture.src||this.actor?.img,this.name||=this.token?.name||this.actor?.name||c.i18n.localize("COMBAT.UnknownCombatant"),this.updateResource()}updateResource(){return this.actor&&this.combat?this.resource=foundry.utils.getProperty(this.actor.system,this.parent.settings.resource)||null:this.resource=null}_getInitiativeFormula(){return String(g.Combat.initiative.formula||c.system.initiative)}static async _preCreateOperation(e,t,i){const n=t.parent?.combatant;if(!n)return;const s=t.parent.clone();s.updateSource({combatants:e.map((e=>e.toObject()))}),s.setupTurns(),t.combatTurn=Math.max(s.turns.findIndex((e=>e.id===n.id)),0)}static async _preUpdateOperation(e,t,i){const n=t.parent?.combatant;if(!n)return;const s=t.parent.clone();s.updateSource({combatants:t.updates}),s.setupTurns(),!1!==t.turnEvents&&(t.combatTurn=Math.max(s.turns.findIndex((e=>e.id===n.id)),0))}static async _preDeleteOperation(e,t,i){const n=t.parent?.combatant;if(!n)return;const s=t.parent.clone();for(const e of t.ids)s.combatants.delete(e);if(s.setupTurns(),t.ids.includes(n?.id)){const{prevSurvivor:e,nextSurvivor:i}=t.parent.turns.reduce(((e,i,n)=>{let o=!t.ids.includes(i.id);return s.settings.skipDefeated&&(o&&=!i.isDefeated),o?(n<this.turn&&(e.prevSurvivor=i),!e.nextSurvivor&&n>=this.turn&&(e.nextSurvivor=i),e):e}),{}),n=i||e;n&&(t.combatTurn=s.turns.findIndex((e=>e.id===n.id)))}else t.combatTurn=Math.max(s.turns.findIndex((e=>e.id===n.id)),0)}}class DrawingDocument extends(CanvasDocumentMixin(foundry.documents.BaseDrawing)){get isAuthor(){return c.user===this.author}}class FogExploration extends(ClientDocumentMixin(foundry.documents.BaseFogExploration)){static async load({scene:e,user:t}={},i={}){const n=c.collections.get("FogExploration"),s=(e||canvas.scene)?.id||null,o=(t||c.user)?.id;if(!s||!o)return null;if(!c.user.isGM&&o!==c.user.id)throw new Error("You do not have permission to access the FogExploration object of another user");let r=n.find((e=>e.user===o&&e.scene===s));if(r)return r;const a={scene:s,user:o},l=await this.database.get(this,{query:a,...i});return r=l.length?l.shift():null,r&&n.set(r.id,r),r}getTexture(){if(!this.explored)return null;const e=new PIXI.BaseTexture(this.explored);return new PIXI.Texture(e)}_onCreate(e,t,i){super._onCreate(e,t,i),!1!==t.loadFog&&this.user===c.user&&this.scene===canvas.scene&&canvas.fog.load()}_onUpdate(e,t,i){super._onUpdate(e,t,i),!1!==t.loadFog&&this.user===c.user&&this.scene===canvas.scene&&canvas.fog.load()}_onDelete(e,t){super._onDelete(e,t),!1!==e.loadFog&&this.user===c.user&&this.scene===canvas.scene&&canvas.fog.load()}explore(e,t=!1){return foundry.utils.logCompatibilityWarning("explore is obsolete and always returns true. The fog exploration does not record position anymore.",{since:11,until:13}),!0}static get(...e){return"object"==typeof e[0]?(foundry.utils.logCompatibilityWarning("You are calling FogExploration.get by passing an object. This means you are probably trying to load Fog of War exploration data, an operation which has been renamed to FogExploration.load",{since:12,until:14}),this.load(...e)):super.get(...e)}}class Folder extends(ClientDocumentMixin(foundry.documents.BaseFolder)){depth;children;displayed=!1;get contents(){return this.#Ae?this.#Ae:this.pack?c.packs.get(this.pack).index.filter((e=>e.folder===this.id)):this.documentCollection?.filter((e=>e.folder===this))??[]}set contents(e){this.#Ae=e}#Ae;get documentClass(){return g[this.type].documentClass}get documentCollection(){return this.pack?c.packs.get(this.pack).index:c.collections.get(this.type)}get expanded(){return c.folders._expanded[this.uuid]||!1}get ancestors(){return this.folder?[this.folder,...this.folder.ancestors]:[]}async _preCreate(e,t,i){if(e.folder){const t=(e.pack?c.packs.get(e.pack).folders:c.folders).get(e.folder);if(!t)return;const i=e.pack?CONST.FOLDER_MAX_DEPTH-1:CONST.FOLDER_MAX_DEPTH;if(t.ancestors.length+1>=i)throw new Error(c.i18n.format("FOLDER.ExceededMaxDepth",{depth:i}))}return super._preCreate(e,t,i)}static async createDialog(e={},t={}){const i=new Folder.implementation(foundry.utils.mergeObject({name:Folder.implementation.defaultName({pack:t.pack}),sorting:"a"},e),{pack:t.pack});return new Promise((e=>{t.resolve=e,new FolderConfig(i,t).render(!0)}))}async exportToCompendium(e,t={}){const i=t.updateByName??!1,n=await e.getIndex();ui.notifications.info(c.i18n.format("FOLDER.Exporting",{type:c.i18n.localize(getDocumentClass(this.type).metadata.labelPlural),compendium:e.collection})),t.folder||=null;const s=[],o=[],r=[],a=[],l=this.ancestors.length,d=t.folder?(e.folders.get(t.folder)?.ancestors.length??0)+1:0,_extractFolder=async(c,u=0)=>{const h=c.toCompendium(e,{...t,clearSort:!1,keepId:!0});if(t.keepFolders){if(u+d-l>e.maxFolderDepth)throw new Error(`Folder "${c.name}" exceeds maximum allowed folder depth of ${e.maxFolderDepth}`);if(h.folder===this.id&&(h.folder=t.folder),c!==this){const t=i?e.folders.find((e=>e.name===c.name)):e.folders.get(c.id);t?(h._id=t._id,o.push(h)):s.push(h)}}for(let s of c.contents){const o=s.toCompendium(e,t);if(o.folder===this.id?o.folder=t.folder:o.folder=t.keepFolders?h._id:t.folder,s instanceof Scene){const{thumb:e}=await s.createThumbnail({img:o.background.src});o.thumb=e}const l=i?n.find((e=>e.name===o.name)):n.find((e=>e._id===o._id));l?(o._id=l._id,a.push(o)):r.push(o),console.log(`Prepared "${o.name}" for export to "${e.collection}"`)}for(let e of c.children)await _extractFolder(e.folder,u+1)};try{await _extractFolder(this,0)}catch(t){const i=`Cannot export Folder "${this.name}" to Compendium pack "${e.collection}":\n${t.message}`;return ui.notifications.error(i,{console:!0})}o.length&&await this.constructor.updateDocuments(o,{pack:e.collection,diff:!1,recursive:!1,render:!1}),s.length&&await this.constructor.createDocuments(s,{pack:e.collection,keepId:!0,render:!1});const u=e.documentClass;return a.length&&await u.updateDocuments(a,{pack:e.collection,diff:!1,recursive:!1,render:!1}),r.length&&await u.createDocuments(r,{pack:e.collection,keepId:t.keepId,render:!1}),ui.notifications.info(c.i18n.format("FOLDER.ExportDone",{type:c.i18n.localize(getDocumentClass(this.type).metadata.labelPlural),compendium:e.collection})),e.render(!1),e}async exportDialog(e,t={}){const i=c.packs.filter((e=>e.documentName===this.type&&!e.locked));if(!i.length)return ui.notifications.warn(c.i18n.format("FOLDER.ExportWarningNone",{type:c.i18n.localize(getDocumentClass(this.type).metadata.label)}));const n=await renderTemplate("templates/sidebar/apps/folder-export.html",{packs:i.reduce(((e,t)=>(e[t.collection]=t.title,e)),{}),pack:t.pack??null,merge:t.merge??!0,keepId:t.keepId??!0,keepFolders:t.keepFolders??!0,hasFolders:t.pack?.folders?.length??!1,folders:t.pack?.folders?.map((e=>({id:e.id,name:e.name})))||[]});return FolderExport.prompt({title:`${c.i18n.localize("FOLDER.ExportTitle")}: ${this.name}`,content:n,label:c.i18n.localize("FOLDER.ExportTitle"),callback:e=>{const t=e[0].querySelector("form"),i=c.packs.get(t.pack.value);return this.exportToCompendium(i,{updateByName:t.merge.checked,keepId:t.keepId.checked,keepFolders:t.keepFolders.checked,folder:t.folder.value})},rejectClose:!1,options:t})}getSubfolders(e=!1){let t=c.folders.filter((e=>e._source.folder===this.id));if(e&&t.length)for(let e of t){const i=e.getSubfolders(!0);t=t.concat(i)}return t}getParentFolders(){let e=[],t=this.folder;for(;t;)e.push(t),t=t.folder;return e}}class Item extends(ClientDocumentMixin(foundry.documents.BaseItem)){get actor(){return this.parent instanceof Actor?this.parent:null}get thumbnail(){return this.img}get isOwned(){return this.isEmbedded}get transferredEffects(){return this.effects.filter((e=>!0===e.transfer))}getRollData(){return this.system}async _preCreate(e,t,i){if(this.parent instanceof Actor&&!g.ActiveEffect.legacyTransferral)for(const e of this.effects)e.transfer&&e.updateSource(ActiveEffect.implementation.getInitialDuration());return super._preCreate(e,t,i)}static async _onCreateOperation(e,t,i){if(!(t.parent instanceof Actor&&g.ActiveEffect.legacyTransferral&&i.isSelf))return;const n=getDocumentClass("ActiveEffect"),s=[];for(let t of e)for(let e of t.effects){if(!e.transfer)continue;const i=e.toJSON();i.origin=t.uuid,s.push(i)}delete(t={...t}).data,t.renderSheet=!1,n.createDocuments(s,t)}static async _onDeleteOperation(e,t,i){const n=t.parent,s=getDocumentClass("ActiveEffect");if(!(n instanceof Actor&&g.ActiveEffect.legacyTransferral&&i.isSelf))return;const o=new Set(e.map((e=>n.isToken?e.uuid.split(".").slice(-2).join("."):e.uuid))),r=[];for(const e of n.effects){let t=e.origin||"";n.isToken&&(t=t.split(".").slice(-2).join(".")),o.has(t)&&r.push(e.id)}delete(t={...t}).ids,delete t.deleteAll,s.deleteDocuments(r,t)}}class JournalEntryPage extends(ClientDocumentMixin(foundry.documents.BaseJournalEntryPage)){_toc;get toc(){if("text"!==this.type)return{};if(this._toc)return this._toc;const e=document.createElement("template");return e.innerHTML=this.text.content,this._toc=this.constructor.buildTOC(Array.from(e.content.children),{includeElement:!1}),this._toc}get permission(){return c.user.isGM?CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER:this.getUserLevel(c.user)}get sceneNote(){return canvas.ready&&canvas.notes.placeables.find((e=>e.document.entryId===this.parent.id&&e.document.pageId===this.id))||null}static slugifyHeading(e){return e instanceof HTMLElement&&(e=e.textContent),e.slugify().replace(/["']/g,"").substring(0,64)}static buildTOC(e,{includeElement:t=!0}={}){const i={level:0,children:[]},n=[i],searchHeadings=e=>{if(e instanceof HTMLHeadingElement){const i=this._makeHeadingNode(e,{includeElement:t});let s=n.at(-1);i.level<=s.level&&(n.pop(),s=n.at(-1)),s.children.push(i),n.push(i)}for(const t of e.children||[])searchHeadings(t)};return e.forEach(searchHeadings),this._flattenTOC(i.children)}static _flattenTOC(e){let t=0;const i={},flattenNode=e=>{const n=(e=>{if(i[e.slug]){let t=1;for(;i[`${e.slug}$${t}`];)t++;e.slug=`${e.slug}$${t}`}return e.order=t++,i[e.slug]=e,e.slug})(e);for(;e.children.length&&"string"!=typeof e.children[0];){const t=e.children.shift();e.children.push(flattenNode(t))}return n};return e.forEach(flattenNode),i}static _makeHeadingNode(e,{includeElement:t=!0}={}){const i={text:e.innerText,level:Number(e.tagName[1]),slug:e.id||this.slugifyHeading(e),children:[]};return t&&(i.element=e),i}_createDocumentLink(e,{relativeTo:t,label:i}={}){const n=t?this.getRelativeUUID(t):this.uuid;return e.anchor?.slug?(i??=e.anchor.name,`@UUID[${n}#${e.anchor.slug}]{${i}}`):super._createDocumentLink(e,{relativeTo:t,label:i})}_onClickDocumentLink(e){const t=e.currentTarget;return this.parent.sheet.render(!0,{pageId:this.id,anchor:t.dataset.hash})}_onUpdate(e,t,i){super._onUpdate(e,t,i),"text.content"in foundry.utils.flattenObject(e)&&(this._toc=null),canvas.ready&&["name","ownership"].some((t=>t in e))&&canvas.notes.placeables.filter((e=>e.page===this)).forEach((e=>e.draw()))}async _buildEmbedHTML(e,t={}){const i=await super._buildEmbedHTML(e,t);if(!i){if("text"===this.type)return this._embedTextPage(e,t);if("image"===this.type)return this._embedImagePage(e,t)}return i}async _createFigureEmbed(e,t,i){const n=await super._createFigureEmbed(e,t,i);if("image"===this.type&&t.caption&&!t.label&&this.image.caption){const e=n.querySelector("figcaption > .embed-caption");e&&(e.innerText=this.image.caption)}return n}async _embedTextPage(e,t={}){t={...t,relativeTo:this};const{secrets:i=t.secrets,documents:n=t.documents,links:s=t.links,rolls:o=t.rolls,embeds:r=t.embeds}=e;foundry.utils.mergeObject(t,{secrets:i,documents:n,links:s,rolls:o,embeds:r});const a=await TextEditor$1.enrichHTML(this.text.content,t),l=document.createElement("div");return l.innerHTML=a,l.children}async _embedImagePage({alt:e,label:t},i={}){const n=document.createElement("img");return n.src=this.src,n.alt=e||t||this.image.caption||this.name,n}}class JournalEntry extends(ClientDocumentMixin(foundry.documents.BaseJournalEntry)){get visible(){return this.testUserPermission(c.user,"OBSERVER")}getUserLevel(e){return this.pack&&this.compendium.getUserLevel(e)===CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED?CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER:super.getUserLevel(e)}get sceneNote(){return canvas.ready&&canvas.notes.placeables.find((e=>e.document.entryId===this.id))||null}async show(e=!1){return Journal.show(this,{force:e})}panToNote(e={}){return canvas.notes.panToNote(this.sceneNote,e)}_onUpdate(e,t,i){super._onUpdate(e,t,i),canvas.ready&&["name","ownership"].some((t=>t in e))&&canvas.notes.placeables.filter((e=>e.document.entryId===this.id)).forEach((e=>e.draw()))}_onDelete(e,t){if(super._onDelete(e,t),canvas.ready)for(let e of canvas.notes.placeables)e.document.entryId===this.id&&e.draw()}}class Macro extends(ClientDocumentMixin(foundry.documents.BaseMacro)){get isAuthor(){return c.user===this.author}get canExecute(){return this.canUserExecute(c.user)}get thumbnail(){return this.img}canUserExecute(e){return!!this.testUserPermission(e,"LIMITED")&&("script"!==this.type||e.can("MACRO_SCRIPT"))}execute(e={}){if(this.canExecute)switch(this.type){case"chat":return this.#Re(e.speaker);case"script":if("Object"!==foundry.utils.getType(e))throw new Error("Invalid scope parameter passed to Macro#execute which must be an object");return this.#Pe(e)}else ui.notifications.warn(`You do not have permission to execute Macro "${this.name}".`)}#Re(e){return ui.chat.processMessage(this.command,{speaker:e}).catch((e=>{Hooks$1.onError("Macro#_executeChat",e,{msg:"There was an error in your chat message syntax.",log:"error",notify:"error",command:this.command})}))}#Pe({speaker:e,actor:t,token:i,...n}={}){e=e||ChatMessage.implementation.getSpeaker({actor:t,token:i});const s=c.user.character;i=i||(canvas.ready?canvas.tokens.get(e.token):null)||null,t=t||i?.actor||c.actors.get(e.actor)||null;const o=Object.keys(n);if(o.some((e=>Number.isNumeric(e))))throw new Error("Illegal numeric Macro parameter passed to execution scope.");const r=Object.values(n),a=new foundry.utils.AsyncFunction("speaker","actor","token","character","scope",...o,`{${this.command}\n}`);try{return a.call(this,e,t,i,s,n,...r)}catch(e){ui.notifications.error("MACRO.Error",{localize:!0})}}_onClickDocumentLink(e){return this.execute({event:e})}}class MeasuredTemplateDocument extends(CanvasDocumentMixin(foundry.documents.BaseMeasuredTemplate)){get rotation(){return this.direction}get isAuthor(){return c.user===this.author}}class NoteDocument extends(CanvasDocumentMixin(foundry.documents.BaseNote)){get entry(){return c.journal.get(this.entryId)}get page(){return this.entry?.pages.get(this.pageId)}get label(){return this.text||this.page?.name||this.entry?.name||c?.i18n?.localize("NOTE.Unknown")||"Unknown"}}class PlaylistSound extends(ClientDocumentMixin(foundry.documents.BasePlaylistSound)){static VOLUME_DEBOUNCE_MS=100;sound;debounceVolume=foundry.utils.debounce((e=>{this.update({volume:e},{diff:!1,render:!1})}),PlaylistSound.VOLUME_DEBOUNCE_MS);_createSound(){if(c.audio.locked)throw new Error("You may not call PlaylistSound#_createSound until after game audio is unlocked.");if(!this.id||!this.path)return null;const e=c.audio.create({src:this.path,context:this.context,singleton:!1});return e.addEventListener("play",this._onStart.bind(this)),e.addEventListener("end",this._onEnd.bind(this)),e.addEventListener("stop",this._onStop.bind(this)),e}get fadeDuration(){if(!this.sound.duration)return 0;const e=1e3*Math.ceil(this.sound.duration/2);return Math.clamp(this.fade??this.parent.fade??0,0,e)}get context(){const e=(this.channel||this.parent.channel)??"music";return c.audio[e]}sync(){if(!this.playing)return void(this.sound?.playing&&this.sound.stop({fade:this.pausedTime?0:this.fadeDuration,volume:0}));this.sound||=this._createSound();const e=this.sound;return e&&!e.failed?e.playing?(e.loop=this.repeat,void e.fade(this.volume,{duration:500})):void e.load({autoplay:!0,autoplayOptions:{loop:this.repeat,volume:this.volume,fade:this.fade,offset:this.pausedTime&&!e.playing?this.pausedTime:void 0}}):void 0}async load(){this.sound||=this._createSound(),await this.sound.load()}toAnchor({classes:e=[],...t}={}){return this.playing&&e.push("playing"),this.isOwner||e.push("disabled"),super.toAnchor({classes:e,...t})}_onClickDocumentLink(e){return this.playing?this.parent.stopSound(this):this.parent.playSound(this)}_onCreate(e,t,i){super._onCreate(e,t,i),this.parent&&(this.parent._playbackOrder=void 0)}_onUpdate(e,t,i){super._onUpdate(e,t,i),"path"in e&&(this.sound&&this.sound.stop(),this.sound=this._createSound()),"sort"in e&&this.parent&&(this.parent._playbackOrder=void 0),this.sync()}_onDelete(e,t){super._onDelete(e,t),this.parent&&(this.parent._playbackOrder=void 0),this.playing=!1,this.sync()}async _onStart(){if(!this.playing)return this.sound.stop();const{volume:e,fadeDuration:t}=this;if(t&&this.sound.fade(e,{duration:t}),!this.repeat&&Number.isFinite(this.sound.duration)){const e=this.sound.duration-t/1e3,fadeOut=()=>this.sound.fade(0,{duration:t});this.sound.schedule(fadeOut,e)}return this.parent._onSoundStart(this)}async _onEnd(){if(this.parent.isOwner)return this.parent._onSoundEnd(this)}async _onStop(){}get effectiveVolume(){return foundry.utils.logCompatibilityWarning("PlaylistSound#effectiveVolume is deprecated in favor of using PlaylistSound#volume directly",{since:12,until:14}),this.volume}}class Playlist extends(ClientDocumentMixin(foundry.documents.BasePlaylist)){_playbackOrder;get playbackOrder(){if(void 0!==this._playbackOrder)return this._playbackOrder;if(this.mode===CONST.PLAYLIST_MODES.SHUFFLE){let e=this.sounds.map((e=>e.id));const t=new foundry.dice.MersenneTwister(this.seed??0);let i=e.reduce(((e,i)=>(e[i]=t.random(),e)),{});return e.sort(((e,t)=>i[e]-i[t])),this._playbackOrder=e}{const e=this.sounds.contents.sort(this._sortSounds.bind(this));return this._playbackOrder=e.map((e=>e.id))}}get visible(){return this.isOwner||this.playing}static _getSoundContentLinks(e){return document.querySelectorAll(`a[data-link][data-uuid="${e.uuid}"]`)}prepareDerivedData(){this.playing=this.sounds.some((e=>e.playing))}async playAll(){if(0===this.sounds.size)return this;const e={playing:!0},t=this.playbackOrder;switch(this.mode){case CONST.PLAYLIST_MODES.DISABLED:e.playing=!1;break;case CONST.PLAYLIST_MODES.SEQUENTIAL:case CONST.PLAYLIST_MODES.SHUFFLE:const i=this.sounds.find((e=>e.pausedTime)),n=i?.id||t[0];e.sounds=this.sounds.map((e=>({_id:e.id,playing:e.id===n})));break;case CONST.PLAYLIST_MODES.SIMULTANEOUS:e.sounds=this.sounds.map((e=>({_id:e.id,playing:!0})))}return this.update(e)}async playNext(e,{direction:t=1}={}){if(![CONST.PLAYLIST_MODES.SEQUENTIAL,CONST.PLAYLIST_MODES.SHUFFLE].includes(this.mode))return null;if(!e){const t=this.sounds.find((e=>e.playing));e=t?.id||null}let i=1===t?this._getNextSound(e):this._getPreviousSound(e);this.playing||(i=null);const n=this.sounds.map((e=>({_id:e.id,playing:e.id===i?.id,pausedTime:null})));return this.update({sounds:n})}async playSound(e){const t={playing:!0};switch(this.mode){case CONST.PLAYLIST_MODES.SEQUENTIAL:case CONST.PLAYLIST_MODES.SHUFFLE:t.sounds=this.sounds.map((t=>{let i=t.id===e.id;return{_id:t.id,playing:i,pausedTime:i?t.pausedTime:null}}));break;default:t.sounds=[{_id:e.id,playing:!0}]}return this.update(t)}async stopSound(e){return this.update({playing:this.sounds.some((t=>t.id!==e.id&&t.playing)),sounds:[{_id:e.id,playing:!1,pausedTime:null}]})}async stopAll(){return this.update({playing:!1,sounds:this.sounds.map((e=>({_id:e.id,playing:!1})))})}async cycleMode(){const e=Object.values(CONST.PLAYLIST_MODES);let t=this.mode+1;t=t>Math.max(...e)?e[0]:t;for(let e of this.sounds)e.playing=!1;return this.update({sounds:this.sounds.toJSON(),mode:t})}_getNextSound(e){const t=this.playbackOrder;let i=t.indexOf(e);return i===t.length-1&&(i=-1),this.sounds.get(t[i+1])}_getPreviousSound(e){const t=this.playbackOrder;let i=t.indexOf(e);return-1===i?i=1:0===i&&(i=t.length),this.sounds.get(t[i-1])}_sortSounds(e,t){switch(this.sorting){case CONST.PLAYLIST_SORT_MODES.ALPHABETICAL:return e.name.compare(t.name);case CONST.PLAYLIST_SORT_MODES.MANUAL:return e.sort-t.sort}}toAnchor({classes:e=[],...t}={}){return this.playing&&e.push("playing"),this.isOwner||e.push("disabled"),super.toAnchor({classes:e,...t})}_onClickDocumentLink(e){return this.playing?this.stopAll():this.playAll()}async _preUpdate(e,t,i){return!("mode"in e)&&!("playing"in e)||"seed"in e||(e.seed=Math.floor(1e3*Math.random())),super._preUpdate(e,t,i)}_onUpdate(e,t,i){super._onUpdate(e,t,i),("seed"in e||"mode"in e||"sorting"in e)&&(this._playbackOrder=void 0),"sounds"in e&&!c.audio.locked&&this.sounds.forEach((e=>e.sync())),this.#ke(e)}_onDelete(e,t){super._onDelete(e,t),this.sounds.forEach((e=>e.sound?.stop()))}_onCreateDescendantDocuments(e,t,i,n,s,o){super._onCreateDescendantDocuments(e,t,i,n,s,o),!1!==s.render&&this.collection.render()}_onUpdateDescendantDocuments(e,t,i,n,s,o){super._onUpdateDescendantDocuments(e,t,i,n,s,o),!1!==s.render&&this.collection.render()}_onDeleteDescendantDocuments(e,t,i,n,s,o){super._onDeleteDescendantDocuments(e,t,i,n,s,o),!1!==s.render&&this.collection.render()}async _onSoundEnd(e){switch(this.mode){case CONST.PLAYLIST_MODES.SEQUENTIAL:case CONST.PLAYLIST_MODES.SHUFFLE:return this.playNext(e.id);case CONST.PLAYLIST_MODES.SIMULTANEOUS:case CONST.PLAYLIST_MODES.DISABLED:const t={playing:!0,sounds:[{_id:e.id,playing:!1,pausedTime:null}]};for(let i of this.sounds){if(i!==e&&i.playing)break;t.playing=!1}return this.update(t)}}async _onSoundStart(e){if(![CONST.PLAYLIST_MODES.SEQUENTIAL,CONST.PLAYLIST_MODES.SHUFFLE].includes(this.mode))return;const t=g.Playlist.autoPreloadSeconds;Number.isNumeric(t)&&Number.isFinite(e.sound.duration)&&setTimeout((()=>{if(!e.playing)return;const t=this._getNextSound(e.id);t?.load()}),1e3*(e.sound.duration-t))}#ke(e){"playing"in e&&this.constructor._getSoundContentLinks(this).forEach((t=>t.classList.toggle("playing",e.playing))),"sounds"in e&&e.sounds.forEach((e=>{const t=this.sounds.get(e._id);"playing"in e&&t&&this.constructor._getSoundContentLinks(t).forEach((t=>t.classList.toggle("playing",e.playing)))}))}toCompendium(e,t={}){const i=super.toCompendium(e,t);if(t.clearState){i.playing=!1;for(let e of i.sounds)e.playing=!1}return i}}class RegionBehavior extends(ClientDocumentMixin(foundry.documents.BaseRegionBehavior)){get region(){return this.parent}get scene(){return this.region?.parent??null}get active(){return!this.disabled&&this.region?.behaviors.get(this.id)===this&&this.scene?.regions.get(this.region.id)===this.region}get viewed(){return this.active&&!0===this.scene?.isView}prepareBaseData(){this.name||=c.i18n.localize(g.RegionBehavior.typeLabels[this.type])}hasEvent(e){const t=this.system;return t instanceof foundry.data.regionBehaviors.RegionBehaviorType&&(e in t.constructor.events||t.events.has(e))}async _handleRegionEvent(e){const t=this.system;t instanceof foundry.data.regionBehaviors.RegionBehaviorType&&(e.name in t.constructor.events&&await t.constructor.events[e.name].call(t,e),t.events.has(e.name)&&await t._handleRegionEvent(e))}static async createDialog(e,t){return c.user.can("MACRO_SCRIPT")||(t={...t,types:(t?.types??this.TYPES).filter((e=>"executeScript"!==e))}),super.createDialog(e,t)}}class RegionDocument extends(CanvasDocumentMixin(foundry.documents.BaseRegion)){static _activateSocketListeners(e){e.on("regionEvent",this.#Me.bind(this))}static async#Me(e){const{regionUuid:t,userId:i,eventName:n,eventData:s,eventDataUuids:o}=e,r=await fromUuid(t);if(!r)return;for(const e of o){const t=foundry.utils.getProperty(s,e),i=await fromUuid(t);foundry.utils.setProperty(s,e,i)}const a={name:n,data:s,region:r,user:c.users.get(i)};await r._handleEvent(a)}static async _updateTokens(e,{deleted:t=!1,reset:i=!0}={}){if(0===e.length)return;const n=[],s=e[0].parent;for(const o of e)if(t||o.object)for(const e of s.tokens){if(!t&&!e.object)continue;!t&&i&&0!==e.object.animationContexts.size&&e.reset();!t&&e.object.testInsideRegion(o.object)?e._regions.includes(o.id)||n.push({_id:e.id,_regions:[...e._regions,o.id].sort()}):e._regions.includes(o.id)&&n.push({_id:e.id,_regions:e._regions.filter((e=>e!==o.id))})}await s.updateEmbeddedDocuments("Token",n)}static async _onCreateOperation(e,t,i){i.isSelf&&RegionDocument._updateTokens(e,{reset:!1});for(const t of e){const e={active:!0};t.parent.isView&&(e.viewed=!0),t._handleEvent({name:CONST.REGION_EVENTS.BEHAVIOR_STATUS,data:e,region:t,user:i})}}static async _onUpdateOperation(e,t,i){const n=[];for(let i=0;i<e.length;i++){const s=t.updates[i];("shapes"in s||"elevation"in s)&&n.push(e[i])}i.isSelf&&RegionDocument._updateTokens(n,{reset:!1});for(const e of n)e._handleEvent({name:CONST.REGION_EVENTS.REGION_BOUNDARY,data:{},region:e,user:i})}static async _onDeleteOperation(e,t,i){i.isSelf&&RegionDocument._updateTokens(e,{deleted:!0});const n=[];for(const t of e){for(const e of t.tokens)t.tokens.delete(e),n.push({name:CONST.REGION_EVENTS.TOKEN_EXIT,data:{token:e},region:t,user:i});t.tokens.clear()}for(const t of e){const e={active:!1};t.parent.isView&&(e.viewed=!1),n.push({name:CONST.REGION_EVENTS.BEHAVIOR_STATUS,data:e,region:t,user:i})}for(const e of n)e.region._handleEvent(e)}tokens=new Set;async _triggerEvent(e,t){t=foundry.utils.deepClone(t);const i=[],serializeDocuments=(e,t,n=t)=>{const s=e[t];if(null!==s&&"object"==typeof s)if(s.constructor&&s.constructor!==Object)if(Array.isArray(s))for(let e=0;e<s.length;e++)serializeDocuments(s,e,`${n}.${e}`);else s instanceof foundry.abstract.Document&&(e[t]=s.uuid,i.push(n));else for(const e in s)serializeDocuments(s,e,`${n}.${e}`)};for(const e in t)serializeDocuments(t,e);c.socket.emit("regionEvent",{regionUuid:this.uuid,userId:c.user.id,eventName:e,eventData:t,eventDataUuids:i})}async _handleEvent(e){const t=await Promise.allSettled(this.behaviors.filter((e=>!e.disabled)).map((t=>t._handleRegionEvent(e))));for(const e of t)"rejected"===e.status&&console.error(e.reason)}_onCreateDescendantDocuments(e,t,i,n,s,o){if(super._onCreateDescendantDocuments(e,t,i,n,s,o),"behaviors"!==t)return;const r=c.users.get(o);for(let e=0;e<i.length;e++){const t=i[e];if(t.disabled)continue;const n={active:!0};this.parent.isView&&(n.viewed=!0),t._handleRegionEvent({name:CONST.REGION_EVENTS.BEHAVIOR_STATUS,data:n,region:this,user:r});for(const e of this.tokens){!this.parent.tokens.has(e.id)||t._handleRegionEvent({name:CONST.REGION_EVENTS.TOKEN_ENTER,data:{token:e},region:this,user:r})}}}_onUpdateDescendantDocuments(e,t,i,n,s,o){if(super._onUpdateDescendantDocuments(e,t,i,n,s,o),"behaviors"!==t)return;const r=c.users.get(o);for(let e=0;e<i.length;e++){const t=n[e].disabled;if(void 0===t)continue;const s=i[e];if(t)for(const e of this.tokens)s._handleRegionEvent({name:CONST.REGION_EVENTS.TOKEN_EXIT,data:{token:e},region:this,user:r});const o={active:!t};if(this.parent.isView&&(o.viewed=!t),s._handleRegionEvent({name:CONST.REGION_EVENTS.BEHAVIOR_STATUS,data:o,region:this,user:r}),!t)for(const e of this.tokens){!this.parent.tokens.has(e.id)||s._handleRegionEvent({name:CONST.REGION_EVENTS.TOKEN_ENTER,data:{token:e},region:this,user:r})}}}_onDeleteDescendantDocuments(e,t,i,n,s,o){if(super._onDeleteDescendantDocuments(e,t,n,s,o),"behaviors"!==t)return;const r=c.users.get(o);for(let e=0;e<i.length;e++){const t=i[e];if(t.disabled)continue;for(const e of this.tokens){!this.parent.tokens.has(e.id)||t._handleRegionEvent({name:CONST.REGION_EVENTS.TOKEN_EXIT,data:{token:e},region:this,user:r})}const n={active:!1};this.parent.isView&&(n.viewed=!1),t._handleRegionEvent({name:CONST.REGION_EVENTS.BEHAVIOR_STATUS,data:n,region:this,user:r})}}}class Scene extends(ClientDocumentMixin(foundry.documents.BaseScene)){_viewPosition={};_view=this.active;grid=this.grid;dimensions=this.dimensions;get thumbnail(){return this.thumb}get isView(){return this._view}async activate(){return this.active?this:this.update({active:!0})}async view(){if(canvas.loading)return ui.notifications.warn("You cannot switch Scenes until resources finish loading for your current view.");for(let e of c.scenes)e._view=e.id===this.id;return c.settings.get("core","noCanvas")&&ui.notifications.info(c.i18n.format("INFO.SceneViewCanvasDisabled",{name:this.navName?this.navName:this.name})),canvas.initialized&&canvas.id!==this.id&&(console.log(`Foundry VTT | Viewing Scene ${this.name}`),await canvas.draw(this)),this.collection.render(),ui.combat.initialize(),this}clone(e={},t={}){return e.active=!1,e.navigation=!1,foundry.data.validators.isBase64Data(e.thumb)||delete e.thumb,t.save?this.createThumbnail().then((i=>(e.thumb=i.thumb,super.clone(e,t)))):super.clone(e,t)}reset(){this._initialize({sceneReset:!0})}toObject(e=!0){const t=super.toObject(e);return!e&&this.grid.isHexagonal&&this.flags.core?.legacyHex&&(t.grid.size=Math.round(this.grid.size*(2*Math.SQRT1_3))),t}prepareBaseData(){this.grid=Scene.#Le(this),this.dimensions=this.getDimensions(),this.playlistSound=this.playlist?this.playlist.sounds.get(this._source.playlistSound):null,this.foregroundElevation=this.foregroundElevation||4*this.grid.distance}static#Le(e){const t=e.grid;if(t instanceof foundry.grid.BaseGrid)return t;const i=CONST.GRID_TYPES,n=t.type,s={size:t.size,distance:t.distance,units:t.units,style:t.style,thickness:t.thickness,color:t.color,alpha:t.alpha};if(n===i.GRIDLESS)return new foundry.grid.GridlessGrid(s);if(n===i.SQUARE)return s.diagonals=c.settings.get("core","gridDiagonals"),new foundry.grid.SquareGrid(s);if(n.between(i.HEXODDR,i.HEXEVENQ))return s.columns=n===i.HEXODDQ||n===i.HEXEVENQ,s.even=n===i.HEXEVENR||n===i.HEXEVENQ,e.flags.core?.legacyHex&&(s.size*=Math.SQRT3/2),new foundry.grid.HexagonalGrid(s);throw new Error("Invalid grid type")}getDimensions(){const e=this.grid,t=this.width,i=this.height;let n;if(e.isHexagonal&&this.flags.core?.legacyHex){const s=Math.round(e.size*(2*Math.SQRT1_3));n=foundry.grid.HexagonalGrid._calculatePreV10Dimensions(e.columns,s,t,i,this.padding)}else n=e.calculateDimensions(t,i,this.padding);const{width:s,height:o}=n,r=n.x-this.background.offsetX,a=n.y-this.background.offsetY;return{width:s,height:o,size:e.size,rect:{x:0,y:0,width:s,height:o},sceneX:r,sceneY:a,sceneWidth:t,sceneHeight:i,sceneRect:{x:r,y:a,width:t,height:i},distance:e.distance,distancePixels:e.size/e.distance,ratio:t/i,maxR:Math.hypot(s,o),rows:n.rows,columns:n.columns}}_onClickDocumentLink(e){return this.journal?this.journal._onClickDocumentLink(e):super._onClickDocumentLink(e)}async _preCreate(e,t,i){if(!1===await super._preCreate(e,t,i))return!1;if(!("thumb"in e)&&canvas.ready&&this.background.src){const e=await this.createThumbnail({img:this.background.src});this.updateSource({thumb:e.thumb})}return this.active?c.playlists._onChangeScene(this,e):void 0}static async _preCreateOperation(e,t,i){if(!c.scenes.active){const i=e.find(((e,i)=>!("active"in t.data[i])));i?.updateSource({active:!0})}}_onCreate(e,t,i){super._onCreate(e,t,i);const n=c.users.get(i);for(const e of this.regions)e._handleEvent({name:CONST.REGION_EVENTS.BEHAVIOR_STATUS,data:{active:!0},region:e,user:n});!0===e.active&&this._onActivate(!0)}async _preUpdate(e,t,i){if(!1===await super._preUpdate(e,t,i))return!1;if(void 0!==e.environment?.darknessLevel){this.environment.darknessLock&&!1!==e.environment.darknessLock&&delete e.environment.darknessLevel}if("thumb"in e&&(t.thumb??=[],t.thumb.push(this.id)),t.autoReposition)try{e=this._repositionObjects(e)}catch(t){return delete e.width,delete e.height,delete e.padding,delete e.background,ui.notifications.error(t.message)}return"active"in e||this.active&&["playlist","playlistSound"].some((t=>t in e))?c.playlists._onChangeScene(this,e):void 0}_repositionObjects(e){const t="width"in e?e.width/this.width:1,i="height"in e?e.height/this.height:1,n=(t+i)/2,s=this.getDimensions(),o=this.clone();o.updateSource(e);const r=o.getDimensions(),a="padding"in e?(r.width-s.width)/2:0,l="padding"in e?(r.height-s.height)/2:0,d=void 0!==e.background?.offsetX?this.background.offsetX-e.background.offsetX:0,u=void 0!==e.background?.offsetY?this.background.offsetY-e.background.offsetY:0;if(this.grid.type!==CONST.GRID_TYPES.GRIDLESS&&!foundry.utils.hasProperty(e,"grid.size")){const t=Math.round(this._source.grid.size*n);if(t<CONST.GRID_MIN_SIZE)throw new Error(c.i18n.localize("SCENES.GridSizeError"));foundry.utils.setProperty(e,"grid.size",t)}function adjustPoint(e,n,s=!0){return{x:Math.round(e*t+(s?a+d:0)),y:Math.round(n*i+(s?l+u:0))}}for(let t of["tokens","lights","sounds","templates"])e[t]=this[t].map((e=>{const{x:t,y:i}=adjustPoint(e.x,e.y);return{_id:e.id,x:t,y:i}}));for(let n of["tiles"])e[n]=this[n].map((e=>{const{x:n,y:s}=adjustPoint(e.x,e.y),o=Math.round(e.width*t),r=Math.round(e.height*i);return{_id:e.id,x:n,y:s,width:o,height:r}}));return e.notes=this.notes.map((e=>{const{x:t,y:i}=adjustPoint(e.x,e.y),s=Math.max(32,Math.round(e.iconSize*n));return{_id:e.id,x:t,y:i,iconSize:s}})),e.drawings=this.drawings.map((e=>{const{x:n,y:s}=adjustPoint(e.x,e.y),o=Math.round(e.shape.width*t),r=Math.round(e.shape.height*i);let a=[];if(e.shape.points)for(let t=0;t<e.shape.points.length;t+=2){const{x:i,y:n}=adjustPoint(e.shape.points[t],e.shape.points[t+1],!1);a.push(i),a.push(n)}return{_id:e.id,x:n,y:s,"shape.width":o,"shape.height":r,"shape.points":a}})),e.walls=this.walls.map((e=>{const t=e.c,i=adjustPoint(t[0],t[1]),n=adjustPoint(t[2],t[3]);return{_id:e.id,c:[i.x,i.y,n.x,n.y]}})),e}_onUpdate(e,t,i){!("thumb"in e)&&(t.thumb??[]).includes(this.id)&&(e.thumb=this.thumb),super._onUpdate(e,t,i);const n=new Set(Object.keys(foundry.utils.flattenObject(e)).filter((e=>"_id"!==e)));if("active"in e&&this._onActivate(e.active),"thumb"in e&&this.thumb&&(this.thumb=`${this.thumb.split("?")[0]}?${Date.now()}`),c.user.id===i&&["grid.type","grid.size"].some((e=>n.has(e)))&&RegionDocument._updateTokens(this.regions.contents,{reset:!1}),canvas.scene===this){if(["foreground","fog.overlay","width","height","padding","grid.type","grid.size","grid.distance","grid.units","drawings","lights","sounds","templates","tiles","tokens","walls","weather"].some((e=>n.has(e)))||"background"in e)return canvas.draw();"grid"in e&&canvas.interface.grid.initializeMesh(this.grid);if(["globalLight","tokenVision","fog.exploration"].some((e=>n.has(e)))&&canvas.perception.initialize(),"tokenVision"in e)for(const e of canvas.tokens.placeables)e.initializeVisionSource();if(n.has("environment.darknessLevel")&&t.animateDarkness)return canvas.effects.animateDarkness(e.environment.darknessLevel,{duration:"number"==typeof t.animateDarkness?t.animateDarkness:void 0});("environment"in e||["backgroundColor","fog.colors.unexplored","fog.colors.explored"].some((e=>n.has(e))))&&canvas.environment.initialize(),["initial.x","initial.y","initial.scale","width","height"].some((e=>n.has(e)))&&(this._viewPosition={},canvas.initializeCanvasPosition());const i=this.sheet;n.has("environment.darknessLock")&&(ui.controls.rendered&&ui.controls.initialize(),i?.rendered&&i._previewScene("force"))}}async _preDelete(e,t){if(!1===await super._preDelete(e,t))return!1;this.active&&c.playlists._onChangeScene(this,{active:!1})}_onDelete(e,t){super._onDelete(e,t),canvas.scene?.id===this.id&&canvas.draw(null);for(const e of this.tokens)e.baseActor?._unregisterDependentScene(this);const i=c.users.get(t);for(const e of this.regions)e._handleEvent({name:CONST.REGION_EVENTS.BEHAVIOR_STATUS,data:{active:!1},region:e,user:i})}_onActivate(e){for(let e of c.scenes)e.active&&e!==this&&(e.updateSource({active:!1}),e._initialize());return canvas.initialized&&!e?canvas.draw(null):this.view()}_preCreateDescendantDocuments(e,t,i,n,s){if(super._preCreateDescendantDocuments(e,t,i,n,s),s===c.userId&&this.isView&&e===this&&!n.isUndo){const e=canvas.getCollectionLayer(t);e?.storeHistory("create",i.map((e=>({_id:e._id}))))}}_preUpdateDescendantDocuments(e,t,i,n,s){if(super._preUpdateDescendantDocuments(e,t,i,n,s),s===c.userId&&this.isView&&e===this&&!n.isUndo){const e=this.getEmbeddedCollection(t),n=i.reduce(((t,i)=>{const n=e.get(i._id);if(n){const e=n.toObject(),s=foundry.utils.filterObject(e,i);if("flags"in i){s.flags??={};for(let t in foundry.utils.flattenObject(i.flags))if(t.includes(".-="))t=t.replace(".-=","."),foundry.utils.setProperty(s.flags,t,foundry.utils.getProperty(e.flags,t));else if(!foundry.utils.hasProperty(s.flags,t)){let e;for(;;){const i=t.split(".").slice(0,-1).join(".");if(e=i?foundry.utils.getProperty(s.flags,i):s.flags,void 0!==e)break;t=i}"Object"===foundry.utils.getType(e)&&(e[`-=${t.split(".").at(-1)}`]=null)}}t.push(s)}return t}),[]),s=canvas.getCollectionLayer(t);s?.storeHistory("update",n)}}_preDeleteDescendantDocuments(e,t,i,n,s){if(super._preDeleteDescendantDocuments(e,t,i,n,s),s===c.userId&&this.isView&&e===this&&!n.isUndo){const e=this.getEmbeddedCollection(t),n=i.reduce(((t,i)=>{const n=e.get(i);return n&&t.push(n.toObject()),t}),[]),s=canvas.getCollectionLayer(t);s?.storeHistory("delete",n)}}_onUpdateDescendantDocuments(e,t,i,n,s,o){super._onUpdateDescendantDocuments(e,t,i,n,s,o),e===this&&i.some((e=>e.object?.hasActiveHUD))&&canvas.getCollectionLayer(t).hud.render()}toCompendium(e,t={}){const i=super.toCompendium(e,t);return t.clearState&&delete i.fog.reset,t.clearSort&&(delete i.navigation,delete i.navOrder),i}async createThumbnail({img:e,width:t=300,height:i=100,format:n="image/webp",quality:s=.8}={}){if(c.settings.get("core","noCanvas"))throw new Error(c.i18n.localize("SCENES.GenerateThumbNoCanvas"));const o=void 0!==e;e=e??this.background.src;const r=this.clone({"background.src":e}),a=this.tiles.filter((e=>e.texture.src&&!e.hidden)),l=a.map((e=>e.texture.src));e&&l.push(e),this.foreground&&l.push(this.foreground),await TextureLoader.loader.load(l);const d=e?getTexture(e):null;o&&d&&r.updateSource({width:d.width,height:d.height});const u=r.getDimensions(),h=new PIXI.Container,p=new PIXI.Rectangle(0,0,u.sceneWidth,u.sceneHeight),g=h.addChild(new PIXI.LegacyGraphics);g.beginFill(16777215,1).drawShape(p).endFill(),g.zIndex=-1,h.mask=g;const drawTile=async e=>{const t=getTexture(e.texture.src);if(!t)return;const i=new PIXI.Sprite(t),{x:n,y:s,rotation:o,width:r,height:a}=e,{scaleX:l,scaleY:c,tint:d}=e.texture;return i.anchor.set(.5,.5),i.width=Math.abs(r),i.height=Math.abs(a),i.scale.x*=l,i.scale.y*=c,i.tint=d,i.position.set(n+r/2-u.sceneRect.x,s+a/2-u.sceneRect.y),i.angle=o,i.elevation=e.elevation,i.zIndex=e.sort,i};if(d){const e=new PIXI.Sprite(d);e.width=u.sceneWidth,e.height=u.sceneHeight,e.elevation=PrimaryCanvasGroup.BACKGROUND_ELEVATION,e.zIndex=-1/0,h.addChild(e)}if(this.foreground){const e=getTexture(this.foreground),t=new PIXI.Sprite(e);t.width=u.sceneWidth,t.height=u.sceneHeight,t.elevation=r.foregroundElevation,t.zIndex=-1/0,h.addChild(t)}for(let e of a){const t=await drawTile(e);t&&h.addChild(t)}h.children.sort(((e,t)=>e.elevation-t.elevation||e.zIndex-t.zIndex));const m=new PIXI.Container;return m.addChild(h),ImageHelper.createThumbnail(m,{width:t,height:i,format:n,quality:s})}}class Setting extends(ClientDocumentMixin(foundry.documents.BaseSetting)){static#Fe=Object.freeze([String,Number,Boolean,Array,Symbol,BigInt]);get config(){return c.settings?.settings.get(this.key)}_initialize(e={}){super._initialize(e),this.value=this._castType()}_onCreate(e,t,i){super._onCreate(e,t,i);const n=this.config?.onChange;n instanceof Function&&n(this.value,t,i)}_onUpdate(e,t,i){super._onUpdate(e,t,i);const n=this.config?.onChange;"value"in e&&n instanceof Function&&n(this.value,t,i)}_castType(){if(null===this.value||void 0===this.value)return this.value;const e=this.config?.type;if(!(e instanceof Function))return this.value;if(Setting.#Fe.includes(e))return e===String&&"string"!=typeof this.value?JSON.stringify(this.value):this.value instanceof e?this.value:e(this.value);if(e instanceof foundry.data.fields.DataField)return e.initialize(value);if(foundry.utils.isSubclass(e,foundry.abstract.DataModel))return e.fromSource(this.value);return e?.prototype?.constructor===e?new e(this.value):e(this.value)}}class TableResult extends(ClientDocumentMixin(foundry.documents.BaseTableResult)){get icon(){return this.img||g.RollTable.resultIcon}prepareBaseData(){super.prepareBaseData(),c._documentsReady&&("document"===this.type?this.img=c.collections.get(this.documentCollection)?.get(this.documentId)?.img??this.img:"pack"===this.type&&(this.img=c.packs.get(this.documentCollection)?.index.get(this.documentId)?.img??this.img))}getChatText(){switch(this.type){case CONST.TABLE_RESULT_TYPES.DOCUMENT:return`@${this.documentCollection}[${this.documentId}]{${this.text}}`;case CONST.TABLE_RESULT_TYPES.COMPENDIUM:return`@Compendium[${this.documentCollection}.${this.documentId}]{${this.text}}`;default:return this.text}}}class RollTable extends(ClientDocumentMixin(foundry.documents.BaseRollTable)){get thumbnail(){return this.img}async toMessage(e,{roll:t,messageData:i={},messageOptions:n={}}={}){const s=ChatMessage.getSpeaker(),o="TABLE.DrawFlavor"+(e.length>1?"Plural":"");return i=foundry.utils.mergeObject({flavor:c.i18n.format(o,{number:e.length,name:this.name}),user:c.user.id,speaker:s,rolls:[],sound:t?g.sounds.dice:null,flags:{"core.RollTable":this.id}},i),t&&i.rolls.push(t),i.content=await renderTemplate(g.RollTable.resultTemplate,{description:await TextEditor$1.enrichHTML(this.description,{documents:!0}),results:e.map((e=>{const t=e.toObject(!1);return t.text=e.getChatText(),t.icon=e.icon,t})),rollHTML:this.displayRoll&&t?await t.render():null,table:this}),ChatMessage.implementation.create(i,n)}async draw({roll:e,recursive:t=!0,results:i=[],displayChat:n=!0,rollMode:s}={}){if(!i.length){const n=await this.roll({roll:e,recursive:t});e=n.roll,i=n.results}if(!i.length)return{roll:e,results:i};if(!this.replacement&&!this.pack){const t=this.getResultsForRoll(e.total);await this.updateEmbeddedDocuments("TableResult",t.map((e=>({_id:e.id,drawn:!0}))))}let o=i.reduce(((e,t)=>{const i=t.parent;return i===this||i.replacement||i.pack||(e[i.id]||(e[i.id]=[]),e[i.id].push({_id:t.id,drawn:!0})),e}),{});return Object.keys(o).length&&(o=Object.entries(o).map((([e,t])=>({_id:e,results:t}))),await RollTable.implementation.updateDocuments(o)),n&&await this.toMessage(i,{roll:e,messageOptions:{rollMode:s}}),{roll:e,results:i}}async drawMany(e,{roll:t=null,recursive:i=!0,displayChat:n=!0,rollMode:s}={}){let o=[],r=[];const a=[];for(let n=0;n<e;n++){let e=await this.roll({roll:t,recursive:i});if(!e.results.length)break;a.push(e.roll),o=o.concat(e.results),this.replacement||this.pack||(r=r.concat(e.results.map((e=>(e.drawn=!0,{_id:e.id,drawn:!0})))))}const l=g.Dice.termTypes.PoolTerm.fromRolls(a);return t=Roll.defaultImplementation.fromTerms([l]),r.length&&await this.updateEmbeddedDocuments("TableResult",r,{diff:!1}),n&&o.length&&await this.toMessage(o,{roll:t,messageOptions:{rollMode:s}}),{roll:t,results:o}}async normalize(){let e=0,t=1;const i=[];for(let n of this.results){const s=n.weight??1;e+=s,i.push({_id:n.id,range:[t,t+s-1]}),t+=s}return this.update({results:i,formula:`1d${e}`})}async resetResults(){const e=this.results.map((e=>({_id:e.id,drawn:!1})));return this.updateEmbeddedDocuments("TableResult",e,{diff:!1})}async roll({roll:e,recursive:t=!0,_depth:i=0}={}){if(i>5)throw new Error(`Maximum recursion depth exceeded when attempting to draw from RollTable ${this.id}`);this.formula||await this.normalize(),e=e instanceof Roll?e:Roll.create(this.formula);let n=[];const s=this.results.filter((e=>!e.drawn));if(!s.length)return ui.notifications.warn(c.i18n.localize("TABLE.NoAvailableResults")),{roll:e,results:n};const o=(await e.reroll({minimize:!0})).total,r=(await e.reroll({maximize:!0})).total,a=s.reduce(((e,t)=>{const i=t.range;return(!e[0]||i[0]<e[0])&&(e[0]=i[0]),(!e[1]||i[1]>e[1])&&(e[1]=i[1]),e}),[null,null]);if(a[0]>r||a[1]<o)return ui.notifications.warn("No results can possibly be drawn from this table and formula."),{roll:e,results:n};let l=0;for(;!n.length;){if(l>=1e4){ui.notifications.error(`Failed to draw an available entry from Table ${this.name}, maximum iteration reached`);break}e=await e.reroll(),n=this.getResultsForRoll(e.total),l++}if(t){let e=[];for(let t of n){let n,s;if(t.type===CONST.TABLE_RESULT_TYPES.DOCUMENT?s=t.documentCollection:t.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM&&(n=c.packs.get(t.documentCollection),s=n?.documentName),"RollTable"===s){const s=t.documentId,o=n?await n.getDocument(s):c.tables.get(s);if(o){const t=await o.roll({_depth:i+1});e=e.concat(t.results)}}else e.push(t)}n=e}return{roll:e,results:n}}async _rollFromEmbeddedHTML(e){await this.draw();const t=e.target.closest(".roll-table-embed");if(!t)return;let i=0;const n=t.querySelectorAll(":scope > tbody > tr");for(const{drawn:e}of this.results){const t=n[i++];t?.classList.toggle("drawn",e)}}getResultsForRoll(e){return this.results.filter((t=>!t.drawn&&Number.between(e,...t.range)))}async _buildEmbedHTML(e,t={}){t={...t,relativeTo:this};const i=e.rollable||e.values.includes("rollable"),n=this.results.toObject();n.sort(((e,t)=>e.range[0]-t.range[0]));const s=document.createElement("table");let o=c.i18n.localize("TABLE.Roll");i&&(o=`\n        <button type="button" data-action="rollTable" data-tooltip="TABLE.Roll"\n                aria-label="${c.i18n.localize("TABLE.Roll")}" class="fas fa-dice-d20"></button>\n        <span>${o}</span>\n      `),s.classList.add("roll-table-embed"),s.classList.toggle("roll-table-rollable",i),s.innerHTML=`\n      <thead>\n        <tr>\n          <th>${o}</th>\n          <th>${c.i18n.localize("TABLE.Result")}</th>\n        </tr>\n      </thead>\n      <tbody></tbody>\n    `;const r=s.querySelector("tbody");for(const{range:e,type:i,text:s,documentCollection:o,documentId:a,drawn:l}of n){const n=document.createElement("tr");n.classList.toggle("drawn",l);const[d,u]=e;let h,p;switch(n.innerHTML+=`<td>${d===u?d:`${d}&mdash;${u}`}</td>`,i){case CONST.TABLE_RESULT_TYPES.TEXT:h=await TextEditor$1.enrichHTML(s,t);break;case CONST.TABLE_RESULT_TYPES.DOCUMENT:p=g[o].collection.instance?.get(a);break;case CONST.TABLE_RESULT_TYPES.COMPENDIUM:const e=c.packs.get(o);p=await e.getDocument(a)}void 0===h&&(h=p?p.toAnchor().outerHTML:TextEditor$1.createAnchor({label:s,icon:"fas fa-unlink",classes:["content-link","broken"]}).outerHTML),n.innerHTML+=`<td>${h}</td>`,r.append(n)}return s}async _createFigureEmbed(e,t,i){const n=await super._createFigureEmbed(e,t,i);if(t.caption&&!t.label){i={...i,relativeTo:this};const e=await TextEditor$1.enrichHTML(this.description,i),t=n.querySelector(":scope > figcaption");t.querySelector(":scope > .embed-caption").remove();const s=document.createElement("div");s.classList.add("embed-caption"),s.innerHTML=e,t.insertAdjacentElement("afterbegin",s)}return n}_onCreateDescendantDocuments(e,t,i,n,s,o){super._onCreateDescendantDocuments(e,t,i,n,s,o),!1!==s.render&&this.collection.render()}_onDeleteDescendantDocuments(e,t,i,n,s,o){super._onDeleteDescendantDocuments(e,t,i,n,s,o),!1!==s.render&&this.collection.render()}toCompendium(e,t={}){const i=super.toCompendium(e,t);if(t.clearState)for(let e of i.results)e.drawn=!1;return i}static async fromFolder(e,t={}){const i=e.contents.map(((t,i)=>({text:t.name,type:e.pack?CONST.TABLE_RESULT_TYPES.COMPENDIUM:CONST.TABLE_RESULT_TYPES.DOCUMENT,documentCollection:e.pack?e.pack:e.type,documentId:t.id,img:t.thumbnail||t.img,weight:1,range:[i+1,i+1],drawn:!1})));return t.renderSheet=t.renderSheet??!0,this.create({name:e.name,description:`A random table created from the contents of the ${e.name} Folder.`,results:i,formula:`1d${i.length}`},t)}}class TileDocument extends(CanvasDocumentMixin(foundry.documents.BaseTile)){prepareDerivedData(){super.prepareDerivedData();const e=this.parent?.dimensions;if(!e)return;const t=Math.max(e.size/5,20).toNearest(.1),i=e.width-t,n=e.height-t,s=-1*(this.width-t),o=-1*(this.height-t);this.x=Math.clamp(this.x.toNearest(.1),s,i),this.y=Math.clamp(this.y.toNearest(.1),o,n)}}class TokenDocument extends(CanvasDocumentMixin(foundry.documents.BaseToken)){actors=function(){const e=new foundry.utils.Collection;return e.documentClass=Actor.implementation,e}();get actor(){return(this.isLinked?this.baseActor:this.delta?.syntheticActor)??null}get baseActor(){return c.actors.get(this.actorId)}get isOwner(){return!!c.user.isGM||(this.actor?.isOwner??!1)}get isLinked(){return this.actorLink}get isSecret(){return this.disposition===CONST.TOKEN_DISPOSITIONS.SECRET&&!this.testUserPermission(c.user,"OBSERVER")}get combatant(){return c.combat?.combatants.find((e=>e.tokenId===this.id))||null}get inCombat(){return!!this.combatant}regions=c._documentsReady?new Set:null;_initialize(e={}){super._initialize(e),this.baseActor?._registerDependentToken(this)}prepareBaseData(){if(null===this.regions){if(this.regions=new Set,!this.parent)return;for(const e of this._regions){const t=this.parent.regions.get(e);t&&(this.regions.add(t),t.tokens.add(this))}}this.name||=this.actor?.name||"Unknown",this.hidden&&(this.alpha=Math.min(this.alpha,c.user.isGM?.5:0)),this._prepareDetectionModes()}prepareEmbeddedDocuments(){c._documentsReady&&!this.delta&&this.updateSource({delta:{_id:this.id}})}prepareDerivedData(){this.ring.enabled&&!this.ring.subject.texture&&(this.ring.subject.texture=this._inferRingSubjectTexture())}_inferRingSubjectTexture(){let e=this.texture.src;for(const[t,i]of Object.entries(g.Token.ring.subjectPaths))if(e.startsWith(t))return e.replace(t,i);return e}_prepareDetectionModes(){if(!this.sight.enabled)return;this.detectionModes.find((e=>"lightPerception"===e.id))||this.detectionModes.push({id:"lightPerception",enabled:!0,range:null});this.detectionModes.find((e=>"basicSight"===e.id))||this.detectionModes.push({id:"basicSight",enabled:!0,range:this.sight.range})}getBarAttribute(e,{alternative:t}={}){const i=t||this[e]?.attribute;if(!i||!this.actor)return null;const n=this.actor.system,s=n instanceof foundry.abstract.DataModel,o=c.model.Actor[this.actor.type],r=foundry.utils.getProperty(n,i);if(null==r)return null;if(Number.isNumeric(r)){let e=foundry.utils.hasProperty(o,i);if(s){const t=n.schema.getField(i);t&&(e=t instanceof foundry.data.fields.NumberField)}return{type:"value",attribute:i,value:Number(r),editable:e}}if("value"in r&&"max"in r){let e=foundry.utils.hasProperty(o,`${i}.value`);if(s){const t=n.schema.getField(`${i}.value`);t&&(e=t instanceof foundry.data.fields.NumberField)}return{type:"bar",attribute:i,value:parseInt(r.value||0),max:parseInt(r.max||0),editable:e}}return null}hasStatusEffect(e){return this.actor?.statuses.has(e)??!1}async toggleCombatant({active:e,...t}={}){return e??=!this.inCombat,e?await this.constructor.createCombatants([this],t):await this.constructor.deleteCombatants([this],t),this.inCombat}static async createCombatants(e,{combat:t}={}){if(t??=c.combats.viewed,!t){if(!c.user.isGM)throw new Error(c.i18n.localize("COMBAT.NoneActive"));{const e=getDocumentClass("Combat");t=await e.create({scene:canvas.scene.id,active:!0},{render:!1})}}const i=new Set(e).reduce(((e,t)=>(t.inCombat||e.push({tokenId:t.id,sceneId:t.parent.id,actorId:t.actorId,hidden:t.hidden}),e)),[]);return t.createEmbeddedDocuments("Combatant",i)}static async deleteCombatants(e,{combat:t}={}){t??=c.combats.viewed;const i=new Set(e.map((e=>e.id))),n=t.combatants.reduce(((e,t)=>(i.has(t.tokenId)&&e.push(t.id),e)),[]);return t.deleteEmbeddedDocuments("Combatant",n)}async updateVisionMode(e,t=!0){if(!(e in g.Canvas.visionModes))throw new Error("The provided vision mode does not exist in CONFIG.Canvas.visionModes");let i={sight:{visionMode:e}};if(t){const t=g.Canvas.visionModes[e].vision.defaults;for(const[e,n]of Object.entries(t))void 0!==n&&(i.sight[e]=n)}return this.update(i)}getEmbeddedCollection(e){if(this.isLinked)return super.getEmbeddedCollection(e);switch(e){case"Actor":return this.actors.set(this.actorId,this.actor),this.actors;case"Item":return this.actor.items;case"ActiveEffect":return this.actor.effects}return super.getEmbeddedCollection(e)}_onCreate(e,t,i){for(const e of this._regions){const t=this.parent.regions.get(e);t&&(this.regions.add(t),t.tokens.add(this))}super._onCreate(e,t,i)}async _preUpdate(e,t,i){if(!1===await super._preUpdate(e,t,i))return!1;"actorId"in e&&(t.previousActorId=this.actorId),"actorData"in e&&foundry.utils.logCompatibilityWarning("This update operation includes an update to the Token's actorData property, which is deprecated. Please perform updates via the synthetic Actor instead, accessible via the 'actor' getter.",{since:11,until:13})}_onUpdate(e,t,i){const n=Object.values(this.apps).filter((e=>e instanceof TokenConfig));if(n.forEach((i=>{i.preview&&(t.animate=!1),i._previewChanges(e)})),"actorId"in e||"actorLink"in e){const e=c.actors.get(t.previousActorId);e&&(Object.values(e.apps).forEach((e=>e.close({submit:!1}))),e._unregisterDependentToken(this)),this.delta._createSyntheticActor({reinitializeCollections:!0})}const s=t._priorRegions?.[this.id];if(s&&this.#Ue(s),c.user.id===i){const e=t._priorPosition?.[this.id];e&&this.#Be(e,!0===t.teleport,!0===t.forced)}super._onUpdate(e,t,i),n.forEach((e=>e._previewChanges()))}#Ue(e){this.regions.clear();for(const e of this._regions){const t=this.parent.regions.get(e);t&&this.regions.add(t)}const t=new Set;for(const i of e){const e=this.parent.regions.get(i);e&&t.add(e)}for(const e of t)e.tokens.delete(this);for(const e of this.regions)e.tokens.add(this)}#Be(e,t,i){if(!this.parent.isView||!this.object)return;const n=CONST.REGION_EVENTS,s=this.elevation,o={x:this.x,y:this.y,elevation:s};for(const s of this.parent.regions){if(!s.object)continue;if(!s.behaviors.some((e=>!e.disabled&&(e.hasEvent(n.TOKEN_MOVE)||e.hasEvent(n.TOKEN_MOVE_IN)||e.hasEvent(n.TOKEN_MOVE_OUT)))))continue;const r=this.object.segmentizeRegionMovement(s.object,[e,o],{teleport:t});if(0===r.length)continue;const a=Region.MOVEMENT_SEGMENT_TYPES,l=r[0].type,c=r.at(-1).type,d={token:this,origin:e,destination:o,teleport:t,forced:i,segments:r};l===a.ENTER&&c!==a.EXIT&&s._triggerEvent(n.TOKEN_MOVE_IN,d),s._triggerEvent(n.TOKEN_MOVE,d),l!==a.ENTER&&c===a.EXIT&&s._triggerEvent(n.TOKEN_MOVE_OUT,d)}}_onDelete(e,t){c.user.id===t&&c.combats._onDeleteToken(this.parent.id,this.id),super._onDelete(e,t),this.baseActor?._unregisterDependentToken(this)}#Ge(e={}){if(!this.parent?.isView)return;const t=[];let i;for(const n of this.parent.regions){if(!n.object)continue;i??=this.clone(e);i.object.testInsideRegion(n.object)&&t.push(n.id)}return i?.object.destroy({children:!0}),t.sort()}static async _preCreateOperation(e,t,i){if(!1===await super._preCreateOperation(e,t,i))return!1;for(const t of e)t.updateSource({_regions:t.#Ge()??[]})}static async _preUpdateOperation(e,t,i){if(!1===await super._preUpdateOperation(e,t,i))return!1;await TokenDocument.#je(e,t,i),TokenDocument.#$e(e,t,i)}static async#je(e,t,i){if(!t.parent.isView)return;const n=!0===t.teleport;for(let s=0;s<e.length;s++){const o=e[s];if(!o.object)continue;const r=t.updates[s];if(!("x"in r||"y"in r||"elevation"in r))continue;const{x:a,y:l,elevation:c}=o,d={x:a,y:l,elevation:c},u=r.x??a,h=r.y??l,p=r.elevation??c,g={x:u,y:h,elevation:p};let m,v;for(const e of o.parent.regions){if(!e.object)continue;const t=e.behaviors.filter((e=>!e.disabled&&e.hasEvent(CONST.REGION_EVENTS.TOKEN_PRE_MOVE)));if(0===t.length)continue;0!==o.object.animationContexts.size&&o.reset();const s=o.object.segmentizeRegionMovement(e.object,[d,g],{teleport:n});if(0===s.length)continue;const r={name:CONST.REGION_EVENTS.TOKEN_PRE_MOVE,data:{token:o,origin:d,destination:g,teleport:n,segments:s},region:e,user:i};for(const e of t){try{await e._handleRegionEvent(r)}catch(e){console.error(e)}const t=r.data.destination;if(t.x===u&&t.y===h&&t.elevation===p)continue;const i=Math.hypot(t.x-d.x,t.y-d.y,(t.elevation-d.elevation)*canvas.dimensions.distancePixels);(!m||i<v)&&(m={x:t.x,y:t.y,elevation:t.elevation},v=i),r.data.destination={x:u,y:h,elevation:p}}}m&&(r.x=m.x,r.y=m.y,r.elevation=m.elevation)}}static#$e(e,t){if(t.parent.isView)for(let i=0;i<e.length;i++){const n=e[i],s=t.updates[i];n._couldRegionsChange(s)&&(s._regions=n.#Ge(s))}}static async _onCreateOperation(e,t,i){for(const t of e)for(const e of t.regions)e._handleEvent({name:CONST.REGION_EVENTS.TOKEN_ENTER,data:{token:t},region:e,user:i})}static async _onUpdateOperation(e,t,i){if(t._priorRegions)for(const n of e){const e=t._priorRegions[n.id];if(!e)continue;const s=new Set;for(const t of e){const e=n.parent.regions.get(t);e&&s.add(e)}const o=n.regions.difference(s),r=s.difference(n.regions);for(const e of r)e._handleEvent({name:CONST.REGION_EVENTS.TOKEN_EXIT,data:{token:n},region:e,user:i});for(const e of o)e._handleEvent({name:CONST.REGION_EVENTS.TOKEN_ENTER,data:{token:n},region:e,user:i})}}static async _onDeleteOperation(e,t,i){const n=[];for(const t of e){for(const e of t.regions)e.tokens.delete(t),n.push({name:CONST.REGION_EVENTS.TOKEN_EXIT,data:{token:t},region:e,user:i});t.regions.clear()}for(const e of n)e.region._handleEvent(e)}_couldRegionsChange(e){const t="x"in e||"y"in e,i="elevation"in e,n="width"in e||"height"in e,s=this.parent.grid.isHexagonal&&"hexagonalShape"in e;return t||i||n||s}_preCreateDescendantDocuments(e,t,i,n,s){e!==this.delta&&this.delta?._handleDeltaCollectionUpdates(e)}_preUpdateDescendantDocuments(e,t,i,n,s){e!==this.delta&&this.delta?._handleDeltaCollectionUpdates(e)}_preDeleteDescendantDocuments(e,t,i,n,s){e!==this.delta&&this.delta?._handleDeltaCollectionUpdates(e)}_onCreateDescendantDocuments(e,t,i,n,s,o){super._onCreateDescendantDocuments(e,t,i,n,s,o),this._onRelatedUpdate(n,s)}_onUpdateDescendantDocuments(e,t,i,n,s,o){super._onUpdateDescendantDocuments(e,t,i,n,s,o),this._onRelatedUpdate(n,s)}_onDeleteDescendantDocuments(e,t,i,n,s,o){super._onDeleteDescendantDocuments(e,t,i,n,s,o),this._onRelatedUpdate({},s)}_onUpdateBaseActor(e={},t={}){if(!this.isLinked&&this.delta){this.delta.updateSyntheticActor();for(const e of Object.values(this.delta.collections))e.initialize({full:!0});this.actor.sheet.render(!1,{renderContext:"updateActor"})}this._onRelatedUpdate(e,t)}_onRelatedUpdate(e={},t={}){const i=this.combatant;if(i&&foundry.utils.hasProperty(e.system||{},c.combat.settings.resource)&&i.updateResource(),this.inCombat&&ui.combat.render(),this.parent.isView){this.object?.hasActiveHUD&&canvas.tokens.hud.render(),this.object?.renderFlags.set({refreshBars:!0,redrawEffects:!0});Object.values(this.apps).filter((e=>e instanceof TokenConfig)).forEach((e=>{e.preview?.updateSource({delta:this.toObject().delta},{diff:!1,recursive:!1}),e.preview?.object?.renderFlags.set({refreshBars:!0,redrawEffects:!0})}))}}static getTrackedAttributes(e,t=[]){if(e instanceof foundry.abstract.DataModel||foundry.utils.isSubclass(e,foundry.abstract.DataModel))return this._getTrackedAttributesFromSchema(e.schema,t);if(e instanceof foundry.data.fields.SchemaField)return this._getTrackedAttributesFromSchema(e,t);if(["Object","Array"].includes(foundry.utils.getType(e)))return this._getTrackedAttributesFromObject(e,t);if(!e||"string"==typeof e){const t=this._getConfiguredTrackedAttributes(e);if(t)return t;e=void 0}if(void 0!==e)return{bar:[],value:[]};const i=new Set,n=new Set;for(let[e,s]of Object.entries(c.model.Actor)){const o=g.Actor.dataModels?.[e],r=this.getTrackedAttributes(o??s,t);r.bar.forEach((e=>i.add(e.join(".")))),r.value.forEach((e=>n.add(e.join("."))))}return{bar:Array.from(i).map((e=>e.split("."))),value:Array.from(n).map((e=>e.split(".")))}}static _getTrackedAttributesFromObject(e,t=[]){const i={bar:[],value:[]};for(let[n,s]of Object.entries(e)){let o=t.concat([n]);if(s instanceof Object){if("_source"===n)continue;if("value"in s&&"max"in s)i.bar.push(o);else{const t=this.getTrackedAttributes(e[n],o);i.bar.push(...t.bar),i.value.push(...t.value)}}else(Number.isNumeric(s)||null===s)&&i.value.push(o)}return i}static _getTrackedAttributesFromSchema(e,t=[]){const i={bar:[],value:[]};for(const[n,s]of Object.entries(e.fields)){const e=t.concat([n]);s instanceof foundry.data.fields.NumberField&&i.value.push(e);const o=s instanceof foundry.data.fields.SchemaField,r=s instanceof foundry.data.fields.EmbeddedDataField;if(o||r){const t=r?s.model.schema:s;if(t.has("value")&&t.has("max"))i.bar.push(e);else{const n=this.getTrackedAttributes(t,e);i.bar.push(...n.bar),i.value.push(...n.value)}}}return i}static _getConfiguredTrackedAttributes(e){if(foundry.utils.isEmpty(g.Actor.trackableAttributes))return;let t=foundry.utils.deepClone(g.Actor.trackableAttributes[e]);if(foundry.utils.isEmpty(t)){const e=new Set,i=new Set;for(const t of Object.values(g.Actor.trackableAttributes))t.bar.forEach(e.add,e),t.value.forEach(i.add,i);t={bar:Array.from(e),value:Array.from(i)}}return Object.keys(t).forEach((e=>t[e]=t[e].map((e=>e.split("."))))),t}static getTrackedAttributeChoices(e){e=e||this.getTrackedAttributes();const t=c.i18n.localize("TOKEN.BarAttributes"),i=c.i18n.localize("TOKEN.BarValues"),n=e.bar.map((e=>{const i=e.join(".");return{group:t,value:i,label:i}}));n.sort(((e,t)=>e.value.compare(t.value)));const s=e.value.map((e=>{const t=e.join(".");return{group:i,value:t,label:t}}));return s.sort(((e,t)=>e.value.compare(t.value))),n.concat(s)}getActor(){return foundry.utils.logCompatibilityWarning("TokenDocument#getActor has been deprecated. Please use the TokenDocument#actor getter to retrieve the Actor instance that the TokenDocument represents, or use TokenDocument#delta#apply to generate a new synthetic Actor instance."),this.delta?.apply()??this.baseActor??null}get actorData(){return foundry.utils.logCompatibilityWarning("You are accessing TokenDocument#actorData which is deprecated. Source data may be retrieved via TokenDocument#delta but all modifications/access should be done via the synthetic Actor at TokenDocument#actor if possible.",{since:11,until:13}),this.delta.toObject()}set actorData(e){foundry.utils.logCompatibilityWarning("You are accessing TokenDocument#actorData which is deprecated. Source data may be retrieved via TokenDocument#delta but all modifications/access should be done via the synthetic Actor at TokenDocument#actor if possible.",{since:11,until:13});const t=this.delta.id;this.delta=new ActorDelta.implementation({...e,_id:t},{parent:this})}async toggleActiveEffect(e,{overlay:t=!1,active:i}={}){return foundry.utils.logCompatibilityWarning("TokenDocument#toggleActiveEffect is deprecated in favor of Actor#toggleStatusEffect",{since:12,until:14}),!(!this.actor||!e.id)&&!!await this.actor.toggleStatusEffect(e.id,{active:i,overlay:t})}}foundry.data.PrototypeToken.prototype.getBarAttribute=TokenDocument.prototype.getBarAttribute;class User extends(ClientDocumentMixin(foundry.documents.BaseUser)){active=!1;targets=new UserTargets(this);viewedScene=null;get isTrusted(){return this.hasRole("TRUSTED")}get isSelf(){return c.userId===this.id}prepareDerivedData(){super.prepareDerivedData(),this.avatar=this.avatar||this.character?.img||CONST.DEFAULT_TOKEN,this.border=this.color.multiply(2)}async assignHotbarMacro(e,t,{fromSlot:i}={}){if(!(e instanceof Macro)&&null!==e)throw new Error("Invalid Macro provided");const n=this.hotbar;if(Number.isNumeric(t))t=Number(t);else for(let e=1;e<=50;e++)if(!(e in n)){t=e;break}if(!t)throw new Error("No available Hotbar slot exists");if(t<1||t>50)throw new Error("Invalid Hotbar slot requested");if(e&&n[t]===e.id)return this;const s=n[t],o=foundry.utils.deepClone(n);return e?o[t]=e.id:delete o[t],Number.isNumeric(i)&&i in n&&(s?o[i]=s:delete o[i]),this.update({hotbar:o},{diff:!1,recursive:!1,noHook:!0})}assignPermission(e,t){if(!c.user.isGM)throw new Error(`You are not allowed to modify the permissions of User ${this.id}`);const i={[e]:t};return this.update({permissions:i})}broadcastActivity(e={},{volatile:t}={}){t??=!("sceneId"in e||null===e.ruler||"targets"in e||"ping"in e||"av"in e),t?c.socket.volatile.emit("userActivity",this.id,e):c.socket.emit("userActivity",this.id,e)}getHotbarMacros(e=1){const t=Array.from({length:50},(()=>""));for(let[e,i]of Object.entries(this.hotbar))t[parseInt(e)-1]=i;const i=10*(e-1);return t.slice(i,i+10).map(((e,t)=>({slot:i+t+1,macro:e?c.macros.get(e):null})))}updateTokenTargets(e=[]){if(this.viewedScene!==canvas.scene.id){for(let e of this.targets)e.setTarget(!1,{user:this,releaseOthers:!1,groupSelection:!0});return}const t=new Set(e);if(!this.targets.equals(t)){for(let e of this.targets)t.has(e.id)||e.setTarget(!1,{user:this,releaseOthers:!1,groupSelection:!0});for(let e of t){const t=canvas.tokens.get(e);t&&!this.targets.has(t)&&t.setTarget(!0,{user:this,releaseOthers:!1,groupSelection:!0})}}}_onUpdate(e,t,i){if(super._onUpdate(e,t,i),this._source.role!==this.role){const n=this.clone({},{keepId:!0});return c.users.set(n.id,n),n._onUpdate(e,t,i)}const n=e._id===c.userId;if(n&&["password","role"].some((t=>t in e)))return c.logOut();if(!c.ready)return;"color"in e&&(document.documentElement.style.setProperty(`--user-color-${this.id}`,this.color.css),n&&document.documentElement.style.setProperty("--user-color",this.color.css)),["active","character","color","role"].some((t=>t in e))&&(ui.nav?.render(),ui.players?.render()),n&&"hotbar"in e&&ui.hotbar?.render();if(["permissions","role"].some((t=>t in e))&&e._id===c.userId?c.webrtc?.client.updateLocalStream().then((()=>c.webrtc.render())):["name","avatar","character"].some((t=>t in e))&&c.webrtc?.render(),canvas.ready){if("color"in e){canvas.controls.drawCursor(this);const t=canvas.controls.getRulerForUser(this.id);t&&(t.color=Color.from(e.color))}"active"in e&&canvas.controls.updateCursor(this,null),n&&"character"in e&&(canvas.perception.initialize(),canvas.tokens.cycleTokens(!0,!0))}}_onDelete(e,t){if(super._onDelete(e,t),this.id===c.user.id)return c.logOut()}}class WallDocument extends(CanvasDocumentMixin(foundry.documents.BaseWall)){}const h={};h.MAX_COLOR=[WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.MAX,WebGL2RenderingContext.MAX],h.MIN_COLOR=[WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.MIN,WebGL2RenderingContext.MAX],h.MIN_ALL=[WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.MIN,WebGL2RenderingContext.MIN];class Canvas{constructor(){Object.defineProperty(this,"edges",{value:new foundry.canvas.edges.CanvasEdges}),Object.defineProperty(this,"fog",{value:new g.Canvas.fogManager}),Object.defineProperty(this,"perception",{value:new PerceptionManager})}blurFilters=new Set;currentMouseManager=null;loadTexturesOptions;visibilityOptions;blurOptions;sceneTextures={};fps={average:0,values:[],render:0,element:document.getElementById("fps")};mouseInteractionManager;performance;supported;photosensitiveMode;screenDimensions=[0,0];loading=!1;initializing=null;#He=foundry.utils.throttle(this.#ze.bind(this),100);#Ve=Promise.resolve(this);app;stage;rendered;edges;fog;perception;environment;primary;effects;visibility;interface;overlay;hud;mousePosition=new PIXI.Point;#We;#Xe={};_panTime=0;forceSnapVertices=!1;get initialized(){return this.#Ye}#Ye=!1;get scene(){return this.#Ke}#Ke=null;get manager(){return this.#qe}#qe=null;get dimensions(){return this.#Je}#Je=null;get grid(){return this.scene?.grid??null}get ready(){return this.#g}#g=!1;get colors(){return this.environment.colors}get masks(){return this.hidden.masks}get id(){return this.#Ke?.id||null}static get layers(){return g.Canvas.layers}get layers(){const e=[];for(const[t,i]of Object.entries(g.Canvas.layers)){const n=this[i.group]?.[t]??this[t];n instanceof CanvasLayer&&e.push(n)}return e}get activeLayer(){for(const e of this.layers)if(e.active)return e;return null}get darknessLevel(){return this.environment.darknessLevel}initialize(){if(this.#Ye)throw new Error("The Canvas is already initialized and cannot be re-initialized");if(c.settings.get("core","noCanvas"))return;Canvas.#Qe();const e=Canvas.#Ze(),t=Canvas.#et();this.#tt(e,t),this._configurePerformanceMode(),c.issues._detectWebGLIssues(),this.#We=new DragDrop({callbacks:{drop:this._onDrop.bind(this)}}).bind(e),Object.defineProperty(this,"hud",{value:new HeadsUpDisplay,writable:!1}),Object.defineProperty(this,"photosensitiveMode",{value:c.settings.get("core","photosensitiveMode"),writable:!1}),this.#it("stage",this.stage),this.#Ke=null,this.#qe=null,this.#Ye=!0,this.#g=!1}static#Qe(){if(!PIXI.utils.isWebGLSupported()){const e=new Error(c.i18n.localize("ERROR.NoWebGL"));throw ui.notifications.error(e.message,{permanent:!0}),e}PIXI.settings.PREFER_ENV=PIXI.ENV.WEBGL2}static#Ze(){const e=document.getElementById("board"),t=document.createElement("canvas");return t.id="board",t.style.display="none",e.replaceWith(t),t}static#et(){const e={width:window.innerWidth,height:window.innerHeight,transparent:!1,resolution:c.settings.get("core","pixelRatioResolutionScaling")?window.devicePixelRatio:1,autoDensity:!0,antialias:!1,powerPreference:"high-performance"};return Hooks$1.callAll("canvasConfig",e),e}#nt(){BaseSamplerShader.registerPlugin({force:!0}),OccludableSamplerShader.registerPlugin(),DepthSamplerShader.registerPlugin(),g.Token.ring.ringClass.initialize()}#tt(e,t){this.#nt();const i=new PIXI.Application({view:e,...t});Object.defineProperty(this,"app",{value:i,writable:!1}),Object.defineProperty(this,"stage",{value:this.app.stage,writable:!1}),this.#st(),this.#ot();const n=this.#rt(i.renderer);Object.defineProperty(this,"supported",{value:Object.freeze(n),writable:!1,enumerable:!0});const s=new FramebufferSnapshot;Object.defineProperty(this,"snapshot",{value:s,writable:!1})}#ot(){const e={contextChange:()=>{console.debug(`${l} | Recovering from context loss.`),this.#st(),this.hidden.invalidateMasks(),this.effects.illumination.invalidateDarknessLevelContainer(!0)}};this.app.renderer.runners.contextChange.add(e)}#st(){for(let[e,t]of Object.entries(h)){const i=this.app.renderer.state.blendModes.push(t)-1;PIXI.BLEND_MODES[e]=i,PIXI.BLEND_MODES[i]=e}this.#at()}#at(){const e=[],t=[];for(let i=0;i<canvas.app.renderer.state.blendModes.length;i++)e[i]=i,t[i]=i;e[PIXI.BLEND_MODES.NORMAL_NPM]=PIXI.BLEND_MODES.NORMAL,e[PIXI.BLEND_MODES.ADD_NPM]=PIXI.BLEND_MODES.ADD,e[PIXI.BLEND_MODES.SCREEN_NPM]=PIXI.BLEND_MODES.SCREEN,t[PIXI.BLEND_MODES.NORMAL]=PIXI.BLEND_MODES.NORMAL_NPM,t[PIXI.BLEND_MODES.ADD]=PIXI.BLEND_MODES.ADD_NPM,t[PIXI.BLEND_MODES.SCREEN]=PIXI.BLEND_MODES.SCREEN_NPM,PIXI.utils.premultiplyBlendMode.splice(0,PIXI.utils.premultiplyBlendMode.length),PIXI.utils.premultiplyBlendMode.push(t),PIXI.utils.premultiplyBlendMode.push(e)}#it(e,t){for(const[i,n]of Object.entries(g.Canvas.groups)){if(n.parent!==e)continue;const s=new n.groupClass;Object.defineProperty(this,i,{value:s,writable:!1}),Object.defineProperty(t,i,{value:s,writable:!1}),t.addChild(s),this.#it(i,s)}}_initializeBlur(e={}){this.blurFilters.clear();const t=this.scene.grid.size,i=t/25,n=t/100,s=Math.max(0,this.performance.mode-(this.performance.mode<CONST.CANVAS_PERFORMANCE_MODES.HIGH?1:0)),o=Math.max(5+2*s,5),r=2+2*s;this.blur=new Proxy(Object.seal({enabled:e.enabled??this.performance.mode>CONST.CANVAS_PERFORMANCE_MODES.MED,blurClass:e.blurClass??AlphaBlurFilter,blurPassClass:e.blurPassClass??AlphaBlurFilterPass,strength:e.strength??i,passes:e.passes??Math.clamp(s+Math.floor(n),2,r),kernels:e.kernels??Math.clamp(2*Math.ceil((1+2*s+Math.floor(n))/2)-1,5,o)}),{set(e,t,i){if("strength"!==t)throw new Error(`canvas.blur.${t} is immutable`);const n=Reflect.set(e,t,i);return canvas.updateBlur(),n}}),this.updateBlur()}_configurePerformanceMode(){const e=CONST.CANVAS_PERFORMANCE_MODES;let t=c.settings.get("core","performanceMode");const i=c.settings.get("core","maxFPS"),n=c.settings.get("core","mipmap"),s=this.app.renderer.context.gl,o=s.getParameter(s.MAX_TEXTURE_SIZE);null===t&&(t=o<=Math.pow(2,12)?CONST.CANVAS_PERFORMANCE_MODES.LOW:o<=Math.pow(2,13)?CONST.CANVAS_PERFORMANCE_MODES.MED:CONST.CANVAS_PERFORMANCE_MODES.HIGH,c.settings.storage.get("client").setItem("core.performanceMode",String(t)));const r={mode:t,mipmap:n?"ON":"OFF",msaa:!1,smaa:!1,fps:Math.clamp(i,0,60),tokenAnimation:!0,lightAnimation:!0,lightSoftEdges:!1};return t>=e.LOW&&(r.tokenAnimation=!1,r.lightAnimation=!1),t>=e.MED&&(r.lightSoftEdges=!0,r.smaa=!0),t===e.MAX&&60===r.fps&&(r.fps=0),PIXI.BaseTexture.defaultOptions.mipmap=PIXI.MIPMAP_MODES[r.mipmap],PIXI.Filter.defaultResolution=null,PIXI.Filter.defaultMultisample=null,this.app.ticker.maxFPS=PIXI.Ticker.shared.maxFPS=PIXI.Ticker.system.maxFPS=r.fps,this.performance=r}async draw(e){return this.#Ve=this.#Ve.finally(this.#lt.bind(this,e)),await this.#Ve,this}async#lt(e){if(!this.#Ye)throw new Error("You may not call Canvas#draw before Canvas#initialize");if(void 0===e&&(e=c.scenes.current),!(e instanceof Scene||null===e))throw new Error("You must provide a Scene Document to draw the Canvas.");const t=this.#g;if(this.#g=!1,this.stage.visible=!1,this.loading=!0,t)try{await this.tearDown()}catch(e){e.message=`Encountered an error while tearing down the previous scene: ${e.message}`,logger.error(e)}if(this.#Ke&&e!==this.#Ke&&(this.#Ke._view=!1,c.user.viewedScene===this.#Ke.id&&(c.user.viewedScene=null)),this.#Ke=e,null===this.#Ke)return this.#ct();const{rect:i,sceneRect:n,...s}=e.getDimensions();this.#Je=Object.assign(s,{rect:new PIXI.Rectangle(i.x,i.y,i.width,i.height),sceneRect:new PIXI.Rectangle(n.x,n.y,n.width,n.height)}),canvas.app.view.style.display="block",document.documentElement.style.setProperty("--gridSize",`${this.dimensions.size}px`),this.#qe=Canvas.getSceneManager(this.#Ke),g.Canvas.transcoders.basis&&await TextureLoader.initializeBasisTranscoder(),this.loadTexturesOptions={expireCache:!0,additionalSources:[]},this.visibilityOptions={persistentVision:!1},console.log(`${l} | Drawing game canvas for scene ${this.#Ke.name}`),await this.#dt("_onInit"),await this.#dt("_registerHooks"),Hooks$1.callAll("canvasInit",this),this.stage.position.set(window.innerWidth/2,window.innerHeight/2),this.stage.hitArea={contains:()=>!0},this.stage.eventMode="static",this.stage.sortableChildren=!0,this.initializeCanvasPosition(),this._initializeBlur(this.blurOptions);try{await TextureLoader.loadSceneTextures(this.#Ke,this.loadTexturesOptions)}catch(e){return Hooks$1.onError("Canvas#draw",e,{msg:`Texture loading failed: ${e.message}`,log:"error",notify:"error"}),void(this.loading=!1)}this.performance.smaa&&(this.stage.filters=[new foundry.canvas.SMAAFilter]),g.Token.ring.ringClass.createAssetsUVs(),this.#ut(),await this.#dt("_onDraw"),Hooks$1.callAll("canvasDraw",this);for(const e of Object.keys(g.Canvas.groups)){const t=this[e];try{await t.draw()}catch(t){return Hooks$1.onError("Canvas#draw",t,{msg:`Failed drawing ${e} canvas group: ${t.message}`,log:"error",notify:"error"}),void(this.loading=!1)}}const o=canvas.dimensions.rect;this.masks.canvas.clear().beginFill(16777215,1).drawRect(o.x,o.y,o.width,o.height).endFill(),this.primary.sprite.mask=this.primary.mask=this.effects.mask=this.interface.grid.mask=this.interface.templates.mask=this.masks.canvas;const r=canvas.dimensions.sceneRect;this.masks.scene.clear().beginFill(16777215,1).drawRect(r.x,r.y,r.width,r.height).endFill(),await this.#ht(),this.#Ke._view=!0,this.stage.visible=!0,await this.#dt("_onReady"),Hooks$1.call("canvasReady",this),this.loading=!1,await this.#pt(!0),MouseInteractionManager.emulateMoveEvent()}async tearDown(){this.stage.visible=!1,this.stage.filters=null,this.sceneTextures={},this.blurOptions=void 0,this.#Xe={scene:this.#Ke.id,layer:this.activeLayer?.options.name,controlledTokens:this.tokens.controlled.map((e=>e.id)),targetedTokens:Array.from(c.user.targets).map((e=>e.id))},this.#gt(),this.deactivateFPSMeter();for(let e of this.layers.reverse())e instanceof InteractionLayer&&e.deactivate();await this.#pt(!1),await this.#dt("_deactivateHooks"),await this.#dt("_onTearDown"),Hooks$1.callAll("canvasTearDown",this);for(const e of Object.keys(g.Canvas.groups).reverse()){const t=this[e];await t.tearDown()}await this.effects.tearDown();for(let e of this.layers.reverse())await e.tearDown();this.edges.clear(),this.blurFilters.clear(),this.app.renderer.events.rootBoundary=new PIXI.EventBoundary(this.stage),MouseInteractionManager.emulateMoveEvent()}async#pt(e){const t=await Promise.allSettled(this.scene.regions.map((t=>t._handleEvent({name:CONST.REGION_EVENTS.BEHAVIOR_STATUS,data:{viewed:e},region:t,user:c.user}))));for(const e of t)"rejected"===e.status&&console.error(e.reason)}static getSceneManager(e){const t=g.Canvas.managedScenes[e.id];return t?new t(e):null}#ct(){console.log(`${l} | Skipping game canvas - no active scene.`),canvas.app.view.style.display="none",ui.controls.render(),this.loading=this.#g=!1,this.#qe=null,this.#Je=null,MouseInteractionManager.emulateMoveEvent()}getGLParameter(e){const t=this.app.renderer.context.gl;return t.getParameter(t[e])}async#ht(){this.#g=!0,c.user.targets.clear(),this.hud.render(!0),this.#mt(),this.#ft(),this._onResize(),this.#Xe={},this.edges.initialize(),this.perception.initialize(),c.user.viewedScene=this.#Ke.id,c.user.broadcastActivity({sceneId:this.#Ke.id,cursor:null,ruler:null,targets:[]}),c.socket.emit("getUserActivity"),this.#vt(),canvas.primary.sortChildren()}initializeCanvasPosition(){let e=this.#Ke._viewPosition;if(foundry.utils.isEmpty(e)){let{x:t,y:i,scale:n}=this.#Ke.initial;const s=this.dimensions.rect;t??=s.right/2,i??=s.bottom/2,n??=Math.clamp(Math.min(window.innerHeight/s.height,window.innerWidth/s.width),.25,3),e={x:t,y:i,scale:n}}this.pan(e)}#mt(){(this[this.#Xe.layer]??this.tokens).activate()}#ft(){let e=null,t=[],i=[],n=this.#Xe.scene===this.#Ke.id;if(n)t=this.#Xe.controlledTokens.map((e=>canvas.tokens.get(e))),i=this.#Xe.targetedTokens.map((e=>canvas.tokens.get(e)));else if(!c.user.isGM&&(t=c.user.character?.getActiveTokens()||[],t.length||(t=canvas.tokens.placeables.filter((e=>e.actor?.testUserPermission(c.user,"OWNER")))),!t.length)){e=canvas.tokens.placeables.filter((e=>e.actor?.testUserPermission(c.user,"OBSERVER"))).shift()||null}for(let i of t)e||(e=i),i?.control({releaseOthers:!1});c.user.isGM||!this.#Ke.tokenVision||canvas.effects.visionSources.size||ui.notifications.warn("TOKEN.WarningNoVision",{localize:!0});for(const e of i)e?.setTarget(!0,{releaseOthers:!1,groupSelection:!0});e&&!n&&this.pan({x:e.center.x,y:e.center.y,duration:250})}async#dt(e){if(!this.#qe)return;const t=this.#qe[e];try{if(!(t instanceof Function))return void console.error(`Invalid SceneManager function name "${e}"`);await t.call(this.#qe)}catch(t){t.message=`${this.#qe.constructor.name}#${e} failed with error: ${t.message}`,console.error(t)}}getLayerByEmbeddedName(e){return{AmbientLight:this.lighting,AmbientSound:this.sounds,Drawing:this.drawings,MeasuredTemplate:this.templates,Note:this.notes,Region:this.regions,Tile:this.tiles,Token:this.tokens,Wall:this.walls}[e]||null}getCollectionLayer(e){return{drawings:this.drawings,lights:this.lighting,notes:this.notes,regions:this.regions,sounds:this.sounds,templates:this.templates,tiles:this.tiles,tokens:this.tokens,walls:this.walls}[e]}activateFPSMeter(){this.deactivateFPSMeter(),this.#g&&(this.fps.element.style.display="block",this.app.ticker.add(this.#yt,this,PIXI.UPDATE_PRIORITY.LOW))}deactivateFPSMeter(){this.app.ticker.remove(this.#yt,this),this.fps.element.style.display="none"}#yt(){const e=this.app.ticker.lastTime;if(this.fps.values.push(1e3/this.app.ticker.elapsedMS),this.fps.values.length>60&&this.fps.values.shift(),e-this.fps.render<250)return;if(!this.fps.element)return;const t=this.fps.values.reduce(((e,t)=>t+e),0);this.fps.average=t/this.fps.values.length,this.fps.element.innerHTML=`<label>FPS:</label> <span>${this.fps.average.toFixed(2)}</span>`,this.fps.render=e}pan({x:e=null,y:t=null,scale:i=null}={}){const n=this._constrainView({x:e,y:t,scale:i}),s=n.scale!==this.stage.scale.x;this.stage.pivot.set(n.x,n.y),s&&(this.stage.scale.set(n.scale,n.scale),this.updateBlur()),this.scene._viewPosition=n,Hooks$1.callAll("canvasPan",this,n),this.controls._onCanvasPan(),this.hud.align(),this.hidden.invalidateMasks(),this.effects.illumination.invalidateDarknessLevelContainer(),MouseInteractionManager.emulateMoveEvent()}async animatePan({x:e,y:t,scale:i,duration:n=250,speed:s,easing:o}={}){if(s){let i=new Ray(this.stage.pivot,{x:e,y:t});n=Math.round(1e3*i.distance/s)}const r={...this.scene._viewPosition},a=this._constrainView({x:e,y:t,scale:i});return CanvasAnimation.animate([{parent:r,attribute:"x",to:a.x},{parent:r,attribute:"y",to:a.y},{parent:r,attribute:"scale",to:a.scale}],{name:"canvas.animatePan",duration:n,easing:o??CanvasAnimation.easeInOutCosine,ontick:()=>this.pan(r)})}async recenter(e){e&&this.pan(e);const t=this.dimensions.sceneRect;return this.animatePan({x:t.x+window.innerWidth/2,y:t.y+window.innerHeight/2,duration:250})}highlightObjects(e){if(this.#g){for(let t of this.layers)if(t.objects&&t.interactiveChildren){t.highlightObjects=e;for(let e of t.placeables)e.renderFlags.set({refreshState:!0})}canvas.tokens.occlusionMode&CONST.TOKEN_OCCLUSION_MODES.HIGHLIGHTED&&canvas.perception.update({refreshOcclusion:!0}),Hooks$1.callAll("highlightObjects",e)}}async ping(e,t){if(!this.dimensions.rect.contains(e.x,e.y))return!1;const i=g.Canvas.pings.types,n=c.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT),s=c.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT);let o=i.PULSE;n?o=i.PULL:s&&(o=i.ALERT);let r={scene:this.scene?.id,pull:n,style:o,zoom:canvas.stage.scale.x};r=foundry.utils.mergeObject(r,t);const a={cursor:e,ping:r};return c.user.broadcastActivity(a),this.controls.handlePing(c.user,e,r)}_constrainView({x:e,y:t,scale:i}){Number.isNumeric(e)||(e=this.stage.pivot.x),Number.isNumeric(t)||(t=this.stage.pivot.y),Number.isNumeric(i)||(i=this.stage.scale.x);const n=canvas.dimensions,s=g.Canvas.maxZoom,o=1/Math.max(n.width/window.innerWidth,n.height/window.innerHeight,s);i=Math.clamp(i,o,s);const r=window.innerWidth/i*.4,a=window.innerHeight/i*.4;return{x:e=Math.clamp(e,-r,n.width+r),y:t=Math.clamp(t,-a,n.height+a),scale:i}}createBlurFilter(e,t=g.Canvas.blurQuality){const i=e??this.blur.strength??g.Canvas.blurStrength,n=new PIXI.BlurFilter(i,t);return n._configuredStrength=i,this.addBlurFilter(n),n}addBlurFilter(e){if(void 0!==e.blur)return e.blur=(e._configuredStrength??this.blur.strength??g.Canvas.blurStrength)*this.stage.scale.x,this.blurFilters.add(e),e}updateBlur(e){for(const t of this.blurFilters)t.blur=(e??t._configuredStrength??this.blur.strength??g.Canvas.blurStrength)*this.stage.scale.x}clientCoordinatesFromCanvas(e){const t={x:e.x,y:e.y};return this.stage.worldTransform.apply(t,t)}canvasCoordinatesFromClient(e){const t={x:e.x,y:e.y};return this.stage.worldTransform.applyInverse(t,t)}isOffscreen(e){const{clientWidth:t,clientHeight:i}=document.documentElement,{x:n,y:s}=this.clientCoordinatesFromCanvas(e);return n<0||s<0||n>=t||s>=i}static clearContainer(e,t=!0){const i=e.removeChildren();for(const e of i)e.clear?e.clear(t):e.tearDown?e.tearDown():e.destroy(t)}static getRenderTexture({clearColor:e,textureConfiguration:t}={}){const i=PIXI.RenderTexture.create(t);return e&&(i.baseTexture.clearColor=e),i}#vt(){this.stage.removeAllListeners();const e={clickLeft:this.#bt.bind(this),clickLeft2:this.#St.bind(this),clickRight:this.#Tt.bind(this),clickRight2:this.#Et.bind(this),dragLeftStart:this.#Ct.bind(this),dragLeftMove:this.#_t.bind(this),dragLeftDrop:this.#It.bind(this),dragLeftCancel:this.#wt.bind(this),dragRightStart:this._onDragRightStart.bind(this),dragRightMove:this._onDragRightMove.bind(this),dragRightDrop:this._onDragRightDrop.bind(this),dragRightCancel:this._onDragRightCancel.bind(this),longPress:this.#Dt.bind(this)},t={clickRight2:!1,dragLeftStart:this.#Ot.bind(this)},i=new MouseInteractionManager(this.stage,this.stage,t,e);this.mouseInteractionManager=i.activate(),c.settings.get("core","fpsMeter")&&this.activateFPSMeter(),this.dt=0,this.stage.on("pointermove",(e=>{e.getLocalPosition(this.stage,this.mousePosition),this.#He()}))}#ze(){this.controls._onMouseMove(),this.sounds._onMouseMove(),this.primary._onMouseMove()}#bt(e){const t=this.activeLayer;if(t instanceof InteractionLayer)return t._onClickLeft(e)}#St(e){const t=this.activeLayer;if(t instanceof InteractionLayer)return t._onClickLeft2(e)}#Dt(e,t){canvas.controls._onLongPress(e,t)}#Ot(e,t){const i=this.activeLayer;return i instanceof TokenLayer&&g.Canvas.rulerClass.canMeasure?!this.controls.ruler.active:!!["select","target"].includes(c.activeTool)||i instanceof InteractionLayer&&i._canDragLeftStart(e,t)}#Ct(e){const t=this.activeLayer;if(t instanceof TokenLayer&&g.Canvas.rulerClass.canMeasure)return e.interactionData.ruler=!0,this.controls.ruler._onDragStart(e);return["select","target"].includes(c.activeTool)?(delete e.interactionData.coords,void(canvas.controls.select.active=!0)):t instanceof InteractionLayer?t._onDragLeftStart(e):void 0}#_t(e){const t=this.activeLayer;if(this._onDragCanvasPan(e),e.interactionData.ruler)return this.controls.ruler._onMouseMove(e);return["select","target"].includes(c.activeTool)&&canvas.controls.select.active?this.#xt(e):t instanceof InteractionLayer?t._onDragLeftMove(e):void 0}#It(e){const t=e.interactionData.coords,i=c.activeTool,n=canvas.activeLayer;if(e.interactionData.ruler)return canvas.controls.ruler._onMouseUp(e);const s=["select","target"].includes(i),o=c.keyboard.isCoreActionKeyActive("target");if(s&&canvas.controls.select.active&&n instanceof PlaceablesLayer){canvas.controls.select.clear(),canvas.controls.select.active=!1;const s=!e.shiftKey;if(!t)return;if("select"===i&&!o)return n.selectObjects(t,{releaseOthers:s});if("target"===i||o)return n.targetObjects(t,{releaseOthers:s})}return n instanceof InteractionLayer?n._onDragLeftDrop(e):void 0}#wt(e){const t=canvas.activeLayer,i=c.activeTool;if(e.interactionData.ruler){const e=canvas.controls.ruler;return!e.active||e.state===Ruler.STATES.MOVING}if(!["select","target"].includes(i))return t instanceof InteractionLayer?t._onDragLeftCancel(e):void 0;canvas.controls.select.clear()}#Tt(e){const t=canvas.controls.ruler;if(t.state===Ruler.STATES.MEASURING)return t._onClickRight(e);const i=this.activeLayer;return i instanceof InteractionLayer?i._onClickRight(e):void 0}#Et(e){const t=this.activeLayer;if(t instanceof InteractionLayer)return t._onClickRight2(e)}_onDragRightStart(e){}_onDragRightMove(e){const{origin:t,destination:i}=e.interactionData,n=i.x-t.x,s=i.y-t.y;this.pan({x:canvas.stage.pivot.x-n*g.Canvas.dragSpeedModifier,y:canvas.stage.pivot.y-s*g.Canvas.dragSpeedModifier}),this.tokens._tabIndex=null}_onDragRightDrop(e){}_onDragRightCancel(e){}#xt(e){const{origin:t,destination:i}=e.interactionData;let n={x:Math.min(t.x,i.x),y:Math.min(t.y,i.y),width:Math.abs(i.x-t.x),height:Math.abs(i.y-t.y)};canvas.controls.drawSelect(n),e.interactionData.coords=n}_onDragCanvasPan(e){const t=Date.now();if(t-(this._panTime||0)<=200)return;this._panTime=t;const{x:i,y:n}=e,s=3*this.dimensions.size/this.stage.scale.x;let o=0;i<50?o=-s:i>window.innerWidth-50&&(o=s);let r=0;return n<50?r=-s:n>window.innerHeight-50&&(r=s),o||r?this.animatePan({x:this.stage.pivot.x+o,y:this.stage.pivot.y+r,duration:200}):void 0}_onResize(e=null){if(!this.#g)return!1;this.app.renderer.resize(window.innerWidth,window.innerHeight);const t=this.screenDimensions[0]=this.app.renderer.screen.width,i=this.screenDimensions[1]=this.app.renderer.screen.height;this.stage.position.set(t/2,i/2),this.pan(this.stage.pivot)}_onMouseWheel(e){let t=e.delta<0?1.05:.95;this.pan({scale:t*canvas.stage.scale.x})}_onDrop(e){e.preventDefault();const t=TextEditor$1.getDragEventData(e);if(!t.type)return;const{x:i,y:n}=this.canvasCoordinatesFromClient({x:e.clientX,y:e.clientY});t.x=i,t.y=n;if(!1!==Hooks$1.call("dropCanvasData",this,t))switch(t.type){case"Actor":return canvas.tokens._onDropActorData(e,t);case"JournalEntry":case"JournalEntryPage":return canvas.notes._onDropData(e,t);case"Macro":return c.user.assignHotbarMacro(null,Number(t.slot));case"PlaylistSound":return canvas.sounds._onDropData(e,t);case"Tile":return canvas.tiles._onDropData(e,t)}}pendingRenderFlags;#Nt={};#ut(){const e=PIXI.UPDATE_PRIORITY;Object.assign(e,{OBJECTS:e.HIGH-2,PRIMARY:e.NORMAL+3,PERCEPTION:e.NORMAL+2}),Object.defineProperty(this,"pendingRenderFlags",{value:{OBJECTS:new Set,PERCEPTION:new Set},configurable:!0,writable:!1}),this.#Nt.OBJECTS=this.#At.bind(this,this.pendingRenderFlags.OBJECTS),this.app.ticker.add(this.#Nt.OBJECTS,void 0,e.OBJECTS),this.#Nt.PRIMARY=this.primary.update.bind(this.primary),this.app.ticker.add(this.#Nt.PRIMARY,void 0,e.PRIMARY),this.#Nt.PERCEPTION=this.#At.bind(this,this.pendingRenderFlags.PERCEPTION),this.app.ticker.add(this.#Nt.PERCEPTION,void 0,e.PERCEPTION)}#gt(){for(const e of Object.values(this.pendingRenderFlags))e.clear();for(const[e,t]of Object.entries(this.#Nt))canvas.app.ticker.remove(t),delete this.#Nt[e]}#At(e){if(!e.size)return;const t=Array.from(e);e.clear();for(const e of t)e.applyRenderFlags()}#rt(e){const t={},i=e?.gl;if(!(i instanceof WebGL2RenderingContext))return t.webGL2=!1,t;let n;t.webGL2=!0,n=PIXI.RenderTexture.create({width:1,height:1,format:PIXI.FORMATS.RED,type:PIXI.TYPES.UNSIGNED_BYTE,resolution:1,multisample:PIXI.MSAA_QUALITY.NONE}),e.renderTexture.bind(n);const s=i.getParameter(i.IMPLEMENTATION_COLOR_READ_FORMAT),o=i.getParameter(i.IMPLEMENTATION_COLOR_READ_TYPE);t.readPixelsRED=s===i.RED&&o===i.UNSIGNED_BYTE,e.renderTexture.bind(),n?.destroy(!0);try{t.offscreenCanvas="undefined"!=typeof OffscreenCanvas&&!!new OffscreenCanvas(10,10).getContext("2d")}catch(e){t.offscreenCanvas=!1}return t}addPendingOperation(e,t,i,n){foundry.utils.logCompatibilityWarning("Canvas#addPendingOperation is deprecated without replacement in v11. The callback that you have passed as a pending operation has been executed immediately. We recommend switching your code to use a debounce operation or RenderFlags to de-duplicate overlapping requests.",{since:11,until:13}),t.call(i,...n)}triggerPendingOperations(){foundry.utils.logCompatibilityWarning("Canvas#triggerPendingOperations is deprecated without replacement in v11 and performs no action.",{since:11,until:13})}get pendingOperations(){return foundry.utils.logCompatibilityWarning("Canvas#pendingOperations is deprecated without replacement in v11.",{since:11,until:13}),[]}get colorManager(){return foundry.utils.logCompatibilityWarning("Canvas#colorManager is deprecated and replaced by Canvas#environment",{since:12,until:14}),this.environment}}class PlaceableObject extends(RenderFlagsMixin(PIXI.Container)){constructor(e){if(super(),!(e instanceof foundry.abstract.Document&&e.isEmbedded))throw new Error("You must provide an embedded Document instance as the input for a PlaceableObject");this.scene=e.parent,this.document=e,this.controlIcon=null,this.mouseInteractionManager=null,this.cullable=!0}static embeddedName;static RENDER_FLAGS={redraw:{propagate:["refresh"]},refresh:{propagate:["refreshState"],alias:!0},refreshState:{}};get _original(){return this.#Rt}#Rt;#Pt;#Ve=Promise.resolve(this);#kt=!1;get isOwner(){return this.document.isOwner}get interactionState(){return this._original?.mouseInteractionManager?.state??this.mouseInteractionManager?.state}get bounds(){throw new Error("Each subclass of PlaceableObject must define its own bounds rectangle")}get center(){const e=this.document;return"width"in e&&"height"in e?new PIXI.Point(e.x+e.width/2,e.y+e.height/2):new PIXI.Point(e.x,e.y)}get id(){return this.document.id}get objectId(){let e=`${this.document.documentName}.${this.document.id}`;return this.isPreview&&(e+=".preview"),e}get sourceId(){return`${this.document.documentName}.${this._original?.id??this.document.id??"preview"}`}get isPreview(){return!!this._original||!this.document.id}get hasPreview(){return!!this._preview}get layer(){return this.document.layer}get sheet(){return this.document.sheet}get controlled(){return this.#Mt}#Mt=!1;get hover(){return this.#Lt}set hover(e){this.#Lt="boolean"==typeof e&&e}#Lt=!1;get hasActiveHUD(){return this.layer.hud?.object===this}getSnappedPosition(e){return this.layer.getSnappedPoint(e??this.document)}applyRenderFlags(){if(!this.renderFlags.size||this._destroyed)return;const e=this.renderFlags.clear();e.redraw?this.draw():this.#kt&&(this._applyRenderFlags(e),Hooks$1.callAll(`refresh${this.document.documentName}`,this,e))}_applyRenderFlags(e){}clear(){return this.removeChildren().forEach((e=>e.destroy({children:!0}))),this}destroy(e){return this.mouseInteractionManager?.cancel(),MouseInteractionManager.emulateMoveEvent(),this._original&&(this._original._preview=void 0),this.document._object=null,this.document._destroyed=!0,this.controlIcon&&this.controlIcon.destroy(),this.renderFlags.clear(),Hooks$1.callAll(`destroy${this.document.documentName}`,this),this._destroy(e),super.destroy(e)}_destroy(e){}async draw(e={}){return this.#Ve=this.#Ve.finally((async()=>{this.#kt=!1;const t=this.visible,i=this.renderable;this.visible=!1,this.renderable=!1,this.clear(),this.mouseInteractionManager?.cancel(),MouseInteractionManager.emulateMoveEvent(),await this._draw(e),Hooks$1.callAll(`draw${this.document.documentName}`,this),this.renderFlags.set({refresh:!0}),this.id&&this.activateListeners(),this.visible=t,this.renderable=i,this.#kt=!0,MouseInteractionManager.emulateMoveEvent()}))}async _draw(e){throw new Error(`The ${this.constructor.name} subclass of PlaceableObject must define the _draw method`)}async _partialDraw(e){return this.#Ve=this.#Ve.finally((async()=>{this.#kt&&await e()}))}refresh(e={}){return this.renderFlags.set({refresh:!0}),this}_updateQuadtree(){const e=this.layer;if(!e.quadtree||this.isPreview)return;if(this.destroyed||this.parent!==e.objects)return this.#Pt=void 0,void e.quadtree.remove(this);const t=this.bounds;this.#Pt&&t.x===this.#Pt.x&&t.y===this.#Pt.y&&t.width===this.#Pt.width&&t.height===this.#Pt.height||(this.#Pt=t,e.quadtree.update({r:t,t:this}))}_overlapsSelection(e){const{x:t,y:i}=this.center;return e.contains(t,i)}_getTargetAlpha(){return this._original?.mouseInteractionManager?.isDragging??this.mouseInteractionManager?.isDragging?this.isPreview?.8:this.hasPreview?.4:1:1}_onCreate(e,t,i){}_onUpdate(e,t,i){this._updateQuadtree(),this.parent&&("elevation"in e||"sort"in e)&&(this.parent.sortDirty=!0)}_onDelete(e,t){this.release({trigger:!1});const i=this.layer;i.hover===this&&(i.hover=null),this.destroy({children:!0})}control(e={}){if(!this.layer.options.controllableObjects)return!1;if(!1!==e.releaseOthers)for(let e of this.layer.controlled)e!==this&&e.release();return!(!this.#Mt&&this.id)||!!this.can(c.user,"control")&&(this.#Mt=!0,this.layer.controlledObjects.set(this.id,this),this._onControl(e),Hooks$1.callAll(`control${this.constructor.embeddedName}`,this,this.#Mt),!0)}_onControl(e){this.renderFlags.set({refreshState:!0})}release(e={}){return this.layer.controlledObjects.delete(this.id),!this.#Mt||(this.#Mt=!1,this._onRelease(e),Hooks$1.callAll(`control${this.constructor.embeddedName}`,this,this.#Mt),!0)}_onRelease(e){const t=this.layer;this.hover=!1,this===t.hover&&(t.hover=null),this.hasActiveHUD&&t.hud.clear(),this.renderFlags.set({refreshState:!0})}clone(){const e=this.document.clone({},{keepId:!0}),t=new this.constructor(e);return e._object=t,t.#Rt=this,t.eventMode="none",t.#Mt=this.#Mt,this._preview=t,t}async rotate(e,t){if(!this.document.schema.has("rotation"))return this;if(c.paused&&!c.user.isGM)return ui.notifications.warn("GAME.PausedWarning",{localize:!0}),this;const i=this._updateRotation({angle:e,snap:t});return await this.document.update({rotation:i}),this}_updateRotation({angle:e,delta:t=0,snap:i=0}={}){let n=Number.isNumeric(e)?e:this.document.rotation+t;return i>0&&(n=n.toNearest(i)),Math.normalizeDegrees(n)}_getShiftedPosition(e,t){const{x:i,y:n}=this.document,s=this.getSnappedPosition(),o=CONST.MOVEMENT_DIRECTIONS;let r=0;e<0?i<=s.x+.5&&(r|=o.LEFT):e>0&&i>=s.x-.5&&(r|=o.RIGHT),t<0?n<=s.y+.5&&(r|=o.UP):t>0&&n>=s.y-.5&&(r|=o.DOWN);const a=this.scene.grid;let l=0,c=0;a.isHexagonal&&(a.columns?c=1:l=1),s.x+=l,s.y+=c;const d=a.getShiftedPoint(s,r);return d.x-=l,d.y-=c,d}activateListeners(){const e=this._createInteractionManager();this.mouseInteractionManager=e.activate()}_createInteractionManager(){const e={hoverIn:this._canHover,clickLeft:this._canControl,clickLeft2:this._canView,clickRight:this._canHUD,clickRight2:this._canConfigure,dragStart:this._canDrag,dragLeftStart:this._canDragLeftStart},t={hoverIn:this._onHoverIn,hoverOut:this._onHoverOut,clickLeft:this._onClickLeft,clickLeft2:this._onClickLeft2,clickRight:this._onClickRight,clickRight2:this._onClickRight2,unclickLeft:this._onUnclickLeft,unclickRight:this._onUnclickRight,dragLeftStart:this._onDragLeftStart,dragLeftMove:this._onDragLeftMove,dragLeftDrop:this._onDragLeftDrop,dragLeftCancel:this._onDragLeftCancel,dragRightStart:this._onDragRightStart,dragRightMove:this._onDragRightMove,dragRightDrop:this._onDragRightDrop,dragRightCancel:this._onDragRightCancel,longPress:this._onLongPress},i={target:this.controlIcon?"controlIcon":null};return new MouseInteractionManager(this,canvas.stage,e,t,i)}can(e,t){const i=this[`_can${t.titleCase()}`];return!!i&&i.call(this,e)}_canHUD(e,t){return this.isOwner}_canConfigure(e,t){return this.document.canUserModify(e,"update")}_canControl(e,t){return!(!this.layer.active||this.isPreview)&&this.document.canUserModify(e,"update")}_canView(e,t){return this.document.testUserPermission(e,"LIMITED")}_canCreate(e,t){return e.isGM}_canDrag(e,t){return this._canControl(e,t)}_canDragLeftStart(e,t){return c.paused&&!c.user.isGM?(ui.notifications.warn("GAME.PausedWarning",{localize:!0}),!1):!this.document.schema.has("locked")||!this.document.locked||(ui.notifications.warn(c.i18n.format("CONTROLS.ObjectIsLocked",{type:c.i18n.localize(this.document.constructor.metadata.label)})),!1)}_canHover(e,t){return this._canControl(e,t)}_canUpdate(e,t){return this._canControl(e,t)}_canDelete(e,t){return this._canControl(e,t)}_onHoverIn(e,{hoverOutOthers:t=!1}={}){if(this.hover)return;if(3&e.buttons)return;const i=this.layer;if(i.hover=this,t)for(const t of i.placeables)t!==this&&t._onHoverOut(e);this.hover=!0,this.renderFlags.set({refreshState:!0}),Hooks$1.callAll(`hover${this.constructor.embeddedName}`,this,this.hover)}_onHoverOut(e){if(!this.hover)return;this.layer.hover=null,this.hover=!1,this.renderFlags.set({refreshState:!0}),Hooks$1.callAll(`hover${this.constructor.embeddedName}`,this,this.hover)}_propagateLeftClick(e){return!1}_onClickLeft(e){this.layer.hud?.clear(),this.#Mt?e.shiftKey&&(e.interactionData.release=!0):this.control({releaseOthers:!e.shiftKey}),this._propagateLeftClick(e)||e.stopPropagation()}_onUnclickLeft(e){!0===e.interactionData.release&&this.release(),this._propagateLeftClick(e)||e.stopPropagation()}_onClickLeft2(e){const t=this.sheet;t&&t.render(!0),this._propagateLeftClick(e)||e.stopPropagation()}_propagateRightClick(e){return!1}_onClickRight(e){if(this.layer.hud){const t=!this.#Mt&&!e.shiftKey;this.control({releaseOthers:t}),this.hasActiveHUD?this.layer.hud.clear():this.layer.hud.bind(this)}this._propagateRightClick(e)||e.stopPropagation()}_onUnclickRight(e){this._propagateRightClick(e)||e.stopPropagation()}_onClickRight2(e){const t=this.sheet;t&&t.render(!0),this._propagateRightClick(e)||e.stopPropagation()}_onDragLeftStart(e){const t=this.layer.options.controllableObjects?this.layer.controlled:[this],i=[];for(const n of t){if(!n._canDrag(c.user,e))continue;if(n.document.locked)continue;const t=n.clone();i.push(t),t._onDragStart(),t.visible=!1,this.layer.preview.addChild(t),t.draw().then((e=>e.visible=!0))}e.interactionData.clones=i}_onDragStart(){const e=this._original;e.document.locked=!0,e.renderFlags.set({refreshState:!0})}_onDragEnd(){const e=this._original;e&&(e.document.locked=e.document._source.locked,e.renderFlags.set({refreshState:!0}))}_onDragLeftMove(e){canvas._onDragCanvasPan(e);const{clones:t,destination:i,origin:n}=e.interactionData;let s={x:this.document.x+(i.x-n.x),y:this.document.y+(i.y-n.y)};e.shiftKey||(s=this.getSnappedPosition(s));const o=s.x-this.document.x,r=s.y-this.document.y;for(const i of t||[]){const t=i._original;let n={x:t.document.x+o,y:t.document.y+r};e.shiftKey||(n=this.getSnappedPosition(n)),i.document.x=n.x,i.document.y=n.y,i.renderFlags.set({refreshPosition:!0})}}_onDragLeftDrop(e){const{clones:t,destination:i}=e.interactionData;if(!t||!canvas.dimensions.rect.contains(i.x,i.y))return!1;e.interactionData.clearPreviewContainer=!1;const n=this._prepareDragLeftDropUpdates(e);n&&this.#Ft(n)}_prepareDragLeftDropUpdates(e){const t=[];for(const i of e.interactionData.clones){let n={x:i.document.x,y:i.document.y};e.shiftKey||(n=this.getSnappedPosition(n)),t.push({_id:i._original.id,x:n.x,y:n.y,rotation:i.document.rotation})}return t}async#Ft(e){for(const t of e){const e=this.document.collection.get(t._id);e&&(e.locked=e._source.locked)}await canvas.scene.updateEmbeddedDocuments(this.document.documentName,e),this.layer.clearPreviewContainer()}_onDragLeftCancel(e){!1!==e.interactionData.clearPreviewContainer&&this.layer.clearPreviewContainer()}_onDragRightStart(e){return canvas._onDragRightStart(e)}_onDragRightMove(e){return canvas._onDragRightMove(e)}_onDragRightDrop(e){return canvas._onDragRightDrop(e)}_onDragRightCancel(e){return canvas._onDragRightCancel(e)}_onLongPress(e,t){return canvas.controls._onLongPress(e,t)}}class TextureLoader{static CACHE_TTL=9e5;static#Ut=new Map;static#Bt=new WeakMap;static#Gt=Date.now().toString();static#jt=!1;static async initializeBasisTranscoder(){if(!this.#jt)return this.#jt=!0,await PIXI.TranscoderWorker.loadTranscoder("scripts/basis_transcoder.js","scripts/basis_transcoder.wasm")}static hasTextExtension(e){return new RegExp(`(\\.${Object.keys(CONST.TEXT_FILE_EXTENSIONS).join("|\\.")})(\\?.*)?`,"i").test(e)}static getTextureAlphaData(e,t=1){if(!e?.valid)return;const i=Math.ceil(Math.round(e.width*e.resolution)*t),n=Math.ceil(Math.round(e.height*e.resolution)*t),s=e.baseTexture,o=e.frame,r=`${o.x},${o.y},${o.width},${o.height},${i},${n}`;let a,l=this.#Bt.get(s);if(l&&(a=l.get(r)),a)return a;a={};const c=new PIXI.Sprite(e);c.width=a.width=i,c.height=a.height=n,c.anchor.set(0,0);const d=PIXI.RenderTexture.create({width:i,height:n});canvas.app.renderer.render(c,{renderTexture:d}),c.destroy(!1);const u=canvas.app.renderer.extract.pixels(d);d.destroy(!0);let h=i,p=n,g=0,m=0;for(let e=3,t=0;t<n;t++)for(let n=0;n<i;n++,e+=4){0!==u[e]&&(n<h&&(h=n),n>=g&&(g=n+1),t<p&&(p=t),t>=m&&(m=t+1))}h>g&&(h=p=g=m=0),a.minX=h,a.minY=p,a.maxX=g,a.maxY=m;const v=a.data=new Uint8Array((g-h)*(m-p));for(let e=0,t=p;t<m;t++)for(let n=h;n<g;n++,e++)v[e]=u[4*(i*t+n)+3];return l||(l=new Map,this.#Bt.set(s,l)),l.set(r,a),a}static loadSceneTextures(e,{expireCache:t=!0,additionalSources:i=[],maxConcurrent:n}={}){let s=[];e.background.src&&s.push(e.background.src),e.foreground&&s.push(e.foreground),e.fog.overlay&&s.push(e.fog.overlay),s=s.concat(e.tiles.reduce(((e,t)=>(t.texture.src&&e.push(t.texture.src),e)),[])),s.push(g.Token.ring.spritesheet),s=s.concat(e.tokens.reduce(((e,t)=>(t.texture.src&&e.push(t.texture.src),t.ring.enabled&&e.push(t.ring.subject.texture),e)),[])),s=s.concat(Object.values(g.controlIcons)),s=s.concat(g.statusEffects.map((e=>e.img??e.icon))),s.push(...Object.values(canvas.sceneTextures)),s.push(...i);const o=e.active||e.visible?e.navName||e.name:"...";return this.loader.load(s,{message:c.i18n.format("SCENES.Loading",{name:o}),expireCache:t,maxConcurrent:n})}async load(e,{message:t,expireCache:i=!1,maxConcurrent:n,displayProgress:s=!0}={}){const o={message:t,loaded:0,failed:0,total:(e=new Set(e)).size,pct:0};console.groupCollapsed(`${l} | Loading ${e.size} Assets`);const loadTexture=async e=>{try{await this.loadTexture(e),s&&TextureLoader.#$t(e,o)}catch(t){TextureLoader.#Z(e,o,t)}},r=[];if(n){const t=new foundry.utils.Semaphore(n);for(const i of e)r.push(t.add(loadTexture,i))}else for(const t of e)r.push(loadTexture(t));await Promise.allSettled(r),console.groupEnd(),i&&await this.expireCache()}async loadTexture(e){const loadAsset=async(e,t=!1)=>{if(t&&(e=TextureLoader.getCacheBustURL(e)),!e)return null;try{return await PIXI.Assets.load(e)}catch(i){if(t)throw i;return await loadAsset(e,!0)}};let t=await loadAsset(e);return t?.baseTexture?.valid?(t instanceof PIXI.Texture&&(t=t.baseTexture),this.setCache(e,t),t):null}static async fetchResource(e,{bustCache:t=!1}={}){const i=`Failed to load texture ${e}`,n=t?TextureLoader.getCacheBustURL(e):e;if(!n)throw new Error(`${i}: Invalid URL`);let s;try{s=await fetch(n,{mode:"cors",credentials:"same-origin"})}catch(n){if(!t)return this.fetchResource(e,{bustCache:!0});throw new Error(`${i}: CORS failure`)}if(!s.ok)throw new Error(`${i}: Server responded with ${s.status}`);return s.blob()}static#$t(e,t){t.loaded++,t.pct=Math.round(100*(t.loaded+t.failed)/t.total),SceneNavigation.displayProgressBar({label:t.message,pct:t.pct}),console.log(`Loaded ${e} (${t.pct}%)`)}static#Z(e,t,i){t.failed++,t.pct=Math.round(100*(t.loaded+t.failed)/t.total),SceneNavigation.displayProgressBar({label:t.message,pct:t.pct}),console.warn(`Loading failed for ${e} (${t.pct}%): ${i.message}`)}setCache(e,t){TextureLoader.#Ut.set(t,{src:e,time:Date.now()})}getCache(e){if(!e)return null;PIXI.Assets.cache.has(e)||(e=TextureLoader.getCacheBustURL(e)||e);let t=PIXI.Assets.get(e);return t?.baseTexture?.valid?(t instanceof PIXI.Texture&&(t=t.baseTexture),this.setCache(e,t),t):null}async expireCache(){const e=[],t=Date.now();for(const[i,{src:n,time:s}]of TextureLoader.#Ut.entries()){const o=i instanceof PIXI.Spritesheet?i.baseTexture:i;o&&!o.destroyed?t-s<=TextureLoader.CACHE_TTL||(console.log(`${l} | Expiring cached texture: ${n}`),e.push(PIXI.Assets.unload(n)),TextureLoader.#Ut.delete(i)):TextureLoader.#Ut.delete(i)}await Promise.allSettled(e)}static getCacheBustURL(e){const t=URL.parseSafe(e);return!!t&&(t.origin!==window.location.origin&&(t.searchParams.append("cors-retry",TextureLoader.#Gt),t.href))}async loadImageTexture(e){return foundry.utils.logCompatibilityWarning("TextureLoader#loadImageTexture is deprecated. Use TextureLoader#loadTexture instead.",{since:11,until:13}),this.loadTexture(e)}async loadVideoTexture(e){return foundry.utils.logCompatibilityWarning("TextureLoader#loadVideoTexture is deprecated. Use TextureLoader#loadTexture instead.",{since:11,until:13}),this.loadTexture(e)}static get textureBufferDataMap(){return foundry.utils.logCompatibilityWarning("TextureLoader.textureBufferDataMap is deprecated without replacement. Use TextureLoader.getTextureAlphaData to create a texture data map and cache it automatically, or create your own caching system.",{since:12,until:14}),this.#Ht}static#Ht=new Map}function getTexture(e){const t=TextureLoader.loader.getCache(e),i=t instanceof PIXI.Spritesheet?t.baseTexture:t;return i?.valid?t instanceof PIXI.Spritesheet?t:new PIXI.Texture(t):null}async function loadTexture(e,{fallback:t}={}){let i,n;try{i=await TextureLoader.loader.loadTexture(e);const t=i instanceof PIXI.Spritesheet?i.baseTexture:i;t?.valid||(n=new Error(`Invalid Asset ${e}`))}catch(t){t.message=`The requested asset ${e} could not be loaded: ${t.message}`,n=t}return n?(console.error(n),TextureLoader.hasTextExtension(e)?null:t?loadTexture(t):null):i instanceof PIXI.Spritesheet?i:new PIXI.Texture(i)}TextureLoader.loader=new TextureLoader;const CanvasGroupMixin=e=>class CanvasGroup extends e{constructor(...e){super(...e),this.sortableChildren=!0,this.layers=this._createLayers()}static groupName;static tearDownChildren=!0;get name(){let e=Object.getPrototypeOf(this.constructor),t=this.constructor.name;for(;e&&e!==CanvasGroup;)t=e.name,e=Object.getPrototypeOf(e);return t}get hookName(){return this.name}layers;_createLayers(){const e={};for(let[t,i]of Object.entries(g.Canvas.layers)){if(i.group!==this.constructor.groupName)continue;const n=e[t]=new i.layerClass;Object.defineProperty(this,t,{value:n,writable:!1}),t in canvas||Object.defineProperty(canvas,t,{value:n,writable:!1})}return e}#Ve=Promise.resolve(this);#kt=!1;async draw(e={}){return this.#Ve=this.#Ve.finally((async()=>{console.log(`${l} | Drawing the ${this.hookName} canvas group`),await this.tearDown(),await this._draw(e),Hooks$1.callAll(`draw${this.hookName}`,this),this.#kt=!0,MouseInteractionManager.emulateMoveEvent()}))}async _draw(e){for(const e of Object.values(this.layers))this.addChild(e),await e.draw()}async tearDown(e={}){return this.#kt?(this.#kt=!1,await this._tearDown(e),Hooks$1.callAll(`tearDown${this.hookName}`,this),MouseInteractionManager.emulateMoveEvent(),this):this}async _tearDown(e){for(const e of Object.values(this.layers).reverse())await e.tearDown(),this.removeChild(e);if(this.constructor.tearDownChildren)for(const e of this.removeChildren())e instanceof CachedContainer?e.clear():e.destroy({children:!0})}};Object.defineProperty(globalThis,"BaseCanvasMixin",{get:()=>(foundry.utils.logCompatibilityWarning("BaseCanvasMixin is deprecated in favor of CanvasGroupMixin",{since:12,until:14}),CanvasGroupMixin)});class CachedContainer extends PIXI.Container{constructor(e){super();const t=canvas.app?.renderer;this.#zt=this.createRenderTexture(),e&&(this.sprite=e),this.#Vt=this.#Wt.bind(this,t),t.on("resize",this.#Vt)}static textureConfiguration={};#Vt;_renderPaths=new Map;#Xt={renderTexture:void 0,sourceFrame:canvas.app.renderer.screen.clone()};clearColor=[0,0,0,1];displayed=!1;autoRender=!0;renderDirty=!0;get renderTexture(){return this.#zt}#zt;set alphaMode(e){this.#zt.baseTexture.alphaMode=e,this.#zt.baseTexture.update()}get sprite(){return this.#Yt}set sprite(e){if(e instanceof PIXI.Sprite||e instanceof SpriteMesh)e.texture=this.renderTexture,this.#Yt=e;else if(e)throw new Error("You may only bind a PIXI.Sprite or a SpriteMesh as the render target for a CachedContainer.")}#Yt;createRenderTexture({renderFunction:e,clearColor:t}={}){const i={},n=canvas.app.renderer,s=this.constructor.textureConfiguration,o=canvas.performance.mode>CONST.CANVAS_PERFORMANCE_MODES.MED?PIXI.SCALE_MODES.LINEAR:PIXI.SCALE_MODES.NEAREST,r=PIXI.RenderTexture.create({width:n.screen.width,height:n.screen.height,resolution:n.resolution,multisample:s.multisample??n.multisample,scaleMode:s.scaleMode??o,format:s.format??PIXI.FORMATS.RGBA});return i.renderFunction=e,i.clearColor=t,this._renderPaths.set(r,i),this.renderDirty=!0,r}removeRenderTexture(e,t=!0){this._renderPaths.delete(e),t&&e?.destroy(!0),this.renderDirty=!0}clear(e=!0){return Canvas.clearContainer(this,e),this}destroy(e){this.#Vt&&canvas.app.renderer.off("resize",this.#Vt);for(const[e]of this._renderPaths)e?.destroy(!0);this._renderPaths.clear(),super.destroy(e)}render(e){this.renderable&&((this.autoRender||this.renderDirty)&&(this.renderDirty=!1,this.#Kt(e),super.render(e),this.#qt(e),this.#Jt(e)),this.#Yt?.render(e),this.displayed&&super.render(e))}#qt(e){if(!(this._renderPaths.size<=1))for(const[t,i]of this._renderPaths)i.renderFunction&&(this.#Qt(e,t,i.clearColor),i.renderFunction.call(this,e))}#Kt(e){const t=this.renderTexture,i=e.renderTexture;this.#Xt.renderTexture=i.current,this.#Xt.sourceFrame.copyFrom(i.sourceFrame),this.#Qt(e,t)}#Qt(e,t,i){const n=e.renderTexture;e.batch.flush(),n.bind(t,void 0,void 0),n.clear(i??this.clearColor);const s=e.filter.defaultFilterStack;s.length>1&&(s[s.length-1].renderTexture=t)}#Jt(e){e.batch.flush();const t=e.filter.defaultFilterStack;t.length>1&&(t[t.length-1].renderTexture=this.#Xt.renderTexture),e.renderTexture.bind(this.#Xt.renderTexture,this.#Xt.sourceFrame,void 0),this.#Xt.renderTexture=void 0}#Wt(e){for(const[t]of this._renderPaths)CachedContainer.resizeRenderTexture(e,t);this.#Yt&&this.#Yt._boundsID++,this.renderDirty=!0}static resizeRenderTexture(e,t){const i=e?.screen;t&&i&&(t.baseTexture.resolution!==e.resolution&&(t.baseTexture.resolution=e.resolution),t.width===i.width&&t.height===i.height||t.resize(i.width,i.height))}}function FullCanvasObjectMixin(e){return class FullCanvasObject extends e{calculateBounds(){const e=this._bounds,{x:t,y:i,width:n,height:s}=canvas.dimensions.rect;e.clear(),e.addFrame(this.transform,t,i,t+n,i+s),e.updateID=this._boundsID}}}FullCanvasObjectMixin(PIXI.Container);class PointSourceMesh extends PIXI.Mesh{static _priorBlendMode;static _currentTexture;_worldID=-1;_updateID=-1;get geometry(){return super.geometry}set geometry(e){this._geometry!==e&&(this._updateID=-1),super.geometry=e}addChild(){throw new Error("You can't add children to a PointSourceMesh.")}addChildAt(){throw new Error("You can't add children to a PointSourceMesh.")}_render(e){if(void 0!==this.uniforms.framebufferTexture){if(canvas.blur.enabled){this.state.blendMode!==PointSourceMesh._priorBlendMode&&void 0!==PointSourceMesh._priorBlendMode&&(PointSourceMesh._currentTexture=canvas.snapshot.getFramebufferTexture(e)),PointSourceMesh._priorBlendMode=this.state.blendMode}this.uniforms.framebufferTexture=PointSourceMesh._currentTexture}super._render(e)}calculateBounds(){const{transform:e,geometry:t}=this;if(this._worldID!==e._worldID||this._updateID!==t.buffers[0]._updateID){this._worldID=e._worldID,this._updateID=t.buffers[0]._updateID;const{x:i,y:n,width:s,height:o}=this.geometry.bounds;this._bounds.clear(),this._bounds.addFrame(e,i,n,i+s,n+o)}this._bounds.updateID=this._boundsID}_calculateBounds(){this.calculateBounds()}getLocalBounds(e){return e??=this._localBoundsRect??=new PIXI.Rectangle,this.geometry.bounds.copyTo(e)}}class QuadMesh extends PIXI.Container{constructor(e){if(super(),!AbstractBaseShader.isPrototypeOf(e))throw new Error("QuadMesh shader class must inherit from AbstractBaseShader.");this.#Zt=e.create()}#ei=(new PIXI.Geometry).addAttribute("aVertexPosition",[0,0,1,0,1,1,0,1],2).addIndex([0,1,2,0,2,3]);get shader(){return this.#Zt}#Zt;get blendMode(){return this.#ti.blendMode}set blendMode(e){this.#ti.blendMode=e}#ti=PIXI.State.for2d();setShaderClass(e){if(!AbstractBaseShader.isPrototypeOf(e))throw new Error("QuadMesh shader class must inherit from AbstractBaseShader.");this.#Zt.constructor!==e&&(this.#Zt=e.create())}_render(e){this.#Zt._preRender(this,e),this.#Zt.uniforms.translationMatrix=this.transform.worldTransform.toArray(!0),e.batch.flush(),e.state.set(this.#ti),e.shader.bind(this.#Zt),e.geometry.bind(this.#ei,this.#Zt),e.geometry.draw(PIXI.DRAW_MODES.TRIANGLES)}_calculateBounds(){this._bounds.addFrame(this.transform,0,0,1,1)}containsPoint(e){return this.getBounds().contains(e.x,e.y)}destroy(e){super.destroy(e),this.#ei.dispose(),this.#ei=null,this.#Zt=null,this.#ti=null}}class Quadtree{constructor(e,{maxObjects:t=20,maxDepth:i=4,_depth:n=0,_root:s}={}){this.bounds=new PIXI.Rectangle(e.x,e.y,e.width,e.height),this.maxObjects=t,this.maxDepth=i,this.depth=n,this.objects=[],this.nodes=[],this.root=s||this}static INDICES={tl:0,tr:1,bl:2,br:3};get all(){return this.nodes.length?this.nodes.reduce(((e,t)=>e.concat(t.all)),[]):this.objects}split(){const e=this.bounds,t=e.width/2,i=e.height/2,n={maxObjects:this.maxObjects,maxDepth:this.maxDepth,_depth:this.depth+1,_root:this.root};this.nodes[Quadtree.INDICES.tl]=new Quadtree(new PIXI.Rectangle(e.x,e.y,t,i),n),this.nodes[Quadtree.INDICES.tr]=new Quadtree(new PIXI.Rectangle(e.x+t,e.y,t,i),n),this.nodes[Quadtree.INDICES.bl]=new Quadtree(new PIXI.Rectangle(e.x,e.y+i,t,i),n),this.nodes[Quadtree.INDICES.br]=new Quadtree(new PIXI.Rectangle(e.x+t,e.y+i,t,i),n);for(let e of this.objects)e.n.delete(this),this.insert(e);return this.objects=[],this}clear(){this.objects=[];for(let e of this.nodes)e.clear();return this.nodes=[],this}insert(e){if(e.n=e.n||new Set,this.objects.length===this.maxObjects-1&&this.depth<this.maxDepth&&(this.nodes.length||this.split()),this.nodes.length){return this.getChildNodes(e.r).reduce(((t,i)=>t.concat(i.insert(e))),[])}return e.n.add(this),this.objects.push(e),[this]}remove(e){this.objects.findSplice((t=>t.t===e));for(let t of this.nodes)t.remove(e);return this}update(e){return this.remove(e.t),this.insert(e)}getObjects(e,{collisionTest:t,_s:i}={}){const n=i||new Set;if(this.nodes.length){const i=this.getChildNodes(e);for(let s of i)s.getObjects(e,{collisionTest:t,_s:n})}else for(let i of this.objects)!e.overlaps(i.r)||t&&!t(i,e)||n.add(i.t);return n}getLeafNodes(e){if(!this.nodes.length)return[this];return this.getChildNodes(e).reduce(((t,i)=>t.concat(i.getLeafNodes(e))),[])}getChildNodes(e){if(!this.nodes.length)return[this];const t=[],i=this.bounds.x+this.bounds.width/2,n=this.bounds.y+this.bounds.height/2,s=e.y<=n,o=e.x<=i,r=e.y+e.height>n,a=e.x+e.width>i;return o&&s&&t.push(this.nodes[Quadtree.INDICES.tl]),a&&s&&t.push(this.nodes[Quadtree.INDICES.tr]),o&&r&&t.push(this.nodes[Quadtree.INDICES.bl]),a&&r&&t.push(this.nodes[Quadtree.INDICES.br]),t}getAdjacentNodes(){const e=this.bounds.clone().pad(1);return this.root.getLeafNodes(e)}visualize({objects:e=!1}={}){const t=canvas.controls.debug;if(0===this.depth&&t.clear().endFill(),t.lineStyle(2,65280,.5).drawRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height),e)for(let e of this.objects)t.lineStyle(2,16711680,.5).drawRect(e.r.x,e.r.y,Math.max(e.r.width,1),Math.max(e.r.height,1));for(let t of this.nodes)t.visualize({objects:e})}}class CanvasQuadtree extends Quadtree{constructor(e={}){super({},e),Object.defineProperty(this,"bounds",{get:()=>canvas.dimensions.rect})}}class SpriteMesh extends PIXI.Container{constructor(e,t=BaseSamplerShader){if(super(),!foundry.utils.isSubclass(t,BaseSamplerShader))throw new Error("SpriteMesh shader class must be a subclass of BaseSamplerShader.");this._shader=t.create(),this.vertexData=this.#ei.buffers[0].data,this.uvs=this.#ei.buffers[1].data,this.indices=this.#ei.indexBuffer.data,this._texture=null,this._anchor=new PIXI.ObservablePoint(this._onAnchorUpdate,this,e?e.defaultAnchor.x:0,e?e.defaultAnchor.y:0),this.texture=e,this.isSprite=!0,this._batchData.vertexData=this.vertexData,this._batchData.indices=this.indices,this._batchData.uvs=this.uvs,this._batchData.object=this}static#ii=new PIXI.Rectangle;static#ni=new PIXI.Point;#ei=(new PIXI.Geometry).addAttribute("aVertexPosition",new PIXI.Buffer(new Float32Array(8),!1),2).addAttribute("aTextureCoord",new PIXI.Buffer(new Float32Array(8),!0),2).addIndex([0,1,2,0,2,3]);_batchData={_texture:void 0,vertexData:void 0,indices:void 0,uvs:void 0,worldAlpha:void 0,_tintRGB:void 0,blendMode:void 0,object:void 0};indices;_width=0;_height=0;_texture;_textureID=-1;_cachedTint=[1,1,1,1];_textureTrimmedID=-1;uvs;_anchor;vertexData;vertexTrimmedData=null;_transformID=-1;_transformTrimmedID=-1;_tintColor=new PIXI.Color(16777215);_tintRGB=16777215;_textureUvs=null;_tintAlphaDirty=!0;#ti=PIXI.State.for2d();get shader(){return this._shader}_shader;get paddingX(){return this._paddingX}set paddingX(e){if(e<0)throw new Error("The padding must be a non-negative value.");this._paddingX!==e&&(this._paddingX=e,this._textureID=-1,this._textureTrimmedID=-1,this._textureUvs??=new PIXI.TextureUvs)}get paddingY(){return this._paddingY}set paddingY(e){if(e<0)throw new Error("The padding must be a non-negative value.");this._paddingY!==e&&(this._paddingY=e,this._textureID=-1,this._textureTrimmedID=-1,this._textureUvs??=new PIXI.TextureUvs)}get padding(){return Math.max(this._paddingX,this._paddingY)}set padding(e){if(e<0)throw new Error("The padding must be a non-negative value.");this.paddingX=this.paddingY=e}_paddingX=0;_paddingY=0;set blendMode(e){this.#ti.blendMode=e}get blendMode(){return this.#ti.blendMode}set roundPixels(e){this.#si!==e&&(this._transformID=-1),this.#si=e}get roundPixels(){return this.#si}#si=PIXI.settings.ROUND_PIXELS;get alphaMode(){return this.#oi??this._texture.baseTexture.alphaMode}set alphaMode(e){this.#oi!==e&&(this.#oi=e,this._tintAlphaDirty=!0)}#oi=null;get pluginName(){return this.#ri??this._shader.pluginName}set pluginName(e){this.#ri=e}#ri=null;get width(){return Math.abs(this.scale.x)*this._texture.orig.width}set width(e){const t=Math.sign(this.scale.x)||1;this.scale.x=t*e/this._texture.orig.width,this._width=e}get height(){return Math.abs(this.scale.y)*this._texture.orig.height}set height(e){const t=Math.sign(this.scale.y)||1;this.scale.y=t*e/this._texture.orig.height,this._height=e}get texture(){return this._texture}set texture(e){e=e??null,this._texture!==e&&(this._texture&&this._texture.off("update",this._onTextureUpdate,this),this._texture=e||PIXI.Texture.EMPTY,this._textureID=this._textureTrimmedID=-1,this._tintAlphaDirty=!0,e&&(this._texture.baseTexture.valid?this._onTextureUpdate():this._texture.once("update",this._onTextureUpdate,this)))}get anchor(){return this._anchor}set anchor(e){this._anchor.copyFrom(e)}get tint(){return this._tintColor.value}set tint(e){this._tintColor.setValue(e);const t=this._tintColor.toLittleEndianNumber();t!==this._tintRGB&&(this._tintRGB=t,this._tintAlphaDirty=!0)}get sourceElement(){return this.texture.valid&&this.texture?.baseTexture.resource?.source||null}get isVideo(){const e=this.sourceElement;return"VIDEO"===e?.tagName}_onTextureUpdate(){this._textureID=this._textureTrimmedID=this._transformID=this._transformTrimmedID=-1,this._width&&(this.scale.x=Math.sign(this.scale.x)*this._width/this._texture.orig.width),this._height&&(this.scale.y=Math.sign(this.scale.y)*this._height/this._texture.orig.height),this._tintAlphaDirty=!0,this.updateUvs()}_onAnchorUpdate(){this._textureID=this._textureTrimmedID=this._transformID=this._transformTrimmedID=-1}updateUvs(){if(this._textureID!==this._texture._updateID){let e;if(0!==this._paddingX||0!==this._paddingY){const t=this._texture,i=SpriteMesh.#ii.copyFrom(t.frame).pad(this._paddingX,this._paddingY);e=this._textureUvs,e.set(i,t.baseTexture,t.rotate)}else e=this._texture._uvs;this.uvs.set(e.uvsFloat32),this.#ei.buffers[1].update()}}setShaderClass(e){if(!foundry.utils.isSubclass(e,BaseSamplerShader))throw new Error("SpriteMesh shader class must inherit from BaseSamplerShader.");this._shader.constructor!==e&&(this._shader=e.create())}updateTransform(){super.updateTransform(),this.#ai!==this.worldAlpha&&(this.#ai=this.worldAlpha,this._tintAlphaDirty=!0)}#ai;calculateVertices(){if(this._transformID===this.transform._worldID&&this._textureID===this._texture._updateID)return;this.updateUvs(),this._transformID=this.transform._worldID,this._textureID=this._texture._updateID;const{a:e,b:t,c:i,d:n,tx:s,ty:o}=this.transform.worldTransform,r=this._texture.orig,a=this._texture.trim,l=this._paddingX,c=this._paddingY;let d,u,h,p;a?(d=a.x-this._anchor._x*r.width-l,u=d+a.width+2*l,h=a.y-this._anchor._y*r.height-c,p=h+a.height+2*c):(d=-this._anchor._x*r.width-l,u=d+r.width+2*l,h=-this._anchor._y*r.height-c,p=h+r.height+2*c);const g=this.vertexData;if(g[0]=e*d+i*h+s,g[1]=n*h+t*d+o,g[2]=e*u+i*h+s,g[3]=n*h+t*u+o,g[4]=e*u+i*p+s,g[5]=n*p+t*u+o,g[6]=e*d+i*p+s,g[7]=n*p+t*d+o,this.roundPixels){const e=PIXI.settings.RESOLUTION;for(let t=0;t<g.length;++t)g[t]=Math.round(g[t]*e)/e}this.#ei.buffers[0].update()}calculateTrimmedVertices(){if(this.vertexTrimmedData){if(this._transformTrimmedID===this.transform._worldID&&this._textureTrimmedID===this._texture._updateID)return}else this.vertexTrimmedData=new Float32Array(8);this._transformTrimmedID=this.transform._worldID,this._textureTrimmedID=this._texture._updateID;const e=this._texture,t=this.vertexTrimmedData,i=e.orig,n=this._anchor,s=this._paddingX,o=this._paddingY,r=this.transform.worldTransform,a=r.a,l=r.b,c=r.c,d=r.d,u=r.tx,h=r.ty,p=-n._x*i.width-s,g=p+i.width+2*s,m=-n._y*i.height-o,v=m+i.height+2*o;if(t[0]=a*p+c*m+u,t[1]=d*m+l*p+h,t[2]=a*g+c*m+u,t[3]=d*m+l*g+h,t[4]=a*g+c*v+u,t[5]=d*v+l*g+h,t[6]=a*p+c*v+u,t[7]=d*v+l*p+h,this.roundPixels){const e=PIXI.settings.RESOLUTION;for(let i=0;i<t.length;++i)t[i]=Math.round(t[i]*e)/e}}_render(e){const t=this.pluginName;t?this.#li(e,t):this.#ci(e,this._shader)}#li(e,t){this.calculateVertices(),this._updateBatchData();const i=e.plugins[t];e.batch.setObjectRenderer(i),i.render(this._batchData)}#ci(e,t){this.calculateVertices(),this._tintAlphaDirty&&(PIXI.Color.shared.setValue(this._tintColor).premultiply(this.worldAlpha,this.alphaMode>0).toArray(this._cachedTint),this._tintAlphaDirty=!1),t._preRender(this,e),e.batch.flush(),e.shader.bind(t),e.state.set(this.#ti),e.geometry.bind(this.#ei,t),e.geometry.draw(PIXI.DRAW_MODES.TRIANGLES,6,0)}_updateBatchData(){this._batchData._texture=this._texture,this._batchData.worldAlpha=this.worldAlpha,this._batchData._tintRGB=this._tintRGB,this._batchData.blendMode=this.#ti.blendMode}_calculateBounds(){const e=this._texture.trim,t=this._texture.orig;!e||e.width===t.width&&e.height===t.height?(this.calculateVertices(),this._bounds.addQuad(this.vertexData)):(this.calculateTrimmedVertices(),this._bounds.addQuad(this.vertexTrimmedData))}getLocalBounds(e){if(0===this.children.length){this._localBounds||(this._localBounds=new PIXI.Bounds);const t=this._paddingX,i=this._paddingY,n=this._texture.orig;return this._localBounds.minX=n.width*-this._anchor._x-t,this._localBounds.minY=n.height*-this._anchor._y-i,this._localBounds.maxX=n.width*(1-this._anchor._x)+t,this._localBounds.maxY=n.height*(1-this._anchor._y)+i,e||(this._localBoundsRect||(this._localBoundsRect=new PIXI.Rectangle),e=this._localBoundsRect),this._localBounds.getRectangle(e)}return super.getLocalBounds(e)}containsPoint(e){const t=SpriteMesh.#ni;this.worldTransform.applyInverse(e,t);const i=this._texture.orig.width,n=this._texture.orig.height,s=-i*this.anchor.x;let o=0;return t.x>=s&&t.x<s+i&&(o=-n*this.anchor.y,t.y>=o&&t.y<o+n)}destroy(e){super.destroy(e),this.#ei.dispose(),this.#ei=null,this._shader=null,this.#ti=null,this.uvs=null,this.indices=null,this.vertexData=null,this._texture.off("update",this._onTextureUpdate,this),this._anchor=null;if("boolean"==typeof e?e:e?.texture){const t="boolean"==typeof e?e:e?.baseTexture;this._texture.destroy(!!t)}this._texture=null}static from(e,t,i){const n=e instanceof PIXI.Texture?e:PIXI.Texture.from(e,t);return new SpriteMesh(n,i)}}class UnboundContainer extends PIXI.Container{constructor(...e){super(...e),this.transform=new UnboundTransform}}class UnboundTransform extends PIXI.Transform{static IDENTITY=new UnboundTransform;updateTransform(e){const t=this.localTransform;this._localID!==this._currentLocalID&&(t.a=this._cx*this.scale.x,t.b=this._sx*this.scale.x,t.c=this._cy*this.scale.y,t.d=this._sy*this.scale.y,t.tx=this.position.x-(this.pivot.x*t.a+this.pivot.y*t.c),t.ty=this.position.y-(this.pivot.x*t.b+this.pivot.y*t.d),this._currentLocalID=this._localID,this._parentID=-1),this._parentID!==e._worldID&&(this._parentID=e._worldID,this._worldID++)}}class CanvasAnimation{static get STATES(){return this.#di}static#di=Object.freeze({FAILED:-2,TERMINATED:-1,WAITING:0,RUNNING:1,COMPLETED:2});static get ticker(){return canvas.app.ticker}static animations={};static async animate(e,{context:t=canvas.stage,name:i,duration:n=1e3,easing:s,ontick:o,priority:r,wait:a}={}){if(r??=PIXI.UPDATE_PRIORITY.LOW+1,"string"==typeof s&&(s=this[s]),i&&this.terminateAnimation(i),(e=e.map((e=>(e.from=e.from??e.parent[e.attribute],e.delta=e.to-e.from,e.done=0,e.to instanceof Color&&(e.color=!0,e.from=Color.from(e.from)),e)))).length&&e.every((e=>0===e.delta)))return;const l={attributes:e,context:t,duration:n,easing:s,name:i,ontick:o,time:0,wait:a,state:CanvasAnimation.STATES.WAITING,fn:e=>CanvasAnimation.#ui(e,l)},c=new Promise((async(e,i)=>{l.resolve=t=>{l.state!==CanvasAnimation.STATES.WAITING&&l.state!==CanvasAnimation.STATES.RUNNING||(l.state=t?CanvasAnimation.STATES.COMPLETED:CanvasAnimation.STATES.TERMINATED,e(t))},l.reject=e=>{l.state!==CanvasAnimation.STATES.WAITING&&l.state!==CanvasAnimation.STATES.RUNNING||(l.state=CanvasAnimation.STATES.FAILED,i(e))};try{a instanceof Promise&&await a,l.state===CanvasAnimation.STATES.WAITING&&(l.state=CanvasAnimation.STATES.RUNNING,this.ticker.add(l.fn,t,r))}catch(e){l.reject(e)}})).catch((e=>console.error(e))).finally((()=>{this.ticker.remove(l.fn,t),i&&this.animations[i]===l&&delete this.animations[i]}));return i&&(l.promise=c,this.animations[i]=l),c}static getAnimation(e){return this.animations[e]}static terminateAnimation(e){let t=this.animations[e];t&&t.resolve(!1)}static easeInOutCosine(e){return.5*(1-Math.cos(Math.PI*e))}static easeOutCircle(e){return Math.sqrt(1-Math.pow(e-1,2))}static easeInCircle(e){return 1-Math.sqrt(1-Math.pow(e,2))}static#ui(e,t){const{attributes:i,duration:n,ontick:s}=t,o=this.ticker.elapsedMS;t.time+=o;const r=t.time>=n,a=r?1:t.time/n,l=t.easing?t.easing(a):a;try{for(let e of i)CanvasAnimation.#hi(e,l);s&&s(o,t)}catch(e){t.reject(e)}r&&t.resolve(!0)}static#hi(e,t){e.done=e.delta*t,1!==t?e.color?e.parent[e.attribute]=e.from.mix(e.to,t):e.parent[e.attribute]=e.from+e.done:e.parent[e.attribute]=e.to}}class ControlIcon extends PIXI.Container{constructor({texture:e,size:t=40,borderColor:i=16733440,tint:n=null,elevation:s=0}={},...o){super(...o),this.iconSrc=e,this.size=t,this.rect=[-2,-2,t+4,t+4],this.borderColor=i,this.tintColor=n,this.eventMode="static",this.interactiveChildren=!1,this.hitArea=new PIXI.Rectangle(...this.rect),this.cursor="pointer",this.bg=this.addChild(new PIXI.Graphics),this.bg.clear().beginFill(0,.4).lineStyle(2,0,1).drawRoundedRect(...this.rect,5).endFill(),this.icon=this.addChild(new PIXI.Sprite),this.border=this.addChild(new PIXI.Graphics),this.border.visible=!1,this.tooltip=this.addChild(new PreciseText),this.tooltip.visible=!1,this.elevation=s,this.draw()}get elevation(){return this.#pi}set elevation(e){if("number"!=typeof e||!Number.isFinite(e))throw new Error("ControlIcon#elevation must be a finite numeric value.");e!==this.#pi&&(this.#pi=e,this.tooltip.text=`${e>0?"+":""}${e} ${canvas.grid.units}`.trim(),this.tooltip.visible=0!==e)}#pi=0;async draw(){return this.destroyed?this:(this.texture=this.texture??await loadTexture(this.iconSrc),this.icon.texture=this.texture,this.icon.width=this.icon.height=this.size,this.tooltip.style=g.canvasTextStyle,this.tooltip.anchor.set(.5,1),this.tooltip.position.set(this.size/2,-12),this.refresh())}refresh({visible:e,iconColor:t,borderColor:i,borderVisible:n}={}){return void 0!==t&&(this.tintColor=t),this.icon.tint=this.tintColor??16777215,void 0!==i&&(this.borderColor=i),this.border.clear().lineStyle(2,this.borderColor,1).drawRoundedRect(...this.rect,5).endFill(),void 0!==n&&(this.border.visible=n),void 0!==e&&this.visible!==e&&(this.visible=e,MouseInteractionManager.emulateMoveEvent()),this}}class MouseInteractionManager{constructor(e,t,i={},n={},s={}){this.object=e,this.layer=t,this.permissions=i,this.callbacks=n,this.options=s,this.state=this.states.NONE,this.interactionData={},this.dragTime=0,this.lcTime=0,this.rcTime=0,this._dragRight=!1,this.controlIcon=this.options.target?this.object[this.options.target]:null,this.viewId=(this.options.application??canvas.app).view.id}lastClick=new PIXI.Point;#gi={};static INTERACTION_STATES={NONE:0,HOVER:1,CLICKED:2,GRABBED:3,DRAG:4,DROP:5};static#mi={SKIPPED:-2,DISALLOWED:-1,REFUSED:1,ACCEPTED:2};static DOUBLE_CLICK_TIME_MS=250;static DOUBLE_CLICK_DISTANCE_PX=5;static LONG_PRESS_DURATION_MS=500;static longPressTimeout=null;static emulateMoveEvent(){MouseInteractionManager.#fi()}static#fi=foundry.utils.throttle((()=>{const e=canvas.app.renderer.events,t=e.rootPointerEvent;e.supportsPointerEvents&&(e.supportsTouchEvents&&"touch"===t.pointerType||e.domElement.dispatchEvent(new PointerEvent("pointermove",{pointerId:t.pointerId,pointerType:t.pointerType,isPrimary:t.isPrimary,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey})))}),10);get target(){return this.options.target?this.object[this.options.target]:this.object}get isDragging(){return this.state>=this.states.DRAG}activate(){return this.state=this.states.NONE,this.target.removeAllListeners(),this.#gi={pointerover:this.#vi.bind(this),pointerout:this.#yi.bind(this),pointerdown:this.#bi.bind(this),pointermove:this.#Si.bind(this),pointerup:this.#Ti.bind(this),contextmenu:this.#Ei.bind(this)},this.#Ci(),this.target.eventMode="static",this}can(e,t){const i=this.permissions[e];return"boolean"==typeof i?i:!(i instanceof Function)||i.call(this.object,c.user,t)}callback(e,t,...i){const n=this.callbacks[e];return!(n instanceof Function)||(this.#_i(t),n.call(this.object,t,...i)??!0)}get states(){return this.constructor.INTERACTION_STATES}get handlerOutcomes(){return MouseInteractionManager.#mi}#Ci(){this.target.off("pointerover",this.#gi.pointerover).on("pointerover",this.#gi.pointerover),this.target.off("pointerout",this.#gi.pointerout).on("pointerout",this.#gi.pointerout)}#Ii(){this.#wi(),this.target.on("pointerdown",this.#gi.pointerdown),this.target.on("pointerup",this.#gi.pointerup),this.target.on("pointerupoutside",this.#gi.pointerup)}#wi(){this.target.off("pointerdown",this.#gi.pointerdown),this.target.off("pointerup",this.#gi.pointerup),this.target.off("pointerupoutside",this.#gi.pointerup)}#Di(){this.#Oi(),this.layer.on("pointermove",this.#gi.pointermove),this._dragRight||canvas.app.view.addEventListener("contextmenu",this.#gi.contextmenu,{capture:!0})}#Oi(e){this.layer.off("pointermove",this.#gi.pointermove),canvas.app.view.removeEventListener("contextmenu",this.#gi.contextmenu,{capture:!0})}#vi(e){const t="hoverIn";return this.state!==this.states.NONE||e.nativeEvent&&e.nativeEvent.target.id!==this.viewId?this.#xi(t,e,this.handlerOutcomes.SKIPPED):this.can(t,e)?(this.state=this.states.HOVER,!1===this.callback(t,e)?(this.state=this.states.NONE,this.#xi(t,e,this.handlerOutcomes.REFUSED)):(this.#Ii(),this.#xi(t,e))):this.#xi(t,e,this.handlerOutcomes.DISALLOWED)}#yi(e){if("touch"===e.pointerType)return;const t="hoverOut";if(!this.state.between(this.states.HOVER,this.states.CLICKED)||e.nativeEvent&&e.nativeEvent.target.id!==this.viewId)return this.#xi(t,e,this.handlerOutcomes.SKIPPED);if(!this.can(t,e))return this.#xi(t,e,this.handlerOutcomes.DISALLOWED);const i=this.state;return this.state=this.states.NONE,!1===this.callback(t,e)?(this.state=i,this.#xi(t,e,this.handlerOutcomes.REFUSED)):(this.#wi(),this.#xi(t,e))}#bi(e){return 0===e.button?this.#Ni(e):2===e.button?this.#Ai(e):void 0}#Ni(e){if(!this.state.between(this.states.HOVER,this.states.DRAG))return;const t=e.timeStamp-this.lcTime<=MouseInteractionManager.DOUBLE_CLICK_TIME_MS&&Math.hypot(e.clientX-this.lastClick.x,e.clientY-this.lastClick.y)<=MouseInteractionManager.DOUBLE_CLICK_DISTANCE_PX;return this.lcTime=t?0:e.timeStamp,this.lastClick.set(e.clientX,e.clientY),this.interactionData.origin=e.getLocalPosition(this.layer),t||(clearTimeout(this.constructor.longPressTimeout),this.constructor.longPressTimeout=setTimeout((()=>{this.#Ri(e,this.interactionData.origin)}),MouseInteractionManager.LONG_PRESS_DURATION_MS)),t&&this.can("clickLeft2",e)?this.#Pi(e):this.#ki(e)}#ki(e){const t="clickLeft";if(!this.can(t,e))return this.#xi(t,e,this.handlerOutcomes.DISALLOWED);this._dragRight=!1;const i=this.state;return this.state===this.states.HOVER&&(this.state=this.states.CLICKED),canvas.currentMouseManager=this,!1===this.callback(t,e)?(this.state=i,canvas.currentMouseManager=null,this.#xi(t,e,this.handlerOutcomes.REFUSED)):(this.state===this.states.CLICKED&&this.can("dragStart",e)&&(this.state=this.states.GRABBED,this.#Di()),this.#xi(t,e))}#Pi(e){const t="clickLeft2";return!1===this.callback(t,e)?this.#xi(t,e,this.handlerOutcomes.REFUSED):this.#xi(t,e)}#Ri(e,t){const i="longPress";return!1===this.callback(i,e,t)?this.#xi(i,e,this.handlerOutcomes.REFUSED):this.#xi(i,e)}#Ai(e){if(!this.state.between(this.states.HOVER,this.states.DRAG))return;const t=e.timeStamp-this.rcTime<=MouseInteractionManager.DOUBLE_CLICK_TIME_MS&&Math.hypot(e.clientX-this.lastClick.x,e.clientY-this.lastClick.y)<=MouseInteractionManager.DOUBLE_CLICK_DISTANCE_PX;return this.rcTime=t?0:e.timeStamp,this.lastClick.set(e.clientX,e.clientY),this.interactionData.origin=e.getLocalPosition(this.layer),t&&this.can("clickRight2",e)?this.#Mi(e):this.#Li(e)}#Li(e){const t="clickRight";if(!this.can(t,e))return this.#xi(t,e,this.handlerOutcomes.DISALLOWED);this._dragRight=!0;const i=this.state;return this.state===this.states.HOVER&&(this.state=this.states.CLICKED),canvas.currentMouseManager=this,!1===this.callback(t,e)?(this.state=i,canvas.currentMouseManager=null,this.#xi(t,e,this.handlerOutcomes.REFUSED)):(this.state===this.states.CLICKED&&this.can("dragRight",e)&&(this.state=this.states.GRABBED,this.#Di()),this.#xi(t,e))}#Mi(e){const t="clickRight2";return!1===this.callback(t,e)?this.#xi(t,e,this.handlerOutcomes.REFUSED):this.#xi(t,e)}#Si(e){if(!this.state.between(this.states.GRABBED,this.states.DRAG))return;const t=Date.now();if(t-this.dragTime<canvas.app.ticker.elapsedMS)return;this.dragTime=t;const i=this.interactionData;if(i.destination=e.getLocalPosition(this.layer,i.destination),void 0===i.origin&&(i.origin=(new PIXI.Point).copyFrom(i.destination)),this.state!==this.states.DRAG){const t=i.destination.x-i.origin.x,n=i.destination.y-i.origin.y;Math.hypot(t,n)>=(this.options.dragResistance||canvas.dimensions.size/4)&&this.#Fi(e)}this.state===this.states.DRAG&&this.#Ui(e)}#Fi(e){clearTimeout(this.constructor.longPressTimeout);const t=this._dragRight?"dragRightStart":"dragLeftStart";return this.can(t,e)?(this.state=this.states.DRAG,!1===this.callback(t,e)?(this.state=this.states.GRABBED,this.#xi(t,e,this.handlerOutcomes.REFUSED)):this.#xi(t,e,this.handlerOutcomes.ACCEPTED)):(this.#xi(t,e,this.handlerOutcomes.DISALLOWED),void this.cancel(e))}#Ui(e){clearTimeout(this.constructor.longPressTimeout);const t=this._dragRight?"dragRightMove":"dragLeftMove";if(!this.can(t,e))return this.#xi(t,e,this.handlerOutcomes.DISALLOWED);const i=this.callback(t,e);return this.#xi(t,e,i?this.handlerOutcomes.ACCEPTED:this.handlerOutcomes.REFUSED)}#Ti(e){clearTimeout(this.constructor.longPressTimeout),this.state===this.states.HOVER&&"touch"===e.pointerType&&(this.state=this.states.DRAG);const t=this.state;if(this.interactionData.destination=e.getLocalPosition(this.layer,this.interactionData.destination),this.state>=this.states.DRAG){if(e.stopPropagation(),e.type.startsWith("right")&&!this._dragRight)return;this.state===this.states.DRAG&&this.#Bi(e)}if(e.defaultPrevented)return this.state=t,this.#xi("mouseUp",e,this.handlerOutcomes.SKIPPED);this.#Gi(e),this.#Ei(e)}#Bi(e){const t=this._dragRight?"dragRightDrop":"dragLeftDrop";return this.can(t,e)?(this.state=this.states.DROP,!1===this.callback(t,e)?(this.state=this.states.DRAG,this.#xi(t,e,this.handlerOutcomes.REFUSED)):this.#xi(t,e)):this.#xi(t,e,this.handlerOutcomes.DISALLOWED)}#Ei(e){this.cancel(e)}#Gi(e){const t=0===e.button?"unclickLeft":"unclickRight";return this.state.between(this.states.CLICKED,this.states.GRABBED)?!1===this.callback(t,e)?this.#xi(t,e,this.handlerOutcomes.REFUSED):this.#xi(t,e):this.#xi(t,e,this.handlerOutcomes.SKIPPED)}handleEvent(e){switch(e.type){case"pointerover":this.#vi(e);break;case"pointerout":this.#yi(e);break;case"pointerup":this.#Ti(e);break;case"pointerdown":this.#bi(e);break;default:return!1}return!0}cancel(e){const t=canvas.app.renderer.events,i=t.rootBoundary,n=!e;n&&((e=i.createPointerEvent(t.pointer,"pointermove",this.target)).defaultPrevented=!1,e.path=null);try{const t=this._dragRight?"dragRightCancel":"dragLeftCancel",n=this.state;if(n<=this.states.HOVER)return this.#xi(t,e,this.handlerOutcomes.SKIPPED);if(n>=this.states.DRAG&&!1===this.callback(t,e))return this.#xi(t,e,this.handlerOutcomes.REFUSED);if(e.defaultPrevented)return this.state=this.states.DRAG,this.#xi(t,e,this.handlerOutcomes.SKIPPED);this.interactionData={},this.state=this.states.HOVER,canvas.currentMouseManager=null,clearTimeout(this.constructor.longPressTimeout),this.#Oi(),this.#xi(t,e),i.trackingData(e.pointerId).overTargets?.includes(this.target)||this.#yi(e)}finally{n&&i.freeEvent(e)}}#xi(e,t,i=this.handlerOutcomes.ACCEPTED){if(g.debug.mouseInteraction){const n=this.object.constructor.name,s=t.target?.constructor.name,{eventPhase:o,type:r,button:a}=t;let l=`${n} | ${e} | state:${Object.keys(this.states)[this.state.toString()]} | target:${s} | phase:${o} | type:${r} | btn:${a} | skipped:${i<=-2} | allowed:${i>-1} | handled:${i>1}`;console.debug(l)}}reset({interactionData:e=!0,state:t=!0}={}){g.debug.mouseInteraction&&console.debug(`${this.object.constructor.name} | Reset | interactionData:${e} | state:${t}`),e&&(this.interactionData={}),t&&(this.state=MouseInteractionManager.INTERACTION_STATES.NONE)}#_i(e){this.interactionData.object=this.object,e.interactionData=this.interactionData;for(const t of Object.keys(this.interactionData))e.hasOwnProperty(t)||Object.defineProperty(e,t,{get(){const e=`event.data.${t} is deprecated in favor of event.interactionData.${t}.`;return foundry.utils.logCompatibilityWarning(e,{since:11,until:13}),this.interactionData[t]},set(e){const i=`event.data.${t} is deprecated in favor of event.interactionData.${t}.`;foundry.utils.logCompatibilityWarning(i,{since:11,until:13}),this.interactionData[t]=e}})}}class Ping extends PIXI.Container{constructor(e,t={}){super(),this.x=e.x,this.y=e.y,this.options=foundry.utils.mergeObject({duration:900,size:128,color:"#ff6400"},t),this._color=Color.from(this.options.color)}destroy(e={}){e.children=!0,super.destroy(e)}async animate(){const e=await CanvasAnimation.animate([],{context:this,name:this.options.name,duration:this.options.duration,ontick:this._animateFrame.bind(this)});return this.destroy(),e}_animateFrame(e,t){throw new Error("Subclasses of Ping must implement the _animateFrame method.")}}class RenderFlags extends Set{constructor(e={},{object:t,priority:i=PIXI.UPDATE_PRIORITY.OBJECTS}={}){super([]);for(const t of Object.values(e))t.propagate||=[],t.reset||=[];Object.defineProperties(this,{flags:{value:Object.freeze(e),enumerable:!1,writable:!1},object:{value:t,enumerable:!1,writable:!1},priority:{value:i,enumerable:!1,writable:!1}})}clear(){const e={};for(const t of this)e[t]=!0;return super.clear(),this.object&&canvas.pendingRenderFlags[this.priority].delete(this.object),e}handle(e){const t=this.has(e);return this.delete(e),t}set(e){const t=new Set;for(const[i,n]of Object.entries(e))this.#ji(i,n,t);this.object&&canvas.pendingRenderFlags[this.priority].add(this.object)}#ji(e,t,i){if(i.has(e)||!t)return;i.add(e);const n=this.flags[e];if(!n)throw new Error(`"${e}" is not defined as a supported RenderFlag option.`);n.deprecated&&this.#$i(e),n.alias||this.add(e);for(const e of n.reset)this.delete(e);for(const e of n.propagate)this.#ji(e,!0,i)}#$i(e){const t=this.flags[e];if(!t.deprecated)throw new Error(`The RenderFlag "${e}" is not deprecated`);let{message:i,...n}=t.deprecated;i||(i=`The RenderFlag "${e}"`,this.object&&(i+=` of ${this.object.constructor.name}`),i+=" is deprecated",0===t.propagate.length?i+=" without replacement.":1===t.propagate.length?i+=` in favor of ${t.propagate[0]}.`:i+=`. Use ${t.propagate.slice(0,-1).join(", ")} and/or ${t.propagate.at(-1)} instead.`),n.once??=!0,foundry.utils.logCompatibilityWarning(i,n)}}function RenderFlagsMixin(e){return class RenderFlagObject extends e{constructor(...e){super(...e),this.renderFlags=new RenderFlags(this.constructor.RENDER_FLAGS,{object:this,priority:this.constructor.RENDER_FLAG_PRIORITY})}static RENDER_FLAGS={};static RENDER_FLAG_PRIORITY="OBJECTS";renderFlags;applyRenderFlags(){this.renderFlags.clear()}}}class ResizeHandle extends PIXI.Graphics{constructor(e,t={}){super(),this.offset=e,this.handlers=t,this.lineStyle(4,0,1).beginFill(16750633,1).drawCircle(0,0,10).endFill(),this.cursor="pointer"}active=!1;refresh(e){this.position.set(e.x+e.width*this.offset[0],e.y+e.height*this.offset[1]),this.hitArea=new PIXI.Rectangle(-16,-16,32,32)}updateDimensions(e,t,i,{aspectRatio:n=null}={}){const s=i.x-t.x,o=i.y-t.y;let r=Math.max(t.width+s,24),a=Math.max(t.height+o,24);return n&&(r>=a?r=a*n:a=r/n),{x:e.x,y:e.y,width:r*Math.sign(e.width),height:a*Math.sign(e.height)}}activateListeners(){this.off("pointerover").off("pointerout").off("pointerdown").on("pointerover",this._onHoverIn.bind(this)).on("pointerout",this._onHoverOut.bind(this)).on("pointerdown",this._onMouseDown.bind(this)),this.eventMode="static"}_onHoverIn(e){e.target.scale.set(1.5,1.5)}_onHoverOut(e){e.target.scale.set(1,1)}_onMouseDown(e){this.handlers.canDrag&&!this.handlers.canDrag()||(this.active=!0)}}class UserTargets extends Set{constructor(e){if(super(),e.targets)throw new Error(`User ${e.id} already has a targets set defined`);this.user=e}get ids(){return Array.from(this).map((e=>e.id))}add(e){return this.has(e)||(super.add(e),this.#Hi(e,!0)),this}clear(){const e=Array.from(this);super.clear(),e.forEach((e=>this.#Hi(e,!1)))}delete(e){return!!this.has(e)&&(super.delete(e),this.#Hi(e,!1),!0)}#Hi(e,t){Hooks$1.callAll("targetToken",this.user,e,t)}}class LimitedAnglePolygon extends PIXI.Polygon{constructor(e,{radius:t,angle:i=360,rotation:n=0,density:s,externalRadius:o=0}={}){super([]),this.origin=e,this.radius=t,this.angle=i,this.rotation=n,this.density=s??PIXI.Circle.approximateVertexDensity(this.radius),this.externalRadius=o,this.aMin=Math.normalizeRadians(Math.toRadians(this.rotation+90-this.angle/2)),this.aMax=this.aMin+Math.toRadians(this.angle),this.#zi()}externalBounds;#zi(){const{x:e,y:t}=this.origin,i=this.aMax-this.aMin,n=Math.ceil(i*this.density/(2*Math.PI)),s=i/n;for(let i=0;i<=n;i++){const n=Ray.fromAngle(e,t,this.aMin+i*s,this.radius);this.points.push(n.B.x,n.B.y)}if(this.externalRadius){const n=2*Math.PI-i,s=Math.ceil(n*this.density/(2*Math.PI)),o=n/s;for(let i=0;i<=s;i++){const n=Ray.fromAngle(e,t,this.aMax+i*o,this.externalRadius);this.points.push(n.B.x,n.B.y)}this.externalBounds=new PIXI.Circle(e,t,this.externalRadius).getBounds()}else this.points.unshift(e,t),this.points.push(e,t)}_includeEdge(e,t){if(this.externalBounds?.lineSegmentIntersects(e,t,{inside:!0}))return!0;const roundPoint=e=>({x:Math.round(e.x),y:Math.round(e.y)}),i=Ray.fromAngle(this.origin.x,this.origin.y,this.aMin,this.radius);roundPoint(i.B);const n=Ray.fromAngle(this.origin.x,this.origin.y,this.aMax,this.radius);return roundPoint(n.B),!!LimitedAnglePolygon.pointBetweenRays(e,i,n,this.angle)||(!!LimitedAnglePolygon.pointBetweenRays(t,i,n,this.angle)||(!!foundry.utils.lineSegmentIntersects(i.A,i.B,e,t)||!!foundry.utils.lineSegmentIntersects(n.A,n.B,e,t)))}static pointBetweenRays(e,t,i,n){const s=foundry.utils.orient2dFast;if(n>180){return!(s(i.A,i.B,e)<=0&&s(t.A,t.B,e)>=0)}return s(t.A,t.B,e)<=0&&s(i.A,i.B,e)>=0}}class PreciseText extends PIXI.Text{constructor(...e){super(...e),this._autoResolution=!1,this._resolution=2}static getTextStyle({anchor:e,...t}={}){const i=g.canvasTextStyle.clone();for(let[e,n]of Object.entries(t))void 0!==n&&(i[e]=n);if("align"in t||(e===CONST.TEXT_ANCHOR_POINTS.LEFT?i.align="right":e===CONST.TEXT_ANCHOR_POINTS.RIGHT&&(i.align="left")),!("stroke"in t)){const e=Color.from(i.fill);i.stroke=e.hsv[2]>.6?0:16777215}return i}}class Ray{constructor(e,t){this.A=e,this.B=t,this.y0=e.y,this.x0=e.x,this.dx=t.x-e.x,this.dy=t.y-e.y,this.slope=this.dy/this.dx}_angle=void 0;_distance=void 0;get angle(){return void 0===this._angle&&(this._angle=Math.atan2(this.dy,this.dx)),this._angle}set angle(e){this._angle=Number(e)}get bounds(){return new PIXI.Rectangle(this.A.x,this.A.y,this.dx,this.dy).normalize()}get distance(){return void 0===this._distance&&(this._distance=Math.hypot(this.dx,this.dy)),this._distance}set distance(e){this._distance=Number(e)}static fromAngle(e,t,i,n){const s=Math.cos(i),o=Math.sin(i),r=this.fromArrays([e,t],[e+s*n,t+o*n]);return r._angle=Math.normalizeRadians(i),r._distance=n,r}static fromArrays(e,t){return new this({x:e[0],y:e[1]},{x:t[0],y:t[1]})}project(e){return{x:this.A.x+e*this.dx,y:this.A.y+e*this.dy}}static towardsPoint(e,t,i){const n=t.x-e.x,s=t.y-e.y,o=i/Math.hypot(n,s);return new this(e,{x:e.x+o*n,y:e.y+o*s})}static towardsPointSquared(e,t,i){const n=t.x-e.x,s=t.y-e.y,o=Math.sqrt(i/(Math.pow(n,2)+Math.pow(s,2)));return new this(e,{x:e.x+o*n,y:e.y+o*s})}reverse(){const e=new Ray(this.B,this.A);return e._distance=this._distance,e._angle=Math.PI-this._angle,e}shiftAngle(e,t){return this.constructor.fromAngle(this.x0,this.y0,this.angle+e,t||this.distance)}intersectSegment(e){return foundry.utils.lineSegmentIntersection(this.A,this.B,{x:e[0],y:e[1]},{x:e[2],y:e[3]})}}class PointSourcePolygon extends PIXI.Polygon{static WALL_DIRECTION_MODES=Object.freeze({NORMAL:0,REVERSED:1,BOTH:2});bounds=new PIXI.Rectangle(0,0,0,0);origin;config={};get isConstrained(){return this.config.boundaryShapes.length>0}static benchmark(e,t,i){const f=()=>this.create(foundry.utils.deepClone(t),foundry.utils.deepClone(i));return Object.defineProperty(f,"name",{value:`${this.name}.construct`,configurable:!0}),foundry.utils.benchmark(f,e)}static create(e,t={}){const i=new this;return i.initialize(e,t),i.compute(),this.applyThresholdAttenuation(i)}clone(){const e=new this.constructor([...this.points]);return e.config=foundry.utils.deepClone(this.config),e.origin={...this.origin},e.bounds=this.bounds.clone(),e}compute(){let e=performance.now();const{x:t,y:i}=this.origin,{width:n,height:s}=canvas.dimensions,{angle:o,debug:r,radius:a}=this.config;if(!(t>=0&&t<=n&&i>=0&&i<=s))return console.warn("The polygon cannot be computed because its origin is out of the scene bounds."),this.points.length=0,this.bounds=new PIXI.Rectangle(0,0,0,0),this;if(0===a||0===o)return this.points.length=0,this.bounds=new PIXI.Rectangle(0,0,0,0),this;if(this.bounds=void 0,this._compute(),this.bounds=this.getBounds(),r){let t=performance.now();console.log(`Created ${this.constructor.name} in ${Math.round(t-e)}ms`),this.visualize()}return this}_compute(){throw new Error("Each subclass of PointSourcePolygon must define its own _compute method")}initialize(e,t){const i=this.origin={x:Math.round(e.x),y:Math.round(e.y)},n=this.config=t,s=canvas.dimensions.maxR;n.radius=Math.min(n.radius??s,s),n.hasLimitedRadius=n.radius>0&&n.radius<s,n.density=n.density??PIXI.Circle.approximateVertexDensity(n.radius),n.angle=n.angle??360,n.rotation=n.rotation??0,n.hasLimitedAngle=360!==n.angle;const o=canvas.dimensions.sceneRect;n.useInnerBounds??="sight"===n.type&&i.x>=o.left&&i.x<=o.right&&i.y>=o.top&&i.y<=o.bottom,n.wallDirectionMode??=PointSourcePolygon.WALL_DIRECTION_MODES.NORMAL,n.useThreshold??=!1,n.includeDarkness??=!1,n.boundaryShapes||=[],n.hasLimitedAngle?this.#Vi():n.hasLimitedRadius&&this.#Wi(),g.debug.polygons&&(n.debug=!0)}#Vi(){this.config.boundaryShapes.push(new LimitedAnglePolygon(this.origin,this.config))}#Wi(){this.config.boundaryShapes.push(new PIXI.Circle(this.origin.x,this.origin.y,this.config.radius))}applyConstraint(e,t={}){const i=this.clone();if(i.config.boundaryShapes.push(e),e instanceof PIXI.Circle&&e.x===this.origin.x&&e.y===this.origin.y){if(i.config.radius<=e.radius)return i;if(i.config.radius=e.radius,i.config.density=t.density??=PIXI.Circle.approximateVertexDensity(e.radius),0===e.radius)return i.points.length=0,i.bounds.x=i.bounds.y=i.bounds.width=i.bounds.height=0,i}if(!i.points.length)return i;const n=e.intersectPolygon(i,t);return i.points=n.points,i.bounds=i.getBounds(),i}contains(e,t){return this.bounds.contains(e,t)&&super.contains(e,t)}_constrainBoundaryShapes(){const{density:e,boundaryShapes:t}=this.config;if(this.points.length<6||!t.length)return;let i=this;const n={density:e,scalingFactor:100};for(const e of t)i=e.intersectPolygon(i,n);this.points=i.points}static testCollision(e,t,{mode:i="all",...n}={}){if(!CONST.WALL_RESTRICTION_TYPES.includes(n.type))throw new Error("A valid wall restriction type is required for testCollision.");const s=new this,o=new Ray(e,t);return n.boundaryShapes||=[],n.boundaryShapes.push(o.bounds),s.initialize(e,n),s._testCollision(o,i)}_testCollision(e,t){throw new Error(`The ${this.constructor.name} class must implement the _testCollision method`)}visualize(){if(!this.points.length)return;let e=canvas.controls.debug;e.clear();for(const t of this.config.boundaryShapes)e.lineStyle(2,16777215,1).beginFill(11206400).drawShape(t).endFill();return e.lineStyle(2,16777215,1).beginFill(16755353,.25).drawShape(this).endFill(),e}isCompleteCircle(){const{radius:e,angle:t,density:i}=this.config;if(0===e)return!0;if(t<360||this.points.length!==2*i)return!1;const n=Math.abs(this.signedArea());return(.5*i*Math.sin(2*Math.PI/i)*e**2).almostEqual(n,1e-5)}static applyThresholdAttenuation(e){const t=e.config;if(!t.useThreshold)return e;const{nAttenuated:i,edges:n}=PointSourcePolygon.#Xi(e.origin,t);if(!i)return e;const s=PointSourcePolygon.#Yi(e,n);if(!s.length)return e;const o=new this;o.initialize(e.origin,{...t,useThreshold:!1}),o.compute();const r=PointSourcePolygon.#Ki(o,s);return e.points=r.points,e.bounds=e.getBounds(),e}static#Xi(e,t){let i=0;const n=[];for(const s of canvas.edges.values())s.applyThreshold(t.type,e,t.externalRadius)&&(n.push(s),i+=s.threshold.attenuation);return{edges:n,nAttenuated:i}}static#Yi(e,t){const i=e.toClipperPoints(),n=e.origin,{radius:s,externalRadius:o,type:r}=e.config,a=[];for(const e of t){let t;if(e.threshold.attenuation){const i=PointSourcePolygon.#qi(e,n,s,o,r);if(!i.outside)continue;t=new PIXI.Circle(n.x,n.y,i.inside+i.outside)}else t=new PIXI.Circle(n.x,n.y,s);const l=t.intersectClipper(i,{convertSolution:!1});l.length&&l[0].length>2&&a.push(l[0])}return a}static#qi(e,t,i,n,s){const o=e.threshold?.[s];if(!o)return{inside:i,outside:i};const r=e[s]===CONST.WALL_SENSE_TYPES.PROXIMITY,a=foundry.utils.closestPointToSegment(t,e.a,e.b),l=Math.hypot(a.x-t.x,a.y-t.y),c=i-l;if(c<0||c.almostEqual(0))return{inside:l,outside:0};const d=(r?Math.max(l-n,0):l+n)/o,u=r?1-d:Math.min(1,d-1),h=u/(2*(1-u))*g.Wall.thresholdAttenuationMultiplier;return{inside:l,outside:Math.min(h*o,c)}}static#Ki(e,t){const i=new ClipperLib.Clipper,n=[],s=[e.toClipperPoints(),...t];i.AddPaths(s,ClipperLib.PolyType.ptSubject,!0);const o=ClipperLib.PolyFillType.pftPositive;return i.Execute(ClipperLib.ClipType.ctUnion,n,o,o),PIXI.Polygon.fromClipperPoints(n.length?n[0]:[])}get rays(){return foundry.utils.logCompatibilityWarning("You are referencing PointSourcePolygon#rays which is no longer a required property of that interface. If your subclass uses the rays property it should be explicitly defined by the subclass which requires it.",{since:11,until:13}),this.#Ji}set rays(e){this.#Ji=e}#Ji=[]}class ChevronPing extends Ping{constructor(e,t={}){super(e,t),this._r=this.options.size/2*.75,this._rInner=.75*this._r,this._t14=.25*this.options.duration,this._t12=.5*this.options.duration,this._t34=3*this._t14}static _CHEVRON_PATH="icons/pings/chevron.webp";async animate(){return this.removeChildren(),this.addChild(...this._createRings()),this._chevron=await this._loadChevron(),this.addChild(this._chevron),super.animate()}_animateFrame(e,t){const{time:i}=t;if(i<this._t14){const e=i/this._t14,t=CanvasAnimation.easeOutCircle(e);this._chevron.y=this._y+this._h2*t,this._chevron.alpha=i/this._t14}else if(i<this._t34){const e=(i-this._t14)/this._t12;this._drawRings(e)}else{const e=(i-this._t34)/this._t14,t=1-e,n=CanvasAnimation.easeInCircle(e);this._chevron.y=this._y+(1-n)*this._h2,this._chevron.alpha=t,this._drawRings(t)}}_drawRings(e){this._outer.clear(),this._inner.clear(),this._outer.lineStyle(6,this._color,e).drawCircle(0,0,this._r),this._inner.lineStyle(3,this._color,e).arc(0,0,this._rInner,0,1.5*Math.PI)}async _loadChevron(){const e=await TextureLoader.loader.loadTexture(ChevronPing._CHEVRON_PATH),t=PIXI.Sprite.from(e);t.tint=this._color;const i=this.options.size,n=e.height/e.width*i;return t.width=i,t.height=n,this._h2=n/2,t.x=-i/2,t.y=this._y=-n-this._h2,t}_createRings(){return this._outer=new PIXI.Graphics,this._inner=new PIXI.Graphics,[this._outer,this._inner]}}class PulsePing extends Ping{constructor(e,{rings:t=3,color2:i="#ffffff",...n}={}){super(e,{rings:t,color2:i,...n}),this._color2=c.settings.get("core","photosensitiveMode")?this._color:Color.from(i),this._r=this.options.size/2,this._r0=this._r/5,this._computeTimeSlices()}_computeTimeSlices(){this._timeSlice=this.options.duration/(this.options.rings+1),this._timeSlice2=2*this._timeSlice,this._timeSlice15=this._timeSlice2/5,this._timeSlice25=2*this._timeSlice15,this._timeSlice45=2*this._timeSlice25}async animate(){this.removeChildren();for(let e=0;e<this.options.rings;e++)this.addChild(new PIXI.Graphics);const e=new PIXI.BlurFilter(2);return e.padding=this.options.size,this.filters=[e],super.animate()}_animateFrame(e,t){const{time:i}=t;for(let e=0;e<this.options.rings;e++){const t=this.children[e],n=this._timeSlice*e,s=n+this._timeSlice2;if(i<n||i>=s)continue;let o=i-n;if(t.clear(),o<this._timeSlice15){const e=o/this._timeSlice15;this._drawShape(t,this._color2,e,this._r0)}else{o-=this._timeSlice15;const e=this._r/this._timeSlice45,i=this._r0+o*e,n=this._color,s=this._color2,r=o<=this._timeSlice25?this._colorTransition(n,s,this._timeSlice25,o):n,a=1-Math.max(0,o-this._timeSlice25)/this._timeSlice25;this._drawShape(t,r,a,i)}}}_colorTransition(e,t,i,n){const s=n/i,o=e.rgb,r=t.rgb;return Color.fromRGB(o.map(((e,t)=>{const i=r[t]-e;return e+s*i})))}_drawShape(e,t,i,n){e.lineStyle({color:t,alpha:i,width:6,cap:PIXI.LINE_CAP.ROUND,join:PIXI.LINE_JOIN.BEVEL}),e.drawCircle(0,0,n)}}class CanvasLayer extends PIXI.Container{options=this.constructor.layerOptions;interactiveChildren=!1;static get layerOptions(){return{name:"",baseClass:CanvasLayer}}static get instance(){return canvas[this.layerOptions.name]}get name(){const e=this.constructor.layerOptions.baseClass;let t=Object.getPrototypeOf(this.constructor),i=this.constructor.name;for(;t&&t!==e;)i=t.name,t=Object.getPrototypeOf(t);return i}get hookName(){return this.name}#Ve=Promise.resolve(this);#kt=!1;async draw(e={}){return this.#Ve=this.#Ve.finally((async()=>{console.log(`${l} | Drawing the ${this.constructor.name} canvas layer`),await this.tearDown(),await this._draw(e),Hooks$1.callAll(`draw${this.hookName}`,this),this.#kt=!0}))}async _draw(e){throw new Error(`The ${this.constructor.name} subclass of CanvasLayer must define the _draw method`)}async tearDown(e={}){return this.#kt?(MouseInteractionManager.emulateMoveEvent(),this.#kt=!1,this.renderable=!1,await this._tearDown(e),Hooks$1.callAll(`tearDown${this.hookName}`,this),this.renderable=!0,MouseInteractionManager.emulateMoveEvent(),this):this}async _tearDown(e){this.removeChildren().forEach((e=>e.destroy({children:!0})))}}class InteractionLayer extends CanvasLayer{get active(){return this.#M}#M=!1;eventMode="passive";static get layerOptions(){return Object.assign(super.layerOptions,{baseClass:InteractionLayer,zIndex:0})}activate({tool:e}={}){const t=this.#M;this.#M=!0;for(const e of Object.keys(Canvas.layers)){const t=canvas[e];t!==this&&t instanceof InteractionLayer&&t.deactivate()}return ui.controls?.initialize({layer:this.constructor.layerOptions.name,tool:e}),t||(canvas.mouseInteractionManager?.reset({state:!1}),this.zIndex=this.getZIndex(),this.eventMode="static",this.interactiveChildren=!0,this._activate(),Hooks$1.callAll(`activate${this.hookName}`,this),Hooks$1.callAll("activateCanvasLayer",this)),this}_activate(){}deactivate(){return this.#M?(canvas.highlightObjects(!1),this.#M=!1,this.eventMode="passive",this.interactiveChildren=!1,this.zIndex=this.getZIndex(),this._deactivate(),Hooks$1.callAll(`deactivate${this.hookName}`,this),this):this}_deactivate(){}async _draw(e){this.hitArea=canvas.dimensions.rect,this.zIndex=this.getZIndex()}getZIndex(){return this.options.zIndex}_onClickLeft(e){}_onClickLeft2(e){}_canDragLeftStart(e,t){return!0}_onDragLeftStart(e){}_onDragLeftMove(e){}_onDragLeftDrop(e){}_onDragLeftCancel(e){}_onClickRight(e){}_onMouseWheel(e){}async _onDeleteKey(e){}}class PlaceablesLayer extends InteractionLayer{static SORT_ORDER=0;objects=null;preview=null;history=[];_copy=[];quadtree=this.options.quadtree?new CanvasQuadtree:null;static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{baseClass:PlaceablesLayer,controllableObjects:!1,rotatableObjects:!1,confirmDeleteKey:!1,objectClass:g[this.documentName]?.objectClass,quadtree:!0})}static documentName;static CREATION_STATES={NONE:0,POTENTIAL:1,CONFIRMED:2,COMPLETED:3};get documentCollection(){return canvas.scene?.getEmbeddedCollection(this.constructor.documentName)||null}static get placeableClass(){return g[this.documentName].objectClass}get hud(){return null}get placeables(){return this.objects?this.objects.children:[]}get controlled(){return Array.from(this.#Qi.values())}*controllableObjects(){if(this.options.controllableObjects)for(const e of this.placeables)e.visible&&(yield e)}get controlledObjects(){return this.#Qi}#Qi=new Map;get hover(){return this.#Lt}set hover(e){e instanceof this.constructor.placeableClass?this.#Lt=e:this.#Lt=null}#Lt=null;highlightObjects=!1;getMaxSort(){let e=-1/0;const t=this.documentCollection;if(!t?.documentClass.schema.has("sort"))return e;for(const i of t)e=Math.max(e,i.sort);return e}_sendToBackOrBringToFront(e){const t=this.documentCollection,i=t?.documentClass;if(!i?.schema.has("sort"))return!1;if(!this.controlled.length)return!0;const n=[];let s=e?-1/0:1/0;for(const i of t)i.object?.controlled&&!i.locked?n.push(i):s=(e?Math.max:Math.min)(s,i.sort);if(!Number.isFinite(s))return!0;s+=e?1:-n.length,n.sort(((e,t)=>e.sort-t.sort));const o=n.map(((e,t)=>({_id:e.id,sort:s+t})));return canvas.scene.updateEmbeddedDocuments(i.documentName,o),!0}getSnappedPoint(e){const t=CONST.GRID_SNAPPING_MODES,i=canvas.grid;return i.getSnappedPoint(e,{mode:i.isHexagonal&&!this.options.controllableObjects?t.CENTER|t.VERTEX:t.CENTER|t.VERTEX|t.CORNER|t.SIDE_MIDPOINT,resolution:1})}getDocuments(){return this.documentCollection||[]}async _draw(e){await super._draw(e),this.objects=this.addChild(new PIXI.Container),this.objects.sortableChildren=!0,this.objects.visible=!1;const t=getDocumentClass(this.constructor.documentName);t.schema.get("elevation")instanceof foundry.data.fields.NumberField&&t.schema.get("sort")instanceof foundry.data.fields.NumberField&&(this.objects.sortChildren=PlaceablesLayer.#Zi),this.objects.on("childAdded",(e=>{e instanceof this.constructor.placeableClass||console.error(`An object of type ${e.constructor.name} was added to ${this.constructor.name}#objects. The object must be an instance of ${this.constructor.placeableClass.name}.`),e instanceof PlaceableObject&&e._updateQuadtree()})),this.objects.on("childRemoved",(e=>{e instanceof PlaceableObject&&e._updateQuadtree()})),this.preview=this.addChild(new PIXI.Container);const i=this.getDocuments().map((e=>{const t=e._object=this.createObject(e);return this.objects.addChild(t),t.draw()}));await Promise.all(i),this.objects.visible=this.active}createObject(e){return new this.constructor.placeableClass(e)}async _tearDown(e){return this.history=[],this.options.controllableObjects&&this.controlledObjects.clear(),this.hud&&this.hud.clear(),this.quadtree&&this.quadtree.clear(),this.objects=null,super._tearDown(e)}static#Zi=function(){for(let e=0;e<this.children.length;e++)this.children[e]._lastSortedIndex=e;this.children.sort(((e,t)=>e.document.elevation-t.document.elevation||e.document.sort-t.document.sort||e.zIndex-t.zIndex||e._lastSortedIndex-t._lastSortedIndex)),this.sortDirty=!1};_activate(){this.objects.visible=!0,this.placeables.forEach((e=>e.renderFlags.set({refreshState:!0})))}_deactivate(){this.objects.visible=!1,this.releaseAll(),this.placeables.forEach((e=>e.renderFlags.set({refreshState:!0}))),this.clearPreviewContainer()}clearPreviewContainer(){this.preview&&this.preview.removeChildren().forEach((e=>{e._onDragEnd(),e.destroy({children:!0})}))}get(e){return this.documentCollection?.get(e)?.object||void 0}controlAll(e={}){if(!this.options.controllableObjects)return[];e.releaseOthers=!1;for(const t of this.controllableObjects())t.control(e);return this.controlled}releaseAll(e={}){let t=0;for(let i of this.placeables)i.controlled&&(i.release(e),t++);return t}async rotateMany({angle:e,delta:t,snap:i,ids:n,includeLocked:s=!1}={}){if(null===(e??t??null))throw new Error("Either a target angle or relative delta must be provided.");if(!this.options.rotatableObjects)return[];if(c.paused&&!c.user.isGM)return ui.notifications.warn("GAME.PausedWarning",{localize:!0}),[];const o=this._getMovableObjects(n,s);if(!o.length)return o;this.hud?.clear();const r=o.map((n=>({_id:n.id,rotation:n._updateRotation({angle:e,delta:t,snap:i})})));return await canvas.scene.updateEmbeddedDocuments(this.constructor.documentName,r),o}async moveMany({dx:e=0,dy:t=0,rotate:i=!1,ids:n,includeLocked:s=!1}={}){if(![-1,0,1].includes(e))throw new Error("Invalid argument: dx must be -1, 0, or 1");if(![-1,0,1].includes(t))throw new Error("Invalid argument: dy must be -1, 0, or 1");if(!e&&!t)return[];if(c.paused&&!c.user.isGM)return ui.notifications.warn("GAME.PausedWarning",{localize:!0}),[];const o=this._getMovableObjects(n,s);if(!o.length)return o;const r=[30,150,210,330],a=[60,120,240,300];let l=[e,t],d=0;if(i){let e=[45,135,225,315];const t=canvas.grid.type;t>=CONST.GRID_TYPES.HEXODDQ?e=a:t>=CONST.GRID_TYPES.HEXODDR&&(e=r),l.equals([0,1])?d=0:l.equals([-1,1])?d=e[0]:l.equals([-1,0])?d=90:l.equals([-1,-1])?d=e[1]:l.equals([0,-1])?d=180:l.equals([1,-1])?d=e[2]:l.equals([1,0])?d=270:l.equals([1,1])&&(d=e[3])}this.hud?.clear();const u=o.map((e=>{let t={_id:e.id};return i?t.rotation=d:foundry.utils.mergeObject(t,e._getShiftedPosition(...l)),t}));return await canvas.scene.updateEmbeddedDocuments(this.constructor.documentName,u),o}_getMovableObjects(e,t){return e instanceof Array?e.reduce(((e,i)=>{const n=this.get(i);if(!n)throw new Error(`"${i} is not a valid ${this.constructor.documentName} in the current Scene`);return!t&&n.document.locked||e.push(n),e}),[]):this.controlled.filter((e=>t||!e.document.locked))}async undoHistory(){if(c.paused&&!c.user.isGM)return ui.notifications.warn("GAME.PausedWarning",{localize:!0}),[];const e=this.constructor.documentName;if(!this.history.length)return ui.notifications.info(c.i18n.format("CONTROLS.EmptyUndoHistory",{type:c.i18n.localize(getDocumentClass(e).metadata.label)})),[];let t=this.history.pop();if("create"===t.type){const i=t.data.map((e=>e._id)),n=await canvas.scene.deleteEmbeddedDocuments(e,i,{isUndo:!0});return 1!==n.length&&ui.notifications.info(c.i18n.format("CONTROLS.UndoCreateObjects",{count:n.length,type:c.i18n.localize(getDocumentClass(e).metadata.label)})),n}if("update"===t.type)return canvas.scene.updateEmbeddedDocuments(e,t.data,{isUndo:!0});if("delete"===t.type){const i=await canvas.scene.createEmbeddedDocuments(e,t.data,{isUndo:!0,keepId:!0});return 1!==i.length&&ui.notifications.info(c.i18n.format("CONTROLS.UndoDeleteObjects",{count:i.length,type:c.i18n.localize(getDocumentClass(e).metadata.label)})),i}}async deleteAll(){const e=this.constructor.documentName;if(!c.user.isGM)throw new Error(`You do not have permission to delete ${e} objects from the Scene.`);const t=c.i18n.localize(getDocumentClass(e).metadata.label);return Dialog.confirm({title:c.i18n.localize("CONTROLS.ClearAll"),content:`<p>${c.i18n.format("CONTROLS.ClearAllHint",{type:t})}</p>`,yes:async()=>{const i=await canvas.scene.deleteEmbeddedDocuments(e,[],{deleteAll:!0});ui.notifications.info(c.i18n.format("CONTROLS.DeletedObjects",{count:i.length,type:t}))}})}storeHistory(e,t){if(t.every((e=>!("_id"in e))))throw new Error("The data entries must contain the _id key");"update"===e&&(t=t.filter((e=>Object.keys(e).length>1))),0!==t.length&&(this.history.length>=10&&this.history.shift(),this.history.push({type:e,data:t}))}copyObjects(){this.options.controllableObjects?this._copy=[...this.controlled]:this.hover?this._copy=[this.hover]:this._copy=[];const e=c.i18n.localize(getDocumentClass(this.constructor.documentName).metadata.label);return ui.notifications.info(c.i18n.format("CONTROLS.CopiedObjects",{count:this._copy.length,type:e})),this._copy}async pasteObjects(e,{hidden:t=!1,snap:i=!0}={}){if(!this._copy.length)return[];const n={x:0,y:0};for(const e of this._copy){const t=e.center;n.x+=t.x,n.y+=t.y}n.x/=this._copy.length,n.y/=this._copy.length;const s={x:e.x-n.x,y:e.y-n.y},o=[];for(const e of this._copy)o.push(this._pasteObject(e,s,{hidden:t,snap:i}));Hooks$1.call(`paste${this.constructor.documentName}`,this._copy,o);const r=await canvas.scene.createEmbeddedDocuments(this.constructor.documentName,o);return ui.notifications.info(c.i18n.format("CONTROLS.PastedObjects",{count:r.length,type:c.i18n.localize(getDocumentClass(this.constructor.documentName).metadata.label)})),r}_pasteObject(e,t,{hidden:i=!1,snap:n=!0}={}){const{x:s,y:o}=e.document;let r={x:s+t.x,y:o+t.y};n&&(r=this.getSnappedPoint(r));const a=canvas.dimensions;r.x=Math.clamp(r.x,0,a.width-1),r.y=Math.clamp(r.y,0,a.height-1);const l=e.document.toObject();return delete l._id,l.x=r.x,l.y=r.y,l.hidden||=i,l}selectObjects({x:e,y:t,width:i,height:n,releaseOptions:s={},controlOptions:o={}}={},{releaseOthers:r=!0}={}){if(!this.options.controllableObjects)return!1;const a=new Set(this.controlled),l=new Set,c=new PIXI.Rectangle(e,t,i,n);for(const e of this.controllableObjects())e._overlapsSelection(c)&&l.add(e);const d=a.difference(l);r&&d.forEach((e=>e.release(s))),foundry.utils.isEmpty(o)&&(o.releaseOthers=!1);const u=l.difference(a);return u.forEach((e=>e.control(o))),r&&d.size>0||u.size>0}async updateAll(e,t=null,i={}){const n=e instanceof Function;if(!n&&"Object"!==foundry.utils.getType(e))throw new Error("You must provide a data object or transformation function");const s=t instanceof Function,o=this.placeables.reduce(((i,o)=>{if(s&&!t(o))return i;const r=n?e(o):foundry.utils.deepClone(e);return r._id=o.id,i.push(r),i}),[]);return canvas.scene.updateEmbeddedDocuments(this.constructor.documentName,o,i)}_canvasCoordinatesFromDrop(e,{center:t=!0}={}){let i=canvas.canvasCoordinatesFromClient({x:e.clientX,y:e.clientY});return t&&(i=canvas.grid.getCenterPoint(i)),!!canvas.dimensions.rect.contains(i.x,i.y)&&[i.x,i.y]}async _createPreview(e,{renderSheet:t=!0,top:i=0,left:n=0}={}){const s=this.constructor.documentName,o=new(getDocumentClass(s))(e,{parent:canvas.scene});if(!o.canUserModify(c.user,"create"))return ui.notifications.warn(c.i18n.format("PERMISSION.WarningNoCreate",{document:s}));const r=new g[s].objectClass(o);return this.activate(),this.preview.addChild(r),await r.draw(),t&&r.sheet.render(!0,{top:i,left:n}),r}_onClickLeft(e){e.target.hasActiveHUD||this.hud?.clear(),this.options.controllableObjects&&c.settings.get("core","leftClickRelease")&&!this.hover&&this.releaseAll()}_canDragLeftStart(e,t){return!(c.paused&&!c.user.isGM)||(ui.notifications.warn("GAME.PausedWarning",{localize:!0}),!1)}_onDragLeftStart(e){this.clearPreviewContainer()}_onDragLeftMove(e){const t=e.interactionData.preview;t&&!t._destroyed&&null===t.parent&&this.preview.addChild(t)}_onDragLeftDrop(e){const t=e.interactionData.preview;if(!t||t._destroyed)return;e.interactionData.clearPreviewContainer=!1;getDocumentClass(this.constructor.documentName).create(t.document.toObject(!1),{parent:canvas.scene}).finally((()=>this.clearPreviewContainer()))}_onDragLeftCancel(e){!1!==e.interactionData?.clearPreviewContainer&&this.clearPreviewContainer()}_onClickRight(e){e.target.hasActiveHUD||this.hud?.clear()}_onMouseWheel(e){if(this.preview.children.length)return;const t=e.shiftKey?canvas.grid.isHexagonal?30:45:15,i=t*Math.sign(e.delta);return this.rotateMany({delta:i,snap:t})}async _onDeleteKey(e){if(c.paused&&!c.user.isGM)return void ui.notifications.warn("GAME.PausedWarning",{localize:!0});const t=this.options.controllableObjects?this.controlled:this.hover?[this.hover]:[];if(!t.length)return;const i=t.reduce(((e,t)=>(t.interactionState===MouseInteractionManager.INTERACTION_STATES.DRAG||t.document.locked||!t.document.canUserModify(c.user,"delete")||(this.hover===t&&(this.hover=null),e.push(t.id)),e)),[]);if(i.length){const e=c.i18n.localize(getDocumentClass(this.constructor.documentName).metadata.label);if(this.options.confirmDeleteKey){if(!await foundry.applications.api.DialogV2.confirm({window:{title:c.i18n.format("DOCUMENT.Delete",{type:e})},content:`<p>${c.i18n.localize("AreYouSure")}</p>`,rejectClose:!1}))return}const t=await canvas.scene.deleteEmbeddedDocuments(this.constructor.documentName,i);1!==t.length&&ui.notifications.info(c.i18n.format("CONTROLS.DeletedObjects",{count:t.length,type:e}))}}get gridPrecision(){foundry.utils.logCompatibilityWarning("PlaceablesLayer#gridPrecision is deprecated. Use PlaceablesLayer#getSnappedPoint instead of GridLayer#getSnappedPosition and PlaceablesLayer#gridPrecision.",{since:12,until:14,once:!0});const e=canvas.grid;return e.type===CONST.GRID_TYPES.GRIDLESS?0:e.type===CONST.GRID_TYPES.SQUARE||this.options.controllableObjects?2:5}get _highlight(){return foundry.utils.logCompatibilityWarning("PlaceablesLayer#_highlight is deprecated. Use PlaceablesLayer#highlightObjects instead.",{since:11,until:13}),this.highlightObjects}set _highlight(e){foundry.utils.logCompatibilityWarning("PlaceablesLayer#_highlight is deprecated. Use PlaceablesLayer#highlightObjects instead.",{since:11,until:13}),this.highlightObjects=!!e}}class ParticleEffect extends(FullCanvasObjectMixin(PIXI.Container)){constructor(e={}){super(),this.emitters=this.getParticleEmitters(e)}createEmitter(e){return e.autoUpdate=!0,e.emit=!1,new PIXI.particles.Emitter(this,e)}getParticleEmitters(e={}){if(foundry.utils.isEmpty(e))throw new Error("The base ParticleEffect class may only be used with an explicitly provided configuration");return[this.createEmitter(e)]}destroy(...e){for(const e of this.emitters)e.destroy();this.emitters=[],super.destroy(...e)}play(){for(let e of this.emitters)e.emit=!0}stop(){for(let e of this.emitters)e.emit=!1}}class AutumnLeavesWeatherEffect extends ParticleEffect{static label="WEATHER.AutumnLeaves";static LEAF_CONFIG={lifetime:{min:10,max:10},behaviors:[{type:"alpha",config:{alpha:{list:[{time:0,value:.9},{time:1,value:.5}]}}},{type:"moveSpeed",config:{speed:{list:[{time:0,value:20},{time:1,value:60}]},minMult:.6}},{type:"scale",config:{scale:{list:[{time:0,value:.2},{time:1,value:.4}]},minMult:.5}},{type:"rotation",config:{accel:0,minSpeed:100,maxSpeed:200,minStart:0,maxStart:365}},{type:"textureRandom",config:{textures:Array.fromRange(6).map((e=>`ui/particles/leaf${e+1}.png`))}}]};getParticleEmitters(){const e=canvas.dimensions,t=e.width/e.size*(e.height/e.size)*.25,i=foundry.utils.deepClone(this.constructor.LEAF_CONFIG);return i.maxParticles=t,i.frequency=i.lifetime.min/t,i.behaviors.push({type:"spawnShape",config:{type:"rect",data:{x:e.sceneRect.x,y:e.sceneRect.y,w:e.sceneRect.width,h:e.sceneRect.height}}}),[this.createEmitter(i)]}}class Cursor extends PIXI.Container{constructor(e){super(),this.target={x:0,y:0},this.draw(e)}#en;refreshVisibility(e){const t=this.visible=!e.isSelf&&e.hasPermission("SHOW_CURSOR");t&&!this.#en?(canvas.app.ticker.add(this._animate,this),this.#en=!0):!t&&this.#en&&(canvas.app.ticker.remove(this._animate,this),this.#en=!1)}draw(e){this.addChild(new PIXI.Graphics).beginFill(e.color,.35).lineStyle(1,0,.5).drawCircle(0,0,6);const t=g.canvasTextStyle.clone();t.fontSize=14;let i=this.addChild(new PreciseText(e.name,t));i.x-=i.width/2,i.y+=10,this.refreshVisibility(e)}_animate(){const e=this.target.y-this.y,t=this.target.x-this.x;Math.abs(t)+Math.abs(e)<10||(this.x+=t/10,this.y+=e/10)}destroy(e){this.#en&&(canvas.app.ticker.remove(this._animate,this),this.#en=!1),super.destroy(e)}}class DoorControl extends PIXI.Container{constructor(e){super(),this.wall=e,this.visible=!1}get center(){return this.wall.center}async draw(){return this.bg=this.bg||this.addChild(new PIXI.Graphics),this.bg.clear().beginFill(0,1).drawRoundedRect(-2,-2,44,44,5).endFill(),this.bg.alpha=0,this.icon=this.icon||this.addChild(new PIXI.Sprite),this.icon.width=this.icon.height=40,this.icon.alpha=.6,this.icon.texture=this._getTexture(),this.border=this.border||this.addChild(new PIXI.Graphics),this.border.clear().lineStyle(1,16733440,.8).drawRoundedRect(-2,-2,44,44,5).endFill(),this.border.visible=!1,this.eventMode="static",this.interactiveChildren=!1,this.hitArea=new PIXI.Rectangle(-2,-2,44,44),this.cursor="pointer",this.reposition(),this.alpha=1,this.removeAllListeners(),this.on("pointerover",this._onMouseOver).on("pointerout",this._onMouseOut).on("pointerdown",this._onMouseDown).on("rightdown",this._onRightDown),this}_getTexture(){const e=CONST.WALL_DOOR_STATES;let t=this.wall.document.ds;c.user.isGM||t!==e.LOCKED||(t=e.CLOSED);const i=g.controlIcons;let n={[e.LOCKED]:i.doorLocked,[e.CLOSED]:i.doorClosed,[e.OPEN]:i.doorOpen}[t]||i.doorClosed;return t===e.CLOSED&&this.wall.document.door===CONST.WALL_DOOR_TYPES.SECRET&&(n=i.doorSecret),getTexture(n)}reposition(){let e=this.wall.midpoint.map((e=>e-20));this.position.set(...e)}get isVisible(){if(!canvas.visibility.tokenVision)return!0;const e=this.wall;if(e.document.door===CONST.WALL_DOOR_TYPES.SECRET&&!c.user.isGM)return!1;const t=this.wall.toRay(),[i,n]=e.midpoint,[s,o]=[-t.dy,t.dx],r=3/(Math.abs(s)+Math.abs(o));return[{x:i+r*s,y:n+r*o},{x:i-r*s,y:n-r*o}].some((e=>canvas.visibility.testVisibility(e,{object:this,tolerance:0})))}_onMouseOver(e){e.stopPropagation();const t=c.user.can("WALL_DOORS"),i=c.paused&&!c.user.isGM;if(!t||i)return!1;this.border.visible=!0,this.icon.alpha=1,this.bg.alpha=.25,canvas.walls.hover=this.wall}_onMouseOut(e){if(e.stopPropagation(),c.paused&&!c.user.isGM)return!1;this.border.visible=!1,this.icon.alpha=.6,this.bg.alpha=0,canvas.walls.hover=null}_onMouseDown(e){if(0!==e.button)return;e.stopPropagation();const{ds:t}=this.wall.document,i=CONST.WALL_DOOR_STATES;if(!c.user.can("WALL_DOORS"))return!1;if(c.paused&&!c.user.isGM)return ui.notifications.warn("GAME.PausedWarning",{localize:!0}),!1;const n=!(c.user.isGM&&c.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT));return t===i.LOCKED?(n&&this.wall._playDoorSound("test"),!1):this.wall.document.update({ds:t===i.CLOSED?i.OPEN:i.CLOSED},{sound:n})}_onRightDown(e){if(e.stopPropagation(),!c.user.isGM)return;let t=this.wall.document.ds;const i=CONST.WALL_DOOR_STATES;if(t===i.OPEN)return;t=t===i.LOCKED?i.CLOSED:i.LOCKED;const n=!(c.user.isGM&&c.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT));return this.wall.document.update({ds:t},{sound:n})}}class Ruler extends PIXI.Container{constructor(e=c.user,{color:t}={}){super(),this.user=e,this.name=`Ruler.${e.id}`,this.color=Color.from(t??this.user.color),this.ruler=this.addChild(new PIXI.Graphics),this.labels=this.addChild(new PIXI.Container)}static get STATES(){return Ruler.#di}static#di=Object.freeze({INACTIVE:0,STARTING:1,MEASURING:2,MOVING:3});static get canMeasure(){return"ruler"===c.activeTool||c.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL)}destination=null;get origin(){return this.waypoints.at(0)??null}waypoints=[];segments=[];get history(){return this.#tn}#tn=[];totalDistance=0;totalCost=0;get state(){return this._state}_state=Ruler.STATES.INACTIVE;get active(){return this.state!==Ruler.STATES.INACTIVE}get highlightLayer(){return canvas.interface.grid.highlightLayers[this.name]||canvas.interface.grid.addHighlightLayer(this.name)}get token(){return this.#in}#in=null;clear(){this._state=Ruler.STATES.INACTIVE,this.#in=null,this.destination=null,this.waypoints=[],this.segments=[],this.#tn=[],this.totalDistance=0,this.totalCost=0,this.ruler.clear(),this.labels.removeChildren().forEach((e=>e.destroy())),canvas.interface.grid.clearHighlightLayer(this.name)}measure(e,{snap:t=!0,force:i=!1}={}){if(this.state!==Ruler.STATES.MEASURING)return;const n=this._getMeasurementDestination(e,{snap:t});if(!this.destination||n.x!==this.destination.x||n.y!==this.destination.y||i){this.destination=n,this.segments=this._getMeasurementSegments(),this._computeDistance(),this._broadcastMeasurement(),this.ruler.clear(),this._drawMeasuredPath(),this.highlightLayer.clear();for(const e of this.segments)this._highlightMeasurementSegment(e);return this.segments}}_getMeasurementOrigin(e,{snap:t=!0}={}){if(this.token&&t){if(canvas.grid.isGridless)return this.token.getCenterPoint();const t=this.token.getSnappedPosition(),i=this.token.document.x-Math.round(t.x),n=this.token.document.y-Math.round(t.y),s=canvas.grid.getCenterPoint({x:e.x-i,y:e.y-n});return{x:s.x+i,y:s.y+n}}return t?canvas.grid.getCenterPoint(e):{x:e.x,y:e.y}}_getMeasurementDestination(e,{snap:t=!0}={}){return t?canvas.grid.getCenterPoint(e):{x:e.x,y:e.y}}_getMeasurementSegments(){const e=[],t=this.history.concat(this.waypoints.concat([this.destination]));for(let i=1;i<t.length;i++){const n=this.labels.children.at(i-1)??this.labels.addChild(new PreciseText("",g.canvasTextStyle)),s=new Ray(t[i-1],t[i]);e.push({ray:s,teleport:i<this.history.length?t[i].teleport:i===this.history.length&&s.distance>0,label:n,distance:0,cost:0,cumulativeDistance:0,cumulativeCost:0,history:i<=this.history.length,first:i===this.history.length+1,last:i===t.length-1,animation:{}})}return this.labels.children.length>e.length&&this.labels.removeChildren(e.length).forEach((e=>e.destroy())),e}_startMeasurement(e,{snap:t=!0,token:i}={}){this.state===Ruler.STATES.INACTIVE&&(this.clear(),this._state=Ruler.STATES.STARTING,this.#in=void 0!==i?i:this._getMovementToken(e),this.#tn=this._getMeasurementHistory()??[],this._addWaypoint(e,{snap:t}),canvas.hud.token.clear())}_endMeasurement(){this.state===Ruler.STATES.MEASURING&&(this.clear(),this._broadcastMeasurement())}_addWaypoint(e,{snap:t=!0}={}){if(this.state!==Ruler.STATES.STARTING&&this.state!==Ruler.STATES.MEASURING)return;const i=this.state===Ruler.STATES.STARTING?this._getMeasurementOrigin(e,{snap:t}):this._getMeasurementDestination(e,{snap:t});this.waypoints.push(i),this._state=Ruler.STATES.MEASURING,this.measure(this.destination??e,{snap:t,force:!0})}_removeWaypoint(){this.state!==Ruler.STATES.STARTING&&this.state!==Ruler.STATES.MEASURING||(this.state===Ruler.STATES.MEASURING&&this.waypoints.length>1?(this.waypoints.pop(),this.measure(this.destination,{snap:!1,force:!0})):this._endMeasurement())}_getCostFunction(){}_computeDistance(){let e=[];this.segments.length&&e.push(this.segments[0].ray.A);for(const t of this.segments){const{x:i,y:n}=t.ray.B;e.push({x:i,y:n,teleport:t.teleport})}const t=canvas.grid.measurePath(e,{cost:this._getCostFunction()}).segments;this.totalDistance=0,this.totalCost=0;for(let e=0;e<this.segments.length;e++){const i=this.segments[e],n=t[e].distance,s=i.history?this.history.at(e+1)?.cost??0:t[e].cost;this.totalDistance+=n,this.totalCost+=s,i.distance=n,i.cost=s,i.cumulativeDistance=this.totalDistance,i.cumulativeCost=this.totalCost}}_getSegmentLabel(e){if(e.teleport)return"";const t=canvas.grid.units;let i=""+Math.round(100*e.distance)/100;return t&&(i+=` ${t}`),e.last&&(i+=" ["+Math.round(100*this.totalDistance)/100,t&&(i+=` ${t}`),i+="]"),i}_drawMeasuredPath(){const e=[];let t=null;for(const i of this.segments){const n=i.ray;0!==n.distance&&(i.teleport?t=null:(t&&t.history===i.history||(t={points:[n.A],history:i.history},e.push(t)),t.points.push(n.B)));const s=i.label;if(s){const e=this._getSegmentLabel(i,this.totalDistance);s.text=e,s.alpha=i.last?1:.5,s.visible=!!e&&0!==n.distance,s.anchor.set(.5,.5);let{sizeX:t,sizeY:o}=canvas.grid;canvas.grid.isGridless&&(t=o=6);const r=8,a=(s.width+2*r+t)/Math.abs(2*n.dx),l=(s.height+2*r+o)/Math.abs(2*n.dy);s.position=n.project(1+Math.min(a,l))}}const i=e.map((e=>e.points)).flat();if(1===i.length)this.ruler.beginFill(0,.5,!0).drawCircle(i[0].x,i[0].y,3).endFill(),this.ruler.beginFill(this.color,.25,!0).drawCircle(i[0].x,i[0].y,2).endFill();else{const t=new PIXI.smooth.DashLineShader;for(const{points:i,history:n}of e)this.ruler.lineStyle({width:6,color:0,alpha:.5,shader:n?t:null,join:PIXI.LINE_JOIN.ROUND,cap:PIXI.LINE_CAP.ROUND}),this.ruler.drawPath(i),this.ruler.lineStyle({width:4,color:this.color,alpha:.25,shader:n?t:null,join:PIXI.LINE_JOIN.ROUND,cap:PIXI.LINE_CAP.ROUND}),this.ruler.drawPath(i)}this.ruler.beginFill(this.color,.25,!0).lineStyle(2,0,.5);for(const{x:e,y:t}of i)this.ruler.drawCircle(e,t,6);this.ruler.endFill()}_highlightMeasurementSegment(e){if(!e.teleport)for(const t of canvas.grid.getDirectPath([e.ray.A,e.ray.B])){const{x:e,y:i}=canvas.grid.getTopLeftPoint(t);canvas.interface.grid.highlightPosition(this.name,{x:e,y:i,color:this.color})}}async moveToken(){if(this.state!==Ruler.STATES.MEASURING)return!1;if(c.paused&&!c.user.isGM)return ui.notifications.warn("GAME.PausedWarning",{localize:!0}),!1;const e=this.token;if(!e)return!1;let t;try{this._canMove(e)||(t="RULER.MovementNotAllowed")}catch(e){t=e.message}return t?(ui.notifications.error(t,{localize:!0}),!1):(this._state=Ruler.STATES.MOVING,await this._preMove(e),await this._animateMovement(e),await this._postMove(e),this._state=Ruler.STATES.MEASURING,this._endMeasurement(),!0)}_getMovementToken(e){let t=canvas.tokens.controlled;!t.length&&c.user.character&&(t=c.user.character.getActiveTokens());for(const i of t){if(!i.visible||!i.shape)continue;const{x:t,y:n}=i.document;for(let s=-1;s<=1;s++)for(let o=-1;o<=1;o++)if(i.shape.contains(e.x-t+s,e.y-n+o))return i}return null}_getMeasurementHistory(){}_createMeasurementHistory(){if(!this.segments.length)return[];const e=this.segments[0].ray.A;return this.segments.reduce(((e,t)=>(0===t.ray.distance||e.push({x:t.ray.B.x,y:t.ray.B.y,teleport:t.teleport,cost:t.cost}),e)),[{x:e.x,y:e.y,teleport:!1,cost:0}])}_canMove(e){if(!e.document.canUserModify(c.user,"update"))throw new Error("RULER.MovementNoPermission");if(e.document.locked)throw new Error("RULER.MovementLocked");if(this.segments.some((t=>e.checkCollision(t.ray.B,{origin:t.ray.A,type:"move",mode:"any"}))))throw new Error("RULER.MovementCollision");return!0}async _animateMovement(e){const t=c.paused,i=this.segments[this.history.length].ray.A,n=e.document.x-i.x,s=e.document.y-i.y;let o;for(const i of this.segments){if(i.history||0===i.ray.distance)continue;const r=i.ray,{x:a,y:l}=e.document._source;if(!t&&c.paused)break;if(o&&(a!==o.x||l!==o.y))break;const d={x:Math.round(r.B.x+n),y:Math.round(r.B.y+s)};await this._animateSegment(e,i,d),o=d}}async _animateSegment(e,t,i,n={}){let s;void 0===t.animation?.name?s=e.animationName:s||=Symbol(e.animationName);const{x:o,y:r}=e.document._source;await e.animate({x:o,y:r},{name:s,duration:0}),foundry.utils.mergeObject(n,{teleport:t.teleport,animation:{...t.animation,name:s}},{overwrite:!1}),await e.document.update(i,n),await(CanvasAnimation.getAnimation(s)?.promise)}async _preMove(e){}async _postMove(e){}#nn=foundry.utils.throttle(this.#sn.bind(this),100);#sn(){c.user.broadcastActivity({ruler:this.active?this._getMeasurementData():null})}_broadcastMeasurement(){this.user.isSelf&&c.user.hasPermission("SHOW_RULER")&&this.#nn()}_getMeasurementData(){return foundry.utils.deepClone({state:this.state,token:this.token?.id??null,history:this.history,waypoints:this.waypoints,destination:this.destination})}update(e){if(!e||e.state===Ruler.STATES.INACTIVE)return this.clear();this._state=e.state,this.#in=canvas.tokens.get(e.token)??null,this.#tn=e.history,this.waypoints=e.waypoints,this.measure(e.destination,{snap:!1,force:!0})}_onDragStart(e){this._startMeasurement(e.interactionData.origin,{snap:!e.shiftKey}),this.token&&this.state===Ruler.STATES.MEASURING&&(this.token.document.locked=!0)}_onClickLeft(e){(e.ctrlKey||e.metaKey)&&this._addWaypoint(e.interactionData.origin,{snap:!e.shiftKey})}_onClickRight(e){const t=this.token;e.ctrlKey||e.metaKey?this._removeWaypoint():this._endMeasurement(),this.active?canvas.mouseInteractionManager._dragRight=!1:(t&&(t.document.locked=t.document._source.locked),canvas.mouseInteractionManager.cancel(e))}_onMouseMove(e){const t=e.interactionData.destination;canvas.dimensions.rect.contains(t.x,t.y)&&this.measure(t,{snap:!e.shiftKey})}_onMouseUp(e){if(!this.active)return;e.ctrlKey||e.metaKey||this.waypoints.length>1?e.preventDefault():(this.token&&(this.token.document.locked=this.token.document._source.locked),this._endMeasurement(),canvas.mouseInteractionManager.cancel(e))}_onMoveKeyDown(e){this.token&&(this.token.document.locked=this.token.document._source.locked),this.moveToken(),this.state!==Ruler.STATES.MEASURING&&canvas.mouseInteractionManager.cancel()}}class CanvasBackgroundAlterationEffects extends CanvasLayer{constructor(){super(),this.vision=this.addChild(new PIXI.Container),this.vision.sortableChildren=!0,this.visionPreferred=this.addChild(new PIXI.Container),this.visionPreferred.sortableChildren=!0,this.lighting=this.addChild(new PIXI.Container),this.lighting.sortableChildren=!0}async _draw(e){const t=this.vision.filter=new VoidFilter;t.blendMode=PIXI.BLEND_MODES.NORMAL,t.enabled=!1,this.vision.filters=[t],this.vision.filterArea=canvas.app.renderer.screen;const i=this.visionPreferred.filter=new VoidFilter;i.blendMode=PIXI.BLEND_MODES.NORMAL,i.enabled=!1,this.visionPreferred.filters=[i],this.visionPreferred.filterArea=canvas.app.renderer.screen;const n=g.Canvas.visualEffectsMaskingFilter,s=this.lighting.filter=n.create({visionTexture:canvas.masks.vision.renderTexture,darknessLevelTexture:canvas.effects.illumination.renderTexture,mode:n.FILTER_MODES.BACKGROUND});s.blendMode=PIXI.BLEND_MODES.NORMAL,this.lighting.filters=[s],this.lighting.filterArea=canvas.app.renderer.screen,canvas.effects.visualEffectsMaskingFilters.add(s)}async _tearDown(e){canvas.effects.visualEffectsMaskingFilters.delete(this.lighting?.filter),this.clear()}clear(){this.vision.removeChildren(),this.visionPreferred.removeChildren(),this.lighting.removeChildren()}}class CanvasColorationEffects extends CanvasLayer{constructor(){super(),this.sortableChildren=!0,this.#on=this.addChild(new PIXI.LegacyGraphics),this.#on.zIndex=-1/0}#on;filter;clear(){this.removeChildren(),this.addChild(this.#on)}async _draw(e){const t=g.Canvas.visualEffectsMaskingFilter;this.filter=t.create({visionTexture:canvas.masks.vision.renderTexture,darknessLevelTexture:canvas.effects.illumination.renderTexture,mode:t.FILTER_MODES.COLORATION}),this.filter.blendMode=PIXI.BLEND_MODES.ADD,this.filterArea=canvas.app.renderer.screen,this.filters=[this.filter],canvas.effects.visualEffectsMaskingFilters.add(this.filter),this.#on.clear().beginFill().drawShape(canvas.dimensions.rect).endFill()}async _tearDown(e){canvas.effects.visualEffectsMaskingFilters.delete(this.filter),this.#on.clear()}}class CanvasDarknessEffects extends CanvasLayer{constructor(){super(),this.sortableChildren=!0}clear(){this.removeChildren()}async _draw(e){this.filter=VoidFilter.create(),this.filter.blendMode=PIXI.BLEND_MODES.NORMAL,this.filterArea=canvas.app.renderer.screen,this.filters=[this.filter]}}class CanvasIlluminationEffects extends CanvasLayer{constructor(){super(),this.#ht()}filter;lights=new PIXI.Container;backgroundColorTexture;#rn;baselineMesh=new SpriteMesh;darknessLevelMeshes=new DarknessLevelContainer;get hasDynamicDarknessLevel(){return this.darknessLevelMeshes.children.length>0}get renderTexture(){return this.darknessLevelMeshes.renderTexture}#ht(){this.backgroundColorTexture=this._createBackgroundColorTexture(),this.baselineMesh.setShaderClass(BaselineIlluminationSamplerShader),this.baselineMesh.texture=this.darknessLevelMeshes.renderTexture,canvas.masks.addChild(this.darknessLevelMeshes),this.addChild(this.lights);const e=this.lights.render,t=this.baselineMesh;this.lights.render=i=>{t.render(i),e.call(this.lights,i)},this.lights.sortableChildren=!0}set backgroundColor(e){const t=this.#rn=Color.from(e).rgb;this.filter&&(this.filter.uniforms.replacementColor=t),this.backgroundColorTexture.baseTexture.resource.data.set(t),this.backgroundColorTexture.baseTexture.resource.update()}clear(){this.lights.removeChildren()}invalidateDarknessLevelContainer(e=!1){if(canvas.environment.globalLightSource.active&&(canvas.masks.vision.renderDirty=!0),!this.hasDynamicDarknessLevel&&!e)return;this.darknessLevelMeshes.renderDirty=!0;const compare=(e,t)=>t.shader.darknessLevel-e.shader.darknessLevel;this.darknessLevelMeshes.children.sort(compare),canvas.visibility.vision.light.global.meshes.children.sort(compare)}_createBackgroundColorTexture(){return PIXI.Texture.fromBuffer(new Float32Array(3),1,1,{type:PIXI.TYPES.FLOAT,format:PIXI.FORMATS.RGB,wrapMode:PIXI.WRAP_MODES.CLAMP,scaleMode:PIXI.SCALE_MODES.NEAREST,mipmap:PIXI.MIPMAP_MODES.OFF})}render(e){PointSourceMesh._priorBlendMode=void 0,PointSourceMesh._currentTexture=this.backgroundColorTexture,super.render(e)}async _draw(e){const t=g.Canvas.visualEffectsMaskingFilter;this.darknessLevel=canvas.darknessLevel,this.filter=t.create({visionTexture:canvas.masks.vision.renderTexture,darknessLevelTexture:canvas.effects.illumination.renderTexture,mode:t.FILTER_MODES.ILLUMINATION}),this.filter.blendMode=PIXI.BLEND_MODES.MULTIPLY,this.filterArea=canvas.app.renderer.screen,this.filters=[this.filter],canvas.effects.visualEffectsMaskingFilters.add(this.filter)}async _tearDown(e){canvas.effects.visualEffectsMaskingFilters.delete(this.filter),this.clear()}updateGlobalLight(){return foundry.utils.logCompatibilityWarning("CanvasIlluminationEffects#updateGlobalLight has been deprecated.",{since:11,until:13}),!1}background(){return foundry.utils.logCompatibilityWarning("CanvasIlluminationEffects#background is now obsolete.",{since:12,until:14}),null}get globalLight(){return foundry.utils.logCompatibilityWarning("CanvasIlluminationEffects#globalLight has been deprecated without replacement. Check thecanvas.environment.globalLightSource.active instead.",{since:12,until:14}),canvas.environment.globalLightSource.active}}class DarknessLevelContainer extends CachedContainer{constructor(...e){super(...e),this.autoRender=!1,this.on("childAdded",this.#an),this.on("childRemoved",this.#an)}static textureConfiguration={scaleMode:PIXI.SCALE_MODES.NEAREST,format:PIXI.FORMATS.RED,multisample:PIXI.MSAA_QUALITY.NONE,mipmap:PIXI.MIPMAP_MODES.OFF};#an(){this.autoRender=this.children.length>0,this.renderDirty=!0,canvas.perception.update({refreshVisionSources:!0,refreshLightSources:!0})}}class CanvasVisibility extends CanvasLayer{vision;explored;visibilityOverlay;#ln=new PIXI.LegacyGraphics;#cn=new PIXI.Matrix;#dn;visionModeData={source:void 0,activeLightingOptions:{}};lightingVisibility={background:VisionMode.LIGHTING_VISIBILITY.ENABLED,illumination:VisionMode.LIGHTING_VISIBILITY.ENABLED,coloration:VisionMode.LIGHTING_VISIBILITY.ENABLED,darkness:VisionMode.LIGHTING_VISIBILITY.ENABLED,any:!0};#un=new Map;static#hn=4096;get initialized(){return this.#Ye}#Ye=!1;get needsContainment(){return this.#pn}#pn=!1;get tokenVision(){return canvas.scene.tokenVision}get textureConfiguration(){return this.#gn}#gn;set explorationRect(e){this.#mn=e}#mn;initializeSources(){canvas.effects.toggleMaskingFilters(!1);for(const e of canvas.effects.visionSources)e.initialize();Hooks$1.callAll("initializeVisionSources",canvas.effects.visionSources)}initializeVisionMode(){this.visionModeData.source=this.#fn(),this.#vn(),this.#yn(),this.#bn(),Hooks$1.callAll("initializeVisionMode",this)}#fn(){return canvas.effects.visionSources.filter((e=>e.active)).sort(((e,t)=>e.isPreview-t.isPreview||e.isBlinded-t.isBlinded||t.visionMode.perceivesLight-e.visionMode.perceivesLight)).at(0)??null}#vn(){const e=this.visionModeData.source,t=e?.visionMode,i=this.lightingVisibility,n=VisionMode.LIGHTING_VISIBILITY;Object.assign(i,{background:CanvasVisibility.#Sn(t),illumination:t?.lighting.illumination.visibility??n.ENABLED,coloration:t?.lighting.coloration.visibility??n.ENABLED,darkness:t?.lighting.darkness.visibility??n.ENABLED}),i.any=i.background+i.illumination+i.coloration+i.darkness>VisionMode.LIGHTING_VISIBILITY.DISABLED}#yn(){const e=this.visionModeData.source?.visionMode.lighting||{},t=foundry.utils.diffObject(this.visionModeData.activeLightingOptions,e);if(this.visionModeData.activeLightingOptions=e,foundry.utils.isEmpty(e)&&canvas.effects.resetPostProcessingFilters(),foundry.utils.isEmpty(t))return;const i=g.Canvas.visualEffectsMaskingFilter.FILTER_MODES;canvas.effects.resetPostProcessingFilters();for(const t of["background","illumination","coloration"])if(t in e){const n=e[t],s=i[t.toUpperCase()];canvas.effects.activatePostProcessingFilters(s,n.postProcessingModes,n.uniforms)}}#bn(){const e=this.visionModeData.activeLightingOptions,t=this.visionModeData.source,i=t?.visionModeOverrides.colorRGB;for(const t of canvas.effects.visualEffectsMaskingFilters){const n=t.constructor.defaultUniforms.tint,s=e[t.uniforms.mode]?.uniforms?.tint;t.uniforms.tint=s?i??s??n:n}}static#Sn(e){const t=VisionMode.LIGHTING_VISIBILITY;let i=!1,n=!1;for(const e of canvas.effects.visionSources){if(!e.active)continue;const s=e.visionMode;if(s.lighting.background.visibility===t.REQUIRED)return t.REQUIRED;s.vision.preferred?i=!0:n=!0}return i&&n?t.REQUIRED:e?.lighting.background.visibility??t.ENABLED}async _draw(e){this.#Tn(),await canvas.fog.initialize(),this.vision=this.#En(),canvas.masks.vision.attachVision(this.vision),this.#Cn(!0),this.explored=this.addChild(this.#_n()),await this.#In(),this.filter=g.Canvas.visibilityFilter.create({unexploredColor:canvas.colors.fogUnexplored.rgb,exploredColor:canvas.colors.fogExplored.rgb,backgroundColor:canvas.colors.background.rgb,visionTexture:canvas.masks.vision.renderTexture,primaryTexture:canvas.primary.renderTexture,overlayTexture:this.visibilityOverlay?.texture??null,dimensions:this.#dn,hasOverlayTexture:!!this.visibilityOverlay?.texture.valid},canvas.visibilityOptions),this.filter.blendMode=PIXI.BLEND_MODES.NORMAL,this.filters=[this.filter],this.filterArea=canvas.app.screen,canvas.addBlurFilter(this.filter),this.visible=!1,this.#Ye=!0}#_n(){const e=canvas.dimensions,t=new PIXI.Container,i=t.addChild(canvas.fog.sprite),n=this.#mn;return n?(i.position.set(n.x,n.y),i.width=n.width,i.height=n.height):(i.position.set(e.sceneX,e.sceneY),i.width=this.#gn.width,i.height=this.#gn.height),t}#En(){const e=canvas.dimensions,t=new PIXI.Container;return t.containmentFilter=VoidFilter.create(),t.containmentFilter.blendMode=PIXI.BLEND_MODES.MAX_COLOR,t.containmentFilter.enabled=!1,t.filters=[t.containmentFilter],t.light=t.addChild(new PIXI.Container),t.light.global=t.light.addChild(new PIXI.Container),t.light.global.source=t.light.global.addChild(new PIXI.LegacyGraphics),t.light.global.meshes=t.light.global.addChild(new PIXI.Container),t.light.global.source.blendMode=PIXI.BLEND_MODES.MAX_COLOR,t.light.sources=t.light.addChild(new PIXI.LegacyGraphics),t.light.sources.blendMode=PIXI.BLEND_MODES.MAX_COLOR,t.light.preview=t.light.addChild(new PIXI.LegacyGraphics),t.light.preview.blendMode=PIXI.BLEND_MODES.MAX_COLOR,t.light.cached=t.light.addChild(new SpriteMesh(Canvas.getRenderTexture({textureConfiguration:this.textureConfiguration}))),t.light.cached.position.set(e.sceneX,e.sceneY),t.light.cached.blendMode=PIXI.BLEND_MODES.MAX_COLOR,t.light.mask=t.light.addChild(new PIXI.LegacyGraphics),t.light.mask.preview=t.light.mask.addChild(new PIXI.LegacyGraphics),t.sight=t.addChild(new PIXI.LegacyGraphics),t.sight.blendMode=PIXI.BLEND_MODES.MAX_COLOR,t.sight.preview=t.sight.addChild(new PIXI.LegacyGraphics),t.sight.preview.blendMode=PIXI.BLEND_MODES.MAX_COLOR,t.darkness=t.addChild(new PIXI.LegacyGraphics),t.darkness.blendMode=PIXI.BLEND_MODES.ERASE,Object.defineProperty(t,"base",{get(){return foundry.utils.logCompatibilityWarning("CanvasVisibility#vision#base is deprecated in favor of CanvasVisibility#vision#light#preview.",{since:12,until:14,once:!0}),this.fov.preview}}),Object.defineProperty(t,"fov",{get(){return foundry.utils.logCompatibilityWarning("CanvasVisibility#vision#fov is deprecated in favor of CanvasVisibility#vision#light.",{since:12,until:14,once:!0}),this.light}}),Object.defineProperty(t,"los",{get(){return foundry.utils.logCompatibilityWarning("CanvasVisibility#vision#los is deprecated in favor of CanvasVisibility#vision#light#mask.",{since:12,until:14,once:!0}),this.light.mask}}),Object.defineProperty(t.light,"lights",{get:()=>(foundry.utils.logCompatibilityWarning("CanvasVisibility#vision#fov#lights is deprecated without replacement.",{since:12,until:14,once:!0}),this.#ln)}),Object.defineProperty(t.light,"lightsSprite",{get(){return foundry.utils.logCompatibilityWarning("CanvasVisibility#vision#fov#lightsSprite is deprecated in favor of CanvasVisibility#vision#light#cached.",{since:12,until:14,once:!0}),this.cached}}),Object.defineProperty(t.light,"tokens",{get(){return foundry.utils.logCompatibilityWarning("CanvasVisibility#vision#tokens is deprecated in favor of CanvasVisibility#vision#light.",{since:12,until:14,once:!0}),this}}),t}async _tearDown(e){return canvas.masks.vision.detachVision(),this.#un.clear(),await canvas.fog.clear(),this.vision.destroy({children:!0,texture:!0,baseTexture:!0}),this.vision=void 0,canvas.effects.visionSources.clear(),this.#Ye=!1,super._tearDown(e)}refresh(){this.initialized&&(this.tokenVision?(this.refreshVisibility(),this.visible=canvas.effects.visionSources.some((e=>e.active))||!c.user.isGM):this.visible=!1,this.restrictVisibility())}refreshVisibility(){if(canvas.masks.vision.renderDirty=!0,!this.vision)return;const e=this.vision,t=16711680;this.#ln.beginFill(t),e.light.sources.clear().beginFill(t),e.light.preview.clear().beginFill(t),e.light.global.source.clear().beginFill(t),e.light.mask.clear().beginFill(),e.light.mask.preview.clear().beginFill(),e.sight.clear().beginFill(t),e.sight.preview.clear().beginFill(t),e.darkness.clear().beginFill(t);const i=this.#wn();i&&this.#un.clear();let n=i,s=!1;for(const[t,i]of canvas.effects.lightSources.entries()){if(!i.hasActiveLayer||i instanceof foundry.canvas.sources.GlobalLightSource)continue;i.data.vision&&(i.isPreview?e.light.mask.preview.drawShape(i.shape):(e.light.mask.drawShape(i.shape),s=!0));const o=this.#Dn(i);if(o){if(this.#un.has(t))continue;this.#un.set(t,i.updateId),n=!0}o?this.#ln.drawShape(i.shape):i.isPreview?e.light.preview.drawShape(i.shape):e.light.sources.drawShape(i.shape)}n&&this.#Cn(i),this.#On();for(const t of canvas.effects.visionSources){if(!t.hasActiveLayer)continue;const i=t.isBlinded;t.radius>0&&!i&&!t.isPreview?(e.sight.drawShape(t.shape),s=!0):e.sight.preview.drawShape(t.shape),t.lightRadius>0&&!i&&!t.isPreview?(e.light.mask.drawShape(t.light),s=!0):e.light.mask.preview.drawShape(t.light)}Hooks$1.callAll("visibilityRefresh",this),e.light.sources.endFill(),e.light.preview.endFill(),e.light.global.source.endFill(),e.light.mask.endFill(),e.light.mask.preview.endFill(),e.sight.endFill(),e.sight.preview.endFill(),e.darkness.endFill(),s&&canvas.fog.commit()}resetExploration(){this.explored&&(this.explored.destroy(),this.explored=this.addChild(this.#_n()))}#On(){this.#pn=!1;const e=canvas.environment.globalLightSource;if(!(this.vision.light.global.visible=e.active))return;const{min:t,max:i}=e.data.darkness,n=canvas.environment.darknessLevel;n>=t&&n<=i&&this.vision.light.global.source.drawShape(e.shape);const s=this.vision.light.global.meshes.children;for(const e of s){const n=e.shader.darknessLevel;n<t||n>i?(e.blendMode=PIXI.BLEND_MODES.ERASE,this.#pn=!0):e.blendMode=PIXI.BLEND_MODES.MAX_COLOR}}#Dn(e){return!(e.object instanceof Token||e.isPreview)}#wn(){for(const[e,t]of this.#un){const i=canvas.effects.lightSources.get(e);if(!i||!i.active||!this.#Dn(i)||t!==i.updateId)return!0}return!1}#Cn(e){const t=canvas.dimensions;this.#cn.tx=-t.sceneX,this.#cn.ty=-t.sceneY,this.#ln.blendMode=PIXI.BLEND_MODES.MAX_COLOR,canvas.app.renderer.render(this.#ln,{renderTexture:this.vision.light.cached.texture,clear:e,transform:this.#cn}),this.#ln.clear()}restrictVisibility(){canvas.effects.toggleMaskingFilters(this.visible);const e={refreshVisibility:!0};for(const t of canvas.tokens.placeables)t.renderFlags.set(e);for(const t of canvas.notes.placeables)t.renderFlags.set(e);for(const e of canvas.controls.doors.children)e.visible=e.isVisible;Hooks$1.callAll("sightRefresh",this)}testVisibility(e,t={}){if(!canvas.effects.visionSources.some((e=>e.active)))return c.user.isGM;const i=t.object??null,n=this._createVisibilityTestConfig(e,t);for(const e of canvas.effects.lightSources){if(!e.data.vision||!e.active)continue;if(!0===e.testVisibility(n))return!0}const s=canvas.dimensions.sceneRect,o=!s.contains(e.x,e.y),r=canvas.effects.visionSources.filter((e=>e.active&&o!==s.contains(e.x,e.y))),a=g.Canvas.detectionModes;for(const e of r){if(e.isBlinded)continue;const t=e.object.document,i=t.detectionModes.find((e=>"basicSight"===e.id));if(i){if(!0===a.basicSight.testVisibility(e,i,n))return!0}const s=t.detectionModes.find((e=>"lightPerception"===e.id));if(s){if(!0===a.lightPerception.testVisibility(e,s,n))return!0}}if(!(i instanceof Token))return!1;for(const e of r){const t=e.object.document;for(const s of t.detectionModes){if("basicSight"===s.id||"lightPerception"===s.id)continue;const t=a[s.id],o=t?.testVisibility(e,s,n);if(!0===o)return i.detectionFilter=t.constructor.getDetectionFilter(),!0}}return!1}_createVisibilityTestConfig(e,{tolerance:t=2,object:i=null}={}){const n=t>0?[[0,0],[-t,-t],[-t,t],[t,t],[t,-t],[-t,0],[t,0],[0,-t],[0,t]]:[[0,0]],s=i instanceof Token?i.document.elevation:0;return{object:i,tests:n.map((t=>({point:{x:e.x+t[0],y:e.y+t[1]},elevation:s,los:new Map})))}}async#In(){this.visibilityOverlay=void 0,this.#dn=[];const e=canvas.sceneTextures.fogOverlay??canvas.scene.fog.overlay,t=e instanceof PIXI.Texture?e:getTexture(e);if(!t)return;const i=this.visibilityOverlay=new PIXI.Sprite(t),n=canvas.primary.background,s=t.baseTexture;!n||i.width===n.width&&i.height===n.height?(i.width=n.width,i.height=n.height,i.position.set(n.x,n.y)):(i.width=canvas.scene.dimensions.width,i.height=canvas.scene.dimensions.height,i.position.set(0,0),s.wrapMode=PIXI.WRAP_MODES.REPEAT),i.renderable=!1,this.addChild(this.visibilityOverlay);const o=c.video.getVideoSource(t);if(o){const e={volume:0};c.video.play(o,e)}this.#dn=[i.width,i.height,s.width,s.height]}#Tn(){const e=canvas.dimensions;let t=e.sceneWidth,i=e.sceneHeight;const n=CanvasVisibility.#hn;let s=1;return t>=i&&t>n?(s=n/t,i=Math.ceil(i*s)/s):i>n&&(s=n/i,t=Math.ceil(t*s)/s),this.#gn={resolution:s,width:t,height:i,mipmap:PIXI.MIPMAP_MODES.OFF,multisample:PIXI.MSAA_QUALITY.NONE,scaleMode:PIXI.SCALE_MODES.LINEAR,alphaMode:PIXI.ALPHA_MODES.NPM,format:PIXI.FORMATS.RED}}get fogOverlay(){return foundry.utils.logCompatibilityWarning("fogOverlay is deprecated in favor of visibilityOverlay",{since:11,until:13}),this.visibilityOverlay}}class WeatherEffects extends(FullCanvasObjectMixin(CanvasLayer)){constructor(){super(),this.#xn(),this.mask=canvas.masks.scene,this.sortableChildren=!0,this.eventMode="none"}weatherEffects;suppression;#xn(){this.#Nn=VoidFilter.create(),this.occlusionFilter=WeatherOcclusionMaskFilter.create({occlusionTexture:canvas.masks.depth.renderTexture}),this.#Nn.enabled=this.occlusionFilter.enabled=!1,this.#Nn.blendMode=PIXI.BLEND_MODES.SCREEN,this.occlusionFilter.elevation=this.#pi,this.filterArea=canvas.app.renderer.screen,this.filters=[this.occlusionFilter,this.#Nn]}static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"effects"})}effects=new Map;terrainMaskConfig;occlusionMaskConfig;occlusionFilter;#Nn;get elevation(){return this.#pi}set elevation(e){if("number"!=typeof e||Number.isNaN(e))throw new Error("WeatherEffects#elevation must be a numeric value.");e!==this.#pi&&(this.#pi=e,this.parent&&(this.parent.sortDirty=!0))}#pi=1/0;get sortLayer(){return this.#An}set sortLayer(e){if("number"!=typeof e||Number.isNaN(e))throw new Error("WeatherEffects#sortLayer must be a numeric value.");e!==this.#An&&(this.#An=e,this.parent&&(this.parent.sortDirty=!0))}#An=PrimaryCanvasGroup.SORT_LAYERS.WEATHER;get sort(){return this.#Rn}set sort(e){if("number"!=typeof e||Number.isNaN(e))throw new Error("WeatherEffects#sort must be a numeric value.");e!==this.#Rn&&(this.#Rn=e,this.parent&&(this.parent.sortDirty=!0))}#Rn=0;get zIndex(){return this._zIndex}set zIndex(e){if("number"!=typeof e||Number.isNaN(e))throw new Error("WeatherEffects#zIndex must be a numeric value.");e!==this._zIndex&&(this._zIndex=e,this.parent&&(this.parent.sortDirty=!0))}async _draw(e){const t=g.weatherEffects[canvas.scene.weather];this.weatherEffects=this.addChild(new PIXI.Container),this.suppression=this.addChild(new PIXI.Container);for(const e of["childAdded","childRemoved"])this.suppression.on(e,(()=>{this.#Nn.enabled=!this.occlusionFilter.enabled&&!!this.suppression.children.length}));this.initializeEffects(t)}async _tearDown(e){return this.clearEffects(),super._tearDown(e)}initializeEffects(e){this.#Pn(),Hooks$1.callAll("initializeWeatherEffects",this,e),this.#kn(e)}clearEffects(){this.initializeEffects(null)}#Pn(){if(0!==this.effects.size){for(const e of this.effects.values())e.destroy();this.effects.clear()}}#kn(e){if(!e)return void(this.#Nn.enabled=this.occlusionFilter.enabled=!1);const t=e.effects;let i=0;const n=!1!==e.filter?.enabled;n?(WeatherEffects.configureOcclusionMask(this.occlusionFilter,this.occlusionMaskConfig||{enabled:!0}),this.terrainMaskConfig&&WeatherEffects.configureTerrainMask(this.occlusionFilter,this.terrainMaskConfig),this.occlusionFilter.blendMode=e.filter?.blendMode??PIXI.BLEND_MODES.NORMAL,this.occlusionFilter.enabled=!0,this.#Nn.enabled=!1):this.#Nn.enabled=!!this.suppression.children.length;for(const e of t){const t=Number.isNumeric(e.performanceLevel)?e.performanceLevel:0;if(canvas.performance.mode<t){console.debug(`Skipping weather effect ${e.id}. The client performance level ${canvas.performance.mode} is less than the required performance mode ${t} for the effect`);continue}let s;try{s=new e.effectClass(e.config,e.shaderClass)}catch(e){e.message=`Failed to construct weather effect: ${e.message}`,console.error(e);continue}s.zIndex=e.zIndex??i++,s.blendMode=e.blendMode??PIXI.BLEND_MODES.NORMAL,e.shaderClass&&!n&&(WeatherEffects.configureOcclusionMask(s.shader,this.occlusionMaskConfig||{enabled:!0}),this.terrainMaskConfig&&WeatherEffects.configureTerrainMask(s.shader,this.terrainMaskConfig)),this.weatherEffects.addChild(s),this.effects.set(e.id,s),s.play()}}static configureOcclusionMask(e,{enabled:t=!1,channelWeights:i=[0,0,1,0],reverse:n=!1,texture:s}={}){if(!(e instanceof PIXI.Shader))return;const o=e.uniforms;void 0!==s?o.occlusionTexture=s:o.occlusionTexture??=canvas.masks.depth.renderTexture,o.useOcclusion=t,o.occlusionWeights=i,o.reverseOcclusion=n,t&&!o.occlusionTexture&&(console.warn(`The occlusion configuration for the weather shader ${e.constructor.name} is enabled but does not have a valid texture`),o.useOcclusion=!1)}static configureTerrainMask(e,{enabled:t=!1,channelWeights:i=[1,0,0,0],reverse:n=!1,texture:s}={}){if(!(e instanceof PIXI.Shader))return;const o=e.uniforms;if(void 0!==s){o.terrainTexture=s;const e=new PIXI.TextureMatrix(s);e.update(),o.terrainUvMatrix.copyFrom(e.mapCoord)}o.useTerrain=t,o.terrainWeights=i,o.reverseTerrain=n,t&&!o.terrainTexture&&(console.warn(`The terrain configuration for the weather shader ${e.constructor.name} is enabled but does not have a valid texture`),o.useTerrain=!1)}get weather(){return foundry.utils.logCompatibilityWarning("The WeatherContainer at canvas.weather.weather is deprecated and combined with the layer itself.",{since:11,until:13}),this}}class GridHighlight extends PIXI.Graphics{constructor(e,...t){super(...t),this.name=e,this.positions=new Set}highlight(e,t){let i=`${e},${t}`;return!this.positions.has(i)&&(this.positions.add(i),!0)}clear(){return this.positions=new Set,super.clear()}destroy(...e){return delete canvas.interface.grid.highlightLayers[this.name],super.destroy(...e)}}class GridMesh extends QuadMesh{constructor(e=GridShader){super(e),this.width=0,this.height=0,this.alpha=0,this.renderable=!1}data={type:CONST.GRID_TYPES.GRIDLESS,width:0,height:0,size:0,thickness:1,color:0,alpha:1};initialize(e){this._initialize(e);const t=this.data;return this.width=t.width,this.height=t.height,this.alpha=t.alpha,this.renderable=t.type!==CONST.GRID_TYPES.GRIDLESS&&t.thickness>0,this}_initialize(e){const t=this.data;if(void 0!==e.type&&(t.type=e.type),void 0!==e.width&&(t.width=e.width),void 0!==e.height&&(t.height=e.height),void 0!==e.size&&(t.size=e.size),void 0!==e.thickness&&(t.thickness=e.thickness),void 0!==e.color){const i=Color.from(e.color);t.color=i.valid?i.valueOf():0}void 0!==e.alpha&&(t.alpha=e.alpha)}}class CanvasDepthMask extends CachedContainer{constructor(...e){super(...e),this.#Mn()}roofs;static textureConfiguration={scaleMode:PIXI.SCALE_MODES.NEAREST,format:PIXI.FORMATS.RGB,multisample:PIXI.MSAA_QUALITY.NONE};clearColor=[0,0,0,0];_elevationDirty=!1;#Ln=new Float64Array([-1/0]);mapElevation(e){const t=this.#Ln;if(e<t[0])return 0;let i=0,n=t.length-1;for(;i<n;){const s=i+n+1>>1;t[s]<=e?i=s:n=s-1}return(i+1)/255}_update(){if(!this._elevationDirty)return;this._elevationDirty=!1;const e=[],t=canvas.primary.children;for(let i=0,n=t.length;i<n;i++){const n=t[i];if(!n.shouldRenderDepth)continue;const s=n.elevation;s!==e.at(-1)&&e.push(s)}e.length?e.length=Math.min(e.length,255):e.push(-1/0),this.#Ln=new Float64Array(e)}#Mn(){this.roofs=this.addChild(this.#Fn())}#Fn(){const e=new PIXI.Container;return e.render=(e=>{for(const t of canvas.primary.children)t.renderDepthData?.(e)}).bind(e),e}clear(){Canvas.clearContainer(this.roofs,!1)}}class CanvasOcclusionMask extends CachedContainer{constructor(...e){super(...e),this.#Un()}static textureConfiguration={scaleMode:PIXI.SCALE_MODES.NEAREST,format:PIXI.FORMATS.RGB,multisample:PIXI.MSAA_QUALITY.NONE};tokens;#Bn;clearColor=[0,1,1,1];autoRender=!1;get vision(){return this.#Gn}#Gn=!1;#Ln=new Float64Array([-1/0]);#Un(){this.alphaMode=PIXI.ALPHA_MODES.NO_PREMULTIPLIED_ALPHA,this.tokens=this.addChild(new PIXI.LegacyGraphics),this.tokens.blendMode=PIXI.BLEND_MODES.MIN_ALL}clear(){this.tokens.clear()}mapElevation(e){const t=this.#Ln;let i=0,n=t.length-1;if(e>t[n])return 1;for(;i<n;){const s=i+n>>1;t[s]>=e?n=s:i=s+1}return i/255}updateOcclusion(){this.#Bn=canvas.tokens._getOccludableTokens(),this._updateOcclusionMask(),this._updateOcclusionStates()}_updateOcclusionMask(){this.#Gn=!1,this.tokens.clear();const e=[];for(const t of this.#Bn.sort(((e,t)=>e.document.elevation-t.document.elevation))){const i=t.document.elevation;i!==e.at(-1)&&e.push(i);const n=Math.min(e.length-1,255);t.vision?.active&&(this.#Gn=!0,this.tokens.beginFill(16776960|n).drawShape(t.vision.los).endFill());const s=t.center,o=Math.max(t.externalRadius,t.getLightRadius(t.document.occludable.radius));this.tokens.beginFill(16711680|n<<8|(t.vision?.active?255:n)).drawCircle(s.x,s.y,o).endFill()}e.length?e.length=Math.min(e.length,255):e.push(-1/0),this.#Ln=new Float64Array(e),this.renderDirty=!0}_updateOcclusionStates(){const e=this._identifyOccludedObjects(this.#Bn);for(const t of canvas.primary.children){const i=t.isOccludable;void 0!==i&&(i||t.occluded)&&t.debounceSetOcclusion(e.has(t))}}_identifyOccludedObjects(e){const t=new Set;for(const i of e){const e=canvas.primary.quadtree.getObjects(i.bounds);for(const n of e)n.isOccludable&&!t.has(n)&&n.testOcclusion(i,{corners:n.restrictsLight&&n.restrictsWeather})&&t.add(n)}return t}_identifyOccludedTiles(){return foundry.utils.logCompatibilityWarning("CanvasOcclusionMask#_identifyOccludedTiles has been deprecated in favor of CanvasOcclusionMask#_identifyOccludedObjects.",{since:11,until:13}),this._identifyOccludedObjects()}}class CanvasVisionMask extends CachedContainer{static textureConfiguration={scaleMode:PIXI.SCALE_MODES.NEAREST,format:PIXI.FORMATS.RED,multisample:PIXI.MSAA_QUALITY.NONE};clearColor=[0,0,0,0];autoRender=!1;vision;blurFilter;#jn(){this.filters??=[],this.filterArea=null;const e=canvas.blur;if(this.filters.findSplice((e=>e===this.blurFilter)),!e.enabled)return;const t=this.blurFilter=new e.blurClass(e.strength,e.passes,PIXI.Filter.defaultResolution,e.kernels);return t.blendMode=PIXI.BLEND_MODES.NORMAL,this.filterArea=canvas.app.renderer.screen,this.filters.push(t),canvas.addBlurFilter(this.blurFilter)}async draw(){this.#jn()}attachVision(e){return this.vision=this.addChild(e)}detachVision(){const e=this.vision;return this.removeChild(e),this.vision=void 0,e}get filter(){return foundry.utils.logCompatibilityWarning("CanvasVisionMask#filter has been renamed to blurFilter.",{since:11,until:13}),this.blurFilter}set filter(e){foundry.utils.logCompatibilityWarning("CanvasVisionMask#filter has been renamed to blurFilter.",{since:11,until:13}),this.blurFilter=e}}class DrawingsLayer extends PlaceablesLayer{static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"drawings",controllableObjects:!0,rotatableObjects:!0,zIndex:500})}static documentName="Drawing";static DEFAULT_CONFIG_SETTING="defaultDrawingConfig";graphics=new foundry.utils.Collection;get hud(){return canvas.hud.drawing}get hookName(){return DrawingsLayer.name}getSnappedPoint(e){const t=CONST.GRID_SNAPPING_MODES,i=canvas.dimensions.size;return canvas.grid.getSnappedPoint(e,canvas.forceSnapVertices?{mode:t.VERTEX}:{mode:t.CENTER|t.VERTEX|t.CORNER|t.SIDE_MIDPOINT,resolution:i>=128?8:i>=64?4:2})}configureDefault(){const e=c.settings.get("core",DrawingsLayer.DEFAULT_CONFIG_SETTING),t=DrawingDocument.fromSource(e);new DrawingConfig(t,{configureDefault:!0}).render(!0)}_deactivate(){super._deactivate(),this.objects.visible=!0}async _draw(e){await super._draw(e),this.objects.visible=!0}_getNewDrawingData(e){const t=c.activeTool,i=c.settings.get("core",this.constructor.DEFAULT_CONFIG_SETTING)||{},n=c.user.color.css,s=foundry.utils.mergeObject(i,{fillColor:n,strokeColor:n,fontFamily:g.defaultFontFamily},{overwrite:!1,inplace:!1});delete s._id,s.x=e.x,s.y=e.y,s.sort=Math.max(this.getMaxSort()+1,0),s.author=c.user.id,s.shape={};const o=ui.controls.controls.find((e=>"drawings"===e.layer)).tools.find((e=>"role"===e.name));switch(s.interface=o.active,t){case"rect":s.shape.type=Drawing.SHAPE_TYPES.RECTANGLE,s.shape.width=1,s.shape.height=1;break;case"ellipse":s.shape.type=Drawing.SHAPE_TYPES.ELLIPSE,s.shape.width=1,s.shape.height=1;break;case"polygon":s.shape.type=Drawing.SHAPE_TYPES.POLYGON,s.shape.points=[0,0],s.bezierFactor=0;break;case"freehand":s.shape.type=Drawing.SHAPE_TYPES.POLYGON,s.shape.points=[0,0],s.bezierFactor=s.bezierFactor??.5;break;case"text":s.shape.type=Drawing.SHAPE_TYPES.RECTANGLE,s.shape.width=1,s.shape.height=1,s.fillColor="#ffffff",s.fillAlpha=.1,s.strokeColor="#ffffff",s.text||=""}return DrawingDocument.cleanData(s)}_onClickLeft(e){const{preview:t,drawingsState:i,destination:n}=e.interactionData;if(i>=1&&t.isPolygon)return t._addPoint(n,{snap:!e.shiftKey,round:!0}),t._chain=!0,t.refresh();super._onClickLeft(e)}_onClickLeft2(e){const{drawingsState:t,preview:i}=e.interactionData;t>=1&&i.isPolygon?e.interactionData.drawingsState=2:super._onClickLeft2(e)}_onDragLeftStart(e){super._onDragLeftStart(e);const t=e.interactionData,i="freehand"===c.activeTool;e.shiftKey||i||(t.origin=this.getSnappedPoint(t.origin));const n=getDocumentClass("Drawing");let s;try{s=new n(this._getNewDrawingData(t.origin),{parent:canvas.scene})}catch(e){throw e instanceof foundry.data.validation.DataModelValidationError&&ui.notifications.error("DRAWING.JointValidationErrorUI",{localize:!0}),e}const o=new this.constructor.placeableClass(s);t.preview=this.preview.addChild(o),t.drawingsState=1,o.draw()}_onDragLeftMove(e){const{preview:t,drawingsState:i}=e.interactionData;if(t&&!t._destroyed&&(null===t.parent&&this.preview.addChild(t),i>=1)){t._onMouseDraw(e);const i="freehand"===c.activeTool;t.isPolygon&&!i||(e.interactionData.drawingsState=2)}}_onDragLeftDrop(e){const t=e.interactionData,i="freehand"===c.activeTool;e.shiftKey||i||(t.destination=this.getSnappedPoint(t.destination));const{drawingsState:n,destination:s,origin:o,preview:r}=t;if(2===n){const t=Math.hypot(Math.max(s.x,o.x)-r.x,Math.max(s.y,o.x)-r.y)>=canvas.dimensions.size/8,i=r.isPolygon&&r.document.shape.points.length>4;if(t||i){e.interactionData.clearPreviewContainer=!1,e.interactionData.drawingsState=0;const t=r.document.toObject(!1);r._chain=!1;const i=getDocumentClass("Drawing"),n=this.constructor.placeableClass.normalizeShape(t);i.create(n,{parent:canvas.scene}).then((e=>{const t=e.object;t._creating=!0,"freehand"!==c.activeTool&&t.control({isNew:!0})})).finally((()=>this.clearPreviewContainer()))}}if(1===n&&r.isPolygon){if(e.preventDefault(),r._chain)return;return this._onClickLeft(e)}}_onDragLeftCancel(e){const t=this.preview.children?.[0]||null;if(t?._chain&&(t._removePoint(),t.refresh(),t.document.shape.points.length))return e.preventDefault();e.interactionData.drawingsState=0,super._onDragLeftCancel(e)}_onClickRight(e){if(this.preview.children?.[0]||null)return canvas.mouseInteractionManager._dragRight=!1;super._onClickRight(e)}get gridPrecision(){return super.gridPrecision,canvas.grid.type===CONST.GRID_TYPES.GRIDLESS?0:canvas.dimensions.size>=128?16:8}}class LightingLayer extends PlaceablesLayer{static documentName="AmbientLight";static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"lighting",rotatableObjects:!0,zIndex:900})}#$n;get hookName(){return LightingLayer.name}async _draw(e){await super._draw(e),this.#$n=this._onDarknessChange.bind(this),canvas.environment.addEventListener("darknessChange",this.#$n)}async _tearDown(e){return canvas.environment.removeEventListener("darknessChange",this.#$n),this.#$n=void 0,super._tearDown(e)}refreshFields(){if(this.active)for(const e of this.placeables)e.renderFlags.set({refreshField:!0})}_activate(){super._activate();for(const e of this.placeables)e.renderFlags.set({refreshField:!0})}_canDragLeftStart(e,t){return this.preview.children.length?(ui.notifications.warn("CONTROLS.ObjectConfigured",{localize:!0}),!1):super._canDragLeftStart(e,t)}_onDragLeftStart(e){super._onDragLeftStart(e);const t=e.interactionData;e.shiftKey||(t.origin=this.getSnappedPoint(t.origin));const i=new(getDocumentClass("AmbientLight"))(t.origin,{parent:canvas.scene}),n=new this.constructor.placeableClass(i);t.preview=this.preview.addChild(n),t.lightsState=1,n.draw()}_onDragLeftMove(e){const{destination:t,lightsState:i,preview:n,origin:s}=e.interactionData;if(0===i)return;const o=Math.hypot(t.x-s.x,t.y-s.y);n.document.config.dim=o*(canvas.dimensions.distance/canvas.dimensions.size),n.document.config.bright=n.document.config.dim/2,n.initializeLightSource(),n.renderFlags.set({refreshState:!0}),e.interactionData.lightsState=2}_onDragLeftCancel(e){super._onDragLeftCancel(e),canvas.effects.refreshLighting(),e.interactionData.lightsState=0}_onMouseWheel(e){const t=this.hover;if(!t||t.isPreview||360===t.document.config.angle)return;const i=e.shiftKey?15:3,n=i*Math.sign(e.delta);return t.rotate(t.document.rotation+n,i)}_onDarknessChange(e){const{darknessLevel:t,priorDarknessLevel:i}=e.environmentData;for(const e of this.placeables){const{min:n,max:s}=e.document.config.darkness;t.between(n,s)!==i.between(n,s)&&(e.initializeLightSource(),this.active&&e.renderFlags.set({refreshState:!0}))}}}class NotesLayer extends PlaceablesLayer{static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"notes",zIndex:800})}static documentName="Note";static TOGGLE_SETTING="notesDisplayToggle";get hookName(){return NotesLayer.name}interactiveChildren=c.settings.get("core",this.constructor.TOGGLE_SETTING);_deactivate(){super._deactivate();const e=c.settings.get("core",this.constructor.TOGGLE_SETTING);this.objects.visible=this.interactiveChildren=e}async _draw(e){await super._draw(e);const t=c.settings.get("core",this.constructor.TOGGLE_SETTING);this.objects.visible||=t}static registerSettings(){c.settings.register("core",this.TOGGLE_SETTING,{name:"Map Note Toggle",scope:"client",config:!1,type:new foundry.data.fields.BooleanField({initial:!1}),onChange:e=>{if(!canvas.ready)return;const t=canvas.notes;t.objects.visible=t.interactiveChildren=t.active||e}})}hintMapNotes(){const e=this.placeables.some((e=>e.visible)),t=document.querySelector(".scene-control[data-control='notes'] i");t.classList.toggle("fa-solid",!e),t.classList.toggle("fa-duotone",e),t.classList.toggle("has-notes",e)}panToNote(e,{scale:t=1.5,duration:i=250}={}){return e?(e.visible&&!this.active&&this.activate(),canvas.animatePan({x:e.x,y:e.y,scale:t,duration:i}).then((()=>{this.hover&&this.hover._onHoverOut(new Event("pointerout")),e._onHoverIn(new Event("pointerover"),{hoverOutOthers:!0})}))):Promise.resolve()}async _onClickLeft(e){if("journal"!==c.activeTool)return super._onClickLeft(e);const t=e.getLocalPosition(canvas.stage),{x:i,y:n}=canvas.grid.getCenterPoint(t),s=c.journal.folders.filter((e=>e.displayed)),o=c.i18n.localize("NOTE.Create"),r=await renderTemplate("templates/sidebar/document-create.html",{folders:s,name:c.i18n.localize("NOTE.Unknown"),hasFolders:s.length>=1,hasTypes:!1,content:`\n        <div class="form-group">\n            <label style="display: flex;">\n                <input type="checkbox" name="journal">\n                ${c.i18n.localize("NOTE.CreateJournal")}\n            </label>\n        </div>\n      `});let a;try{a=await Dialog.prompt({title:o,content:r,label:c.i18n.localize("NOTE.Create"),callback:e=>{const t=e.querySelector("form"),i=new FormDataExtended(t).object;return i.folder||delete i.folder,i.journal?JournalEntry.implementation.create(i,{renderSheet:!0}):i.name},render:e=>{const t=e.querySelector("form"),i=t.elements.folder;i&&(i.disabled=!0,t.elements.journal.addEventListener("change",(e=>{i.disabled=!e.currentTarget.checked})))},options:{jQuery:!1}})}catch(e){return}const l={x:i,y:n};if(a.id){l.entryId=a.id;return getDocumentClass("Note").create(l,{parent:canvas.scene})}return l.text=a,this._createPreview(l,{top:e.clientY-20,left:e.clientX+40})}async _onDropData(e,t){let i,n;if(void 0===t.x||void 0===t.y){const t=this._canvasCoordinatesFromDrop(e,{center:!1});if(!t)return!1;n={x:t[0],y:t[1]}}else n={x:t.x,y:t.y};if(e.shiftKey||(n=this.getSnappedPoint(n)),!canvas.dimensions.rect.contains(n.x,n.y))return!1;const s={x:n.x,y:n.y};if("JournalEntry"===t.type&&(i=await JournalEntry.implementation.fromDropData(t)),"JournalEntryPage"===t.type){const e=await JournalEntryPage.implementation.fromDropData(t);i=e.parent,s.pageId=e.id}if(i?.compendium){const e=c.journal.fromCompendium(i);i=await JournalEntry.implementation.create(e)}return s.entryId=i?.id,this._createPreview(s,{top:e.clientY-20,left:e.clientX+40})}}class RegionLayer extends PlaceablesLayer{static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"regions",controllableObjects:!0,confirmDeleteKey:!0,quadtree:!1,zIndex:100,zIndexActive:600})}static documentName="Region";static#Hn=function(){for(let e=0;e<this.children.length;e++)this.children[e]._lastSortedIndex=e;this.children.sort(((e,t)=>e.zIndex-t.zIndex||e.top-t.top||e.bottom-t.bottom||e._lastSortedIndex-t._lastSortedIndex)),this.sortDirty=!1};get hookName(){return RegionLayer.name}get legend(){return this.#zn??=new foundry.applications.ui.RegionLegend}#zn;#Vn;#Wn;_holeMode=!1;_activate(){super._activate(),this.legend.render({force:!0})}_deactivate(){super._deactivate(),this.objects.visible=!0,this.legend.close({animate:!1})}storeHistory(e,t){super.storeHistory(e,"update"===e?t.map((e=>("behaviors"in e&&delete(e=foundry.utils.deepClone(e)).behaviors,e))):t)}copyObjects(){return[]}getSnappedPoint(e){const t=CONST.GRID_SNAPPING_MODES,i=canvas.dimensions.size;return canvas.grid.getSnappedPoint(e,canvas.forceSnapVertices?{mode:t.VERTEX}:{mode:t.CENTER|t.VERTEX|t.CORNER|t.SIDE_MIDPOINT,resolution:i>=128?8:i>=64?4:2})}getZIndex(){return this.active?this.options.zIndexActive:this.options.zIndex}async _draw(e){await super._draw(e),this.objects.sortChildren=RegionLayer.#Hn,this.objects.visible=!0,this.#Vn=this.addChild(new PIXI.Graphics),this.#Vn.eventMode="none",this.#Vn.visible=!1,this.#Wn=this.addChild(new PIXI.Graphics),this.#Wn.eventMode="none",this.#Wn.visible=!1,this.filters=[VisionMaskFilter.create()],this.filterArea=canvas.app.screen}_highlightShape(e){if(this.#Vn.clear(),this.#Vn.visible=!1,!e)return;this.#Vn.visible=!0,this.#Vn.lineStyle({width:g.Canvas.objectBorderThickness,color:0,join:PIXI.LINE_JOIN.ROUND,shader:new PIXI.smooth.DashLineShader});foundry.canvas.regions.RegionShape.create(e)._drawShape(this.#Vn)}#Xn(e){this.#Wn.clear(),this.#Wn.lineStyle({width:g.Canvas.objectBorderThickness,color:0,join:PIXI.LINE_JOIN.ROUND,cap:PIXI.LINE_CAP.ROUND,alignment:.75}),this.#Wn.beginFill(e.interactionData.drawingColor,.5),this.#Yn(e),this.#Wn.endFill(),this.#Wn.lineStyle({width:g.Canvas.objectBorderThickness/2,color:g.Canvas.dispositionColors.CONTROLLED,join:PIXI.LINE_JOIN.ROUND,cap:PIXI.LINE_CAP.ROUND,alignment:1}),this.#Yn(e)}#Yn(e){const t=this.#Kn(e);if(t)switch(t.type){case"rectangle":this.#Wn.drawRect(t.x,t.y,t.width,t.height);break;case"circle":this.#Wn.drawCircle(t.x,t.y,t.radius);break;case"ellipse":this.#Wn.drawEllipse(t.x,t.y,t.radiusX,t.radiusY);break;case"polygon":const e=new PIXI.Polygon(t.points);e.isPositive||e.reverseOrientation(),this.#Wn.drawPath(e.points)}}#Kn(e){let t;switch(e.interactionData.drawingTool){case"rectangle":t=this.#qn(e);break;case"ellipse":t=this.#Jn(e);break;case"polygon":t=this.#Qn(e)}if(t)return t.elevation={bottom:Number.isFinite(this.legend.elevation.bottom)?this.legend.elevation.bottom:null,top:Number.isFinite(this.legend.elevation.top)?this.legend.elevation.top:null},this._holeMode&&(t.hole=!0),t}#qn(e){const{origin:t,destination:i}=e.interactionData;let n=Math.abs(i.x-t.x),s=Math.abs(i.y-t.y);e.altKey&&(n=s=Math.min(n,s));let o=t.x,r=t.y;if(e.ctrlKey||e.metaKey?(o-=n,r-=s,n*=2,s*=2):(t.x>i.x&&(o-=n),t.y>i.y&&(r-=s)),0!==n&&0!==s)return{type:"rectangle",x:o,y:r,width:n,height:s,rotation:0}}#Jn(e){const{origin:t,destination:i}=e.interactionData;let n=Math.abs(i.x-t.x),s=Math.abs(i.y-t.y);e.altKey&&(n=s=Math.min(n,s));let o=t.x,r=t.y;if(e.ctrlKey||e.metaKey||(t.x>i.x&&(o-=n),t.y>i.y&&(r-=s),n/=2,s/=2,o+=n,r+=s),0!==n&&0!==s)return e.altKey?{type:"circle",x:o,y:r,radius:n}:{type:"ellipse",x:o,y:r,radiusX:n,radiusY:s,rotation:0}}#Qn(e){let{destination:t,points:i,complete:n}=e.interactionData;if(n){if(i.length<6)return}else i=[...i,t.x,t.y];return{type:"polygon",points:i}}_onClickLeft(e){const t=e.interactionData;if("polygon"!==t.drawingTool)["rectangle","ellipse","polygon"].includes(c.activeTool)||super._onClickLeft(e);else{const{destination:i,points:n}=t,s=e.shiftKey?i:this.getSnappedPoint(i);s.x===n.at(0)&&s.y===n.at(1)?t.complete=!0:s.x===n.at(-2)&&s.y===n.at(-1)||(t.points.push(s.x,s.y),this.#Xn(e))}}_onClickLeft2(e){const t=e.interactionData;"polygon"!==t.drawingTool?super._onClickLeft2(e):t.complete=!0}_canDragLeftStart(e,t){return!!super._canDragLeftStart(e,t)&&(!!["rectangle","ellipse","polygon"].includes(c.activeTool)&&(this.controlled.length>1?(ui.notifications.error("REGION.NOTIFICATIONS.DrawingMultipleRegionsControlled",{localize:!0}),!1):!this.controlled.at(0)?.document.locked||(ui.notifications.warn(c.i18n.format("CONTROLS.ObjectIsLocked",{type:c.i18n.localize(RegionDocument.metadata.label)})),!1)))}_onDragLeftStart(e){const t=e.interactionData;if(e.shiftKey||(t.origin=this.getSnappedPoint(t.origin)),t.drawingTool=c.activeTool,t.drawingRegion=this.controlled.at(0),t.drawingColor=t.drawingRegion?.document.color??Color.from(RegionDocument.schema.fields.color.getInitialValue({})),"polygon"===t.drawingTool){const e=t.origin;t.points=[e.x,e.y]}this.#Xn(e),this.#Wn.visible=!0}_onDragLeftMove(e){const t=e.interactionData;t.drawingTool&&(e.shiftKey||(t.destination=this.getSnappedPoint(t.destination)),this.#Xn(e))}_onDragLeftDrop(e){const t=e.interactionData;if(!t.drawingTool)return;if(e.shiftKey||(t.destination=this.getSnappedPoint(t.destination)),"polygon"===t.drawingTool&&!0!==t.complete)return void e.preventDefault();this.#Wn.clear(),this.#Wn.visible=!1;const i=this.#Kn(e);if(!i)return;const n=t.drawingRegion;n?n.document.locked||n.document.update({shapes:[...n.document.shapes,i]}):RegionDocument.implementation.create({name:RegionDocument.implementation.defaultName({parent:canvas.scene}),color:t.drawingColor,shapes:[i]},{parent:canvas.scene,renderSheet:!0}).then((e=>e.object.control({releaseOthers:!0})))}_onDragLeftCancel(e){const t=e.interactionData;if(t.drawingTool){if("polygon"===t.drawingTool&&!0!==t.complete&&(t.points.splice(-2,2),t.points.length))return e.preventDefault(),void this.#Xn(e);this.#Wn.clear(),this.#Wn.visible=!1}}_onClickRight(e){if(e.interactionData.drawingTool)return canvas.mouseInteractionManager._dragRight=!1;super._onClickRight(e)}}class SoundsLayer extends PlaceablesLayer{livePreview=!1;sources=new foundry.utils.Collection;#$n;static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"sounds",zIndex:900})}static documentName="AmbientSound";get hookName(){return SoundsLayer.name}async _draw(e){await super._draw(e),this.#$n=this._onDarknessChange.bind(this),canvas.environment.addEventListener("darknessChange",this.#$n)}async _tearDown(e){return this.stopAll(),canvas.environment.removeEventListener("darknessChange",this.#$n),this.#$n=void 0,super._tearDown(e)}_activate(){super._activate();for(const e of this.placeables)e.renderFlags.set({refreshField:!0})}initializeSources(){for(let e of this.placeables)e.initializeSoundSource();for(let e of this.preview.children)e.initializeSoundSource()}refresh(e={}){if(!this.placeables.length)return;for(const e of this.placeables)e.source.refresh();if(c.audio.locked)return c.audio.pending.push((()=>this.refresh(e)));const t=this.getListenerPositions();this._syncPositions(t,e)}previewSound(e){if(this.placeables.length&&!c.audio.locked)return this._syncPositions([e],{fade:50})}stopAll(){this.placeables.forEach((e=>e.sync(!1)))}getListenerPositions(){const e=canvas.tokens.controlled.map((e=>e.center));if(!e.length&&!c.user.isGM)for(const t of canvas.tokens.placeables)t.actor?.isOwner&&t.isVisible&&e.push(t.center);return e}_syncPositions(e,t){if(!this.placeables.length||c.audio.locked)return;const i={};for(const t of this.placeables){const{path:n,easing:s,volume:o,walls:r}=t.document;if(!n)continue;const{sound:a,source:l}=t;i[n]||={sound:a,source:l,object:t,volume:0};const c=i[n];if(!c.sound&&a&&Object.assign(c,{sound:a,source:l,object:t}),t.isAudible&&l.active)for(let i of e){const e=o*l.getVolumeMultiplier(i,{easing:s});e>c.volume&&(Object.assign(c,{source:l,object:t,listener:i,volume:e,walls:r}),c.sound??=a)}}for(const e of Object.values(i))this._configurePlayback(e),e.object.sync(e.volume>0,e.volume,{...t,muffled:e.muffled})}_configurePlayback(e){const{source:t,walls:i}=e;if(e.listener)if(i)e.muffled=!1;else{if(e.listener.equals(t))return!1;const i=g.Canvas.polygonBackends.sound.testCollision(e.listener,t,{mode:"first",type:"sound"});e.muffled=i&&i._distance<1}else e.volume=0}_onDarknessChange(e){const{darknessLevel:t,priorDarknessLevel:i}=e.environmentData;for(const e of this.placeables){const{min:n,max:s}=e.document.darkness;t.between(n,s)!==i.between(n,s)&&(e.initializeSoundSource(),this.active&&e.renderFlags.set({refreshState:!0}))}}async playAtPosition(e,t,i,{volume:n=1,easing:s=!0,walls:o=!0,gmAlways:r=!0,baseEffect:a,muffledEffect:l,sourceData:d,playbackOptions:u}={}){const h=new foundry.audio.Sound(e,{context:c.audio.environment}),p=new g.Canvas.soundSourceClass({object:null});p.initialize({x:t.x,y:t.y,radius:canvas.dimensions.distancePixels*i,walls:o,...d});const m={sound:h,source:p,listener:void 0,volume:0,walls:o},v=r&&c.user.isGM?[t]:this.getListenerPositions();for(const e of v){const t=n*p.getVolumeMultiplier(e,{easing:s});t>m.volume&&Object.assign(m,{listener:e,volume:t})}if(this._configurePlayback(m),!m.volume)return null;await h.load();const y=g.soundEffects;let b;if(m.muffled&&l?.type in y){b=new y[l.type].effectClass(h.context,l)}if(!b&&a?.type in y){b=new y[a.type].effectClass(h.context,a)}return b&&h.effects.push(b),await h.play({...u,loop:!1,volume:m.volume}),h}async emitAtPosition(...e){return c.socket.emit("playAudioPosition",e),this.playAtPosition(...e)}_onMouseMove(){this.livePreview&&(canvas.tokens.active&&canvas.tokens.controlled.length||this.previewSound(canvas.mousePosition))}_onDragLeftStart(e){super._onDragLeftStart(e);const t=e.interactionData;e.shiftKey||(t.origin=this.getSnappedPoint(t.origin));const i=new(getDocumentClass("AmbientSound"))({type:"l",...t.origin},{parent:canvas.scene}),n=new this.constructor.placeableClass(i);t.preview=this.preview.addChild(n),t.soundState=1,this.preview._creating=!1,n.draw()}_onDragLeftMove(e){const{destination:t,soundState:i,preview:n,origin:s}=e.interactionData;if(0===i)return;const o=Math.hypot(t.x-s.x,t.y-s.y);n.document.updateSource({radius:o/canvas.dimensions.distancePixels}),n.initializeSoundSource(),n.renderFlags.set({refreshState:!0}),e.interactionData.soundState=2}_onDragLeftDrop(e){const t=e.interactionData;e.shiftKey||(t.destination=this.getSnappedPoint(t.destination));const{soundState:i,destination:n,origin:s,preview:o}=t;if(2!==i)return;const r=Math.hypot(n.x-s.x,n.y-s.y);r<canvas.dimensions.size/2||(o.document.updateSource({radius:r/canvas.dimensions.distancePixels}),o.initializeSoundSource(),o.renderFlags.set({refreshState:!0}),o.sheet.render(!0),this.preview._creating=!0)}_onDragLeftCancel(e){if(!this.preview._creating)return super._onDragLeftCancel(e)}async _onDropData(e,t){const i=await PlaylistSound.implementation.fromDropData(t);if(!i)return!1;let n;if(void 0===t.x||void 0===t.y){const t=this._canvasCoordinatesFromDrop(e,{center:!1});if(!t)return!1;n={x:t[0],y:t[1]}}else n={x:t.x,y:t.y};if(e.shiftKey||(n=this.getSnappedPoint(n)),!canvas.dimensions.rect.contains(n.x,n.y))return!1;const s={path:i.path,volume:i.volume,x:n.x,y:n.y,radius:2*canvas.dimensions.distance};return this._createPreview(s,{top:e.clientY-20,left:e.clientX+40})}}class TemplateLayer extends PlaceablesLayer{static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"templates",rotatableObjects:!0,zIndex:400})}static documentName="MeasuredTemplate";get hookName(){return TemplateLayer.name}_deactivate(){super._deactivate(),this.objects.visible=!0}async _draw(e){await super._draw(e),this.objects.visible=!0}static registerSettings(){c.settings.register("core","gridTemplates",{name:"TEMPLATE.GridTemplatesSetting",hint:"TEMPLATE.GridTemplatesSettingHint",scope:"world",config:!0,type:new foundry.data.fields.BooleanField({initial:!1}),onChange:()=>{canvas.ready&&canvas.templates.draw()}}),c.settings.register("core","coneTemplateType",{name:"TEMPLATE.ConeTypeSetting",hint:"TEMPLATE.ConeTypeSettingHint",scope:"world",config:!0,type:new foundry.data.fields.StringField({required:!0,blank:!1,initial:"round",choices:{round:"TEMPLATE.ConeTypeRound",flat:"TEMPLATE.ConeTypeFlat"}}),onChange:()=>{canvas.ready&&canvas.templates.draw()}})}_onDragLeftStart(e){super._onDragLeftStart(e);const t=e.interactionData;e.shiftKey||(t.origin=this.getSnappedPoint(t.origin));const i=c.activeTool,n={user:c.user.id,t:i,x:t.origin.x,y:t.origin.y,sort:Math.max(this.getMaxSort()+1,0),distance:1,direction:0,fillColor:c.user.color||"#FF0000",hidden:e.altKey},s=g.MeasuredTemplate.defaults;"cone"===i?n.angle=s.angle:"ray"===i&&(n.width=s.width*canvas.dimensions.distance);const o=new(getDocumentClass("MeasuredTemplate"))(n,{parent:canvas.scene}),r=new this.constructor.placeableClass(o);t.preview=this.preview.addChild(r),r.draw()}_onDragLeftMove(e){const t=e.interactionData;e.shiftKey||(t.destination=this.getSnappedPoint(t.destination));const{origin:i,destination:n,preview:s}=t,o=new Ray(i,n);let r;if(c.settings.get("core","gridTemplates"))r=canvas.grid.measurePath([i,n]).distance;else{const e=canvas.dimensions.size/canvas.dimensions.distance;r=o.distance/e}s.document.direction=Math.normalizeDegrees(Math.toDegrees(o.angle)),s.document.distance=r,s.renderFlags.set({refreshShape:!0})}_onMouseWheel(e){const t=this.hover;if(!t||t.isPreview)return;const i=e.shiftKey?15:5,n=i*Math.sign(e.delta);return t.rotate(t.document.direction+n,i)}}class TilesLayer extends PlaceablesLayer{static documentName="Tile";static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"tiles",zIndex:300,controllableObjects:!0,rotatableObjects:!0})}get hookName(){return TilesLayer.name}get hud(){return canvas.hud.tile}get tiles(){return this.objects?.children||[]}*controllableObjects(){const e=ui.controls.control.foreground??!1;for(const t of super.controllableObjects()){t.document.elevation>=t.document.parent.foregroundElevation===e&&(yield t)}}getSnappedPoint(e){return canvas.forceSnapVertices?canvas.grid.getSnappedPoint(e,{mode:CONST.GRID_SNAPPING_MODES.VERTEX}):super.getSnappedPoint(e)}async _tearDown(e){for(const e of this.tiles)e.isVideo&&c.video.stop(e.sourceElement);return super._tearDown(e)}_onDragLeftStart(e){super._onDragLeftStart(e);const t=e.interactionData;e.shiftKey||(t.origin=this.getSnappedPoint(t.origin));const i=this.constructor.placeableClass.createPreview(t.origin);t.preview=this.preview.addChild(i),this.preview._creating=!1}_onDragLeftMove(e){const t=e.interactionData;e.shiftKey||(t.destination=this.getSnappedPoint(t.destination));const{destination:i,tilesState:n,preview:s,origin:o}=t;if(0===n)return;const r=i.x-o.x,a=i.y-o.y,l=Math.min(Math.abs(r),Math.abs(a));s.document.width=e.altKey?l*Math.sign(r):r,s.document.height=e.altKey?l*Math.sign(a):a,s.renderFlags.set({refreshSize:!0}),t.tilesState=2}_onDragLeftDrop(e){const t=e.interactionData;e.shiftKey||(t.destination=this.getSnappedPoint(t.destination));const{tilesState:i,preview:n}=t;if(2!==i)return;const s=n.document,o=new PIXI.Rectangle(s.x,s.y,s.width,s.height).normalize();n.document.updateSource(o),Math.hypot(o.width,o.height)<canvas.dimensions.size/2||(n.sheet.render(!0,{preview:!0}),this.preview._creating=!0)}_onDragLeftCancel(e){if(!this.preview._creating)return super._onDragLeftCancel(e)}async _onDropData(e,t){if(!t.texture?.src)return;this.active||this.activate();const i=await this._getDropData(e,t);if(!canvas.dimensions.rect.contains(i.x,i.y))return!1;return getDocumentClass(this.constructor.documentName).create(i,{parent:canvas.scene})}async _getDropData(e,t){const i=await loadTexture(t.texture.src),n=canvas.dimensions.size/(t.tileSize||canvas.dimensions.size);t.width=i.baseTexture.width*n,t.height=i.baseTexture.height*n;const s=ui.controls.controls.find((e=>"tiles"===e.layer)).foreground;if(t.elevation=s?canvas.scene.foregroundElevation:0,t.sort=Math.max(this.getMaxSort()+1,0),foundry.utils.setProperty(t,"occlusion.mode",s?CONST.OCCLUSION_MODES.FADE:CONST.OCCLUSION_MODES.NONE),t.x=t.x-t.width/2,t.y=t.y-t.height/2,!e.shiftKey){const{x:e,y:i}=this.getSnappedPoint(t);t.x=e,t.y=i}return e.altKey&&(t.hidden=!0),t}get roofs(){return foundry.utils.logCompatibilityWarning("TilesLayer#roofs has been deprecated without replacement.",{since:12,until:14}),this.placeables.filter((e=>e.isRoof))}get textureDataMap(){return foundry.utils.logCompatibilityWarning("TilesLayer#textureDataMap has moved to TextureLoader.textureBufferDataMap",{since:11,until:13}),TextureLoader.textureBufferDataMap}get depthMask(){return foundry.utils.logCompatibilityWarning("TilesLayer#depthMask is deprecated without replacement. Use canvas.masks.depth instead",{since:12,until:14}),canvas.masks.depth}}class TokenLayer extends PlaceablesLayer{_tabIndex=null;static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"tokens",controllableObjects:!0,rotatableObjects:!0,zIndex:200})}static documentName="Token";set occlusionMode(e){this.#Zn=e,canvas.perception.update({refreshOcclusion:!0})}get occlusionMode(){return this.#Zn}#Zn;get hookName(){return TokenLayer.name}get hud(){return canvas.hud.token}get ownedTokens(){return this.placeables.filter((e=>e.actor&&e.actor.isOwner))}getSnappedPoint(e){const t=CONST.GRID_SNAPPING_MODES;return canvas.grid.getSnappedPoint(e,{mode:t.TOP_LEFT_CORNER,resolution:1})}async _draw(e){await super._draw(e),this.objects.visible=!0;const t=CONST.TOKEN_OCCLUSION_MODES;this.#Zn=c.user.isGM?t.CONTROLLED|t.HOVERED|t.HIGHLIGHTED:t.OWNED,canvas.app.ticker.add(this._animateTargets,this)}async _tearDown(e){return this.concludeAnimation(),super._tearDown(e)}_activate(){super._activate(),canvas.controls&&(canvas.controls.doors.visible=!0),this._tabIndex=null}_deactivate(){super._deactivate(),this.objects.visible=!0,canvas.controls&&(canvas.controls.doors.visible=!1)}_pasteObject(e,t,{hidden:i=!1,snap:n=!0}={}){const{x:s,y:o}=e.document;let r={x:s+t.x,y:o+t.y};n&&(r=e.getSnappedPosition(r));const a=canvas.dimensions;r.x=Math.clamp(r.x,0,a.width-1),r.y=Math.clamp(r.y,0,a.height-1);const l=e.document.toObject();return delete l._id,l.x=r.x,l.y=r.y,l.hidden||=i,l}_getMovableObjects(e,t){const i=canvas.controls.ruler;if(i.state===Ruler.STATES.MEASURING)return[];const n=super._getMovableObjects(e,t);return i.token&&n.findSplice((e=>e===i.token)),n}targetObjects({x:e,y:t,width:i,height:n},{releaseOthers:s=!0}={}){const o=c.user,r=new Set,a=new PIXI.Rectangle(e,t,i,n);for(const e of this.placeables)e.visible&&!e.document.isSecret&&e._overlapsSelection(a)&&r.add(e);if(s)for(const e of o.targets)r.has(e)||e.setTarget(!1,{releaseOthers:!1,groupSelection:!0});for(const e of r)o.targets.has(e)||e.setTarget(!0,{releaseOthers:!1,groupSelection:!0});return o.broadcastActivity({targets:o.targets.ids}),o.targets.size}cycleTokens(e,t){let i=null;t&&(this._tabIndex=null);const n=this._getCycleOrder();if(null===this._tabIndex){this._tabIndex=0;let e=this.controlled.length?n.find((e=>this.controlled.includes(e))):null;if(!e&&c.user.character){const t=c.user.character.getActiveTokens();e=t.length?n.find((e=>t.includes(e))):null}if(e=e||n[this._tabIndex]||null,!e)return null;i=e}else if(this._tabIndex=e?this._tabIndex<n.length-1?this._tabIndex+1:0:this._tabIndex>0?this._tabIndex-1:n.length-1,i=n[this._tabIndex],!i)return null;return canvas.animatePan({x:i.center.x,y:i.center.y,duration:250}),i.control(),i}_getCycleOrder(){const e=this.placeables.filter((e=>!!c.user.isGM||!!e.actor?.testUserPermission(c.user,"OBSERVER")&&!e.document.hidden));return e.sort(((e,t)=>Math.hypot(e.x,e.y)-Math.hypot(t.x,t.y))),e}concludeAnimation(){this.placeables.forEach((e=>e.stopAnimation())),canvas.app.ticker.remove(this._animateTargets,this)}_animateTargets(){if(!c.user.targets.size)return;void 0===this._t?this._t=0:this._t+=canvas.app.ticker.elapsedMS;const e=2e3,t=1200,i=this._t%e;let n=Math.max(0,i-t)/800;n=CanvasAnimation.easeOutCircle(n);const s=i<t?.5:.5+.5*n,o=1-Math.max(0,i-e+200)/200;for(const e of c.user.targets)e._refreshTarget({margin:s,alpha:o,color:g.Canvas.targeting.color,size:g.Canvas.targeting.size})}_getOccludableTokens(){const e=CONST.TOKEN_OCCLUSION_MODES,t=this.occlusionMode;if(t&e.VISIBLE||t&e.HIGHLIGHTED&&this.highlightObjects)return this.placeables.filter((e=>e.visible));const i=new Set;return t&e.HOVERED&&this.hover&&i.add(this.hover),t&e.CONTROLLED&&this.controlled.forEach((e=>i.add(e))),t&e.OWNED&&this.ownedTokens.filter((e=>!e.document.hidden)).forEach((e=>i.add(e))),Array.from(i)}storeHistory(e,t){super.storeHistory(e,"update"===e?t.map((e=>(delete(e=foundry.utils.deepClone(e)).actorData,delete e.delta,delete e._regions,e))):t)}async _onDropActorData(e,t){if(!c.user.can("TOKEN_CREATE"))return ui.notifications.warn("You do not have permission to create new Tokens!");let i=await Actor.implementation.fromDropData(t);if(!i.isOwner)return ui.notifications.warn(`You do not have permission to create a new Token for the ${i.name} Actor.`);if(i.compendium){const e=c.actors.fromCompendium(i);i=await Actor.implementation.create(e,{fromCompendium:!0})}const n=await i.getTokenDocument({hidden:c.user.isGM&&e.altKey,sort:Math.max(this.getMaxSort()+1,0)},{parent:canvas.scene}),s=this.createObject(n);let o=s.getCenterPoint({x:0,y:0});return o.x=t.x-o.x,o.y=t.y-o.y,e.shiftKey||(o=s.getSnappedPosition(o)),s.destroy({children:!0}),n.updateSource(o),!!canvas.dimensions.rect.contains(n.x,n.y)&&(this.activate(),n.constructor.create(n,{parent:canvas.scene}))}_onClickLeft(e){let t=c.activeTool;switch(c.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL)&&(t="ruler"),t){case"target":c.settings.get("core","leftClickRelease")&&(c.user.updateTokenTargets([]),c.user.broadcastActivity({targets:[]}));break;case"ruler":return canvas.controls.ruler._onClickLeft(e)}super._onClickLeft(e)}_onMouseWheel(e){if(this.preview.children.length)return;const t=canvas.grid.isHexagonal?e.shiftKey?60:30:e.shiftKey?45:15,i=t*Math.sign(e.delta);return this.rotateMany({delta:i,snap:t})}get gridPrecision(){return super.gridPrecision,1}async toggleCombat(e=!0,t=null,{token:i=null}={}){foundry.utils.logCompatibilityWarning("TokenLayer#toggleCombat is deprecated in favor of TokenDocument.implementation.createCombatants and TokenDocument.implementation.deleteCombatants",{since:12,until:14});const n=this.controlled.map((e=>e.document));return i&&!i.controlled&&i.inCombat!==e&&n.push(i.document),e?TokenDocument.implementation.createCombatants(n,{combat:t}):TokenDocument.implementation.deleteCombatants(n,{combat:t})}}class WallsLayer extends PlaceablesLayer{chain=null;_chain=!1;_cloneType=null;last={point:null};static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"walls",controllableObjects:!0,zIndex:700})}static documentName="Wall";get hookName(){return WallsLayer.name}#es=canvas.grid;get doors(){return this.objects.children.filter((e=>e.document.door>CONST.WALL_DOOR_TYPES.NONE))}getSnappedPoint(e){const t=CONST.GRID_SNAPPING_MODES,i=canvas.dimensions.size;return this.#es.getSnappedPoint(e,canvas.forceSnapVertices?{mode:t.VERTEX}:{mode:t.CENTER|t.VERTEX|t.CORNER|t.SIDE_MIDPOINT,resolution:i>=128?8:i>=64?4:2})}async _draw(e){this.#es=canvas.grid.isGridless?new foundry.grid.SquareGrid({size:canvas.grid.size}):canvas.grid,await super._draw(e),this.chain=this.addChildAt(new PIXI.Graphics,0),this.last={point:null}}_deactivate(){super._deactivate(),this.chain?.clear()}static getClosestEndpoint(e,t){const i=t.coords,n=[i[0],i[1]],s=[i[2],i[3]];if(n.equals([e.x,e.y]))return n;if(s.equals([e.x,e.y]))return s;return Math.hypot(e.x-n[0],e.y-n[1])<Math.hypot(e.x-s[0],e.y-s[1])?n:s}releaseAll(e){return this.chain&&this.chain.clear(),super.releaseAll(e)}_pasteObject(e,t,i){const n=e.document.c,s=Math.round(t.x),o=Math.round(t.y),r={x:n[0]+s,y:n[1]+o},a={x:n[2]+s,y:n[3]+o},l=e.document.toObject();return delete l._id,l.c=[r.x,r.y,a.x,a.y],l}_panCanvasEdge(e,t,i){const n=Date.now();if(n-(e.interactionData.panTime||0)<=100)return;e.interactionData.panTime=n;const s=500/canvas.stage.scale.x;let o=0;t<50?o=-s:t>window.innerWidth-50&&(o=s);let r=0;return i<50?r=-s:i>window.innerHeight-50&&(r=s),!o&&!r||this._panning?void 0:canvas.animatePan({x:canvas.stage.pivot.x+o,y:canvas.stage.pivot.y+r,duration:100})}_getWallEndpointCoordinates(e,{snap:t=!0}={}){return t&&(e=this.getSnappedPoint(e)),[e.x,e.y].map(Math.round)}_getWallDataFromActiveTool(e){if("clone"===e&&this._cloneType)return this._cloneType;const t={light:CONST.WALL_SENSE_TYPES.NORMAL,sight:CONST.WALL_SENSE_TYPES.NORMAL,sound:CONST.WALL_SENSE_TYPES.NORMAL,move:CONST.WALL_SENSE_TYPES.NORMAL};switch(e){case"invisible":t.sight=t.light=t.sound=CONST.WALL_SENSE_TYPES.NONE;break;case"terrain":t.sight=t.light=t.sound=CONST.WALL_SENSE_TYPES.LIMITED;break;case"ethereal":t.move=t.sound=CONST.WALL_SENSE_TYPES.NONE;break;case"doors":t.door=CONST.WALL_DOOR_TYPES.DOOR;break;case"secret":t.door=CONST.WALL_DOOR_TYPES.SECRET;break;case"window":const e=canvas.dimensions.distance;t.sight=t.light=CONST.WALL_SENSE_TYPES.PROXIMITY,t.threshold={light:2*e,sight:2*e,attenuation:!0}}return t}
/**
   * Identify the interior enclosed by the given walls.
   * @param {Wall[]} walls        The walls that enclose the interior.
   * @returns {PIXI.Polygon[]}    The polygons of the interior.
   * @license MIT
   */identifyInteriorArea(e){const t=new Map,addEdge=(e,i)=>{let n=t.get(e.key);n||t.set(e.key,n={X:e.x,Y:e.y,key:e.key,neighbors:new Set,visited:!1});let s=t.get(i.key);s||t.set(i.key,s={X:i.x,Y:i.y,key:i.key,neighbors:new Set,visited:!1}),n!==s&&(n.neighbors.add(s),s.neighbors.add(n))};for(const t of e){const e=t.edge,i=new foundry.canvas.edges.PolygonVertex(e.a.x,e.a.y),n=new foundry.canvas.edges.PolygonVertex(e.b.x,e.b.y);if(i.key!==n.key)if(0===e.intersections.length)addEdge(i,n);else{const t=e.intersections.map((e=>foundry.canvas.edges.PolygonVertex.fromPoint(e.intersection)));t.push(i,n),t.sort(((e,t)=>e.x-t.x||e.y-t.y));for(let e=1;e<t.length;e++){const i=t[e-1],n=t[e];i.key!==n.key&&addEdge(i,n)}}}const i=[];for(;0!==t.size;){let e;for(const i of t.values())i.visited=!1,(!e||e.X>i.X||e.X===i.X&&e.Y>i.Y)&&(e=i);if(e.neighbors.size>=2){const n=[];let s=e,o={X:s.X-1,Y:s.Y-1};for(;;){s.visited=!0;const t=o.X,i=o.Y,r=s.X,a=s.Y;let l;for(const n of s.neighbors){if(n===o)continue;if(n!==e&&n.visited)continue;if(!l){l=n;continue}const s=l.X,c=l.Y,d=(i-a)*(s-r)+(r-t)*(c-a),u=n.X,h=n.Y,p=(i-a)*(u-r)+(r-t)*(h-a);if(d<0){if(p>=0)continue}else{if(!(d>0)){if(p<0){l=n;continue}const e=(s-r)*(t-r)+(c-a)*(i-a)>0;if(p>0){e&&(l=n);continue}e&&!((u-r)*(t-r)+(h-a)*(i-a)>0)&&(l=n);continue}if(p<0){l=n;continue}if(0===p){(u-r)*(t-r)+(h-a)*(i-a)>0||(l=n);continue}}const g=(a-c)*(u-r)+(s-r)*(h-a);if(g>0)continue;if(g<0){l=n;continue}(u-r)*(u-r)+(h-a)*(h-a)<(s-r)*(s-r)+(c-a)*(c-a)&&(l=n)}if(l){if(n.push(s),o=s,s=l,s===e)break}else{if(s=n.pop(),!s){o=void 0;break}o=n.length?n[n.length-1]:{X:s.X-1,Y:s.Y-1}}}if(0!==n.length){i.push(n),o=n[n.length-1];for(const e of n)o.neighbors.delete(e),0===o.neighbors.size&&t.delete(o.key),e.neighbors.delete(o),o=e;0===o.neighbors.size&&t.delete(o.key)}}for(const i of e.neighbors)i.neighbors.delete(e),0===i.neighbors.size&&t.delete(i.key);t.delete(e.key)}const n=new ClipperLib.Clipper;return n.AddPaths(i,ClipperLib.PolyType.ptSubject,!0),n.Execute(ClipperLib.ClipType.ctUnion,i,ClipperLib.PolyFillType.pftPositive,ClipperLib.PolyFillType.pftEvenOdd),i.map((e=>{const t=[];for(const i of e)t.push(i.X,i.Y);return new PIXI.Polygon(t)}))}_onDragLeftStart(e){this.clearPreviewContainer();const t=e.interactionData,i=t.origin;t.wallsState=WallsLayer.CREATION_STATES.NONE,t.clearPreviewContainer=!0;const n=this._getWallDataFromActiveTool(c.activeTool),s=!e.shiftKey,o=(this._chain||c.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL))&&this.last.point?this.last.point:this._getWallEndpointCoordinates(i,{snap:s});n.c=o.concat(o);const r=new(getDocumentClass("Wall"))(n,{parent:canvas.scene}),a=new this.constructor.placeableClass(r);return t.wallsState=WallsLayer.CREATION_STATES.POTENTIAL,t.preview=a,a.draw()}_onDragLeftMove(e){const t=e.interactionData,{preview:i,destination:n}=t,s=WallsLayer.CREATION_STATES;if(!i||i._destroyed||[s.NONE,s.COMPLETED].includes(t.wallsState))return;null===i.parent&&this.preview.addChild(i);const o=!e.shiftKey;i.document.updateSource({c:i.document.c.slice(0,2).concat(this._getWallEndpointCoordinates(n,{snap:o}))}),i.refresh(),t.wallsState=WallsLayer.CREATION_STATES.CONFIRMED}_onDragLeftDrop(e){const t=e.interactionData,{wallsState:i,destination:n,preview:s}=t,o=WallsLayer.CREATION_STATES;if(s&&!s._destroyed&&t.wallsState!==o.NONE){if(c.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL)){if(e.preventDefault(),this._chain=!0,i<WallsLayer.CREATION_STATES.CONFIRMED)return}else this._chain=!1;if(i===WallsLayer.CREATION_STATES.CONFIRMED){t.wallsState=WallsLayer.CREATION_STATES.COMPLETED;const i=!e.shiftKey;let o=this._getWallEndpointCoordinates(n,{snap:i});const r=s.document.c.slice(0,2).concat(o);s.document.updateSource({c:r});const clearPreviewAndChain=()=>{this.clearPreviewContainer(),this._chain&&(t.origin={x:o[0],y:o[1]},this._onDragLeftStart(e))};if(r[0]===r[2]&&r[1]===r[3])return void clearPreviewAndChain();t.clearPreviewContainer=!1,this.last={point:o};getDocumentClass(this.constructor.documentName).create(s.document.toObject(),{parent:canvas.scene}).finally(clearPreviewAndChain)}}}_onDragLeftCancel(e){this._chain=!1,this.last={point:null},super._onDragLeftCancel(e)}_onClickRight(e){if(e.interactionData.wallsState>WallsLayer.CREATION_STATES.NONE)return this._onDragLeftCancel(e)}checkCollision(e,t={}){return foundry.utils.logCompatibilityWarning("WallsLayer#checkCollision is obsolete.Prefer calls to testCollision from CONFIG.Canvas.polygonBackends[type]",{since:11,until:13}),g.Canvas.losBackend.testCollision(e.A,e.B,t)}highlightControlledSegments(){foundry.utils.logCompatibilityWarning('The WallsLayer#highlightControlledSegments function is deprecated in favorof calling wall.renderFlags.set("refreshHighlight") on individual Wall objects',{since:11,until:13});for(const e of this.placeables)e.renderFlags.set({refreshHighlight:!0})}initialize(){return foundry.utils.logCompatibilityWarning("WallsLayer#initialize is deprecated in favor of Canvas#edges#initialize",{since:12,until:14}),canvas.edges.initialize()}identifyInteriorWalls(){foundry.utils.logCompatibilityWarning("WallsLayer#identifyInteriorWalls has been deprecated. It has no effect anymore and there's no replacement.",{since:12,until:14})}identifyWallIntersections(){foundry.utils.logCompatibilityWarning("WallsLayer#identifyWallIntersections is deprecated in favor of foundry.canvas.edges.Edge.identifyEdgeIntersections and has no effect.",{since:12,until:14})}}class BatchShaderGenerator extends PIXI.BatchShaderGenerator{constructor(e,t,i={}){super(e,t),this.#ts=i}#ts;generateShader(e){if(!this.programCache[e]){const t=Int32Array.from({length:e},((e,t)=>t));this.defaultGroupCache[e]=PIXI.UniformGroup.from({uSamplers:t},!0);let i=this.fragTemplate;i=i.replace(/%count%/gi,`${e}`),i=i.replace(/%forloop%/gi,this.generateSampleSrc(e)),this.programCache[e]=new PIXI.Program(this.vertexSrc,i)}let t=this.#ts;return t="function"==typeof t?t.call(this,e):foundry.utils.deepClone(t),new PIXI.Shader(this.programCache[e],{...t,tint:new Float32Array([1,1,1,1]),translationMatrix:new PIXI.Matrix,default:this.defaultGroupCache[e]})}}class BatchRenderer extends PIXI.BatchRenderer{static shaderGeneratorClass=BatchShaderGenerator;static defaultUniforms={};_packInterleavedGeometry;_preRenderBatch;get uniforms(){return this._shader?.uniforms}set reservedTextureUnits(e){if("number"!=typeof e)throw new Error("BatchRenderer#reservedTextureUnits must be a number!");if(e<0||e>4)throw new Error("BatchRenderer#reservedTextureUnits must be positive and can't exceed 4.");this.#is=e}get reservedTextureUnits(){return this.#is}#is=0;setShaderGenerator({vertex:e=this.constructor.defaultVertexSrc,fragment:t=this.constructor.defaultFragmentTemplate,uniforms:i=this.constructor.defaultUniforms}={}){this.shaderGenerator=new this.constructor.shaderGeneratorClass(e,t,i)}contextChange(){const e=this.renderer.gl;if(PIXI.settings.PREFER_ENV===PIXI.ENV.WEBGL_LEGACY)this.maxTextures=1;else{const t=Math.min(e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),65536),i=t-this.#is;if(i<1){throw new Error(`Impossible to allocate the required number of texture units in contextChange#BatchRenderer. Your GPU should handle at least 8 texture units. Currently, it is supporting: ${t} texture units.`)}this.maxTextures=Math.min(i,PIXI.settings.SPRITE_MAX_TEXTURES),this.maxTextures=PIXI.checkMaxIfStatementsInShader(this.maxTextures,e)}this._shader=this.shaderGenerator?.generateShader(this.maxTextures)??null;for(let e=0;e<this._packedGeometryPoolSize;e++)this._packedGeometries[e]=new this.geometryClass;this.initFlushBuffers()}onPrerender(){this.shaderGenerator||this.setShaderGenerator(),this._shader??=this.shaderGenerator.generateShader(this.maxTextures),super.onPrerender()}start(){this._preRenderBatch?.(this),super.start()}packInterleavedGeometry(e,t,i,n,s){this._packInterleavedGeometry?this._packInterleavedGeometry(e,t,i,n,s):super.packInterleavedGeometry(e,t,i,n,s)}static hasPlugin(e){return Object.keys(PIXI.Renderer.__plugins).some((t=>t===e))}}const BaseShaderMixin=e=>class BaseShaderMixin extends e{static CONSTANTS="\n    const float PI = 3.141592653589793;\n    const float TWOPI = 6.283185307179586;\n    const float INVPI = 0.3183098861837907;\n    const float INVTWOPI = 0.15915494309189535;\n    const float SQRT2 = 1.4142135623730951;\n    const float SQRT1_2 = 0.7071067811865476;\n    const float SQRT3 = 1.7320508075688772;\n    const float SQRT1_3 = 0.5773502691896257;\n    const vec3 BT709 = vec3(0.2126, 0.7152, 0.0722);\n    ";static PERCEIVED_BRIGHTNESS="\n    float perceivedBrightness(in vec3 color) { return sqrt(dot(BT709, color * color)); }\n    float perceivedBrightness(in vec4 color) { return perceivedBrightness(color.rgb); }\n    float reversePerceivedBrightness(in vec3 color) { return 1.0 - perceivedBrightness(color); }\n    float reversePerceivedBrightness(in vec4 color) { return 1.0 - perceivedBrightness(color.rgb); }\n    ";static COLOR_SPACES="\n    float luminance(in vec3 c) { return dot(BT709, c); }\n    vec3 linear2grey(in vec3 c) { return vec3(luminance(c)); }\n    \n    vec3 linear2srgb(in vec3 c) {\n      vec3 a = 12.92 * c;\n      vec3 b = 1.055 * pow(c, vec3(1.0 / 2.4)) - 0.055;\n      vec3 s = step(vec3(0.0031308), c);\n      return mix(a, b, s);\n    }\n\n    vec3 srgb2linear(in vec3 c) {\n      vec3 a = c / 12.92;\n      vec3 b = pow((c + 0.055) / 1.055, vec3(2.4));\n      vec3 s = step(vec3(0.04045), c);\n      return mix(a, b, s);\n    }\n    \n    vec3 srgb2linearFast(in vec3 c) { return c * c; }\n    vec3 linear2srgbFast(in vec3 c) { return sqrt(c); }\n    \n    vec3 colorClamp(in vec3 c) { return clamp(c, vec3(0.0), vec3(1.0)); }\n    vec4 colorClamp(in vec4 c) { return clamp(c, vec4(0.0), vec4(1.0)); }\n    \n    vec3 tintColorLinear(in vec3 color, in vec3 tint, in float intensity) {\n      float t = luminance(tint);\n      float c = luminance(color);\n      return mix(color, mix(\n                            mix(tint, vec3(1.0), (c - t) / (1.0 - t)),\n                            tint * (c / t),\n                            step(c, t)\n                           ), intensity);\n    }\n    \n    vec3 tintColor(in vec3 color, in vec3 tint, in float intensity) {\n      return linear2srgbFast(tintColorLinear(srgb2linearFast(color), srgb2linearFast(tint), intensity));\n    }\n    ";static FBM(e=4,t=1){return`float fbm(in vec2 uv) {\n        float total = 0.0, amp = ${t.toFixed(1)};\n        for (int i = 0; i < ${e}; i++) {\n          total += noise(uv) * amp;\n          uv += uv;\n          amp *= 0.5;\n        }\n        return total;\n      }`}static FBMHQ(e=3){return`float fbm(in vec2 uv, in float smoothness) {   \n        float s = exp2(-smoothness);\n        float f = 1.0;\n        float a = 1.0;\n        float t = 0.0;\n        for( int i = 0; i < ${e}; i++ ) {\n            t += a * noise(f * uv);\n            f *= 2.0;\n            a *= s;\n        }\n        return t;\n      }`}static PIE="\n    float pie(in vec2 coord, in float angle, in float smoothness, in float l) {   \n      coord.x = abs(coord.x);\n      vec2 va = vec2(sin(angle), cos(angle));\n      float lg = length(coord) - l;\n      float clg = length(coord - va * clamp(dot(coord, va) , 0.0, l));\n      return smoothstep(0.0, smoothness, max(lg, clg * sign(va.y * coord.x - va.x * coord.y)));\n    }";static PRNG_LEGACY="\n    float random(in vec2 uv) { \n      return fract(cos(dot(uv, vec2(12.9898, 4.1414))) * 43758.5453);\n    }";static PRNG="\n    float random(in vec2 uv) { \n      uv = mod(uv, 1000.0);\n      return fract( dot(uv, vec2(5.23, 2.89) \n                        * fract((2.41 * uv.x + 2.27 * uv.y)\n                                 * 251.19)) * 551.83);\n    }";static PRNG2D="\n    vec2 random(in vec2 uv) {\n      vec2 uvf = fract(uv * vec2(0.1031, 0.1030));\n      uvf += dot(uvf, uvf.yx + 19.19);\n      return fract((uvf.x + uvf.y) * uvf);\n    }";static PRNG3D="\n    vec3 random(in vec3 uv) {\n      return vec3(fract(cos(dot(uv, vec3(12.9898,  234.1418,    152.01))) * 43758.5453),\n                  fract(sin(dot(uv, vec3(80.9898,  545.8937, 151515.12))) * 23411.1789),\n                  fract(cos(dot(uv, vec3(01.9898, 1568.5439,    154.78))) * 31256.8817));\n    }";static NOISE="\n    float noise(in vec2 uv) {\n      const vec2 d = vec2(0.0, 1.0);\n      vec2 b = floor(uv);\n      vec2 f = smoothstep(vec2(0.), vec2(1.0), fract(uv));\n      return mix(\n        mix(random(b), random(b + d.yx), f.x), \n        mix(random(b + d.xy), random(b + d.yy), f.x), \n        f.y\n      );\n    }";static HSB2RGB="\n    vec3 hsb2rgb(in vec3 c) {\n      vec3 rgb = clamp(abs(mod(c.x*6.0+vec3(0.0,4.0,2.0), 6.0)-3.0)-1.0, 0.0, 1.0 );\n      rgb = rgb*rgb*(3.0-2.0*rgb);\n      return c.z * mix(vec3(1.0), rgb, c.y);\n    }";static WAVE(e="cos"){return`\n      float w${e}(in float v1, in float v2, in float a, in float speed) {\n        float w = ${e}( speed + a ) + 1.0;\n        return (v1 - v2) * (w * 0.5) + v2;\n      }`}static ROTATION="\n    mat2 rot(in float a) {\n      float s = sin(a);\n      float c = cos(a);\n      return mat2(c, -s, s, c);\n    }\n    ";static VORONOI="\n    vec3 voronoi(in vec2 uv, in float t, in float zd) {\n      vec3 vor = vec3(0.0, 0.0, zd);\n      vec2 uvi = floor(uv);\n      vec2 uvf = fract(uv);\n      for ( float j = -1.0; j <= 1.0; j++ ) {\n        for ( float i = -1.0; i <= 1.0; i++ ) {\n          vec2 uvn = vec2(i, j);\n          vec2 uvr = 0.5 * sin(TWOPI * random(uvi + uvn) + t) + 0.5;\n          uvr = 0.5 * sin(TWOPI * uvr + t) + 0.5;\n          vec2 uvd = uvn + uvr - uvf;\n          float dist = length(uvd);\n          if ( dist < vor.z ) {\n            vor.xy = uvr;\n            vor.z = dist;\n          }\n        }\n      }\n      return vor;\n    }\n    \n    vec3 voronoi(in vec2 vuv, in float zd)  { \n      return voronoi(vuv, 0.0, zd); \n    }\n\n    vec3 voronoi(in vec3 vuv, in float zd)  { \n      return voronoi(vuv.xy, vuv.z, zd);\n    }\n    ";static GLSL1_COMPATIBILITY_VERTEX="\n      #define attribute in\n      #define varying out\n    ";static GLSL1_COMPATIBILITY_FRAGMENT="\n      #define varying in\n      #define texture2D texture\n      #define textureCube texture\n      #define texture2DProj textureProj\n      #define texture2DLodEXT textureLod\n      #define texture2DProjLodEXT textureProjLod\n      #define textureCubeLodEXT textureLod\n      #define texture2DGradEXT textureGrad\n      #define texture2DProjGradEXT textureProjGrad\n      #define textureCubeGradEXT textureGrad\n      #define gl_FragDepthEXT gl_FragDepth\n    "};class AbstractBaseShader extends(BaseShaderMixin(PIXI.Shader)){constructor(e,t){super(e,foundry.utils.deepClone(t)),this.initialUniforms=t}static vertexShader="";static fragmentShader="";static defaultUniforms={};static create(e){const t=new this(PIXI.Program.from(this.vertexShader,this.fragmentShader),foundry.utils.mergeObject(this.defaultUniforms,e,{inplace:!1,insertKeys:!1}));return t._configure(),t}reset(){for(let[e,t]of Object.entries(this.initialUniforms))this.uniforms[e]=foundry.utils.deepClone(t)}_configure(){}_preRender(e,t){}get _defaults(){return foundry.utils.logCompatibilityWarning("AbstractBaseShader#_defaults is deprecated in favor of AbstractBaseShader#initialUniforms.",{since:12,until:14}),this.initialUniforms}}class AbstractBaseFilter extends(BaseShaderMixin(PIXI.Filter)){static defaultUniforms={};static fragmentShader=void 0;static vertexShader=void 0;static create(e={}){return new this(this.vertexShader,this.fragmentShader,{...this.defaultUniforms,...e})}}class BaseSamplerShader extends AbstractBaseShader{static classPluginName="batch";static pausable=!0;get pluginName(){return this.#ri}#ri=this.constructor.classPluginName;get enabled(){return this.#ns}set enabled(e){this.#ri=e?this.constructor.classPluginName:"batch",this.#ns=e}#ns=!0;get paused(){return!this.#ns}set paused(e){this.constructor.pausable&&(this.enabled=!e)}static CONTRAST="\n    // Computing contrasted color\n    if ( contrast != 0.0 ) {\n      changedColor = (changedColor - 0.5) * (contrast + 1.0) + 0.5;\n    }";static SATURATION="\n    // Computing saturated color\n    if ( saturation != 0.0 ) {\n      vec3 grey = vec3(perceivedBrightness(changedColor));\n      changedColor = mix(grey, changedColor, 1.0 + saturation);\n    }";static EXPOSURE="\n    if ( exposure != 0.0 ) {\n      changedColor *= (1.0 + exposure);\n    }";static get ADJUSTMENTS(){return`vec3 changedColor = baseColor.rgb;\n      ${this.CONTRAST}\n      ${this.SATURATION}\n      ${this.EXPOSURE}\n      baseColor.rgb = changedColor;`}static vertexShader=`\n    precision ${PIXI.settings.PRECISION_VERTEX} float;\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    uniform mat3 projectionMatrix;\n    varying vec2 vUvs;\n\n    void main() {\n      gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n      vUvs = aTextureCoord;\n    }\n  `;static fragmentShader=`\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n    uniform sampler2D sampler;\n    uniform vec4 tintAlpha;\n    varying vec2 vUvs;\n\n    void main() {\n      gl_FragColor = texture2D(sampler, vUvs) * tintAlpha;\n    }\n  `;static batchVertexShader=`\n    #version 300 es\n    precision ${PIXI.settings.PRECISION_VERTEX} float;\n    in vec2 aVertexPosition;\n    in vec2 aTextureCoord;\n    in vec4 aColor;\n    in float aTextureId;\n    uniform mat3 projectionMatrix;\n    uniform mat3 translationMatrix;\n    uniform vec4 tint;\n    out vec2 vTextureCoord;\n    flat out vec4 vColor;\n    flat out float vTextureId;\n\n    void main(void){\n      gl_Position = vec4((projectionMatrix * translationMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n      vTextureCoord = aTextureCoord;\n      vTextureId = aTextureId;\n      vColor = aColor * tint;\n    }\n  `;static batchFragmentShader=`\n    #version 300 es\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n    in vec2 vTextureCoord;\n    flat in vec4 vColor;\n    flat in float vTextureId;\n    uniform sampler2D uSamplers[%count%];\n    out vec4 fragColor;\n\n    #define texture2D texture\n\n    void main(void){\n      vec4 color;\n      %forloop%\n      fragColor = color * vColor;\n    }\n  `;static defaultUniforms={sampler:0,tintAlpha:[1,1,1,1]};static batchGeometry=PIXI.BatchGeometry;static batchVertexSize=6;static _packInterleavedGeometry;static _preRenderBatch;static batchDefaultUniforms={};static reservedTextureUnits=0;static initializeBatchGeometry(){}static batchRendererClass=BatchRenderer;static batchShaderGeneratorClass=BatchShaderGenerator;static createPlugin(){const e=this,t=Array.isArray(e.batchGeometry)?class BatchGeometry extends PIXI.Geometry{constructor(t=!1){super(),this._buffer=new PIXI.Buffer(null,t,!1),this._indexBuffer=new PIXI.Buffer(null,t,!0);for(const{id:t,size:i,normalized:n,type:s}of e.batchGeometry)this.addAttribute(t,this._buffer,i,n,s);this.addIndex(this._indexBuffer)}}:e.batchGeometry;return class BatchPlugin extends e.batchRendererClass{static get shaderGeneratorClass(){return e.batchShaderGeneratorClass}static get defaultVertexSrc(){return e.batchVertexShader}static get defaultFragmentTemplate(){return e.batchFragmentShader}static get defaultUniforms(){return e.batchDefaultUniforms}constructor(i){super(i),this.geometryClass=t,this.vertexSize=e.batchVertexSize,this.reservedTextureUnits=e.reservedTextureUnits,this._packInterleavedGeometry=e._packInterleavedGeometry,this._preRenderBatch=e._preRenderBatch}setShaderGenerator(e){canvas.performance&&super.setShaderGenerator(e)}contextChange(){this.shaderGenerator=null,super.contextChange()}}}static registerPlugin({force:e=!1}={}){const t=this.classPluginName;if(!(t&&"string"==typeof t&&t.length>0)){const e=`Impossible to create a PIXI plugin for ${this.name}. The plugin name is invalid: [pluginName=${t}]. The plugin name must be a string with at least 1 character.`;throw new Error(e)}if(!e&&BatchRenderer.hasPlugin(t)){const e=`Impossible to create a PIXI plugin for ${this.name}. The plugin name is already associated to a plugin in PIXI.Renderer: [pluginName=${t}].`;throw new Error(e)}this.initializeBatchGeometry();const i=this.createPlugin();PIXI.extensions.add({name:t,type:PIXI.ExtensionType.RendererPlugin,ref:i})}_preRender(e,t){const i=this.uniforms;i.sampler=e.texture,i.tintAlpha=e._cachedTint}}class AdaptiveLightingShader extends AbstractBaseShader{static forceDefaultColor=!1;update(){this.uniforms.depthElevation=canvas.masks.depth.mapElevation(this.uniforms.elevation??0)}static VERTEX_ATTRIBUTES="\n  attribute vec2 aVertexPosition;\n  attribute float aDepthValue;\n  ";static VERTEX_UNIFORMS="\n  uniform mat3 translationMatrix;\n  uniform mat3 projectionMatrix;\n  uniform float rotation;\n  uniform float angle;\n  uniform float radius;\n  uniform float depthElevation;\n  uniform vec2 screenDimensions;\n  uniform vec2 resolution;\n  uniform vec3 origin;\n  uniform vec3 dimensions;\n  ";static VERTEX_FRAGMENT_VARYINGS="\n  varying vec2 vUvs;\n  varying vec2 vSamplerUvs;\n  varying float vDepth;\n  ";static VERTEX_FUNCTIONS="";static FRAGMENT_UNIFORMS=`\n  uniform int technique;\n  uniform bool useSampler;\n  uniform bool hasColor;\n  uniform bool computeIllumination;\n  uniform bool linkedToDarknessLevel;\n  uniform bool enableVisionMasking;\n  uniform bool globalLight;\n  uniform float attenuation;\n  uniform float borderDistance;\n  uniform float contrast;\n  uniform float shadows;\n  uniform float exposure;\n  uniform float saturation;\n  uniform float intensity;\n  uniform float brightness;\n  uniform float luminosity;\n  uniform float pulse;\n  uniform float brightnessPulse;\n  uniform float backgroundAlpha;\n  uniform float illuminationAlpha;\n  uniform float colorationAlpha;\n  uniform float ratio;\n  uniform float time;\n  uniform float darknessLevel;\n  uniform float darknessPenalty;\n  uniform vec2 globalLightThresholds;\n  uniform vec3 color;\n  uniform vec3 colorBackground;\n  uniform vec3 colorVision;\n  uniform vec3 colorTint;\n  uniform vec3 colorEffect;\n  uniform vec3 colorDim;\n  uniform vec3 colorBright;\n  uniform vec3 ambientDaylight;\n  uniform vec3 ambientDarkness;\n  uniform vec3 ambientBrightest;\n  uniform int dimLevelCorrection;\n  uniform int brightLevelCorrection;\n  uniform vec4 weights;\n  uniform sampler2D primaryTexture;\n  uniform sampler2D framebufferTexture;\n  uniform sampler2D depthTexture;\n  uniform sampler2D darknessLevelTexture;\n  uniform sampler2D visionTexture;\n\n  // Shared uniforms with vertex shader\n  uniform ${PIXI.settings.PRECISION_VERTEX} float rotation;\n  uniform ${PIXI.settings.PRECISION_VERTEX} float angle;\n  uniform ${PIXI.settings.PRECISION_VERTEX} float radius;\n  uniform ${PIXI.settings.PRECISION_VERTEX} float depthElevation;\n  uniform ${PIXI.settings.PRECISION_VERTEX} vec2 resolution;\n  uniform ${PIXI.settings.PRECISION_VERTEX} vec2 screenDimensions;\n  uniform ${PIXI.settings.PRECISION_VERTEX} vec3 origin;\n  uniform ${PIXI.settings.PRECISION_VERTEX} vec3 dimensions;\n  uniform ${PIXI.settings.PRECISION_VERTEX} mat3 translationMatrix;\n  uniform ${PIXI.settings.PRECISION_VERTEX} mat3 projectionMatrix;\n  `;static FRAGMENT_FUNCTIONS="\n  #define DARKNESS -2\n  #define HALFDARK -1\n  #define UNLIT 0\n  #define DIM 1\n  #define BRIGHT 2\n  #define BRIGHTEST 3\n  \n  vec3 computedDimColor;\n  vec3 computedBrightColor;\n  vec3 computedBackgroundColor;\n  float computedDarknessLevel;\n  \n  vec3 getCorrectedColor(int level) {\n    if ( (level == HALFDARK) || (level == DIM) ) {\n      return computedDimColor;\n    } else if ( (level == BRIGHT) || (level == DARKNESS) ) {\n      return computedBrightColor;\n    } else if ( level == BRIGHTEST ) {\n      return ambientBrightest;\n    } else if ( level == UNLIT ) {\n      return computedBackgroundColor;\n    } \n    return computedDimColor;\n  }\n  ";static CONSTANTS=`\n    ${super.CONSTANTS}\n    const float INVTHREE = 1.0 / 3.0;\n    const vec2 PIVOT = vec2(0.5);\n    const vec4 ALLONES = vec4(1.0);\n  `;static vertexShader=`\n  ${this.VERTEX_ATTRIBUTES}\n  ${this.VERTEX_UNIFORMS}\n  ${this.VERTEX_FRAGMENT_VARYINGS}\n  ${this.VERTEX_FUNCTIONS}\n\n  void main() {\n    vec3 tPos = translationMatrix * vec3(aVertexPosition, 1.0);\n    vUvs = aVertexPosition * 0.5 + 0.5;\n    vDepth = aDepthValue;\n    vSamplerUvs = tPos.xy / screenDimensions;\n    gl_Position = vec4((projectionMatrix * tPos).xy, 0.0, 1.0);\n  }`;static getShaderTechniques(e){let t="",i=0;for(let n of Object.values(this.SHADER_TECHNIQUES))if(n[e]){let s=`if ( technique == ${n.id} )`;i>0&&(s=`else ${s}`),t+=`${s} {${n[e]}\n}\n`,i++}return t}static get COLORATION_TECHNIQUES(){return this.getShaderTechniques("coloration")}static get ILLUMINATION_TECHNIQUES(){return this.getShaderTechniques("illumination")}static get BACKGROUND_TECHNIQUES(){return this.getShaderTechniques("background")}static get ADJUSTMENTS(){return`vec3 changedColor = finalColor;\n\n    ${this.CONTRAST}\n    ${this.SATURATION}\n    ${this.EXPOSURE}\n    ${this.SHADOW}\n    if ( useSampler ) finalColor = changedColor;`}static CONTRAST="\n    // Computing contrasted color\n    if ( contrast != 0.0 ) {\n      changedColor = (changedColor - 0.5) * (contrast + 1.0) + 0.5;\n    }";static SATURATION="\n    // Computing saturated color\n    if ( saturation != 0.0 ) {\n      vec3 grey = vec3(perceivedBrightness(changedColor));\n      changedColor = mix(grey, changedColor, 1.0 + saturation);\n    }";static EXPOSURE="\n    // Computing exposed color for background\n    if ( exposure > 0.0 ) {\n      float halfExposure = exposure * 0.5;\n      float attenuationStrength = attenuation * 0.25;\n      float lowerEdge = 0.98 - attenuationStrength;\n      float upperEdge = 1.02 + attenuationStrength;\n      float finalExposure = halfExposure *\n                            (1.0 - smoothstep(ratio * lowerEdge, clamp(ratio * upperEdge, 0.0001, 1.0), dist)) +\n                            halfExposure;\n      changedColor *= (1.0 + finalExposure);\n    }\n    ";static SWITCH_COLOR="\n    vec3 switchColor( in vec3 innerColor, in vec3 outerColor, in float dist ) {\n      float attenuationStrength = attenuation * 0.7;\n      float lowerEdge = 0.99 - attenuationStrength;\n      float upperEdge = 1.01 + attenuationStrength;\n      return mix(innerColor, outerColor, smoothstep(ratio * lowerEdge, clamp(ratio * upperEdge, 0.0001, 1.0), dist));\n    }";static SHADOW="\n    // Computing shadows\n    if ( shadows != 0.0 ) {\n      float shadowing = mix(1.0, smoothstep(0.50, 0.80, perceivedBrightness(changedColor)), shadows);\n      // Applying shadow factor\n      changedColor *= shadowing;\n    }";static TRANSITION="\n  finalColor = switchColor(computedBrightColor, computedDimColor, dist);";static FALLOFF="\n  if ( attenuation != 0.0 ) depth *= smoothstep(1.0, 1.0 - attenuation, dist);\n  ";static COMPUTE_ILLUMINATION="\n  float weightDark = weights.x;\n  float weightHalfdark = weights.y;\n  float weightDim = weights.z;\n  float weightBright = weights.w;\n  \n  if ( computeIllumination ) {\n    computedDarknessLevel = texture2D(darknessLevelTexture, vSamplerUvs).r;  \n    computedBackgroundColor = mix(ambientDaylight, ambientDarkness, computedDarknessLevel);\n    computedBrightColor = mix(computedBackgroundColor, ambientBrightest, weightBright);\n    computedDimColor = mix(computedBackgroundColor, computedBrightColor, weightDim);\n    \n    // Apply lighting levels\n    vec3 correctedComputedBrightColor = getCorrectedColor(brightLevelCorrection);\n    vec3 correctedComputedDimColor = getCorrectedColor(dimLevelCorrection);\n    computedBrightColor = correctedComputedBrightColor;\n    computedDimColor = correctedComputedDimColor;\n  }\n  else {\n    computedBackgroundColor = colorBackground;\n    computedDimColor = colorDim;\n    computedBrightColor = colorBright;\n    computedDarknessLevel = darknessLevel;\n  }\n\n  computedDimColor = max(computedDimColor, computedBackgroundColor);\n  computedBrightColor = max(computedBrightColor, computedBackgroundColor);\n\n  if ( globalLight && ((computedDarknessLevel < globalLightThresholds[0]) || (computedDarknessLevel > globalLightThresholds[1])) ) discard;\n  ";static FRAGMENT_BEGIN=`\n  ${this.COMPUTE_ILLUMINATION}\n  float dist = distance(vUvs, vec2(0.5)) * 2.0;\n  vec4 depthColor = texture2D(depthTexture, vSamplerUvs);\n  float depth = smoothstep(0.0, 1.0, vDepth) * step(depthColor.g, depthElevation) * step(depthElevation, (254.5 / 255.0) - depthColor.r);\n  vec4 baseColor = useSampler ? texture2D(primaryTexture, vSamplerUvs) : vec4(1.0);\n  vec3 finalColor = baseColor.rgb;\n  `;static FRAGMENT_END="\n  gl_FragColor = vec4(finalColor, 1.0) * depth;\n  ";static SHADER_TECHNIQUES={LEGACY:{id:0,label:"LIGHT.LegacyColoration"},LUMINANCE:{id:1,label:"LIGHT.AdaptiveLuminance",coloration:"\n      float reflection = perceivedBrightness(baseColor);\n      finalColor *= reflection;"},INTERNAL_HALO:{id:2,label:"LIGHT.InternalHalo",coloration:"\n      float reflection = perceivedBrightness(baseColor);\n      finalColor = switchColor(finalColor, finalColor * reflection, dist);"},EXTERNAL_HALO:{id:3,label:"LIGHT.ExternalHalo",coloration:"\n      float reflection = perceivedBrightness(baseColor);\n      finalColor = switchColor(finalColor * reflection, finalColor, dist);"},COLOR_BURN:{id:4,label:"LIGHT.ColorBurn",coloration:"\n      float reflection = perceivedBrightness(baseColor);\n      finalColor = (finalColor * (1.0 - sqrt(reflection))) / clamp(baseColor.rgb * 2.0, 0.001, 0.25);"},INTERNAL_BURN:{id:5,label:"LIGHT.InternalBurn",coloration:"\n      float reflection = perceivedBrightness(baseColor);\n      finalColor = switchColor((finalColor * (1.0 - sqrt(reflection))) / clamp(baseColor.rgb * 2.0, 0.001, 0.25), finalColor * reflection, dist);"},EXTERNAL_BURN:{id:6,label:"LIGHT.ExternalBurn",coloration:"\n      float reflection = perceivedBrightness(baseColor);\n      finalColor = switchColor(finalColor * reflection, (finalColor * (1.0 - sqrt(reflection))) / clamp(baseColor.rgb * 2.0, 0.001, 0.25), dist);"},LOW_ABSORPTION:{id:7,label:"LIGHT.LowAbsorption",coloration:"\n      float reflection = perceivedBrightness(baseColor);\n      reflection *= smoothstep(0.35, 0.75, reflection);\n      finalColor *= reflection;"},HIGH_ABSORPTION:{id:8,label:"LIGHT.HighAbsorption",coloration:"\n      float reflection = perceivedBrightness(baseColor);\n      reflection *= smoothstep(0.55, 0.85, reflection);\n      finalColor *= reflection;"},INVERT_ABSORPTION:{id:9,label:"LIGHT.InvertAbsorption",coloration:"\n      float r = reversePerceivedBrightness(baseColor);\n      finalColor *= (r * r * r * r * r);"},NATURAL_LIGHT:{id:10,label:"LIGHT.NaturalLight",coloration:"\n      float reflection = perceivedBrightness(baseColor);\n      finalColor *= reflection;",background:"\n      float ambientColorIntensity = perceivedBrightness(computedBackgroundColor);\n      vec3 mutedColor = mix(finalColor, \n                            finalColor * mix(color, computedBackgroundColor, ambientColorIntensity), \n                            backgroundAlpha);\n      finalColor = mix( finalColor,\n                        mutedColor,\n                        computedDarknessLevel);"}};getDarknessPenalty(e,t){return foundry.utils.logCompatibilityWarning("AdaptiveLightingShader#getDarknessPenalty is deprecated without replacement. The darkness penalty is no longer applied on light and vision sources.",{since:12,until:14}),0}}class AdaptiveVisionShader extends AdaptiveLightingShader{static FRAGMENT_FUNCTIONS=`\n  ${super.FRAGMENT_FUNCTIONS}\n  vec3 computedVisionColor;\n  `;static EXPOSURE="\n    // Computing exposed color for background\n    if ( exposure != 0.0 ) {\n      changedColor *= (1.0 + exposure);\n    }";static COMPUTE_ILLUMINATION=`\n  ${super.COMPUTE_ILLUMINATION}\n  if ( computeIllumination ) computedVisionColor = mix(computedDimColor, computedBrightColor, brightness);\n  else computedVisionColor = colorVision;\n  `;static FRAGMENT_BEGIN=`\n  ${this.COMPUTE_ILLUMINATION}\n  float dist = distance(vUvs, vec2(0.5)) * 2.0;\n  vec4 depthColor = texture2D(depthTexture, vSamplerUvs);\n  float depth = smoothstep(0.0, 1.0, vDepth) * step(depthColor.g, depthElevation) * step(depthElevation, (254.5 / 255.0) - depthColor.r);\n  vec4 baseColor = useSampler ? texture2D(primaryTexture, vSamplerUvs) : vec4(1.0);\n  vec3 finalColor = baseColor.rgb;\n  `;static SHADOW="";static SHADER_TECHNIQUES={LEGACY:{id:0,label:"LIGHT.AdaptiveLuminance",coloration:"\n      float reflection = perceivedBrightness(baseColor);\n      finalColor *= reflection;"}}}class AdaptiveBackgroundShader extends AdaptiveLightingShader{static SHADER_HEADER=`\n  ${this.FRAGMENT_UNIFORMS}\n  ${this.VERTEX_FRAGMENT_VARYINGS}\n  ${this.FRAGMENT_FUNCTIONS}\n  ${this.CONSTANTS}\n  ${this.SWITCH_COLOR}\n  `;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    ${this.ADJUSTMENTS}\n    ${this.BACKGROUND_TECHNIQUES}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`;static defaultUniforms={technique:1,contrast:0,shadows:0,saturation:0,intensity:5,attenuation:.5,exposure:0,ratio:.5,color:[1,1,1],colorBackground:[1,1,1],screenDimensions:[1,1],time:0,useSampler:!0,primaryTexture:null,depthTexture:null,darknessLevelTexture:null,depthElevation:1,ambientBrightest:[1,1,1],ambientDarkness:[0,0,0],ambientDaylight:[1,1,1],weights:[0,0,0,0],dimLevelCorrection:1,brightLevelCorrection:2,computeIllumination:!1,globalLight:!1,globalLightThresholds:[0,0]};static{const e=foundry.data.LightData.cleanData();this.defaultUniforms.technique=e.coloration,this.defaultUniforms.contrast=e.contrast,this.defaultUniforms.shadows=e.shadows,this.defaultUniforms.saturation=e.saturation,this.defaultUniforms.intensity=e.animation.intensity,this.defaultUniforms.attenuation=e.attenuation}get isRequired(){const e=canvas.visibility.lightingVisibility;if(e.background===VisionMode.LIGHTING_VISIBILITY.REQUIRED)return!0;if(e.background===VisionMode.LIGHTING_VISIBILITY.DISABLED)return!1;return["contrast","saturation","shadows","exposure","technique"].some((e=>this.uniforms[e]!==this.constructor.defaultUniforms[e]))}}class AdaptiveColorationShader extends AdaptiveLightingShader{static FRAGMENT_END="\n  gl_FragColor = vec4(finalColor * depth, 1.0);\n  ";static get ADJUSTMENTS(){return`\n      vec3 changedColor = finalColor;\n\n      ${this.SATURATION}\n      ${this.SHADOW}\n      finalColor = changedColor;\n`}static SHADOW="\n    // Computing shadows\n    if ( shadows != 0.0 ) {\n      float shadowing = mix(1.0, smoothstep(0.25, 0.35, perceivedBrightness(baseColor.rgb)), shadows);\n      // Applying shadow factor\n      changedColor *= shadowing;\n    }\n  ";static SHADER_HEADER=`\n  ${this.FRAGMENT_UNIFORMS}\n  ${this.VERTEX_FRAGMENT_VARYINGS}\n  ${this.FRAGMENT_FUNCTIONS}\n  ${this.CONSTANTS}\n  ${this.SWITCH_COLOR}\n  `;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n  \n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    finalColor = color * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`;static defaultUniforms={technique:1,shadows:0,contrast:0,saturation:0,colorationAlpha:1,intensity:5,attenuation:.5,ratio:.5,color:[1,1,1],time:0,hasColor:!1,screenDimensions:[1,1],useSampler:!1,primaryTexture:null,depthTexture:null,darknessLevelTexture:null,depthElevation:1,ambientBrightest:[1,1,1],ambientDarkness:[0,0,0],ambientDaylight:[1,1,1],weights:[0,0,0,0],dimLevelCorrection:1,brightLevelCorrection:2,computeIllumination:!1,globalLight:!1,globalLightThresholds:[0,0]};static{const e=foundry.data.LightData.cleanData();this.defaultUniforms.technique=e.coloration,this.defaultUniforms.contrast=e.contrast,this.defaultUniforms.shadows=e.shadows,this.defaultUniforms.saturation=e.saturation,this.defaultUniforms.intensity=e.animation.intensity,this.defaultUniforms.attenuation=e.attenuation}get isRequired(){const e=canvas.visibility.lightingVisibility;return e.coloration===VisionMode.LIGHTING_VISIBILITY.REQUIRED||e.coloration!==VisionMode.LIGHTING_VISIBILITY.DISABLED&&(this.constructor.forceDefaultColor||this.uniforms.hasColor)}}class AdaptiveDarknessShader extends AdaptiveLightingShader{update(){super.update(),this.uniforms.darknessLevel=canvas.environment.darknessLevel}get isRequired(){return canvas.visibility.lightingVisibility.darkness!==VisionMode.LIGHTING_VISIBILITY.DISABLED}static defaultUniforms={intensity:5,color:Color.from("#8651d5").rgb,screenDimensions:[1,1],time:0,primaryTexture:null,depthTexture:null,visionTexture:null,darknessLevelTexture:null,depthElevation:1,ambientBrightest:[1,1,1],ambientDarkness:[0,0,0],ambientDaylight:[1,1,1],weights:[0,0,0,0],dimLevelCorrection:1,brightLevelCorrection:2,borderDistance:0,darknessLevel:0,computeIllumination:!1,globalLight:!1,globalLightThresholds:[0,0],enableVisionMasking:!1};static{const e=foundry.data.LightData.cleanData();this.defaultUniforms.intensity=e.animation.intensity}static FRAGMENT_END="\n  gl_FragColor = vec4(finalColor, 1.0) * depth;\n  ";static FRAGMENT_BEGIN=`\n  ${this.COMPUTE_ILLUMINATION}\n  float dist = distance(vUvs, vec2(0.5)) * 2.0;\n  vec4 depthColor = texture2D(depthTexture, vSamplerUvs);\n  float depth = smoothstep(0.0, 1.0, vDepth) * \n                step(depthColor.g, depthElevation) * \n                step(depthElevation, (254.5 / 255.0) - depthColor.r) *\n                (enableVisionMasking ? 1.0 - step(texture2D(visionTexture, vSamplerUvs).r, 0.0) : 1.0) *\n                (1.0 - smoothstep(borderDistance, 1.0, dist));\n  vec4 baseColor = texture2D(primaryTexture, vSamplerUvs);\n  vec3 finalColor = baseColor.rgb;\n  `;static SHADER_HEADER=`\n  ${this.FRAGMENT_UNIFORMS}\n  ${this.VERTEX_FRAGMENT_VARYINGS}\n  ${this.FRAGMENT_FUNCTIONS}\n  ${this.CONSTANTS}\n  `;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    finalColor *= (mix(color, color * 0.33, darknessLevel) * colorationAlpha);\n    ${this.FRAGMENT_END}\n  }`}class AdaptiveIlluminationShader extends AdaptiveLightingShader{static FRAGMENT_BEGIN=`\n  ${super.FRAGMENT_BEGIN}\n  vec3 framebufferColor = min(texture2D(framebufferTexture, vSamplerUvs).rgb, computedBackgroundColor);\n  `;static FRAGMENT_END="\n  gl_FragColor = vec4(mix(framebufferColor, finalColor, depth), 1.0);\n  ";static get ADJUSTMENTS(){return`\n      vec3 changedColor = finalColor;\n\n      ${this.SATURATION}\n      ${this.EXPOSURE}\n      ${this.SHADOW}\n      finalColor = changedColor;\n`}static EXPOSURE='\n    // Computing exposure with illumination\n    if ( exposure > 0.0 ) {\n      // Diminishing exposure for illumination by a factor 2 (to reduce the "inflating radius" visual problem)\n      float quartExposure = exposure * 0.25;\n      float attenuationStrength = attenuation * 0.25;\n      float lowerEdge = 0.98 - attenuationStrength;\n      float upperEdge = 1.02 + attenuationStrength;\n      float finalExposure = quartExposure *\n                            (1.0 - smoothstep(ratio * lowerEdge, clamp(ratio * upperEdge, 0.0001, 1.0), dist)) +\n                            quartExposure;\n      changedColor *= (1.0 + finalExposure);\n    }\n    else if ( exposure != 0.0 ) changedColor *= (1.0 + exposure);\n  ';static SHADER_HEADER=`\n  ${this.FRAGMENT_UNIFORMS}\n  ${this.VERTEX_FRAGMENT_VARYINGS}\n  ${this.FRAGMENT_FUNCTIONS}\n  ${this.CONSTANTS}\n  ${this.SWITCH_COLOR}\n  `;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    ${this.TRANSITION}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`;static defaultUniforms={technique:1,shadows:0,saturation:0,intensity:5,attenuation:.5,contrast:0,exposure:0,ratio:.5,darknessLevel:0,color:[1,1,1],colorBackground:[1,1,1],colorDim:[1,1,1],colorBright:[1,1,1],screenDimensions:[1,1],time:0,useSampler:!1,primaryTexture:null,framebufferTexture:null,depthTexture:null,darknessLevelTexture:null,depthElevation:1,ambientBrightest:[1,1,1],ambientDarkness:[0,0,0],ambientDaylight:[1,1,1],weights:[0,0,0,0],dimLevelCorrection:1,brightLevelCorrection:2,computeIllumination:!1,globalLight:!1,globalLightThresholds:[0,0]};static{const e=foundry.data.LightData.cleanData();this.defaultUniforms.technique=e.coloration,this.defaultUniforms.contrast=e.contrast,this.defaultUniforms.shadows=e.shadows,this.defaultUniforms.saturation=e.saturation,this.defaultUniforms.intensity=e.animation.intensity,this.defaultUniforms.attenuation=e.attenuation}get isRequired(){return canvas.visibility.lightingVisibility.illumination!==VisionMode.LIGHTING_VISIBILITY.DISABLED}}class RegionShader extends AbstractBaseShader{static vertexShader=`\n    precision ${PIXI.settings.PRECISION_VERTEX} float;\n\n    attribute vec2 aVertexPosition;\n\n    uniform mat3 translationMatrix;\n    uniform mat3 projectionMatrix;\n    uniform vec2 canvasDimensions;\n    uniform vec4 sceneDimensions;\n    uniform vec2 screenDimensions;\n\n    varying vec2 vCanvasCoord; // normalized canvas coordinates\n    varying vec2 vSceneCoord; // normalized scene coordinates\n    varying vec2 vScreenCoord; // normalized screen coordinates\n\n    void main() {\n      vec2 pixelCoord = aVertexPosition;\n      vCanvasCoord = pixelCoord / canvasDimensions;\n      vSceneCoord = (pixelCoord - sceneDimensions.xy) / sceneDimensions.zw;\n      vec3 tPos = translationMatrix * vec3(aVertexPosition, 1.0);\n      vScreenCoord = tPos.xy / screenDimensions;\n      gl_Position = vec4((projectionMatrix * tPos).xy, 0.0, 1.0);\n    }\n  `;static fragmentShader=`\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n\n    uniform vec4 tintAlpha;\n\n    void main() {\n      gl_FragColor = tintAlpha;\n    }\n  `;static defaultUniforms={canvasDimensions:[1,1],sceneDimensions:[0,0,1,1],screenDimensions:[1,1],tintAlpha:[1,1,1,1]};_preRender(e,t){const i=this.uniforms;i.tintAlpha=e._cachedTint;const n=canvas.dimensions;i.canvasDimensions[0]=n.width,i.canvasDimensions[1]=n.height,i.sceneDimensions=n.sceneRect,i.screenDimensions=canvas.screenDimensions}}class AbstractDarknessLevelRegionShader extends RegionShader{static defaultUniforms={...super.defaultUniforms,bottom:0,top:0,depthTexture:null};mode=foundry.data.regionBehaviors.AdjustDarknessLevelRegionBehaviorType.MODES.OVERRIDE;modifier=0;get darknessLevel(){const e=foundry.data.regionBehaviors.AdjustDarknessLevelRegionBehaviorType.MODES;switch(this.mode){case e.OVERRIDE:return this.modifier;case e.BRIGHTEN:return canvas.environment.darknessLevel*(1-this.modifier);case e.DARKEN:return 1-(1-canvas.environment.darknessLevel)*(1-this.modifier);default:throw new Error("Invalid mode")}}_preRender(e,t){super._preRender(e,t);const i=this.uniforms;i.bottom=canvas.masks.depth.mapElevation(e.region.bottom),i.top=canvas.masks.depth.mapElevation(e.region.top),i.depthTexture||(i.depthTexture=canvas.masks.depth.renderTexture)}}class AdjustDarknessLevelRegionShader extends AbstractDarknessLevelRegionShader{static fragmentShader=`\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n\n    uniform sampler2D depthTexture;\n    uniform float darknessLevel;\n    uniform float top;\n    uniform float bottom;\n    uniform vec4 tintAlpha;\n    varying vec2 vScreenCoord;\n\n    void main() {\n      vec2 depthColor = texture2D(depthTexture, vScreenCoord).rg;\n      float depth = step(depthColor.g, top) * step(bottom, (254.5 / 255.0) - depthColor.r);\n      gl_FragColor = vec4(darknessLevel, 0.0, 0.0, 1.0) * tintAlpha * depth;\n    }\n  `;static defaultUniforms={...super.defaultUniforms,darknessLevel:0};_preRender(e,t){super._preRender(e,t),this.uniforms.darknessLevel=this.darknessLevel}}PIXI.settings.PRECISION_FRAGMENT;class HighlightRegionShader extends RegionShader{static vertexShader=`    precision ${PIXI.settings.PRECISION_VERTEX} float;\n\n    ${this.CONSTANTS}\n\n    attribute vec2 aVertexPosition;\n\n    uniform mat3 translationMatrix;\n    uniform mat3 projectionMatrix;\n    uniform vec2 canvasDimensions;\n    uniform vec4 sceneDimensions;\n    uniform vec2 screenDimensions;\n    uniform mediump float hatchThickness;\n\n    varying vec2 vCanvasCoord; // normalized canvas coordinates\n    varying vec2 vSceneCoord; // normalized scene coordinates\n    varying vec2 vScreenCoord; // normalized screen coordinates\n    varying float vHatchOffset;\n\n    void main() {\n      vec2 pixelCoord = aVertexPosition;\n      vCanvasCoord = pixelCoord / canvasDimensions;\n      vSceneCoord = (pixelCoord - sceneDimensions.xy) / sceneDimensions.zw;\n      vec3 tPos = translationMatrix * vec3(aVertexPosition, 1.0);\n      vScreenCoord = tPos.xy / screenDimensions;\n      gl_Position = vec4((projectionMatrix * tPos).xy, 0.0, 1.0);\n      vHatchOffset = (pixelCoord.x + pixelCoord.y) / (SQRT2 * 2.0 * hatchThickness);\n    }\n  `;static fragmentShader=`    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n\n    varying float vHatchOffset;\n\n    uniform vec4 tintAlpha;\n    uniform float resolution;\n    uniform bool hatchEnabled;\n    uniform mediump float hatchThickness;\n\n    void main() {\n      gl_FragColor = tintAlpha;\n      if ( !hatchEnabled ) return;\n      float x = abs(vHatchOffset - floor(vHatchOffset + 0.5)) * 2.0;\n      float s = hatchThickness * resolution;\n      float y0 = clamp((x + 0.5) * s + 0.5, 0.0, 1.0);\n      float y1 = clamp((x - 0.5) * s + 0.5, 0.0, 1.0);\n      gl_FragColor *= mix(0.3333, 1.0, y0 - y1);\n    }\n  `;static defaultUniforms={...super.defaultUniforms,resolution:1,hatchEnabled:!1,hatchThickness:1};_preRender(e,t){super._preRender(e,t);const i=this.uniforms;i.resolution=(t.renderTexture.current??t).resolution*e.worldTransform.a;const n=t.projection.transform;if(n){const{a:e,b:t}=n;i.resolution*=Math.sqrt(e*e+t*t)}}}class BackgroundVisionShader extends AdaptiveVisionShader{static FRAGMENT_END=`\n  finalColor *= colorTint;\n  if ( linkedToDarknessLevel ) finalColor = mix(baseColor.rgb, finalColor, computedDarknessLevel);\n  ${super.FRAGMENT_END}\n  `;static ADJUST_INTENSITY="\n  float darknessLevelDifference = clamp(computedDarknessLevel - darknessLevel, 0.0, 1.0);\n  finalColor = mix(finalColor, finalColor * 0.5, darknessLevelDifference);\n  ";static ADJUSTMENTS=`\n  ${this.ADJUST_INTENSITY}\n  ${super.ADJUSTMENTS}\n  `;static SHADER_HEADER=`\n  ${this.FRAGMENT_UNIFORMS}\n  ${this.VERTEX_FRAGMENT_VARYINGS}\n  ${this.FRAGMENT_FUNCTIONS}\n  ${this.CONSTANTS}`;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    ${this.ADJUSTMENTS}\n    ${this.BACKGROUND_TECHNIQUES}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`;static defaultUniforms={technique:0,saturation:0,contrast:0,attenuation:.1,exposure:0,darknessLevel:0,colorVision:[1,1,1],colorTint:[1,1,1],colorBackground:[1,1,1],screenDimensions:[1,1],time:0,useSampler:!0,linkedToDarknessLevel:!0,primaryTexture:null,depthTexture:null,darknessLevelTexture:null,depthElevation:1,ambientBrightest:[1,1,1],ambientDarkness:[0,0,0],ambientDaylight:[1,1,1],weights:[0,0,0,0],dimLevelCorrection:1,brightLevelCorrection:2,globalLight:!1,globalLightThresholds:[0,0]};get isRequired(){return["contrast","saturation","colorTint","colorVision"].some((e=>this.uniforms[e]!==this.constructor.defaultUniforms[e]))}}class ColorationVisionShader extends AdaptiveVisionShader{static EXPOSURE="";static CONTRAST="";static SHADER_HEADER=`\n  ${this.FRAGMENT_UNIFORMS}\n  ${this.VERTEX_FRAGMENT_VARYINGS}\n  ${this.FRAGMENT_FUNCTIONS}\n  ${this.CONSTANTS}\n  `;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n  \n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    finalColor = colorEffect;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`;static defaultUniforms={technique:0,saturation:0,attenuation:0,colorEffect:[0,0,0],colorBackground:[0,0,0],colorTint:[1,1,1],time:0,screenDimensions:[1,1],useSampler:!0,primaryTexture:null,linkedToDarknessLevel:!0,depthTexture:null,depthElevation:1,ambientBrightest:[1,1,1],ambientDarkness:[0,0,0],ambientDaylight:[1,1,1],weights:[0,0,0,0],dimLevelCorrection:1,brightLevelCorrection:2,globalLight:!1,globalLightThresholds:[0,0]};get isRequired(){return["saturation","colorEffect"].some((e=>this.uniforms[e]!==this.constructor.defaultUniforms[e]))}}class IlluminationVisionShader extends AdaptiveVisionShader{static FRAGMENT_BEGIN=`\n  ${super.FRAGMENT_BEGIN}\n  vec3 framebufferColor = min(texture2D(framebufferTexture, vSamplerUvs).rgb, computedBackgroundColor);\n  `;static FRAGMENT_END="\n  gl_FragColor = vec4(mix(framebufferColor, finalColor, depth), 1.0);\n  ";static VISION_COLOR="\n  finalColor = computedVisionColor;\n  ";static get ADJUSTMENTS(){return`\n      vec3 changedColor = finalColor;\n\n      ${this.SATURATION}\n      finalColor = changedColor;\n`}static SHADER_HEADER=`\n  ${this.FRAGMENT_UNIFORMS}\n  ${this.VERTEX_FRAGMENT_VARYINGS}\n  ${this.FRAGMENT_FUNCTIONS}\n  ${this.CONSTANTS}\n  `;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    ${this.VISION_COLOR}\n    ${this.ILLUMINATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`;static defaultUniforms={technique:foundry.data.LightData.cleanData().initial,attenuation:0,exposure:0,saturation:0,darknessLevel:0,colorVision:[1,1,1],colorTint:[1,1,1],colorBackground:[1,1,1],screenDimensions:[1,1],time:0,useSampler:!1,linkedToDarknessLevel:!0,primaryTexture:null,framebufferTexture:null,depthTexture:null,darknessLevelTexture:null,depthElevation:1,ambientBrightest:[1,1,1],ambientDarkness:[0,0,0],ambientDaylight:[1,1,1],weights:[0,0,0,0],dimLevelCorrection:1,brightLevelCorrection:2,globalLight:!1,globalLightThresholds:[0,0]}}class DepthSamplerShader extends BaseSamplerShader{static classPluginName="batchDepth";static batchGeometry=[{id:"aVertexPosition",size:2,normalized:!1,type:PIXI.TYPES.FLOAT},{id:"aTextureCoord",size:2,normalized:!1,type:PIXI.TYPES.FLOAT},{id:"aTextureId",size:1,normalized:!1,type:PIXI.TYPES.UNSIGNED_BYTE},{id:"aTextureAlphaThreshold",size:1,normalized:!0,type:PIXI.TYPES.UNSIGNED_BYTE},{id:"aDepthElevation",size:1,normalized:!0,type:PIXI.TYPES.UNSIGNED_BYTE},{id:"aRestrictionState",size:1,normalized:!1,type:PIXI.TYPES.UNSIGNED_BYTE},{id:"aOcclusionData",size:4,normalized:!0,type:PIXI.TYPES.UNSIGNED_BYTE}];static batchVertexSize=6;static reservedTextureUnits=1;static defaultUniforms={screenDimensions:[1,1],sampler:null,occlusionTexture:null,textureAlphaThreshold:0,depthElevation:0,occlusionElevation:0,fadeOcclusion:0,radialOcclusion:0,visionOcclusion:0,restrictsLight:!1,restrictsWeather:!1};static batchDefaultUniforms(e){return{screenDimensions:[1,1],occlusionTexture:e}}static _preRenderBatch(e){const t=e._shader.uniforms;t.screenDimensions=canvas.screenDimensions,e.renderer.texture.bind(canvas.masks.occlusion.renderTexture,t.occlusionTexture)}static _packInterleavedGeometry(e,t,i,n,s){const{float32View:o,uint8View:r}=t,a=n/this.vertexSize,l=e.indices;for(let e=0;e<l.length;e++)i[s++]=a+l[e];const c=e.vertexData,d=e.uvs,u=e._texture.baseTexture._batchLocation,h=e.restrictionState,p=255*e.textureAlphaThreshold|0,g=255*canvas.masks.depth.mapElevation(e.elevation)|0,m=255*canvas.masks.occlusion.mapElevation(e.elevation)|0,v=255*e.fadeOcclusion|0,y=255*e.radialOcclusion|0,b=255*e.visionOcclusion|0,S=this.vertexSize;for(let e=0,t=0;e<c.length;e+=2,t+=S){let i=n+t;o[i++]=c[e],o[i++]=c[e+1],o[i++]=d[e],o[i++]=d[e+1],i<<=2,r[i++]=u,r[i++]=p,r[i++]=g,r[i++]=h,r[i++]=m,r[i++]=v,r[i++]=y,r[i++]=b}}static get batchVertexShader(){return`\n      #version 300 es\n\n      ${this.GLSL1_COMPATIBILITY_VERTEX}\n\n      precision ${PIXI.settings.PRECISION_VERTEX} float;\n\n      in vec2 aVertexPosition;\n      in vec2 aTextureCoord;\n\n      uniform vec2 screenDimensions;\n\n      ${this._batchVertexShader}\n\n      in float aTextureId;\n      in float aTextureAlphaThreshold;\n      in float aDepthElevation;\n      in vec4 aOcclusionData;\n      in float aRestrictionState;\n\n      uniform mat3 projectionMatrix;\n      uniform mat3 translationMatrix;\n\n      out vec2 vTextureCoord;\n      out vec2 vOcclusionCoord;\n      flat out float vTextureId;\n      flat out float vTextureAlphaThreshold;\n      flat out float vDepthElevation;\n      flat out float vOcclusionElevation;\n      flat out float vFadeOcclusion;\n      flat out float vRadialOcclusion;\n      flat out float vVisionOcclusion;\n      flat out uint vRestrictionState;\n\n      void main() {\n        vec2 vertexPosition;\n        vec2 textureCoord;\n        _main(vertexPosition, textureCoord);\n        vec3 tPos = translationMatrix * vec3(vertexPosition, 1.0);\n        gl_Position = vec4((projectionMatrix * tPos).xy, 0.0, 1.0);\n        vTextureCoord = textureCoord;\n        vOcclusionCoord = tPos.xy / screenDimensions;\n        vTextureId = aTextureId;\n        vTextureAlphaThreshold = aTextureAlphaThreshold;\n        vDepthElevation = aDepthElevation;\n        vOcclusionElevation = aOcclusionData.x;\n        vFadeOcclusion = aOcclusionData.y;\n        vRadialOcclusion = aOcclusionData.z;\n        vVisionOcclusion = aOcclusionData.w;\n        vRestrictionState = uint(aRestrictionState);\n      }\n    `}static _batchVertexShader="\n    void _main(out vec2 vertexPosition, out vec2 textureCoord) {\n      vertexPosition = aVertexPosition;\n      textureCoord = aTextureCoord;\n    }\n  ";static get batchFragmentShader(){return`\n      #version 300 es\n\n      ${this.GLSL1_COMPATIBILITY_FRAGMENT}\n\n      precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n\n      in vec2 vTextureCoord;\n      flat in float vTextureId;\n\n      uniform sampler2D uSamplers[%count%];\n\n      ${DepthSamplerShader.#ss}\n      ${this._batchFragmentShader}\n\n      in vec2 vOcclusionCoord;\n      flat in float vTextureAlphaThreshold;\n      flat in float vDepthElevation;\n      flat in float vOcclusionElevation;\n      flat in float vFadeOcclusion;\n      flat in float vRadialOcclusion;\n      flat in float vVisionOcclusion;\n      flat in uint vRestrictionState;\n      \n      uniform sampler2D occlusionTexture;\n\n      out vec3 fragColor;\n\n      void main() {\n        float textureAlpha = _main();\n        float textureAlphaThreshold = vTextureAlphaThreshold;\n        float depthElevation = vDepthElevation;\n        float occlusionElevation = vOcclusionElevation;\n        float fadeOcclusion = vFadeOcclusion;\n        float radialOcclusion = vRadialOcclusion;\n        float visionOcclusion = vVisionOcclusion;\n        bool restrictsLight = ((vRestrictionState & RESTRICTS_LIGHT) == RESTRICTS_LIGHT);\n        bool restrictsWeather = ((vRestrictionState & RESTRICTS_WEATHER) == RESTRICTS_WEATHER);\n        ${DepthSamplerShader.#os}\n      }\n    `}static _batchFragmentShader="\n    float _main() {\n      vec4 color;\n      %forloop%\n      return color.a;\n    }\n  ";static get vertexShader(){return`\n      #version 300 es\n\n      ${this.GLSL1_COMPATIBILITY_VERTEX}\n\n      precision ${PIXI.settings.PRECISION_VERTEX} float;\n\n      in vec2 aVertexPosition;\n      in vec2 aTextureCoord;\n\n      uniform vec2 screenDimensions;\n\n      ${this._vertexShader}\n\n      uniform mat3 projectionMatrix;\n\n      out vec2 vUvs;\n      out vec2 vOcclusionCoord;\n\n      void main() {\n        vec2 vertexPosition;\n        vec2 textureCoord;\n        _main(vertexPosition, textureCoord);\n        gl_Position = vec4((projectionMatrix * vec3(vertexPosition, 1.0)).xy, 0.0, 1.0);\n        vUvs = textureCoord;\n        vOcclusionCoord = vertexPosition / screenDimensions;\n      }\n    `}static _vertexShader="\n    void _main(out vec2 vertexPosition, out vec2 textureCoord) {\n      vertexPosition = aVertexPosition;\n      textureCoord = aTextureCoord;\n    }\n  ";static get fragmentShader(){return`\n      #version 300 es\n\n      ${this.GLSL1_COMPATIBILITY_FRAGMENT}\n\n      precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n\n      in vec2 vUvs;\n\n      uniform sampler2D sampler;\n\n      ${DepthSamplerShader.#ss}\n      ${this._fragmentShader}\n\n      in vec2 vOcclusionCoord;\n\n      uniform sampler2D occlusionTexture;\n      uniform float textureAlphaThreshold;\n      uniform float depthElevation;\n      uniform float occlusionElevation;\n      uniform float fadeOcclusion;\n      uniform float radialOcclusion;\n      uniform float visionOcclusion;\n      uniform bool restrictsLight;\n      uniform bool restrictsWeather;\n\n      out vec3 fragColor;\n\n      void main() {\n        float textureAlpha = _main();\n        ${DepthSamplerShader.#os}\n      }\n    `}static _fragmentShader="\n    float _main() {\n      return texture(sampler, vUvs).a;\n    }\n  ";_preRender(e,t){super._preRender(e,t);const i=this.uniforms;i.screenDimensions=canvas.screenDimensions,i.textureAlphaThreshold=e.textureAlphaThreshold;const n=canvas.masks.occlusion;i.occlusionTexture=n.renderTexture,i.occlusionElevation=n.mapElevation(e.elevation),i.depthElevation=canvas.masks.depth.mapElevation(e.elevation);const s=e._occlusionState;i.fadeOcclusion=s.fade,i.radialOcclusion=s.radial,i.visionOcclusion=s.vision,i.restrictsLight=e.restrictsLight,i.restrictsWeather=e.restrictsWeather}static#ss=foundry.utils.BitMask.generateShaderBitMaskConstants(["RESTRICTS_LIGHT","RESTRICTS_WEATHER"]);static#os="\n    float inverseDepthElevation = 1.0 - depthElevation;\n    fragColor = vec3(inverseDepthElevation, depthElevation, inverseDepthElevation);\n    fragColor *= step(textureAlphaThreshold, textureAlpha);\n    vec3 weight = 1.0 - step(occlusionElevation, texture(occlusionTexture, vOcclusionCoord).rgb);\n    float occlusion = step(0.5, max(max(weight.r * fadeOcclusion, weight.g * radialOcclusion), weight.b * visionOcclusion));\n    fragColor.r *= occlusion;\n    fragColor.g *= 1.0 - occlusion;\n    fragColor.b *= occlusion;\n    if ( !restrictsLight ) {\n      fragColor.r = 0.0;\n      fragColor.g = 0.0;\n    }\n    if ( !restrictsWeather ) {\n      fragColor.b = 0.0;\n    }\n  "}class OccludableSamplerShader extends BaseSamplerShader{static#rs="\n    vec3 occluded = 1.0 - step(occlusionElevation, texture(occlusionTexture, vScreenCoord).rgb);\n    float occlusion = max(occluded.r * fadeOcclusion, max(occluded.g * radialOcclusion, occluded.b * visionOcclusion));\n    fragColor *= mix(unoccludedAlpha, occludedAlpha, occlusion);\n  ";static classPluginName="batchOcclusion";static batchGeometry=[{id:"aVertexPosition",size:2,normalized:!1,type:PIXI.TYPES.FLOAT},{id:"aTextureCoord",size:2,normalized:!1,type:PIXI.TYPES.FLOAT},{id:"aColor",size:4,normalized:!0,type:PIXI.TYPES.UNSIGNED_BYTE},{id:"aTextureId",size:1,normalized:!1,type:PIXI.TYPES.UNSIGNED_SHORT},{id:"aOcclusionAlphas",size:2,normalized:!0,type:PIXI.TYPES.UNSIGNED_BYTE},{id:"aOcclusionData",size:4,normalized:!0,type:PIXI.TYPES.UNSIGNED_BYTE}];static batchVertexSize=7;static reservedTextureUnits=1;static defaultUniforms={screenDimensions:[1,1],sampler:null,tintAlpha:[1,1,1,1],occlusionTexture:null,unoccludedAlpha:1,occludedAlpha:0,occlusionElevation:0,fadeOcclusion:0,radialOcclusion:0,visionOcclusion:0};static batchDefaultUniforms(e){return{screenDimensions:[1,1],occlusionTexture:e}}static _preRenderBatch(e){const t=canvas.masks.occlusion,i=e._shader.uniforms;i.screenDimensions=canvas.screenDimensions,e.renderer.texture.bind(t.renderTexture,i.occlusionTexture)}static _packInterleavedGeometry(e,t,i,n,s){const{float32View:o,uint8View:r,uint16View:a,uint32View:l}=t,c=n/this.vertexSize,d=e.indices;for(let e=0;e<d.length;e++)i[s++]=c+d[e];const u=e.vertexData,h=e.uvs,p=e._texture.baseTexture,g=Math.min(e.worldAlpha,1),m=PIXI.Color.shared.setValue(e._tintRGB).toPremultiplied(g,p.alphaMode>0),v=p._batchLocation,y=255*e.unoccludedAlpha|0,b=255*e.occludedAlpha|0,S=255*canvas.masks.occlusion.mapElevation(e.elevation)|0,T=255*e.fadeOcclusion|0,E=255*e.radialOcclusion|0,C=255*e.visionOcclusion|0,_=this.vertexSize;for(let e=0,t=0;e<u.length;e+=2,t+=_){let i=n+t;o[i++]=u[e],o[i++]=u[e+1],o[i++]=h[e],o[i++]=h[e+1],l[i++]=m,i<<=1,a[i++]=v,i<<=1,r[i++]=y,r[i++]=b,r[i++]=S,r[i++]=T,r[i++]=E,r[i++]=C}}static get batchVertexShader(){return`\n      #version 300 es\n\n      ${this.GLSL1_COMPATIBILITY_VERTEX}\n\n      precision ${PIXI.settings.PRECISION_VERTEX} float;\n\n      in vec2 aVertexPosition;\n      in vec2 aTextureCoord;\n      in vec4 aColor;\n\n      uniform mat3 translationMatrix;\n      uniform vec4 tint;\n      uniform vec2 screenDimensions;\n\n      ${this._batchVertexShader}\n\n      in float aTextureId;\n      in vec2 aOcclusionAlphas;\n      in vec4 aOcclusionData;\n\n      uniform mat3 projectionMatrix;\n\n      out vec2 vTextureCoord;\n      out vec2 vScreenCoord;\n      flat out vec4 vColor;\n      flat out float vTextureId;\n      flat out float vUnoccludedAlpha;\n      flat out float vOccludedAlpha;\n      flat out float vOcclusionElevation;\n      flat out float vFadeOcclusion;\n      flat out float vRadialOcclusion;\n      flat out float vVisionOcclusion;\n\n      void main() {\n        vec2 vertexPosition;\n        vec2 textureCoord;\n        vec4 color;\n        _main(vertexPosition, textureCoord, color);\n        gl_Position = vec4((projectionMatrix * vec3(vertexPosition, 1.0)).xy, 0.0, 1.0);\n        vTextureCoord = textureCoord;\n        vScreenCoord = vertexPosition / screenDimensions;\n        vColor = color;\n        vTextureId = aTextureId;\n        vUnoccludedAlpha = aOcclusionAlphas.x;\n        vOccludedAlpha = aOcclusionAlphas.y;\n        vOcclusionElevation = aOcclusionData.x;\n        vFadeOcclusion = aOcclusionData.y;\n        vRadialOcclusion = aOcclusionData.z;\n        vVisionOcclusion = aOcclusionData.w;\n      }\n    `}static _batchVertexShader="\n    void _main(out vec2 vertexPosition, out vec2 textureCoord, out vec4 color) {\n      vertexPosition = (translationMatrix * vec3(aVertexPosition, 1.0)).xy;\n      textureCoord = aTextureCoord;\n      color = aColor * tint;\n    }\n  ";static get batchFragmentShader(){return`\n      #version 300 es\n\n      ${this.GLSL1_COMPATIBILITY_FRAGMENT}\n\n      precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n\n      in vec2 vTextureCoord;\n      in vec2 vScreenCoord;\n      flat in vec4 vColor;\n      flat in float vTextureId;\n\n      uniform sampler2D uSamplers[%count%];\n\n      ${this._batchFragmentShader}\n\n      flat in float vUnoccludedAlpha;\n      flat in float vOccludedAlpha;\n      flat in float vOcclusionElevation;\n      flat in float vFadeOcclusion;\n      flat in float vRadialOcclusion;\n      flat in float vVisionOcclusion;\n\n      uniform sampler2D occlusionTexture;\n\n      out vec4 fragColor;\n\n      void main() {\n        fragColor = _main();\n        float unoccludedAlpha = vUnoccludedAlpha;\n        float occludedAlpha = vOccludedAlpha;\n        float occlusionElevation = vOcclusionElevation;\n        float fadeOcclusion = vFadeOcclusion;\n        float radialOcclusion = vRadialOcclusion;\n        float visionOcclusion = vVisionOcclusion;\n        ${OccludableSamplerShader.#rs}\n      }\n    `}static _batchFragmentShader="\n    vec4 _main() {\n      vec4 color;\n      %forloop%\n      return color * vColor;\n    }\n  ";static get vertexShader(){return`\n      #version 300 es\n\n      ${this.GLSL1_COMPATIBILITY_VERTEX}\n\n      precision ${PIXI.settings.PRECISION_VERTEX} float;\n\n      in vec2 aVertexPosition;\n      in vec2 aTextureCoord;\n\n      uniform vec2 screenDimensions;\n\n      ${this._vertexShader}\n\n      uniform mat3 projectionMatrix;\n\n      out vec2 vUvs;\n      out vec2 vScreenCoord;\n\n      void main() {\n        vec2 vertexPosition;\n        vec2 textureCoord;\n        _main(vertexPosition, textureCoord);\n        gl_Position = vec4((projectionMatrix * vec3(vertexPosition, 1.0)).xy, 0.0, 1.0);\n        vUvs = textureCoord;\n        vScreenCoord = vertexPosition / screenDimensions;\n      }\n    `}static _vertexShader="\n    void _main(out vec2 vertexPosition, out vec2 textureCoord) {\n      vertexPosition = aVertexPosition;\n      textureCoord = aTextureCoord;\n    }\n  ";static get fragmentShader(){return`\n      #version 300 es\n\n      ${this.GLSL1_COMPATIBILITY_FRAGMENT}\n\n      precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n\n      in vec2 vUvs;\n      in vec2 vScreenCoord;\n\n      uniform sampler2D sampler;\n      uniform vec4 tintAlpha;\n\n      ${this._fragmentShader}\n\n      uniform sampler2D occlusionTexture;\n      uniform float unoccludedAlpha;\n      uniform float occludedAlpha;\n      uniform float occlusionElevation;\n      uniform float fadeOcclusion;\n      uniform float radialOcclusion;\n      uniform float visionOcclusion;\n\n      out vec4 fragColor;\n\n      void main() {\n        fragColor = _main();\n        ${OccludableSamplerShader.#rs}\n      }\n    `}static _fragmentShader="\n    vec4 _main() {\n      return texture(sampler, vUvs) * tintAlpha;\n    }\n  ";_preRender(e,t){super._preRender(e,t);const i=this.uniforms;i.screenDimensions=canvas.screenDimensions;const n=canvas.masks.occlusion;i.occlusionTexture=n.renderTexture,i.occlusionElevation=n.mapElevation(e.elevation),i.unoccludedAlpha=e.unoccludedAlpha,i.occludedAlpha=e.occludedAlpha;const s=e._occlusionState;i.fadeOcclusion=s.fade,i.radialOcclusion=s.radial,i.visionOcclusion=s.vision}}class PrimaryBaseSamplerShader extends OccludableSamplerShader{static depthShaderClass=DepthSamplerShader;get depthShader(){return this.#as??=this.#ls()}#as;#ls(){const e=this.constructor.depthShaderClass.create();return this._configureDepthShader(e),e}_configureDepthShader(e){}}class BaselineIlluminationSamplerShader extends BaseSamplerShader{static classPluginName=null;static fragmentShader=`\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n    uniform sampler2D sampler;\n    uniform vec4 tintAlpha;\n    uniform vec3 ambientDarkness;\n    uniform vec3 ambientDaylight;\n    varying vec2 vUvs;    \n\n    void main() {\n      float illuminationRed = texture2D(sampler, vUvs).r;\n      vec3 finalColor = mix(ambientDaylight, ambientDarkness, illuminationRed);\n      gl_FragColor = vec4(finalColor, 1.0) * tintAlpha;\n    }`;static defaultUniforms={tintAlpha:[1,1,1,1],ambientDarkness:[0,0,0],ambientDaylight:[1,1,1],sampler:null};_preRender(e,t){super._preRender(e,t);const i=canvas.colors,n=this.uniforms;i.ambientDarkness.applyRGB(n.ambientDarkness),i.ambientDaylight.applyRGB(n.ambientDaylight)}}class ColorAdjustmentsSamplerShader extends BaseSamplerShader{static classPluginName=null;static vertexShader=`\n    precision ${PIXI.settings.PRECISION_VERTEX} float;\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    uniform mat3 projectionMatrix;\n    uniform vec2 screenDimensions;\n    varying vec2 vUvs;\n    varying vec2 vScreenCoord;\n\n    void main() {\n      gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n      vUvs = aTextureCoord;\n      vScreenCoord = aVertexPosition / screenDimensions;\n    }`;static fragmentShader=`\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n    uniform sampler2D sampler;\n    uniform vec4 tintAlpha;\n    uniform vec3 tint;\n    uniform float exposure;\n    uniform float contrast;\n    uniform float saturation;\n    uniform float brightness;\n    uniform sampler2D darknessLevelTexture;\n    uniform bool linkedToDarknessLevel;\n    varying vec2 vUvs;\n    varying vec2 vScreenCoord;\n\n    ${this.CONSTANTS}\n    ${this.PERCEIVED_BRIGHTNESS}\n\n    void main() {\n      vec4 baseColor = texture2D(sampler, vUvs);\n\n      if ( baseColor.a > 0.0 ) {\n        // Unmultiply rgb with alpha channel\n        baseColor.rgb /= baseColor.a;\n\n        // Copy original color before update\n        vec3 originalColor = baseColor.rgb;\n\n        ${this.ADJUSTMENTS}\n\n        if ( linkedToDarknessLevel ) {\n          float darknessLevel = texture2D(darknessLevelTexture, vScreenCoord).r;\n          baseColor.rgb = mix(originalColor, baseColor.rgb, darknessLevel);\n        }\n\n        // Multiply rgb with tint and alpha channel\n        baseColor.rgb *= (tint * baseColor.a);\n      }\n\n      // Output with tint and alpha\n      gl_FragColor = baseColor * tintAlpha;\n    }`;static defaultUniforms={tintAlpha:[1,1,1,1],tint:[1,1,1],contrast:0,saturation:0,exposure:0,sampler:null,linkedToDarknessLevel:!1,darknessLevelTexture:null,screenDimensions:[1,1]};get linkedToDarknessLevel(){return this.uniforms.linkedToDarknessLevel}set linkedToDarknessLevel(e){this.uniforms.linkedToDarknessLevel=e}get contrast(){return this.uniforms.contrast}set contrast(e){this.uniforms.contrast=e}get exposure(){return this.uniforms.exposure}set exposure(e){this.uniforms.exposure=e}get saturation(){return this.uniforms.saturation}set saturation(e){this.uniforms.saturation=e}}class AmplificationSamplerShader extends ColorAdjustmentsSamplerShader{static classPluginName=null;static vertexShader=`\n    precision ${PIXI.settings.PRECISION_VERTEX} float;\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    uniform mat3 projectionMatrix;\n    uniform vec2 screenDimensions;\n    varying vec2 vUvs;\n    varying vec2 vScreenCoord;\n\n    void main() {\n      gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n      vUvs = aTextureCoord;\n      vScreenCoord = aVertexPosition / screenDimensions;\n    }\n  `;static fragmentShader=`\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n    uniform sampler2D sampler;\n    uniform vec4 tintAlpha;\n    uniform vec3 tint;\n    uniform float exposure;\n    uniform float contrast;\n    uniform float saturation;\n    uniform float brightness;\n    uniform sampler2D darknessLevelTexture;\n    uniform bool linkedToDarknessLevel;\n    uniform bool enable;\n    varying vec2 vUvs;\n    varying vec2 vScreenCoord;\n\n    ${this.CONSTANTS}\n    ${this.PERCEIVED_BRIGHTNESS}\n\n    void main() {\n      vec4 baseColor = texture2D(sampler, vUvs);\n\n      if ( enable && baseColor.a > 0.0 ) {\n        // Unmultiply rgb with alpha channel\n        baseColor.rgb /= baseColor.a;\n\n        float lum = perceivedBrightness(baseColor.rgb);\n        vec3 vision = vec3(smoothstep(0.0, 1.0, lum * 1.5)) * tint;\n        float darknessLevel = texture2D(darknessLevelTexture, vScreenCoord).r;\n        baseColor.rgb = vision + (vision * (lum + brightness) * 0.1) + (baseColor.rgb * (1.0 - darknessLevel) * 0.125);\n\n        ${this.ADJUSTMENTS}\n\n        // Multiply rgb with alpha channel\n        baseColor.rgb *= baseColor.a;\n      }\n\n      // Output with tint and alpha\n      gl_FragColor = baseColor * tintAlpha;\n    }`;static defaultUniforms={tintAlpha:[1,1,1,1],tint:[.38,.8,.38],brightness:0,darknessLevelTexture:null,screenDimensions:[1,1],enable:!0};get brightness(){return this.uniforms.brightness}set brightness(e){this.uniforms.brightness=e}get colorTint(){return this.uniforms.colorTint}set colorTint(e){this.uniforms.colorTint=e}}class FogSamplerShader extends BaseSamplerShader{static classPluginName=null;static fragmentShader=`\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n    uniform sampler2D sampler;\n    uniform vec4 tintAlpha;\n    varying vec2 vUvs;\n    void main() {\n        vec4 color = texture2D(sampler, vUvs);\n        gl_FragColor = vec4(1.0, color.gb, 1.0) * step(0.15, color.r) * tintAlpha;\n    }`}class TokenRingSamplerShader extends PrimaryBaseSamplerShader{static classPluginName="tokenRingBatch";static pausable=!1;static batchGeometry=[...super.batchGeometry??[],{id:"aRingTextureCoord",size:2,normalized:!1,type:PIXI.TYPES.FLOAT},{id:"aBackgroundTextureCoord",size:2,normalized:!1,type:PIXI.TYPES.FLOAT},{id:"aRingColor",size:4,normalized:!0,type:PIXI.TYPES.UNSIGNED_BYTE},{id:"aBackgroundColor",size:4,normalized:!0,type:PIXI.TYPES.UNSIGNED_BYTE},{id:"aStates",size:1,normalized:!1,type:PIXI.TYPES.FLOAT},{id:"aScaleCorrection",size:2,normalized:!1,type:PIXI.TYPES.FLOAT},{id:"aRingColorBand",size:2,normalized:!1,type:PIXI.TYPES.FLOAT},{id:"aTextureScaleCorrection",size:1,normalized:!1,type:PIXI.TYPES.FLOAT}];static batchVertexSize=super.batchVertexSize+12;static reservedTextureUnits=super.reservedTextureUnits+1;static nullUvs=new Float32Array([0,0,0,0,0,0,0,0]);static batchDefaultUniforms(e){return{...super.batchDefaultUniforms(e),tokenRingTexture:e+super.reservedTextureUnits,time:0}}static _preRenderBatch(e){super._preRenderBatch(e),e.renderer.texture.bind(g.Token.ring.ringClass.baseTexture,e.uniforms.tokenRingTexture),e.uniforms.time=canvas.app.ticker.lastTime/1e3,e.uniforms.debugColorBands=g.Token.ring.debugColorBands}static _packInterleavedGeometry(e,t,i,n,s){super._packInterleavedGeometry(e,t,i,n,s);const{float32View:o,uint32View:r}=t,a=e.vertexData,l=g.Token.ringClass,c=e.object.object||{},d=PIXI.Color.shared.setValue(c.ring?.ringColorLittleEndian??16777215).toNumber(),u=PIXI.Color.shared.setValue(c.ring?.bkgColorLittleEndian??16777215).toNumber(),h=c.ring?.ringUVs??l.tokenRingSamplerShader.nullUvs,p=c.ring?.bkgUVs??l.tokenRingSamplerShader.nullUvs,m=(c.ring?.effects??0)+.5,v=(c.ring?.scaleCorrection??1)*(c.ring?.scaleAdjustmentX??1),y=(c.ring?.scaleCorrection??1)*(c.ring?.scaleAdjustmentY??1),b=c.ring?.colorBand.startRadius??0,S=c.ring?.colorBand.endRadius??0,T=c.ring?.textureScaleAdjustment??1,E=this.vertexSize;for(let e=0,t=PrimaryBaseSamplerShader.batchVertexSize;e<a.length;e+=2,t+=E){let i=n+t;o[i++]=h[e],o[i++]=h[e+1],o[i++]=p[e],o[i++]=p[e+1],r[i++]=d,r[i++]=u,o[i++]=m,o[i++]=v,o[i++]=y,o[i++]=b,o[i++]=S,o[i++]=T}}static#cs="\n    const uint STATE_RING_PULSE = 0x02U;\n    const uint STATE_RING_GRADIENT = 0x04U;\n    const uint STATE_BKG_WAVE = 0x08U;\n    const uint STATE_INVISIBLE = 0x10U;\n\n    /* -------------------------------------------- */\n\n    bool hasState(in uint state) {\n      return (vStates & state) == state;\n    }\n\n    /* -------------------------------------------- */\n\n    vec2 rotation(in vec2 uv, in float a) {\n      uv -= 0.5;\n      float s = sin(a);\n      float c = cos(a);\n      return uv * mat2(c, -s, s, c) + 0.5;\n    }\n\n    /* -------------------------------------------- */\n\n    float normalizedCos(in float val) {\n      return (cos(val) + 1.0) * 0.5;\n    }\n\n    /* -------------------------------------------- */\n\n    float wave(in float dist) {\n      float sinWave = 0.5 * (sin(-time * 4.0 + dist * 100.0) + 1.0);\n      return mix(1.0, 0.55 * sinWave + 0.8, clamp(1.0 - dist, 0.0, 1.0));\n    }\n\n    /* -------------------------------------------- */\n\n    vec4 colorizeTokenRing(in vec4 tokenRing, in float dist) {\n      if ( tokenRing.a > 0.0 ) tokenRing.rgb /= tokenRing.a;\n      vec3 rcol = hasState(STATE_RING_PULSE)\n                  ? mix(tokenRing.rrr, tokenRing.rrr * 0.35, (cos(time * 2.0) + 1.0) * 0.5)\n                  : tokenRing.rrr;\n      vec3 ccol = vRingColor * rcol;\n      vec3 gcol = hasState(STATE_RING_GRADIENT)\n              ? mix(ccol, vBackgroundColor * tokenRing.r, smoothstep(0.0, 1.0, dot(rotation(vTextureCoord, time), vec2(0.5))))\n              : ccol;\n      vec3 col = mix(tokenRing.rgb, gcol, step(vRingColorBand.x, dist) - step(vRingColorBand.y, dist));\n      return vec4(col, 1.0) * tokenRing.a;\n    }\n\n    /* -------------------------------------------- */\n\n    vec4 colorizeTokenBackground(in vec4 tokenBackground, in float dist) {\n      if (tokenBackground.a > 0.0) tokenBackground.rgb /= tokenBackground.a;\n    \n      float wave = hasState(STATE_BKG_WAVE) ? (0.5 + wave(dist) * 1.5) : 1.0;\n      vec3 bgColor = tokenBackground.rgb;\n      vec3 tintColor = vBackgroundColor.rgb;\n      vec3 resultColor;\n  \n      // Overlay blend mode\n      if ( tintColor == vec3(1.0, 1.0, 1.0) ) {\n        // If tint color is pure white, keep the original background color\n        resultColor = bgColor;\n      } else {\n        // Overlay blend mode\n        for ( int i = 0; i < 3; i++ ) {\n          if ( bgColor[i] < 0.5 ) resultColor[i] = 2.0 * bgColor[i] * tintColor[i];\n          else resultColor[i] = 1.0 - 2.0 * (1.0 - bgColor[i]) * (1.0 - tintColor[i]);\n        }\n      }\n      return vec4(resultColor, 1.0) * tokenBackground.a * wave;\n    }\n\n    /* -------------------------------------------- */\n\n    vec4 processTokenColor(in vec4 finalColor) {\n      if ( !hasState(STATE_INVISIBLE) ) return finalColor;\n\n      // Computing halo\n      float lum = perceivedBrightness(finalColor.rgb);\n      vec3 haloColor = vec3(lum) * vec3(0.5, 1.0, 1.0);\n\n      // Construct final image\n      return vec4(haloColor, 1.0) * finalColor.a\n                   * (0.55 + normalizedCos(time * 2.0) * 0.25);\n    }\n\n    /* -------------------------------------------- */\n\n    vec4 blend(vec4 src, vec4 dst) {\n      return src + (dst * (1.0 - src.a));\n    }\n    \n    /* -------------------------------------------- */\n    \n    float getTokenTextureClip() {\n      return step(3.5,\n           step(0.0, vTextureCoord.x) +\n           step(0.0, vTextureCoord.y) +\n           step(vTextureCoord.x, 1.0) +\n           step(vTextureCoord.y, 1.0));\n    }\n  ";static#ds="\n    vec4 color;\n    vec4 result;\n\n    %forloop%\n\n    if ( vStates == 0U ) result = color * vColor;\n    else {\n      // Compute distances\n      vec2 scaledDistVec = (vOrigTextureCoord - 0.5) * 2.0 * vScaleCorrection;\n      \n      // Euclidean distance computation\n      float dist = length(scaledDistVec);\n      \n      // Rectangular distance computation\n      vec2 absScaledDistVec = abs(scaledDistVec);\n      float rectangularDist = max(absScaledDistVec.x, absScaledDistVec.y);\n      \n      // Clip token texture color (necessary when a mesh is padded on x and/or y axis)\n      color *= getTokenTextureClip();\n      \n      // Blend token texture, token ring and token background\n      result = blend(\n        processTokenColor(color * (vColor / vColor.a)),\n        blend(\n          colorizeTokenRing(texture(tokenRingTexture, vRingTextureCoord), dist),\n          colorizeTokenBackground(texture(tokenRingTexture, vBackgroundTextureCoord), dist)\n        ) * step(rectangularDist, 1.0)\n      ) * vColor.a;\n    }\n  ";static#us="\n    if ( debugColorBands ) {\n      vec2 scaledDistVec = (vTextureCoord - 0.5) * 2.0 * vScaleCorrection;\n      float dist = length(scaledDistVec);\n      result.rgb += vec3(0.0, 0.5, 0.0) * (step(vRingColorBand.x, dist) - step(vRingColorBand.y, dist));\n    }\n  ";static _batchVertexShader="\n    in vec2 aRingTextureCoord;\n    in vec2 aBackgroundTextureCoord;\n    in vec2 aScaleCorrection;\n    in vec2 aRingColorBand;\n    in vec4 aRingColor;\n    in vec4 aBackgroundColor;\n    in float aTextureScaleCorrection;\n    in float aStates;\n\n    out vec2 vRingTextureCoord;\n    out vec2 vBackgroundTextureCoord;\n    out vec2 vOrigTextureCoord;\n    flat out vec2 vRingColorBand;\n    flat out vec3 vRingColor;\n    flat out vec3 vBackgroundColor;\n    flat out vec2 vScaleCorrection;\n    flat out uint vStates;\n\n    void _main(out vec2 vertexPosition, out vec2 textureCoord, out vec4 color) {\n      vRingTextureCoord = aRingTextureCoord;\n      vBackgroundTextureCoord = aBackgroundTextureCoord;\n      vRingColor = aRingColor.rgb;\n      vBackgroundColor = aBackgroundColor.rgb;\n      vStates = uint(aStates);\n      vScaleCorrection = aScaleCorrection;\n      vRingColorBand = aRingColorBand;\n      vOrigTextureCoord = aTextureCoord;\n      vertexPosition = (translationMatrix * vec3(aVertexPosition, 1.0)).xy;\n      textureCoord = (aTextureCoord - 0.5) * aTextureScaleCorrection + 0.5;\n      color = aColor * tint;\n    }\n  ";static _batchFragmentShader=`\n    in vec2 vRingTextureCoord;\n    in vec2 vBackgroundTextureCoord;\n    in vec2 vOrigTextureCoord;\n    flat in vec3 vRingColor;\n    flat in vec3 vBackgroundColor;\n    flat in vec2 vScaleCorrection;\n    flat in vec2 vRingColorBand;\n    flat in uint vStates;\n\n    uniform sampler2D tokenRingTexture;\n    uniform float time;\n    uniform bool debugColorBands;\n\n    ${this.CONSTANTS}\n    ${this.PERCEIVED_BRIGHTNESS}\n    ${TokenRingSamplerShader.#cs}\n\n    vec4 _main() {\n      ${TokenRingSamplerShader.#ds}\n      ${TokenRingSamplerShader.#us}\n      return result;\n    }\n  `}class BewitchingWaveIlluminationShader extends AdaptiveIlluminationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBM(4,1)}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  // Transform UV\n  vec2 transform(in vec2 uv, in float dist) {\n    float t = time * 0.25;\n    mat2 rotmat = mat2(cos(t), -sin(t), sin(t), cos(t));\n    mat2 scalemat = mat2(2.5, 0.0, 0.0, 2.5);\n    uv -= vec2(0.5); \n    uv *= rotmat * scalemat;\n    uv += vec2(0.5);\n    return uv;\n  }\n\n  float bwave(in float dist) {\n    vec2 uv = transform(vUvs, dist);\n    float motion = fbm(uv + time * 0.25);\n    float distortion = mix(1.0, motion, clamp(1.0 - dist, 0.0, 1.0));\n    float sinWave = 0.5 * (sin(-time * 6.0 + dist * 10.0 * intensity * distortion) + 1.0);\n    return 0.3 * sinWave + 0.8;\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    ${this.TRANSITION}\n    finalColor *= bwave(dist);\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class BewitchingWaveColorationShader extends AdaptiveColorationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBM(4,1)}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  // Transform UV\n  vec2 transform(in vec2 uv, in float dist) {\n    float t = time * 0.25;\n    mat2 rotmat = mat2(cos(t), -sin(t), sin(t), cos(t));\n    mat2 scalemat = mat2(2.5, 0.0, 0.0, 2.5);\n    uv -= vec2(0.5); \n    uv *= rotmat * scalemat;\n    uv += vec2(0.5);\n    return uv;\n  }\n\n  float bwave(in float dist) {\n    vec2 uv = transform(vUvs, dist);\n    float motion = fbm(uv + time * 0.25);\n    float distortion = mix(1.0, motion, clamp(1.0 - dist, 0.0, 1.0));\n    float sinWave = 0.5 * (sin(-time * 6.0 + dist * 10.0 * intensity * distortion) + 1.0);\n    return 0.55 * sinWave + 0.8;\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    finalColor = color * bwave(dist) * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class BlackHoleDarknessShader extends AdaptiveDarknessShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBMHQ()}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  // create an emanation composed of n beams, n = intensity\n  vec3 beamsEmanation(in vec2 uv, in float dist, in vec3 pCol) {   \n    float angle = atan(uv.x, uv.y) * INVTWOPI;\n\n    // Create the beams\n    float dad = mix(0.33, 5.0, dist);\n    float beams = fract(angle + sin(dist * 30.0 * (intensity * 0.2) - time + fbm(uv * 10.0 + time * 0.25, 1.0) * dad));\n\n    // Compose the final beams and reverse beams, to get a nice gradient on EACH side of the beams.\n    beams = max(beams, 1.0 - beams);\n\n    // Creating the effect\n    return smoothstep(0.0, 1.1 + (intensity * 0.1), beams * pCol);\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    vec2 uvs = (2.0 * vUvs) - 1.0;\n    finalColor *= (mix(color, color * 0.66, darknessLevel) * colorationAlpha);\n    float rd = pow(1.0 - dist, 3.0);\n    finalColor = beamsEmanation(uvs, rd, finalColor);\n    ${this.FRAGMENT_END}\n  }`}class ChromaColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.HSB2RGB}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    finalColor = mix( color, \n                      hsb2rgb(vec3(time * 0.25, 1.0, 1.0)),\n                      intensity * 0.1 ) * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class EmanationColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  // Create an emanation composed of n beams, n = intensity\n  vec3 beamsEmanation(in vec2 uv, in float dist) {\n    float angle = atan(uv.x, uv.y) * INVTWOPI;\n\n    // create the beams\n    float beams = fract( angle * intensity + sin(dist * 10.0 - time));\n\n    // compose the final beams with max, to get a nice gradient on EACH side of the beams.\n    beams = max(beams, 1.0 - beams);\n\n    // creating the effect : applying color and color correction. saturate the entire output color.\n    return smoothstep( 0.0, 1.0, beams * color);\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    vec2 uvs = (2.0 * vUvs) - 1.0;\n    // apply beams emanation, fade and alpha\n    finalColor = beamsEmanation(uvs, dist) * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class EnergyFieldColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`    \n  ${this.SHADER_HEADER}\n  ${this.PRNG3D}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  // classic 3d voronoi (with some bug fixes)\n  vec3 voronoi3d(const in vec3 x) {\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    \n    float id = 0.0;\n    vec2 res = vec2(100.0);\n    \n    for (int k = -1; k <= 1; k++) {\n      for (int j = -1; j <= 1; j++) {\n        for (int i = -1; i <= 1; i++) {\n          vec3 b = vec3(float(i), float(j), float(k));\n          vec3 r = vec3(b) - f + random(p + b);\n          \n          float d = dot(r, r);\n          float cond = max(sign(res.x - d), 0.0);\n          float nCond = 1.0 - cond;\n          float cond2 = nCond * max(sign(res.y - d), 0.0);\n          float nCond2 = 1.0 - cond2;\n    \n          id = (dot(p + b, vec3(1.0, 67.0, 142.0)) * cond) + (id * nCond);\n          res = vec2(d, res.x) * cond + res * nCond;\n    \n          res.y = cond2 * d + nCond2 * res.y;\n        }\n      }\n    }\n    // replaced abs(id) by pow( abs(id + 10.0), 0.01)\n    // needed to remove artifacts in some specific configuration\n    return vec3( sqrt(res), pow( abs(id + 10.0), 0.01) );\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    vec2 uv = vUvs;\n    \n    // Hemispherize and scaling the uv\n    float f = (1.0 - sqrt(1.0 - dist)) / dist;\n    uv -= vec2(0.5);\n    uv *= f * 4.0 * intensity;\n    uv += vec2(0.5);\n    \n    // time and uv motion variables\n    float t = time * 0.4;\n    float uvx = cos(uv.x - t);\n    float uvy = cos(uv.y + t);\n    float uvxt = cos(uv.x + sin(t));\n    float uvyt = sin(uv.y + cos(t));\n    \n    // creating the voronoi 3D sphere, applying motion\n    vec3 c = voronoi3d(vec3(uv.x - uvx + uvyt, \n                            mix(uv.x, uv.y, 0.5) + uvxt - uvyt + uvx,\n                            uv.y + uvxt - uvx));\n    \n    // applying color and contrast, to create sharp black areas. \n    finalColor = c.x * c.x * c.x * color * colorationAlpha;\n\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class FairyLightColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.HSB2RGB}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBM(3,1)}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    \n    // Creating distortion with vUvs and fbm\n    float distortion1 = fbm(vec2( \n                        fbm(vUvs * 3.0 + time * 0.50), \n                        fbm((-vUvs + vec2(1.)) * 5.0 + time * INVTHREE)));\n    \n    float distortion2 = fbm(vec2(\n                        fbm(-vUvs * 3.0 + time * 0.50),\n                        fbm((-vUvs + vec2(1.)) * 5.0 - time * INVTHREE)));\n    vec2 uv = vUvs;\n      \n    // time related var\n    float t = time * 0.5;\n    float tcos = 0.5 * (0.5 * (cos(t)+1.0)) + 0.25;\n    float tsin = 0.5 * (0.5 * (sin(t)+1.0)) + 0.25;\n    \n    // Creating distortions with cos and sin : create fluidity\n    uv -= PIVOT;\n    uv *= tcos * distortion1;\n    uv *= tsin * distortion2;\n    uv *= fbm(vec2(time + distortion1, time + distortion2));\n    uv += PIVOT;\n\n    // Creating the rainbow\n    float intens = intensity * 0.1;\n    vec2 nuv = vUvs * 2.0 - 1.0;\n    vec2 puv = vec2(atan(nuv.x, nuv.y) * INVTWOPI + 0.5, length(nuv));\n    vec3 rainbow = hsb2rgb(vec3(puv.x + puv.y - time * 0.2, 1.0, 1.0));\n    vec3 mixedColor = mix(color, rainbow, smoothstep(0.0, 1.5 - intens, dist));\n\n    finalColor = distortion1 * distortion1 * \n                 distortion2 * distortion2 * \n                 mixedColor * colorationAlpha * (1.0 - dist * dist * dist) *\n                 mix( uv.x + distortion1 * 4.5 * (intensity * 0.4),\n                      uv.y + distortion2 * 4.5 * (intensity * 0.4), tcos);\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class FairyLightIlluminationShader extends AdaptiveIlluminationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBM(3,1)}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    \n    // Creating distortion with vUvs and fbm\n    float distortion1 = fbm(vec2( \n                        fbm(vUvs * 3.0 - time * 0.50), \n                        fbm((-vUvs + vec2(1.)) * 5.0 + time * INVTHREE)));\n    \n    float distortion2 = fbm(vec2(\n                        fbm(-vUvs * 3.0 - time * 0.50),\n                        fbm((-vUvs + vec2(1.)) * 5.0 - time * INVTHREE)));\n      \n    // linear interpolation motion\n    float motionWave = 0.5 * (0.5 * (cos(time * 0.5) + 1.0)) + 0.25;\n    ${this.TRANSITION}\n    finalColor *= mix(distortion1, distortion2, motionWave);\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class FlameIlluminationShader extends AdaptiveIlluminationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n  \n  void main() {\n    ${this.FRAGMENT_BEGIN}                          \n    ${this.TRANSITION}\n    finalColor *= brightnessPulse;\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`;static defaultUniforms={...super.defaultUniforms,brightnessPulse:1}}class FlameColorationShader extends AdaptiveColorationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBMHQ(3)}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  vec2 scale(in vec2 uv, in float scale) {\n    mat2 scalemat = mat2(scale, 0.0, 0.0, scale);\n    uv -= PIVOT; \n    uv *= scalemat;\n    uv += PIVOT;\n    return uv;\n  }\n  \n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    vec2 uv = scale(vUvs, 10.0 * ratio);\n    \n    float intens = pow(0.1 * intensity, 2.0);\n    float fratioInner = ratio * (intens * 0.5) - \n                   (0.005 * \n                        fbm( vec2( \n                             uv.x + time * 8.01, \n                             uv.y + time * 10.72), 1.0));\n    float fratioOuter = ratio - (0.007 * \n                        fbm( vec2( \n                             uv.x + time * 7.04, \n                             uv.y + time * 9.51), 2.0));\n                             \n    float fdist = max(dist - fratioInner * intens, 0.0);\n    \n    float flameDist = smoothstep(clamp(0.97 - fratioInner, 0.0, 1.0),\n                                 clamp(1.03 - fratioInner, 0.0, 1.0),\n                                 1.0 - fdist);\n    float flameDistInner = smoothstep(clamp(0.95 - fratioOuter, 0.0, 1.0),\n                                      clamp(1.05 - fratioOuter, 0.0, 1.0),\n                                      1.0 - fdist);\n                                 \n    vec3 flameColor = color * 8.0;\n    vec3 flameFlickerColor = color * 1.2;\n    \n    finalColor = mix(mix(color, flameFlickerColor, flameDistInner),\n                     flameColor, \n                     flameDist) * brightnessPulse * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }\n  `;static defaultUniforms={...super.defaultUniforms,brightnessPulse:1}}class FogColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBM(4,1)}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  vec3 fog() {\n    // constructing the palette\n    vec3 c1 = color * 0.60;\n    vec3 c2 = color * 0.95;\n    vec3 c3 = color * 0.50;\n    vec3 c4 = color * 0.75;\n    vec3 c5 = vec3(0.3);\n    vec3 c6 = color;\n    \n    // creating the deformation\n    vec2 uv = vUvs;\n    vec2 p = uv.xy * 8.0;\n\n    // time motion fbm and palette mixing\n    float q = fbm(p - time * 0.1);\n    vec2 r = vec2(fbm(p + q - time * 0.5 - p.x - p.y), \n                  fbm(p + q - time * 0.3));\n    vec3 c = clamp(mix(c1, \n                       c2, \n                       fbm(p + r)) + mix(c3, c4, r.x) \n                                   - mix(c5, c6, r.y),\n                                     vec3(0.0), vec3(1.0));\n    // returning the color\n    return c;\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    float intens = intensity * 0.2;\n    // applying fog\n    finalColor = fog() * intens * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class ForceGridColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  const float MAX_INTENSITY = 1.2;\n  const float MIN_INTENSITY = 0.8;\n\n  vec2 hspherize(in vec2 uv, in float dist) {\n    float f = (1.0 - sqrt(1.0 - dist)) / dist;\n    uv -= vec2(0.50);\n    uv *= f * 5.0;\n    uv += vec2(0.5);\n    return uv;\n  }\n\n  float wave(in float dist) {\n    float sinWave = 0.5 * (sin(time * 6.0 + pow(1.0 - dist, 0.10) * 35.0 * intensity) + 1.0);\n    return ((MAX_INTENSITY - MIN_INTENSITY) * sinWave) + MIN_INTENSITY;\n  }\n\n  float fpert(in float d, in float p) {\n    return max(0.3 - \n               mod(p + time + d * 0.3, 3.5),\n               0.0) * intensity * 2.0;\n  }\n\n  float pert(in vec2 uv, in float dist, in float d, in float w) {\n    uv -= vec2(0.5);\n    float f = fpert(d, min( uv.y,  uv.x)) +\n              fpert(d, min(-uv.y,  uv.x)) +\n              fpert(d, min(-uv.y, -uv.x)) +\n              fpert(d, min( uv.y, -uv.x));\n    f *= f;\n    return max(f, 3.0 - f) * w;\n  }\n\n  vec3 forcegrid(vec2 suv, in float dist) {\n    vec2 uv = suv - vec2(0.2075, 0.2075);\n    vec2 cid2 = floor(uv);\n    float cid = (cid2.y + cid2.x);\n    uv = fract(uv);\n    float r = 0.3;\n    float d = 1.0;\n    float e;\n    float c;\n\n    for( int i = 0; i < 5; i++ ) {\n      e = uv.x - r;\n      c = clamp(1.0 - abs(e * 0.75), 0.0, 1.0);\n      d += pow(c, 200.0) * (1.0 - dist);\n      if ( e > 0.0 ) {\n        uv.x = (uv.x - r) / (2.0 - r);\n      } \n      uv = uv.yx;\n    }\n\n    float w = wave(dist);\n    vec3 col = vec3(max(d - 1.0, 0.0)) * 1.8;\n    col *= pert(suv, dist * intensity * 4.0, d, w);\n    col += color * 0.30 * w;\n    return col * color;\n  }\n  \n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    vec2 uvs = vUvs;\n    uvs -= PIVOT;\n    uvs *= intensity * 0.2;\n    uvs += PIVOT;\n    vec2 suvs = hspherize(uvs, dist);\n    finalColor = forcegrid(suvs, dist) * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }\n  `}class GhostLightIlluminationShader extends AdaptiveIlluminationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBM(3,1)}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    \n    // Creating distortion with vUvs and fbm\n    float distortion1 = fbm(vec2( \n                        fbm(vUvs * 5.0 - time * 0.50), \n                        fbm((-vUvs - vec2(0.01)) * 5.0 + time * INVTHREE)));\n    \n    float distortion2 = fbm(vec2(\n                        fbm(-vUvs * 5.0 - time * 0.50),\n                        fbm((-vUvs + vec2(0.01)) * 5.0 + time * INVTHREE)));\n    vec2 uv = vUvs;\n      \n    // time related var\n    float t = time * 0.5;\n    float tcos = 0.5 * (0.5 * (cos(t)+1.0)) + 0.25;\n\n    ${this.TRANSITION}\n    finalColor *= mix( distortion1 * 1.5 * (intensity * 0.2),\n                       distortion2 * 1.5 * (intensity * 0.2), tcos);\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class GhostLightColorationShader extends AdaptiveColorationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBM(3,1)}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    \n    // Creating distortion with vUvs and fbm\n    float distortion1 = fbm(vec2( \n                        fbm(vUvs * 3.0 + time * 0.50), \n                        fbm((-vUvs + vec2(1.)) * 5.0 + time * INVTHREE)));\n    \n    float distortion2 = fbm(vec2(\n                        fbm(-vUvs * 3.0 + time * 0.50),\n                        fbm((-vUvs + vec2(1.)) * 5.0 - time * INVTHREE)));\n    vec2 uv = vUvs;\n      \n    // time related var\n    float t = time * 0.5;\n    float tcos = 0.5 * (0.5 * (cos(t)+1.0)) + 0.25;\n    float tsin = 0.5 * (0.5 * (sin(t)+1.0)) + 0.25;\n    \n    // Creating distortions with cos and sin : create fluidity\n    uv -= PIVOT;\n    uv *= tcos * distortion1;\n    uv *= tsin * distortion2;\n    uv *= fbm(vec2(time + distortion1, time + distortion2));\n    uv += PIVOT;\n\n    finalColor = distortion1 * distortion1 * \n                 distortion2 * distortion2 * \n                 color * pow(1.0 - dist, dist)\n                 * colorationAlpha * mix( uv.x + distortion1 * 4.5 * (intensity * 0.2),\n                                          uv.y + distortion2 * 4.5 * (intensity * 0.2), tcos);\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class HexaDomeColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  // rotate and scale uv\n  vec2 transform(in vec2 uv, in float dist) {\n    float hspherize = (1.0 - sqrt(1.0 - dist)) / dist;\n    float t = -time * 0.20;\n    float scale = 10.0 / (11.0 - intensity);\n    float cost = cos(t);\n    float sint = sin(t);\n\n    mat2 rotmat = mat2(cost, -sint, sint, cost);\n    mat2 scalemat = mat2(scale, 0.0, 0.0, scale);\n    uv -= PIVOT; \n    uv *= rotmat * scalemat * hspherize;\n    uv += PIVOT;\n    return uv;\n  }\n\n  // Adapted classic hexa algorithm\n  float hexDist(in vec2 uv) {\n    vec2 p = abs(uv);\n    float c = dot(p, normalize(vec2(1.0, 1.73)));\n    c = max(c, p.x);\n    return c;\n  }\n\n  vec4 hexUvs(in vec2 uv) {\n    const vec2 r = vec2(1.0, 1.73);\n    const vec2 h = r*0.5;\n    \n    vec2 a = mod(uv, r) - h;\n    vec2 b = mod(uv - h, r) - h;\n    vec2 gv = dot(a, a) < dot(b,b) ? a : b;\n    \n    float x = atan(gv.x, gv.y);\n    float y = 0.55 - hexDist(gv);\n    vec2 id = uv - gv;\n    return vec4(x, y, id.x, id.y);\n  }\n\n  vec3 hexa(in vec2 uv) {\n    float t = time;\n    vec2 uv1 = uv + vec2(0.0, sin(uv.y) * 0.25);\n    vec2 uv2 = 0.5 * uv1 + 0.5 * uv + vec2(0.55, 0);\n    float a = 0.2;\n    float c = 0.5;\n    float s = -1.0;\n    uv2 *= mat2(c, -s, s, c);\n\n    vec3 col = color;\n    float hexy = hexUvs(uv2 * 10.0).y;\n    float hexa = smoothstep( 3.0 * (cos(t)) + 4.5, 12.0, hexy * 20.0) * 3.0;\n\n    col *= mix(hexa, 1.0 - hexa, min(hexy, 1.0 - hexy));\n    col += color * fract(smoothstep(1.0, 2.0, hexy * 20.0)) * 0.65;\n    return col;\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n\n    // Rotate, magnify and hemispherize the uvs\n    vec2 uv = transform(vUvs, dist);\n    \n    // Hexaify the uv (hemisphere) and apply fade and alpha\n    finalColor = hexa(uv) * pow(1.0 - dist, 0.18) * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class LightDomeColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBM(2)}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  // Rotate and scale uv\n  vec2 transform(in vec2 uv, in float dist) {\n    float hspherize = (1.0 - sqrt(1.0 - dist)) / dist;\n    float t = time * 0.02;\n    mat2 rotmat = mat2(cos(t), -sin(t), sin(t), cos(t));\n    mat2 scalemat = mat2(8.0 * intensity, 0.0, 0.0, 8.0 * intensity);\n    uv -= PIVOT; \n    uv *= rotmat * scalemat * hspherize;\n    uv += PIVOT;\n    return uv;\n  }\n  \n  vec3 ripples(in vec2 uv) {\n    // creating the palette\n    vec3 c1 = color * 0.550;\n    vec3 c2 = color * 0.020;\n    vec3 c3 = color * 0.3;\n    vec3 c4 = color;\n    vec3 c5 = color * 0.025;\n    vec3 c6 = color * 0.200;\n\n    vec2 p = uv + vec2(5.0);\n    float q = 2.0 * fbm(p + time * 0.2);\n    vec2 r = vec2(fbm(p + q + ( time  ) - p.x - p.y), fbm(p * 2.0 + ( time )));\n    \n    return clamp( mix( c1, c2, abs(fbm(p + r)) ) + mix( c3, c4, abs(r.x * r.x * r.x) ) - mix( c5, c6, abs(r.y * r.y)), vec3(0.0), vec3(1.0));\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    \n    // to hemispherize, rotate and magnify\n    vec2 uv = transform(vUvs, dist);\n    finalColor = ripples(uv) * pow(1.0 - dist, 0.25) * colorationAlpha;\n\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class MagicalGloomDarknessShader extends AdaptiveDarknessShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBMHQ()}\n  \n  vec3 colorScale(in float t) {\n    return vec3(1.0 + 0.8 * t) * t;\n  }\n  \n  vec2 radialProjection(in vec2 uv, in float s, in float i) {\n    uv = vec2(0.5) - uv;\n    float px = 1.0 - fract(atan(uv.y, uv.x) / TWOPI + 0.25) + s;\n    float py = (length(uv) * (1.0 + i * 2.0) - i) * 2.0;\n    return vec2(px, py);\n  }\n  \n  float interference(in vec2 n) {\n    float noise1 = noise(n);\n    float noise2 = noise(n * 2.1) * 0.6;\n    float noise3 = noise(n * 5.4) * 0.42;\n    return noise1 + noise2 + noise3;\n  }\n  \n  float illuminate(in vec2 uv) {\n    float t = time;\n    \n    // Adjust x-coordinate based on time and y-value\n    float xOffset = uv.y < 0.5 \n                    ? 23.0 + t * 0.035 \n                    : -11.0 + t * 0.03;\n    uv.x += xOffset;\n    \n    // Shift y-coordinate to range [0, 0.5]\n    uv.y = abs(uv.y - 0.5);\n    \n    // Scale x-coordinate\n    uv.x *= (10.0 + 80.0 * intensity * 0.2);\n    \n    // Compute interferences\n    float q = interference(uv - t * 0.013) * 0.5;\n    vec2 r = vec2(interference(uv + q * 0.5 + t - uv.x - uv.y), interference(uv + q - t));\n    \n    // Compute final shade value\n    float sh = (r.y + r.y) * max(0.0, uv.y) + 0.1;\n    return sh * sh * sh;\n  }\n  \n  vec3 voidHalf(in float intensity) {\n    float minThreshold = 0.35;\n    \n    // Alter gradient\n    intensity = pow(intensity, 0.75);\n    \n    // Compute the gradient\n    vec3 color = colorScale(intensity);\n    \n    // Normalize the color by the sum of m2 and the color values\n    color /= (1.0 + max(vec3(0), color));\n    return color;\n  }\n    \n  vec3 voidRing(in vec2 uvs) {\n    vec2 uv = (uvs - 0.5) / (borderDistance * 1.06) + 0.5;\n    float r = 3.6;\n    float ff = 1.0 - uv.y;\n    vec2 uv2 = uv;\n    uv2.y = 1.0 - uv2.y;\n    \n    // Calculate color for upper half\n    vec3 colorUpper = voidHalf(illuminate(radialProjection(uv, 1.0, r))) * ff;\n    \n    // Calculate color for lower half\n    vec3 colorLower = voidHalf(illuminate(radialProjection(uv2, 1.9, r))) * (1.0 - ff);\n    \n    // Return upper and lower half combined\n    return colorUpper + colorLower;\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    float lumBase = perceivedBrightness(finalColor);\n    lumBase = mix(lumBase, lumBase * 0.33, darknessLevel);   \n    vec3 voidRingColor = voidRing(vUvs);\n    float lum = pow(perceivedBrightness(voidRingColor), 4.0);\n    vec3 voidRingFinal = vec3(perceivedBrightness(voidRingColor)) * color;\n    finalColor = voidRingFinal * lumBase * colorationAlpha;\n    ${this.FRAGMENT_END}\n  }`}class PulseIlluminationShader extends AdaptiveIlluminationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    float fading = pow(abs(1.0 - dist * dist), 1.01 - ratio);\n    ${this.TRANSITION}\n    finalColor *= fading;\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class PulseColorationShader extends AdaptiveColorationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  float pfade(in float dist, in float pulse) {\n      return 1.0 - smoothstep(pulse * 0.5, 1.0, dist);\n  }\n    \n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    finalColor = color * pfade(dist, pulse) * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`;static defaultUniforms={...super.defaultUniforms,pulse:0}}class RadialRainbowColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.HSB2RGB}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n\n    float intens = intensity * 0.1;\n    vec2 nuv = vUvs * 2.0 - 1.0;\n    vec2 puv = vec2(atan(nuv.x, nuv.y) * INVTWOPI + 0.5, length(nuv)); \n    vec3 rainbow = hsb2rgb(vec3(puv.y - time * 0.2, 1.0, 1.0));\n    finalColor = mix(color, rainbow, smoothstep(0.0, 1.5 - intens, dist))\n                  * (1.0 - dist * dist * dist);\n    \n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class RevolvingColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  uniform float gradientFade;\n  uniform float beamLength;\n  \n  ${this.PERCEIVED_BRIGHTNESS}\n  ${this.PIE}\n  ${this.ROTATION}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    vec2 ncoord = vUvs * 2.0 - 1.0;\n    float angularIntensity = mix(PI, PI * 0.5, intensity * 0.1);\n    ncoord *= rot(angle + time);\n    float angularCorrection = pie(ncoord, angularIntensity, gradientFade, beamLength);\n    finalColor = color * colorationAlpha * angularCorrection;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }\n  `;static defaultUniforms={...super.defaultUniforms,angle:0,gradientFade:.15,beamLength:1}}class RoilingDarknessShader extends AdaptiveDarknessShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBM(3)}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    // Creating distortion with vUvs and fbm\n    float distortion1 = fbm( vec2( \n                        fbm( vUvs * 2.5 + time * 0.5),\n                        fbm( (-vUvs - vec2(0.01)) * 5.0 + time * INVTHREE)));\n    \n    float distortion2 = fbm( vec2(\n                        fbm( -vUvs * 5.0 + time * 0.5),\n                        fbm( (vUvs + vec2(0.01)) * 2.5 + time * INVTHREE)));\n    \n    // Timed values\n    float t = -time * 0.5;\n    float cost = cos(t);\n    float sint = sin(t);\n    \n    // Rotation matrix\n    mat2 rotmat = mat2(cost, -sint, sint, cost);\n    vec2 uv = vUvs;\n\n    // Applying rotation before distorting\n    uv -= vec2(0.5);\n    uv *= rotmat;\n    uv += vec2(0.5);\n\n    // Amplify distortions\n    vec2 dstpivot = vec2( sin(min(distortion1 * 0.1, distortion2 * 0.1)),\n                          cos(min(distortion1 * 0.1, distortion2 * 0.1)) ) * INVTHREE\n                  - vec2( cos(max(distortion1 * 0.1, distortion2 * 0.1)),\n                          sin(max(distortion1 * 0.1, distortion2 * 0.1)) ) * INVTHREE ;\n    vec2 apivot = PIVOT - dstpivot;\n    uv -= apivot;\n    uv *= 1.13 + 1.33 * (cos(sqrt(max(distortion1, distortion2)) + 1.0) * 0.5);\n    uv += apivot;\n\n    // distorted distance\n    float ddist = clamp(distance(uv, PIVOT) * 2.0, 0.0, 1.0);\n\n    // R'lyeh Ftagnh !\n    float smooth = smoothstep(borderDistance, borderDistance * 1.2, ddist);\n    float inSmooth = min(smooth, 1.0 - smooth) * 2.0;\n    \n    // Creating the spooky membrane around the bright area\n    vec3 membraneColor = vec3(1.0 - inSmooth);\n   \n    finalColor *= (mix(color, color * 0.33, darknessLevel) * colorationAlpha);\n    finalColor = mix(finalColor, \n                     vec3(0.0), \n                     1.0 - smoothstep(0.25, 0.30 + (intensity * 0.2), ddist));    \n    finalColor *= membraneColor;\n    ${this.FRAGMENT_END}\n  }`}class SirenColorationShader extends AdaptiveColorationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  uniform float gradientFade;\n  uniform float beamLength;\n  \n  ${this.PERCEIVED_BRIGHTNESS}\n  ${this.PIE}\n  ${this.ROTATION}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    vec2 ncoord = vUvs * 2.0 - 1.0;\n    float angularIntensity = mix(PI, 0.0, intensity * 0.1);\n    ncoord *= rot(time * 50.0 + angle);\n    float angularCorrection = pie(ncoord, angularIntensity, clamp(gradientFade * dist, 0.05, 1.0), beamLength);\n    finalColor = color * brightnessPulse * colorationAlpha * angularCorrection;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }\n  `;static defaultUniforms={...super.defaultUniforms,ratio:0,brightnessPulse:1,angle:0,gradientFade:.15,beamLength:1}}class SirenIlluminationShader extends AdaptiveIlluminationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  uniform float gradientFade;\n  uniform float beamLength;\n  \n  ${this.PERCEIVED_BRIGHTNESS}\n  ${this.PIE}\n  ${this.ROTATION}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    ${this.TRANSITION}\n    vec2 ncoord = vUvs * 2.0 - 1.0;\n    float angularIntensity = mix(PI, 0.0, intensity * 0.1);\n    ncoord *= rot(time * 50.0 + angle);\n    float angularCorrection = mix(1.0, pie(ncoord, angularIntensity, clamp(gradientFade * dist, 0.05, 1.0), beamLength), 0.5);\n    finalColor *= angularCorrection;\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`;static defaultUniforms={...super.defaultUniforms,angle:0,gradientFade:.45,beamLength:1}}class SmokePatchColorationShader extends AdaptiveColorationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBMHQ(3)}\n  \n  vec2 transform(in vec2 uv, in float dist) {\n    float t = time * 0.1;\n    float cost = cos(t);\n    float sint = sin(t);\n\n    mat2 rotmat = mat2(cost, -sint, sint, cost);\n    mat2 scalemat = mat2(10.0, uv.x, uv.y, 10.0);\n    uv -= PIVOT;\n    uv *= (rotmat * scalemat);\n    uv += PIVOT;\n    return uv;\n  }\n\n  float smokefading(in float dist) {\n    float t = time * 0.4;\n    vec2 uv = transform(vUvs, dist);\n    return pow(1.0 - dist, \n      mix(fbm(uv, 1.0 + intensity * 0.4), \n        max(fbm(uv + t, 1.0),\n            fbm(uv - t, 1.0)), \n          pow(dist, intensity * 0.5)));\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    finalColor = color * smokefading(dist) * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }\n  `}class SmokePatchIlluminationShader extends AdaptiveIlluminationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBMHQ(3)}\n\n  vec2 transform(in vec2 uv, in float dist) {\n    float t = time * 0.1;\n    float cost = cos(t);\n    float sint = sin(t);\n\n    mat2 rotmat = mat2(cost, -sint, sint, cost);\n    mat2 scalemat = mat2(10.0, uv.x, uv.y, 10.0);\n    uv -= PIVOT;\n    uv *= (rotmat * scalemat);\n    uv += PIVOT;\n    return uv;\n  }\n  \n  float smokefading(in float dist) {\n    float t = time * 0.4;\n    vec2 uv = transform(vUvs, dist);\n    return pow(1.0 - dist,\n      mix(fbm(uv, 1.0 + intensity * 0.4),\n        max(fbm(uv + t, 1.0),\n            fbm(uv - t, 1.0)),\n        pow(dist, intensity * 0.5)));\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}                          \n    ${this.TRANSITION}\n    finalColor *= smokefading(dist);\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }\n  `}class StarLightColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBM(2,1)}\n\n  vec2 transform(in vec2 uv, in float dist) {\n    float t = time * 0.20;\n    float cost = cos(t);\n    float sint = sin(t);\n\n    mat2 rotmat = mat2(cost, -sint, sint, cost);\n    uv *= rotmat;\n    return uv;\n  }\n\n  float makerays(in vec2 uv, in float t) {\n    vec2 uvn = normalize(uv * (uv + t)) * (5.0 + intensity);\n    return max(clamp(0.5 * tan(fbm(uvn - t)), 0.0, 2.25),\n               clamp(3.0 - tan(fbm(uvn + t * 2.0)), 0.0, 2.25));\n  }\n\n  float starlight(in float dist) {\n    vec2 uv = (vUvs - 0.5);\n    uv = transform(uv, dist);\n    float rays = makerays(uv, time * 0.5);\n    return pow(1.0 - dist, rays) * pow(1.0 - dist, 0.25);\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    finalColor = clamp(color * starlight(dist) * colorationAlpha, 0.0, 1.0);\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }\n  `}class SunburstIlluminationShader extends AdaptiveIlluminationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  // Smooth back and forth between a and b\n  float cosTime(in float a, in float b) {\n    return (a - b) * ((cos(time) + 1.0) * 0.5) + b;\n  }\n\n  // Create the sunburst effect\n  vec3 sunBurst(in vec3 color, in vec2 uv, in float dist) {\n    // Pulse calibration\n    float intensityMod = 1.0 + (intensity * 0.05);\n    float lpulse = cosTime(1.3 * intensityMod, 0.85 * intensityMod);\n    \n    // Compute angle\n    float angle = atan(uv.x, uv.y) * INVTWOPI;\n    \n    // Creating the beams and the inner light\n    float beam = fract(angle * 16.0 + time);\n    float light = lpulse * pow(abs(1.0 - dist), 0.65);\n    \n    // Max agregation of the central light and the two gradient edges\n    float sunburst = max(light, max(beam, 1.0 - beam));\n        \n    // Creating the effect : applying color and color correction. ultra saturate the entire output color.\n    return color * pow(sunburst, 3.0);\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    vec2 uv = (2.0 * vUvs) - 1.0;\n    finalColor = switchColor(computedBrightColor, computedDimColor, dist);\n    ${this.ADJUSTMENTS}\n    finalColor = sunBurst(finalColor, uv, dist);\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class SunburstColorationShader extends AdaptiveColorationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  // Smooth back and forth between a and b\n  float cosTime(in float a, in float b) {\n    return (a - b) * ((cos(time) + 1.0) * 0.5) + b;\n  }\n\n  // Create a sun burst effect\n  vec3 sunBurst(in vec2 uv, in float dist) {\n    // pulse calibration\n    float intensityMod = 1.0 + (intensity * 0.05);\n    float lpulse = cosTime(1.1 * intensityMod, 0.85 * intensityMod);\n\n    // compute angle\n    float angle = atan(uv.x, uv.y) * INVTWOPI;\n    \n    // creating the beams and the inner light\n    float beam = fract(angle * 16.0 + time);\n    float light = lpulse * pow(abs(1.0 - dist), 0.65);\n    \n    // agregation of the central light and the two gradient edges to create the sunburst\n    float sunburst = max(light, max(beam, 1.0 - beam));\n        \n    // creating the effect : applying color and color correction. saturate the entire output color.\n    return color * pow(sunburst, 3.0);\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    vec2 uvs = (2.0 * vUvs) - 1.0;\n    finalColor = sunBurst(uvs, dist) * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class SwirlingRainbowColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.HSB2RGB}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n\n    float intens = intensity * 0.1;\n    vec2 nuv = vUvs * 2.0 - 1.0;\n    vec2 puv = vec2(atan(nuv.x, nuv.y) * INVTWOPI + 0.5, length(nuv));\n    vec3 rainbow = hsb2rgb(vec3(puv.x + puv.y - time * 0.2, 1.0, 1.0));\n    finalColor = mix(color, rainbow, smoothstep(0.0, 1.5 - intens, dist))\n                     * (1.0 - dist * dist * dist);\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class TorchIlluminationShader extends AdaptiveIlluminationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    ${this.TRANSITION}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class TorchColorationShader extends AdaptiveColorationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    finalColor = color * brightnessPulse * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }\n  `;static defaultUniforms={...super.defaultUniforms,ratio:0,brightnessPulse:1}}class VortexColorationShader extends AdaptiveColorationShader{static forceDefaultColor=!0;static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBM(4,1)}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  vec2 vortex(in vec2 uv, in float dist, in float radius, in mat2 rotmat) {\n    float intens = intensity * 0.2;\n    vec2 uvs = uv - PIVOT;\n    uv *= rotmat;\n\n    if ( dist < radius ) {\n      float sigma = (radius - dist) / radius;\n      float theta = sigma * sigma * TWOPI * intens;\n      float st = sin(theta);\n      float ct = cos(theta);\n      uvs = vec2(dot(uvs, vec2(ct, -st)), dot(uvs, vec2(st, ct)));\n    }\n    uvs += PIVOT;\n    return uvs;\n  }\n\n  vec3 spice(in vec2 iuv, in mat2 rotmat) {\n\n    // constructing the palette\n    vec3 c1 = color * 0.55;\n    vec3 c2 = color * 0.95;\n    vec3 c3 = color * 0.45;\n    vec3 c4 = color * 0.75;\n    vec3 c5 = vec3(0.20);\n    vec3 c6 = color * 1.2;\n\n    // creating the deformation\n    vec2 uv = iuv;\n    uv -= PIVOT;\n    uv *= rotmat;\n    vec2 p = uv.xy * 6.0;\n    uv += PIVOT;\n\n    // time motion fbm and palette mixing\n    float q = fbm(p + time);\n    vec2 r = vec2(fbm(p + q + time * 0.9 - p.x - p.y), \n                  fbm(p + q + time * 0.6));\n    vec3 c = mix(c1, \n                 c2, \n                 fbm(p + r)) + mix(c3, c4, r.x) \n                             - mix(c5, c6, r.y);\n    // returning the color\n    return c;\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    \n    // Timed values\n    float t = time * 0.5;\n    float cost = cos(t);\n    float sint = sin(t);\n\n    // Rotation matrix\n    mat2 vortexRotMat = mat2(cost, -sint, sint, cost);\n    mat2 spiceRotMat = mat2(cost * 2.0, -sint * 2.0, sint * 2.0, cost * 2.0);\n\n    // Creating vortex\n    vec2 vuv = vortex(vUvs, dist, 1.0, vortexRotMat);\n\n    // Applying spice\n    finalColor = spice(vuv, spiceRotMat) * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    \n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class VortexIlluminationShader extends AdaptiveIlluminationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PRNG}\n  ${this.NOISE}\n  ${this.FBM(4,1)}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  vec2 vortex(in vec2 uv, in float dist, in float radius, in float angle, in mat2 rotmat) {\n    vec2 uvs = uv - PIVOT;\n    uv *= rotmat;\n\n    if ( dist < radius ) {\n      float sigma = (radius - dist) / radius;\n      float theta = sigma * sigma * angle;\n      float st = sin(theta);\n      float ct = cos(theta);\n      uvs = vec2(dot(uvs, vec2(ct, -st)), dot(uvs, vec2(st, ct)));\n    }\n    uvs += PIVOT;\n    return uvs;\n  }\n\n  vec3 spice(in vec2 iuv, in mat2 rotmat) {\n    // constructing the palette\n    vec3 c1 = vec3(0.20);\n    vec3 c2 = vec3(0.80);\n    vec3 c3 = vec3(0.15);\n    vec3 c4 = vec3(0.85);\n    vec3 c5 = c3;\n    vec3 c6 = vec3(0.9);\n\n    // creating the deformation\n    vec2 uv = iuv;\n    uv -= PIVOT;\n    uv *= rotmat;\n    vec2 p = uv.xy * 6.0;\n    uv += PIVOT;\n\n    // time motion fbm and palette mixing\n    float q = fbm(p + time);\n    vec2 r = vec2(fbm(p + q + time * 0.9 - p.x - p.y), fbm(p + q + time * 0.6));\n\n    // Mix the final color\n    return mix(c1, c2, fbm(p + r)) + mix(c3, c4, r.x) - mix(c5, c6, r.y);\n  }\n\n  vec3 convertToDarknessColors(in vec3 col, in float dist) {\n    float intens = intensity * 0.20;\n    float lum = (col.r * 2.0 + col.g * 3.0 + col.b) * 0.5 * INVTHREE;\n    float colorMod = smoothstep(ratio * 0.99, ratio * 1.01, dist);\n    return mix(computedDimColor, computedBrightColor * colorMod, 1.0 - smoothstep( 0.80, 1.00, lum)) *\n                smoothstep( 0.25 * intens, 0.85 * intens, lum);\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    ${this.TRANSITION}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class WaveIlluminationShader extends AdaptiveIlluminationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  float wave(in float dist) {\n    float sinWave = 0.5 * (sin(-time * 6.0 + dist * 10.0 * intensity) + 1.0);\n    return 0.3 * sinWave + 0.8;\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    ${this.TRANSITION}\n    finalColor *= wave(dist);\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class WaveColorationShader extends AdaptiveColorationShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  float wave(in float dist) {\n    float sinWave = 0.5 * (sin(-time * 6.0 + dist * 10.0 * intensity) + 1.0);\n    return 0.55 * sinWave + 0.8;\n  }\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    finalColor = color * wave(dist) * colorationAlpha;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`}class AmplificationBackgroundVisionShader extends BackgroundVisionShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.PERCEIVED_BRIGHTNESS}\n\n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    float lum = perceivedBrightness(baseColor.rgb);\n    vec3 vision = vec3(smoothstep(0.0, 1.0, lum * 1.5)) * colorTint;\n    finalColor = vision + (vision * (lum + brightness) * 0.1) + (baseColor.rgb * (1.0 - computedDarknessLevel) * 0.125);\n    ${this.ADJUSTMENTS}\n    ${this.BACKGROUND_TECHNIQUES}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`;static defaultUniforms={...super.defaultUniforms,colorTint:[.38,.8,.38],brightness:.5};get isRequired(){return!0}}class WaveBackgroundVisionShader extends BackgroundVisionShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.WAVE()}\n  ${this.PERCEIVED_BRIGHTNESS}\n  \n  void main() {\n    ${this.FRAGMENT_BEGIN}    \n    // Normalize vUvs and compute base time\n    vec2 uvs = (2.0 * vUvs) - 1.0;\n    float t = time * -8.0;\n    \n    // Rotate uvs\n    float sinX = sin(t * 0.02);\n    float cosX = cos(t * 0.02);\n    mat2 rotationMatrix = mat2( cosX, -sinX, sinX, cosX);\n    vec2 ruv = ((vUvs - 0.5) * rotationMatrix) + 0.5;\n    \n    // Produce 4 arms smoothed to the edges\n    float angle = atan(ruv.x * 2.0 - 1.0, ruv.y * 2.0 - 1.0) * INVTWOPI;\n    float beam = fract(angle * 4.0);\n    beam = smoothstep(0.3, 1.0, max(beam, 1.0 - beam));\n    \n    // Construct final color\n    vec3 grey = vec3(perceivedBrightness(baseColor.rgb));\n    finalColor = mix(baseColor.rgb, grey * 0.5, sqrt(beam)) * mix(vec3(1.0), colorTint, 0.3);\n    ${this.ADJUSTMENTS}\n    ${this.BACKGROUND_TECHNIQUES}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`;static defaultUniforms={...super.defaultUniforms,colorTint:[.8,.1,.8]};get isRequired(){return!0}}class WaveColorationVisionShader extends ColorationVisionShader{static fragmentShader=`\n  ${this.SHADER_HEADER}\n  ${this.WAVE()}\n  ${this.PERCEIVED_BRIGHTNESS}\n    \n  void main() {\n    ${this.FRAGMENT_BEGIN}\n    // Normalize vUvs and compute base time\n    vec2 uvs = (2.0 * vUvs) - 1.0;\n    float t = time * -8.0;\n    \n    // Rotate uvs\n    float sinX = sin(t * 0.02);\n    float cosX = cos(t * 0.02);\n    mat2 rotationMatrix = mat2( cosX, -sinX, sinX, cosX);\n    vec2 ruv = ((vUvs - 0.5) * rotationMatrix) + 0.5;\n    \n    // Prepare distance from 4 corners\n    float dst[4];\n    dst[0] = distance(vec2(0.0), ruv);\n    dst[1] = distance(vec2(1.0), ruv);\n    dst[2] = distance(vec2(1.0,0.0), ruv);\n    dst[3] = distance(vec2(0.0,1.0), ruv);\n    \n    // Produce 4 arms smoothed to the edges\n    float angle = atan(ruv.x * 2.0 - 1.0, ruv.y * 2.0 - 1.0) * INVTWOPI;\n    float beam = fract(angle * 4.0);\n    beam = smoothstep(0.3, 1.0, max(beam, 1.0 - beam));\n    \n    // Computing the 4 corner waves\n    float multiWaves = 0.0;\n    for ( int i = 0; i <= 3 ; i++) {\n      multiWaves += smoothstep(0.6, 1.0, max(multiWaves, wcos(-10.0, 1.30 - dst[i], dst[i] * 120.0, t)));\n    }\n    // Computing the central wave\n    multiWaves += smoothstep(0.6, 1.0, max(multiWaves, wcos(-10.0, 1.35 - dist, dist * 120.0, -t)));\n        \n    // Construct final color\n    finalColor = vec3(mix(multiWaves, 0.0, sqrt(beam))) * colorEffect;\n    ${this.COLORATION_TECHNIQUES}\n    ${this.ADJUSTMENTS}\n    ${this.FALLOFF}\n    ${this.FRAGMENT_END}\n  }`;static defaultUniforms={...super.defaultUniforms,colorEffect:[.8,.1,.8]};get isRequired(){return!0}}Object.defineProperty(PIXI.Circle.prototype,"center",{get:function(){return new PIXI.Point(this.x,this.y)}}),PIXI.Circle.prototype.pointIsOn=function(e,t=1e-8){const i=Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2),n=Math.pow(this.radius,2);return i.almostEqual(n,t)},PIXI.Circle.prototype.segmentIntersections=function(e,t){return foundry.utils.lineCircleIntersection(e,t,this,this.radius).intersections},PIXI.Circle.prototype.pointAtAngle=function(e){return{x:this.x+this.radius*Math.cos(e),y:this.y+this.radius*Math.sin(e)}},PIXI.Circle.prototype.pointsBetween=function(e,t,i){const n=Math.atan2(e.y-this.y,e.x-this.x),s=Math.atan2(t.y-this.y,t.x-this.x);return this.pointsForArc(n,s,{includeEndpoints:!1,...i})},PIXI.Circle.prototype.pointsForArc=function(e,t,{density:i,includeEndpoints:n=!0}={}){const s=2*Math.PI;i??=this.constructor.approximateVertexDensity(this.radius);const o=[],r=s/i;n&&o.push(this.pointAtAngle(e));let a=t-e;for(;a<=0;)a+=s;const l=Math.round(a/r);for(let t=1;t<l;t++)o.push(this.pointAtAngle(e+t*r));return n&&o.push(this.pointAtAngle(t)),o},PIXI.Circle.prototype.toPolygon=function(e){const t=this.pointsForArc(0,0,e);return t.pop(),new PIXI.Polygon(t)},PIXI.Circle.approximateVertexDensity=function(e,t=1){return Math.ceil(Math.PI/Math.sqrt(t/e*2))},PIXI.Circle.prototype.intersectPolygon=function(e,{density:t,clipType:i,weilerAtherton:n=!0,...s}={}){if(!this.radius)return new PIXI.Polygon([]);if(i??=ClipperLib.ClipType.ctIntersection,n&&e.isPositive){const n=WeilerAthertonClipper.combine(e,this,{clipType:i,density:t,...s});return n.length?n[0]:new PIXI.Polygon([])}const o=this.toPolygon({density:t});return e.intersectPolygon(o,s)},PIXI.Circle.prototype.intersectClipper=function(e,{density:t,...i}={}){if(!this.radius)return[];return this.toPolygon({density:t}).intersectClipper(e,i)},PIXI.Graphics.prototype.drawPath=function(...e){let t,i=!1,n=e[0];return n.points?(i=n.closeStroke,t=n.points):t=Array.isArray(e[0])?e[0]:e,n=new PIXI.Polygon(t),n.closeStroke=i,this.drawShape(n)},PIXI.LegacyGraphics.prototype.drawPath=PIXI.Graphics.prototype.drawPath,PIXI.smooth.SmoothGraphics.prototype.drawPath=PIXI.Graphics.prototype.drawPath,PIXI.Graphics.prototype.drawSmoothedPolygon=function(...e){let t,i,n=!0,s=e[0];if(s.points)n=s.closeStroke,t=s.points,i=e[1];else if(Array.isArray(e[0]))t=e[0],i=e[1];else if("number"==typeof e[0])t=e,i=e.length%2?e.at(-1):0;else{const n=e.length-("object"!=typeof e.at(-1)?1:0);t=[];for(let i=0;i<n;i++)t.push(e[i].x,e[i].y);i=e.at(n)}if(i??=0,t.length<6||i<=0)return s=new PIXI.Polygon(t.slice(0,t.length-t.length%2)),s.closeStroke=n,this.drawShape(s);const o=[t[0],t[1]];for(let e=2;e<t.length-1;e+=2){const i=t[e],n=t[e+1];i===t[e-2]&&n===t[e-1]||o.push(i,n)}if(t=o,n&&t[0]===t.at(-2)&&t[1]===t.at(-1)&&(t.length-=2),t.length<6)return s=new PIXI.Polygon(t),s.closeStroke=n,this.drawShape(s);const getBezierControlPoints=(e,t,n,s,o,r)=>{const a=o-e,l=r-t,c=Math.hypot(n-e,s-t),d=Math.hypot(o-n,r-s),u=c+d,h=.5*i*(c/u),p=.5*i*(d/u);return[n-a*h,s-l*h,n+a*p,s+l*p]};let[r,a,l,c]=t,[d,u,h,p]=getBezierControlPoints(t.at(-2),t.at(-1),r,a,l,c);this.moveTo(r,a);for(let e=2,i=t.length+(n?2:0);e<i;e+=2){const i=t[(e+2)%t.length],s=t[(e+3)%t.length];let o,g;d=h,u=p,[o,g,h,p]=getBezierControlPoints(r,a,l,c,i,s),n||2!==e?n||e!==t.length-2?this.bezierCurveTo(d,u,o,g,l,c):this.quadraticCurveTo(d,u,l,c):this.quadraticCurveTo(o,g,l,c),r=l,a=c,l=i,c=s}return n&&this.closePath(),this.finishPoly(),this},PIXI.LegacyGraphics.prototype.drawSmoothedPolygon=PIXI.Graphics.prototype.drawSmoothedPolygon,PIXI.smooth.SmoothGraphics.prototype.drawSmoothedPolygon=PIXI.Graphics.prototype.drawSmoothedPolygon,PIXI.Graphics.prototype.drawSmoothedPath=function(...e){let t,i,n=!1,s=e[0];if(s.points)n=s.closeStroke,t=s.points,i=e[1];else if(Array.isArray(e[0]))t=e[0],i=e[1];else if("number"==typeof e[0])t=e,i=e.length%2?e.at(-1):0;else{const n=e.length-("object"!=typeof e.at(-1)?1:0);t=[];for(let i=0;i<n;i++)t.push(e[i].x,e[i].y);i=e.at(n)}return s=new PIXI.Polygon(t),s.closeStroke=n,this.drawSmoothedPolygon(s,i)},PIXI.LegacyGraphics.prototype.drawSmoothedPath=PIXI.Graphics.prototype.drawSmoothedPath,PIXI.smooth.SmoothGraphics.prototype.drawSmoothedPath=PIXI.Graphics.prototype.drawSmoothedPath;PIXI.Transform;Object.defineProperties(PIXI.Polygon.prototype,{isPositive:{get:function(){return void 0!==this._isPositive?this._isPositive:this.points.length<6?void 0:this._isPositive=this.signedArea()>0}},_isPositive:{value:void 0,writable:!0,enumerable:!1}}),PIXI.Polygon.prototype.clearCache=function(){this._isPositive=void 0},PIXI.Polygon.prototype.signedArea=function(){const e=this.points,t=e.length;if(t<6)return 0;let i=0,n=e[t-2],s=e[t-1];for(let o=0;o<t;o+=2){const t=e[o],r=e[o+1];i+=(t-n)*(r+s),n=t,s=r}return-.5*i},PIXI.Polygon.prototype.reverseOrientation=function(){const e=[],t=this.points;for(let i=t.length-2;i>=0;i-=2)e.push(t[i],t[i+1]);return this.points=e,void 0!==this._isPositive&&(this._isPositive=!this._isPositive),this},PIXI.Polygon.prototype.addPoint=function({x:e,y:t}={}){const i=this.points.length;return e===this.points[i-2]&&t===this.points[i-1]||(this.points.push(e,t),this.clearCache()),this},PIXI.Polygon.prototype.getBounds=function(){if(this.points.length<2)return new PIXI.Rectangle(0,0,0,0);let e,t,i=e=this.points[0],n=t=this.points[1];for(let s=3;s<this.points.length;s+=2){const o=this.points[s-1],r=this.points[s];o<i?i=o:o>e&&(e=o),r<n?n=r:r>t&&(t=r)}return new PIXI.Rectangle(i,n,e-i,t-n)},PIXI.Polygon.fromClipperPoints=function(e,{scalingFactor:t=1}={}){const i=[];for(const n of e)i.push(n.X/t,n.Y/t);return new PIXI.Polygon(i)},PIXI.Polygon.prototype.toClipperPoints=function({scalingFactor:e=1}={}){const t=[];for(let i=1;i<this.points.length;i+=2)t.push({X:Math.round(this.points[i-1]*e),Y:Math.round(this.points[i]*e)});return t},Object.defineProperty(PIXI.Polygon.prototype,"isClosed",{get:function(){const e=this.points.length;return!(e<4)&&(this.points[0]===this.points[e-2]&&this.points[1]===this.points[e-1])},enumerable:!1}),PIXI.Polygon.prototype.intersectPolygon=function(e,{clipType:t,scalingFactor:i}={}){const n=e.toClipperPoints({scalingFactor:i}),s=this.intersectClipper(n,{clipType:t,scalingFactor:i});return PIXI.Polygon.fromClipperPoints(s.length?s[0]:[],{scalingFactor:i})},PIXI.Polygon.prototype.intersectClipper=function(e,{clipType:t,scalingFactor:i}={}){t??=ClipperLib.ClipType.ctIntersection;const n=new ClipperLib.Clipper;n.AddPath(this.toClipperPoints({scalingFactor:i}),ClipperLib.PolyType.ptSubject,!0),n.AddPath(e,ClipperLib.PolyType.ptClip,!0);const s=new ClipperLib.Paths;return n.Execute(t,s),s},PIXI.Polygon.prototype.intersectCircle=function(e,t){return e.intersectPolygon(this,t)},PIXI.Polygon.prototype.intersectRectangle=function(e,t){return e.intersectPolygon(this,t)},PIXI.Rectangle.CS_ZONES={INSIDE:0,LEFT:1,RIGHT:16,TOP:4096,BOTTOM:256,TOPLEFT:4097,TOPRIGHT:4112,BOTTOMRIGHT:272,BOTTOMLEFT:257},Object.defineProperty(PIXI.Rectangle.prototype,"center",{get:function(){return{x:this.x+.5*this.width,y:this.y+.5*this.height}}}),PIXI.Rectangle.prototype.getBounds=function(){let{x:e,y:t,width:i,height:n}=this;return e=i>0?e:e+i,t=n>0?t:t+n,new PIXI.Rectangle(e,t,Math.abs(i),Math.abs(n))},PIXI.Rectangle.prototype.pointIsOn=function(e){const t=PIXI.Rectangle.CS_ZONES;return this._getZone(e)===t.INSIDE&&this._getEdgeZone(e)!==t.INSIDE},PIXI.Rectangle.prototype._getEdgeZone=function(e){const t=PIXI.Rectangle.CS_ZONES;let i=t.INSIDE;return e.x<this.x||e.x.almostEqual(this.x)?i|=t.LEFT:(e.x>this.right||e.x.almostEqual(this.right))&&(i|=t.RIGHT),e.y<this.y||e.y.almostEqual(this.y)?i|=t.TOP:(e.y>this.bottom||e.y.almostEqual(this.bottom))&&(i|=t.BOTTOM),i},PIXI.Rectangle.prototype.pointsBetween=function(e,t){const i=PIXI.Rectangle.CS_ZONES,n=this._getEdgeZone(e);if(!n)return[];const s=this._getEdgeZone(t);if(!s)return[];if(n===s&&foundry.utils.orient2dFast(this.center,e,t)<=0)return[];let o=n;const r=[];for(let e=0;e<4&&(o&i.LEFT?(o!==i.TOPLEFT&&r.push({x:this.left,y:this.top}),o=i.TOP):o&i.TOP?(o!==i.TOPRIGHT&&r.push({x:this.right,y:this.top}),o=i.RIGHT):o&i.RIGHT?(o!==i.BOTTOMRIGHT&&r.push({x:this.right,y:this.bottom}),o=i.BOTTOM):o&i.BOTTOM&&(o!==i.BOTTOMLEFT&&r.push({x:this.left,y:this.bottom}),o=i.LEFT),!(o&s));e+=1);return r},PIXI.Rectangle.prototype.segmentIntersections=function(e,t){if(e.x.almostEqual(t.x)&&(e.x.almostEqual(this.left)||e.x.almostEqual(this.right))){const i=Math.min(e.y,t.y),n=Math.min(this.top,this.bottom),s=Math.max(e.y,t.y),o=Math.max(this.top,this.bottom),r=Math.max(i,n),a=Math.min(s,o),l=r.almostEqual(a);if(l||r<a){const i=Math.abs(t.y-e.y),n=this.height,s=t.y-e.y>0?e.y:t.y,o=e.x.almostEqual(this.right)?this.top:this.bottom,c={x:e.x,y:r,t0:(r-s)/i,t1:Math.abs((r-o)/n)};if(l)return[c];const d={x:e.x,y:a,t0:(a-s)/i,t1:Math.abs((a-o)/n)};return Math.abs(r-e.y)<Math.abs(a-e.y)?[c,d]:[d,c]}}else if(e.y.almostEqual(t.y)&&(e.y.almostEqual(this.top)||e.y.almostEqual(this.bottom))){const i=Math.min(e.x,t.x),n=Math.min(this.right,this.left),s=Math.max(e.x,t.x),o=Math.max(this.right,this.left),r=Math.max(i,n),a=Math.min(s,o),l=r.almostEqual(a);if(l||r<a){const i=Math.abs(t.x-e.x),n=this.width,s=t.x-e.x>0?e.x:t.x,o=e.y.almostEqual(this.top)?this.left:this.right,c={x:r,y:e.y,t0:(r-s)/i,t1:Math.abs((r-o)/n)};if(l)return[c];const d={x:a,y:e.y,t0:(a-s)/i,t1:Math.abs((a-o)/n)};return Math.abs(r-e.x)<Math.abs(a-e.x)?[c,d]:[d,c]}}const i=this._getZone(e),n=this._getZone(t);if(!(i|n))return[];const s=i&&n?[i,n]:[i||n];if(2===s.length&&!this.lineSegmentIntersects(e,t))return[];const o=PIXI.Rectangle.CS_ZONES,r=foundry.utils.lineSegmentIntersects,a=foundry.utils.lineLineIntersection,{leftEdge:l,rightEdge:c,bottomEdge:d,topEdge:u}=this,h=[];for(const i of s){let n;if(i&o.LEFT&&r(l.A,l.B,e,t)&&(n=a(e,t,l.A,l.B)),!n&&i&o.RIGHT&&r(c.A,c.B,e,t)&&(n=a(e,t,c.A,c.B)),!n&&i&o.TOP&&r(u.A,u.B,e,t)&&(n=a(e,t,u.A,u.B)),!n&&i&o.BOTTOM&&r(d.A,d.B,e,t)&&(n=a(e,t,d.A,d.B)),!n)throw new Error("PIXI.Rectangle.prototype.segmentIntersections returned an unexpected null point.");h.push(n)}return h},PIXI.Rectangle.prototype.intersection=function(e){const t=this.x<e.x?e.x:this.x,i=this.right>e.right?e.right:this.right,n=this.y<e.y?e.y:this.y,s=this.bottom>e.bottom?e.bottom:this.bottom;return new PIXI.Rectangle(t,n,i-t,s-n)},PIXI.Rectangle.prototype.toPolygon=function(){const e=[this.left,this.top,this.right,this.top,this.right,this.bottom,this.left,this.bottom];return new PIXI.Polygon(e)},Object.defineProperty(PIXI.Rectangle.prototype,"leftEdge",{get:function(){return{A:{x:this.left,y:this.bottom},B:{x:this.left,y:this.top}}}}),Object.defineProperty(PIXI.Rectangle.prototype,"rightEdge",{get:function(){return{A:{x:this.right,y:this.top},B:{x:this.right,y:this.bottom}}}}),Object.defineProperty(PIXI.Rectangle.prototype,"topEdge",{get:function(){return{A:{x:this.left,y:this.top},B:{x:this.right,y:this.top}}}}),Object.defineProperty(PIXI.Rectangle.prototype,"bottomEdge",{get:function(){return{A:{x:this.right,y:this.bottom},B:{x:this.left,y:this.bottom}}}}),PIXI.Rectangle.prototype._getZone=function(e){const t=PIXI.Rectangle.CS_ZONES;let i=t.INSIDE;return e.x<this.x?i|=t.LEFT:e.x>this.right&&(i|=t.RIGHT),e.y<this.y?i|=t.TOP:e.y>this.bottom&&(i|=t.BOTTOM),i},PIXI.Rectangle.prototype.lineSegmentIntersects=function(e,t,{inside:i=!1}={}){const n=this._getZone(e),s=this._getZone(t);if(!(n|s))return i;if(n&s)return!1;if(!n||!s)return!0;const o=PIXI.Rectangle.CS_ZONES,r=foundry.utils.lineSegmentIntersects,a=this.leftEdge;if(n&o.LEFT&&r(a.A,a.B,e,t))return!0;const l=this.rightEdge;if(n&o.RIGHT&&r(l.A,l.B,e,t))return!0;const c=this.topEdge;if(n&o.TOP&&r(c.A,c.B,e,t))return!0;const d=this.bottomEdge;return!!(n&o.BOTTOM&&r(d.A,d.B,e,t))},PIXI.Rectangle.prototype.intersectPolygon=function(e,{clipType:t,scalingFactor:i,canMutate:n,weilerAtherton:s=!0}={}){if(!this.width||!this.height)return new PIXI.Polygon([]);if(t??=ClipperLib.ClipType.ctIntersection,s&&e.isPositive){const s=WeilerAthertonClipper.combine(e,this,{clipType:t,canMutate:n,scalingFactor:i});return s.length?s[0]:new PIXI.Polygon([])}return e.intersectPolygon(this.toPolygon(),{clipType:t,canMutate:n,scalingFactor:i})},PIXI.Rectangle.prototype.intersectClipper=function(e,{clipType:t,scalingFactor:i}={}){return this.width&&this.height?this.toPolygon().intersectPolygon(e,{clipType:t,scalingFactor:i}):[]},PIXI.Rectangle.prototype.overlaps=function(e){return e.right>=this.left&&e.left<=this.right&&e.bottom>=this.top&&e.top<=this.bottom},PIXI.Rectangle.prototype.normalize=function(){return this.width<0&&(this.x+=this.width,this.width=Math.abs(this.width)),this.height<0&&(this.y+=this.height,this.height=Math.abs(this.height)),this},PIXI.Rectangle.prototype.rotate=function(e,t){return 0===e?this:this.constructor.fromRotation(this.x,this.y,this.width,this.height,e,t,this)},PIXI.Rectangle.fromRotation=function(e,t,i,n,s,o,r){const a=Math.cos(s),l=Math.sin(s);if(r??=new PIXI.Rectangle,void 0===o||.5===o.x&&.5===o.y)return r.height=n*Math.abs(a)+i*Math.abs(l),r.width=n*Math.abs(l)+i*Math.abs(a),r.x=e+(i-r.width)/2,r.y=t+(n-r.height)/2,r;const c=e+i*o.x,d=t+n*o.y,u=e-c,h=t-d,p=e+i-c,g=t-d,m=e-c,v=t+n-d,y=e+i-c,b=t+n-d,S=a*u-l*h,T=l*u+a*h,E=a*p-l*g,C=l*p+a*g,_=a*m-l*v,I=l*m+a*v,w=a*y-l*b,D=l*y+a*b,O=Math.min(S,E,_,w),x=Math.min(T,C,I,D),N=Math.max(S,E,_,w),A=Math.max(T,C,I,D);return r.x=c+O,r.y=d+x,r.width=N-O,r.height=A-x,r};class EffectsCanvasGroup extends(CanvasGroupMixin(PIXI.Container)){static#hs="lighting.animateDarkness";animateLightSources=!0;animateVisionSources=!0;lightSources=new foundry.utils.Collection;darknessSources=new foundry.utils.Collection;visionSources=new foundry.utils.Collection;visualEffectsMaskingFilters=new Set;*allSources(){for(const e of this.darknessSources)yield e;for(const e of this.lightSources)yield e}_createLayers(){return this.background=this.addChild(new CanvasBackgroundAlterationEffects),this.illumination=this.addChild(new CanvasIlluminationEffects),this.coloration=this.addChild(new CanvasColorationEffects),this.darkness=this.addChild(new CanvasDarknessEffects),{background:this.background,illumination:this.illumination,coloration:this.coloration,darkness:this.darkness}}clearEffects(){this.background.clear(),this.illumination.clear(),this.coloration.clear(),this.darkness.clear()}async _draw(e){await this.background.draw(),await this.illumination.draw(),await this.coloration.draw(),await this.darkness.draw(),Hooks$1.callAll("drawEffectsCanvasGroup",this),this.activateAnimation()}initializeLightSources(){for(let e of this.lightSources)e.initialize();Hooks$1.callAll("initializeLightSources",this)}initializeDarknessSources(){for(let e of this.darknessSources)e.initialize();Hooks$1.callAll("initializeDarknessSources",this)}refreshLightSources(){for(const e of this.allSources())e.refresh();canvas.lighting.refreshFields()}refreshVisionSources(){for(const e of this.visionSources)e.refresh()}refreshLighting(){this.illumination.backgroundColor=canvas.colors.background,this.illumination.darknessLevelMeshes.clearColor[0]!==canvas.environment.darknessLevel&&(this.illumination.darknessLevelMeshes.clearColor[0]=canvas.environment.darknessLevel,this.illumination.invalidateDarknessLevelContainer(!0));const e=canvas.visibility.filter;e&&(e.uniforms.visionTexture=canvas.masks.vision.renderTexture,e.uniforms.primaryTexture=canvas.primary.renderTexture,canvas.colors.fogExplored.applyRGB(e.uniforms.exploredColor),canvas.colors.fogUnexplored.applyRGB(e.uniforms.unexploredColor),canvas.colors.background.applyRGB(e.uniforms.backgroundColor)),canvas.effects.clearEffects();for(const e of this.allSources())this.#ps(e);for(const e of this.visionSources)this.#gs(e);this.background.vision.filter.enabled=!!this.background.vision.children.length,this.background.visionPreferred.filter.enabled=!!this.background.visionPreferred.children.length;const t=canvas.visibility.visionModeData.activeLightingOptions;this.background.vision.visible=this.background.vision.children.length>0,this.background.visionPreferred.visible=this.background.visionPreferred.children.length>0,this.background.lighting.visible=this.background.lighting.children.length>0||t.background?.postProcessingModes?.length>0,this.coloration.visible=this.coloration.children.length>1||t.coloration?.postProcessingModes?.length>0,Hooks$1.callAll("lightingRefresh",this)}#gs(e){if(!e.active||e.radius<=0)return;const t=e.drawMeshes();if(t.background){(e.preferred?this.background.visionPreferred:this.background.vision).addChild(t.background)}t.illumination&&this.illumination.lights.addChild(t.illumination),t.coloration&&this.coloration.addChild(t.coloration)}#ps(e){if(!e.active)return;const t=e.drawMeshes();t.background&&this.background.lighting.addChild(t.background),t.illumination&&this.illumination.lights.addChild(t.illumination),t.coloration&&this.coloration.addChild(t.coloration),t.darkness&&this.darkness.addChild(t.darkness)}testInsideLight(e,t){for(const t of this.lightSources)if(t.active&&!(t instanceof foundry.canvas.sources.GlobalLightSource)&&t.shape.contains(e.x,e.y))return!0;const i=canvas.environment.globalLightSource;if(!i.active)return!1;const{min:n,max:s}=i.data.darkness,o=this.getDarknessLevel(e,t);return o>=n&&o<=s}testInsideDarkness({x:e,y:t},i){for(const i of this.darknessSources)if(i.active&&!i.isPreview)for(let n=-1;n<=1;n+=1)for(let s=-1;s<=1;s+=1)if(i.shape.contains(e+n,t+s))return!0;return!1}getDarknessLevel(e,t){const i=canvas.effects.illumination.darknessLevelMeshes.children;for(let n=i.length-1;n>=0;n--){const s=i[n];if(s.region.testPoint(e,t))return s.shader.uniforms.darknessLevel}return canvas.environment.darknessLevel}async _tearDown(e){CanvasAnimation.terminateAnimation(EffectsCanvasGroup.#hs),this.deactivateAnimation(),this.darknessSources.clear(),this.lightSources.clear();for(const e of this.children)e.clear?e.clear():e.tearDown?await e.tearDown():e.destroy();this.visualEffectsMaskingFilters.clear()}toggleMaskingFilters(e=!0){for(const t of this.visualEffectsMaskingFilters)t.uniforms.enableVisionMasking=e}activatePostProcessingFilters(e,t=[],i={}){for(const n of this.visualEffectsMaskingFilters)n.uniforms.mode===e&&n.updatePostprocessModes(t,i)}resetPostProcessingFilters(){for(const e of this.visualEffectsMaskingFilters)e.reset()}activateAnimation(){this.deactivateAnimation(),!1!==c.settings.get("core","lightAnimation")&&canvas.app.ticker.add(this.#ms,this)}deactivateAnimation(){canvas.app.ticker.remove(this.#ms,this)}#ms(e){if(this.animateLightSources)for(const t of this.allSources())t.animate(e);if(this.animateVisionSources)for(const t of this.visionSources.values())t.animate(e)}async animateDarkness(e=1,{duration:t=1e4}={}){if(CanvasAnimation.terminateAnimation(EffectsCanvasGroup.#hs),e===canvas.environment.darknessLevel)return!1;if(t<=0)return canvas.environment.initialize({environment:{darknessLevel:e}});const i=[{parent:{darkness:canvas.environment.darknessLevel},attribute:"darkness",to:Math.clamp(e,0,1)}];return CanvasAnimation.animate(i,{name:EffectsCanvasGroup.#hs,duration:t,ontick:(e,t)=>canvas.environment.initialize({environment:{darknessLevel:t.attributes[0].parent.darkness}})}).then((t=>{t||canvas.environment.initialize({environment:{darknessLevel:e}})}))}get visibility(){return foundry.utils.logCompatibilityWarning("EffectsCanvasGroup#visibility has been deprecated and moved to Canvas#visibility.",{since:12,until:14}),canvas.visibility}get globalLightSource(){return foundry.utils.logCompatibilityWarning("EffectsCanvasGroup#globalLightSource has been deprecated and moved to EnvironmentCanvasGroup#globalLightSource.",{since:12,until:14}),canvas.environment.globalLightSource}updateGlobalLightSource(){foundry.utils.logCompatibilityWarning("EffectsCanvasGroup#updateGlobalLightSource has been deprecated and is part of EnvironmentCanvasGroup#initialize workflow.",{since:12,until:14}),canvas.environment.initialize()}}class EnvironmentCanvasGroup extends(CanvasGroupMixin(PIXI.Container)){constructor(...e){super(...e),this.eventMode="static",Object.defineProperty(this,"globalLightSource",{value:new g.Canvas.globalLightSourceClass({object:this,sourceId:"globalLight"}),configurable:!1,enumerable:!0,writable:!1})}static groupName="environment";static tearDownChildren=!1;#fs;colors={darkness:void 0,halfdark:void 0,background:void 0,dim:void 0,bright:void 0,ambientBrightest:void 0,ambientDaylight:void 0,ambientDarkness:void 0,sceneBackground:void 0,fogExplored:void 0,fogUnexplored:void 0};weights={dark:void 0,halfdark:void 0,dim:void 0,bright:void 0};static#vs={darknessColor:2368584,daylightColor:15658734,brightestColor:16777215,backgroundColor:10066329,fogUnexplored:0,fogExplored:0};#ys;get darknessLevel(){return this.#fs}async _draw(e){await super._draw(e),this.#ys=new PIXI.EventBoundary(this),this.initialize()}initialize({backgroundColor:e,brightestColor:t,darknessColor:i,daylightColor:n,fogExploredColor:s,fogUnexploredColor:o,darknessLevel:r,environment:a={}}={}){const l=canvas.scene,c=EnvironmentCanvasGroup.#vs;if(this.colors.ambientDarkness=Color.from(i??g.Canvas.darknessColor??c.darknessColor),this.colors.ambientDaylight=Color.from(n??(l.tokenVision?g.Canvas.daylightColor??c.daylightColor:16777215)),this.colors.ambientBrightest=Color.from(t??g.Canvas.brightestColor??c.brightestColor),void 0!==r){const e="config.darknessLevel parameter into EnvironmentCanvasGroup#initialize is deprecated. You should pass the darkness level into config.environment.darknessLevel";foundry.utils.logCompatibilityWarning(e,{since:12,until:14,once:!0}),a.darknessLevel=r}const d=this.#fs??0,u=a.darknessLevel??l.environment.darknessLevel,h=u!==this.#fs;if(this.#fs=l.environment.darknessLevel=u,Object.assign(this.weights,g.Canvas.lightLevels??{dark:0,halfdark:.5,dim:.25,bright:1}),this.#bs({fogExploredColor:s,fogUnexploredColor:o,backgroundColor:e}),this.#Ss(a),canvas.app.renderer.background.color=this.colors.rendererBackground,canvas.primary._backgroundColor=this.colors.sceneBackground.rgb,h){const e=new PIXI.FederatedEvent(this.#ys);e.type="darknessChange",e.environmentData={darknessLevel:this.#fs,priorDarknessLevel:d},this.dispatchEvent(e)}canvas.perception.update({refreshPrimary:!0,refreshLighting:!0,refreshVision:!0})}#bs({fogExploredColor:e,fogUnexploredColor:t,backgroundColor:i}={}){const n=canvas.scene,s=EnvironmentCanvasGroup.#vs;this.colors.background=this.colors.ambientDarkness.mix(this.colors.ambientDaylight,1-this.darknessLevel),this.colors.darkness=this.colors.ambientDarkness.mix(this.colors.background,this.weights.dark),this.colors.halfdark=this.colors.darkness.mix(this.colors.background,this.weights.halfdark),this.colors.bright=this.colors.background.mix(this.colors.ambientBrightest,this.weights.bright),this.colors.dim=this.colors.background.mix(this.colors.bright,this.weights.dim);const o=g.Canvas,r=Color.from(t??n.fog.colors.unexplored??o.unexploredColor??s.fogUnexplored);this.colors.fogUnexplored=this.colors.background.multiply(r);const a=Color.from(e??n.fog.colors.explored??o.exploredColor??s.fogExplored);this.colors.fogExplored=this.colors.background.multiply(a);const l=Color.from(i??n?.backgroundColor??s.backgroundColor);this.colors.sceneBackground=l,this.colors.rendererBackground=l.multiply(this.colors.background)}#Ss(e={}){const t=canvas.scene.toObject().environment,i=foundry.utils.mergeObject(e,t,{inplace:!1,insertKeys:!0,insertValues:!0,overwrite:!1});this.#Ts(i),this.#Es(i)}#Ts({cycle:e,base:t,dark:i}){const n=canvas.primary._ambienceFilter;if(!n)return;const s=n.uniforms,o=Color.fromHSL([t.hue,1,.5]).linear;Color.applyRGB(o,s.baseTint),s.baseLuminosity=t.luminosity,s.baseShadows=t.shadows,s.baseIntensity=t.intensity,s.baseSaturation=t.saturation;const r=0!==t.luminosity||t.shadows>0||t.intensity>0||0!==t.saturation,a=Color.fromHSL([i.hue,1,.5]).linear;Color.applyRGB(a,s.darkTint),s.darkLuminosity=i.luminosity,s.darkShadows=i.shadows,s.darkIntensity=i.intensity,s.darkSaturation=i.saturation;const l=(0!==i.luminosity||i.shadows>0||i.intensity>0||0!==i.saturation)&&e;s.cycle=e,s.darknessLevelTexture=canvas.effects.illumination.renderTexture,n.enabled=r||l}#Es({globalLight:e}){const t=1.2*canvas.dimensions.maxR,i=foundry.utils.mergeObject({z:-1/0,elevation:1/0,dim:e.bright?0:t,bright:e.bright?t:0,disabled:!e.enabled},e,{overwrite:!1});this.globalLightSource.initialize(i),this.globalLightSource.add()}get darknessPenalty(){return foundry.utils.logCompatibilityWarning("EnvironmentCanvasGroup#darknessPenalty is deprecated without replacement. The darkness penalty is no longer applied on light and vision sources.",{since:12,until:14}),0}}class HiddenCanvasGroup extends(CanvasGroupMixin(PIXI.Container)){constructor(){super(),this.eventMode="none",this.#Cs()}masks=new PIXI.Container;static groupName="hidden";addMask(e,t,i){if(!("string"==typeof e&&e.length>0))throw new Error(`Adding mask failed. Name ${e} is invalid.`);if(!t.clear)throw new Error("A mask container must implement a clear method.");this.masks[e]=i?this.masks.addChildAt(t,i):this.masks.addChild(t)}invalidateMasks(){for(const e of this.masks.children)e instanceof CachedContainer&&(e.renderDirty=!0)}async _draw(e){this.invalidateMasks(),this.addChild(this.masks),await this.#_s(),await super._draw(e)}async#_s(){await this.masks.vision.draw()}#Cs(){const e=new PIXI.LegacyGraphics;this.addMask("canvas",e);const t=new PIXI.LegacyGraphics;this.addMask("scene",t);const i=new CanvasVisionMask;this.addMask("vision",i);const n=new CanvasOcclusionMask;this.addMask("occlusion",n);const s=new CanvasDepthMask;this.addMask("depth",s)}async _tearDown(e){this.removeChild(this.masks),this.masks.children.forEach((e=>e.clear())),await super._tearDown(e)}}class InterfaceCanvasGroup extends(CanvasGroupMixin(PIXI.Container)){static groupName="interface";#Is;#ws;#Ds;addDrawing(e){const t=e.objectId,i=this.drawings.graphics.get(t)??this.#Ds.addChild(new PIXI.Graphics);return i.name=t,this.drawings.graphics.set(t,i),i}removeDrawing(e){const t=e.objectId;if(!this.drawings.graphics.has(t))return;const i=this.drawings.graphics.get(t);!1===i?.destroyed&&i.destroy({children:!0}),this.drawings.graphics.delete(t)}async _draw(e){this.#Os(),this.#xs(),this.#Ns(),await super._draw(e),this.filters=[new VoidFilter],this.filterArea=canvas.app.screen}#Os(){const e=this.#ws=this.addChild(new PIXI.Graphics),{scene:t,dimensions:i}=canvas,n=0!==t.padding,s=!t.background.src;(n||s)&&(n&&e.lineStyle({alignment:1,alpha:.75,color:0,join:PIXI.LINE_JOIN.BEVEL,width:4}).drawShape(i.rect),s&&e.lineStyle({alignment:1,alpha:.25,color:0,join:PIXI.LINE_JOIN.BEVEL,width:4}).drawShape(i.sceneRect).endFill())}#Ns(){this.#Is=this.addChild(new PIXI.Container);const{width:e,height:t}=canvas.dimensions;this.#Is.width=e,this.#Is.height=t,this.#Is.eventMode="none",this.#Is.interactiveChildren=!1,this.#Is.zIndex=g.Canvas.groups.interface.zIndexScrollingText}#xs(){this.#Ds=this.addChild(new PIXI.Container),this.#Ds.sortChildren=function(){const e=this.children;for(let t=0,i=e.length;t<i;t++)e[t]._lastSortedIndex=t;e.sort(InterfaceCanvasGroup.#As),this.sortDirty=!1},this.#Ds.sortableChildren=!0,this.#Ds.eventMode="none",this.#Ds.interactiveChildren=!1,this.#Ds.zIndex=g.Canvas.groups.interface.zIndexDrawings}static#As(e,t){return(e.elevation||0)-(t.elevation||0)||(e.sort||0)-(t.sort||0)||e.zIndex-t.zIndex||e._lastSortedIndex-t._lastSortedIndex}async createScrollingText(e,t,{duration:i=2e3,distance:n,jitter:s=0,anchor:o,direction:r,...a}={}){if(!c.settings.get("core","scrollingStatusText"))return null;const l=PreciseText.getTextStyle({anchor:o,...a}),d=this.#Is.addChild(new PreciseText(t,l));d.visible=!1;const u=(s?(Math.random()-.5)*s:0)*d.width,h=(s?(Math.random()-.5)*s:0)*d.height;d.position.set(e.x+u,e.y+h),d.anchor.set(...{[CONST.TEXT_ANCHOR_POINTS.CENTER]:[.5,.5],[CONST.TEXT_ANCHOR_POINTS.BOTTOM]:[.5,0],[CONST.TEXT_ANCHOR_POINTS.TOP]:[.5,1],[CONST.TEXT_ANCHOR_POINTS.LEFT]:[1,.5],[CONST.TEXT_ANCHOR_POINTS.RIGHT]:[0,.5]}[o??CONST.TEXT_ANCHOR_POINTS.CENTER]);let p=0,g=0;switch(r??CONST.TEXT_ANCHOR_POINTS.TOP){case CONST.TEXT_ANCHOR_POINTS.BOTTOM:g=n??2*d.height;break;case CONST.TEXT_ANCHOR_POINTS.TOP:g=-1*(n??2*d.height);break;case CONST.TEXT_ANCHOR_POINTS.LEFT:p=-1*(n??2*d.width);break;case CONST.TEXT_ANCHOR_POINTS.RIGHT:p=n??2*d.width}await CanvasAnimation.animate([{parent:d,attribute:"alpha",from:0,to:1},{parent:d.scale,attribute:"x",from:.6,to:1},{parent:d.scale,attribute:"y",from:.6,to:1}],{context:this,duration:.25*i,easing:CanvasAnimation.easeInOutCosine,ontick:()=>d.visible=!0});const m=[{parent:d,attribute:"alpha",to:0}];0!==p&&m.push({parent:d,attribute:"x",to:d.position.x+p}),0!==g&&m.push({parent:d,attribute:"y",to:d.position.y+g}),await CanvasAnimation.animate(m,{context:this,duration:.75*i,easing:CanvasAnimation.easeInOutCosine}),this.#Is.removeChild(d),d.destroy()}}class OverlayCanvasGroup extends(CanvasGroupMixin(UnboundContainer)){static groupName="overlay";static tearDownChildren=!1}class PrimaryCanvasGroup extends(CanvasGroupMixin(CachedContainer)){constructor(e){e||=new SpriteMesh(void 0,BaseSamplerShader),super(e),this.eventMode="none",this.#Rs(),this.on("childAdded",this.#Ps),this.on("childRemoved",this.#ks)}static SORT_LAYERS=Object.freeze({SCENE:0,TILES:500,DRAWINGS:600,TOKENS:700,WEATHER:1e3});static groupName="primary";static textureConfiguration={scaleMode:PIXI.SCALE_MODES.NEAREST,format:PIXI.FORMATS.RGB,multisample:PIXI.MSAA_QUALITY.NONE};clearColor=[0,0,0,0];_backgroundColor;videoMeshes=new Set;hoverFadeElevation=0;static BACKGROUND_ELEVATION=0;background;foreground;quadtree=new CanvasQuadtree;drawings=new foundry.utils.Collection;tokens=new foundry.utils.Collection;tiles=new foundry.utils.Collection;_ambienceFilter;#Ms=[];#Ls=!1;get backgroundSource(){return this.background.texture.valid&&this.background.texture!==PIXI.Texture.WHITE?this.background.texture.baseTexture.resource.source:null}get foregroundSource(){return this.foreground.texture.valid?this.foreground.texture.baseTexture.resource.source:null}#Rs(){if(this._ambienceFilter)this._ambienceFilter.enabled=!1;else{this.filters??=[];const e=this._ambienceFilter=PrimaryCanvasGroupAmbienceFilter.create();e.enabled=!1,this.filterArea=canvas.app.renderer.screen,this.filters.push(e)}}refreshPrimarySpriteMesh(){const e=canvas.visibility.visionModeData.source,t=e?.visionMode.canvas,i=this.sprite.shader.constructor===BaseSamplerShader;if((t||!i)&&(this.sprite.setShaderClass(t?.shader??BaseSamplerShader),this.sprite.shader.uniforms.sampler=this.renderTexture,t?.uniforms)){t.uniforms.linkedToDarknessLevel=e?.visionMode.vision.darkness.adaptive,t.uniforms.darknessLevel=canvas.environment.darknessLevel,t.uniforms.darknessLevelTexture=canvas.effects.illumination.renderTexture,t.uniforms.screenDimensions=canvas.screenDimensions,t.uniforms.tint=e?.visionModeOverrides.colorRGB??this.sprite.shader.constructor.defaultUniforms.tint;for(const[e,i]of Object.entries(t?.uniforms??{}))e in this.sprite.shader.uniforms&&(this.sprite.shader.uniforms[e]=i)}}update(){this.sortDirty&&this.sortChildren();const e=this.children;for(let t=0,i=e.length;t<i;t++)e[t].updateCanvasTransform?.();if(canvas.masks.depth._update(),!g.debug.canvas.primary.bounds)return;const t=canvas.controls.debug.clear().lineStyle(5,3211008);for(const e of this.children)e.canvasBounds&&t.drawShape(e.canvasBounds)}async _draw(e){this.#Fs(),this.#Us(),this.#Bs(),this.hoverFadeElevation=0,await super._draw(e)}_render(e){const[t,i,n]=this._backgroundColor;e.framebuffer.clear(t,i,n,1,PIXI.BUFFER_BITS.COLOR),super._render(e)}#Fs(){const e=this.background=this.addChild(new PrimarySpriteMesh({name:"background",object:this}));e.elevation=this.constructor.BACKGROUND_ELEVATION;const t=canvas.sceneTextures.background??canvas.scene.background.src,i=t instanceof PIXI.Texture?t:getTexture(t);this.#Gs(e,i)}#Us(){const e=this.foreground=this.addChild(new PrimarySpriteMesh({name:"foreground",object:this}));e.elevation=canvas.scene.foregroundElevation;const t=canvas.sceneTextures.foreground??canvas.scene.foreground,i=t instanceof PIXI.Texture?t:getTexture(t),n=this.background.texture;i&&n&&(i.width!==n.width||i.height!==n.height)&&ui.notifications.warn("WARNING.ForegroundDimensionsMismatch",{localize:!0}),this.#Gs(e,i)}#Gs(e,t){const i=canvas.dimensions;e.texture=t??PIXI.Texture.EMPTY,e.textureAlphaThreshold=.75,e.occludedAlpha=.5,e.visible=e.texture!==PIXI.Texture.EMPTY,e.position.set(i.sceneX,i.sceneY),e.width=i.sceneWidth,e.height=i.sceneHeight,e.sortLayer=PrimaryCanvasGroup.SORT_LAYERS.SCENE,e.zIndex=-1/0,e.hoverFade=!1;const n=c.video.getVideoSource(e);n&&(this.videoMeshes.add(e),c.video.play(n,{volume:c.settings.get("core","globalAmbientVolume")}))}#Bs(){const e=canvas.dimensions,t=this.addChild(new PIXI.LegacyGraphics);t.beginFill(0,.025).drawShape(e.rect).beginHole().drawShape(e.sceneRect).endHole().endFill(),t.elevation=-1/0,t.sort=-1/0}async _tearDown(e){for(const e of this.videoMeshes)c.video.stop(e.sourceElement);await super._tearDown(e),this.videoMeshes.clear(),this.tokens.clear(),this.tiles.clear(),this.quadtree.clear(),this.#Ls=!1}addToken(e){const t=e.objectId,i=this.tokens.get(t)??this.addChild(new PrimarySpriteMesh({name:t,object:e}));return i.texture=e.texture??PIXI.Texture.EMPTY,this.tokens.set(t,i),i.isVideo&&this.videoMeshes.add(i),i}removeToken(e){const t=e.objectId,i=this.tokens.get(t);!1===i?.destroyed&&i.destroy({children:!0}),this.tokens.delete(t),this.videoMeshes.delete(i)}addTile(e){if(!this.#Ls&&e.document.getFlag("core","isTilingSprite")){this.#Ls=!0,ui.notifications.warn("WARNING.TilingSpriteDeprecation",{localize:!0,permanent:!0});const e="Tiling Sprites are deprecated without replacement.";foundry.utils.logCompatibilityWarning(e,{since:12,until:14})}const t=e.objectId;let i=this.tiles.get(t)??this.addChild(new PrimarySpriteMesh({name:t,object:e}));return i.texture=e.texture??PIXI.Texture.EMPTY,this.tiles.set(t,i),i.isVideo&&this.videoMeshes.add(i),i}removeTile(e){const t=e.objectId,i=this.tiles.get(t);!1===i?.destroyed&&i.destroy({children:!0}),this.tiles.delete(t),this.videoMeshes.delete(i)}addDrawing(e){const t=e.objectId,i=this.drawings.get(t)??this.addChild(new PrimaryGraphics({name:t,object:e}));return this.drawings.set(t,i),i}removeDrawing(e){const t=e.objectId;if(!this.drawings.has(t))return;const i=this.drawings.get(t);!1===i?.destroyed&&i.destroy({children:!0}),this.drawings.delete(t)}sortChildren(){const e=this.children;for(let t=0,i=e.length;t<i;t++)e[t]._lastSortedIndex=t;e.sort(PrimaryCanvasGroup.#As),this.sortDirty=!1}static#As(e,t){return(e.elevation||0)-(t.elevation||0)||(e.sortLayer||0)-(t.sortLayer||0)||(e.sort||0)-(t.sort||0)||e.zIndex-t.zIndex||e._lastSortedIndex-t._lastSortedIndex}#Ps(e){e.shouldRenderDepth&&(canvas.masks.depth._elevationDirty=!0)}#ks(e){e.shouldRenderDepth&&(canvas.masks.depth._elevationDirty=!0)}_onMouseMove(){const e=canvas.app.ticker.lastTime;for(const t of this.#Ms)t._hoverFadeState.hovered&&(t._hoverFadeState.hovered=!1,t._hoverFadeState.hoveredTime=e);this.#js();for(const t of this.#Ms){if(!(t.hoverFade&&t.elevation>this.hoverFadeElevation))break;t._hoverFadeState.hovered=!0,t._hoverFadeState.hoveredTime=e}}#js(){this.#Ms.length=0;const e=canvas.mousePosition,collisionTest=({t:t})=>t.visible&&t.renderable&&t._hoverFadeState&&t.containsCanvasPoint(e);for(const t of canvas.primary.quadtree.getObjects(new PIXI.Rectangle(e.x,e.y,0,0),{collisionTest:collisionTest}))this.#Ms.push(t);this.#Ms.sort(((e,t)=>PrimaryCanvasGroup.#As(t,e)));const t=canvas.activeLayer?.hover;if(t){let e=0,i=1/0,n=1/0,s=1/0;if(t instanceof Token||t instanceof Tile){const o=t.mesh;o&&(e=o.elevation,i=o.sortLayer,n=o.sort,s=o.zIndex)}else if(t instanceof Drawing){const o=t.shape;o&&(e=o.elevation,i=o.sortLayer,n=o.sort,s=o.zIndex)}else t.document.schema.has("elevation")&&(e=t.document.elevation);const o={elevation:e,sortLayer:i,sort:n,zIndex:s,_lastSortedIndex:1/0};for(;this.#Ms.length&&PrimaryCanvasGroup.#As(this.#Ms.at(-1),o)<=0;)this.#Ms.pop()}}mapElevationToDepth(e){return foundry.utils.logCompatibilityWarning("PrimaryCanvasGroup#mapElevationAlpha is deprecated. Use canvas.masks.depth.mapElevation(elevation) instead.",{since:12,until:14}),canvas.masks.depth.mapElevation(e)}mapElevationAlpha(e){return foundry.utils.logCompatibilityWarning("PrimaryCanvasGroup#mapElevationAlpha is deprecated. Use canvas.masks.depth.mapElevation(elevation) instead.",{since:11,until:13}),canvas.masks.depth.mapElevation(e)}}class RenderedCanvasGroup extends(CanvasGroupMixin(PIXI.Container)){static groupName="rendered";static tearDownChildren=!1}class ClockwiseSweepPolygon extends PointSourcePolygon{vertices=new Map;edges=new Set;rays=[];#$s;initialize(e,t){super.initialize(e,t),this.#$s=Math.pow(canvas.dimensions.maxR,2)}clone(){const e=super.clone();for(const t of["vertices","edges","rays","#rayDistance2"])e[t]=this[t];return e}_compute(){this.points=[],this.rays=[],this.vertices.clear(),this.edges.clear(),this._identifyEdges(),this._identifyVertices(),this._executeSweep(),this._constrainBoundaryShapes()}_identifyEdges(){const e=this.config.boundingBox=this._defineBoundingBox(),t=this._determineEdgeTypes();for(const i of canvas.edges.values())this._testEdgeInclusion(i,t,e)&&this.edges.add(i.clone())}_determineEdgeTypes(){const{type:e,useInnerBounds:t,includeDarkness:i}=this.config,n={};return"universal"!==e&&(n.wall=1),i&&(n.darkness=1),t&&canvas.scene.padding?n.innerBounds=2:n.outerBounds=2,n}_testEdgeInclusion(e,t,i){const{type:n,boundaryShapes:s,useThreshold:o,wallDirectionMode:r,externalRadius:a}=this.config,l=t[e.type];if(!l)return!1;if(2===l)return!0;if(!i.lineSegmentIntersects(e.a,e.b,{inside:!0}))return!1;for(const t of s)if(t._includeEdge&&!t._includeEdge(e.a,e.b))return!1;if(e[n]===CONST.WALL_SENSE_TYPES.NONE)return!1;const c=e.orientPoint(this.origin);if(!c)return!1;const d=PointSourcePolygon.WALL_DIRECTION_MODES;return(!e.direction||r===d.BOTH||r===d.NORMAL!=(c===e.direction))&&(!o||!e.applyThreshold(n,this.origin,a))}_defineBoundingBox(){let e=this.config.useInnerBounds?canvas.dimensions.sceneRect:canvas.dimensions.rect;for(const t of this.config.boundaryShapes)e=e.intersection(t.getBounds());return new PIXI.Rectangle(e.x,e.y,e.width,e.height).normalize().ceil().pad(1)}_identifyVertices(){const e=new Map;for(let t of this.edges){e.set(t.id,t);const i=foundry.canvas.edges.PolygonVertex.getKey(t.a.x,t.a.y);this.vertices.has(i)?t.vertexA=this.vertices.get(i):(t.vertexA=new foundry.canvas.edges.PolygonVertex(t.a.x,t.a.y),this.vertices.set(i,t.vertexA));const n=foundry.canvas.edges.PolygonVertex.getKey(t.b.x,t.b.y);this.vertices.has(n)?t.vertexB=this.vertices.get(n):(t.vertexB=new foundry.canvas.edges.PolygonVertex(t.b.x,t.b.y),this.vertices.set(n,t.vertexB));const s=foundry.utils.orient2dFast(this.origin,t.vertexA,t.vertexB);s>0&&Object.assign(t,{vertexA:t.vertexB,vertexB:t.vertexA}),0!==s&&(t.vertexA.attachEdge(t,-1,this.config.type),t.vertexB.attachEdge(t,1,this.config.type))}this._identifyIntersections(e)}_identifyIntersections(e){const t=new Set;for(let i of this.edges){for(const n of i.intersections){const s=e.get(n.edge.id);if(!s||t.has(s))continue;const o=n.intersection,r=foundry.canvas.edges.PolygonVertex.getKey(Math.round(o.x),Math.round(o.y));let a=this.vertices.get(r);if(a||(a=new foundry.canvas.edges.PolygonVertex(o.x,o.y),a._intersectionCoordinates=o,this.vertices.set(r,a)),!a.edges.has(i)){const e=foundry.utils.orient2dFast(this.origin,i.vertexB,o)<0?1:foundry.utils.orient2dFast(this.origin,i.vertexA,o)>0?-1:0;a.attachEdge(i,e,this.config.type)}if(!a.edges.has(s)){const e=foundry.utils.orient2dFast(this.origin,s.vertexB,o)<0?1:foundry.utils.orient2dFast(this.origin,s.vertexA,o)>0?-1:0;a.attachEdge(s,e,this.config.type)}}t.add(i)}}_executeSweep(){const e=this._initializeActiveEdges(),t=this._sortVertices();let i=1;for(const n of t){if(n._visited)continue;n._index=i++,this.#Hs(n,e);const t=n.collinearVertices.size>0;if(t){this.#zs(n,n.collinearVertices);for(const t of n.collinearVertices)t._index=i++,this.#Hs(t,e)}this._determineSweepResult(n,e,t)}}#zs(e,t){for(const e of t)for(const i of e.collinearVertices)t.add(i);t.delete(e)}#Hs(e,t){for(const i of e.ccwEdges)e.cwEdges.has(i)||t.delete(i);for(const i of e.cwEdges)i.vertexA._visited&&i.vertexB._visited||t.add(i);e._visited=!0}_initializeActiveEdges(){const e={x:Math.round(this.origin.x-this.#$s),y:this.origin.y},t=new Set;for(let i of this.edges){foundry.utils.lineSegmentIntersects(this.origin,e,i.vertexA,i.vertexB)&&t.add(i)}return t}_sortVertices(){if(!this.vertices.size)return[];let e=Array.from(this.vertices.values());const t=this.origin;return e.sort(((e,i)=>{let n=e._intersectionCoordinates||e,s=i._intersectionCoordinates||i;const o=n.y>t.y?1:-1;if(o!==(s.y>t.y?1:-1))return o;const r=n.x<t.x?-1:1;if(r!==(s.x<t.x?-1:1))return-1===o?r:-r;const a=foundry.utils.orient2dFast(t,n,s);return 0!==a?a:(e.collinearVertices.add(i),i.collinearVertices.add(e),e._d2||=Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2),i._d2||=Math.pow(s.x-t.x,2)+Math.pow(s.y-t.y,2),e._d2-i._d2)})),e}_isVertexBehindActiveEdges(e,t){let i=!1;for(let n of t)if(!e.edges.has(n)&&foundry.utils.orient2dFast(n.vertexA,n.vertexB,e)>0){if(!n.isLimited(this.config.type)||i)return{isBehind:!0,wasLimited:i};i=!0}return{isBehind:!1,wasLimited:i}}_determineSweepResult(e,t,i=!1){const{isBehind:n,wasLimited:s}=this._isVertexBehindActiveEdges(e,t);if(n)return;const o=new foundry.canvas.edges.CollisionResult({target:e,cwEdges:e.cwEdges,ccwEdges:e.ccwEdges,isLimited:e.isLimited,isBehind:n,wasLimited:s}),r=e.ccwEdges.size;if(!r)return this._switchEdge(o,t),void o.collisions.forEach((e=>this.addPoint(e)));const a=!o.wasLimited&&e.isLimitingCCW,l=!o.wasLimited&&e.isLimitingCW;if(i||!l||!a){if(!a&&!l&&r&&e.cwEdges.size)return o.collisions.push(o.target),void this.addPoint(o.target);this._switchEdge(o,t),o.collisions.forEach((e=>this.addPoint(e)))}}_switchEdge(e,t){const i=this.origin,n=Ray.towardsPointSquared(i,e.target,this.#$s);n.result=e,this.rays.push(n);const s=[e.target,...e.target.collinearVertices],o=new Set;for(const e of s)o.add(e.key),e._d2??=Math.pow(e.x-i.x,2)+Math.pow(e.y-i.y,2);let r;this.#Vs(s,o,n,t),s.sort(((e,t)=>e._d2-t._d2));const a=e.collisions;for(const t of s){if(t.isInternal){if(!e.blockedCW&&!e.blockedCCW&&!t.isLimited)return;e.blockedCW||=!t.isLimited||e.limitedCW,e.blockedCCW||=!t.isLimited||e.limitedCCW,e.limitedCW=!0,e.limitedCCW=!0}else e.blockedCW||=e.limitedCW&&t.isLimitingCW||t.isBlockingCW,e.blockedCCW||=e.limitedCCW&&t.isLimitingCCW||t.isBlockingCCW,e.limitedCW||=t.isLimitingCW,e.limitedCCW||=t.isLimitingCCW;if(e.blockedCW&&(r||=a.unshift,e.blockedCWPrev||r.call(a,t)),e.blockedCCW&&(r||=a.push,e.blockedCCWPrev||r.call(a,t)),e.blockedCW&&e.blockedCCW)return;e.blockedCWPrev||=e.blockedCW,e.blockedCCWPrev||=e.blockedCCW}}#Vs(e,t,i,n){for(const s of n){if(t.has(s.vertexA.key)||t.has(s.vertexB.key))continue;const n=foundry.utils.lineLineIntersection(i.A,i.B,s.vertexA,s.vertexB);if(!n)continue;const o=foundry.canvas.edges.PolygonVertex.fromPoint(n);o.attachEdge(s,0,this.config.type),o.isInternal=!0,o._d2=Math.pow(n.x-i.A.x,2)+Math.pow(n.y-i.A.y,2),e.push(o)}}_testCollision(e,t){const{debug:i,type:n}=this.config;this._identifyEdges();let s=new Map;for(const i of this.edges){const o=foundry.utils.lineSegmentIntersection(this.origin,e.B,i.a,i.b);if(!o||o.t0<=0)continue;if("any"===t&&(!i.isLimited(n)||s.size))return!0;let r=foundry.canvas.edges.PolygonVertex.fromPoint(o,{distance:o.t0});s.has(r.key)?r=s.get(r.key):s.set(r.key,r),r.attachEdge(i,0,n)}return"any"!==t&&(s=Array.from(s.values()).sort(((e,t)=>e._distance-t._distance)),s[0]?.isLimited&&s.shift(),i&&this._visualizeCollision(e,s),"all"===t?s:s[0]||null)}visualize(){let e=canvas.controls.debug;e.clear(),canvas.controls.debug.debugText||(canvas.controls.debug.debugText=canvas.controls.addChild(new PIXI.Container));const t=canvas.controls.debug.debugText;t.removeChildren().forEach((e=>e.destroy({children:!0})));const i={[CONST.WALL_SENSE_TYPES.NONE]:7858152,[CONST.WALL_SENSE_TYPES.NORMAL]:16777147,[CONST.WALL_SENSE_TYPES.LIMITED]:8501516,[CONST.WALL_SENSE_TYPES.PROXIMITY]:16777147,[CONST.WALL_SENSE_TYPES.DISTANCE]:16777147};for(const t of this.config.boundaryShapes)e.lineStyle(2,16729156,1).beginFill(16729156,.1).drawShape(t).endFill();e.beginFill(43775,.25).drawShape(this).endFill();for(let t of this.edges){const n=i[t[this.config.type]];e.lineStyle(4,n).moveTo(t.a.x,t.a.y).lineTo(t.b.x,t.b.y)}for(let n of this.vertices.values()){const s=n.restriction;if(s&&e.lineStyle(1,0).beginFill(i[s]).drawCircle(n.x,n.y,8).endFill(),n._index){t.addChild(new PIXI.Text(String(n._index),g.canvasTextStyle)).position.set(n.x,n.y)}}for(let t of this.rays){const i=t.result;if(i){e.lineStyle(2,65280,i.collisions.length?1:.33).moveTo(t.A.x,t.A.y).lineTo(t.B.x,t.B.y);for(let t of i.collisions)e.lineStyle(1,0).beginFill(16711680).drawCircle(t.x,t.y,6).endFill()}}return e}_visualizeCollision(e,t){let i=canvas.controls.debug;i.clear();const n={[CONST.WALL_SENSE_TYPES.NONE]:7858152,[CONST.WALL_SENSE_TYPES.NORMAL]:16777147,[CONST.WALL_SENSE_TYPES.LIMITED]:8501516,[CONST.WALL_SENSE_TYPES.PROXIMITY]:16777147,[CONST.WALL_SENSE_TYPES.DISTANCE]:16777147};for(let e of this.edges.values()){const t=n[e[this.config.type]];i.lineStyle(4,t).moveTo(e.a.x,e.b.y).lineTo(e.b.x,e.b.y)}i.lineStyle(4,26316).moveTo(e.A.x,e.A.y).lineTo(e.B.x,e.B.y);for(let e of t)i.lineStyle(1,0).beginFill(16711680).drawCircle(e.x,e.y,6).endFill()}}class DetectionMode extends foundry.abstract.DataModel{static defineSchema(){const e=foundry.data.fields;return{id:new e.StringField({blank:!1}),label:new e.StringField({blank:!1}),tokenConfig:new e.BooleanField({initial:!0}),walls:new e.BooleanField({initial:!0}),angle:new e.BooleanField({initial:!0}),type:new e.NumberField({initial:this.DETECTION_TYPES.SIGHT,choices:Object.values(this.DETECTION_TYPES)})}}static getDetectionFilter(){return this._detectionFilter}static _detectionFilter;static{Object.defineProperty(this,"DETECTION_TYPES",{value:Object.freeze({SIGHT:0,SOUND:1,MOVE:2,OTHER:3})}),Object.defineProperty(this,"BASIC_MODE_ID",{value:"basicSight"})}testVisibility(e,t,{object:i,tests:n}={}){return!!t.enabled&&(!!this._canDetect(e,i)&&n.some((n=>this._testPoint(e,t,i,n))))}_canDetect(e,t){const i=e.object.document,n=this.type===DetectionMode.DETECTION_TYPES.SIGHT;if(n&&i.hasStatusEffect(g.specialStatusEffects.BLIND))return!1;if(this.walls&&i.hasStatusEffect(g.specialStatusEffects.BURROW))return!1;if(t instanceof Token){const e=t.document;if(n&&e.hasStatusEffect(g.specialStatusEffects.INVISIBLE))return!1;if(this.walls&&e.hasStatusEffect(g.specialStatusEffects.BURROW))return!1}return!0}_testPoint(e,t,i,n){return!!this._testRange(e,t,i,n)&&this._testLOS(e,t,i,n)}_testLOS(e,t,i,n){if(!this.walls)return this._testAngle(e,t,i,n);const s=e.constructor.sourceType,o="sight"===s;if(o&&e.blinded.darkness)return!1;if(!this.angle&&e.data.angle<360)return!g.Canvas.polygonBackends[s].testCollision({x:e.x,y:e.y},n.point,{type:s,mode:"any",source:e,useThreshold:!0,includeDarkness:o});let r=n.los.get(e);return void 0===r&&(r=e.los.contains(n.point.x,n.point.y),n.los.set(e,r)),r}_testAngle(e,t,i,n){if(!this.angle)return!0;const{angle:s,rotation:o,externalRadius:r}=e.data;if(s>=360)return!0;const a=n.point,l=a.x-e.x,c=a.y-e.y;if(l*l+c*c<=r*r)return!0;const d=o+90-s/2;return((Math.toDegrees(Math.atan2(c,l))-d)%360+360)%360<=s}_testRange(e,t,i,n){if(null===t.range)return!0;if(t.range<=0)return!1;const s=e.object.getLightRadius(t.range),o=n.point.x-e.x,r=n.point.y-e.y;return o*o+r*r<=s*s}}class DetectionModeInvisibility extends DetectionMode{static getDetectionFilter(){return this._detectionFilter??=GlowOverlayFilter.create({glowColor:[0,.6,.33,1]})}_canDetect(e,t){if(!(t instanceof Token))return!1;const i=t.document;if(!i.hasStatusEffect(g.specialStatusEffects.INVISIBLE))return!1;const n=e.object.document;if(this.type===DetectionMode.DETECTION_TYPES.SIGHT&&n.hasStatusEffect(g.specialStatusEffects.BLIND))return!1;if(this.walls){if(n.hasStatusEffect(g.specialStatusEffects.BURROW))return!1;if(i.hasStatusEffect(g.specialStatusEffects.BURROW))return!1}return!0}}class DetectionModeAll extends DetectionMode{static getDetectionFilter(){return this._detectionFilter??=OutlineOverlayFilter.create({outlineColor:[.85,.85,1,1],knockout:!0})}_canDetect(e,t){const i=e.object.document;if(this.type===DetectionMode.DETECTION_TYPES.SIGHT&&i.hasStatusEffect(g.specialStatusEffects.BLIND))return!1;if(!this.walls)return!0;if(i.hasStatusEffect(g.specialStatusEffects.BURROW))return!1;if(t instanceof Token){if(t.document.hasStatusEffect(g.specialStatusEffects.BURROW))return!1}return!0}}class FogManager{exploration=null;#Ye=!1;_updated=!1;get extractor(){return this.#Ws}#Ws;#Xs=0;#cn=new PIXI.Matrix;static COMMIT_THRESHOLD=70;#Ys;#Ks=new foundry.utils.Semaphore;get sprite(){return this.#qs||(this.#qs=this._createExplorationObject())}#qs;get textureConfiguration(){return canvas.visibility.textureConfiguration}get tokenVision(){return canvas.scene.tokenVision}get fogExploration(){return canvas.scene.fog.exploration}_createExplorationObject(e){return new SpriteMesh(e??Canvas.getRenderTexture({clearColor:[0,0,0,1],textureConfiguration:this.textureConfiguration}),FogSamplerShader)}async initialize(){if(this.#Ye=!1,void 0===this.#Ws)try{this.#Ws=new TextureExtractor(canvas.app.renderer,{callerName:"FogExtractor",controlHash:!0,format:PIXI.FORMATS.RED})}catch(e){this.#Ws=null,console.error(e)}this.#Ws?.reset(),this.#Ys=foundry.utils.debounce(this.save.bind(this),2e3),await this.load(),this.#Ye=!0}async clear(){try{await this.save()}catch(e){ui.notifications.error("Failed to save fog exploration"),console.error(e)}this.#Ye=!1,this.#Js()}commit(){const e=canvas.visibility.vision;if(!e?.children.length||!this.fogExploration||!this.tokenVision)return;if(!this.#qs?.texture.valid)return;const t=canvas.dimensions,i=this.#qs.texture instanceof PIXI.RenderTexture,n=i?this.#qs.texture:Canvas.getRenderTexture({clearColor:[0,0,0,1],textureConfiguration:this.textureConfiguration});if(this.#cn.tx=-t.sceneX,this.#cn.ty=-t.sceneY,e.containmentFilter.enabled=canvas.visibility.needsContainment,e.light.preview.visible=!1,e.light.mask.preview.visible=!1,e.sight.preview.visible=!1,canvas.app.renderer.render(i?e:this.#qs,{renderTexture:n,clear:!1,transform:this.#cn}),e.light.preview.visible=!0,e.light.mask.preview.visible=!0,e.sight.preview.visible=!0,e.containmentFilter.enabled=!1,i||this.#qs.texture.destroy(!0),this.#qs.texture=n,this._updated=!0,!this.exploration){const e=getDocumentClass("FogExploration");this.exploration=new e}this.#Xs>FogManager.COMMIT_THRESHOLD?(this.#Ys(),this.#Xs=0):this.#Xs++}async load(){return await this.#Ks.add(this.#Qs.bind(this))}async#Qs(){if(g.debug.fog.manager&&console.debug("FogManager | Loading saved FogExploration for Scene."),this.#Js(),!this.tokenVision)return;const e=getDocumentClass("FogExploration");this.exploration=await e.load();const assign=(e,t)=>{if(this.#qs?.texture===e)return t(e);this.#qs?.destroy(!0),this.#qs=this._createExplorationObject(e),canvas.visibility.resetExploration(),canvas.perception.initialize(),t(e)};return this.exploration?await new Promise((e=>{let t=this.exploration.getTexture();null===t?assign(Canvas.getRenderTexture({clearColor:[0,0,0,1],textureConfiguration:this.textureConfiguration}),e):t.baseTexture.valid?assign(t,e):t.on("update",(t=>assign(t,e)))})):await new Promise((e=>{assign(Canvas.getRenderTexture({clearColor:[0,0,0,1],textureConfiguration:this.textureConfiguration}),e)}))}async reset(){g.debug.fog.manager&&console.debug("FogManager | Resetting fog of war exploration for Scene."),c.socket.emit("resetFog",canvas.scene.id)}async save(){return await this.#Ks.add(this.#Zs.bind(this))}async#Zs(){if(!this._updated)return;this._updated=!1;const e=this.exploration;if(g.debug.fog.manager&&console.debug("FogManager | Initiate non-blocking extraction of the fog of war progress."),!this.#Ws)return void console.error("FogManager | Browser does not support texture extraction.");const t=await this._extractBase64();if(this.exploration!==e)return;if(!t)return void(g.debug.fog.manager&&console.debug("FogManager | Fog of war has not changed. Skipping db operation."));const i=this._prepareFogUpdateData(t);await this.#eo(i)}async _extractBase64(){try{return this.#Ws.extract({texture:this.#qs.texture,compression:TextureExtractor.COMPRESSION_MODES.BASE64,type:"image/webp",quality:.8,debug:g.debug.fog.extractor})}catch(e){throw new Error("Fog of War base64 extraction failed")}}_prepareFogUpdateData(e){return{explored:e,timestamp:Date.now()}}async#eo(e){c.scenes.has(canvas.scene?.id)&&this.exploration&&(g.debug.fog.manager&&console.debug("FogManager | Saving fog of war progress into exploration document."),this.exploration.id?await this.exploration.update(e,{loadFog:!1}):(this.exploration.updateSource(e),this.exploration=await this.exploration.constructor.create(this.exploration.toJSON(),{loadFog:!1})))}#Js(){this.exploration=null,this.#Ws?.reset(),this.#qs&&!this.#qs.destroyed&&this.#qs.destroy(!0),this.#qs=void 0,this._updated=!1,this.#Xs=0}async _handleReset(){return await this.#Ks.add(this.#to.bind(this))}async#to(){ui.notifications.info("Fog of War exploration progress was reset for this Scene"),this.#Js(),canvas.visibility.resetExploration(),canvas.perception.initialize()}get pending(){return foundry.utils.logCompatibilityWarning("pending is deprecated and redirected to the exploration container",{since:11,until:13}),canvas.visibility.explored}get revealed(){return foundry.utils.logCompatibilityWarning("revealed is deprecated and redirected to the exploration container",{since:11,until:13}),canvas.visibility.explored}update(e,t=!1){return foundry.utils.logCompatibilityWarning("update is obsolete and always returns true. The fog exploration does not record position anymore.",{since:11,until:13}),!0}get resolution(){return foundry.utils.logCompatibilityWarning("resolution is deprecated and redirected to CanvasVisibility#textureConfiguration",{since:11,until:13}),canvas.visibility.textureConfiguration}}class PerceptionManager extends(RenderFlagsMixin(Object)){static RENDER_FLAGS={refreshEdges:{},initializeLighting:{propagate:["initializeDarknessSources","initializeLightSources"]},initializeDarknessSources:{propagate:["refreshLighting","refreshVision","refreshEdges"]},initializeLightSources:{propagate:["refreshLighting","refreshVision"]},refreshLighting:{propagate:["refreshLightSources"]},refreshLightSources:{},initializeVisionModes:{propagate:["refreshVisionSources","refreshLighting","refreshPrimary"]},initializeVision:{propagate:["initializeVisionModes","refreshVision"]},refreshVision:{propagate:["refreshVisionSources","refreshOcclusionMask"]},refreshVisionSources:{},refreshPrimary:{},refreshOcclusion:{propagate:["refreshOcclusionStates","refreshOcclusionMask"]},refreshOcclusionStates:{},refreshOcclusionMask:{},initializeSounds:{propagate:["refreshSounds"]},refreshSounds:{},soundFadeDuration:{},refreshTiles:{propagate:["refreshOcclusion"],deprecated:{message:"The refreshTiles flag is deprecated in favor of refreshOcclusion",since:12,until:14,alias:!0}},identifyInteriorWalls:{propagate:["initializeLighting","initializeVision"],deprecated:{message:"The identifyInteriorWalls is now obsolete and has no replacement.",since:12,until:14,alias:!0}},forceUpdateFog:{propagate:["refreshVision"],deprecated:{message:"The forceUpdateFog flag is now obsolete and has no replacement. The fog is now always updated when the visibility is refreshed",since:11,until:13,alias:!0}}};static#io=["refreshTiles","identifyInteriorWalls","forceUpdateFog"];static RENDER_FLAG_PRIORITY="PERCEPTION";applyRenderFlags(){if(!this.renderFlags.size)return;const e=this.renderFlags.clear();e.initializeDarknessSources&&canvas.effects.initializeDarknessSources(),e.refreshEdges&&canvas.edges.refresh(),e.initializeLightSources&&canvas.effects.initializeLightSources(),e.initializeVision&&canvas.visibility.initializeSources(),e.initializeVisionModes&&canvas.visibility.initializeVisionMode(),e.initializeSounds&&canvas.sounds.initializeSources(),e.refreshLightSources&&canvas.effects.refreshLightSources(),e.refreshVisionSources&&canvas.effects.refreshVisionSources(),e.refreshSounds&&canvas.sounds.refresh({fade:e.soundFadeDuration?250:0}),e.refreshPrimary&&canvas.primary.refreshPrimarySpriteMesh(),e.refreshLighting&&canvas.effects.refreshLighting(),e.refreshVision&&canvas.visibility.refresh(),e.refreshOcclusion?canvas.masks.occlusion.updateOcclusion():(e.refreshOcclusionMask&&canvas.masks.occlusion._updateOcclusionMask(),e.refreshOcclusionStates&&canvas.masks.occlusion._updateOcclusionStates());for(const t of PerceptionManager.#io)if(e[t]){const{message:e,since:i,until:n}=PerceptionManager.RENDER_FLAGS[t].deprecated;foundry.utils.logCompatibilityWarning(e,{since:i,until:n})}}update(e){canvas.ready&&this.renderFlags.set(e)}initialize(){return this.update({refreshEdges:!0,initializeLighting:!0,initializeVision:!0,initializeSounds:!0,refreshOcclusion:!0})}refresh(){return foundry.utils.logCompatibilityWarning("PerceptionManager#refresh is deprecated in favor of assigning granular refresh flags",{since:12,until:14}),this.update({refreshLighting:!0,refreshVision:!0,refreshSounds:!0,refreshOcclusion:!0})}}class ShaderField extends foundry.data.fields.DataField{static get _defaults(){const e=super._defaults;return e.nullable=!0,e.initial=void 0,e}_cast(e){if(!foundry.utils.isSubclass(e,AbstractBaseShader))throw new Error("The value provided to a ShaderField must be an AbstractBaseShader subclass.");return e}}class VisionMode extends foundry.abstract.DataModel{constructor(e={},t={}){super(e,t),this.animated=t.animated??!1}static defineSchema(){const e=foundry.data.fields,shaderSchema=()=>new e.SchemaField({shader:new ShaderField,uniforms:new e.ObjectField}),lightingSchema=()=>new e.SchemaField({visibility:new e.NumberField({initial:this.LIGHTING_VISIBILITY.ENABLED,choices:Object.values(this.LIGHTING_VISIBILITY)}),postProcessingModes:new e.ArrayField(new e.StringField),uniforms:new e.ObjectField});return{id:new e.StringField({blank:!1}),label:new e.StringField({blank:!1}),tokenConfig:new e.BooleanField({initial:!0}),canvas:new e.SchemaField({shader:new ShaderField,uniforms:new e.ObjectField}),lighting:new e.SchemaField({background:lightingSchema(),coloration:lightingSchema(),illumination:lightingSchema(),darkness:lightingSchema(),levels:new e.ObjectField({validate:e=>{const t=Object.values(CONST.LIGHTING_LEVELS);return Object.entries(e).every((([e,i])=>t.includes(Number(e))&&t.includes(i)))},validationError:"may only contain a mapping of keys from VisionMode.LIGHTING_LEVELS"}),multipliers:new e.ObjectField({validate:e=>{const t=Object.values(CONST.LIGHTING_LEVELS);return Object.entries(e).every((([e,i])=>t.includes(Number(e))&&Number.isFinite(i)))},validationError:"must provide a mapping of keys from VisionMode.LIGHTING_LEVELS to numeric multiplier values"})}),vision:new e.SchemaField({background:shaderSchema(),coloration:shaderSchema(),illumination:shaderSchema(),darkness:new e.SchemaField({adaptive:new e.BooleanField({initial:!0})}),defaults:new e.SchemaField({color:new e.ColorField({required:!1,initial:void 0}),attenuation:new e.AlphaField({required:!1,initial:void 0}),brightness:new e.NumberField({required:!1,initial:void 0,nullable:!1,min:-1,max:1}),saturation:new e.NumberField({required:!1,initial:void 0,nullable:!1,min:-1,max:1}),contrast:new e.NumberField({required:!1,initial:void 0,nullable:!1,min:-1,max:1})}),preferred:new e.BooleanField({initial:!1})})}}static LIGHTING_LEVELS=CONST.LIGHTING_LEVELS;static LIGHTING_VISIBILITY={DISABLED:0,ENABLED:1,REQUIRED:2};animated=!1;get perceivesLight(){const{background:e,illumination:t,coloration:i}=this.lighting;return!!(e.visibility||t.visibility||i.visibility)}_activate(e){}_deactivate(e){}activate(e){e._visionModeActivated||(e._visionModeActivated=!0,this._activate(e))}deactivate(e){e._visionModeActivated&&(e._visionModeActivated=!1,this._deactivate(e))}animate(e){return foundry.canvas.sources.PointVisionSource.prototype.animateTime.call(this,e)}}class WeilerAthertonClipper{constructor(e,t,i,n){if(!e.isPositive){throw new Error("WeilerAthertonClipper#constructor needs a subject polygon with a positive signed area.")}i??=this.constructor.CLIP_TYPES.INTERSECT,n??={},this.polygon=e,this.clipObject=t,this.config={clipType:i,clipOpts:n}}static CLIP_TYPES=Object.freeze({INTERSECT:0,UNION:1});static INTERSECTION_TYPES=Object.freeze({OUT_IN:-1,IN_OUT:1,TANGENT:0});polygon;clipObject;config={};static union(e,t,i={}){return this.combine(e,t,{clipType:this.CLIP_TYPES.UNION,...i})}static intersect(e,t,i={}){return this.combine(e,t,{clipType:this.CLIP_TYPES.INTERSECT,...i})}static combine(e,t,{clipType:i,canMutate:n,...s}={}){if(i!==this.CLIP_TYPES.INTERSECT&&i!==this.CLIP_TYPES.UNION)throw new Error("The Weiler-Atherton clipping algorithm only supports INTERSECT or UNION clip types.");n&&!e.isPositive&&e.reverseOrientation();const o=new this(e,t,i,s),r=o.#no();return r.length?o.#so(r):this.testForEnvelopment(e,t,i,s)}#so(e){const t=this.config.clipType,i=e.length;let n=e[i-1],s=n.type===this.constructor.INTERSECTION_TYPES.OUT_IN^t;const o=new PIXI.Polygon;for(let t=0;t<i;t+=1){const i=e[t];this.#oo(i,n,s,o),s=!s,n=i}return[o]}#oo(e,t,i,n){const s=this.config.clipOpts,o=i?e.leadingPoints:this.clipObject.pointsBetween(t,e,s);for(const e of o)n.addPoint(e);n.addPoint(e)}static testForEnvelopment(e,t,i,n){const s=e.points;if(s.length<6)return[];const o=i===this.CLIP_TYPES.UNION;let r=!0;for(let e=0;e<s.length;e+=2){const i={x:s[e],y:s[e+1]};if(!t.pointIsOn(i)){r=t.contains(i.x,i.y);break}}if(r)return o?[t.toPolygon(n)]:[e];const a=t.center;e instanceof PointSourcePolygon&&(e.bounds??=e.getBounds());return e.contains(a.x,a.y)?o?[e]:[t.toPolygon(n)]:o?[e,t.toPolygon(n)]:[]}#no(){const e=this.#ro();return e.length?WeilerAthertonClipper.#ao(e):[]}#ro(){const{polygon:e,clipObject:t}=this,i=e.points,n=i.length;if(n<6)return[];let s,o=-1;for(let e=0;e<n;e+=2)if(s={x:i[e],y:i[e+1]},!t.pointIsOn(s)){o=e;break}if(!~o)return[];let r,a,l=t.contains(s.x,s.y),c=0;const d=[s],u=this.constructor.INTERSECTION_TYPES,h=o+n+2;for(let e=o+2;e<h;e+=2){const o=e>=n?e%n:e,h={x:i[o],y:i[o+1]},p=t.segmentIntersections(s,h),g=p.length;let m=!1;if(g){m=h.x.almostEqual(p[g-1].x)&&h.y.almostEqual(p[g-1].y),m&&p.pop(),c+=p.length;for(const e of p)e.isIntersection=!0,e.type=r?-r.type:l?u.IN_OUT:u.OUT_IN,a=r,r=e;d.push(...p)}if(m)s=h;else{if(c){const e=t.contains(h.x,h.y);1&c^(e^l)&&(1===c?r.isIntersection=!1:(a.isIntersection=!1,r.type=a.type)),l=e,c=0,a=void 0,r=void 0}d.push(h),s=h}}return d}static#ao(e){const t=e.findIndex((e=>e.isIntersection));if(!~t)return[];const i=e.length;let n=[];const s=[];for(let o=0;o<i;o+=1){const r=e[(o+t)%i];r.isIntersection?(r.leadingPoints=n,n=[],s.push(r)):n.push(r)}return s[0].leadingPoints=n,s}}class Drawing extends PlaceableObject{texture;frame;text=null;shape;#lo=0;#co=foundry.utils.deepClone(this.document.shape.points);static embeddedName="Drawing";static RENDER_FLAGS={redraw:{propagate:["refresh"]},refresh:{propagate:["refreshState","refreshTransform","refreshText","refreshElevation"],alias:!0},refreshState:{},refreshTransform:{propagate:["refreshPosition","refreshRotation","refreshSize"],alias:!0},refreshPosition:{},refreshRotation:{propagate:["refreshFrame"]},refreshSize:{propagate:["refreshPosition","refreshFrame","refreshShape","refreshText"]},refreshShape:{},refreshText:{},refreshFrame:{},refreshElevation:{},refreshMesh:{propagate:["refreshTransform","refreshShape","refreshElevation"],deprecated:{since:12,until:14,alias:!0}}};static FREEHAND_SAMPLE_RATE=75;static SHAPE_TYPES=foundry.data.ShapeData.TYPES;get isAuthor(){return this.document.isAuthor}get isVisible(){return!this.document.hidden||this.isAuthor||c.user.isGM||this.isPreview}get bounds(){const{x:e,y:t,shape:i,rotation:n}=this.document;return 0===n?new PIXI.Rectangle(e,t,i.width,i.height).normalize():PIXI.Rectangle.fromRotation(e,t,i.width,i.height,Math.toRadians(n)).normalize()}get center(){const{x:e,y:t,shape:i}=this.document;return new PIXI.Point(e+i.width/2,t+i.height/2)}get isTiled(){return this.document.fillType===CONST.DRAWING_FILL_TYPES.PATTERN}get isPolygon(){return this.type===Drawing.SHAPE_TYPES.POLYGON}get hasText(){return(void 0!==this._pendingText||!!this.document.text)&&this.document.fontSize>0}get type(){return this.document.shape.type}_pendingText;_onkeydown=null;#do=!1;_destroy(e){this.#uo(this),this.texture?.destroy()}async _draw(e){const t=this.document.texture;this._original?this.texture=this._original.texture?.clone():this.texture=t?await loadTexture(t,{fallback:"icons/svg/hazard.svg"}):null,this.shape=this.#ho(),this.shape.visible=!0,this.frame=this.addChild(this.#po()),this.text=this.hasText?this.shape.addChild(this.#go()):null,this.cursor=this.document.isOwner?"pointer":null}#ho(){const e=this.document.interface?canvas.interface:canvas.primary;return(this.document.interface?canvas.primary:canvas.interface).removeDrawing(this),e.addDrawing(this)}#uo(){canvas.interface.removeDrawing(this),canvas.primary.removeDrawing(this)}#po(){const e=new PIXI.Container;return e.eventMode="passive",e.bounds=new PIXI.Rectangle,e.interaction=e.addChild(new PIXI.Container),e.interaction.hitArea=e.bounds,e.interaction.eventMode="auto",e.border=e.addChild(new PIXI.Graphics),e.border.eventMode="none",e.handle=e.addChild(new ResizeHandle([1,1])),e.handle.eventMode="static",e}#go(){const e=new PreciseText(this.document.text||"",this._getTextStyle());return e.eventMode="none",e}_getLineStyle(){const{strokeWidth:e,strokeColor:t,strokeAlpha:i}=this.document;return{width:e,color:t,alpha:i}}_getFillStyle(){const{fillType:e,fillColor:t,fillAlpha:i}=this.document,n={color:t,alpha:i};return e===CONST.DRAWING_FILL_TYPES.PATTERN&&this.texture?.valid?n.texture=this.texture:e||(n.alpha=0),n}_getTextStyle(){const{fontSize:e,fontFamily:t,textColor:i,shape:n}=this.document,s=Math.max(Math.round(e/32),2);return PreciseText.getTextStyle({fontFamily:t,fontSize:e,fill:i,strokeThickness:s,dropShadowBlur:Math.max(Math.round(e/16),2),align:"center",wordWrap:!0,wordWrapWidth:n.width,padding:4*s})}clone(){const e=super.clone();return e._pendingText=this._pendingText,e}_applyRenderFlags(e){e.refreshState&&this._refreshState(),e.refreshPosition&&this._refreshPosition(),e.refreshRotation&&this._refreshRotation(),e.refreshShape&&this._refreshShape(),e.refreshText&&this._refreshText(),e.refreshFrame&&this._refreshFrame(),e.refreshElevation&&this._refreshElevation()}_refreshPosition(){const{x:e,y:t,shape:{width:i,height:n}}=this.document;this.position.x===e&&this.position.y===t||MouseInteractionManager.emulateMoveEvent(),this.position.set(e,t),this.shape.position.set(e+i/2,t+n/2),this.shape.pivot.set(i/2,n/2),this.text&&(this.text.position.set(i/2,n/2),this.text.anchor.set(.5,.5))}_refreshRotation(){const e=Math.toRadians(this.document.rotation);this.shape.rotation=e}_refreshState(){const{hidden:e,locked:t,sort:i}=this.document,n=this.visible;this.visible=this.isVisible,this.visible!==n&&MouseInteractionManager.emulateMoveEvent(),this.alpha=this._getTargetAlpha();const s=g.Canvas.dispositionColors;this.frame.border.tint=this.controlled?t?s.HOSTILE:s.CONTROLLED:s.INACTIVE,this.frame.border.visible=this.controlled||this.hover||this.layer.highlightObjects,this.frame.handle.visible=this.controlled&&!t,this.zIndex=this.shape.zIndex=this.controlled?2:this.hover?1:0;const o=this.eventMode;this.eventMode=this.layer.active&&(this.controlled||["select","text"].includes(c.activeTool))?"static":"none",this.eventMode!==o&&MouseInteractionManager.emulateMoveEvent(),this.shape.visible=this.visible,this.shape.sort=i,this.shape.sortLayer=PrimaryCanvasGroup.SORT_LAYERS.DRAWINGS,this.shape.alpha=this.alpha*(e?.5:1),this.shape.hidden=e,this.text&&(this.text.alpha=this.document.textAlpha)}_refreshShape(){this.shape.clear(),this.shape.lineStyle(this._getLineStyle()),this.shape.beginTextureFill(this._getFillStyle());const e=this.shape.line.width,t=this.document.shape;switch(t.type){case Drawing.SHAPE_TYPES.RECTANGLE:this.shape.drawRect(e/2,e/2,Math.max(t.width-e,0),Math.max(t.height-e,0));break;case Drawing.SHAPE_TYPES.ELLIPSE:this.shape.drawEllipse(t.width/2,t.height/2,Math.max(t.width-e,0)/2,Math.max(t.height-e,0)/2);break;case Drawing.SHAPE_TYPES.POLYGON:this.document.fillType||t.points.slice(0,2).equals(t.points.slice(-2))?this.shape.drawSmoothedPolygon(t.points,2*this.document.bezierFactor):this.shape.drawSmoothedPath(t.points,2*this.document.bezierFactor)}this.shape.endFill(),this.shape.line.reset()}_refreshElevation(){this.shape.elevation=this.document.elevation}_refreshFrame(){const e=g.Canvas.objectBorderThickness,{shape:{width:t,height:i},rotation:n}=this.document,s=this.frame.bounds;s.x=0,s.y=0,s.width=t,s.height=i,s.rotate(Math.toRadians(n));const o=.25*e;s.width<o&&(s.x-=(o-s.width)/2,s.width=o),s.height<o&&(s.y-=(o-s.height)/2,s.height=o),MouseInteractionManager.emulateMoveEvent();const r=this.frame.border;r.clear(),r.lineStyle({width:e,color:0,join:PIXI.LINE_JOIN.ROUND,alignment:.75}).drawShape(s),r.lineStyle({width:e/2,color:16777215,join:PIXI.LINE_JOIN.ROUND,alignment:1}).drawShape(s),this.frame.handle.refresh(s)}_refreshText(){if(!this.text)return;const{text:e,textAlpha:t}=this.document;this.text.text=this._pendingText??e??"",this.text.alpha=t,this.text.style=this._getTextStyle()}_addPoint(e,{round:t=!1,snap:i=!1,temporary:n=!1}={}){i&&(e=this.layer.getSnappedPoint(e)),t&&(e.x=Math.round(e.x),e.y=Math.round(e.y));const s=this.#co.slice(-2),o=[e.x-this.document.x,e.y-this.document.y];if(o.equals(s))return;const r=this.#co.concat(o);this.document.shape.updateSource({points:r}),n||(this.#co=r,this.#lo=Date.now())}_removePoint(){this.#co.splice(-2),this.document.shape.updateSource({points:this.#co})}_onControl(e){super._onControl(e),this.enableTextEditing(e)}_onRelease(e){super._onRelease(e),this._onkeydown&&(document.removeEventListener("keydown",this._onkeydown),this._onkeydown=null),canvas.scene.drawings.has(this.id)&&(""===this._pendingText&&this.#do?this.document.delete():void 0!==this._pendingText&&(this.#do=!1,this.document.update({text:this._pendingText}).then((()=>{this._pendingText=void 0,this.renderFlags.set({redraw:this.hasText===!this.text,refreshText:!0})}))))}_overlapsSelection(e){if(!this.frame)return!1;return new PIXI.Rectangle(e.x-this.document.x,e.y-this.document.y,e.width,e.height).overlaps(this.frame.bounds)}enableTextEditing(e={}){("text"===c.activeTool||e.forceTextEditing)&&(this._pendingText=this.document.text||"",this._onkeydown=this.#mo.bind(this),document.addEventListener("keydown",this._onkeydown),e.isNew&&(this.#do=!0),this.renderFlags.set({refreshPosition:!this.text,refreshText:!0}),this.text??=this.shape.addChild(this.#go()))}#mo(e){if(e.altKey||e.ctrlKey||e.metaKey)return;if(c.keyboard.hasFocus)return;let t=!1,i=!1;["Escape","Enter"].includes(e.key)?t=!0:"Backspace"===e.key?(this._pendingText=this._pendingText.slice(0,-1),i=!0):/^.$/.test(e.key)&&(this._pendingText+=e.key,i=!0),(i||t)&&(e.preventDefault(),e.stopPropagation()),t?this.release():i&&this.renderFlags.set({refreshText:!0})}_onUpdate(e,t,i){super._onUpdate(e,t,i),"text"in e&&void 0!==this._pendingText&&(this._pendingText=this.document.text||""),this.shape?.parent&&("elevation"in e||"sort"in e)&&(this.shape.parent.sortDirty=!0),this.renderFlags.set({redraw:"interface"in e||"texture"in e||"text"in e&&this.hasText===!this.text,refreshState:"sort"in e||"hidden"in e||"locked"in e,refreshPosition:"x"in e||"y"in e,refreshRotation:"rotation"in e,refreshSize:"shape"in e&&("width"in e.shape||"height"in e.shape),refreshElevation:"elevation"in e,refreshShape:["shape","bezierFactor","strokeWidth","strokeColor","strokeAlpha","fillType","fillColor","fillAlpha"].some((t=>t in e)),refreshText:["text","fontFamily","fontSize","textColor","textAlpha"].some((t=>t in e))})}_onDelete(e,t){super._onDelete(e,t),this._onkeydown&&document.removeEventListener("keydown",this._onkeydown)}activateListeners(){super.activateListeners(),this.frame.handle.off("pointerover").off("pointerout").on("pointerover",this._onHandleHoverIn.bind(this)).on("pointerout",this._onHandleHoverOut.bind(this))}_canControl(e,t){return!(!this.layer.active||this.isPreview)&&(this._creating?(delete this._creating,!0):!!this.controlled||!!["select","text"].includes(c.activeTool)&&(e.isGM||e===this.document.author))}_canConfigure(e,t){return this.controlled}_onMouseDraw(e){const{destination:t,origin:i}=e.interactionData,n=e.shiftKey,s=e.altKey;let o=t;if(this.type===Drawing.SHAPE_TYPES.POLYGON){const e="freehand"===c.activeTool;let t=!0;if(e){t=Date.now()-this.#lo<this.constructor.FREEHAND_SAMPLE_RATE}const i=!(n||e);this._addPoint(o,{snap:i,temporary:t})}else{n||(o=this.layer.getSnappedPoint(o));const e=this.document.shape,t=.5*canvas.dimensions.size;let r=o.x-i.x,a=o.y-i.y;Math.abs(r)<t&&(r=t*Math.sign(e.width)),Math.abs(a)<t&&(a=t*Math.sign(e.height)),s&&(r=Math.abs(a)<Math.abs(r)?Math.abs(a)*Math.sign(r):r,a=Math.abs(r)<Math.abs(a)?Math.abs(r)*Math.sign(a):a);const l=new PIXI.Rectangle(i.x,i.y,r,a).normalize();this.document.updateSource({x:l.x,y:l.y,shape:{width:l.width,height:l.height}})}this.renderFlags.set({refreshPosition:!0,refreshSize:!0})}_onClickLeft(e){return e.target===this.frame.handle?(e.interactionData.dragHandle=!0,void e.stopPropagation()):super._onClickLeft(e)}_onDragLeftStart(e){return e.interactionData.dragHandle?this._onHandleDragStart(e):super._onDragLeftStart(e)}_onDragLeftMove(e){return e.interactionData.dragHandle?this._onHandleDragMove(e):super._onDragLeftMove(e)}_onDragLeftDrop(e){return e.interactionData.dragHandle?this._onHandleDragDrop(e):super._onDragLeftDrop(e)}_onDragLeftCancel(e){return e.interactionData.dragHandle?this._onHandleDragCancel(e):super._onDragLeftCancel(e)}_onHandleHoverIn(e){const t=e.target;t?.scale.set(1.5,1.5)}_onHandleHoverOut(e){const t=e.target;t?.scale.set(1,1)}_onHandleDragStart(e){e.interactionData.originalData=this.document.toObject();const t=this.frame.handle;e.interactionData.handleOrigin={x:t.position.x,y:t.position.y}}_onHandleDragMove(e){canvas._onDragCanvasPan(e);const{destination:t,origin:i,handleOrigin:n,originalData:s}=e.interactionData;let o={x:n.x+(t.x-i.x),y:n.y+(t.y-i.y)};e.shiftKey||(o=this.layer.getSnappedPoint(o));const r=o.x-n.x,a=o.y-n.y,l=Drawing.rescaleDimensions(s,r,a);this.document.updateSource(l),this.document.rotation=0,this.renderFlags.set({refreshTransform:!0})}_onHandleDragDrop(e){e.interactionData.restoreOriginalData=!1;const{destination:t,origin:i,handleOrigin:n,originalData:s}=e.interactionData;let o={x:n.x+(t.x-i.x),y:n.y+(t.y-i.y)};e.shiftKey||(o=this.layer.getSnappedPoint(o));const r=o.x-n.x,a=o.y-n.y,l=Drawing.rescaleDimensions(s,r,a);this.document.update(l,{diff:!1}).then((()=>this.renderFlags.set({refreshTransform:!0})))}_onHandleDragCancel(e){!1!==e.interactionData.restoreOriginalData&&(this.document.updateSource(e.interactionData.originalData),this.renderFlags.set({refreshTransform:!0}))}static rescaleDimensions(e,t,i){let{type:n,points:s,width:o,height:r}=e.shape;if(o+=t,r+=i,s=s||[],n===Drawing.SHAPE_TYPES.POLYGON){const n=1+(e.shape.width>0?t/e.shape.width:0),o=1+(e.shape.height>0?i/e.shape.height:0);s=s.map(((e,t)=>e*(t%2?o:n)))}return this.normalizeShape({x:e.x,y:e.y,shape:{width:Math.round(o),height:Math.round(r),points:s}})}static normalizeShape(e){const t=e.shape.points;if(t?.length){const i=[],n=[];for(let e=1;e<t.length;e+=2){const s=t[e-3],o=t[e-2],r=t[e-1],a=t[e];r===s&&a===o||(i.push(r),n.push(a))}const s=Math.min(...i),o=Math.max(...i),r=Math.min(...n),a=Math.max(...n),l=[];for(let e=0;e<i.length;e++)l.push(i[e]-s,n[e]-r);e.x+=s,e.y+=r,e.shape.width=o-s,e.shape.height=a-r,e.shape.points=l}else{const t=new PIXI.Rectangle(e.x,e.y,e.shape.width,e.shape.height).normalize();e.x=t.x,e.y=t.y,e.shape.width=t.width,e.shape.height=t.height}return e}}class Region extends PlaceableObject{constructor(e){super(e),this.#ht()}static embeddedName="Region";static RENDER_FLAGS={redraw:{propagate:["refresh"]},refresh:{propagate:["refreshState","refreshBorder"],alias:!0},refreshState:{},refreshBorder:{}};static{Object.defineProperty(this,"CLIPPER_SCALING_FACTOR",{value:100}),Object.defineProperty(this,"MOVEMENT_SEGMENT_TYPES",{value:Object.freeze({EXIT:-1,MOVE:0,ENTER:1})})}static#fo=new PIXI.Point;get shapes(){return this.#vo??=this.document.shapes.map((e=>foundry.canvas.regions.RegionShape.create(e)))}#vo;get bottom(){return this.document.elevation.bottom??-1/0}get top(){return this.document.elevation.top??1/0}get polygons(){return this.#yo??=Array.from(this.polygonTree,(e=>e.polygon))}#yo;get polygonTree(){return this.#bo??=foundry.canvas.regions.RegionPolygonTree._fromClipperPolyTree(this.#So())}#bo;get clipperPaths(){return this.#To??=Array.from(this.polygonTree,(e=>e.clipperPath))}#To;get triangulation(){let e=this.#Eo;if(!this.#Eo){let t=0,i=0;for(const e of this.polygonTree)i+=e.points.length;const n=new Float32Array(i),s=[];for(const e of this.polygonTree){if(e.isHole)continue;const i=[];let o=e.points;for(const t of e.children)i.push(o.length/2),o=o.concat(t.points);const r=PIXI.utils.earcut(o,i,2),a=t/2;for(let e=0;e<r.length;e++)s.push(r[e]+a);for(let e=0;e<o.length;e++)n[t++]=o[e]}const o=new(i/2>65536?Uint32Array:Uint16Array)(s);this.#Eo=e={vertices:n,indices:o}}return e}#Eo;get geometry(){return this.#ei}#ei=new foundry.canvas.regions.RegionGeometry(this);get bounds(){let e=this.#Co;if(!e){const t=this.polygonTree.children;if(0===t.length)e=new PIXI.Rectangle;else{e=t[0].bounds.clone();for(let i=1;i<t.length;i++)e.enlarge(t[i].bounds)}this.#Co=e}return e.clone()}#Co;get center(){const{x:e,y:t}=this.bounds.center;return new PIXI.Point(e,t)}get isVisible(){if(this.sheet?.rendered)return!0;if(!this.layer.legend._isRegionVisible(this))return!1;const e=CONST.REGION_VISIBILITY;switch(this.document.visibility){case e.LAYER:return this.layer.active;case e.GAMEMASTER:return c.user.isGM;case e.ALWAYS:return!0;default:throw new Error("Invalid visibility")}}#Vn;#_o;getSnappedPosition(e){throw new Error("Region#getSnappedPosition is not supported: RegionDocument does not have a (x, y) position")}#ht(){this.#Io()}async _draw(e){this.#Vn=this.addChild(new foundry.canvas.regions.RegionMesh(this,HighlightRegionShader)),this.#Vn.eventMode="auto",this.#Vn.shader.uniforms.hatchThickness=canvas.dimensions.size/25,this.#Vn.alpha=.5,this.#_o=this.addChild(new PIXI.Graphics),this.#_o.eventMode="none",this.cursor="pointer"}_applyRenderFlags(e){e.refreshState&&this._refreshState(),e.refreshBorder&&this._refreshBorder()}_refreshState(){const e=this.visible;this.visible=this.isVisible,this.visible!==e&&MouseInteractionManager.emulateMoveEvent(),this.zIndex=this.controlled?2:this.hover?1:0;const t=this.eventMode;this.eventMode=this.layer.active&&"select"===c.activeTool?"static":"none",this.eventMode!==t&&MouseInteractionManager.emulateMoveEvent();const{locked:i,color:n}=this.document;this.#Vn.tint=n,this.#Vn.shader.uniforms.hatchEnabled=!this.controlled&&!this.hover;const s=g.Canvas.dispositionColors;this.#_o.tint=this.controlled?i?s.HOSTILE:s.CONTROLLED:s.INACTIVE,this.#_o.visible=this.controlled||this.hover||this.layer.highlightObjects}_refreshBorder(){const e=g.Canvas.objectBorderThickness;this.#_o.clear();for(const t of[{width:e,color:0,join:PIXI.LINE_JOIN.ROUND,alignment:.75},{width:e/2,color:16777215,join:PIXI.LINE_JOIN.ROUND,alignment:1}]){this.#_o.lineStyle(t);for(const e of this.polygonTree)if(!e.isHole){this.#_o.drawShape(e.polygon),this.#_o.beginHole();for(const t of e.children)this.#_o.drawShape(t.polygon);this.#_o.endHole()}}}_canDrag(e,t){return!1}_canHUD(e,t){return!1}_onControl(e){super._onControl(e),this.layer.legend.render()}_onRelease(e){super._onRelease(e),this.layer.active&&(ui.controls.initialize({tool:"select"}),this.layer.legend.render())}_onHoverIn(e,{updateLegend:t=!0,...i}={}){return t&&this.layer.legend._hoverRegion(this,!0),super._onHoverIn(e,i)}_onHoverOut(e,{updateLegend:t=!0,...i}={}){return t&&this.layer.legend._hoverRegion(this,!1),super._onHoverOut(e)}_overlapsSelection(e){if(!e.intersects(this.bounds))return!1;const t=Region.CLIPPER_SCALING_FACTOR,i=Math.round(e.left*t),n=Math.round(e.top*t),s=Math.round(e.right*t),o=Math.round(e.bottom*t);if(i===s||n===o)return!1;const r=[new ClipperLib.IntPoint(i,n),new ClipperLib.IntPoint(s,n),new ClipperLib.IntPoint(s,o),new ClipperLib.IntPoint(i,o)],a=new ClipperLib.Clipper,l=[];return a.Clear(),a.AddPath(r,ClipperLib.PolyType.ptSubject,!0),a.AddPaths(this.clipperPaths,ClipperLib.PolyType.ptClip,!0),a.Execute(ClipperLib.ClipType.ctIntersection,l),0!==l.length}testPoint(e,t){return(void 0===t||this.bottom<=t&&t<=this.top)&&this.polygonTree.testPoint(e)}#Io(){this.#vo=void 0,this.#yo=void 0,this.#bo=void 0,this.#To=void 0,this.#Co=void 0,this.#Eo=void 0,this.#ei?._clearBuffers()}#So(){const e=this.shapes.findIndex((e=>!e.isHole));if(e<0)return new ClipperLib.PolyTree;if(e===this.shapes.length-1){const t=this.shapes[e];return t.isHole?new ClipperLib.PolyTree:t.clipperPolyTree}const t=new ClipperLib.Clipper,i=this.#wo();if(0===i.length)return new ClipperLib.PolyTree;if(1===i.length){const e=i[0],n=new ClipperLib.PolyTree;return t.AddPaths(e.paths,ClipperLib.PolyType.ptClip,!0),t.Execute(e.clipType,n,ClipperLib.PolyFillType.pftNonZero,e.fillType),n}let n=i[0].paths,s=i[0].fillType;for(let e=1;e<i.length;e++){const o=i[e],r=e===i.length-1?new ClipperLib.PolyTree:[];t.Clear(),t.AddPaths(n,ClipperLib.PolyType.ptSubject,!0),t.AddPaths(o.paths,ClipperLib.PolyType.ptClip,!0),t.Execute(o.clipType,r,s,o.fillType),n=r,s=ClipperLib.PolyFillType.pftNonZero}return n}#wo(){const e=[],t=this.shapes;let i=0;for(;i<t.length&&t[i].isHole;)i++;for(;i<t.length;){const n=[],s=t[i].isHole;do{for(const e of t[i].clipperPaths)n.push(e);i++}while(i<t.length&&t[i].isHole===s);e.push({paths:n,fillType:ClipperLib.PolyFillType.pftNonZero,clipType:s?ClipperLib.ClipType.ctDifference:ClipperLib.ClipType.ctUnion})}return e}segmentizeMovement(e,t,{teleport:i=!1}={}){if(0===t.length)return[];let n=[];for(let s=1;s<e.length;s++)for(const o of this.#Do(e[s-1],e[s],t,i))n.push(o);return n}#Do(e,t,i,n){const s=Math.round(e.x),o=Math.round(e.y),r=e.elevation,a=Math.round(t.x),l=Math.round(t.y),c=t.elevation;if(s===a&&o===l&&r===c)return[];if(n){const e=this.#Oo(s,o,r,a,l,c,i);return e?[e]:[]}if(r===c)return this.bottom<=r&&r<=this.top?this.#xo(s,o,r,a,l,c,i):[];const d=r<c,u=d?Math.max(r,this.bottom):Math.min(r,this.top),h=d?Math.min(c,this.top):Math.max(c,this.bottom),p=(u-r)/(c-r),g=(h-r)/(c-r);if(p>g)return[];const m=Math.round(Math.mix(s,a,p)),v=Math.round(Math.mix(o,l,p)),y=Math.round(Math.mix(s,a,g)),b=Math.round(Math.mix(o,l,g)),S=this.#xo(m,v,u,y,b,h,i);if(r!==u&&this.#No(m,v,i)){const e=this.document.parent.grid,t=Math.min(Math.abs(r-u),e.distance/e.size);S.unshift({type:Region.MOVEMENT_SEGMENT_TYPES.ENTER,from:{x:m,y:v,elevation:u-(d?t:-t)},to:{x:m,y:v,elevation:u}})}if(c!==h&&this.#No(y,b,i)){const e=this.document.parent.grid,t=Math.min(Math.abs(c-h),e.distance/e.size);S.push({type:Region.MOVEMENT_SEGMENT_TYPES.EXIT,from:{x:y,y:b,elevation:h},to:{x:y,y:b,elevation:h+(d?t:-t)}})}return S}#Oo(e,t,i,n,s,o,r){const a=e!==n||t!==s;if(!a&&!(i!==o))return;const{bottom:l,top:c}=this;let d,u=l<=i&&i<=c,h=l<=o&&o<=c;if(a)u&&=this.#No(e,t,r),h&&=this.#No(n,s,r);else if(u||h){const i=this.#No(e,t,r);u&&=i,h&&=i}if(u&&h)d=Region.MOVEMENT_SEGMENT_TYPES.MOVE;else if(u)d=Region.MOVEMENT_SEGMENT_TYPES.EXIT;else{if(!h)return;d=Region.MOVEMENT_SEGMENT_TYPES.ENTER}return{type:d,from:{x:e,y:t,elevation:i},to:{x:n,y:s,elevation:o}}}#No(e,t,i){const n=Region.#fo,s=i.length;for(let o=0;o<s;o++){const s=i[o];if(this.#bo.testPoint(n.set(e+s.x,t+s.y)))return!0}return!1}#xo(e,t,i,n,s,o,r){const a=[];if(e===n&&t===s)return i!==o&&this.#No(e,t,r)&&a.push({type:Region.MOVEMENT_SEGMENT_TYPES.MOVE,from:{x:e,y:t,elevation:i},to:{x:n,y:s,elevation:o}}),a;if(!this.#Ao(e,t,n,s,r))return a;const l=this.#Ro(e,t,n,s,r);for(const{start:c,end:d}of l){const l=Math.round(Math.mix(e,n,c)),u=Math.round(Math.mix(t,s,c)),h=Math.mix(i,o,c),p=Math.round(Math.mix(e,n,d)),g=Math.round(Math.mix(t,s,d)),m=Math.mix(i,o,d),[{x:v,y:y,inside:b},{x:S,y:T,inside:E}]=this.#Po(e,t,l,u,p,g,r,!0),[{x:C,y:_,inside:I},{x:w,y:D,inside:O}]=this.#Po(l,u,p,g,n,s,r,!1);b!==E&&a.push({type:Region.MOVEMENT_SEGMENT_TYPES.ENTER,from:{x:v,y:y,elevation:h},to:{x:S,y:T,elevation:h}}),!E&&!I||S===C&&T===_||a.push({type:E&&I?Region.MOVEMENT_SEGMENT_TYPES.MOVE:I?Region.MOVEMENT_SEGMENT_TYPES.ENTER:Region.MOVEMENT_SEGMENT_TYPES.EXIT,from:{x:S,y:T,elevation:h},to:{x:C,y:_,elevation:m}}),I!==O&&a.push({type:Region.MOVEMENT_SEGMENT_TYPES.EXIT,from:{x:C,y:_,elevation:m},to:{x:w,y:D,elevation:m}})}const c=this.#No(e,t,r),d=this.#No(n,s,r);if(!c&&!d)return a;if(0===a.length){if(c){const[{x:o,y:l},{x:c,y:d,inside:u}]=this.#Po(e,t,e,t,n,s,r,!1);u||(e===o&&t===l||a.push({type:Region.MOVEMENT_SEGMENT_TYPES.MOVE,from:{x:e,y:t,elevation:i},to:{x:o,y:l,elevation:i}}),a.push({type:Region.MOVEMENT_SEGMENT_TYPES.EXIT,from:{x:o,y:l,elevation:i},to:{x:c,y:d,elevation:i}}))}if(d){const[{x:i,y:l,inside:c},{x:d,y:u}]=this.#Po(e,t,n,s,n,s,r,!0);c||(a.push({type:Region.MOVEMENT_SEGMENT_TYPES.ENTER,from:{x:i,y:l,elevation:o},to:{x:d,y:u,elevation:o}}),n===d&&s===u||a.push({type:Region.MOVEMENT_SEGMENT_TYPES.MOVE,from:{x:d,y:u,elevation:o},to:{x:n,y:s,elevation:o}}))}c&&d&&0===a.length&&a.push({type:Region.MOVEMENT_SEGMENT_TYPES.MOVE,from:{x:e,y:t,elevation:i},to:{x:n,y:s,elevation:o}})}else{if(c){const n=a.at(0),{x:s,y:o}=n.from;if(e!==s||t!==o)if(1===n.type){const[{x:n,y:l},{x:c,y:d}]=this.#Po(s,o,e,t,e,t,r,!1);a.unshift({type:Region.MOVEMENT_SEGMENT_TYPES.EXIT,from:{x:n,y:l,elevation:i},to:{x:c,y:d,elevation:i}})}else n.from.x=e,n.from.y=t}if(d){const e=a.at(-1),{x:t,y:i}=e.to;if(n!==t||s!==i)if(-1===e.type){const[{x:e,y:l},{x:c,y:d}]=this.#Po(t,i,n,s,n,s,r,!0);a.push({type:Region.MOVEMENT_SEGMENT_TYPES.ENTER,from:{x:e,y:l,elevation:o},to:{x:c,y:d,elevation:o}})}else e.to.x=n,e.to.y=s}}return a}#Ao(e,t,i,n,s){let{x:o,y:r}=s[0],a=o,l=r;for(let e=1;e<s.length;e++){const{x:t,y:i}=s[e];o=Math.min(o,t),r=Math.min(r,i),a=Math.max(a,t),l=Math.max(l,i)}o+=Math.min(e,i),r+=Math.min(t,n),a+=Math.max(e,i),l+=Math.max(t,n);const{left:c,right:d,top:u,bottom:h}=this.bounds;return Math.max(o,c-1)<=Math.min(a,d+1)&&Math.max(r,u-1)<=Math.min(l,h+1)}#Ro(e,t,i,n,s){const o=Region.CLIPPER_SCALING_FACTOR,r=[],a=new ClipperLib.Clipper,l=new ClipperLib.PolyTree,c=new ClipperLib.IntPoint(0,0),d=new ClipperLib.IntPoint(0,0),u=[c,d];for(const{x:h,y:p}of s){c.X=Math.round((e+h)*o),c.Y=Math.round((t+p)*o),d.X=Math.round((i+h)*o),d.Y=Math.round((n+p)*o),a.Clear(),a.AddPath(u,ClipperLib.PolyType.ptSubject,!1),a.AddPaths(this.clipperPaths,ClipperLib.PolyType.ptClip,!0),a.Execute(ClipperLib.ClipType.ctIntersection,l);const s=Math.hypot(d.X-c.X,d.Y-c.Y);for(const[e,t]of ClipperLib.Clipper.PolyTreeToPaths(l)){let i=Math.hypot(e.X-c.X,e.Y-c.Y)/s,n=Math.hypot(t.X-c.X,t.Y-c.Y)/s;i>n&&([i,n]=[n,i]),r.push({start:i,end:n})}}r.sort(((e,t)=>e.start-t.start));const h=[];if(0!==r.length){let e=r[0];h.push(e);for(let t=1;t<r.length;t++){const i=r[t];e.end<i.start?h.push(e=i):e.end=Math.max(e.end,i.end)}}return h}#Po(e,t,i,n,s,o,r,a){let l,c,d=i,u=n,h=d,p=u;const g=this.#No(i,n,r);g===a?(l=e,c=t):(l=s,c=o);const m=h<l?1:-1,v=p<c?1:-1,y=Math.abs(h-l),b=0-Math.abs(p-c);let S=y+b;for(;h!==l||p!==c;){const e=2*S;if(e<=y&&(S+=y,p+=v),e>=b&&(S+=b,h+=m),this.#No(h,p,r)!==g)return g===a?[{x:h,y:p,inside:!g},{x:d,y:u,inside:g}]:[{x:d,y:u,inside:g},{x:h,y:p,inside:!g}];d=h,u=p}return[{x:h,y:p,inside:g},{x:h,y:p,inside:g}]}_onUpdate(e,t,i){super._onUpdate(e,t,i),"shapes"in e&&this.#Io(),this.renderFlags.set({refreshState:"color"in e||"visibility"in e||"locked"in e,refreshBorder:"shapes"in e})}}class Tile extends PlaceableObject{static embeddedName="Tile";static RENDER_FLAGS={redraw:{propagate:["refresh"]},refresh:{propagate:["refreshState","refreshTransform","refreshMesh","refreshElevation","refreshVideo"],alias:!0},refreshState:{propagate:["refreshPerception"]},refreshTransform:{propagate:["refreshPosition","refreshRotation","refreshSize"],alias:!0},refreshPosition:{propagate:["refreshPerception"]},refreshRotation:{propagate:["refreshPerception","refreshFrame"]},refreshSize:{propagate:["refreshPosition","refreshFrame"]},refreshMesh:{},refreshFrame:{},refreshElevation:{propagate:["refreshPerception"]},refreshPerception:{},refreshVideo:{},refreshShape:{propagate:["refreshTransform","refreshMesh","refreshElevation"],deprecated:{since:12,until:14,alias:!0}}};frame;texture;bg;mesh;#ko=!1;#Mo={playVideo:void 0,offset:void 0};get aspectRatio(){if(!this.texture)return 1;let e=this.texture.baseTexture;return e.width/e.height}get bounds(){let{x:e,y:t,width:i,height:n,texture:s,rotation:o}=this.document;if(1!==s.scaleX){const t=i;i*=Math.abs(s.scaleX),e+=(t-i)/2}if(1!==s.scaleY){const e=n;n*=Math.abs(s.scaleY),t+=(e-n)/2}return 0!==o?PIXI.Rectangle.fromRotation(e,t,i,n,Math.toRadians(o)).normalize():new PIXI.Rectangle(e,t,i,n).normalize()}get sourceElement(){return this.texture?.baseTexture.resource.source}get isVideo(){const e=this.sourceElement;return"VIDEO"===e?.tagName}get isVisible(){return!this.document.hidden||c.user.isGM}get occluded(){return this.mesh?.occluded??!1}get playing(){return this.isVideo&&!this.sourceElement.paused}get volume(){return this.document.video.volume*c.settings.get("core","globalAmbientVolume")}_overlapsSelection(e){if(!this.frame)return!1;return new PIXI.Rectangle(e.x-this.document.x,e.y-this.document.y,e.width,e.height).overlaps(this.frame.bounds)}static createPreview(e){e.width=e.height=1,e.elevation=e.elevation??(ui.controls.control.foreground?canvas.scene.foregroundElevation:0),e.sort=Math.max(canvas.tiles.getMaxSort()+1,0);const t=new(getDocumentClass("Tile"))(e,{parent:canvas.scene}).object;return t.control({releaseOthers:!1}),t.draw().then((()=>{t.removeChild(t.frame),t.addChild(t.frame)})),t}async _draw(e={}){let t;this._original?t=this._original.texture?.clone():this.document.texture.src&&(t=await loadTexture(this.document.texture.src,{fallback:"icons/svg/hazard.svg"}));let i=c.video.getVideoSource(t);this.#ko=!!i&&!this._original,this.#ko&&(t=await c.video.cloneTexture(i),i=c.video.getVideoSource(t),!1!==this.document.getFlag("core","randomizeVideo")&&Number.isFinite(i.duration)&&(i.currentTime=Math.random()*i.duration)),i||(this.#Mo.playVideo=void 0),this.#Mo.offset=void 0,this.texture=t,this.texture?(this.mesh=canvas.primary.addTile(this),this.bg=void 0):(canvas.primary.removeTile(this),this.texture=this.mesh=null,this.bg=this.addChild(new PIXI.Graphics),this.bg.eventMode="none"),this.frame=this.addChild(this.#po()),this.cursor=this.document.isOwner?"pointer":null}#po(){const e=new PIXI.Container;return e.eventMode="passive",e.bounds=new PIXI.Rectangle,e.interaction=e.addChild(new PIXI.Container),e.interaction.hitArea=e.bounds,e.interaction.eventMode="auto",e.border=e.addChild(new PIXI.Graphics),e.border.eventMode="none",e.handle=e.addChild(new ResizeHandle([1,1])),e.handle.eventMode="static",e}clear(e){this.#ko&&this.texture?.baseTexture?.destroy(),this.#ko=!1,super.clear(e)}_destroy(e){canvas.primary.removeTile(this),this.texture&&(this.#ko&&this.texture?.baseTexture?.destroy(),this.texture=void 0,this.#ko=!1)}_applyRenderFlags(e){e.refreshState&&this._refreshState(),e.refreshPosition&&this._refreshPosition(),e.refreshRotation&&this._refreshRotation(),e.refreshSize&&this._refreshSize(),e.refreshMesh&&this._refreshMesh(),e.refreshFrame&&this._refreshFrame(),e.refreshElevation&&this._refreshElevation(),e.refreshPerception&&this.#Lo(),e.refreshVideo&&this._refreshVideo()}_refreshPosition(){const{x:e,y:t,width:i,height:n}=this.document;if(this.position.x===e&&this.position.y===t||MouseInteractionManager.emulateMoveEvent(),this.position.set(e,t),!this.mesh)return this.bg.position.set(i/2,n/2),void this.bg.pivot.set(i/2,n/2);this.mesh.position.set(e+i/2,t+n/2)}_refreshRotation(){const e=this.document.rotation;if(!this.mesh)return this.bg.angle=e;this.mesh.angle=e}_refreshSize(){const{width:e,height:t,texture:{fit:i,scaleX:n,scaleY:s}}=this.document;if(!this.mesh)return this.bg.clear().beginFill(16777215,.5).drawRect(0,0,e,t).endFill();this.mesh.resize(e,t,{fit:i,scaleX:n,scaleY:s})}_refreshState(){const{hidden:e,locked:t,elevation:i,sort:n}=this.document;this.visible=this.isVisible,this.alpha=this._getTargetAlpha(),this.bg&&(this.bg.visible=this.layer.active);const s=g.Canvas.dispositionColors;this.frame.border.tint=this.controlled?t?s.HOSTILE:s.CONTROLLED:s.INACTIVE,this.frame.border.visible=this.controlled||this.hover||this.layer.highlightObjects,this.frame.handle.visible=this.controlled&&!t;const o=this.layer.active&&!!ui.controls.control.foreground,r=i>=this.document.parent.foregroundElevation,a=this.eventMode;this.eventMode=r===o?"static":"none",this.eventMode!==a&&MouseInteractionManager.emulateMoveEvent();const l=this.zIndex=this.controlled?2:this.hover?1:0;this.mesh&&(this.mesh.visible=this.visible,this.mesh.sort=n,this.mesh.sortLayer=PrimaryCanvasGroup.SORT_LAYERS.TILES,this.mesh.zIndex=l,this.mesh.alpha=this.alpha*(e?.5:1),this.mesh.hidden=e,this.mesh.restrictsLight=this.document.restrictions.light,this.mesh.restrictsWeather=this.document.restrictions.weather)}_refreshMesh(){if(!this.mesh)return;const{width:e,height:t,alpha:i,occlusion:n,texture:s}=this.document,{anchorX:o,anchorY:r,fit:a,scaleX:l,scaleY:c,tint:d,alphaThreshold:u}=s;this.mesh.anchor.set(o,r),this.mesh.resize(e,t,{fit:a,scaleX:l,scaleY:c}),this.mesh.unoccludedAlpha=i,this.mesh.occludedAlpha=n.alpha,this.mesh.occlusionMode=n.mode,this.mesh.hoverFade=this.mesh.isOccludable,this.mesh.tint=d,this.mesh.textureAlphaThreshold=u}_refreshElevation(){this.mesh&&(this.mesh.elevation=this.document.elevation)}#Lo(){this.mesh&&canvas.perception.update({refreshOcclusionStates:!0})}_refreshFrame(){const e=g.Canvas.objectBorderThickness,{width:t,height:i,rotation:n}=this.document,s=this.frame.bounds;s.x=0,s.y=0,s.width=t,s.height=i,s.rotate(Math.toRadians(n));const o=.25*e;s.width<o&&(s.x-=(o-s.width)/2,s.width=o),s.height<o&&(s.y-=(o-s.height)/2,s.height=o),MouseInteractionManager.emulateMoveEvent();const r=this.frame.border;r.clear(),r.lineStyle({width:e,color:0,join:PIXI.LINE_JOIN.ROUND,alignment:.75}).drawShape(s),r.lineStyle({width:e/2,color:16777215,join:PIXI.LINE_JOIN.ROUND,alignment:1}).drawShape(s),this.frame.handle.refresh(s)}_refreshVideo(){if(!this.texture||!this.#ko)return;const e=c.video.getVideoSource(this.texture);if(!e)return;const t={...this.document.video,volume:this.volume};t.playing=this.#Mo.playVideo??t.autoplay,t.offset=this.#Mo.offset,this.#Mo.offset=void 0,c.video.play(e,t),this.hasActiveHUD&&this.layer.hud.render()}_onUpdate(e,t,i){super._onUpdate(e,t,i);const n="restrictions"in e&&!foundry.utils.isEmpty(e.restrictions);this.renderFlags.set({redraw:"texture"in e&&"src"in e.texture,refreshState:"sort"in e||"hidden"in e||"locked"in e||n,refreshPosition:"x"in e||"y"in e,refreshRotation:"rotation"in e,refreshSize:"width"in e||"height"in e,refreshMesh:"alpha"in e||"occlusion"in e||"texture"in e,refreshElevation:"elevation"in e,refreshPerception:"occlusion"in e&&"mode"in e.occlusion,refreshVideo:"video"in e||"playVideo"in t||"offset"in t}),"playVideo"in t&&(this.#Mo.playVideo=t.playVideo),"offset"in t&&(this.#Mo.offset=t.offset)}activateListeners(){super.activateListeners(),this.frame.handle.off("pointerover").off("pointerout").on("pointerover",this._onHandleHoverIn.bind(this)).on("pointerout",this._onHandleHoverOut.bind(this))}_onClickLeft(e){return e.target===this.frame.handle?(e.interactionData.dragHandle=!0,void e.stopPropagation()):super._onClickLeft(e)}_onDragLeftStart(e){return e.interactionData.dragHandle?this._onHandleDragStart(e):super._onDragLeftStart(e)}_onDragLeftMove(e){if(e.interactionData.dragHandle)return this._onHandleDragMove(e);super._onDragLeftMove(e)}_onDragLeftDrop(e){return e.interactionData.dragHandle?this._onHandleDragDrop(e):super._onDragLeftDrop(e)}_onDragLeftCancel(e){return e.interactionData.dragHandle?this._onHandleDragCancel(e):super._onDragLeftCancel(e)}_onHandleHoverIn(e){const t=e.target;t?.scale.set(1.5,1.5)}_onHandleHoverOut(e){const t=e.target;t?.scale.set(1,1)}_onHandleDragStart(e){const t=this.frame.handle,i=this.document.width,n=this.document.height,s=this.document.x+t.offset[0]*i,o=this.document.y+t.offset[1]*n;e.interactionData.origin={x:s,y:o,width:i,height:n}}_onHandleDragMove(e){canvas._onDragCanvasPan(e);const t=e.interactionData;e.shiftKey||(t.destination=this.layer.getSnappedPoint(t.destination));const i=this.#Fo(e);this.document.x=i.x,this.document.y=i.y,this.document.width=i.width,this.document.height=i.height,this.document.rotation=0,this.document.texture.scaleX=i.sx,this.document.texture.scaleY=i.sy,this.renderFlags.set({refreshTransform:!0})}_onHandleDragDrop(e){const t=e.interactionData;t.resetDocument=!1,e.shiftKey||(t.destination=this.layer.getSnappedPoint(t.destination));const i=this.#Fo(e);this.document.update({x:i.x,y:i.y,width:i.width,height:i.height,"texture.scaleX":i.sx,"texture.scaleY":i.sy}).then((()=>this.renderFlags.set({refreshTransform:!0})))}#Fo(e){const t=this.document._source,{origin:i,destination:n}=e.interactionData,s=n.x-i.x,o=n.y-i.y;let r=Math.abs(t.width)+s,a=Math.abs(t.height)+o;if(e.altKey&&this.texture?.valid){const e=this.texture.width/this.texture.height;Math.abs(r)>Math.abs(a)?a=r/e:r=a*e}const{x:l,y:c,width:d,height:u}=new PIXI.Rectangle(t.x,t.y,r,a).normalize();return{x:l,y:c,width:d,height:u,sx:(Math.sign(n.x-t.x)||1)*t.texture.scaleX,sy:(Math.sign(n.y-t.y)||1)*t.texture.scaleY}}_onHandleDragCancel(e){!1!==e.interactionData.resetDocument&&(this.document.reset(),this.renderFlags.set({refreshTransform:!0}))}get isRoof(){return foundry.utils.logCompatibilityWarning("Tile#isRoof has been deprecated without replacement.",{since:12,until:14}),this.document.roof}testOcclusion(...e){return foundry.utils.logCompatibilityWarning("Tile#testOcclusion has been deprecated in favor of PrimaryCanvasObject#testOcclusion",{since:11,until:13}),this.mesh?.testOcclusion(...e)??!1}containsPixel(...e){return foundry.utils.logCompatibilityWarning("Tile#containsPixel has been deprecated in favor of PrimaryCanvasObject#containsPixel",{since:11,until:13}),this.mesh?.containsPixel(...e)??!1}getPixelAlpha(...e){return foundry.utils.logCompatibilityWarning("Tile#getPixelAlpha has been deprecated in favor of PrimaryCanvasObject#getPixelAlpha",{since:11,until:13}),this.mesh?.getPixelAlpha(...e)??null}_getAlphaBounds(){return foundry.utils.logCompatibilityWarning("Tile#_getAlphaBounds has been deprecated",{since:11,until:13}),this.mesh?._getAlphaBounds()}}class Token extends PlaceableObject{constructor(e){super(e),this.#ht()}static embeddedName="Token";static RENDER_FLAGS={redraw:{propagate:["refresh"]},redrawEffects:{},refresh:{propagate:["refreshState","refreshTransform","refreshMesh","refreshNameplate","refreshElevation","refreshRingVisuals"],alias:!0},refreshState:{propagate:["refreshVisibility","refreshTarget"]},refreshVisibility:{},refreshTransform:{propagate:["refreshPosition","refreshRotation","refreshSize"],alias:!0},refreshPosition:{},refreshRotation:{},refreshSize:{propagate:["refreshPosition","refreshShape","refreshBars","refreshEffects","refreshNameplate","refreshTarget","refreshTooltip"]},refreshElevation:{propagate:["refreshTooltip"]},refreshMesh:{propagate:["refreshShader"]},refreshShader:{},refreshShape:{propagate:["refreshVisibility","refreshPosition","refreshBorder","refreshEffects"]},refreshBorder:{},refreshBars:{},refreshEffects:{},refreshNameplate:{},refreshTarget:{},refreshTooltip:{},refreshRingVisuals:{},recoverFromPreview:{deprecated:{since:12,until:14}}};static#Uo=[null];shape;detectionFilter=null;border;effects;bars;tooltip;target;nameplate;targeted=new Set([]);mesh;voidMesh;detectionFilterMesh;texture;vision;light;#Bo;#Go;#jo;#ko=!1;#$o;#Ho;#zo=new Map;get animationContexts(){return this.#Vo}#Vo=new Map;get ring(){return this.#Wo}#Wo;get hasDynamicRing(){return this.ring instanceof foundry.canvas.tokens.TokenRing}#ht(){const{x:e,y:t,rotation:i}=this.document,n=Ray.fromAngle(e,t,Math.toRadians(i+90),canvas.dimensions.size);this.#jo={x:e,y:t,rotation:i},this.#Bo={dx:n.dx,dy:n.dy,ox:Math.sign(n.dx),oy:Math.sign(n.dy)},this.#Go=this.getMovementAdjustedPoint(this.center),this.#$o=this._getAnimationData(),this.#Ho=foundry.utils.deepClone(this.#$o)}#Xo(){if(this.document.ring.enabled){if(!this.hasDynamicRing){const e=g.Token.ring.ringClass;if(!foundry.utils.isSubclass(e,foundry.canvas.tokens.TokenRing))throw new Error("The configured CONFIG.Token.ring.ringClass is not a TokenRing subclass.");this.#Wo=new e(this)}this.#Wo.configure(this.mesh)}else this.hasDynamicRing&&this.#Wo.clear(),this.#Wo=null}get actor(){return this.document.actor}get observer(){return c.user.isGM||!!this.actor?.testUserPermission(c.user,"OBSERVER")}get name(){return this.document.name}get bounds(){const{x:e,y:t}=this.document,{width:i,height:n}=this.getSize();return new PIXI.Rectangle(e,t,i,n)}get w(){return this.getSize().width}get h(){return this.getSize().height}get center(){const{x:e,y:t}=this.getCenterPoint();return new PIXI.Point(e,t)}getMovementAdjustedPoint(e,{offsetX:t,offsetY:i}={}){const n=Math.round(e.x),s=Math.round(e.y),o=new PIXI.Rectangle(n,s,0,0),r=[];for(const e of canvas.edges.values())e.move&&o.overlaps(e.bounds)&&0===foundry.utils.orient2dFast(e.a,e.b,{x:n,y:s})&&r.push(e);if(r.length){const{ox:e,oy:o}=this.#Bo;return{x:n-(t??e),y:s-(i??o)}}return{x:n,y:s}}get sourceElement(){return this.texture?.baseTexture.resource.source}get sourceId(){let e=`${this.document.documentName}.${this.document.id}`;return this.isPreview&&(e+=".preview"),e}get isVideo(){const e=this.sourceElement;return"VIDEO"===e?.tagName}get inCombat(){return this.document.inCombat}get combatant(){return this.document.combatant}get isTargeted(){return this.targeted.has(c.user)}get detectionModes(){return this.document.detectionModes}get isVisible(){this.detectionFilter=null;const e=c.user.isGM;if(this.document.hidden&&!e)return!1;if(!canvas.visibility.tokenVision)return!0;if(this.controlled)return!0;if(this.vision?.active)return!0;const{width:t,height:i}=this.getSize(),n=Math.min(t,i)/4;return canvas.visibility.testVisibility(this.center,{tolerance:n,object:this})}get animationName(){return`${this.objectId}.animate`}get hasSight(){return this.document.sight.enabled}_isLightSource(){const{hidden:e,light:t}=this.document;if(e)return!1;if(!t.dim&&!t.bright)return!1;return!!canvas.darknessLevel.between(t.darkness.min,t.darkness.max)&&!this.document.hasStatusEffect(g.specialStatusEffects.BURROW)}get emitsDarkness(){return this.document.light.negative&&this._isLightSource()}get emitsLight(){return!this.document.light.negative&&this._isLightSource()}get hasLimitedSourceAngle(){const e=this.document;return this.hasSight&&360!==e.sight.angle||this._isLightSource()&&360!==e.light.angle}get dimRadius(){return this.getLightRadius(this.document.light.dim)}get brightRadius(){return this.getLightRadius(this.document.light.bright)}get radius(){return Math.max(Math.abs(this.dimRadius),Math.abs(this.brightRadius))}get lightPerceptionRange(){const e=this.document.detectionModes.find((e=>"lightPerception"===e.id));return e?.enabled?this.getLightRadius(e.range??1/0):0}get sightRange(){return this.getLightRadius(this.document.sight.range??1/0)}get optimalSightRange(){let e=0;const t=this.document.detectionModes.find((e=>"lightPerception"===e.id));return t?.enabled&&(e=Math.max(this.document.light.bright,this.document.light.dim),e=Math.min(e,t.range??1/0)),this.getLightRadius(Math.max(this.document.sight.range??1/0,e))}initializeSources({deleted:e=!1}={}){this.#Go=this.getMovementAdjustedPoint(this.center),this.initializeLightSource({deleted:e}),this.initializeVisionSource({deleted:e})}initializeLightSource({deleted:e=!1}={}){const t=this.sourceId,i=canvas.effects.lightSources.has(t),n=canvas.effects.darknessSources.has(t),s=this.document.light.negative,o={refreshEdges:n||s,initializeVision:n||s,initializeLighting:n||s,refreshLighting:!0,refreshVision:!0};if(e||!this._isLightSource()){if(!this.light)return;return this.light.active&&canvas.perception.update(o),void this.#Yo()}(i&&s||n&&!s)&&this.#Yo(),this.light??=this.#Ko(),this.light.initialize(this._getLightSourceData()),this.light.add(),canvas.perception.update(o)}_getLightSourceData(){const{x:e,y:t}=this.#Go,{elevation:i,rotation:n}=this.document,s=canvas.dimensions,o=this.document.light;return foundry.utils.mergeObject(o.toObject(!1),{x:e,y:t,elevation:i,rotation:n,dim:Math.clamp(this.getLightRadius(o.dim),0,s.maxR),bright:Math.clamp(this.getLightRadius(o.bright),0,s.maxR),externalRadius:this.externalRadius,seed:this.document.getFlag("core","animationSeed"),preview:this.isPreview,disabled:!this._isLightSource()})}initializeVisionSource({deleted:e=!1}={}){if(e||!this._isVisionSource()){if(!this.vision)return;return this.vision.active&&canvas.perception.update({initializeVisionModes:!0,refreshVision:!0,refreshLighting:!0}),void this.#qo()}const t=!!this.vision;this.vision??=this.#Jo();const i=this.vision.active,n=this.vision.visionMode,s=this._getVisionBlindedStates();for(const e in s)this.vision.blinded[e]=s[e];this.vision.initialize(this._getVisionSourceData()),this.vision.add(),canvas.perception.update({initializeVisionModes:!t||this.vision.active!==i||this.vision.visionMode!==n,refreshVision:!0,refreshLighting:!0})}_getVisionBlindedStates(){return{blind:this.document.hasStatusEffect(g.specialStatusEffects.BLIND),burrow:this.document.hasStatusEffect(g.specialStatusEffects.BURROW)}}_getVisionSourceData(){const e=canvas.dimensions,{x:t,y:i}=this.#Go,{elevation:n,rotation:s}=this.document,o=this.document.sight;return{x:t,y:i,elevation:n,rotation:s,radius:Math.clamp(this.sightRange,0,e.maxR),lightRadius:Math.clamp(this.lightPerceptionRange,0,e.maxR),externalRadius:this.externalRadius,angle:o.angle,contrast:o.contrast,saturation:o.saturation,brightness:o.brightness,attenuation:o.attenuation,visionMode:o.visionMode,color:o.color,preview:this.isPreview,disabled:!1}}_isVisionSource(){if(!canvas.visibility.tokenVision||!this.hasSight)return!1;const e=c.user.isGM;if(this.document.hidden&&!e)return!1;if(this.controlled)return!0;if(e)return!1;return!!(this.actor?.testUserPermission(c.user,"OBSERVER")??!1)&&!this.layer.controlled.some((e=>!e.document.hidden&&e.hasSight))}_renderDetectionFilter(e){if(!this.mesh)return;Token.#Uo[0]=this.detectionFilter;const t=this.mesh.filters,i=this.mesh.tint,n=this.mesh.worldAlpha;this.mesh.filters=Token.#Uo,this.mesh.tint=16777215,this.mesh.worldAlpha=1,this.mesh.pluginName=BaseSamplerShader.classPluginName,this.mesh.render(e),this.mesh.filters=t,this.mesh.tint=i,this.mesh.worldAlpha=n,this.mesh.pluginName=null,Token.#Uo[0]=null}clear(){this.mesh&&(this.mesh.texture=PIXI.Texture.EMPTY,this.mesh.visible=!1),this.#ko&&this.texture?.baseTexture?.destroy(),this.#ko=!1,this.hasActiveHUD&&this.layer.hud.clear()}_destroy(e){this._removeAllFilterEffects(),this.stopAnimation(),canvas.primary.removeToken(this),this.#Yo(),this.#qo(),this.#ko&&this.texture?.baseTexture?.destroy(),this.removeChildren().forEach((e=>e.destroy({children:!0}))),this.texture=void 0,this.#ko=!1}async _draw(e){let t;this.#Qo(),t=this._original?this._original.texture?.clone():await loadTexture(this.document.texture.src,{fallback:CONST.DEFAULT_TOKEN});const i=this.document.ring;i.enabled&&i.subject.texture&&await loadTexture(i.subject.texture);let n=c.video.getVideoSource(t);if(this.#ko=!!n&&!this._original,this.#ko){t=await c.video.cloneTexture(n),n=c.video.getVideoSource(t);const e={volume:0};!1!==this.document.getFlag("core","randomizeVideo")&&Number.isFinite(n.duration)&&(e.offset=Math.random()*n.duration),c.video.play(n,e)}this.texture=t,this.mesh=canvas.primary.addToken(this),this.#Xo(),this.border||=this.addChild(new PIXI.Graphics),this.voidMesh||(this.voidMesh=this.addChild(new PIXI.Container),this.voidMesh.updateTransform=()=>{},this.voidMesh.render=e=>this.mesh?._renderVoid(e)),this.detectionFilterMesh||(this.detectionFilterMesh=this.addChild(new PIXI.Container),this.detectionFilterMesh.updateTransform=()=>{},this.detectionFilterMesh.render=e=>{this.detectionFilter&&this._renderDetectionFilter(e)}),this.bars||=this.addChild(this.#Zo()),this.tooltip||=this.addChild(this.#er()),this.effects||=this.addChild(new PIXI.Container),this.target||=this.addChild(new PIXI.Graphics),this.nameplate||=this.addChild(this.#tr()),this._updateSpecialStatusFilterEffects(),await this._drawEffects(),this.isPreview||this.initializeSources()}#Ko(){return new(this.document.light.negative?g.Canvas.darknessSourceClass:g.Canvas.lightSourceClass)({sourceId:this.sourceId,object:this})}#Yo(){this.light?.destroy(),this.light=void 0}#Jo(){return new g.Canvas.visionSourceClass({sourceId:this.sourceId,object:this})}#qo(){this.vision?.visionMode?.deactivate(this.vision),this.vision?.destroy(),this.vision=void 0}#Qo(){const e=this.scene.dimensions,{x:t,y:i}=this.getCenterPoint({x:0,y:0});this.document.x=Math.clamp(this.document.x,-t,e.width-t),this.document.y=Math.clamp(this.document.y,-i,e.height-i)}#Zo(){const e=new PIXI.Container;return e.bar1=e.addChild(new PIXI.Graphics),e.bar2=e.addChild(new PIXI.Graphics),e}_applyRenderFlags(e){e.refreshState&&this._refreshState(),e.refreshVisibility&&this._refreshVisibility(),e.refreshPosition&&this._refreshPosition(),e.refreshRotation&&this._refreshRotation(),e.refreshSize&&this._refreshSize(),e.refreshElevation&&this._refreshElevation(),e.refreshMesh&&this._refreshMesh(),e.refreshShader&&this._refreshShader(),e.refreshShape&&this._refreshShape(),e.refreshBorder&&this._refreshBorder(),e.refreshBars&&this.drawBars(),e.refreshNameplate&&this._refreshNameplate(),e.refreshTarget&&this._refreshTarget(),e.refreshTooltip&&this._refreshTooltip(),e.recoverFromPreview&&this._recoverFromPreview(),e.refreshRingVisuals&&this._refreshRingVisuals(),e.redrawEffects&&this.drawEffects(),e.refreshEffects&&this._refreshEffects()}_refreshRingVisuals(){this.hasDynamicRing&&this.ring.configureVisuals()}_refreshVisibility(){const e=this.visible;this.visible=this.isVisible,this.visible!==e&&MouseInteractionManager.emulateMoveEvent(),this.mesh.visible=this.visible&&this.renderable,this.layer.occlusionMode===CONST.TOKEN_OCCLUSION_MODES.VISIBLE&&canvas.perception.update({refreshOcclusion:!0})}_refreshState(){this.alpha=this._getTargetAlpha(),this.border.tint=this.#ir();const e=this.document.isSecret,t=this.hover||this.layer.highlightObjects;this.removeChild(this.voidMesh),this.addChildAt(this.voidMesh,this.getChildIndex(this.border)+(t?0:1)),this.border.visible=!e&&(this.controlled||t),this.nameplate.visible=!e&&this._canViewMode(this.document.displayName),this.bars.visible=!e&&this.actor&&this._canViewMode(this.document.displayBars),this.tooltip.visible=!e,this.effects.visible=!e,this.target.visible=!e,this.cursor=e?null:"pointer",this.zIndex=this.mesh.zIndex=this.controlled?2:this.hover?1:0,this.mesh.sort=this.document.sort,this.mesh.sortLayer=PrimaryCanvasGroup.SORT_LAYERS.TOKENS,this.mesh.alpha=this.alpha*this.document.alpha,this.mesh.hidden=this.document.hidden}_refreshSize(){const{width:e,height:t}=this.getSize(),{fit:i,scaleX:n,scaleY:s}=this.document.texture;let o=n,r=s;this.hasDynamicRing&&g.Token.ring.isGridFitMode&&(o*=this.ring.subjectScaleAdjustment,r*=this.ring.subjectScaleAdjustment),this.mesh.resize(e,t,{fit:i,scaleX:o,scaleY:r}),this.nameplate.position.set(e/2,t+2),this.tooltip.position.set(e/2,-2),this.hasDynamicRing&&this.ring.configureSize()}_refreshShape(){this.shape=this.getShape(),this.hitArea=this.shape,MouseInteractionManager.emulateMoveEvent()}_refreshRotation(){this.mesh.angle=this.document.lockRotation?0:this.document.rotation}_refreshPosition(){const{x:e,y:t}=this.document;this.position.x===e&&this.position.y===t||MouseInteractionManager.emulateMoveEvent(),this.position.set(e,t),this.mesh.position=this.center}_refreshElevation(){this.mesh.elevation=this.document.elevation}_refreshTooltip(){this.tooltip.text=this._getTooltipText(),this.tooltip.style=this._getTextStyle()}_refreshNameplate(){this.nameplate.text=this.document.name,this.nameplate.style=this._getTextStyle()}_refreshMesh(){const{alpha:e,texture:{anchorX:t,anchorY:i,fit:n,scaleX:s,scaleY:o,tint:r,alphaThreshold:a}}=this.document,{width:l,height:c}=this.getSize();let d=s,u=o;this.hasDynamicRing&&g.Token.ring.isGridFitMode&&(d*=this.ring.subjectScaleAdjustment,u*=this.ring.subjectScaleAdjustment),this.mesh.resize(l,c,{fit:n,scaleX:d,scaleY:u}),this.mesh.anchor.set(t,i),this.mesh.alpha=this.alpha*e,this.mesh.tint=r,this.mesh.textureAlphaThreshold=a,this.mesh.occludedAlpha=.5}_refreshShader(){this.hasDynamicRing?this.mesh.setShaderClass(g.Token.ring.shaderClass):this.mesh.setShaderClass(PrimaryBaseSamplerShader)}_refreshBorder(){const e=g.Canvas.objectBorderThickness;this.border.clear(),this.border.lineStyle({width:e,color:0,alignment:.75,join:PIXI.LINE_JOIN.ROUND}),this.border.drawShape(this.shape),this.border.lineStyle({width:e/2,color:16777215,alignment:1,join:PIXI.LINE_JOIN.ROUND}),this.border.drawShape(this.shape)}_getBorderColor(){const e=g.Canvas.dispositionColors;if(this.controlled||this.isOwner&&!c.user.isGM)return e.CONTROLLED;const t=CONST.TOKEN_DISPOSITIONS;switch(this.document.disposition){case t.SECRET:return e.SECRET;case t.HOSTILE:return e.HOSTILE;case t.NEUTRAL:return e.NEUTRAL;case t.FRIENDLY:return this.actor?.hasPlayerOwner?e.PARTY:e.FRIENDLY;default:throw new Error("Invalid disposition")}}#ir(){let e=this._getBorderColor();if("number"!=typeof e){e=g.Canvas.dispositionColors.INACTIVE;const t="Token#_getBorderColor returning null is deprecated.";foundry.utils.logCompatibilityWarning(t,{since:12,until:14,once:!0})}return e}_refreshTarget(e){if(this.target.clear(),!this.targeted.size)return;const[t,i]=Array.from(this.targeted).partition((e=>e===c.user));i.length&&this._drawTarget(e);const n=this.w/2+(t.length%2==0?8:0);for(let[e,i]of t.entries()){const t=n+(e%2==0?1:-1)*(16*Math.floor((e+1)/2));this.target.beginFill(i.color,1).lineStyle(2,0).drawCircle(t,0,6)}}_drawTarget({margin:e=0,alpha:t=1,size:i=.15,color:n,border:{width:s=2,color:o=0}={}}={}){const r=canvas.dimensions.size*i,{h:a,w:l}=this,c={color:o,alpha:t,width:s,cap:PIXI.LINE_CAP.ROUND,join:PIXI.LINE_JOIN.BEVEL};n??=this.#ir(),e*=-1*r,this.target.beginFill(n,t).lineStyle(c).drawPolygon([-e,-e,-e-r,-e,-e,-e-r]).drawPolygon([l+e,-e,l+e+r,-e,l+e,-e-r]).drawPolygon([-e,a+e,-e-r,a+e,-e,a+e+r]).drawPolygon([l+e,a+e,l+e+r,a+e,l+e,a+e+r])}drawBars(){this.actor&&this.document.displayBars!==CONST.TOKEN_DISPLAY_MODES.NONE&&["bar1","bar2"].forEach(((e,t)=>{const i=this.bars[e],n=this.document.getBarAttribute(e);if(!n||"bar"!==n.type||0===n.max)return i.visible=!1;this._drawBar(t,i,n),i.visible=!0}))}_drawBar(e,t,i){const n=Number(i.value),s=Math.clamp(n,0,i.max)/i.max,{width:o,height:r}=this.getSize(),a=o,l=Math.max(canvas.dimensions.size/12,8)*(this.document.height>=2?1.6:1),c=Math.clamp(l/8,1,2);let d;d=0===e?Color.fromRGB([1-s/2,s,0]):Color.fromRGB([.5*s,.7*s,.5+s/2]),t.clear(),t.lineStyle(c,0,1),t.beginFill(0,.5).drawRoundedRect(0,0,a,l,3),t.beginFill(d,1).drawRoundedRect(0,0,s*a,l,2);const u=0===e?r-l:0;return t.position.set(0,u),!0}#tr(){const e=new PreciseText(this.document.name,this._getTextStyle());return e.anchor.set(.5,0),e}#er(){const e=new PreciseText(this._getTooltipText(),this._getTextStyle());return e.anchor.set(.5,1),e}_getTooltipText(){let e=this.document.elevation;if(!Number.isFinite(e)||0===e)return"";let t=String(e);e>0&&(t=`+${t}`);const i=canvas.grid.units;return i&&(t=`${t} ${i}`),t}_getTextStyle(){const e=g.canvasTextStyle.clone();return e.fontSize=24,canvas.dimensions.size>=200?e.fontSize=28:canvas.dimensions.size<50&&(e.fontSize=20),e.wordWrapWidth=2.5*this.w,e}async drawEffects(){return this._partialDraw((()=>this._drawEffects()))}async _drawEffects(){this.effects.renderable=!1,this.effects.removeChildren().forEach((e=>e.destroy())),this.effects.bg=this.effects.addChild(new PIXI.Graphics),this.effects.bg.zIndex=-1,this.effects.overlay=null;const e=this.actor?.temporaryEffects||[],t=e.findLast((e=>e.img&&e.getFlag("core","overlay"))),i=[];for(const[n,s]of e.entries()){if(!s.img)continue;const e=s===t?this._drawOverlay(s.img,s.tint):this._drawEffect(s.img,s.tint);i.push(e.then((e=>{e&&(e.zIndex=n)})))}await Promise.allSettled(i),this.effects.sortChildren(),this.effects.renderable=!0,this.renderFlags.set({refreshEffects:!0})}async _drawEffect(e,t){if(!e)return;const i=await loadTexture(e,{fallback:"icons/svg/hazard.svg"}),n=new PIXI.Sprite(i);return n.tint=t??16777215,this.effects.addChild(n)}async _drawOverlay(e,t){const i=await this._drawEffect(e,t);return i&&(i.alpha=.8),this.effects.overlay=i??null,i}_refreshEffects(){let e=0;const t=2*Math.round(canvas.dimensions.size/10),i=Math.floor(5*this.document.height),n=this.effects.bg.clear().beginFill(0,.4).lineStyle(1,0);for(const s of this.effects.children)if(s!==n)if(s===this.effects.overlay){const{width:e,height:t}=this.getSize(),i=Math.min(.6*e,.6*t);s.width=s.height=i,s.position=this.getCenterPoint({x:0,y:0}),s.anchor.set(.5,.5)}else s.width=s.height=t,s.x=Math.floor(e/i)*t,s.y=e%i*t,n.drawRoundedRect(s.x+1,s.y+1,t-2,t-2,2),e++}_canViewMode(e){return e!==CONST.TOKEN_DISPLAY_MODES.NONE&&(e===CONST.TOKEN_DISPLAY_MODES.ALWAYS||(e===CONST.TOKEN_DISPLAY_MODES.CONTROL?this.controlled:e===CONST.TOKEN_DISPLAY_MODES.HOVER?this.hover||this.layer.highlightObjects:e===CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER?this.isOwner&&(this.hover||this.layer.highlightObjects):e===CONST.TOKEN_DISPLAY_MODES.OWNER&&this.isOwner))}getRingColors(){return{}}getRingEffects(){return[]}_getAnimationData(){const e=this.document,{x:t,y:i,width:n,height:s,rotation:o,alpha:r}=e,{src:a,anchorX:l,anchorY:c,scaleX:d,scaleY:u,tint:h}=e.texture;return{x:t,y:i,width:n,height:s,rotation:o,alpha:r,texture:{src:a,anchorX:l,anchorY:c,scaleX:d,scaleY:u,tint:h},ring:{subject:{texture:e.ring.subject.texture,scale:e.ring.subject.scale}}}}async animate(e,{duration:t,easing:i,movementSpeed:n,name:s,ontick:o,...r}={}){if("a0"in r){const e="Passing a0 to Token#animate is deprecated without replacement.";foundry.utils.logCompatibilityWarning(e,{since:12,until:14})}void 0===s?s=this.animationName:s||=Symbol(this.animationName);const a=this.#$o;e=foundry.utils.filterObject(e,this.#$o);let l=this.#Vo.get(s);if(l&&(e=foundry.utils.mergeObject(l.to,e,{inplace:!1})),CanvasAnimation.terminateAnimation(s),l&&this.#Vo.delete(s),t??=this._getAnimationDuration(a,e,{movementSpeed:n,...r}),l={name:s,to:e,duration:t,time:0,preAnimate:[],postAnimate:[],onAnimate:[]},this.#ui(l),t<=0)return;this.#Vo.set(s,l);const c=foundry.utils.diffObject(a,e),d=this._prepareAnimation(a,c,l,r);l.promise=CanvasAnimation.animate(d,{name:s,context:this,duration:t,easing:i,priority:PIXI.UPDATE_PRIORITY.OBJECTS+1,wait:Promise.allSettled(l.preAnimate.map((e=>e(l)))),ontick:(e,t)=>{l.time=t.time,o&&o(e,t,this.#$o),this.#ui(l)}}),await l.promise.finally((()=>{this.#Vo.get(s)===l&&this.#Vo.delete(s);for(const e of l.postAnimate)e(l)}))}_getAnimationDuration(e,t,{movementSpeed:i=6}={}){let n=0;const s=e.x-(t.x??e.x),o=e.y-(t.y??e.y);(s||o)&&(n=Math.max(n,Math.hypot(s,o)/canvas.dimensions.size/i*1e3));const r=(Math.abs(e.rotation-(t.rotation??e.rotation))+180)%360-180;return r&&(n=Math.max(n,Math.abs(r)/(60*i)*1e3)),n||(n=1e3),n}#ui(e){e.time>=e.duration&&foundry.utils.mergeObject(this.#$o,e.to);const t=foundry.utils.diffObject(this.#Ho,this.#$o);foundry.utils.mergeObject(this.#Ho,this.#$o),foundry.utils.mergeObject(this.document,this.#$o,{insertKeys:!1});for(const t of e.onAnimate)t(e);this._onAnimationUpdate(t,e)}_onAnimationUpdate(e,t){const i="x"in e||"y"in e,n="rotation"in e,s="width"in e||"height"in e,o="texture"in e,r=this.document.ring.enabled&&"ring"in e&&"subject"in e.ring,a=r&&"texture"in e.ring.subject,l=r&&"scale"in e.ring.subject;if(this.renderFlags.set({redraw:o&&"src"in e.texture||a,refreshVisibility:i||s,refreshPosition:i,refreshRotation:n&&!this.document.lockRotation,refreshSize:s||l,refreshMesh:o||"alpha"in e}),(i||s)&&(canvas.perception.update({refreshSounds:!0,refreshOcclusionMask:!0,refreshOcclusionStates:!0}),this.hasActiveHUD&&this.layer.hud.clear()),t.time<t.duration&&!c.settings.get("core","visionAnimation"))return;const d=i||s||n&&this.hasLimitedSourceAngle,u=d&&this.hasSight,h=d&&this._isLightSource();(u||h)&&this.initializeSources()}stopAnimation({reset:e=!0}={}){e&&this.document.reset();for(const e of this.#Vo.keys())CanvasAnimation.terminateAnimation(e);this.#Vo.clear();const t=this._getAnimationData(),i=foundry.utils.diffObject(this.#$o,t);if(foundry.utils.mergeObject(this.#$o,t),foundry.utils.mergeObject(this.#Ho,this.#$o),foundry.utils.isEmpty(i))return;const n={name:Symbol(this.animationName),to:t,duration:0,time:0,preAnimate:[],postAnimate:[],onAnimate:[]};this._onAnimationUpdate(i,n)}#nr(e){const t={};if("x"in e&&(this.#$o.x=t.x=e.x),"y"in e&&(this.#$o.y=t.y=e.y),"elevation"in e&&(this.#$o.elevation=t.elevation=e.elevation),!foundry.utils.isEmpty(t)){const e={name:Symbol(this.animationName),to:t,duration:0,time:0,preAnimate:[],postAnimate:[],onAnimate:[]};this._onAnimationUpdate(t,e)}}static#sr(e,t){if("rotation"in t){let i=t.rotation-e.rotation;for(;i>180;)i-=360;for(;i<-180;)i+=360;t.rotation=e.rotation+i}}static#or(e,t){const calculatePadding=({width:e,height:t})=>({x:e>t?0:(t-e)/2,y:t>e?0:(e-t)/2}),i=calculatePadding(e.texture);e.paddingX=i.x,e.paddingY=i.y;const n=calculatePadding(t.texture);t.paddingX=n.x,t.paddingY=n.y}static#rr(e){const t=TextureTransitionFilter.create();return t.enabled=!1,t.type=e.transition??"fade",t}_prepareAnimation(e,t,i,n={}){const s=[];Token.#sr(e,t),this.#ar(t,i,n,s);const recur=(e,t)=>{for(const[i,n]of Object.entries(e)){const e=foundry.utils.getType(n);"Object"===e?recur(n,t[i]):"number"!==e&&"Color"!==e||s.push({attribute:i,parent:t,to:n})}};return recur(t,this.#$o),s}#ar(e,t,i,n){const s="texture"in e&&"src"in e.texture,o=this.document.ring.enabled,r=o&&"ring"in e&&"subject"in e.ring&&"texture"in e.ring.subject;if(!s&&!r)return;const a=Token.#rr(i);let l,c,d;this.mesh&&(this.mesh.filters??=[],this.mesh.filters.unshift(a)),t.preAnimate.push(async function(){const i=o?r?e.ring.subject.texture:this.document.ring.subject.texture:e.texture.src,n=await loadTexture(i,{fallback:CONST.DEFAULT_TOKEN});d=this.#lr(n),c=new PrimarySpriteMesh({object:d}),c.texture=n,d.mesh=c,o?(d.#Wo=new g.Token.ring.ringClass(d),d.#Wo.configure(c),c.setShaderClass(g.Token.ring.shaderClass)):(Token.#or(this.mesh,c),c.setShaderClass(PrimaryBaseSamplerShader)),c.position.set(c.paddingX,c.paddingY);const s=canvas.app.renderer;l=s.generateTexture(c,{resolution:c.texture.resolution}),d.hasDynamicRing&&this.document.ring.effects>g.Token.ring.ringClass.effects.ENABLED&&t.onAnimate.push((function(){canvas.app.renderer.render(c,{renderTexture:l})})),a.targetTexture=l,a.enabled=!0}.bind(this)),t.postAnimate.push(function(){c?.destroy(),l?.destroy(!0),d?.destroy({children:!0}),this.mesh?.filters?.findSplice((e=>e===a)),!this.hasDynamicRing&&this.mesh&&(this.mesh.padding=0)}.bind(this)),n.push({attribute:"progress",parent:a.uniforms,to:1})}#lr(e){const t=this.document.clone().object;return t.texture=e,t}checkCollision(e,{origin:t,type:i="move",mode:n="any"}={}){const{x:s,y:o}=this.getCenterPoint({x:0,y:0});t&&(t={x:Math.round(t.x-s)+s,y:Math.round(t.y-o)+o}),e={x:Math.round(e.x-s)+s,y:Math.round(e.y-o)+o};const r=t||this.getCenterPoint(this.#jo);t=this.getMovementAdjustedPoint(r);const a=e.x-r.x,l=e.y-r.y,c=0===a?this.#Bo.ox:Math.sign(a),d=0===l?this.#Bo.oy:Math.sign(l);let u;switch(e=this.getMovementAdjustedPoint(e,{offsetX:c,offsetY:d}),i){case"move":u=this.#cr(t);break;case"sight":u=this.vision;break;case"light":u=this.light;break;case"sound":throw new Error("Collision testing for Token sound sources is not supported at this time")}return g.Canvas.polygonBackends[i].testCollision(t,e,{type:i,mode:n,source:u})}#cr(e){const t=new foundry.canvas.sources.PointMovementSource({object:this});return t.initialize({x:e.x,y:e.y,elevation:this.document.elevation}),t}getSize(){let{width:e,height:t}=this.document;const i=this.scene.grid;return i.isHexagonal&&(i.columns?e=.75*Math.floor(e)+e%1*.5+.25:t=.75*Math.floor(t)+t%1*.5+.25),e*=i.sizeX,t*=i.sizeY,{width:e,height:t}}getShape(){const{width:e,height:t,hexagonalShape:i}=this.document,n=this.scene.grid;if(n.isHexagonal){const s=Token.#dr(n.columns,i,e,t);if(s){const e=[];for(let t=0;t<s.points.length;t+=2)e.push(s.points[t]*n.sizeX,s.points[t+1]*n.sizeY);return new PIXI.Polygon(e)}}const s=this.getSize();return new PIXI.Rectangle(0,0,s.width,s.height)}getCenterPoint(e){const{x:t,y:i}=e??this.document,{width:n,height:s,hexagonalShape:o}=this.document,r=this.scene.grid;if(r.isHexagonal){const e=Token.#dr(r.columns,o,n,s);if(e){const n=e.center;return{x:t+n.x*r.sizeX,y:i+n.y*r.sizeY}}}const a=this.getSize();return{x:t+a.width/2,y:i+a.height/2}}getSnappedPosition(e){e??=this.document;const t=this.scene.grid;return t.isSquare?this.#ur(e):t.isHexagonal?this.#hr(e):{x:e.x,y:e.y}}#ur(e){const{width:t,height:i}=this.document,n=this.scene.grid,s=CONST.GRID_SNAPPING_MODES;if(.5===t&&i<=1||t<=1&&.5===i){let s=e.x/n.size,o=e.y/n.size;if(1===t)s=Math.round(s);else{s=Math.floor(8*s);const e=(s%8+8)%8;s=e>=6?Math.ceil(s/8):5===e?Math.floor(s/8)+.5:Math.round(s/2)/4}if(1===i)o=Math.round(o);else{o=Math.floor(8*o);const e=(o%8+8)%8;o=e>=6?Math.ceil(o/8):5===e?Math.floor(o/8)+.5:Math.round(o/2)/4}return s*=n.size,o*=n.size,{x:s,y:o}}const o=Number.isInteger(t)?s.VERTEX:s.VERTEX|s.EDGE_MIDPOINT|s.CENTER,r=Number.isInteger(i)?s.VERTEX:s.VERTEX|s.EDGE_MIDPOINT|s.CENTER;return o===r?n.getSnappedPoint(e,{mode:o}):{x:n.getSnappedPoint(e,{mode:o}).x,y:n.getSnappedPoint(e,{mode:r}).y}}#hr(e){const{width:t,height:i,hexagonalShape:n}=this.document,s=this.scene.grid,o=CONST.GRID_SNAPPING_MODES,r=Token.#dr(s.columns,n,t,i);if(r){const{behavior:t,anchor:i}=r.snapping,n=i.x*s.sizeX,o=i.y*s.sizeY;return(e=s.getSnappedPoint({x:e.x+n,y:e.y+o},t)).x-=n,e.y-=o,e}return s.getSnappedPoint(e,{mode:o.CENTER|o.VERTEX|o.CORNER|o.SIDE_MIDPOINT})}testInsideRegion(e,t){return e.testPoint(this.getCenterPoint(t),t?.elevation??this.document.elevation)}segmentizeRegionMovement(e,t,{teleport:i=!1}={}){return e.segmentizeMovement(t,[this.getCenterPoint({x:0,y:0})],{teleport:i})}setTarget(e=!0,{user:t=null,releaseOthers:i=!0,groupSelection:n=!1}={}){if(this.isPreview)return;(t=t||c.user).targets.size&&i&&t.targets.forEach((e=>{e!==this&&e.setTarget(!1,{user:t,releaseOthers:!1,groupSelection:!0})}));const s=this.targeted.has(t);e?(this.targeted.add(t),t.targets.add(this)):(this.targeted.delete(t),t.targets.delete(this)),s!==e&&(this.renderFlags.set({refreshTarget:!0}),this.hasActiveHUD&&this.layer.hud.render()),n||t.broadcastActivity({targets:t.targets.ids})}get externalRadius(){const{width:e,height:t}=this.getSize();return Math.max(e,t)/2}getLightRadius(e){return 0===e?0:(Math.abs(e)*canvas.dimensions.distancePixels+this.externalRadius)*Math.sign(e)}_getShiftedPosition(e,t){const i=super._getShiftedPosition(e,t);return this.checkCollision(this.getCenterPoint(i))?{x:this.document._source.x,y:this.document._source.y}:i}_updateRotation({angle:e,delta:t=0,snap:i=0}={}){let n=Number.isNumeric(e)?e:this.document.rotation+t;const s=[CONST.GRID_TYPES.HEXODDR,CONST.GRID_TYPES.HEXEVENR].includes(canvas.grid.type);return s&&(n-=30),i>0&&(n=n.toNearest(i)),s&&(n+=30),Math.normalizeDegrees(n)}_onCreate(e,t,i){super._onCreate(e,t,i),this.initializeSources(),c.user.isGM||!this.isOwner||this.document.hidden||this.control({pan:!0}),canvas.perception.update({refreshOcclusion:!0})}_onUpdate(e,t,i){super._onUpdate(e,t,i);const n=this.document,s="x"in e||"y"in e,o="rotation"in e,r="width"in e||"height"in e,a="elevation"in e;(s||o||r)&&this.#pr(s,o,r);const l="hidden"in e;l&&(this.controlled&&e.hidden&&!c.user.isGM?this.release():!1!==e.hidden||canvas.tokens.controlled.length||this.control({pan:!0}),this.isOwner&&this.layer.occlusionMode&CONST.TOKEN_OCCLUSION_MODES.OWNED&&canvas.perception.update({refreshOcclusion:!0})),s&&this.controlled&&!1!==t.pan&&this.#gr(),this.inCombat&&"name"in e&&c.combat.debounceSetup();const d="texture"in e,u=n.ring.enabled,h="ring"in e,p=h&&"enabled"in e.ring,g=u&&h&&"subject"in e.ring&&"texture"in e.ring.subject,m=u&&h&&("colors"in e.ring||"effects"in e.ring);if(!1===t.animate)this.stopAnimation({reset:!1});else{const i=foundry.utils.filterObject(this._getAnimationData(),e);l&&(i.alpha=n.alpha),(u||p)&&!g&&d&&"src"in e.texture&&!n._source.ring.subject.texture&&foundry.utils.mergeObject(i,{ring:{subject:{texture:n.texture.src}}}),!0===t.teleport&&this.#nr(i),this.animate(i,t.animation)}if((l||a||"light"in e||"sight"in e||"detectionModes"in e)&&this.initializeSources(),!c.user.isGM&&this.controlled&&(l||"sight"in e&&"enabled"in e.sight))for(const e of this.layer.placeables)e!==this&&!e.vision===e._isVisionSource()&&e.initializeVisionSource();(l||a)&&canvas.perception.update({refreshVision:!0,refreshSounds:!0,refreshOcclusion:!0}),"occludable"in e&&canvas.perception.update({refreshOcclusionMask:!0}),this.renderFlags.set({redraw:p||"actorId"in e||"actorLink"in e,refreshState:l||"sort"in e||"disposition"in e||"displayBars"in e||"displayName"in e,refreshRotation:"lockRotation"in e,refreshElevation:a,refreshMesh:d&&"fit"in e.texture,refreshShape:"hexagonalShape"in e,refreshBars:["displayBars","bar1","bar2"].some((t=>t in e)),refreshNameplate:["displayName","name","appendNumber","prependAdjective"].some((t=>t in e)),refreshRingVisuals:m})}_onDelete(e,t){return c.user.targets.delete(this),this.initializeSources({deleted:!0}),canvas.perception.update({refreshOcclusion:!0}),super._onDelete(e,t)}#pr(e,t,i){const n={};if(t&&(n.rotation=this.document.rotation),e){const e={x:this.#$o.x,y:this.#$o.y};n.x=this.document.x,n.y=this.document.y;const t=new Ray(e,n),i=this.#Bo,s=0===t.dx?i.ox:Math.sign(t.dx),o=0===t.dy?i.oy:Math.sign(t.dy);this.#Bo={dx:t.dx,dy:t.dy,ox:s,oy:o}}foundry.utils.mergeObject(this.#jo,n)}#gr(){const e=this.center,{x:t,y:i}=canvas.stage.transform.worldTransform.apply(e),n=$("#sidebar").width()+50;new PIXI.Rectangle(50,50,window.innerWidth-n,window.innerHeight-50).contains(t,i)||canvas.animatePan(this.center)}_onApplyStatusEffect(e,t){switch(e){case g.specialStatusEffects.BURROW:this.initializeSources();break;case g.specialStatusEffects.FLY:case g.specialStatusEffects.HOVER:canvas.perception.update({refreshVision:!0});break;case g.specialStatusEffects.INVISIBLE:canvas.perception.update({refreshVision:!0}),this._configureFilterEffect(e,t);break;case g.specialStatusEffects.BLIND:this.initializeVisionSource()}Hooks$1.callAll("applyTokenStatusEffect",this,e,t)}_configureFilterEffect(e,t){let i=null,n={};if(e===g.specialStatusEffects.INVISIBLE)i=InvisibilityFilter;if(!i)return;const s=this.mesh;s.filters??=[];let o=this.#zo.get(e);!o&&t?(o=i.create(n),s.filters.push(o),this.#zo.set(e,o)):o&&(o.enabled=t,foundry.utils.mergeObject(o.uniforms,n,{insertKeys:!1,overwrite:!0,enforceTypes:!0}),t&&!s.filters.find((e=>e===o))&&s.filters.push(o))}_updateSpecialStatusFilterEffects(){const e=g.specialStatusEffects.INVISIBLE;this._configureFilterEffect(e,this.document.hasStatusEffect(e))}_removeAllFilterEffects(){const e=this.mesh;if(e?.filters?.length)for(const t of this.#zo.values())e.filters.findSplice((e=>e===t));this.#zo.clear()}_onControl({releaseOthers:e=!0,pan:t=!1,...i}={}){super._onControl(i);for(const e of this.layer.placeables)!e.vision===e._isVisionSource()&&e.initializeVisionSource();p=this,canvas.perception.update({refreshVision:!0,refreshSounds:!0,refreshOcclusion:this.layer.occlusionMode&CONST.TOKEN_OCCLUSION_MODES.CONTROLLED}),t&&canvas.animatePan(this.center)}_onRelease(e){super._onRelease(e);for(const e of this.layer.placeables)!e.vision===e._isVisionSource()&&e.initializeVisionSource();canvas.perception.update({refreshVision:!0,refreshSounds:!0,refreshOcclusion:this.layer.occlusionMode&CONST.TOKEN_OCCLUSION_MODES.CONTROLLED})}_overlapsSelection(e){if(!this.shape)return!1;const t=this.shape,i=t instanceof PIXI.Rectangle;if(!i&&!e.intersects(this.bounds))return!1;const n=new PIXI.Rectangle(e.x-this.document.x,e.y-this.document.y,e.width,e.height);if(i)return n.intersects(t);const s=t instanceof PIXI.Polygon?t:t.toPolygon();return 0!==n.intersectPolygon(s,{scalingFactor:100}).points.length}_canControl(e,t){if(!this.layer.active||this.isPreview)return!1;if(canvas.controls.ruler.state===Ruler.STATES.MEASURING)return!1;return"target"===c.activeTool&&!this.isPreview||super._canControl(e,t)}_canHUD(e,t){return canvas.controls.ruler.state!==Ruler.STATES.MEASURING&&(e.isGM||(this.actor?.testUserPermission(e,"OWNER")??!1))}_canConfigure(e,t){return canvas.controls.ruler.state!==Ruler.STATES.MEASURING&&!this.isPreview}_canHover(e,t){return!this.isPreview}_canView(e,t){return canvas.controls.ruler.state!==Ruler.STATES.MEASURING&&(this.actor||ui.notifications.warn("TOKEN.WarningNoActor",{localize:!0}),this.actor?.testUserPermission(e,"LIMITED"))}_canDrag(e,t){if(!this.controlled)return!1;if(!this.layer.active||"select"!==c.activeTool)return!1;const i=canvas.controls.ruler;return i.state!==Ruler.STATES.MEASURING&&(i.token!==this&&!g.Canvas.rulerClass.canMeasure)}_onHoverIn(e,t){const i=this.combatant;return i&&ui.combat.hoverCombatant(i,!0),this.layer.occlusionMode&CONST.TOKEN_OCCLUSION_MODES.HOVERED&&canvas.perception.update({refreshOcclusion:!0}),super._onHoverIn(e,t)}_onHoverOut(e){const t=this.combatant;return t&&ui.combat.hoverCombatant(t,!1),this.layer.occlusionMode&CONST.TOKEN_OCCLUSION_MODES.HOVERED&&canvas.perception.update({refreshOcclusion:!0}),super._onHoverOut(e)}_onClickLeft(e){if("target"===c.activeTool){if(e.stopPropagation(),this.document.isSecret)return;return this.setTarget(!this.isTargeted,{releaseOthers:!e.shiftKey})}super._onClickLeft(e)}_propagateLeftClick(e){return g.Canvas.rulerClass.canMeasure}_onClickLeft2(e){this._propagateLeftClick(e)||e.stopPropagation();const t=this.actor?.sheet;t?.rendered?(t.maximize(),t.bringToTop()):t?.render(!0,{token:this.document})}_onClickRight2(e){return this._propagateRightClick(e)||e.stopPropagation(),this.isOwner&&c.user.can("TOKEN_CONFIGURE")?super._onClickRight2(e):this.document.isSecret?void 0:this.setTarget(!this.targeted.has(c.user),{releaseOthers:!e.shiftKey})}_onDragLeftStart(e){const t=this.#$o.x,i=this.#$o.y;this.stopAnimation();const n=e.interactionData.origin;return n.x+=this.document.x-t,n.y+=this.document.y-i,super._onDragLeftStart(e)}_prepareDragLeftDropUpdates(e){const t=[];for(const i of e.interactionData.clones){const{document:n,_original:s}=i,o=e.shiftKey?{x:n.x,y:n.y}:i.getSnappedPosition(),r=i.getCenterPoint(o);if(c.user.isGM){if(!canvas.dimensions.rect.contains(r.x,r.y))continue}else{if(s.checkCollision(r)){ui.notifications.error("RULER.MovementCollision",{localize:!0,console:!1});continue}}t.push({_id:s.id,x:o.x,y:o.y})}return t}_onDragLeftMove(e){const{destination:t,clones:i}=e.interactionData,n=c.settings.get("core","tokenDragPreview");canvas._onDragCanvasPan(e);const s=this.getCenterPoint(),o=t.x-s.x,r=t.y-s.y;for(const t of i){const i=t._original;let s={x:i.document.x+o,y:i.document.y+r};if(e.shiftKey||(s=t.getSnappedPosition(s)),n&&!c.user.isGM){if(i.checkCollision(i.getCenterPoint(s)))continue}t.document.x=s.x,t.document.y=s.y,t.renderFlags.set({refreshPosition:!0}),n&&t.initializeSources()}n&&canvas.perception.update({refreshLighting:!0,refreshVision:!0})}_onDragEnd(){this.initializeSources({deleted:!0}),this._original?.initializeSources(),super._onDragEnd()}static#mr=new Map;static#dr(e,t,i,n){if(!Number.isInteger(2*i)||!Number.isInteger(2*n))return null;const s=`${e?"C":"R"},${t},${i},${n}`;let o=Token.#mr.get(s);if(o)return o;const r=CONST.TOKEN_HEXAGONAL_SHAPES,a=CONST.GRID_SNAPPING_MODES;if(e){const e=Token.#dr(!1,t,n,i);if(!e)return null;const s=[];for(let t=e.points.length;t>0;t-=2)s.push(e.points[t-1],e.points[t-2]);o={points:s,center:{x:e.center.y,y:e.center.x},snapping:{behavior:e.snapping.behavior,anchor:{x:e.snapping.anchor.y,y:e.snapping.anchor.x}}}}else.5===i&&.5===n?o={points:[.25,0,.5,.125,.5,.375,.25,.5,0,.375,0,.125],center:{x:.25,y:.25},snapping:{behavior:{mode:a.CENTER,resolution:1},anchor:{x:.25,y:.25}}}:1===i&&1===n?o={points:[.5,0,1,.25,1,.75,.5,1,0,.75,0,.25],center:{x:.5,y:.5},snapping:{behavior:{mode:a.TOP_LEFT_CORNER,resolution:1},anchor:{x:0,y:0}}}:t<=r.TRAPEZOID_2?o=Token.#fr(t,i,n):t<=r.RECTANGLE_2&&(o=Token.#vr(t,i,n));return o&&(Object.freeze(o),Object.freeze(o.points),Object.freeze(o.center),Object.freeze(o.snapping),Object.freeze(o.snapping.behavior),Object.freeze(o.snapping.anchor),Token.#mr.set(s,o)),o}static#fr(e,t,i){if(!Number.isInteger(t)||!Number.isInteger(i))return null;const n=CONST.TOKEN_HEXAGONAL_SHAPES,s=CONST.GRID_SNAPPING_MODES,o=[];let r,a;switch(e){case n.ELLIPSE_1:if(i>=2*t)return null;r=Math.floor(i/2),a=Math.floor((i-1)/2);break;case n.ELLIPSE_2:if(i>=2*t)return null;r=Math.floor((i-1)/2),a=Math.floor(i/2);break;case n.TRAPEZOID_1:if(i>t)return null;r=i-1,a=0;break;case n.TRAPEZOID_2:if(i>t)return null;r=0,a=i-1}let l=.5*a,c=.25;for(let e=t-a;e--;)o.push(l,c),l+=.5,c-=.25,o.push(l,c),l+=.5,c+=.25;o.push(l,c);for(let e=a;e--;)c+=.5,o.push(l,c),l+=.5,c+=.25,o.push(l,c);c+=.5;for(let e=r;e--;)o.push(l,c),l-=.5,c+=.25,o.push(l,c),c+=.5;for(let e=t-r;e--;)o.push(l,c),l-=.5,c+=.25,o.push(l,c),l-=.5,c-=.25;o.push(l,c);for(let e=r;e--;)c-=.5,o.push(l,c),l-=.5,c-=.25,o.push(l,c);c-=.5;for(let e=a;e--;)o.push(l,c),l+=.5,c-=.25,o.push(l,c),c-=.5;return{points:o,center:foundry.utils.polygonCentroid(o),snapping:{behavior:{mode:a%2?s.BOTTOM_RIGHT_VERTEX:s.TOP_LEFT_CORNER,resolution:1},anchor:{x:0,y:0}}}}static#vr(e,t,i){if(t<1||!Number.isInteger(i))return null;if(1===t&&i>1)return null;if(!Number.isInteger(t)&&1===i)return null;const n=CONST.TOKEN_HEXAGONAL_SHAPES,s=CONST.GRID_SNAPPING_MODES,o=e===n.RECTANGLE_1||1===i;let r=o?0:.5,a=.25;const l=[r,a];for(;r+1<=t;)r+=.5,a-=.25,l.push(r,a),r+=.5,a+=.25,l.push(r,a);for(r!==t&&(a+=.5,l.push(r,a),r+=.5,a+=.25,l.push(r,a));a+1.5<=.75*i;)a+=.5,l.push(r,a),r-=.5,a+=.25,l.push(r,a),a+=.5,l.push(r,a),r+=.5,a+=.25,l.push(r,a);for(a+.75<.75*i&&(a+=.5,l.push(r,a),r-=.5,a+=.25,l.push(r,a)),a+=.5,l.push(r,a);r-1>=0;)r-=.5,a+=.25,l.push(r,a),r-=.5,a-=.25,l.push(r,a);for(0!==r&&(a-=.5,l.push(r,a),r-=.5,a-=.25,l.push(r,a));a-1.5>0;)a-=.5,l.push(r,a),r+=.5,a-=.25,l.push(r,a),a-=.5,l.push(r,a),r-=.5,a-=.25,l.push(r,a);return a-.75>0&&(a-=.5,l.push(r,a),r+=.5,a-=.25,l.push(r,a)),{points:l,center:{x:t/2,y:(.75*Math.floor(i)+i%1*.5+.25)/2},snapping:{behavior:{mode:o?s.TOP_LEFT_CORNER:s.BOTTOM_RIGHT_VERTEX,resolution:1},anchor:{x:0,y:0}}}}updatePosition(){foundry.utils.logCompatibilityWarning("Token#updatePosition has been deprecated without replacement as it is no longer required.",{since:11,until:13})}refreshHUD({bars:e=!0,border:t=!0,effects:i=!0,elevation:n=!0,nameplate:s=!0}={}){foundry.utils.logCompatibilityWarning("Token#refreshHUD is deprecated in favor of token.renderFlags.set()",{since:11,until:13}),this.renderFlags.set({refreshBars:e,refreshBorder:t,refreshElevation:n,refreshNameplate:s,redrawEffects:i})}updateSource({deleted:e=!1}={}){foundry.utils.logCompatibilityWarning("Token#updateSource has been deprecated in favor of Token#initializeSources",{since:12,until:14,once:!0}),this.initializeSources({deleted:e})}getCenter(e,t){return foundry.utils.logCompatibilityWarning("Token#getCenter(x, y) has been deprecated in favor of Token#getCenterPoint(Point).",{since:12,until:14,once:!0}),this.getCenterPoint(void 0!==e?{x:e,y:t}:this.document)}get owner(){return foundry.utils.logCompatibilityWarning("Token#owner has been deprecated. Use Token#isOwner instead.",{since:12,until:14}),this.isOwner}async toggleCombat(e){foundry.utils.logCompatibilityWarning("Token#toggleCombat is deprecated in favor of TokenDocument#toggleCombatant, TokenDocument.implementation.createCombatants, and TokenDocument.implementation.deleteCombatants",{since:12,until:14});const t=canvas.tokens.controlled.map((e=>e.document));this.controlled||t.push(this.document),this.inCombat?await TokenDocument.implementation.deleteCombatants(t):await TokenDocument.implementation.createCombatants(t)}async toggleEffect(e,{active:t,overlay:i=!1}={}){return foundry.utils.logCompatibilityWarning("Token#toggleEffect is deprecated in favor of Actor#toggleStatusEffect",{since:12,until:14}),!(!this.actor||!e.id)&&this.actor.toggleStatusEffect(e.id,{active:t,overlay:i})}async toggleVisibility(){foundry.utils.logCompatibilityWarning("Token#toggleVisibility is deprecated without replacement in favor of updating the hidden field of the TokenDocument directly.",{since:12,until:14});let e=this.document.hidden;const t=(this.controlled?canvas.tokens.controlled:[this]).map((t=>({_id:t.id,hidden:!e})));return canvas.scene.updateEmbeddedDocuments("Token",t)}_recoverFromPreview(){foundry.utils.logCompatibilityWarning("Token#_recoverFromPreview is deprecated without replacement in favor of recovering from preview directly into TokenConfig#_resetPreview.",{since:12,until:14}),this.renderable=!0,this.initializeSources(),this.control()}}let p=null;class Wall extends PlaceableObject{constructor(e){super(e),this.#yr=this.#br(),this.#Sr=this.document.ds}static embeddedName="Wall";static RENDER_FLAGS={redraw:{propagate:["refresh"]},refresh:{propagate:["refreshState","refreshLine"],alias:!0},refreshState:{propagate:["refreshEndpoints","refreshHighlight"]},refreshLine:{propagate:["refreshEndpoints","refreshHighlight","refreshDirection"]},refreshEndpoints:{},refreshDirection:{},refreshHighlight:{}};doorControl;line;endpoints;directionIcon;highlight;#Sr;get coords(){return this.document.c}get edge(){return this.#yr}#yr;get bounds(){const[e,t,i,n]=this.document.c;return new PIXI.Rectangle(e,t,i-e,n-t).normalize()}get isDoor(){return this.document.door>CONST.WALL_DOOR_TYPES.NONE}get isOpen(){return this.isDoor&&this.document.ds===CONST.WALL_DOOR_STATES.OPEN}get midpoint(){return[(this.coords[0]+this.coords[2])/2,(this.coords[1]+this.coords[3])/2]}get center(){const[e,t]=this.midpoint;return new PIXI.Point(e,t)}get direction(){let e=this.document.dir;if(!e)return null;let t=this.coords,i=Math.atan2(t[3]-t[1],t[2]-t[0]);return e===CONST.WALL_DIRECTIONS.LEFT?i+Math.PI/2:i-Math.PI/2}getSnappedPosition(e){throw new Error("Wall#getSnappedPosition is not supported: WallDocument does not have a (x, y) position")}initializeEdge({deleted:e=!1}={}){if(e)return this.#yr=null,void canvas.edges.delete(this.id);this.#yr=this.#br(),canvas.edges.set(this.id,this.#yr)}#br(){let{c:e,light:t,sight:i,sound:n,move:s,dir:o,threshold:r}=this.document;this.isOpen&&(t=i=n=s=CONST.WALL_SENSE_TYPES.NONE);const a=this.scene.dimensions.distancePixels;return new foundry.canvas.edges.Edge({x:e[0],y:e[1]},{x:e[2],y:e[3]},{id:this.id,object:this,type:"wall",direction:o,light:t,sight:i,sound:n,move:s,threshold:{light:r.light*a,sight:r.sight*a,sound:r.sound*a,attenuation:r.attenuation}})}toRay(){return Ray.fromArrays(this.coords.slice(0,2),this.coords.slice(2))}async _draw(e){this.line=this.addChild(new PIXI.Graphics),this.line.eventMode="auto",this.directionIcon=this.addChild(this.#Tr()),this.directionIcon.eventMode="none",this.endpoints=this.addChild(new PIXI.Graphics),this.endpoints.eventMode="auto",this.cursor="pointer"}clear(){return this.clearDoorControl(),super.clear()}createDoorControl(){return this.document.door!==CONST.WALL_DOOR_TYPES.SECRET||c.user.isGM?(this.doorControl=canvas.controls.doors.addChild(new g.Canvas.doorControlClass(this)),this.doorControl.draw(),this.doorControl):null}clearDoorControl(){this.doorControl&&(this.doorControl.destroy({children:!0}),this.doorControl=null)}#Tr(){if(this.directionIcon)return null;const e=getTexture(g.controlIcons.wallDirection),t=new PIXI.Sprite(e);return t.width=t.height=32,t.anchor.set(.5,.5),t.visible=!1,t}#Er(e){const t=this.document.c,i=t[2]-t[0],n=t[3]-t[1];let s;if(Math.abs(i)>=Math.abs(n)){const n=Math.sign(i);s=[t[0]-e*n,t[1]-e,t[2]+e*n,t[3]-e,t[2]+e*n,t[3]+e,t[0]-e*n,t[1]+e]}else{const i=Math.sign(n);s=[t[0]-e,t[1]-e*i,t[2]-e,t[3]+e*i,t[2]+e,t[3]+e*i,t[0]+e,t[1]-e*i]}return new PIXI.Polygon(s)}control({chain:e=!1,...t}={}){const i=super.control(t);if(i&&e){const e=this.getLinkedSegments();for(let t of e.walls)t.control({releaseOthers:!1}),this.layer.controlledObjects.set(t.id,t)}return i}_destroy(e){this.clearDoorControl()}isDirectionBetweenAngles(e,t){let i=this.direction;if(i<e)for(;i<e;)i+=2*Math.PI;else if(i>t)for(;i>t;)i-=2*Math.PI;return i>e&&i<t}canRayIntersect(e){return null===this.direction||this.isDirectionBetweenAngles(e.angle-Math.PI/2,e.angle+Math.PI/2)}getLinkedSegments(){const e=new Set,t=new Set,i=new Set,n=[],_addPoints=i=>{let n=i.coords.slice(0,2).join(".");t.has(n)||e.add(n);let s=i.coords.slice(2).join(".");t.has(s)||e.add(s)},_getWalls=e=>canvas.walls.placeables.filter((t=>{if(i.has(t.id))return!1;let n=t.coords.slice(0,2).join("."),s=t.coords.slice(2).join(".");return e===n||e===s}));for(_addPoints(this);e.size>0;){const s=[...e];for(let o of s){_getWalls(o).forEach((e=>{_addPoints(e),i.has(e.id)||n.push(e),i.add(e.id)})),e.delete(o),t.add(o)}}return{ids:[...i],walls:n,endpoints:[...t].map((e=>e.split(".").map(Number)))}}_applyRenderFlags(e){e.refreshState&&this._refreshState(),e.refreshLine&&this._refreshLine(),e.refreshEndpoints&&this._refreshEndpoints(),e.refreshDirection&&this._refreshDirection(),e.refreshHighlight&&this._refreshHighlight()}_refreshLine(){const e=this.document.c,t=this._getWallColor(),i=Wall.#Cr();this.line.clear().lineStyle(3*i,0,1).moveTo(e[0],e[1]).lineTo(e[2],e[3]),this.line.lineStyle(i,t,1).lineTo(e[0],e[1]),this.directionIcon&&(this.directionIcon.position.set((e[0]+e[2])/2,(e[1]+e[3])/2),this.directionIcon.tint=t),this.doorControl&&this.doorControl.reposition();const n=this.line.hitArea;this.line.hitArea=this.#Er(3*i),n&&this.line.hitArea.x===n.x&&this.line.hitArea.y===n.y&&this.line.hitArea.width===n.width&&this.line.hitArea.height===n.height||MouseInteractionManager.emulateMoveEvent()}_refreshEndpoints(){const e=this.coords,t=this._getWallColor(),i=Wall.#Cr(),n=this.hover||this.layer.highlightObjects?4*i:3*i;this.endpoints.clear().lineStyle(i,0,1).beginFill(t,1).drawCircle(e[0],e[1],n).drawCircle(e[2],e[3],n).endFill()}_refreshDirection(){if(!this.document.dir)return this.directionIcon.visible=!1;const e=this.directionIcon,t=-Math.PI/2,i=this.direction;e.rotation=t+i,e.visible=!0}_refreshHighlight(){if(!this.controlled)return void(this.highlight&&(this.removeChild(this.highlight).destroy(),this.highlight=void 0));this.highlight?this.highlight.clear():(this.highlight=this.addChildAt(new PIXI.Graphics,0),this.highlight.eventMode="none");const e=this.coords,t=2*Wall.#Cr();let i=2*t,n=4*t;this.highlight.lineStyle({width:t,color:16750633}).drawRoundedRect(e[0]-i,e[1]-i,n,n,t).drawRoundedRect(e[2]-i,e[3]-i,n,n,t).lineStyle({width:i,color:16750633}).moveTo(e[0],e[1]).lineTo(e[2],e[3])}_refreshState(){this.alpha=this._getTargetAlpha(),this.zIndex=this.controlled?2:this.hover?1:0}_getWallColor(){const e=CONST.WALL_SENSE_TYPES;if(this.document.sight===e.NONE)return 7858152;if(this.document.sight===e.LIMITED)return 8501516;if([e.PROXIMITY,e.DISTANCE].includes(this.document.sight))return 13097215;if(this.document.move===e.NONE)return 13271551;if(this.document.door===CONST.WALL_DOOR_TYPES.DOOR){let e=this.document.ds||CONST.WALL_DOOR_STATES.CLOSED;if(e===CONST.WALL_DOOR_STATES.CLOSED)return 6711022;if(e===CONST.WALL_DOOR_STATES.OPEN)return 6736998;if(e===CONST.WALL_DOOR_STATES.LOCKED)return 15615044}else if(this.document.door===CONST.WALL_DOOR_TYPES.SECRET){let e=this.document.ds||CONST.WALL_DOOR_STATES.CLOSED;if(e===CONST.WALL_DOOR_STATES.CLOSED)return 10883796;if(e===CONST.WALL_DOOR_STATES.OPEN)return 8133275;if(e===CONST.WALL_DOOR_STATES.LOCKED)return 15615044}return 16777147}static#Cr(){const e=canvas.dimensions.size;return e>150?4:e>100?3:2}_onCreate(e,t,i){super._onCreate(e,t,i),this.layer._cloneType=this.document.toJSON(),this.initializeEdge(),this.#_r(this.document.door!==CONST.WALL_DOOR_TYPES.NONE)}_onUpdate(e,t,i){super._onUpdate(e,t,i),this.layer._cloneType=this.document.toJSON();const n="c"in e||CONST.WALL_RESTRICTION_TYPES.some((t=>t in e))||"dir"in e||"threshold"in e,s=["door","ds"].some((t=>t in e));if((n||s)&&(this.initializeEdge(),this.#_r(s)),"ds"in e){const i=CONST.WALL_DOOR_STATES;let n;e.ds===i.LOCKED?n="lock":e.ds===i.OPEN?n="open":e.ds===i.CLOSED&&(this.#Sr===i.OPEN?n="close":this.#Sr===i.LOCKED&&(n="unlock")),!1!==t.sound&&this._playDoorSound(n),this.#Sr=e.ds}this.renderFlags.set({refreshLine:n||s,refreshDirection:"dir"in e})}_onDelete(e,t){super._onDelete(e,t),this.clearDoorControl(),this.initializeEdge({deleted:!0}),this.#_r(!1)}#_r(e=!1){if(canvas.perception.update({refreshEdges:!0,initializeLighting:!0,initializeVision:!0,initializeSounds:!0}),e){const e=this.document.door;e===CONST.WALL_DOOR_TYPES.DOOR||e===CONST.WALL_DOOR_TYPES.SECRET&&c.user.isGM?this.doorControl?this.doorControl.draw():this.createDoorControl():this.clearDoorControl()}else this.doorControl&&this.doorControl.reposition()}_playDoorSound(e){if(!CONST.WALL_DOOR_INTERACTIONS.includes(e))throw new Error(`"${e}" is not a valid door interaction type`);if(!this.isDoor)return;const t=g.Wall.doorSounds[this.document.doorSound];let i=t?.[e];if(i&&!Array.isArray(i))i=[i];else if(!i?.length){if("test"!==e)return;i=[g.sounds.lock]}const n=i[Math.floor(Math.random()*i.length)];canvas.sounds.playAtPosition(n,this.center,this.soundRadius,{volume:1,easing:!0,walls:!1,gmAlways:!0,muffledEffect:{type:"lowpass",intensity:5}})}get soundRadius(){return 12*canvas.dimensions.distance}_canControl(e,t){if(!this.layer.active||this.isPreview)return!1;return!(this.hover&&1===c.keyboard.downKeys.size&&c.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL))}_onHoverIn(e,t){if(this.layer._chain)return!1;const i=e.getLocalPosition(this.layer);return this.layer.last={point:WallsLayer.getClosestEndpoint(i,this)},super._onHoverIn(e,t)}_onHoverOut(e){const t=canvas.mouseInteractionManager;return this.hover&&!this.layer._chain&&t.state<t.states.CLICKED&&(this.layer.last={point:null}),super._onHoverOut(e)}_overlapsSelection(e){const[t,i,n,s]=this.document.c,{left:o,right:r,top:a,bottom:l}=e;let c=-1/0,d=1/0;const u=n-t;if(0!==u){const e=(o-t)/u,i=(r-t)/u;c=Math.max(c,Math.min(e,i)),d=Math.min(d,Math.max(e,i))}else if(t<o||t>r)return!1;const h=s-i;if(0!==h){const e=(a-i)/h,t=(l-i)/h;c=Math.max(c,Math.min(e,t)),d=Math.min(d,Math.max(e,t))}else if(i<a||i>l)return!1;return!(c>1||d<0||d<c)}_onClickLeft(e){if(this.layer._chain)return!1;e.stopPropagation();const t=c.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT),i=c.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT);if(this.controlled&&!t){if(i)return this.release();if(this.layer.controlled.length>1)return this.layer._onDragLeftStart(e)}return this.control({releaseOthers:!i,chain:t})}_onClickLeft2(e){e.stopPropagation();this.sheet.render(!0,{walls:this.layer.controlled})}_onClickRight2(e){e.stopPropagation();this.sheet.render(!0,{walls:this.layer.controlled})}_onDragLeftStart(e){const t=e.interactionData.origin,i=Math.hypot(t.x-this.coords[0],t.y-this.coords[1]),n=Math.hypot(t.x-this.coords[2],t.y-this.coords[3]);return e.interactionData.fixed=i<n?1:0,super._onDragLeftStart(e)}_onDragLeftMove(e){canvas._onDragCanvasPan(e);const{destination:t,fixed:i,origin:n}=e.interactionData;let s=e.interactionData.clones||[];const o=!e.shiftKey;if(s.length>1){const e=i?this.coords.slice(0,2):this.coords.slice(2,4),r=this.layer._getWallEndpointCoordinates({x:t.x+(e[0]-n.x),y:t.y+(e[1]-n.y)},{snap:o}),a=r[0]-e[0],l=r[1]-e[1];for(let e of s)e.document.c=e._original.document.c.map(((e,t)=>t%2?e+l:e+a))}else if(1===s.length){const e=s[0],n=this.layer._getWallEndpointCoordinates(t,{snap:o});e.document.c=i?n.concat(this.coords.slice(2,4)):this.coords.slice(0,2).concat(n)}s.forEach((e=>e.renderFlags.set({refreshLine:!0})))}_prepareDragLeftDropUpdates(e){const{clones:t,destination:i,fixed:n,origin:s}=e.interactionData,o=!e.shiftKey,r=[];if(1===t.length){const e=this.layer._getWallEndpointCoordinates(i,{snap:o}),s=n?this.coords.slice(2,4):this.coords.slice(0,2),a=n?e.concat(s):s.concat(e);return a[0]===a[2]&&a[1]===a[3]?(this.document.delete().finally((()=>this.layer.clearPreviewContainer())),null):(this.layer.last.point=e,r.push({_id:t[0]._original.id,c:a}),r)}const a=n?this.coords.slice(0,2):this.coords.slice(2,4),l=this.layer._getWallEndpointCoordinates({x:i.x+(a[0]-s.x),y:i.y+(a[1]-s.y)},{snap:o}),c=l[0]-a[0],d=l[1]-a[1];for(const e of t){const t=e._original.document.c;r.push({_id:e._original.id,c:[t[0]+c,t[1]+d,t[2]+c,t[3]+d]})}return r}get roof(){return foundry.utils.logCompatibilityWarning("Wall#roof has been deprecated. There's no replacement",{since:12,until:14}),null}get hasActiveRoof(){return foundry.utils.logCompatibilityWarning("Wall#hasActiveRoof has been deprecated. There's no replacement",{since:12,until:14}),!1}identifyInteriorState(){foundry.utils.logCompatibilityWarning("Wall#identifyInteriorState has been deprecated. It has no effect anymore and there's no replacement.",{since:12,until:14})}orientPoint(e){return foundry.utils.logCompatibilityWarning("Wall#orientPoint has been moved to foundry.canvas.edges.Edge#orientPoint",{since:12,until:14}),this.edge.orientPoint(e)}applyThreshold(e,t,i=0){return foundry.utils.logCompatibilityWarning("Wall#applyThreshold has been moved to foundry.canvas.edges.Edge#applyThreshold",{since:12,until:14}),this.edge.applyThreshold(e,t,i)}get vertices(){return foundry.utils.logCompatibilityWarning("Wall#vertices is replaced by Wall#edge",{since:12,until:14}),this.#yr}get A(){return foundry.utils.logCompatibilityWarning("Wall#A is replaced by Wall#edge#a",{since:12,until:14}),this.#yr.a}get B(){return foundry.utils.logCompatibilityWarning("Wall#A is replaced by Wall#edge#b",{since:12,until:14}),this.#yr.b}}class TextureCompressor extends AsyncWorker{constructor(e="Texture Compressor",t={}){t.debug??=!1,t.scripts??=["./workers/image-compressor.js","./spark-md5.min.js"],t.loadPrimitives??=!1,super(e,t),this.#Ir=t.controlHash??!1}#Ir;#wr="";async compressBufferBase64(e,t,i,n={}){this.#Ir&&(n.hash=this.#wr);const s={buffer:e,width:t,height:i,...n},o=await this.executeFunction("processBufferToBase64",[s],[e.buffer]);return o.hash&&(this.#wr=o.hash),o}async expandBufferRedToBufferRGBA(e,t,i,n={}){this.#Ir&&(n.hash=this.#wr);const s={buffer:e,width:t,height:i,...n},o=await this.executeFunction("processBufferRedToBufferRGBA",[s],[e.buffer]);return o.hash&&(this.#wr=o.hash),o}async reduceBufferRGBAToBufferRED(e,t,i,n={}){this.#Ir&&(n.hash=this.#wr);const s={buffer:e,width:t,height:i,...n},o=await this.executeFunction("processBufferRGBAToBufferRED",[s],[e.buffer]);return o.hash&&(this.#wr=o.hash),o}}function PrimaryCanvasObjectMixin(e){return class PrimaryCanvasObject extends(function CanvasTransformMixin(e){return class CanvasTransformMixin extends e{constructor(...e){super(...e),this.on("added",this.#Dr),this.on("removed",this.#Dr)}canvasTransform=new PIXI.Matrix;_canvasTransformID=-1;#Or=-1;#xr=-1;canvasBounds=new PIXI.Rectangle;_canvasBounds=new PIXI.Bounds;_canvasBoundsID=0;#Dr(){this.#xr=-1}_calculateCanvasBounds(){}updateCanvasTransform(){this.transform.updateLocalTransform(),this.#Or===this.transform._localID&&this.#xr===(this.parent._canvasTransformID??0)||(this.#Or=this.transform._localID,this.#xr=this.parent._canvasTransformID??0,this._canvasTransformID++,this.canvasTransform.copyFrom(this.transform.localTransform),this.parent.canvasTransform&&this.canvasTransform.prepend(this.parent.canvasTransform),this._canvasBoundsID++,this._onCanvasTransformUpdate()),this._canvasBounds.updateID!==this._canvasBoundsID&&(this._canvasBounds.updateID=this._canvasBoundsID,this._canvasBounds.clear(),this._calculateCanvasBounds(),this._canvasBounds.isEmpty()?(this.canvasBounds.x=this.x,this.canvasBounds.y=this.y,this.canvasBounds.width=0,this.canvasBounds.height=0):this._canvasBounds.getRectangle(this.canvasBounds),this._onCanvasBoundsUpdate());const e=this.children;for(let t=0,i=e.length;t<i;t++)e[t].updateCanvasTransform?.()}_onCanvasTransformUpdate(){}_onCanvasBoundsUpdate(){}containsCanvasPoint(e){return!1}}}(e)){constructor(...e){super(...e),this.cullable=!0,this.on("added",this._onAdded),this.on("removed",this._onRemoved)}object=null;#Nr=null;#Ar=!1;get elevation(){return this.#pi}set elevation(e){if("number"!=typeof e||Number.isNaN(e))throw new Error("PrimaryCanvasObject#elevation must be a numeric value.");e!==this.#pi&&(this.#pi=e,this.parent&&(this.parent.sortDirty=!0,this.shouldRenderDepth&&(canvas.masks.depth._elevationDirty=!0)))}#pi=0;get sort(){return this.#Rn}set sort(e){if("number"!=typeof e||Number.isNaN(e))throw new Error("PrimaryCanvasObject#sort must be a numeric value.");e!==this.#Rn&&(this.#Rn=e,this.parent&&(this.parent.sortDirty=!0))}#Rn=0;get sortLayer(){return this.#An}set sortLayer(e){if("number"!=typeof e||Number.isNaN(e))throw new Error("PrimaryCanvasObject#sortLayer must be a numeric value.");e!==this.#An&&(this.#An=e,this.parent&&(this.parent.sortDirty=!0))}#An=0;get zIndex(){return this._zIndex}set zIndex(e){if("number"!=typeof e||Number.isNaN(e))throw new Error("PrimaryCanvasObject#zIndex must be a numeric value.");e!==this._zIndex&&(this._zIndex=e,this.parent&&(this.parent.sortDirty=!0))}_onAdded(e){if(e!==canvas.primary)throw new Error("PrimaryCanvasObject instances may only be direct children of the PrimaryCanvasGroup")}_onRemoved(e){this.#Rr(!0)}updateCanvasTransform(){super.updateCanvasTransform(),this.#Rr(),this.#Pr()}_onCanvasBoundsUpdate(){super._onCanvasBoundsUpdate(),this.#Ar=!0}#Rr(e=!1){(this.#Ar||e)&&(this.#Ar=!1,!e&&this.canvasBounds.width>0&&this.canvasBounds.height>0?(this.#Nr??={r:this.canvasBounds,t:this},canvas.primary.quadtree.update(this.#Nr)):this.#Nr&&(this.#Nr=null,canvas.primary.quadtree.remove(this)))}get shouldRenderDepth(){return this.#kr}#kr=!1;#Pr(){const e=this._shouldRenderDepth();this.#kr!==e&&(this.#kr=e,canvas.masks.depth._elevationDirty=!0)}_shouldRenderDepth(){return!1}renderDepthData(e){}renderOcclusion(e){foundry.utils.logCompatibilityWarning("PrimaryCanvasObject#renderOcclusion is deprecated in favor of PrimaryCanvasObject#renderDepthData",{since:11,until:13}),this.renderDepthData(e)}get document(){return foundry.utils.logCompatibilityWarning("PrimaryCanvasObject#document is deprecated.",{since:12,until:14}),this.object instanceof PlaceableObject&&this.object.document||null}updateBounds(){foundry.utils.logCompatibilityWarning("PrimaryCanvasObject#updateBounds is deprecated and has no effect.",{since:12,until:14})}}}class PrimaryGraphics extends(PrimaryCanvasObjectMixin(PIXI.Graphics)){constructor(e){let t;e instanceof PIXI.GraphicsGeometry?(t=e,e={}):e instanceof Object?t=e.geometry:e={},super(t),this.name=e.name??null,this.object=e.object??null}static#ni=new PIXI.Point;#Mr=-1;#Lr=!1;_calculateCanvasBounds(){this.finishPoly();const e=this._geometry;if(!e.graphicsData.length)return;const{minX:t,minY:i,maxX:n,maxY:s}=e.bounds;this._canvasBounds.addFrameMatrix(this.canvasTransform,t,i,n,s)}updateCanvasTransform(){if(this.#Mr!==this._geometry.dirty){this.#Mr=this._geometry.dirty,this.#Lr=!1;const e=this._geometry.graphicsData;for(let t=0;t<e.length;t++){const i=e[t];if(i.shape&&i.fillStyle.visible){this.#Lr=!0;break}}this._canvasBoundsID++}super.updateCanvasTransform()}containsCanvasPoint(e){return!!this.#Lr&&(!!this.canvasBounds.contains(e.x,e.y)&&(e=this.canvasTransform.applyInverse(e,PrimaryGraphics.#ni),this._geometry.containsPoint(e)))}}class PrimarySpriteMesh extends(function PrimaryOccludableObjectMixin(e){class PrimaryOccludableObject extends(PrimaryCanvasObjectMixin(e)){#Fr=new foundry.utils.BitMask({light:!1,weather:!1});hidden=!1;occluded=!1;occlusionMode=CONST.OCCLUSION_MODES.NONE;unoccludedAlpha=1;occludedAlpha=0;get hoverFade(){return this.#Ur}set hoverFade(e){if(this.#Ur===e)return;this.#Ur=e;const t=this._hoverFadeState;t.hovered=!1,t.faded=!1,t.fading=!1,t.occlusion=0}#Ur=!0;_occlusionState={fade:0,radial:0,vision:0};_hoverFadeState={hovered:!1,hoveredTime:0,faded:!1,fading:!1,fadingTime:0,occlusion:0};get _restrictionState(){return this.#Fr.valueOf()}get restrictsLight(){return this.#Fr.hasState(this.#Fr.states.light)}set restrictsLight(e){this.#Fr.toggleState(this.#Fr.states.light,e)}get restrictsWeather(){return this.#Fr.hasState(this.#Fr.states.weather)}set restrictsWeather(e){this.#Fr.toggleState(this.#Fr.states.weather,e)}get isOccludable(){return this.occlusionMode>CONST.OCCLUSION_MODES.NONE}debounceSetOcclusion=foundry.utils.debounce((e=>this.occluded=e),50);updateCanvasTransform(){super.updateCanvasTransform(),this.#Br(),this.#Gr()}#Gr(){const e=this._occlusionState;e.fade=0,e.radial=0,e.vision=0;const t=CONST.OCCLUSION_MODES;switch(this.occlusionMode){case t.FADE:this.occluded&&(e.fade=1);break;case t.RADIAL:e.radial=1;break;case t.VISION:canvas.masks.occlusion.vision?e.vision=1:this.occluded&&(e.fade=1)}const i=this._hoverFadeState.occlusion;canvas.masks.occlusion.vision?e.vision=Math.max(e.vision,i):e.fade=Math.max(e.fade,i)}#Br(){if(!this.#Ur)return;const e=this._hoverFadeState,t=canvas.app.ticker.lastTime,{delay:i,duration:n}=g.Canvas.hoverFade;if(e.fading){t-e.fadingTime>=n&&(e.fading=!1)}else if(e.faded!==e.hovered){const s=t-e.hoveredTime;s>=i&&(e.faded=e.hovered,s-i<n&&(e.fading=!0,e.fadingTime=t))}let s=1;e.fading&&(e.faded!==e.hovered&&(e.faded=e.hovered,e.fadingTime=t-(e.fadingTime+n-t)),s=CanvasAnimation.easeInOutCosine((t-e.fadingTime)/n)),e.occlusion=e.faded?s:1-s}_shouldRenderDepth(){return!this.#Fr.isEmpty&&!this.hidden}testOcclusion(e,{corners:t=!0}={}){if(e.document.elevation>=this.elevation)return!1;const{x:i,y:n,w:s,h:o}=e;let r=[[s/2,o/2]];if(t){const e=2,t=[[e,e],[s/2,e],[s-e,e],[s-e,o/2],[s-e,o-e],[s/2,o-e],[e,o-e],[e,o/2]];r=r.concat(t)}for(const[e,t]of r)if(this.containsCanvasPoint({x:i+e,y:n+t}))return!0;return!1}get roof(){const e=`${this.constructor.name}#roof is deprecated in favor of more granular options: \n      ${this.constructor.name}#BlocksLight and ${this.constructor.name}#BlocksWeather`;return foundry.utils.logCompatibilityWarning(e,{since:12,until:14}),this.restrictsLight&&this.restrictsWeather}set roof(e){const t=`${this.constructor.name}#roof is deprecated in favor of more granular options: \n      ${this.constructor.name}#BlocksLight and ${this.constructor.name}#BlocksWeather`;foundry.utils.logCompatibilityWarning(t,{since:12,until:14}),this.restrictsWeather=e,this.restrictsLight=e}containsPixel(e,t,i=.75){const n=`${this.constructor.name}#containsPixel is deprecated. Use ${this.constructor.name}#containsCanvasPoint instead.`;return foundry.utils.logCompatibilityWarning(n,{since:12,until:14}),this.containsCanvasPoint({x:e,y:t},i+1e-6)}renderOcclusion(e){foundry.utils.logCompatibilityWarning("PrimaryCanvasObject#renderOcclusion is deprecated in favor of PrimaryCanvasObject#renderDepth",{since:11,until:13}),this.renderDepthData(e)}}return PrimaryOccludableObject}(SpriteMesh)){constructor(e,t){let i;if(e instanceof PIXI.Texture?(i=e,e={}):e instanceof Object?(i=e.texture,t=e.shaderClass):e={},t??=PrimaryBaseSamplerShader,!foundry.utils.isSubclass(t,PrimaryBaseSamplerShader))throw new Error(`${t.name} in not a subclass of PrimaryBaseSamplerShader`);super(i,t),this.name=e.name??null,this.object=e.object??null}static#ni=new PIXI.Point;_textureAlphaData=null;textureAlphaThreshold=0;_onTextureUpdate(){super._onTextureUpdate(),this._textureAlphaData=null,this._canvasBoundsID++}setShaderClass(e){if(!foundry.utils.isSubclass(e,PrimaryBaseSamplerShader))throw new Error(`${e.name} in not a subclass of PrimaryBaseSamplerShader`);super.setShaderClass(e)}resize(e,t,{fit:i="fill",scaleX:n=1,scaleY:s=1}={}){if(!(e>=0&&t>=0))throw new Error(`Invalid baseWidth/baseHeight passed to ${this.constructor.name}#resize.`);const{width:o,height:r}=this._texture;let a,l;switch(i){case"fill":a=e/o,l=t/r;break;case"cover":a=l=Math.max(e/o,t/r);break;case"contain":a=l=Math.min(e/o,t/r);break;case"width":a=l=e/o;break;case"height":a=l=t/r;break;default:throw new Error(`Invalid fill type passed to ${this.constructor.name}#resize (fit=${i}).`)}a*=n,l*=s,this.scale.set(a,l),this._width=Math.abs(a*o),this._height=Math.abs(l*r)}_updateBatchData(){super._updateBatchData();const e=this._batchData;e.elevation=this.elevation,e.textureAlphaThreshold=this.textureAlphaThreshold,e.unoccludedAlpha=this.unoccludedAlpha,e.occludedAlpha=this.occludedAlpha;const t=this._occlusionState;e.fadeOcclusion=t.fade,e.radialOcclusion=t.radial,e.visionOcclusion=t.vision,e.restrictionState=this._restrictionState}_calculateCanvasBounds(){if(!this._texture)return;const{width:e,height:t}=this._texture;let i=0,n=0,s=e,o=t;const r=this._textureAlphaData;if(r){const a=e/r.width,l=t/r.height;i=r.minX*a,n=r.minY*l,s=r.maxX*a,o=r.maxY*l}let{x:a,y:l}=this.anchor;a*=e,l*=t,i-=a,n-=l,s-=a,o-=l,this._canvasBounds.addFrameMatrix(this.canvasTransform,i,n,s,o)}containsCanvasPoint(e,t=this.textureAlphaThreshold){return!(t>1)&&(!!this.canvasBounds.contains(e.x,e.y)&&(e=this.canvasTransform.applyInverse(e,PrimarySpriteMesh.#ni),this.#jr(e,t)))}containsPoint(e,t=this.textureAlphaThreshold){return!(t>1)&&(e=this.worldTransform.applyInverse(e,PrimarySpriteMesh.#ni),this.#jr(e,t))}#jr(e,t){const{width:i,height:n}=this._texture,{x:s,y:o}=this.anchor;let{x:r,y:a}=e;return r+=i*s,a+=n*o,t>0?this.#$r(r,a)>=t:r>=0&&r<i&&a>=0&&a<n}#$r(e,t){if(!this._texture)return 0;this._textureAlphaData||(this._textureAlphaData=TextureLoader.getTextureAlphaData(this._texture,.25),this._canvasBoundsID++);const{width:i,height:n}=this._texture,s=this._textureAlphaData;e*=s.width/i,t*=s.height/n;const{minX:o,minY:r,maxX:a,maxY:l}=s;return e<o||e>=a||t<r||t>=l?0:s.data[(a-o)*((0|t)-r)+((0|e)-o)]/255}renderDepthData(e){if(!this.shouldRenderDepth||!this.visible||!this.renderable)return;const t=this._shader,i=this.blendMode;this.blendMode=PIXI.BLEND_MODES.MAX_COLOR,this._shader=t.depthShader,this.cullable?this._renderWithCulling(e):this._render(e),this._shader=t,this.blendMode=i}_renderVoid(e){if(this.visible&&!(this.worldAlpha<=0)&&this.renderable)if(this._mask||this.filters?.length)this.#Hr(e);else{const t=this.blendMode;this.blendMode=PIXI.BLEND_MODES.ERASE,this.cullable?this._renderWithCulling(e):this._render(e),this.blendMode=t}}#Hr(e){const t=this.filters,i=this._mask;if(t){this._enabledFilters||=[],this._enabledFilters.length=0;for(let e=0;e<t.length;e++)t[e].enabled&&this._enabledFilters.push(t[e])}const n=t&&this._enabledFilters.length||i&&(!i.isMaskData||i.enabled&&(i.autoDetect||i.type!==MASK_TYPES.NONE));let s,o;n&&e.batch.flush(),t&&this._enabledFilters.length&&e.filter.push(this,this._enabledFilters),i&&e.mask.push(this,i);const r=e.filter.defaultFilterStack.at(-1);r.target===this?(s=r.filters.at(-1),o=s.blendMode,s.blendMode=PIXI.BLEND_MODES.ERASE):(o=this.blendMode,this.blendMode=PIXI.BLEND_MODES.ERASE),this.cullable?this._renderWithCulling(e):this._render(e),n&&e.batch.flush(),i&&e.mask.pop(this),t&&this._enabledFilters.length&&e.filter.pop(),s?s.blendMode=o:this.blendMode=o}getPixelAlpha(e,t){const i=`${this.constructor.name}#getPixelAlpha is deprecated without replacement.`;if(foundry.utils.logCompatibilityWarning(i,{since:12,until:14}),!this._textureAlphaData)return null;if(!this.canvasBounds.contains(e,t))return-1;const n=PrimarySpriteMesh.#ni.set(e,t);this.canvasTransform.applyInverse(n,n);const{width:s,height:o}=this._texture,{x:r,y:a}=this.anchor;return e=n.x+s*r,t=n.y+o*a,255*this.#$r(e,t)}_getAlphaBounds(){const e=`${this.constructor.name}#_getAlphaBounds is deprecated without replacement.`;foundry.utils.logCompatibilityWarning(e,{since:12,until:14});const t=this._textureAlphaData,i=this.rotation;return PIXI.Rectangle.fromRotation(t.minX,t.minY,t.maxX-t.minX,t.maxY-t.minY,i).normalize()}_getTextureCoordinate(e,t){const i=`${this.constructor.name}#_getTextureCoordinate is deprecated without replacement.`;foundry.utils.logCompatibilityWarning(i,{since:12,until:14});const n={x:e,y:t};let{x:s,y:o}=this.canvasTransform.applyInverse(n,n);return n.x=(s/this._texture.width+this.anchor.x)*this._textureAlphaData.width,n.y=(o/this._texture.height+this.anchor.y)*this._textureAlphaData.height,n}}class FramebufferSnapshot{constructor(){this.framebufferTexture=FramebufferSnapshot.#zr(),canvas.app.renderer.on("resize",(()=>this.#Vr=!0))}#Vr=!0;#Wr=new PIXI.Rectangle;getFramebufferTexture(e){this.#Vr&&(CachedContainer.resizeRenderTexture(e,this.framebufferTexture),this.#Vr=!1),e.batch.flush();const t=e.framebuffer.current,i=this.#Wr.copyFrom(e.renderTexture.viewportFrame);if(t||(i.y=e.view.height-(i.y+i.height)),!(i.width>0&&i.height>0))return PIXI.Texture.WHITE;let n=i.x,s=i.y,o=n+i.width,r=s+i.height;t||(s=e.view.height-1-s,r=s-i.height);let a=i.width,l=i.height;const c=e.gl,d=e.framebuffer,u=d.current;return d.bind(this.framebufferTexture.framebuffer,d.viewport),c.bindFramebuffer(c.READ_FRAMEBUFFER,t?.glFramebuffers[d.CONTEXT_UID].framebuffer),c.blitFramebuffer(n,s,o,r,0,0,a,l,c.COLOR_BUFFER_BIT,c.NEAREST),d.bind(u,d.viewport),this.framebufferTexture}static#zr(){const e=canvas.app?.renderer;return PIXI.RenderTexture.create({width:e?.screen.width??window.innerWidth,height:e?.screen.height??window.innerHeight,resolution:e.resolution??PIXI.settings.RESOLUTION})}}class TextureExtractor{constructor(e,{callerName:t,controlHash:i,format:n=PIXI.FORMATS.RED}={}){if(this.#Xr=e,this.#Yr=t??"TextureExtractor",this.#Kr=new TextureCompressor("Compressor",{debug:!1,controlHash:i}),n!==PIXI.FORMATS.RED&&n!==PIXI.FORMATS.RGBA)throw new Error("TextureExtractor supports format RED and RGBA only.");this.#qr=n,this.#Jr=PIXI.TYPES.UNSIGNED_BYTE,this.#Qr=n===PIXI.FORMATS.RED&&!canvas.supported.readPixelsRED||n===PIXI.FORMATS.RGBA?PIXI.FORMATS.RGBA:PIXI.FORMATS.RED,this.#Xr.runners.contextChange.add(this)}static COMPRESSION_MODES={NONE:0,BASE64:1};#Xr;#Zr;#qr;#Jr;#Qr;#ea;#ta;debug;pixelBuffer;#Yr;#ia;#Kr;get#na(){return this.#Qr===PIXI.FORMATS.RED?1:4}#Ks=new foundry.utils.Semaphore;async extract(e={}){return this.#Ks.add(this.#sa.bind(this),e)}async#sa({texture:e,frame:t,compression:i,type:n,quality:s,debug:o}={}){this.debug=o,this.debug&&this.#oa("Begin texture extraction.");const r=e?.baseTexture;if(e&&(!r||!r.valid||r.parentTextureArray))throw new Error("Texture passed to extractor is invalid.");if(e&&e.baseTexture.alphaMode>0&&e.baseTexture.format===PIXI.FORMATS.RGBA)throw new Error("Texture Extractor is not supporting premultiplied textures yet.");let a;e instanceof PIXI.RenderTexture&&(r.format===this.#qr||this.#Qr===PIXI.FORMATS.RGBA)&&r.type===this.#Jr?(t??=e.frame,a=r.resolution):(e=this.#ia=this.#Xr.generateTexture(new PIXI.Sprite(e),{format:this.#qr,type:this.#Jr,resolution:r.resolution,multisample:PIXI.MSAA_QUALITY.NONE}),t??=this.#ia.frame,a=e.baseTexture.resolution),this.#Xr.renderTexture.bind(e);const l=await this.#ra(t,a);if(i)return await this.#aa(l.buffer,l.width,l.height,{compression:i,type:n,quality:s});if(this.#qr===PIXI.FORMATS.RED&&this.#Qr===PIXI.FORMATS.RGBA){const e=await this.#Kr.reduceBufferRGBAToBufferRED(l.buffer,l.width,l.height,{compression:i,type:n,quality:s});return this.pixelBuffer=e.buffer,e.redBuffer}return l.buffer}reset(){this.debug&&this.#oa("Data reset."),this.#la({buffer:!0,syncObject:!0,rt:!0})}contextChange(){this.debug&&this.#oa("WebGL context has changed."),this.#Zr=void 0,this.#ia=void 0,this.#ea=void 0,this.pixelBuffer=void 0}async#aa(...e){return canvas.supported.offscreenCanvas?this.#ca(...e):this.#da(...e)}async#ca(e,t,i,{type:n,quality:s}={}){let o;try{o=await this.#Kr.compressBufferBase64(e,t,i,{type:n??"image/png",quality:s??1,debug:this.debug,readFormat:this.#Qr})}catch(e){throw this.#ua("Buffer compression has failed!"),e}return this.pixelBuffer=o.buffer,o.base64img}async#da(e,t,i,{quality:n}={}){let s;if(this.#Qr===PIXI.FORMATS.RED){let n;try{n=await this.#Kr.expandBufferRedToBufferRGBA(e,t,i,{debug:this.debug})}catch(e){throw this.#ua("Buffer expansion has failed!"),e}this.pixelBuffer=n.buffer,s=n.rgbaBuffer}else s=e;if(!s)return;const o=ImageHelper.pixelsToCanvas(s,t,i);return await ImageHelper.canvasToBase64(o,"image/jpeg",n)}async#ra(e,t){const i=this.#Xr.gl,n=Math.round(e.left*t),s=Math.round(e.top*t),o=Math.round(e.width*t),r=Math.round(e.height*t),a=o*r*this.#na,l=this.#Qr,c=i.UNSIGNED_BYTE;this.debug&&console.table({x:n,y:s,width:o,height:r,bufSize:a,format:l,type:c,extractorFormat:this.#qr});const d=this.#ha(a);this.#ta?(this.debug&&this.#oa("Creating buffer."),this.#ta=!1,this.#ea&&this.#la({buffer:!0}),this.#ea=i.createBuffer(),i.bindBuffer(i.PIXEL_PACK_BUFFER,this.#ea),i.bufferData(i.PIXEL_PACK_BUFFER,a,i.DYNAMIC_READ)):(this.debug&&this.#oa("Reusing cached buffer."),i.bindBuffer(i.PIXEL_PACK_BUFFER,this.#ea)),i.pixelStorei(i.PACK_ALIGNMENT,1),i.readPixels(n,s,o,r,l,c,0),i.pixelStorei(i.PACK_ALIGNMENT,4),i.bindBuffer(i.PIXEL_PACK_BUFFER,null),this.#Zr=i.fenceSync(i.SYNC_GPU_COMMANDS_COMPLETE,0),i.flush(),await this.#pa();const u=this.#ga(d,o,r,a);return this.#la({syncObject:!0,rt:!0}),this.debug&&this.#oa("Buffer data sent to caller."),u}#ga(e,t,i,n){const s=this.#Xr.gl;return s.bindBuffer(s.PIXEL_PACK_BUFFER,this.#ea),s.getBufferSubData(s.PIXEL_PACK_BUFFER,0,e,0,n),s.bindBuffer(s.PIXEL_PACK_BUFFER,null),{buffer:e,width:t,height:i}}#ha(e){return this.pixelBuffer?.length!==e&&(this.pixelBuffer=new Uint8ClampedArray(e),this.#ta=!0),this.pixelBuffer}async#pa(){const e=this.#Xr.gl,t=this.#Zr;if(!await new Promise(((i,n)=>{!function wait(){const s=e.clientWaitSync(t,0,0);s!==e.WAIT_FAILED?s!==e.TIMEOUT_EXPIRED?i(!0):setTimeout(wait,10):n(!1)}()})))throw this.#la({buffer:!0,syncObject:!0,data:!0,rt:!0}),new Error("The sync object has failed to wait.")}#la({buffer:e=!1,syncObject:t=!1,rt:i=!1}={}){t&&this.#Zr&&(this.#Xr.gl.deleteSync(this.#Zr),this.#Zr=void 0,this.debug&&this.#oa("Free the sync object.")),e&&(this.#ea&&(this.#Xr.gl.deleteBuffer(this.#ea),this.#ea=void 0),this.pixelBuffer=void 0,this.#ta=!0,this.debug&&this.#oa("Free the cached buffers.")),i&&this.#ia&&(this.#ia.destroy(!0),this.#ia=void 0,this.debug&&this.#oa("Destroy the generated render texture."))}#oa(e){console.debug(`${this.#Yr} | ${e}`)}#ua(e){console.error(`${this.#Yr} | ${e}`)}}class AbstractBaseMaskFilter extends AbstractBaseFilter{static vertexShader="\n  attribute vec2 aVertexPosition;\n\n  uniform mat3 projectionMatrix;\n  uniform vec2 screenDimensions;\n  uniform vec4 inputSize;\n  uniform vec4 outputFrame;\n\n  varying vec2 vTextureCoord;\n  varying vec2 vMaskTextureCoord;\n\n  vec4 filterVertexPosition( void ) {\n      vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;\n      return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0., 1.);\n  }\n\n  // getting normalized coord for the tile texture\n  vec2 filterTextureCoord( void ) {\n      return aVertexPosition * (outputFrame.zw * inputSize.zw);\n  }\n\n  // getting normalized coord for a screen sized mask render texture\n  vec2 filterMaskTextureCoord( in vec2 textureCoord ) {\n    return (textureCoord * inputSize.xy + outputFrame.xy) / screenDimensions;\n  }\n\n  void main() {\n    vTextureCoord = filterTextureCoord();\n    vMaskTextureCoord = filterMaskTextureCoord(vTextureCoord);\n    gl_Position = filterVertexPosition();\n  }";apply(e,t,i,n,s){this.uniforms.screenDimensions=canvas.screenDimensions,e.applyFilter(this,t,i,n)}}class AlphaBlurFilterPass extends PIXI.Filter{constructor(e,t=8,i=4,n=PIXI.Filter.defaultResolution,s=5){super(AlphaBlurFilterPass.vertTemplate(s,e),AlphaBlurFilterPass.fragTemplate(s)),this.horizontal=e,this.strength=t,this.passes=i,this.resolution=n}horizontal;strength;passes;get quality(){return this.passes}set quality(e){this.passes=e}get blur(){return this.strength}set blur(e){this.padding=1+2*Math.abs(e),this.strength=e}static GAUSSIAN_VALUES={5:[.153388,.221461,.250301],7:[.071303,.131514,.189879,.214607],9:[.028532,.067234,.124009,.179044,.20236],11:[.0093,.028002,.065984,.121703,.175713,.198596],13:[.002406,.009255,.027867,.065666,.121117,.174868,.197641],15:[489e-6,.002403,.009246,.02784,.065602,.120999,.174697,.197448]};static fragTemplate(e){return`\n    varying vec2 vBlurTexCoords[${e}];\n    varying vec2 vTextureCoords;\n    uniform sampler2D uSampler;\n\n    void main(void) {\n        vec4 finalColor = vec4(0.0);\n        ${this.generateBlurFragSource(e)}\n        finalColor.rgb *= clamp(mix(-1.0, 1.0, finalColor.a), 0.0, 1.0);\n        gl_FragColor = finalColor;\n    }\n    `}static vertTemplate(e,t){return`\n    attribute vec2 aVertexPosition;\n    uniform mat3 projectionMatrix;\n    uniform float strength;\n    varying vec2 vBlurTexCoords[${e}];\n    varying vec2 vTextureCoords;\n    uniform vec4 inputSize;\n    uniform vec4 outputFrame;\n    \n    vec4 filterVertexPosition( void ) {\n        vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;\n        return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);\n    }\n    \n    vec2 filterTextureCoord( void ) {\n        return aVertexPosition * (outputFrame.zw * inputSize.zw);\n    }\n        \n    void main(void) {\n        gl_Position = filterVertexPosition();\n        vec2 textureCoord = vTextureCoords = filterTextureCoord();\n        ${this.generateBlurVertSource(e,t)}\n    }\n    `}static generateBlurFragSource(e){const t=AlphaBlurFilterPass.GAUSSIAN_VALUES[e],i=t.length;let n,s="";for(let o=0;o<e;o++)s+=`finalColor += texture2D(uSampler, vBlurTexCoords[${o.toString()}])`,n=o>=i?e-o-1:o,s+=` * ${t[n].toString()};\n`;return s}static generateBlurVertSource(e,t){const i=Math.ceil(e/2);let n="";for(let s=0;s<e;s++){const e=s-(i-1);n+=t?`vBlurTexCoords[${s.toString()}] = textureCoord + vec2(${e}.0 * strength, 0.0);`:`vBlurTexCoords[${s.toString()}] = textureCoord + vec2(0.0, ${e}.0 * strength);`,n+="\n"}return n}apply(e,t,i,n){const s=i?i.width:e.renderer.width,o=i?i.height:e.renderer.height;if(this.uniforms.strength=(this.horizontal?1/s*(s/t.width):1/o*(o/t.height))*this.strength/this.passes,1===this.passes)return e.applyFilter(this,t,i,n);const r=e.getFilterTexture(),a=e.renderer;let l=t,c=r;this.state.blend=!1,e.applyFilter(this,l,c,PIXI.CLEAR_MODES.CLEAR);for(let t=1;t<this.passes-1;t++){e.bindAndClear(l,PIXI.CLEAR_MODES.BLIT),this.uniforms.uSampler=c;const t=c;c=l,l=t,a.shader.bind(this),a.geometry.draw(5)}this.state.blend=!0,e.applyFilter(this,c,i,n),e.returnFilterTexture(r)}}class AlphaBlurFilter extends PIXI.Filter{constructor(e=8,t=4,i=PIXI.Filter.defaultResolution,n=5){super(),this.blurXFilter=new AlphaBlurFilterPass(!0,e,t,i,n),this.blurYFilter=new AlphaBlurFilterPass(!1,e,t,i,n),this.resolution=i,this._repeatEdgePixels=!1,this.quality=t,this.blur=e}apply(e,t,i,n){const s=Math.abs(this.blurXFilter.strength),o=Math.abs(this.blurYFilter.strength);if(s&&o){const s=e.getFilterTexture();this.blurXFilter.apply(e,t,s,PIXI.CLEAR_MODES.CLEAR),this.blurYFilter.apply(e,s,i,n),e.returnFilterTexture(s)}else o?this.blurYFilter.apply(e,t,i,n):this.blurXFilter.apply(e,t,i,n)}updatePadding(){this.padding=this._repeatEdgePixels?0:2*Math.max(Math.abs(this.blurXFilter.strength),Math.abs(this.blurYFilter.strength))}get blur(){return this.blurXFilter.blur}set blur(e){this.blurXFilter.blur=this.blurYFilter.blur=e,this.updatePadding()}get quality(){return this.blurXFilter.quality}set quality(e){this.blurXFilter.quality=this.blurYFilter.quality=e}get repeatEdgePixels(){return this._repeatEdgePixels}set repeatEdgePixels(e){this._repeatEdgePixels=e,this.updatePadding()}get blurX(){return this.blurXFilter.blur}set blurX(e){this.blurXFilter.blur=e,this.updatePadding()}get blurY(){return this.blurYFilter.blur}set blurY(e){this.blurYFilter.blur=e,this.updatePadding()}get blendMode(){return this.blurYFilter.blendMode}set blendMode(e){this.blurYFilter.blendMode=e}}class VisualEffectsMaskingFilter extends AbstractBaseMaskFilter{static create({postProcessModes:e,...t}={}){const i=this.fragmentShader(e),n={...this.defaultUniforms,...t};return new this(this.vertexShader,i,n)}#ma;static FILTER_MODES=Object.freeze({BACKGROUND:0,ILLUMINATION:1,COLORATION:2});static defaultUniforms={tint:[1,1,1],screenDimensions:[1,1],enableVisionMasking:!0,visionTexture:null,darknessLevelTexture:null,exposure:0,contrast:0,saturation:0,mode:0,ambientDarkness:[0,0,0],ambientDaylight:[1,1,1],replacementColor:[0,0,0]};updatePostprocessModes(e=[],t={}){for(let[e,i]of Object.entries(t))e in this.uniforms&&(this.uniforms[e]=i);e.equals(this.#ma)||(this.#ma=e,this.program=PIXI.Program.from(this.constructor.vertexShader,this.constructor.fragmentShader(this.#ma)))}reset(){this.#ma=[],this.program=PIXI.Program.from(this.constructor.vertexShader,this.constructor.fragmentShader());const e=["tint","exposure","contrast","saturation"];for(const t of e)this.uniforms[t]=this.constructor.defaultUniforms[t]}apply(e,t,i,n,s){const o=canvas.colors,r=this.uniforms;r.mode===this.constructor.FILTER_MODES.ILLUMINATION&&(o.ambientDarkness.applyRGB(r.ambientDarkness),o.ambientDaylight.applyRGB(r.ambientDaylight)),super.apply(e,t,i,n,s)}static POST_PROCESS_TECHNIQUES={EXPOSURE:{id:"EXPOSURE",glsl:"if ( exposure != 0.0 ) {\n        finalColor.rgb *= (1.0 + exposure);\n      }"},CONTRAST:{id:"CONTRAST",glsl:"if ( contrast != 0.0 ) {\n        finalColor.rgb = (finalColor.rgb - 0.5) * (contrast + 1.0) + 0.5;\n      }"},SATURATION:{id:"SATURATION",glsl:"if ( saturation != 0.0 ) {\n        float reflection = perceivedBrightness(finalColor.rgb);\n        finalColor.rgb = mix(vec3(reflection), finalColor.rgb, 1.0 + saturation) * finalColor.a;\n      }"}};static fragmentHeader=`\n    varying vec2 vTextureCoord;\n    varying vec2 vMaskTextureCoord;\n    uniform float contrast;\n    uniform float saturation;\n    uniform float exposure;\n    uniform vec3 ambientDarkness;\n    uniform vec3 ambientDaylight;\n    uniform vec3 replacementColor;\n    uniform vec3 tint;\n    uniform sampler2D uSampler;\n    uniform sampler2D visionTexture;\n    uniform sampler2D darknessLevelTexture;\n    uniform bool enableVisionMasking;\n    uniform int mode;\n    vec4 baseColor;\n    vec4 finalColor;\n    ${this.CONSTANTS}\n    ${this.PERCEIVED_BRIGHTNESS}\n    \n    vec4 getReplacementColor() {\n      if ( mode == 0 ) return vec4(0.0);\n      if ( mode == 2 ) return vec4(replacementColor, 1.0);\n      float darknessLevel = texture2D(darknessLevelTexture, vMaskTextureCoord).r;\n      return vec4(mix(ambientDaylight, ambientDarkness, darknessLevel), 1.0);\n    }\n    `;static fragmentCore="\n    // Get the base color from the filter sampler\n    finalColor = texture2D(uSampler, vTextureCoord);\n    \n    // Handling vision masking  \n    if ( enableVisionMasking ) {\n      finalColor = mix( getReplacementColor(), \n                        finalColor, \n                        texture2D(visionTexture, vMaskTextureCoord).r);\n    }\n    ";static fragmentPostProcess(e=[]){return e.reduce(((e,t)=>e+this.POST_PROCESS_TECHNIQUES[t].glsl??""),"")}static fragmentShader(e=[]){return`\n    ${this.fragmentHeader}\n    void main() {\n      ${this.fragmentCore}\n      ${this.fragmentPostProcess(e)}\n      if ( enableVisionMasking ) finalColor *= vec4(tint, 1.0);\n      gl_FragColor = finalColor;\n    }\n    `}}class PrimaryCanvasGroupAmbienceFilter extends AbstractBaseMaskFilter{static fragmentShader=`\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n    \n    // Base ambience uniforms\n    uniform vec3 baseTint;\n    uniform float baseIntensity;\n    uniform float baseLuminosity;\n    uniform float baseSaturation;\n    uniform float baseShadows;\n    \n    // Darkness ambience uniforms\n    uniform vec3 darkTint;\n    uniform float darkIntensity;\n    uniform float darkLuminosity;\n    uniform float darkSaturation;\n    uniform float darkShadows;\n    \n    // Cycle enabled or disabled\n    uniform bool cycle;\n    \n    // Textures\n    uniform sampler2D darknessLevelTexture;\n    uniform sampler2D uSampler;\n    \n    // Varyings\n    varying vec2 vTextureCoord;\n    varying vec2 vMaskTextureCoord;\n    \n    ${this.CONSTANTS}\n    ${this.COLOR_SPACES}\n    \n    // Ambience parameters computed according to darkness level (per pixel)\n    vec3 tint;\n    float intensity;\n    float luminosity;\n    float saturation;\n    float shadows;\n    \n    /* ----------------------------------------------------------------- */\n    /*  Compute ambience parameters according to darkness level texture  */\n    /* ----------------------------------------------------------------- */\n    void computeAmbienceParameters() {\n      float dl = texture2D(darknessLevelTexture, vMaskTextureCoord).r;\n  \n      // Determine the tint based on base and dark ambience parameters\n      if ( baseIntensity > 0.0 ) tint = (cycle && darkIntensity > 0.0) ? mix(baseTint, darkTint, dl) : baseTint;\n      else if ( darkIntensity > 0.0 && cycle ) tint = darkTint;\n      else tint = vec3(1.0);\n       \n      // Compute the luminosity based on the cycle condition\n      float luminosityBase = cycle ? mix(baseLuminosity, darkLuminosity, dl) : baseLuminosity;\n      luminosity = luminosityBase * (luminosityBase >= 0.0 ? 1.2 : 0.8);\n  \n      // Compute the shadows based on the cycle condition\n      shadows = (cycle ? mix(baseShadows, darkShadows, dl) : baseShadows) * 0.15;\n  \n      // Using a non-linear easing with intensity input value: x^2\n      intensity = cycle ? mix(baseIntensity * baseIntensity, darkIntensity * darkIntensity, dl) \n                        : baseIntensity * baseIntensity;\n      \n      // Compute the saturation based on the cycle condition\n      saturation = cycle ? mix(baseSaturation, darkSaturation, dl) : baseSaturation;\n    }\n    \n    /* -------------------------------------------- */\n          \n    void main() {\n      vec4 baseColor = texture2D(uSampler, vTextureCoord);\n      \n      if ( baseColor.a > 0.0 ) {\n        computeAmbienceParameters();\n        \n        // Unmultiply rgb with alpha channel\n        baseColor.rgb /= baseColor.a;\n        \n        // Apply shadows and luminosity on sRGB values\n        if ( shadows > 0.0 ) {\n          float l = luminance(srgb2linearFast(baseColor.rgb));\n          baseColor.rgb *= min(l / shadows, 1.0);\n        }\n        if ( luminosity != 0.0 ) baseColor.rgb *= (1.0 + luminosity);\n        \n        baseColor.rgb = srgb2linear(baseColor.rgb);    // convert to linear before saturating and tinting\n       \n        // Apply saturation and tint on linearized rgb\n        if ( saturation != 0.0 ) baseColor.rgb = mix(linear2grey(baseColor.rgb), baseColor.rgb, 1.0 + saturation);\n        if ( intensity > 0.0 ) baseColor.rgb = tintColorLinear(colorClamp(baseColor.rgb), tint, intensity);\n        else baseColor.rgb = colorClamp(baseColor.rgb);\n        \n        baseColor.rgb = linear2srgb(baseColor.rgb);    // convert back to sRGB\n        \n        // Multiply rgb with alpha channel\n        baseColor.rgb *= baseColor.a;\n      }\n  \n      // Output the result\n      gl_FragColor = baseColor;\n    }\n  `;static defaultUniforms={uSampler:null,darknessLevelTexture:null,cycle:!0,baseTint:[1,1,1],baseIntensity:0,baseLuminosity:0,baseSaturation:0,baseShadows:0,darkTint:[1,1,1],darkIntensity:0,darkLuminosity:0,darkSaturation:0,darkShadows:0}}
/**
 * A filter which implements an inner or outer glow around the source texture.
 * Inspired from https://github.com/pixijs/filters/tree/main/filters/glow
 * @license MIT
 */class GlowOverlayFilter extends AbstractBaseFilter{padding=6;innerStrength=3;outerStrength=3;animated=!0;static defaultUniforms={distance:10,glowColor:[1,1,1,1],quality:.1,time:0,knockout:!0,alpha:1};static createFragmentShader(e,t){return`\n    precision mediump float;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n  \n    uniform sampler2D uSampler;\n    uniform float innerStrength;\n    uniform float outerStrength;\n    uniform float alpha;\n    uniform vec4 glowColor;\n    uniform vec4 inputSize;\n    uniform vec4 inputClamp;\n    uniform bool knockout;\n  \n    const float PI = 3.14159265358979323846264;\n    const float DIST = ${t.toFixed(0)}.0;\n    const float ANGLE_STEP_SIZE = min(${(1/e/t).toFixed(7)}, PI * 2.0);\n    const float ANGLE_STEP_NUM = ceil(PI * 2.0 / ANGLE_STEP_SIZE);\n    const float MAX_TOTAL_ALPHA = ANGLE_STEP_NUM * DIST * (DIST + 1.0) / 2.0;\n  \n    float getClip(in vec2 uv) {\n      return step(3.5,\n       step(inputClamp.x, uv.x) +\n       step(inputClamp.y, uv.y) +\n       step(uv.x, inputClamp.z) +\n       step(uv.y, inputClamp.w));\n    }\n  \n    void main(void) {\n      vec2 px = inputSize.zw;\n      float totalAlpha = 0.0;\n      vec2 direction;\n      vec2 displaced;\n      vec4 curColor;\n  \n      for (float angle = 0.0; angle < PI * 2.0; angle += ANGLE_STEP_SIZE) {\n       direction = vec2(cos(angle), sin(angle)) * px;\n       for (float curDistance = 0.0; curDistance < DIST; curDistance++) {\n         displaced = vTextureCoord + direction * (curDistance + 1.0);\n         curColor = texture2D(uSampler, displaced) * getClip(displaced);\n         totalAlpha += (DIST - curDistance) * (smoothstep(0.5, 1.0, curColor.a));\n       }\n      }\n  \n      curColor = texture2D(uSampler, vTextureCoord);\n      float alphaRatio = (totalAlpha / MAX_TOTAL_ALPHA);\n      \n      float innerGlowAlpha = (1.0 - alphaRatio) * innerStrength * smoothstep(0.6, 1.0, curColor.a);\n      float innerGlowStrength = min(1.0, innerGlowAlpha);\n      \n      vec4 innerColor = mix(curColor, glowColor, innerGlowStrength);\n\n      float outerGlowAlpha = alphaRatio * outerStrength * (1.0 - smoothstep(0.35, 1.0, curColor.a));\n      float outerGlowStrength = min(1.0 - innerColor.a, outerGlowAlpha);\n      vec4 outerGlowColor = outerGlowStrength * glowColor.rgba;\n      \n      if ( knockout ) {\n        float resultAlpha = outerGlowAlpha + innerGlowAlpha;\n        gl_FragColor = mix(vec4(glowColor.rgb * resultAlpha, resultAlpha), vec4(0.0), curColor.a);\n      }\n      else {\n        vec4 outerGlowColor = outerGlowStrength * glowColor.rgba * alpha;\n        gl_FragColor = innerColor + outerGlowColor;\n      }\n    }`}static vertexShader="\n  precision mediump float;\n  attribute vec2 aVertexPosition;\n  uniform mat3 projectionMatrix;\n  uniform vec4 inputSize;\n  uniform vec4 outputFrame;\n  varying vec2 vTextureCoord;\n\n  void main(void) {\n      vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.0)) + outputFrame.xy;\n      gl_Position = vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);\n      vTextureCoord = aVertexPosition * (outputFrame.zw * inputSize.zw);\n  }";static create(e={}){const t={...this.defaultUniforms,...e},i=this.createFragmentShader(t.quality,t.distance);return new this(this.vertexShader,i,t)}apply(e,t,i,n){let s=canvas.stage.worldTransform.d;if(this.animated&&!canvas.photosensitiveMode){const e=canvas.app.ticker.lastTime;s*=Math.oscillation(.5,2,e,2e3)}this.uniforms.outerStrength=this.outerStrength*s,this.uniforms.innerStrength=this.innerStrength*s,e.applyFilter(this,t,i,n)}}class InvisibilityFilter extends AbstractBaseFilter{static fragmentShader=`\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n    uniform vec3 color;\n    uniform sampler2D uSampler;\n    varying vec2 vTextureCoord;\n    \n    ${this.CONSTANTS}\n    ${this.PERCEIVED_BRIGHTNESS}\n          \n    void main() {\n      vec4 baseColor = texture2D(uSampler, vTextureCoord);\n      \n      // Unmultiply rgb with alpha channel\n      if ( baseColor.a > 0.0 ) baseColor.rgb /= baseColor.a;\n        \n      // Computing halo\n      float lum = perceivedBrightness(baseColor.rgb);\n      vec3 haloColor = vec3(lum) * color * 2.0;\n  \n      // Construct final image\n      gl_FragColor = vec4(haloColor, 1.0) * 0.5 * baseColor.a;\n    }\n    `;static defaultUniforms={uSampler:null,color:[.5,1,1]}}
/**
 * A filter which implements an outline.
 * Inspired from https://github.com/pixijs/filters/tree/main/filters/outline
 * @license MIT
 */class OutlineOverlayFilter extends AbstractBaseFilter{padding=3;autoFit=!1;animated=!0;static defaultUniforms={outlineColor:[1,1,1,1],thickness:[1,1],alphaThreshold:.6,knockout:!0,wave:!1};static vertexShader="\n  attribute vec2 aVertexPosition;\n\n  uniform mat3 projectionMatrix;\n  uniform vec2 screenDimensions;\n  uniform vec4 inputSize;\n  uniform vec4 outputFrame;\n\n  varying vec2 vTextureCoord;\n  varying vec2 vFilterCoord;\n\n  vec4 filterVertexPosition( void ) {\n      vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;\n      return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0., 1.);\n  }\n\n  // getting normalized coord for the tile texture\n  vec2 filterTextureCoord( void ) {\n      return aVertexPosition * (outputFrame.zw * inputSize.zw);\n  }\n\n  // getting normalized coord for a screen sized mask render texture\n  vec2 filterCoord( in vec2 textureCoord ) {\n    return textureCoord * inputSize.xy / outputFrame.zw;\n  }\n\n  void main() {\n    vTextureCoord = filterTextureCoord();\n    vFilterCoord = filterCoord(vTextureCoord);\n    gl_Position = filterVertexPosition();\n  }";static createFragmentShader(){return`\n    varying vec2 vTextureCoord;\n    varying vec2 vFilterCoord;\n    uniform sampler2D uSampler;\n    \n    uniform vec2 thickness;\n    uniform vec4 outlineColor;\n    uniform vec4 filterClamp;\n    uniform float alphaThreshold;\n    uniform float time;\n    uniform bool knockout;\n    uniform bool wave;\n    \n    ${this.CONSTANTS}\n    ${this.WAVE()}\n    \n    void main(void) {\n        float dist = distance(vFilterCoord, vec2(0.5)) * 2.0;\n        vec4 ownColor = texture2D(uSampler, vTextureCoord);\n        vec4 wColor = wave ? outlineColor * \n                             wcos(0.0, 1.0, dist * 75.0, \n                                  -time * 0.01 + 3.0 * dot(vec4(1.0), ownColor)) \n                             * 0.33 * (1.0 - dist) : vec4(0.0);\n        float texAlpha = smoothstep(alphaThreshold, 1.0, ownColor.a);\n        vec4 curColor;\n        float maxAlpha = 0.;\n        vec2 displaced;\n        for ( float angle = 0.0; angle <= TWOPI; angle += ${this.#fa.toFixed(7)} ) {\n            displaced.x = vTextureCoord.x + thickness.x * cos(angle);\n            displaced.y = vTextureCoord.y + thickness.y * sin(angle);\n            curColor = texture2D(uSampler, clamp(displaced, filterClamp.xy, filterClamp.zw));\n            curColor.a = clamp((curColor.a - 0.6) * 2.5, 0.0, 1.0);\n            maxAlpha = max(maxAlpha, curColor.a);\n        }\n        float resultAlpha = max(maxAlpha, texAlpha);\n        vec3 result = ((knockout ? vec3(0.0) : ownColor.rgb) + outlineColor.rgb * (1.0 - texAlpha)) * resultAlpha;\n        gl_FragColor = mix(vec4(result, resultAlpha), wColor, texAlpha);\n    }\n    `}static get#fa(){switch(canvas.performance.mode){case CONST.CANVAS_PERFORMANCE_MODES.LOW:return 2*Math.PI/10;case CONST.CANVAS_PERFORMANCE_MODES.MED:return 2*Math.PI/20;default:return 2*Math.PI/30}}get thickness(){return this.#va}set thickness(e){this.#va=e,this.padding=1.5*e}#va=3;static create(e={}){const t={...this.defaultUniforms,...e};return new this(this.vertexShader,this.createFragmentShader(),t)}apply(e,t,i,n){canvas.photosensitiveMode&&(this.uniforms.wave=!1);let s=0,o=this.#va*canvas.stage.scale.x;this.animated&&!canvas.photosensitiveMode&&(s=canvas.app.ticker.lastTime,o*=Math.oscillation(.75,1.25,s,1500)),this.uniforms.time=s,this.uniforms.thickness[0]=o/t._frame.width,this.uniforms.thickness[1]=o/t._frame.height,e.applyFilter(this,t,i,n)}get animate(){return foundry.utils.logCompatibilityWarning("OutlineOverlayFilter#animate is deprecated in favor of OutlineOverlayFilter#animated.",{since:12,until:14}),this.animated}set animate(e){foundry.utils.logCompatibilityWarning("OutlineOverlayFilter#animate is deprecated in favor of OutlineOverlayFilter#animated.",{since:12,until:14}),this.animated=e}}class TextureTransitionFilter extends AbstractBaseFilter{#ya=!1;static get TYPES(){return TextureTransitionFilter.#ba}static#ba=Object.freeze({FADE:"fade",SWIRL:"swirl",WATER_DROP:"waterDrop",MORPH:"morph",CROSSHATCH:"crosshatch",WIND:"wind",WAVES:"waves",WHITE_NOISE:"whiteNoise",HOLOGRAM:"hologram",HOLE:"hole",HOLE_SWIRL:"holeSwirl",GLITCH:"glitch",DOTS:"dots"});static#Sa=Object.freeze(Object.values(this.TYPES));static#Ta=Object.freeze(Object.fromEntries(this.#Sa.map(((e,t)=>[e,t]))));static#Ea=Object.freeze([this.#ba.SWIRL,this.#ba.WATER_DROP,this.#ba.WAVES,this.#ba.HOLOGRAM]);get type(){return TextureTransitionFilter.#Sa[this.uniforms.type]}set type(e){if(!(e in TextureTransitionFilter.#Ta))throw new Error("Invalid texture transition type");this.uniforms.type=TextureTransitionFilter.#Ta[e],this.#ya=TextureTransitionFilter.#Ea.includes(e)}set targetTexture(e){e.uvMatrix||(e.uvMatrix=new PIXI.TextureMatrix(e,0),e.uvMatrix.update()),this.uniforms.targetTexture=e,this.uniforms.targetUVMatrix=e.uvMatrix.mapCoord.toArray(!0)}static async animate(e,t,{type:i=this.TYPES.FADE,name:n,duration:s,easing:o}={}){if(!(e instanceof SpriteMesh||e instanceof PIXI.Sprite))throw new Error("The subject must be a subclass of SpriteMesh or PIXI.Sprite");if(!(t instanceof PIXI.Texture))throw new Error("The target texture must be a subclass of PIXI.Texture");const r=this.create();r.type=i,r.targetTexture=t,e.filters??=[],e.filters.unshift(r);const a=CanvasAnimation.animate([{attribute:"progress",parent:r.uniforms,to:1}],{name:n,duration:s,easing:o,context:e});return a.then((i=>{i&&(e.texture=t)})),a.finally((()=>{e.filters?.findSplice((e=>e===r))})),a}static defaultUniforms={tintAlpha:[1,1,1,1],targetTexture:null,progress:0,rotation:0,anchor:{x:.5,y:.5},type:1,filterMatrix:new PIXI.Matrix,filterMatrixInverse:new PIXI.Matrix,targetUVMatrix:new PIXI.Matrix};static vertexShader=`\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n\n    attribute vec2 aVertexPosition;\n\n    uniform mat3 projectionMatrix;\n    uniform mat3 filterMatrix;\n    uniform vec4 inputSize;\n    uniform vec4 outputFrame;\n\n    varying vec2 vTextureCoord;\n    varying vec2 vFilterCoord;\n\n    vec4 filterVertexPosition() {\n      vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;\n      return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);\n    }\n\n    vec2 filterTextureCoord() {\n      return aVertexPosition * (outputFrame.zw * inputSize.zw);\n    }\n\n    void main() {\n      gl_Position = filterVertexPosition();\n      vTextureCoord = filterTextureCoord();\n      vFilterCoord = (filterMatrix * vec3(vTextureCoord, 1.0)).xy;\n    }\n  `;static fragmentShader=`\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n    ${this.CONSTANTS}\n    ${this.PRNG}\n    uniform float progress;\n    uniform float rotation;\n    uniform vec2 anchor;\n    uniform int type;\n    uniform sampler2D uSampler;\n    uniform sampler2D targetTexture;\n    uniform vec4 tintAlpha;\n    uniform mat3 filterMatrixInverse;\n    uniform mat3 targetUVMatrix;\n\n    varying vec2 vTextureCoord;\n    varying vec2 vFilterCoord;\n\n    /* -------------------------------------------- */\n    /*  UV Mapping Functions                        */\n    /* -------------------------------------------- */\n\n    /* Map filter coord to source texture coord */\n    vec2 mapFuv2Suv(in vec2 uv) {\n      return (filterMatrixInverse * vec3(uv, 1.0)).xy;\n    }\n\n    /* Map filter coord to target texture coord */\n    vec2 mapFuv2Tuv(in vec2 uv) {\n      return (targetUVMatrix * vec3(uv, 1.0)).xy;\n    }\n\n    /* -------------------------------------------- */\n    /*  Clipping Functions                          */\n    /* -------------------------------------------- */\n\n    float getClip(in vec2 uv) {\n      return step(3.5,\n         step(0.0, uv.x) +\n         step(0.0, uv.y) +\n         step(uv.x, 1.0) +\n         step(uv.y, 1.0));\n    }\n\n    /* -------------------------------------------- */\n    /*  Texture Functions                           */\n    /* -------------------------------------------- */\n\n    vec4 colorFromSource(in vec2 uv) {\n      return texture2D(uSampler, uv);\n    }\n\n    vec4 colorFromTarget(in vec2 uv) {\n      return texture2D(targetTexture, mapFuv2Tuv(uv))\n                       * getClip(uv);\n    }\n\n    /* -------------------------------------------- */\n    /*  Simple transition                           */\n    /* -------------------------------------------- */\n\n    vec4 transition() {\n      return mix(\n        colorFromSource(vTextureCoord),\n        colorFromTarget(vFilterCoord),\n        progress\n      );\n    }\n    \n    /* -------------------------------------------- */\n    /*  Morphing                                    */\n    /* -------------------------------------------- */\n\n    vec4 morph() {\n      vec4 ca = colorFromSource(vTextureCoord);\n      vec4 cb = colorFromTarget(vFilterCoord);\n      float a = mix(ca.a, cb.a, progress);\n\n      vec2 oa = (((ca.rg + ca.b) * 0.5) * 2.0 - 1.0);\n      vec2 ob = (((cb.rg + cb.b) * 0.5) * 2.0 - 1.0);\n      vec2 oc = mix(oa, ob, 0.5) * 0.2;\n\n      float w0 = progress;\n      float w1 = 1.0 - w0;\n      return mix(colorFromSource(mapFuv2Suv(vFilterCoord + oc * w0)),\n                 colorFromTarget(vFilterCoord - oc * w1),\n                 progress) * smoothstep(0.0, 0.5, a);\n    }\n\n    /* -------------------------------------------- */\n    /*  Water Drop                                  */\n    /* -------------------------------------------- */\n\n    vec4 drop() {\n      vec2 dir = vFilterCoord - 0.5;\n      float dist = length(dir);\n      float da = clamp(1.6 - distance(vec2(0.0), vFilterCoord * 2.0 - 1.0), 0.0, 1.6) / 1.6;\n      vec2 offset = mix(vec2(0.0),\n                        dir * sin(dist * 35.0 - progress * 35.0),\n                        min(min(progress, 1.0 - progress) * 2.0, da));\n      return mix(colorFromSource(mapFuv2Suv(vFilterCoord + offset)),\n                 colorFromTarget(vFilterCoord + offset),\n                 progress);\n    }\n\n    /* -------------------------------------------- */\n    /*  Waves effect                                */\n    /* -------------------------------------------- */\n\n    vec2 offset(in float progress, in float x, in float str) {\n      float p = smoothstep(0.0, 1.0, min(progress, 1.0 - progress) * 2.0);\n      float shifty = str * p * cos(30.0 * (progress + x));\n      return vec2(0.0, shifty);\n    }\n\n    vec4 wavy() {\n      vec4 ca = colorFromSource(vTextureCoord);\n      vec4 cb = colorFromTarget(vFilterCoord);\n      float a = mix(ca.a, cb.a, progress);\n      vec2 shift = vFilterCoord + offset(progress, vFilterCoord.x, 0.20);\n      vec4 c0 = colorFromSource(mapFuv2Suv(shift));\n      vec4 c1 = colorFromTarget(shift);\n      return mix(c0, c1, progress);\n    }\n\n    /* -------------------------------------------- */\n    /*  White Noise                                 */\n    /* -------------------------------------------- */\n\n    float noise(vec2 co) {\n      float a = 12.9898;\n      float b = 78.233;\n      float c = 43758.5453;\n      float dt = dot(co.xy * progress, vec2(a, b));\n      float sn = mod(dt, 3.14);\n      return fract(sin(sn) * c);\n    }\n\n    vec4 whitenoise() {\n      const float m = (1.0 / 0.15);\n      vec4 noise = vec4(vec3(noise(vFilterCoord)), 1.0);\n      vec4 cr = morph();\n      float alpha = smoothstep(0.0, 0.75, cr.a);\n      return mix(cr, noise * alpha, smoothstep(0.0, 0.1, min(progress, 1.0 - progress)));\n    }\n\n    /* -------------------------------------------- */\n    /*  Swirling                                    */\n    /* -------------------------------------------- */\n\n    vec2 sphagetization(inout vec2 uv, in float p) {\n      const float r = 1.0;\n      float dist = length(uv);\n      if ( dist < r ) {\n        float percent = r - dist;\n        float a = (p <= 0.5) ? mix(0.0, 1.0, p / 0.5) : mix(1.0, 0.0, (p - 0.5) / 0.5);\n        float tt = percent * percent * a * 8.0 * PI;\n        float s = sin(tt);\n        float c = cos(tt);\n        uv = vec2(dot(uv, vec2(c, -s)), dot(uv, vec2(s, c)));\n      }\n      return uv;\n    }\n\n    vec4 swirl() {\n      float p = progress;\n      vec2 uv = vFilterCoord - 0.5;\n      uv = sphagetization(uv, p);\n      uv += 0.5;\n      vec4 c0 = colorFromSource(mapFuv2Suv(uv));\n      vec4 c1 = colorFromTarget(uv);\n      return mix(c0, c1, p) * smoothstep(0.0, 0.5, mix(c0.a, c1.a, progress));\n    }\n\n    /* -------------------------------------------- */\n    /*  Cross Hatch                                 */\n    /* -------------------------------------------- */\n\n    vec4 crosshatch() {\n      float dist = distance(vec2(0.5), vFilterCoord) / 3.0;\n      float r = progress - min(random(vec2(vFilterCoord.y, 0.0)),\n                               random(vec2(0.0, vFilterCoord.x)));\n      return mix(colorFromSource(vTextureCoord),\n                 colorFromTarget(vFilterCoord),\n                 mix(0.0,\n                     mix(step(dist, r),\n                     1.0,\n                     smoothstep(0.7, 1.0, progress)),\n                 smoothstep(0.0, 0.3, progress)));\n    }\n\n    /* -------------------------------------------- */\n    /*  Lateral Wind                                */\n    /* -------------------------------------------- */\n\n    vec4 wind() {\n      const float s = 0.2;\n      float r = random(vec2(0, vFilterCoord.y));\n      float p = smoothstep(0.0, -s, vFilterCoord.x * (1.0 - s) + s * r - (progress * (1.0 + s)));\n      return mix(\n        colorFromSource(vTextureCoord),\n        colorFromTarget(vFilterCoord),\n        p\n      );\n    }\n\n    /* -------------------------------------------- */\n    /*  Holographic effect                          */\n    /* -------------------------------------------- */\n\n    vec2 roffset(in float progress, in float x, in float theta, in float str) {\n      float shifty = (1.0 - progress) * str * progress * cos(10.0 * (progress + x));\n      return vec2(0, shifty);\n    }\n\n    vec4 hologram() {\n      float cosProg = 0.5 * (cos(2.0 * PI * progress) + 1.0);\n      vec2 os = roffset(progress, vFilterCoord.x, 0.0, 0.24);\n      vec4 fscol = colorFromSource(mapFuv2Suv(vFilterCoord + os));\n      vec4 ftcol = colorFromTarget(vFilterCoord + os);\n\n      float scintensity = max(max(fscol.r, fscol.g), fscol.b);\n      float tcintensity = max(max(ftcol.r, ftcol.g), ftcol.b);\n\n      vec4 tscol = vec4(0.0, fscol.g * 3.0, 0.0, 1.0) * scintensity;\n      vec4 ttcol = vec4(ftcol.r * 3.0, 0.0, 0.0, 1.0) * tcintensity;\n\n      vec4 iscol = vec4(0.0, fscol.g * 3.0, fscol.b * 3.0, 1.0) * scintensity;\n      vec4 itcol = vec4(ftcol.r * 3.0, 0.0, ftcol.b * 3.0, 1.0) * tcintensity;\n\n      vec4 smix = mix(mix(fscol, tscol, progress), iscol, 1.0 - cosProg);\n      vec4 tmix = mix(mix(ftcol, ttcol, 1.0 - progress), itcol, 1.0 - cosProg);\n      return mix(smix, tmix, progress);\n    }\n\n    /* -------------------------------------------- */\n    /*  Hole effect                                 */\n    /* -------------------------------------------- */\n\n    vec4 hole() {\n      vec2 uv = vFilterCoord;\n      float s = smoothstep(0.0, 1.0, min(progress, 1.0 - progress) * 2.0);\n      uv -= 0.5;\n      uv *= (1.0 + s * 30.0);\n      uv += 0.5;\n      float clip = getClip(uv);\n\n      vec4 sc = colorFromSource(mapFuv2Suv(uv)) * clip;\n      vec4 tc = colorFromTarget(uv);\n      return mix(sc, tc, smoothstep(0.4, 0.6, progress));\n    }\n\n    /* -------------------------------------------- */\n    /*  Hole Swirl effect                           */\n    /* -------------------------------------------- */\n\n    vec4 holeSwirl() {\n      vec2 uv = vFilterCoord;\n      vec4 deepBlack = vec4(vec3(0.25), 1.0);\n      float mp = min(progress, 1.0 - progress) * 2.0;\n      float sw = smoothstep(0.0, 1.0, mp);\n      uv -= 0.5;\n      uv *= (1.0 + sw * 15.0);\n      uv = sphagetization(uv, progress);\n      uv += 0.5;\n      float clip = getClip(uv);\n\n      vec4 sc = colorFromSource(mapFuv2Suv(uv)) * clip;\n      vec4 tc = colorFromTarget(uv);\n\n      float sv = smoothstep(0.0, 0.35, mp);\n      return mix(mix(sc, sc * deepBlack, sv), mix(tc, tc * deepBlack, sv), smoothstep(0.4, 0.6, progress));\n    }\n    \n    /* -------------------------------------------- */\n    /*  Glitch                                      */\n    /* -------------------------------------------- */\n\n    vec4 glitch() {\n      // Precompute constant values\n      vec2 inv64 = vec2(1.0 / 64.0);\n      vec2 uvOffset = floor(vec2(progress) * vec2(1200.0, 3500.0)) * inv64;\n      vec2 halfVec = vec2(0.5);\n  \n      // Compute block and normalized UV coordinates\n      vec2 blk = floor(vFilterCoord / vec2(16.0));\n      vec2 uvn = blk * inv64 + uvOffset;\n  \n      // Compute distortion only if progress > 0.0\n      vec2 dist = progress > 0.0 \n                  ? (fract(uvn) - halfVec) * 0.3 * (1.0 - progress) \n                  : vec2(0.0);\n  \n      // Precompute distorted coordinates\n      vec2 coords[4];\n      for ( int i = 0; i < 4; ++i ) {\n        coords[i] = vFilterCoord + dist * (0.4 - 0.1 * float(i));\n      }\n  \n      // Fetch colors and mix them\n      vec4 colorResult;\n      for ( int i = 0; i < 4; ++i ) {\n        vec4 colorSrc = colorFromSource(mapFuv2Suv(coords[i]));\n        vec4 colorTgt = colorFromTarget(coords[i]);\n        colorResult[i] = mix(colorSrc[i], colorTgt[i], progress);\n      }\n      return colorResult;\n    }\n    \n    /* -------------------------------------------- */\n    /*  Dots                                        */\n    /* -------------------------------------------- */\n    \n    vec4 dots() {\n      vec2 halfVec = vec2(0.5);\n      float distToCenter = distance(vFilterCoord, halfVec);\n      float threshold = pow(progress, 3.0) / distToCenter;\n      float distToDot = distance(fract(vFilterCoord * 30.0), halfVec);\n  \n      // Compute the factor to mix colors based on the threshold comparison\n      float isTargetFactor = step(distToDot, threshold);\n      vec4 targetColor = colorFromTarget(vFilterCoord);\n      vec4 sourceColor = colorFromSource(vTextureCoord);\n      return mix(sourceColor, targetColor, isTargetFactor);\n    }\n\n    /* -------------------------------------------- */\n    /*  Main Program                                */\n    /* -------------------------------------------- */\n\n    void main() {\n      vec4 result;\n      if ( type == 1 ) {\n        result = swirl();\n      } else if ( type == 2 ) {\n        result = drop();\n      } else if ( type == 3 ) {\n        result = morph();\n      } else if ( type == 4 ) {\n        result = crosshatch();\n      } else if ( type == 5 ) {\n        result = wind();\n      } else if ( type == 6 ) {\n        result = wavy();\n      } else if ( type == 7 ) {\n        result = whitenoise();\n      } else if ( type == 8 ) {\n        result = hologram();\n      } else if ( type == 9 ) {\n        result = hole();\n      } else if ( type == 10 ) {\n        result = holeSwirl();\n      } else if ( type == 11 ) {\n        result = glitch();\n      } else if ( type == 12 ) {\n        result = dots();\n      } else {\n        result = transition();\n      }\n      gl_FragColor = result * tintAlpha;\n    }\n  `;apply(e,t,i,n){const s=this.uniforms.filterMatrix,{sourceFrame:o,destinationFrame:r,target:a}=e.activeState;this.#ya?this.padding=.5*Math.max(a.width,a.height)*canvas.stage.worldTransform.d:this.padding=0,s.set(r.width,0,0,r.height,o.x,o.y);const l=PIXI.Matrix.TEMP_MATRIX,c=a.getLocalBounds();l.copyFrom(a.transform.worldTransform),l.invert(),s.prepend(l),s.translate(-c.x,-c.y),s.scale(1/c.width,1/c.height);const d=this.uniforms.filterMatrixInverse;d.copyFrom(s),d.invert(),e.applyFilter(this,t,i,n)}}class VisibilityFilter extends AbstractBaseMaskFilter{constructor(...e){super(...e);const t=canvas.blur;if(t.enabled){const e=PIXI.Filter.defaultResolution;this.#Ca=new t.blurPassClass(!0,t.strength,t.passes,e,t.kernels),this.#_a=new t.blurPassClass(!1,t.strength,t.passes,e,t.kernels)}this.#Ia=this.uniforms.overlayTexture,this.#Ia&&!this.#Ia.uvMatrix&&(this.#Ia.uvMatrix=new PIXI.TextureMatrix(this.#Ia.uvMatrix,0))}#Ca;#_a;#Ia;static defaultUniforms={exploredColor:[1,1,1],unexploredColor:[0,0,0],screenDimensions:[1,1],visionTexture:null,primaryTexture:null,overlayTexture:null,overlayMatrix:new PIXI.Matrix,hasOverlayTexture:!1};static create(e={},t={}){const i={...this.defaultUniforms,...e};return new this(this.vertexShader,this.fragmentShader(t),i)}static vertexShader="\n  attribute vec2 aVertexPosition;\n  uniform mat3 projectionMatrix;\n  uniform mat3 overlayMatrix;\n  varying vec2 vTextureCoord;\n  varying vec2 vMaskTextureCoord;\n  varying vec2 vOverlayCoord;\n  varying vec2 vOverlayTilingCoord;\n  uniform vec4 inputSize;\n  uniform vec4 outputFrame;\n  uniform vec4 dimensions;\n  uniform vec2 screenDimensions;\n  uniform bool hasOverlayTexture;\n\n  vec4 filterVertexPosition( void ) {\n    vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;\n    return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);\n  }\n\n  vec2 filterTextureCoord( void ) {\n    return aVertexPosition * (outputFrame.zw * inputSize.zw);\n  }\n  \n  vec2 overlayTilingTextureCoord( void ) {\n    if ( hasOverlayTexture ) return vOverlayCoord * (dimensions.xy / dimensions.zw);\n    return vOverlayCoord;\n  }\n  \n  // getting normalized coord for a screen sized mask render texture\n  vec2 filterMaskTextureCoord( in vec2 textureCoord ) {\n    return (textureCoord * inputSize.xy + outputFrame.xy) / screenDimensions;\n  }\n\n  void main(void) {\n    gl_Position = filterVertexPosition();\n    vTextureCoord = filterTextureCoord();\n    vMaskTextureCoord = filterMaskTextureCoord(vTextureCoord);\n    vOverlayCoord = (overlayMatrix * vec3(vTextureCoord, 1.0)).xy;\n    vOverlayTilingCoord = overlayTilingTextureCoord();\n  }";static fragmentShader(e){return`\n    varying vec2 vTextureCoord;\n    varying vec2 vMaskTextureCoord;\n    varying vec2 vOverlayCoord;\n    varying vec2 vOverlayTilingCoord;\n    uniform sampler2D uSampler;\n    uniform sampler2D primaryTexture;\n    uniform sampler2D overlayTexture;\n    uniform vec3 unexploredColor;\n    uniform vec3 backgroundColor;\n    uniform bool hasOverlayTexture;\n    ${e.persistentVision?"":"uniform sampler2D visionTexture;\n     uniform vec3 exploredColor;"}\n    ${this.CONSTANTS}\n    ${this.PERCEIVED_BRIGHTNESS}\n    \n    // To check if we are out of the bound\n    float getClip(in vec2 uv) {\n      return step(3.5,\n         step(0.0, uv.x) +\n         step(0.0, uv.y) +\n         step(uv.x, 1.0) +\n         step(uv.y, 1.0));\n    }\n    \n    // Unpremultiply fog texture\n    vec4 unPremultiply(in vec4 pix) {\n      if ( !hasOverlayTexture || (pix.a == 0.0) ) return pix;\n      return vec4(pix.rgb / pix.a, pix.a);\n    }\n  \n    void main() {\n      float r = texture2D(uSampler, vTextureCoord).r;               // Revealed red channel from the filter texture\n      ${e.persistentVision?"":"float v = texture2D(visionTexture, vMaskTextureCoord).r;"} // Vision red channel from the vision cached container\n      vec4 baseColor = texture2D(primaryTexture, vMaskTextureCoord);// Primary cached container renderTexture color\n      vec4 fogColor = hasOverlayTexture \n                      ? texture2D(overlayTexture, vOverlayTilingCoord) * getClip(vOverlayCoord)\n                      : baseColor;      \n      fogColor = unPremultiply(fogColor);\n      \n      // Compute fog exploration colors\n      ${e.persistentVision?"":"float reflec = perceivedBrightness(baseColor.rgb);\n      vec4 explored = vec4(min((exploredColor * reflec) + (baseColor.rgb * exploredColor), vec3(1.0)), 0.5);"}\n      vec4 unexplored = hasOverlayTexture\n                        ? mix(vec4(unexploredColor, 1.0), vec4(fogColor.rgb * backgroundColor, 1.0), fogColor.a)\n                        : vec4(unexploredColor, 1.0);\n  \n      // Mixing components to produce fog of war\n      ${e.persistentVision?"gl_FragColor = mix(unexplored, vec4(0.0), r);":"vec4 fow = mix(unexplored, explored, max(r,v));\n       gl_FragColor = mix(fow, vec4(0.0), v);"}\n      \n      // Output the result\n      gl_FragColor.rgb *= gl_FragColor.a;\n    }`}set blur(e){this.#Ca&&(this.#Ca.blur=this.#_a.blur=e)}get blur(){return this.#_a?.blur}apply(e,t,i,n){if(this.calculateMatrix(e),canvas.blur.enabled){const i=e.getFilterTexture();this.state.blend=!1,this.#Ca.apply(e,t,i,PIXI.CLEAR_MODES.NONE),this.#_a.apply(e,i,t,PIXI.CLEAR_MODES.NONE),this.state.blend=!0,e.returnFilterTexture(i)}super.apply(e,t,i,n)}calculateMatrix(e){if(!this.uniforms.hasOverlayTexture||!this.#Ia)return;this.#Ia&&!this.#Ia.uvMatrix&&(this.#Ia.uvMatrix=new PIXI.TextureMatrix(this.#Ia.uvMatrix,0)),this.#Ia.uvMatrix.update();const t=e.calculateSpriteMatrix(this.uniforms.overlayMatrix,canvas.visibility.visibilityOverlay);this.uniforms.overlayMatrix=t.prepend(this.#Ia.uvMatrix.mapCoord)}}class VisionMaskFilter extends AbstractBaseMaskFilter{static fragmentShader="\n    precision mediump float;\n    varying vec2 vTextureCoord;\n    varying vec2 vMaskTextureCoord;\n    uniform sampler2D uSampler;\n    uniform sampler2D uMaskSampler;\n    void main() {\n      float mask = texture2D(uMaskSampler, vMaskTextureCoord).r;\n      gl_FragColor = texture2D(uSampler, vTextureCoord) * mask;\n    }";static defaultUniforms={uMaskSampler:null};static create(){return super.create({uMaskSampler:canvas.masks.vision.renderTexture})}get enabled(){return canvas.visibility.visible}set enabled(e){}}class VoidFilter extends AbstractBaseFilter{static fragmentShader="\n  varying vec2 vTextureCoord;\n  uniform sampler2D uSampler;\n  void main() {\n    gl_FragColor = texture2D(uSampler, vTextureCoord);\n  }"}class WeatherOcclusionMaskFilter extends AbstractBaseMaskFilter{elevation=1/0;static vertexShader="\n    attribute vec2 aVertexPosition;\n  \n    // Filter globals uniforms\n    uniform mat3 projectionMatrix;\n    uniform mat3 terrainUvMatrix;\n    uniform vec4 inputSize;\n    uniform vec4 outputFrame;\n    \n    // Needed to compute mask and terrain normalized coordinates\n    uniform vec2 screenDimensions;\n    \n    // Needed for computing scene sized texture coordinates \n    uniform vec2 sceneAnchor;\n    uniform vec2 sceneDimensions;\n    uniform bool useTerrain;\n  \n    varying vec2 vTextureCoord;\n    varying vec2 vMaskTextureCoord;\n    varying vec2 vTerrainTextureCoord;\n    varying vec2 vSceneCoord;\n  \n    vec4 filterVertexPosition( void ) {\n        vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;\n        return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0., 1.);\n    }\n  \n    // getting normalized coord for the tile texture\n    vec2 filterTextureCoord( void ) {\n        return aVertexPosition * (outputFrame.zw * inputSize.zw);\n    }\n  \n    // getting normalized coord for a screen sized mask render texture\n    vec2 filterMaskTextureCoord( void ) {\n      return (aVertexPosition * outputFrame.zw + outputFrame.xy) / screenDimensions;\n    }\n    \n    vec2 filterTerrainSceneCoord( in vec2 textureCoord ) {\n      return (textureCoord - (sceneAnchor / screenDimensions)) * (screenDimensions / sceneDimensions);\n    }\n    \n    // get normalized terrain texture coordinates\n    vec2 filterTerrainTextureCoord( in vec2 sceneCoord ) {\n      return (terrainUvMatrix * vec3(vSceneCoord, 1.0)).xy;\n    }\n  \n    void main() {\n      vTextureCoord = filterTextureCoord();\n      if ( useTerrain ) {\n        vSceneCoord = filterTerrainSceneCoord(vTextureCoord);\n        vTerrainTextureCoord = filterTerrainTextureCoord(vSceneCoord);\n      }\n      vMaskTextureCoord = filterMaskTextureCoord();\n      gl_Position = filterVertexPosition();\n    }";static fragmentShader=" \n    // Occlusion mask uniforms\n    uniform bool useOcclusion;\n    uniform sampler2D occlusionTexture;\n    uniform bool reverseOcclusion;\n    uniform vec4 occlusionWeights;\n    \n    // Terrain mask uniforms\n    uniform bool useTerrain;\n    uniform sampler2D terrainTexture;\n    uniform bool reverseTerrain;\n    uniform vec4 terrainWeights;\n    \n    // Other uniforms\n    varying vec2 vTextureCoord;\n    varying vec2 vMaskTextureCoord;\n    varying vec2 vTerrainTextureCoord;\n    varying vec2 vSceneCoord;\n    uniform sampler2D uSampler;\n    uniform float depthElevation;\n    uniform highp mat3 terrainUvMatrix;\n    \n    // Clip the terrain texture if out of bounds\n    float getTerrainClip(vec2 uv) {\n      return step(3.5,\n         step(0.0, uv.x) +\n         step(0.0, uv.y) +\n         step(uv.x, 1.0) +\n         step(uv.y, 1.0));\n    }\n    \n    void main() {     \n      // Base mask value \n      float mask = 1.0;\n      \n      // Process the occlusion mask\n      if ( useOcclusion ) {\n        float oMask = step(depthElevation, (254.5 / 255.0) - dot(occlusionWeights, texture2D(occlusionTexture, vMaskTextureCoord)));\n        if ( reverseOcclusion ) oMask = 1.0 - oMask;\n        mask *= oMask;\n      }\n                    \n      // Process the terrain mask \n      if ( useTerrain ) {\n        float tMask = dot(terrainWeights, texture2D(terrainTexture, vTerrainTextureCoord));\n        if ( reverseTerrain ) tMask = 1.0 - tMask;\n        mask *= (tMask * getTerrainClip(vSceneCoord));\n      }\n      \n      // Process filtering and apply mask value\n      gl_FragColor = texture2D(uSampler, vTextureCoord) * mask;\n    }";static defaultUniforms={depthElevation:0,useOcclusion:!0,occlusionTexture:null,reverseOcclusion:!1,occlusionWeights:[0,0,1,0],useTerrain:!1,terrainTexture:null,reverseTerrain:!1,terrainWeights:[1,0,0,0],sceneDimensions:[0,0],sceneAnchor:[0,0],terrainUvMatrix:new PIXI.Matrix};apply(e,t,i,n,s){if(this.uniforms.useTerrain){const e=canvas.stage.worldTransform,t=e.d,i=canvas.scene.dimensions;this.uniforms.sceneAnchor[0]=e.tx+i.sceneX*t,this.uniforms.sceneAnchor[1]=e.ty+i.sceneY*t,this.uniforms.sceneDimensions[0]=i.sceneWidth*t,this.uniforms.sceneDimensions[1]=i.sceneHeight*t}return this.uniforms.depthElevation=canvas.masks.depth.mapElevation(this.elevation),super.apply(e,t,i,n,s)}}class GridShader extends AbstractBaseShader{static TYPE_UNIFORM=`\n    const int TYPE_SQUARE = ${CONST.GRID_TYPES.SQUARE};\n    const int TYPE_HEXODDR = ${CONST.GRID_TYPES.HEXODDR};\n    const int TYPE_HEXEVENR = ${CONST.GRID_TYPES.HEXEVENR};\n    const int TYPE_HEXODDQ = ${CONST.GRID_TYPES.HEXODDQ};\n    const int TYPE_HEXEVENQ = ${CONST.GRID_TYPES.HEXEVENQ};\n\n    uniform lowp int type;\n\n    #define TYPE_IS_SQUARE (type == TYPE_SQUARE)\n    #define TYPE_IS_HEXAGONAL ((TYPE_HEXODDR <= type) && (type <= TYPE_HEXEVENQ))\n    #define TYPE_IS_HEXAGONAL_COLUMNS ((type == TYPE_HEXODDQ) || (type == TYPE_HEXEVENQ))\n    #define TYPE_IS_HEXAGONAL_ROWS ((type == TYPE_HEXODDR) || (type == TYPE_HEXEVENR))\n    #define TYPE_IS_HEXAGONAL_EVEN ((type == TYPE_HEXEVENR) || (type == TYPE_HEXEVENQ))\n    #define TYPE_IS_HEXAGONAL_ODD ((type == TYPE_HEXODDR) || (type == TYPE_HEXODDQ))\n  `;static THICKNESS_UNIFORM="uniform float thickness;";static COLOR_UNIFORM="uniform vec4 color;";static RESOLUTION_UNIFORM="uniform float resolution;";static ANTIALIASED_STEP_FUNCTION="\n    #define ANTIALIASED_STEP_TEMPLATE(type)       type antialiasedStep(type edge, type x) {         return clamp(((x - edge) * resolution) + 0.5, type(0.0), type(1.0));       }\n\n    ANTIALIASED_STEP_TEMPLATE(float)\n    ANTIALIASED_STEP_TEMPLATE(vec2)\n    ANTIALIASED_STEP_TEMPLATE(vec3)\n    ANTIALIASED_STEP_TEMPLATE(vec4)\n\n    #undef ANTIALIASED_STEP_TEMPLATE\n  ";static LINE_COVERAGE_FUNCTION="\n    float lineCoverage(float distance, float thickness, float alignment) {\n      float alpha0 = antialiasedStep((0.0 - alignment) * thickness, distance);\n      float alpha1 = antialiasedStep((1.0 - alignment) * thickness, distance);\n      return alpha0 - alpha1;\n    }\n\n    float lineCoverage(float distance, float thickness) {\n      return lineCoverage(distance, thickness, 0.5);\n    }\n  ";static HEXAGONAL_FUNCTIONS="\n    vec2 pointToCube(vec2 p) {\n      float x = p.x;\n      float y = p.y;\n      float q;\n      float r;\n      float e = TYPE_IS_HEXAGONAL_EVEN ? 1.0 : 0.0;\n      if ( TYPE_IS_HEXAGONAL_COLUMNS ) {\n        q = ((2.0 * SQRT1_3) * x) - (2.0 / 3.0);\n        r = (-0.5 * (q + e)) + y;\n      } else {\n        r = ((2.0 * SQRT1_3) * y) - (2.0 / 3.0);\n        q = (-0.5 * (r + e)) + x;\n      }\n      return vec2(q, r);\n    }\n\n    vec2 cubeToPoint(vec2 a) {\n      float q = a[0];\n      float r = a[1];\n      float x;\n      float y;\n      float e = TYPE_IS_HEXAGONAL_EVEN ? 1.0 : 0.0;\n      if ( TYPE_IS_HEXAGONAL_COLUMNS ) {\n        x = (SQRT3 / 2.0) * (q + (2.0 / 3.0));\n        y = (0.5 * (q + e)) + r;\n      } else {\n        y = (SQRT3 / 2.0) * (r + (2.0 / 3.0));\n        x = (0.5 * (r + e)) + q;\n      }\n      return vec2(x, y);\n    }\n\n    vec2 offsetToCube(vec2 o) {\n      float i = o[0];\n      float j = o[1];\n      float q;\n      float r;\n      float e = TYPE_IS_HEXAGONAL_EVEN ? 1.0 : -1.0;\n      if ( TYPE_IS_HEXAGONAL_COLUMNS ) {\n        q = j;\n        r = i - ((j + (e * mod(j, 2.0))) * 0.5);\n      } else {\n        q = j - ((i + (e * mod(i, 2.0))) * 0.5);\n        r = i;\n      }\n      return vec2(q, r);\n    }\n\n    ivec2 offsetToCube(ivec2 o) {\n      int i = o[0];\n      int j = o[1];\n      int q;\n      int r;\n      int e = TYPE_IS_HEXAGONAL_EVEN ? 1 : -1;\n      if ( TYPE_IS_HEXAGONAL_COLUMNS ) {\n        q = j;\n        r = i - ((j + (e * (j & 1))) / 2);\n      } else {\n        q = j - ((i + (e * (i & 1))) / 2);\n        r = i;\n      }\n      return ivec2(q, r);\n    }\n\n    vec2 cubeToOffset(vec2 a) {\n      float q = a[0];\n      float r = a[1];\n      float i;\n      float j;\n      float e = TYPE_IS_HEXAGONAL_EVEN ? 1.0 : -1.0;\n      if ( TYPE_IS_HEXAGONAL_COLUMNS ) {\n          j = q;\n          i = r + ((q + (e * mod(q, 2.0))) * 0.5);\n      } else {\n          i = r;\n          j = q + ((r + (e * mod(r, 2.0))) * 0.5);\n      }\n      return vec2(i, j);\n    }\n\n    ivec2 cubeToOffset(ivec2 a) {\n      int q = a[0];\n      int r = a[1];\n      int i;\n      int j;\n      int e = TYPE_IS_HEXAGONAL_EVEN ? 1 : -1;\n      if ( TYPE_IS_HEXAGONAL_COLUMNS ) {\n          j = q;\n          i = r + ((q + (e * (q & 1))) / 2);\n      } else {\n          i = r;\n          j = q + ((r + (e * (r & 1))) / 2);\n      }\n      return ivec2(i, j);\n    }\n\n    vec2 cubeRound(vec2 a) {\n      float q = a[0];\n      float r = a[1];\n      float s = -q - r;\n      float iq = floor(q + 0.5);\n      float ir = floor(r + 0.5);\n      float is = floor(s + 0.5);\n      float dq = abs(iq - q);\n      float dr = abs(ir - r);\n      float ds = abs(is - s);\n      if ( (dq > dr) && (dq > ds) ) {\n        iq = -ir - is;\n      } else if ( dr > ds ) {\n        ir = -iq - is;\n      } else {\n        is = -iq - ir;\n      }\n      return vec2(iq, ir);\n    }\n\n    float cubeDistance(vec2 a, vec2 b) {\n      vec2 c = b - a;\n      float q = c[0];\n      float r = c[1];\n      return (abs(q) + abs(r) + abs(q + r)) * 0.5;\n    }\n\n    int cubeDistance(ivec2 a, ivec2 b) {\n      ivec2 c = b - a;\n      int q = c[0];\n      int r = c[1];\n      return (abs(q) + abs(r) + abs(q + r)) / 2;\n    }\n  ";static NEAREST_VERTEX_FUNCTION="\n    vec2 nearestVertex(vec2 p) {\n      if ( TYPE_IS_SQUARE ) {\n        return floor(p + 0.5);\n      }\n\n      if ( TYPE_IS_HEXAGONAL ) {\n        vec2 c = cubeToPoint(cubeRound(pointToCube(p)));\n        vec2 d = p - c;\n        float a = atan(d.y, d.x);\n        if ( TYPE_IS_HEXAGONAL_COLUMNS ) {\n          a = floor((a / (PI / 3.0)) + 0.5) * (PI / 3.0);\n        } else {\n          a = (floor(a / (PI / 3.0)) + 0.5) * (PI / 3.0);\n        }\n        return c + (vec2(cos(a), sin(a)) * SQRT1_3);\n      }\n    }\n  ";static EDGE_DISTANCE_FUNCTION="\n    float edgeDistance(vec2 p) {\n      if ( TYPE_IS_SQUARE ) {\n        vec2 d = abs(p - floor(p + 0.5));\n        return min(d.x, d.y);\n      }\n\n      if ( TYPE_IS_HEXAGONAL ) {\n        vec2 a = pointToCube(p);\n        vec2 b = cubeRound(a);\n        vec2 c = b - a;\n        float q = c[0];\n        float r = c[1];\n        float s = -q - r;\n        return (2.0 - (abs(q - r) + abs(r - s) + abs(s - q))) * 0.25;\n      }\n    }\n  ";static EDGE_OFFSET_FUNCTION="\n    vec3 edgeOffset(vec2 p) {\n      if ( TYPE_IS_SQUARE ) {\n        vec2 d = abs(p - floor(p + 0.5));\n        return vec3(max(d.x, d.y), min(d.x, d.y), 1.0);\n      }\n\n      if ( TYPE_IS_HEXAGONAL ) {\n        vec2 c = cubeToPoint(cubeRound(pointToCube(p)));\n        vec2 d = p - c;\n        float a = atan(d.y, d.x);\n        if ( TYPE_IS_HEXAGONAL_COLUMNS ) {\n          a = (floor(a / (PI / 3.0)) + 0.5) * (PI / 3.0);\n        } else {\n          a = floor((a / (PI / 3.0)) + 0.5) * (PI / 3.0);\n        }\n        vec2 n = vec2(cos(a), sin(a));\n        return vec3((0.5 * SQRT1_3) + dot(d, vec2(-n.y, n.x)), 0.5 - dot(d, n), SQRT1_3);\n      }\n    }\n  ";static DRAW_GRID_FUNCTION="\n    const int STYLE_LINE_SOLID = 0;\n    const int STYLE_LINE_DASHED = 1;\n    const int STYLE_LINE_DOTTED = 2;\n    const int STYLE_POINT_SQUARE = 3;\n    const int STYLE_POINT_DIAMOND = 4;\n    const int STYLE_POINT_ROUND = 5;\n\n    vec4 drawGrid(vec2 point, int style, float thickness, vec4 color) {\n      float alpha;\n\n      if ( style == STYLE_POINT_SQUARE ) {\n        vec2 offset = abs(nearestVertex(point) - point);\n        float distance = max(offset.x, offset.y);\n        alpha = lineCoverage(distance, thickness);\n      }\n\n      else if ( style == STYLE_POINT_DIAMOND ) {\n        vec2 offset = abs(nearestVertex(point) - point);\n        float distance = (offset.x + offset.y) * SQRT1_2;\n        alpha = lineCoverage(distance, thickness);\n      }\n\n      else if ( style == STYLE_POINT_ROUND ) {\n        float distance = distance(point, nearestVertex(point));\n        alpha = lineCoverage(distance, thickness);\n      }\n\n      else if ( style == STYLE_LINE_SOLID ) {\n        float distance = edgeDistance(point);\n        alpha = lineCoverage(distance, thickness);\n      }\n\n      else if ( (style == STYLE_LINE_DASHED) || (style == STYLE_LINE_DOTTED) ) {\n        vec3 offset = edgeOffset(point);\n        if ( (style == STYLE_LINE_DASHED) && TYPE_IS_HEXAGONAL ) {\n          float padding = thickness * ((1.0 - SQRT1_3) * 0.5);\n          offset.x += padding;\n          offset.z += (padding * 2.0);\n        }\n\n        float intervals = offset.z * 0.5 / thickness;\n        if ( intervals < 0.5 ) {\n          alpha = lineCoverage(offset.y, thickness);\n        } else {\n          float interval = thickness * (2.0 * (intervals / floor(intervals + 0.5)));\n          float dx = offset.x - (floor((offset.x / interval) + 0.5) * interval);\n          float dy = offset.y;\n\n          if ( style == STYLE_LINE_DOTTED ) {\n            alpha = lineCoverage(length(vec2(dx, dy)), thickness);\n          } else {\n            alpha = min(lineCoverage(dx, thickness), lineCoverage(dy, thickness));\n          }\n        }\n      }\n\n      return color * alpha;\n    }\n  ";static vertexShader=`\n    #version 300 es\n\n    ${this.GLSL1_COMPATIBILITY_VERTEX}\n\n    precision ${PIXI.settings.PRECISION_VERTEX} float;\n\n    in vec2 aVertexPosition;\n\n    uniform mat3 translationMatrix;\n    uniform mat3 projectionMatrix;\n    uniform vec4 meshDimensions;\n    uniform vec2 canvasDimensions;\n    uniform vec4 sceneDimensions;\n    uniform vec2 screenDimensions;\n    uniform float gridSize;\n\n    out vec2 vGridCoord; // normalized grid coordinates\n    out vec2 vCanvasCoord; // normalized canvas coordinates\n    out vec2 vSceneCoord; // normalized scene coordinates\n    out vec2 vScreenCoord; // normalized screen coordinates\n\n    void main() {\n      vec2 pixelCoord = (aVertexPosition * meshDimensions.zw) + meshDimensions.xy;\n      vGridCoord = pixelCoord / gridSize;\n      vCanvasCoord = pixelCoord / canvasDimensions;\n      vSceneCoord = (pixelCoord - sceneDimensions.xy) / sceneDimensions.zw;\n      vec3 tPos = translationMatrix * vec3(aVertexPosition, 1.0);\n      vScreenCoord = tPos.xy / screenDimensions;\n      gl_Position = vec4((projectionMatrix * tPos).xy, 0.0, 1.0);\n    }\n  `;static get fragmentShader(){return`\n      #version 300 es\n\n      ${this.GLSL1_COMPATIBILITY_FRAGMENT}\n\n      precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n\n      in vec2 vGridCoord; // normalized grid coordinates\n      in vec2 vCanvasCoord; // normalized canvas coordinates\n      in vec2 vSceneCoord; // normalized scene coordinates\n      in vec2 vScreenCoord; // normalized screen coordinates\n\n      ${this.CONSTANTS}\n\n      ${this.TYPE_UNIFORM}\n      ${this.THICKNESS_UNIFORM}\n      ${this.COLOR_UNIFORM}\n      ${this.RESOLUTION_UNIFORM}\n\n      ${this.ANTIALIASED_STEP_FUNCTION}\n      ${this.LINE_COVERAGE_FUNCTION}\n      ${this.HEXAGONAL_FUNCTIONS}\n      ${this.NEAREST_VERTEX_FUNCTION}\n      ${this.EDGE_DISTANCE_FUNCTION}\n      ${this.EDGE_OFFSET_FUNCTION}\n\n      ${this._fragmentShader}\n\n      uniform float alpha;\n\n      out vec4 fragColor;\n\n      void main() {\n        fragColor = _main() * alpha;\n      }\n    `}static _fragmentShader=`\n    uniform lowp int style;\n\n    ${this.DRAW_GRID_FUNCTION}\n\n    vec4 _main() {\n      return drawGrid(vGridCoord, style, thickness, color);\n    }\n  `;static defaultUniforms={canvasDimensions:[1,1],meshDimensions:[0,0,1,1],sceneDimensions:[0,0,1,1],screenDimensions:[1,1],gridSize:1,type:0,thickness:0,resolution:0,color:[0,0,0,0],alpha:0,style:0};configure(e){"style"in e&&(this.uniforms.style=e.style??0)}#wa=new PIXI.Color(0);_preRender(e,t){const i=e.data,n=i.size,s=this.uniforms,o=canvas.dimensions;s.meshDimensions[0]=e.x,s.meshDimensions[1]=e.y,s.meshDimensions[2]=i.width,s.meshDimensions[3]=i.height,s.canvasDimensions[0]=o.width,s.canvasDimensions[1]=o.height,s.sceneDimensions=o.sceneRect,s.screenDimensions=canvas.screenDimensions,s.gridSize=n,s.type=i.type,s.thickness=i.thickness/n,s.alpha=e.worldAlpha,this.#wa.setValue(i.color).toArray(s.color);const{resolution:r}=t.renderTexture.current??t;let a=r*e.worldTransform.a/i.width;const l=t.projection.transform;if(l){const{a:e,b:t}=l;a*=Math.sqrt(e*e+t*t)}s.resolution=a*n}}class AbstractWeatherShader extends AbstractBaseShader{constructor(...e){super(...e),Object.defineProperties(this,Object.keys(this.constructor.defaultUniforms).reduce(((e,t)=>(e[t]={get(){return this.uniforms[t]},set(e){this.uniforms[t]=e},enumerable:!1},e)),{}))}static COMPUTE_MASK="\n    // Base mask value \n    float mask = 1.0;\n    \n    // Process the occlusion mask\n    if ( useOcclusion ) {\n      float oMask = step(depthElevation, (254.5 / 255.0) - dot(occlusionWeights, texture2D(occlusionTexture, vUvsOcclusion)));\n      if ( reverseOcclusion ) oMask = 1.0 - oMask;\n      mask *= oMask;\n    }\n                  \n    // Process the terrain mask \n    if ( useTerrain ) {\n      float tMask = dot(terrainWeights, texture2D(terrainTexture, vUvsTerrain));\n      if ( reverseTerrain ) tMask = 1.0 - tMask;\n      mask *= tMask;\n    }\n  ";static FRAGMENT_HEADER=`\n    precision ${PIXI.settings.PRECISION_FRAGMENT} float;\n    \n    // Occlusion mask uniforms\n    uniform bool useOcclusion;\n    uniform sampler2D occlusionTexture;\n    uniform bool reverseOcclusion;\n    uniform vec4 occlusionWeights;\n    \n    // Terrain mask uniforms\n    uniform bool useTerrain;\n    uniform sampler2D terrainTexture;\n    uniform bool reverseTerrain;\n    uniform vec4 terrainWeights;\n\n    // Other uniforms and varyings\n    uniform vec3 tint;\n    uniform float time;\n    uniform float depthElevation;\n    uniform float alpha;\n    varying vec2 vUvsOcclusion;\n    varying vec2 vUvsTerrain;\n    varying vec2 vStaticUvs;\n    varying vec2 vUvs;\n  `;static commonUniforms={terrainUvMatrix:new PIXI.Matrix,useOcclusion:!1,occlusionTexture:null,reverseOcclusion:!1,occlusionWeights:[0,0,1,0],useTerrain:!1,terrainTexture:null,reverseTerrain:!1,terrainWeights:[1,0,0,0],alpha:1,tint:[1,1,1],screenDimensions:[1,1],effectDimensions:[1,1],depthElevation:1,time:0};static defaultUniforms;static create(e){return new this(this.createProgram(),{...this.commonUniforms,...this.defaultUniforms,...e})}static createProgram(){return PIXI.Program.from(this.vertexShader,this.fragmentShader)}static vertexShader=`\n    precision ${PIXI.settings.PRECISION_VERTEX} float;\n    attribute vec2 aVertexPosition;\n    uniform mat3 translationMatrix;\n    uniform mat3 projectionMatrix;\n    uniform mat3 terrainUvMatrix;\n    uniform vec2 screenDimensions;\n    uniform vec2 effectDimensions;\n    varying vec2 vUvsOcclusion;\n    varying vec2 vUvsTerrain;\n    varying vec2 vUvs;\n    varying vec2 vStaticUvs;\n  \n    void main() {    \n      vec3 tPos = translationMatrix * vec3(aVertexPosition, 1.0);\n      vStaticUvs = aVertexPosition;\n      vUvs = vStaticUvs * effectDimensions;\n      vUvsOcclusion = tPos.xy / screenDimensions;\n      vUvsTerrain = (terrainUvMatrix * vec3(aVertexPosition, 1.0)).xy;\n      gl_Position = vec4((projectionMatrix * tPos).xy, 0.0, 1.0);\n    }\n  `;set scale(e){this.#Da.x="object"==typeof e?e.x:e,this.#Da.y=("object"==typeof e?e.y:e)??this.#Da.x}set scaleX(e){this.#Da.x=e??1}set scaleY(e){this.#Da.y=e??1}#Da={x:1,y:1};speed=1;_preRender(e,t){this.uniforms.alpha=e.worldAlpha,this.uniforms.depthElevation=canvas.masks.depth.mapElevation(canvas.weather.elevation),this.uniforms.time+=canvas.app.ticker.deltaMS/1e3*this.speed,this.uniforms.screenDimensions=canvas.screenDimensions,this.uniforms.effectDimensions[0]=this.#Da.x*e.scale.x/1e4,this.uniforms.effectDimensions[1]=this.#Da.y*e.scale.y/1e4}}class WeatherShaderEffect extends QuadMesh{constructor(e,t){super(t),this.stop(),this._initialize(e)}configure(e={}){for(const[t,i]of Object.entries(e))t in this.shader?this.shader[t]=i:t in this.shader.uniforms&&(this.shader.uniforms[t]=i)}play(){this.visible=!0}stop(){this.visible=!1}_initialize(e){this.configure(e);const t=canvas.dimensions.sceneRect;this.position.set(t.x,t.y),this.width=t.width,this.height=t.height}}class FogShader extends AbstractWeatherShader{static defaultUniforms={intensity:1,rotation:0,slope:.25};static OCTAVES(e){return`${e+2}`}static FOG(e){return 0===e?"vec2 mv = vec2(fbm(uv * 4.5 + time * 0.115)) * (1.0 + r * 0.25);\n        mist += fbm(uv * 4.5 + mv - time * 0.0275) * (1.0 + r * 0.25);":"for ( int i=0; i<2; i++ ) {\n        vec2 mv = vec2(fbm(uv * 4.5 + time * 0.115 + vec2(float(i) * 250.0))) * (0.50 + r * 0.25);\n        mist += fbm(uv * 4.5 + mv - time * 0.0275) * (0.50 + r * 0.25);\n    }"}static createProgram(){const e=canvas?.performance.mode??2;return PIXI.Program.from(this.vertexShader,this.fragmentShader(e))}static fragmentShader(e){return`\n    ${this.FRAGMENT_HEADER}\n    uniform float intensity;\n    uniform float slope;\n    uniform float rotation;\n    \n    ${this.CONSTANTS}\n    ${this.PERCEIVED_BRIGHTNESS}\n    ${this.PRNG}\n    ${this.ROTATION}\n     \n    // ********************************************************* //\n\n    float fnoise(in vec2 coords) {\n      vec2 i = floor(coords);\n      vec2 f = fract(coords);\n    \n      float a = random(i);\n      float b = random(i + vec2(1.0, 0.0));\n      float c = random(i + vec2(0.0, 1.0));\n      float d = random(i + vec2(1.0, 1.0));\n      vec2 cb = f * f * (3.0 - 2.0 * f);\n    \n      return mix(a, b, cb.x) + (c - a) * cb.y * (1.0 - cb.x) + (d - b) * cb.x * cb.y;\n    }\n     \n    // ********************************************************* //\n\n    float fbm(in vec2 uv) {\n      float r = 0.0;\n      float scale = 1.0;  \n      uv += time * 0.03;\n      uv *= 2.0;\n        \n      for (int i = 0; i < ${this.OCTAVES(e)}; i++) {\n        r += fnoise(uv + time * 0.03) * scale;\n        uv *= 3.0;\n        scale *= 0.3;\n      }\n      return r;\n    }\n    \n    // ********************************************************* //\n    \n    vec3 mist(in vec2 uv, in float r) {\n      float mist = 0.0;\n      ${this.FOG(e)}\n      return vec3(0.9, 0.85, 1.0) * mist;\n    }\n    \n    // ********************************************************* //\n    \n    void main() {\n      ${this.COMPUTE_MASK}\n      \n      vec2 ruv;\n      if ( rotation != 0.0 ) {\n        ruv = vUvs - 0.5;\n        ruv *= rot(rotation);\n        ruv += 0.5;\n      }\n      else {\n        ruv = vUvs;\n      }\n      \n      vec3 col = mist(ruv * 2.0 - 1.0, 0.0) * 1.33;\n      float pb = perceivedBrightness(col);\n      pb = smoothstep(slope * 0.5, slope + 0.001, pb);\n      \n      gl_FragColor = vec4( mix(vec3(0.05, 0.05, 0.08), col * clamp(slope, 1.0, 2.0), pb), 1.0) \n                     * vec4(tint, 1.0) * intensity * mask * alpha;\n    }\n    `}}class RainShader extends AbstractWeatherShader{static defaultUniforms={opacity:1,intensity:1,strength:1,rotation:.5,resolution:[3200,80]};static fragmentShader=`\n    ${this.FRAGMENT_HEADER}\n    ${this.CONSTANTS}\n    ${this.PERCEIVED_BRIGHTNESS}\n    ${this.ROTATION}\n    ${this.PRNG2D}\n    ${this.VORONOI}\n    \n    uniform float intensity;\n    uniform float opacity;\n    uniform float strength;\n    uniform float rotation;\n    uniform vec2 resolution;\n\n    // Compute rain according to uv and dimensions for layering\n    float computeRain(in vec2 uv, in float t) {\n      vec2 tuv = uv;\n      vec2 ruv = ((tuv + 0.5) * rot(rotation)) - 0.5;\n      ruv.y -= t * 0.8;\n      vec2 st = ruv * resolution;\n      vec3 d2 = voronoi(vec3(st - t * 0.5, t * 0.8), 10.0);\n      float df = perceivedBrightness(d2);\n      return (1.0 - smoothstep(-df * strength, df * strength + 0.001, 1.0 - smoothstep(0.3, 1.0, d2.z))) * intensity;\n    }\n\n    void main() {\n      ${this.COMPUTE_MASK}\n      gl_FragColor = vec4(vec3(computeRain(vUvs, time)) * tint, 1.0) * alpha * mask * opacity;\n    }\n  `}class SnowShader extends AbstractWeatherShader{static defaultUniforms={direction:1.2};static fragmentShader=`\n    ${this.FRAGMENT_HEADER}\n    uniform float direction;\n\n    // Contribute to snow PRNG\n    const mat3 prng = mat3(13.323122, 23.5112, 21.71123, 21.1212, \n                           28.731200, 11.9312, 21.81120, 14.7212, 61.3934);\n       \n    // Compute snow density according to uv and layer                       \n    float computeSnowDensity(in vec2 uv, in float layer) {\n      vec3 snowbase = vec3(floor(uv), 31.189 + layer);\n      vec3 m = floor(snowbase) / 10000.0 + fract(snowbase);\n      vec3 mp = (31415.9 + m) / fract(prng * m);\n      vec3 r = fract(mp);\n      vec2 s = abs(fract(uv) - 0.5 + 0.9 * r.xy - 0.45) + 0.01 * abs( 2.0 * fract(10.0 * uv.yx) - 1.0); \n      float d = 0.6 * (s.x + s.y) + max(s.x, s.y) - 0.01;\n      float edge = 0.005 + 0.05 * min(0.5 * abs(layer - 5.0 - sin(time * 0.1)), 1.0);\n      return smoothstep(edge * 2.0, -edge * 2.0, d) * r.x / (0.5 + 0.01 * layer * 1.5);\n    }                \n \n    void main() {\n      ${this.COMPUTE_MASK}\n      \n      // Snow accumulation\n      float accumulation = 0.0;\n      \n      // Compute layers  \n      for ( float i=5.0; i<25.0; i++ ) {\n        // Compute uv layerization\n        vec2 snowuv = vUvs.xy * (1.0 + i * 1.5);\n        snowuv += vec2(snowuv.y * 1.2 * (fract(i * 6.258817) - direction), -time / (1.0 + i * 1.5 * 0.03));\n                   \n        // Perform accumulation layer after layer    \n        accumulation += computeSnowDensity(snowuv, i);\n      }\n      // Output the accumulated snow pixel\n      gl_FragColor = vec4(vec3(accumulation) * tint, 1.0) * mask * alpha;\n    }\n  `}class ContextMenu{constructor(e,t,i,{eventName:n="contextmenu",onOpen:s,onClose:o}={}){this.element=e,this.selector=t||e.attr("id"),this.eventName=n,this.menuItems=i,this.onOpen=s,this.onClose=o,this._expandUp=!1,this.bind()}#Oa;get menu(){return $("#context-menu")}static create(e,t,i,n,{hookName:s="EntryContext",...o}={}){return e._callHooks?.((e=>`get${e}${s}`),n),new ContextMenu(t,i,n,o)}bind(){(this.element instanceof HTMLElement?this.element:this.element[0]).addEventListener(this.eventName,(e=>{const t=e.target.closest(this.selector);if(!t)return;e.preventDefault();const i=this.#Oa;this.#Oa=t;const n=this.menu,s=document.querySelector(".context");return s?.classList.remove("context"),this.#Oa.contains(n[0])?this.close():(ui.context?.onClose?.(i),e.stopPropagation(),ui.context=this,this.onOpen?.(this.#Oa),this.render($(this.#Oa),{event:e}))}))}async close({animate:e=!0}={}){e&&await this._animateClose(this.menu),this._close()}_close(){for(const e of this.menuItems)delete e.element;this.menu.remove(),$(".context").removeClass("context"),delete ui.context,this.onClose?.(this.#Oa)}async _animateOpen(e){return e.hide(),new Promise((t=>e.slideDown(200,t)))}async _animateClose(e){return new Promise((t=>e.slideUp(200,t)))}render(e,t={}){const i=$("#context-menu");let n=i.length?i:$('<nav id="context-menu"></nav>'),s=$('<ol class="context-items"></ol>');if(n.html(s),!this.menuItems.length)return;const o=this.menuItems.reduce(((e,t)=>{const i=t.group??"_none";return e[i]??=[],e[i].push(t),e}),{});for(const[t,i]of Object.entries(o)){let n=s;if("_none"!==t){const e=$(`<li class="context-group" data-group-id="${t}"><ol></ol></li>`);s.append(e),n=e.find("ol")}for(const t of i){let i=!0;if(void 0!==t.condition&&(i=t.condition instanceof Function?t.condition(e):t.condition),!i)continue;const s=c.i18n.localize(t.name),o=["context-item",t.classes].filterJoin(" "),r=$(`<li class="${o}">${t.icon}${s}</li>`);r.children("i").addClass("fa-fw"),n.append(r),t.element=r[0]}}return 0!==s.children().length?(this._setPosition(n,e,t),i.length||this.activateListeners(n),c.tooltip.deactivate(),this._animateOpen(n)):void 0}_setPosition(e,t,{event:i}={}){const n=t[0].parentElement;t.css("position","relative"),e.css("visibility","hidden"),t.append(e);const s=e[0].getBoundingClientRect(),o=t[0].getBoundingClientRect(),r=n.getBoundingClientRect(),a=o.top-s.height,l=o.bottom+s.height,c=a>r.top||"visible"===getComputedStyle(n).overflowY,d=l>r.bottom&&a>=r.top,u=l>window.innerHeight&&a>0&&c;this._expandUp=d||u,e.toggleClass("expand-up",this._expandUp),e.toggleClass("expand-down",!this._expandUp),e.css("visibility",""),t.addClass("context")}activateListeners(e){e.on("click","li.context-item",this.#xa.bind(this))}#xa(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget,i=this.menuItems.find((e=>e.element===t));i?.callback($(this.#Oa)),this.close()}static eventListeners(){document.addEventListener("click",(e=>{ui.context&&ui.context.close()}))}}class Dialog extends Application{constructor(e,t){super(t),this.data=e}#Na;static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"templates/hud/dialog.html",focus:!0,classes:["dialog"],width:400,jQuery:!0})}get title(){return this.data.title||"Dialog"}getData(e={}){let t=Object.keys(this.data.buttons).reduce(((e,t)=>{let i=this.data.buttons[t];return i.cssClass=(this.data.default===t?[t,"default","bright"]:[t]).join(" "),!1!==i.condition&&(e[t]=i),e}),{});return{content:this.data.content,buttons:t}}activateListeners(e){e.find(".dialog-button").click(this._onClickButton.bind(this)),e.find("form").each(((e,t)=>t.onsubmit=e=>e.preventDefault())),this.#Na||(this.#Na=this._onKeyDown.bind(this),document.addEventListener("keydown",this.#Na)),this.data.render instanceof Function&&this.data.render(this.options.jQuery?e:e[0]),this.options.focus&&e.find(".default").focus(),e.find("[autofocus]")[0]?.focus()}_onClickButton(e){const t=e.currentTarget.dataset.button,i=this.data.buttons[t];this.submit(i,e)}_onKeyDown(e){if("Tab"===e.key){if(this.element[0].contains(document.activeElement))return;e.preventDefault(),e.stopPropagation();const t=Array.from(document.querySelectorAll(".dialog-button"));(e.shiftKey?t.pop():t.shift()).focus()}if("Escape"===e.key)return e.preventDefault(),e.stopPropagation(),this.close();if("Enter"===e.key){if(!this.element[0].contains(document.activeElement)||document.activeElement instanceof HTMLTextAreaElement)return;e.preventDefault(),e.stopPropagation();const t=document.activeElement.dataset.button||this.data.default,i=this.data.buttons[t];return this.submit(i)}}async _renderOuter(){let e=await super._renderOuter();const t=e[0];return t.setAttribute("role","dialog"),t.setAttribute("aria-modal","true"),e}submit(e,t){const i=this.options.jQuery?this.element:this.element[0];try{e.callback&&e.callback.call(this,i,t),this.close()}catch(e){throw ui.notifications.error(e.message),new Error(e)}}async close(e={}){return this.data.close&&this.data.close(this.options.jQuery?this.element:this.element[0]),this.#Na&&(document.removeEventListener("keydown",this.#Na),this.#Na=void 0),super.close(e)}static async confirm({title:e,content:t,yes:i,no:n,render:s,defaultYes:o=!0,rejectClose:r=!1,options:a={}}={}){return this.wait({title:e,content:t,render:s,focus:!0,default:o?"yes":"no",close:()=>{if(!r)return null},buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:c.i18n.localize("Yes"),callback:e=>!i||i(e)},no:{icon:'<i class="fas fa-times"></i>',label:c.i18n.localize("No"),callback:e=>!!n&&n(e)}}},a)}static async prompt({title:e,content:t,label:i,callback:n,render:s,rejectClose:o=!0,options:r={}}={}){return this.wait({title:e,content:t,render:s,default:"ok",close:()=>{if(!o)return null},buttons:{ok:{icon:'<i class="fas fa-check"></i>',label:i,callback:n}}},r)}static async wait(e={},t={},i={}){return new Promise(((n,s)=>{const o=foundry.utils.deepClone(e.buttons);for(const[a,l]of Object.entries(o)){const c=l.callback;function callback(e,t){const i=c instanceof Function?c.call(this,e,t):void 0;n(void 0===i?a:i)}l.callback=callback}const r=e.close;new this({...e,buttons:o,close:()=>{const e=r instanceof Function?r():void 0;void 0!==e?n(e):s(new Error("The Dialog was closed without a choice being made."))}},t).render(!0,i)}))}}class Draggable{constructor(e,t,i,n){this.app=e,this.element=t[0],this.handle=i??this.element,this.resizable=n||!1,this.position=null,this.handlers={},this._moveTime=0,this.activateListeners()}activateListeners(){this._activateDragListeners(),this._activateResizeListeners()}_activateDragListeners(){this.handle&&(this.handlers.click=["pointerdown",e=>this.app.bringToTop(),{capture:!0,passive:!0}],this.element.addEventListener(...this.handlers.click),this.handlers.dragDown=["pointerdown",e=>this._onDragMouseDown(e),!1],this.handlers.dragMove=["pointermove",e=>this._onDragMouseMove(e),!1],this.handlers.dragUp=["pointerup",e=>this._onDragMouseUp(e),!1],this.handle.addEventListener(...this.handlers.dragDown),this.handle.classList.add("draggable"))}_activateResizeListeners(){if(!this.resizable)return;let e=this.element.querySelector(this.resizable.selector);e||(e=$('<div class="window-resizable-handle"><i class="fas fa-arrows-alt-h"></i></div>')[0],this.element.appendChild(e)),this.handlers.resizeDown=["pointerdown",e=>this._onResizeMouseDown(e),!1],this.handlers.resizeMove=["pointermove",e=>this._onResizeMouseMove(e),!1],this.handlers.resizeUp=["pointerup",e=>this._onResizeMouseUp(e),!1],e.addEventListener(...this.handlers.resizeDown),this.handle&&this.handle.classList.add("resizable")}_onDragMouseDown(e){e.preventDefault(),this.position=foundry.utils.deepClone(this.app.position),this._initial={x:e.clientX,y:e.clientY},window.addEventListener(...this.handlers.dragMove),window.addEventListener(...this.handlers.dragUp)}_onDragMouseMove(e){e.preventDefault();const t=Date.now();t-this._moveTime<1e3/60||(this._moveTime=t,this.app.setPosition({left:this.position.left+(e.clientX-this._initial.x),top:this.position.top+(e.clientY-this._initial.y)}))}_onDragMouseUp(e){e.preventDefault(),window.removeEventListener(...this.handlers.dragMove),window.removeEventListener(...this.handlers.dragUp)}_onResizeMouseDown(e){e.preventDefault();const t=Date.now();t-this._moveTime<1e3/60||(this._moveTime=t,this.position=foundry.utils.deepClone(this.app.position),"auto"===this.position.height&&(this.position.height=this.element.clientHeight),"auto"===this.position.width&&(this.position.width=this.element.clientWidth),this._initial={x:e.clientX,y:e.clientY},window.addEventListener(...this.handlers.resizeMove),window.addEventListener(...this.handlers.resizeUp))}_onResizeMouseMove(e){e.preventDefault();const t=this.app.position.scale??1;let i=(e.clientX-this._initial.x)/t;const n=(e.clientY-this._initial.y)/t;!0===this.resizable.rtl&&(i*=-1);const s={width:this.position.width+i,height:this.position.height+n};!1===this.resizable.resizeX&&delete s.width,!1===this.resizable.resizeY&&delete s.height,this.app.setPosition(s)}_onResizeMouseUp(e){e.preventDefault(),window.removeEventListener(...this.handlers.resizeMove),window.removeEventListener(...this.handlers.resizeUp),this.app._onResize(e)}}class DragDrop{constructor({dragSelector:e,dropSelector:t,permissions:i={},callbacks:n={}}={}){this.dragSelector=e,this.dropSelector=t,this.permissions=i,this.callbacks=n}bind(e){if(this.can("dragstart",this.dragSelector)){const t=e.querySelectorAll(this.dragSelector);for(let e of t)e.setAttribute("draggable",!0),e.ondragstart=this._handleDragStart.bind(this)}if(this.can("drop",this.dropSelector)){const t=!this.dropSelector||e.matches(this.dropSelector)?[e]:e.querySelectorAll(this.dropSelector);for(let e of t)e.ondragover=this._handleDragOver.bind(this),e.ondrop=this._handleDrop.bind(this)}return this}callback(e,t){const i=this.callbacks[t];if(i instanceof Function)return i(e)}can(e,t){const i=this.permissions[e];return!(i instanceof Function)||i(t)}_handleDragStart(e){this.callback(e,"dragstart"),e.dataTransfer.items.length&&e.stopPropagation()}_handleDragOver(e){return e.preventDefault(),this.callback(e,"dragover"),!1}_handleDrop(e){return e.preventDefault(),this.callback(e,"drop")}static createDragImage(e,t,i){let n=document.getElementById("drag-preview");if(!n){n=document.createElement("div"),n.setAttribute("id","drag-preview");const e=document.createElement("img");e.classList.add("noborder"),n.appendChild(e),document.body.appendChild(n)}const s=n.children[0];return s.src=e.src,s.width=t,s.height=i,n}}class TextEditor$1{static#Aa=document.createElement("textarea");static async create({engine:e="tinymce",...t}={},i=""){if("prosemirror"===e){const{target:e,...n}=t;return ProseMirrorEditor.create(e,i,n)}if("tinymce"===e)return this._createTinyMCE(t,i);throw new Error(`Provided engine '${e}' is not a valid TextEditor engine.`)}static _PARAGRAPH_ELEMENTS=new Set(["header","main","section","article","div","footer","h1","h2","h3","h4","h5","h6","p","blockquote","summary","span","a","mark","strong","em","b","i","u"]);static async _createTinyMCE(e={},t=""){const i=foundry.utils.mergeObject(g.TinyMCE,e,{inplace:!1});i.target=e.target,i.file_picker_callback=function(e,t,i){new FilePicker({type:"image",callback:t=>{e(t),$(".tox-tinymce-aux").css({zIndex:""})}}).render(),$(".tox-tinymce-aux").css({zIndex:Math.min(++u,9999)})},i.content_css instanceof Array&&(i.content_css=i.content_css.map((e=>foundry.utils.getRoute(e))).join(",")),i.init_instance_callback=e=>{const i=e.getWin();e.focus(),t&&e.resetContent(t),e.selection.setCursorLocation(e.getBody(),e.getBody().childElementCount),i.addEventListener("wheel",(e=>{e.ctrlKey&&e.preventDefault()}),{passive:!1}),e.off("drop dragover"),e.on("drop",(t=>this._onDropEditorData(t,e)))};const[n]=await tinyMCE.init(i);return n.document=e.document,n}static decodeHTML(e){const t=TextEditor$1.#Aa;t.innerHTML=e;const i=t.value;return t.innerHTML="",i}static async enrichHTML(e,t={}){let{secrets:i=!1,documents:n=!0,links:s=!0,embeds:o=!0,rolls:r=!0,rollData:a}=t;if(!e?.length)return"";const l=document.createElement("div");l.innerHTML=String(e||""),i||l.querySelectorAll("section.secret:not(.revealed)").forEach((e=>e.remove())),t._embedDepth=(t._embedDepth??-1)+1;const c=[];n&&c.push(this._enrichContentLinks.bind(this)),s&&c.push(this._enrichHyperlinks.bind(this)),r&&c.push(this._enrichInlineRolls.bind(this,a)),o&&c.push(this._enrichEmbeds.bind(this));for(const e of g.TextEditor.enrichers)c.push(this._applyCustomEnrichers.bind(this,e));let d=this._getTextNodes(l);await this._primeCompendiums(d);let u=!1;for(const e of c)u&&(d=this._getTextNodes(l)),u=await e(d,t);return l.innerHTML}static async _primeCompendiums(e){const t=/Compendium\.[\w-]+\.[^.]+\.[a-zA-Z\d.]+/g,i=new Map;for(const n of e)for(const[e]of n.textContent.matchAll(t)){const{collection:t,documentId:n}=foundry.utils.parseUuid(e);t&&!t.has(n)&&(i.has(t)||i.set(t,[]),i.get(t).push(n))}for(const[e,t]of i.entries())await e.getDocuments({_id__in:t})}static async _enrichContentLinks(e,{relativeTo:t}={}){const i=CONST.DOCUMENT_LINK_TYPES.concat(["Compendium","UUID"]),n=new RegExp(`@(${i.join("|")})\\[([^#\\]]+)(?:#([^\\]]+))?](?:{([^}]+)})?`,"g");return this._replaceTextContent(e,n,(e=>this._createContentLink(e,{relativeTo:t})))}static async _enrichEmbeds(e,t={}){return this._replaceTextContent(e,/@Embed\[(?<config>[^\]]+)](?:{(?<label>[^}]+)})?/gi,(e=>this._embedContent(e,t)),{replaceParent:!0})}static async _enrichHyperlinks(e,t={}){return this._replaceTextContent(e,/(https?:\/\/)(www\.)?([^\s<]+)/gi,this._createHyperlink)}static async _enrichInlineRolls(e,t){e=e instanceof Function?e():e||{};return this._replaceTextContent(t,/\[\[(\/[a-zA-Z]+\s)?(.*?)(]{2,3})(?:{([^}]+)})?/gi,(t=>this._createInlineRoll(t,e)))}static async _applyCustomEnrichers({pattern:e,enricher:t,replaceParent:i},n,s){return this._replaceTextContent(n,e,(e=>t(e,s)),{replaceParent:i})}static previewHTML(e,t=250){let i=document.createElement("div");return i.innerHTML=e,i=this.truncateHTML(i),i.innerText=this.truncateText(i.innerText,{maxLength:t}),i.innerHTML}static truncateHTML(e){const truncate=e=>{for(const t of e.childNodes)[Node.COMMENT_NODE,Node.TEXT_NODE].includes(t.nodeType)||t.nodeType===Node.ELEMENT_NODE&&(this._PARAGRAPH_ELEMENTS.has(t.tagName.toLowerCase())?truncate(t):t.remove())},t=e.cloneNode(!0);return truncate(t),t}static truncateText(e,{maxLength:t=50,splitWords:i=!0,suffix:n="â€¦"}={}){if(e.length<=t)return e;let s;if(i)for(s=e.slice(0,t+10);s.length>t;)s=/\s/.test(s)?s.replace(/[\s]+([\S]+)?$/,""):s.slice(0,t);else s=e.slice(0,t);return s+(n=n??"")}static _getTextNodes(e){const t=[],i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);for(;i.nextNode();)t.push(i.currentNode);return t}static async _replaceTextContent(e,t,i,n={}){let s=!1;for(const o of e){const e=o.textContent.matchAll(t);for(const t of Array.from(e).reverse()){let e;try{e=await i(t)}catch(e){Hooks$1.onError("TextEditor.enrichHTML",e,{log:"error"})}e&&(this._replaceTextNode(o,t,e,n),s=!0)}}return s}static _replaceTextNode(e,t,i,{replaceParent:n}={}){let s=e;t.index>0&&(s=e.splitText(t.index)),t[0].length<s.length&&s.splitText(t[0].length);const o=s.parentElement;o.parentElement&&o.childNodes.length<2&&n?o.replaceWith(i):s.replaceWith(i)}static async _createContentLink(e,{relativeTo:t}={}){const[i,n,s,o]=e.slice(1,5),r={classes:["content-link"],attrs:{draggable:"true"},dataset:{link:""},name:o};let a,l=!1;if("UUID"===i?(Object.assign(r.dataset,{link:"",uuid:n}),a=await fromUuid(n,{relative:t})):l=TextEditor$1._createLegacyContentLink(i,n,o,r),a){if(a.documentName)return a.toAnchor({name:r.name,dataset:{hash:s}});r.name=r.name||a.name||n;const e=c.packs.get(a.pack)?.documentName;Object.assign(r.dataset,{type:e,id:a._id,pack:a.pack}),s&&(r.dataset.hash=s),r.icon=g[e].sidebarIcon}else"UUID"===i&&(l=!0);return l&&(delete r.dataset.link,delete r.attrs.draggable,r.icon="fas fa-unlink",r.classes.push("broken")),this.createAnchor(r)}static createAnchor({attrs:e={},dataset:t={},classes:i=[],name:n,icon:s}={}){n??=c.i18n.localize("Unknown");const o=document.createElement("a");o.classList.add(...i);for(const[t,i]of Object.entries(e))null!=i&&o.setAttribute(t,i);for(const[e,i]of Object.entries(t))null!=i&&(o.dataset[e]=i);return o.innerHTML=`${s?`<i class="${s}"></i>`:""}${n}`,o}static async _embedContent(e,t={}){if(t._embedDepth>CONST.TEXT_ENRICH_EMBED_MAX_DEPTH)return console.warn(`Nested Document embedding is restricted to a maximum depth of ${CONST.TEXT_ENRICH_EMBED_MAX_DEPTH}. ${e.input} cannot be fully enriched.`),null;const{label:i}=e.groups,n=this._parseEmbedConfig(e.groups.config,{relative:t.relativeTo}),s=await fromUuid(n.uuid,{relative:t.relativeTo});if(s)return s.toEmbed({label:i,...n},t);const o=document.createElement("p");return o.classList.add("broken","content-embed"),o.innerHTML=`\n      <i class="fas fa-circle-exclamation"></i>\n      ${c.i18n.format("EDITOR.EmbedFailed",{uuid:n.uuid})}\n    `,o}static _parseEmbedConfig(e,t={}){const i={values:[]};for(const t of e.match(/(?:[^\s"]+|"[^"]*")+/g)){if(!t)continue;const[e,n]=t.split("="),s=n?.toLowerCase();void 0===n?i.values.push(e.replace(/(^"|"$)/g,"")):"true"===s||"false"===s?i[e]="true"===s:Number.isNumeric(n)?i[e]=Number(n):i[e]=n.replace(/(^"|"$)/g,"")}if("cite"in i||(i.cite=!0),"caption"in i||(i.caption=!0),!("inline"in i)){const e=i.values.indexOf("inline");e>-1&&(i.inline=!0,i.values.splice(e,1))}if(!i.uuid)for(const[e,n]of i.values.entries())try{const s=foundry.utils.parseUuid(n,t);if(s?.documentId){i.uuid=n,i.values.splice(e,1);break}}catch{}return i}static _createLegacyContentLink(e,t,i,n){let s=!1;if(CONST.WORLD_DOCUMENT_TYPES.includes(e)){const i=g[e],o=c.collections.get(e),r=foundry.data.validators.isValidId(t)?o.get(t):o.getName(t);r||(s=!0),n.name=n.name||(s?t:r.name),n.icon=i.sidebarIcon,Object.assign(n.dataset,{type:e,uuid:r?.uuid})}else if("PlaylistSound"===e){const[,i,,o]=t.split("."),r=c.playlists.get(i),a=r?.sounds.get(o);r&&a||(s=!0),n.name=n.name||(s?t:a.name),n.icon=g.Playlist.sidebarIcon,Object.assign(n.dataset,{type:e,uuid:a?.uuid}),a?.playing&&n.cls.push("playing"),c.user.isGM||n.cls.push("disabled")}else if("Compendium"===e){const{collection:e,id:i}=foundry.utils.parseUuid(`Compendium.${t}`);if(e){if(Object.assign(n.dataset,{pack:e.collection,uuid:e.getUuid(i)}),n.icon=g[e.documentName].sidebarIcon,e.index.size){const t=e.index.find((e=>e._id===i||e.name===i));t?(n.name||(n.name=t.name),n.dataset.id=t._id,n.dataset.uuid=t.uuid):s=!0}n.name||(n.name=n.dataset.lookup=i)}else s=!0}return s}static async _createHyperlink(e){const t=e[0],i=document.createElement("a");return i.classList.add("hyperlink"),i.href=i.textContent=t,i.target="_blank",i.rel="nofollow noopener",i}static async _createInlineRoll(e,t){let[i,n,s,o]=e.slice(1,5);const r=Roll.defaultImplementation;if(3===s.length&&(n+="]"),!i){if(!r.validate(n))return null;try{const e={classes:["inline-roll","inline-result"],dataset:{tooltip:n},label:o};return(await r.create(n,t).evaluate({allowInteractive:!1})).toAnchor(e)}catch{return null}}const a=`${i}${n}`;let l=null;try{l=ChatLog.parse(a)}catch{return null}const[c,d]=l;if(!["roll","gmroll","blindroll","selfroll","publicroll"].includes(c))return null;const u=ChatLog.MULTILINE_COMMANDS.has(c)?d.pop():d,h=r.replaceFormulaData(u[2].trim(),t||{}),p=u[3]?.trim(),g=document.createElement("a");return g.classList.add("inline-roll",l[0]),g.dataset.mode=l[0],g.dataset.flavor=p??o??"",g.dataset.formula=h,g.dataset.tooltip=n,g.innerHTML=`<i class="fas fa-dice-d20"></i>${o||h}`,g}static activateListeners(){const e=$("body");e.on("click","a[data-link]",this._onClickContentLink),e.on("dragstart","a[data-link]",this._onDragContentLink),e.on("click","a.inline-roll",this._onClickInlineRoll),e.on("click","[data-uuid][data-content-embed] [data-action]",this._onClickEmbeddedAction)}static async _onClickContentLink(e){e.preventDefault();const t=await fromUuid(e.currentTarget.dataset.uuid);return t?._onClickDocumentLink(e)}static async _onClickEmbeddedAction(e){const{action:t}=e.target.dataset,{uuid:i}=e.target.closest("[data-uuid]").dataset,n=await fromUuid(i);if(n&&"rollTable"===t)n._rollFromEmbeddedHTML(e)}static async _onClickInlineRoll(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("inline-result"))return t.classList.contains("expanded")?Roll.defaultImplementation.collapseInlineResult(t):Roll.defaultImplementation.expandInlineResult(t);const i=ChatMessage.implementation,n=i.getSpeaker();let s=i.getSpeakerActor(n),o=s?s.getRollData():{};const r=t.closest(".sheet");if(r){const e=ui.windows[r.dataset.appid];["Actor","Item"].includes(e?.object?.documentName)&&(o=e.object.getRollData())}return Roll.create(t.dataset.formula,o).toMessage({flavor:t.dataset.flavor,speaker:n},{rollMode:t.dataset.mode})}static _onDragContentLink(e){e.stopPropagation();const t=e.currentTarget;let i=null;if(t.dataset.pack){const e=c.packs.get(t.dataset.pack);let n=t.dataset.id;if(t.dataset.lookup&&e.index.size){const i=e.index.find((e=>e._id===t.dataset.lookup||e.name===t.dataset.lookup));i&&(n=i._id)}if(!t.dataset.uuid&&!n)return!1;const s=t.dataset.uuid||e.getUuid(n);i={type:t.dataset.type||e.documentName,uuid:s}}else{i=fromUuidSync(t.dataset.uuid).toDragData()}e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(i))}static async _onDropEditorData(e,t){e.preventDefault();const i=this.getDragEventData(e),n=await TextEditor$1.getContentLink(i,{relativeTo:t.document});n&&t.insertContent(n)}static getDragEventData(e){if(!("dataTransfer"in e))return console.warn("Incorrectly attempted to process drag event data for an event which was not a DragEvent."),{};try{return JSON.parse(e.dataTransfer.getData("text/plain"))}catch(e){return{}}}static async getContentLink(e,t={}){const i=getDocumentClass(e.type);if(!i)return null;const n=await i.fromDropData(e);return n?n._createDocumentLink(e,t):null}static async _uploadImage(e,t){if(!c.user.hasPermission("FILES_UPLOAD"))return void ui.notifications.error("EDITOR.NoUploadPermission",{localize:!0});ui.notifications.info("EDITOR.UploadingFile",{localize:!0});const i=await FilePicker.upload(null,null,t,{uuid:e});return i?.path}}window.TextEditor=TextEditor$1;class FilePicker extends Application{constructor(e={}){super(e),this.request=e.current,this.sources=Object.entries({data:{target:"",label:c.i18n.localize("FILES.SourceUser"),icon:"fas fa-database"},public:{target:"",label:c.i18n.localize("FILES.SourceCore"),icon:"fas fa-server"},s3:{buckets:[],bucket:"",target:"",label:c.i18n.localize("FILES.SourceS3"),icon:"fas fa-cloud"}}).reduce(((e,t)=>(c.data.files.storages.includes(t[0])&&(e[t[0]]=t[1]),e)),{}),this.activeSource=e.activeSource||"data",this.callback=e.callback,this.results={},this.type=e.type??"any",this.field=e.field,this.button=e.button,this.displayMode=e.displayMode||this.constructor.LAST_DISPLAY_MODE,this.extensions=FilePicker.#Ra(this.type);const[t,i]=this._inferCurrentDirectory(this.request);this.activeSource=t,this.sources[t].target=i,this._loaded=!1}static FILE_TYPES=["image","audio","video","text","imagevideo","font","folder","any"];static LAST_BROWSED_DIRECTORY="";static LAST_TILE_SIZE=null;static LAST_DISPLAY_MODE="list";static DISPLAY_MODES=["list","thumbs","tiles","images"];static S3_BUCKETS=null;static get favorites(){return c.settings.get("core","favoritePaths")}static async setFavorite(e,t){const i=foundry.utils.deepClone(this.favorites);t=t.endsWith("/")?t:`${t}/`;if(Object.keys(i).includes(`${e}-${t}`))return ui.notifications.info(c.i18n.format("FILES.AlreadyFavorited",{path:t}));let n;if("/"===t)n="root";else{const e=t.split("/");n=e[e.length-2]}i[`${e}-${t}`]={source:e,path:t,label:n},await c.settings.set("core","favoritePaths",i)}static async removeFavorite(e,t){const i=foundry.utils.deepClone(this.favorites);delete i[`${e}-${t}`],await c.settings.set("core","favoritePaths",i)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"templates/apps/filepicker.html",classes:["filepicker"],width:546,tabs:[{navSelector:".tabs"}],dragDrop:[{dragSelector:".file",dropSelector:".filepicker-body"}],tileSize:!1,filters:[{inputSelector:'input[name="filter"]',contentSelector:".filepicker-body"}]})}_inferCurrentDirectory(e){const t=[CONST.DEFAULT_TOKEN].concat(this.options.redirectToRoot??[]);e&&!t.includes(e)||(e=this.constructor.LAST_BROWSED_DIRECTORY);let i="data";const n=this.constructor.matchS3URL(e);if(n)this.sources.s3.bucket=n.groups.bucket,i="s3",e=n.groups.key;else if(["http://","https://"].some((t=>e.startsWith(t))))e="";else{const t=e.split("/").shift();["cards","css","fonts","icons","lang","scripts","sounds","ui"].includes(t)&&(i="public")}this.sources[i]||(i=c.data.files.storages[0],"s3"===i&&(this.sources.s3.bucket=c.data.files.s3.buckets?.[0]??null,e=""));let s=e.split("/");-1!==s[s.length-1].indexOf(".")&&s.pop();return[i,s.join("/")]}static#Ra(e){let t=[CONST.IMAGE_FILE_EXTENSIONS,CONST.AUDIO_FILE_EXTENSIONS,CONST.VIDEO_FILE_EXTENSIONS,CONST.TEXT_FILE_EXTENSIONS,CONST.FONT_FILE_EXTENSIONS,CONST.GRAPHICS_FILE_EXTENSIONS].flatMap((e=>Object.keys(e)));return"folder"===e?t=[]:"font"===e?t=Object.keys(CONST.FONT_FILE_EXTENSIONS):"text"===e?t=Object.keys(CONST.TEXT_FILE_EXTENSIONS):"graphics"===e?t=Object.keys(CONST.GRAPHICS_FILE_EXTENSIONS):"image"===e?t=Object.keys(CONST.IMAGE_FILE_EXTENSIONS):"audio"===e?t=Object.keys(CONST.AUDIO_FILE_EXTENSIONS):"video"===e?t=Object.keys(CONST.VIDEO_FILE_EXTENSIONS):"imagevideo"===e&&(t=Object.keys(CONST.IMAGE_FILE_EXTENSIONS).concat(Object.keys(CONST.VIDEO_FILE_EXTENSIONS))),t.map((e=>`.${e.toLowerCase()}`))}static matchS3URL(e){const t=c.data.files.s3?.endpoint;if(!t)return null;const i=new RegExp(`^${t.protocol}//(?<bucket>.*).${t.host}/(?<key>.*)`),n=e.match(i);if(n)return n;const s=new RegExp(`^${t.protocol}//${t.host}/(?<bucket>[^/]+)/(?<key>.*)`);return e.match(s)}get title(){let e=this.type||"file";return c.i18n.localize("imagevideo"===e?"FILES.TitleImageVideo":`FILES.Title${e.capitalize()}`)}get source(){return this.sources[this.activeSource]}get target(){return this.source.target}get canUpload(){return"folder"!==this.type&&(!1!==this.options.allowUpload&&(!!["data","s3"].includes(this.activeSource)&&(!c.user||c.user.can("FILES_UPLOAD"))))}static get uploadURL(){return foundry.utils.getRoute("upload")}async getData(e={}){const t=this.result,i=this.source;let n=decodeURIComponent(i.target);const s="s3"===this.activeSource;let o=t.dirs.map((e=>({name:decodeURIComponent(e.split("/").pop()),path:e,private:t.private||t.privateDirs.includes(e)})));o=o.sort(((e,t)=>e.name.localeCompare(t.name,c.i18n.lang)));let r=t.files.map((e=>{let t=e;return VideoHelper.hasVideoExtension(e)?t="icons/svg/video.svg":foundry.audio.AudioHelper.hasAudioExtension(e)?t="icons/svg/sound.svg":ImageHelper.hasImageExtension(e)||(t="icons/svg/book.svg"),{name:decodeURIComponent(e.split("/").pop()),url:e,img:t}}));return r=r.sort(((e,t)=>e.name.localeCompare(t.name,c.i18n.lang))),{bucket:s?i.bucket:null,buckets:s?i.buckets.map((e=>({value:e,label:e}))):null,canGoBack:""!==this.activeSource,canUpload:this.canUpload,canSelect:!this.options.tileSize,cssClass:[this.displayMode,t.private?"private":"public"].join(" "),dirs:o,displayMode:this.displayMode,extensions:this.extensions,files:r,isS3:s,noResults:o.length+r.length===0,selected:"folder"===this.type?n:this.request,source:i,sources:this.sources,target:n,tileSize:this.options.tileSize?this.constructor.LAST_TILE_SIZE||canvas.dimensions.size:null,user:c.user,submitText:"folder"===this.type?"FILES.SelectFolder":"FILES.SelectFile",favorites:this.constructor.favorites}}setPosition(e={}){const t=super.setPosition(e),i=this.element[0],n=i.querySelector(".window-content"),s=i.querySelectorAll(".filepicker-body > ol"),o=n.scrollHeight-n.offsetHeight;if(o>0&&s.length){let e=Number(getComputedStyle(s[0]).maxHeight.slice(0,-2));e-=Math.ceil(o/s.length),s.forEach((t=>t.style.maxHeight=`${e}px`))}return t}async browse(e,t={}){if(c.world&&!c.user.can("FILES_BROWSE"))return;e="string"==typeof e?e:this.target;const i=this.activeSource;if(t=foundry.utils.mergeObject({type:this.type,extensions:this.extensions,wildcard:!1},t),"s3"===i){if(null===this.constructor.S3_BUCKETS){const e=await this.constructor.browse("s3","");this.constructor.S3_BUCKETS=e.dirs}this.sources.s3.buckets=this.constructor.S3_BUCKETS,this.source.bucket||(this.source.bucket=this.constructor.S3_BUCKETS[0]),t.bucket=this.source.bucket}e.startsWith("/")&&(e=e.slice(1)),e===CONST.DEFAULT_TOKEN&&(e=this.constructor.LAST_BROWSED_DIRECTORY);const n=await this.constructor.browse(i,e,t).catch((e=>(ui.notifications.warn(e),this.constructor.browse(i,"",t))));return this.result=n,this.source.target=n.target,"s3"===i&&(this.source.bucket=n.bucket),this.constructor.LAST_BROWSED_DIRECTORY=n.target,this._loaded=!0,this.render(!0),n}static async browse(e,t,i={}){const n={action:"browseFiles",storage:e,target:t};return FilePicker.#Pa(n,i)}static async configurePath(e,t,i={}){const n={action:"configurePath",storage:e,target:t};return FilePicker.#Pa(n,i)}static async createDirectory(e,t,i={}){const n={action:"createDirectory",storage:e,target:t};return FilePicker.#Pa(n,i)}static async#Pa(e,t){return new Promise(((i,n)=>{c.socket.emit("manageFiles",e,t,(e=>{if(e.error)return n(new Error(e.error));i(e)}))}))}static async upload(e,t,i,n={},{notify:s=!0}={}){const o=new FormData;o.set("source",e),o.set("target",t),o.set("upload",i),Object.entries(n).forEach((e=>o.set(...e)));const r=Object.fromEntries(["ErrorSomethingWrong","WarnUploadModules","ErrorTooLarge"].map((e=>{const t=`FILES.${e}`;return[e,c.i18n.localize(t)]})));try{const e=await fetch(this.uploadURL,{method:"POST",body:o}),t=await e.json();if(t.error)return ui.notifications.error(t.error),!1;if(!t.path)return void(s?ui.notifications.error(r.ErrorSomethingWrong):console.error(r.ErrorSomethingWrong));const[i,n,a]=t.path.split("/");if(["modules","systems"].includes(i)){let e;"modules"===i?e=c.modules.get(n):n===c.system.id&&(e=c.system),e?.persistentStorage&&"storage"===a||(s?ui.notifications.warn(r.WarnUploadModules):console.warn(r.WarnUploadModules))}return t.message&&(s?ui.notifications.info(t.message):console.info(t.message)),t}catch(e){return e instanceof foundry.utils.HttpError&&413===e.code?void(s?ui.notifications.error(r.ErrorTooLarge):console.error(r.ErrorTooLarge)):{}}}static async uploadPersistent(e,t,i,n={},{notify:s=!0}={}){let o=c.system.id===e?c.system:c.modules.get(e);if(!o)throw new Error(`Package ${e} not found`);if(!o.persistentStorage)throw new Error(`Package ${e} does not have persistent storage enabled. Set the "persistentStorage" flag to true in the package manifest.`);const r=`${o.type}s/${o.id}/storage/${t}`;return this.upload("data",r,i,n,{notify:s})}render(e,t){return c.world&&!c.user.can("FILES_BROWSE")?this:(this.position.height=null,this.element.css({height:""}),this._tabs[0].active=this.activeSource,this._loaded?super.render(e,t):(this.browse(),this))}activateListeners(e){super.activateListeners(e);const t=e.find("header.filepicker-header"),i=e[0],n=t.find('input[name="target"]');n.on("keydown",this.#ka.bind(this)),n[0].focus(),e.find(".current-dir button").click(this.#Ma.bind(this)),e.find('select[name="bucket"]').change(this.#La.bind(this)),i.elements.tileSize?.addEventListener("change",this._onChangeTileSize.bind(this));const s=e.find(".display-modes");s.on("click",".display-mode",this.#Fa.bind(this));for(let e of s[0].children)e.classList.toggle("active",e.dataset.mode===this.displayMode);this.canUpload&&(i.upload.onchange=e=>this.#Ua(e)),e.find(".directory").on("click","li",this.#Ba.bind(this)),e.find(".favorites").on("click","a",this.#Ga.bind(this));let o=i.querySelector(`.file[data-path="${encodeURIComponent(this.request)}"]`);o&&o.classList.add("picked"),i.onsubmit=e=>this._onSubmit(e);const r=e.find(".files-list"),a=new IntersectionObserver(this.#ja.bind(this),{root:r[0]});r.find("li.file").each(((e,t)=>a.observe(t)))}#Fa(e){e.preventDefault();const t=e.currentTarget;if(!this.constructor.DISPLAY_MODES.includes(t.dataset.mode))throw new Error("Invalid display mode requested");t.dataset.mode!==this.displayMode&&(this.constructor.LAST_DISPLAY_MODE=this.displayMode=t.dataset.mode,this.render())}_onChangeTab(e,t,i){this.activeSource=i,this.browse(this.source.target)}_canDragStart(e){return c.user?.isGM&&canvas.activeLayer instanceof TilesLayer}_canDragDrop(e){return this.canUpload}_onDragStart(e){const t=e.currentTarget,i=parseInt(t.closest("form").tileSize.value)||canvas.dimensions.size,n=canvas.dimensions.size/i,s={type:"Tile",texture:{src:t.dataset.path},fromFilePicker:!0,tileSize:i};e.dataTransfer.setData("text/plain",JSON.stringify(s));const o=t.querySelector("img"),r=o.naturalWidth*n*canvas.stage.scale.x,a=o.naturalHeight*n*canvas.stage.scale.y,l=DragDrop.createDragImage(o,r,a);e.dataTransfer.setDragImage(l,r/2,a/2)}async _onDrop(e){if(!this.canUpload)return;const t=e.currentTarget.closest("form");t.disabled=!0;const i=t.target.value,n=TextEditor$1.getDragEventData(e),s=e.dataTransfer.files;if(s&&s.length&&!n.fromFilePicker){for(let e of s){const n=e.name.toLowerCase();try{this.#$a(n)}catch(e){ui.notifications.error(e,{console:!0});continue}const s=await this.constructor.upload(this.activeSource,i,e,{bucket:t.bucket?t.bucket.value:null});s&&(this.request=s.path)}return t.disabled=!1,this.browse(i)}}#$a(e){const t=`.${e.split(".").pop()}`;if(!this.extensions.includes(t)){const i=c.i18n.format("FILES.ErrorDisallowedExtension",{name:e,ext:t,allowed:this.extensions.join(" ")});throw new Error(i)}}#ka(e){if("Enter"===e.key)return e.preventDefault(),this.browse(e.target.value)}async#Ga(e){const t=e.currentTarget.dataset.action,i=e.currentTarget.dataset.source||this.activeSource,n=e.currentTarget.dataset.path||this.target;switch(t){case"goToFavorite":this.activeSource=i,await this.browse(n);break;case"setFavorite":await this.constructor.setFavorite(i,n);break;case"removeFavorite":await this.constructor.removeFavorite(i,n)}this.render(!0)}#ja(...e){if("list"!==this.displayMode)return SidebarTab.prototype._onLazyLoadImage.call(this,...e)}#Ba(e){const t=e.currentTarget,i=t.closest("form");if(t.classList.contains("dir"))return this.browse(t.dataset.path);for(let e of t.parentElement.children)e.classList.toggle("picked",e===t);i.file&&(i.file.value=t.dataset.path)}#Ma(e){e.preventDefault();switch(e.currentTarget.dataset.action){case"back":let e=this.target.split("/");return e.pop(),this.browse(e.join("/"));case"mkdir":return this.#Ha(this.source);case"toggle-privacy":const t={private:!this.result.private,bucket:this.result.bucket};return this.constructor.configurePath(this.activeSource,this.target,t).then((e=>{this.result.private=e.private,this.render()}))}}#Ha(e){return Dialog.confirm({title:c.i18n.localize("FILES.CreateSubfolder"),content:'<form><div class="form-group">\n    <label>Directory Name</label>\n    <input type="text" name="dirname" placeholder="directory-name" required/>\n    </div></form>',yes:async t=>{const i=t.querySelector("input").value,n=[e.target,i].filterJoin("/");try{await this.constructor.createDirectory(this.activeSource,n,{bucket:e.bucket})}catch(e){ui.notifications.error(e.message)}return this.browse(this.target)},options:{jQuery:!1}})}#La(e){e.preventDefault();const t=e.currentTarget;return this.sources.s3.bucket=t.value,this.browse("/")}_onChangeTileSize(e){this.constructor.LAST_TILE_SIZE=e.currentTarget.valueAsNumber}_onSearchFilter(e,t,i,n){for(let e of n.querySelectorAll(".directory")){let t=!1;for(let n of e.children){let e=i.test(SearchFilter.cleanQuery(n.dataset.name));e&&(t=!0),n.style.display=e?"":"none"}e.style.display=t?"":"none"}this.setPosition({height:"auto"})}_onSubmit(e){e.preventDefault();let t=e.target.file.value;return t?(this.field&&(this.field.value=t,this.field.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))),this.callback&&this.callback(t,this),this.close()):ui.notifications.error("You must select a file to proceed.")}async#Ua(e){const t=e.target.form,i=t.upload.files[0],n=i.name.toLowerCase();try{this.#$a(n)}catch(e){return ui.notifications.error(e,{console:!0}),!1}const s=t.target.value,o={bucket:t.bucket?t.bucket.value:null},r=await this.constructor.upload(this.activeSource,s,i,o);return r.error?ui.notifications.error(r.error):(this.request=r.path,this.browse(s))}static fromButton(e){if(!(e instanceof HTMLButtonElement))throw new Error("You must pass an HTML button");let t=e.getAttribute("data-type");const i=e.form[e.dataset.target]||null;return new FilePicker({field:i,type:t,current:i?.value||"",button:e})}}class SearchFilter{static OPERATORS=Object.freeze({EQUALS:"equals",CONTAINS:"contains",STARTS_WITH:"starts_with",ENDS_WITH:"ends_with",LESS_THAN:"lt",LESS_THAN_EQUAL:"lte",GREATER_THAN:"gt",GREATER_THAN_EQUAL:"gte",BETWEEN:"between",IS_EMPTY:"is_empty"});constructor({inputSelector:e,contentSelector:t,initial:i="",callback:n,delay:s=200}={}){this.query=i,this.callback=n,this.rgx=void 0,this._inputSelector=e,this._input=null,this._contentSelector=t,this._content=null,this._filter=foundry.utils.debounce(this.callback,s)}static evaluateFilter(e,t){const i=foundry.utils.getProperty(e,t.field),n=t.value;const s=function _evaluate(){switch(t.operator){case SearchFilter.OPERATORS.EQUALS:return i.equals instanceof Function?i.equals(n):i===n;case SearchFilter.OPERATORS.CONTAINS:return Array.isArray(n)?n.includes(i):[n].includes(i);case SearchFilter.OPERATORS.STARTS_WITH:return i.startsWith(n);case SearchFilter.OPERATORS.ENDS_WITH:return i.endsWith(n);case SearchFilter.OPERATORS.LESS_THAN:return i<n;case SearchFilter.OPERATORS.LESS_THAN_EQUAL:return i<=n;case SearchFilter.OPERATORS.GREATER_THAN:return i>n;case SearchFilter.OPERATORS.GREATER_THAN_EQUAL:return i>=n;case SearchFilter.OPERATORS.BETWEEN:if(!Array.isArray(n)||2!==n.length)throw new Error(`Invalid filter value for ${t.operator} operator. Expected an array of length 2.`);const[e,s]=n;return i>=e&&i<=s;case SearchFilter.OPERATORS.IS_EMPTY:return foundry.utils.isEmpty(i);default:return i===n}}();return t.negate?!s:s}bind(e){if(this._input=e.querySelector(this._inputSelector),!this._input)return;this._input.value=this.query,this._contentSelector?e.matches(this._contentSelector)?this._content=e:this._content=e.querySelector(this._contentSelector):this._content=null,this._input.addEventListener("input",(e=>{e.preventDefault(),this.filter(e,e.currentTarget.value)}));const t=new KeyboardEvent("input",{key:"Enter",code:"Enter"});this.filter(t,this.query)}filter(e,t){this.query=SearchFilter.cleanQuery(t),this.rgx=new RegExp(RegExp.escape(this.query),"i"),this._filter(e,this.query,this.rgx,this._content)}static cleanQuery(e){return e.trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}}class FormDataExtended extends FormData{constructor(e,{dtypes:t={},editors:i={},disabled:n=!1,readonly:s=!0}={}){super(),this.dtypes=t,this.editors=i,Object.defineProperty(this,"object",{value:{},writable:!1,enumerable:!1}),this.process(e,{disabled:n,readonly:s})}process(e,t){this.#za(e,t),this.#Va(e,t),this.#Wa(),e.dispatchEvent(new FormDataEvent("formdata",{formData:this}))}set(e,t){this.object[e]=t,t instanceof Array&&(t=JSON.stringify(t)),super.set(e,t)}append(e,t){e in this.object?Array.isArray(this.object[e])||(this.object[e]=[this.object[e]]):this.object[e]=[],this.object[e].push(t),super.append(e,t)}#za(e,{disabled:t,readonly:i}={}){if(!t&&e.hasAttribute("disabled"))return;const n=Object.values(this.editors).map((e=>e.mce?.id));for(const s of e.elements){const o=s.name;if(!o||this.has(o))continue;if("BUTTON"===s.tagName||n.includes(o))continue;if(!t&&(s.disabled||s.closest("fieldset")?.disabled))continue;if(!i&&s.readOnly)continue;const r=e.elements[o],a=this.#Xa(o,r);this.set(o,a)}}#Va(e,{disabled:t,readonly:i}={}){const n=e.querySelectorAll("[data-edit]");for(const e of n){const n=e.dataset.edit;if(this.has(n)||n in this.editors)continue;if(!t&&e.disabled||!i&&e.readOnly)continue;let s;s="IMG"===e.tagName?e.getAttribute("src"):e.innerHTML.trim(),this.set(n,s)}}#Wa(){for(const[e,t]of Object.entries(this.editors))if(t.instance)if("tinymce"===t.options.engine){const i=t.instance.getContent();this.delete(t.mce.id),this.set(e,i)}else"prosemirror"===t.options.engine&&this.set(e,ProseMirror.dom.serializeString(t.instance.view.state.doc.content))}#Xa(e,t){if(t instanceof RadioNodeList){const i=Array.from(t);if(i.every((e=>"radio"===e.type))){const t=i.find((e=>e.checked));return t?this.#Xa(e,t):void 0}return Array.from(t).map((t=>this.#Xa(e,t)))}const i=t.dataset.dtype||this.dtypes[e];return"checkbox"===t.type?t.hasAttribute("value")&&"Boolean"!==i?this.#Ya(t.checked?t.value:null,i):this.#Ya(t.checked,i):["number","range"].includes(t.type)?""===t.value?null:this.#Ya(t.value,i||"Number"):"select-multiple"===t.type?Array.from(t.options).reduce(((e,t)=>(t.selected&&e.push(this.#Ya(t.value,i)),e)),[]):"radio"===t.type?t.checked?this.#Ya(t.value,i):null:this.#Ya(t.value,i)}#Ya(e,t){if(e instanceof Array)return e.map((e=>this.#Ya(e,t)));if([void 0,null].includes(e)||"String"===t)return e;if("Boolean"===t)return"false"!==e&&Boolean(e);if("Number"===t)return""===e||"null"===e?null:Number(e);if("JSON"===t)return JSON.parse(e);if(window[t]instanceof Function)try{return window[t](e)}catch(i){console.warn(`The form field value "${e}" was not able to be cast to the requested data type ${t}`)}return e}}class ProseMirrorEditor{constructor(e,t,i,n,s={}){Object.defineProperty(this,"uuid",{value:e,writable:!1}),Object.defineProperty(this,"view",{value:t,writable:!1}),Object.defineProperty(this,"collaborate",{value:n,writable:!1}),this.options=s,this.#Ka=i}static#qa=new Map;#Ka;destroy(){ProseMirrorEditor.#qa.delete(this.uuid),this.view.destroy(),this.collaborate&&c.socket.emit("pm.endSession",this.uuid)}isDirty(){return this.#Ka.getState(this.view.state)}_onNewSteps(e,t){this._disableSourceCodeEditing(),this.options.document?.sheet?.onNewSteps?.();const i=ProseMirror.collab.getVersion(this.view.state),n=t.slice(i-e),[s,o]=n.reduce((([e,t],i)=>(e.push(ProseMirror.Step.fromJSON(ProseMirror.defaultSchema,i.step)),t.push(i.userId),[e,t])),[[],[]]),r=ProseMirror.collab.receiveTransaction(this.view.state,s,o);this.view.dispatch(r)}_disableSourceCodeEditing(){const e=this.view.dom.closest(".editor")?.querySelector(":scope > textarea");e&&(e.disabled=!0,ui.notifications.warn("EDITOR.EditingHTMLWarning",{localize:!0,permanent:!0}))}_resync(){const e=this.view.dom;e.contentEditable=!1;const t=document.getSelection();t.removeAllRanges();const i=document.createRange();i.selectNode(e),t.addRange(i),document.execCommand("copy"),ui.notifications.warn("EDITOR.Resync",{localize:!0,permanent:!0}),this.destroy(),this.options.document?.sheet?.render(!0,{resync:!0})}_updateUserDisplay(e){const t=this.view.dom.closest(".editor");t.classList.toggle("collaborating",e.length>1);const i=e.map((e=>{const t=c.users.get(e);return t?`\n        <span class="scene-player" style="background: ${t.color}; border: 1px solid ${t.border.css};">\n          ${t.name[0]}\n        </span>\n      `:""})).join(""),n=t.querySelector("menu .concurrent-users");n.dataset.tooltip=e.map((e=>c.users.get(e)?.name)).join(", "),n.innerHTML=`\n      <i class="fa-solid fa-user-group"></i>\n      ${i}\n    `}_handleAutosave(e){this.options.document?.sheet?.onAutosave?.(e)}static async create(e,t="",{uuid:i,document:n,fieldName:s,plugins:o={},collaborate:r=!1,relativeLinks:a=!1}={}){if(r&&(!n||!s))throw new Error("A document and fieldName must be provided when creating an editor with collaborative editing.");i=r?`${n.uuid}#${s}`:i??`ProseMirror.${foundry.utils.randomID()}`;const l=ProseMirror.EditorState.create({doc:ProseMirror.dom.parseString(t)});(o=Object.assign({},ProseMirror.defaultPlugins,o)).contentLinks=ProseMirror.ProseMirrorContentLinkPlugin.build(ProseMirror.defaultSchema,{document:n,relativeLinks:a}),n&&(o.images=ProseMirror.ProseMirrorImagePlugin.build(ProseMirror.defaultSchema,{document:n}));const c={state:l};Hooks$1.callAll("createProseMirrorEditor",i,o,c);const d=r?await this._createCollaborativeEditorView(i,e,c.state,Object.values(o)):this._createLocalEditorView(e,c.state,Object.values(o)),u=new ProseMirrorEditor(i,d,o.isDirty,r,{document:n});return ProseMirrorEditor.#qa.set(i,u),u}static async _createCollaborativeEditorView(e,t,i,n){const s=await new Promise(((t,n)=>{c.socket.emit("pm.editDocument",e,i,(e=>{e.state?t(e):n()}))}));return new ProseMirror.EditorView({mount:t},{state:ProseMirror.EditorState.fromJSON({schema:ProseMirror.defaultSchema,plugins:[...n,ProseMirror.collab.collab({version:s.version,clientID:c.userId})]},s.state),dispatchTransaction(t){const i=this.state.apply(t);this.updateState(i);const n=ProseMirror.collab.sendableSteps(i);n&&c.socket.emit("pm.receiveSteps",e,n.version,n.steps)}})}static _createLocalEditorView(e,t,i){return new ProseMirror.EditorView({mount:e},{state:ProseMirror.EditorState.create({doc:t.doc,plugins:i})})}static _onNewSteps(e,t,i){const n=ProseMirrorEditor.#qa.get(e);n?n._onNewSteps(t,i):console.warn(`New steps were received for UUID '${e}' which is not a ProseMirror editor instance.`)}static _onResync(e){const t=ProseMirrorEditor.#qa.get(e);t?t._resync():console.warn(`A resync request was received for UUID '${e}' which is not a ProseMirror editor instance.`)}static _onUsersEditing(e,t){const i=ProseMirrorEditor.#qa.get(e);i?i._updateUserDisplay(t):console.warn(`A user update was received for UUID '${e}' which is not a ProseMirror editor instance.`)}static async _onAutosave(e,t){const i=ProseMirrorEditor.#qa.get(e),[n,s]=e.split("#"),o=await fromUuid(n);o&&o.updateSource({[s]:t}),i?i._handleAutosave(t):o.render(!1)}static _activateSocketListeners(e){e.on("pm.newSteps",this._onNewSteps.bind(this)),e.on("pm.resync",this._onResync.bind(this)),e.on("pm.usersEditing",this._onUsersEditing.bind(this)),e.on("pm.autosave",this._onAutosave.bind(this))}}class HTMLSecret{constructor({parentSelector:e,callbacks:t={}}={}){Object.defineProperty(this,"parentSelector",{value:e,writable:!1}),Object.defineProperty(this,"callbacks",{value:Object.freeze(t),writable:!1})}bind(e){if(!this.callbacks.content||!this.callbacks.update)return;const t=e.querySelectorAll(this.parentSelector);for(const e of t)e.querySelectorAll("section.secret[id]").forEach((e=>{if(e.closest("[data-content-embed]"))return;const t=e.classList.contains("revealed"),i=document.createElement("button");i.type="button",i.classList.add("reveal"),i.textContent=c.i18n.localize("EDITOR."+(t?"Hide":"Reveal")),e.insertBefore(i,e.firstChild),i.addEventListener("click",this._onToggleSecret.bind(this))}))}_onToggleSecret(e){e.preventDefault();const t=e.currentTarget.closest(".secret"),i=t?.id;if(!i)return;const n=this.callbacks.content(t);if(!n)return;const s=t.classList.contains("revealed"),o=n.replace(new RegExp(`<section[^i]+id="${i}"[^>]*>`),(()=>`<section class="secret${s?"":" revealed"}" id="${i}">`));return this.callbacks.update(t,o)}}class Tabs{constructor({group:e,navSelector:t,contentSelector:i,initial:n,callback:s}={}){this.group=e,this.active=n,this.callback=s??null,this._navSelector=t,this._nav=null,this._contentSelector=i,this._content=null}bind(e){this._nav=e.querySelector(this._navSelector),this._nav&&(this._contentSelector?e.matches(this._contentSelector)?this._content=e:this._content=e.querySelector(this._contentSelector):this._content=null,this.activate(this.active),this._nav.addEventListener("click",this._onClickNav.bind(this)))}activate(e,{triggerCallback:t=!1}={}){const i=this._nav.dataset.group,n=this._nav.querySelectorAll("[data-tab]");if(!n.length)return;Array.from(n).some((t=>t.dataset.tab===e))||(e=n[0].dataset.tab);for(let t of n)t.classList.toggle("active",t.dataset.tab===e);if(this._content){const t=this._content.querySelectorAll(".tab[data-tab]");for(let n of t)n.dataset.group&&n.dataset.group!==i||n.classList.toggle("active",n.dataset.tab===e)}this.active=e,t&&this.callback?.(null,this,e)}_onClickNav(e){const t=e.target.closest("[data-tab]");if(!t)return;e.preventDefault();const i=t.dataset.tab;i!==this.active&&this.activate(i,{triggerCallback:!0})}}class SidebarTab extends Application{constructor(...e){super(...e),this._popout=null,this._original=null,this.options.popOut&&this.options.classes.push("sidebar-popout"),this.options.classes.push(`${this.tabName}-sidebar`),!this.popOut&&ui.sidebar&&(ui.sidebar.tabs[this.tabName]=this)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:null,popOut:!1,width:300,height:"auto",classes:["tab","sidebar-tab"],baseApplication:"SidebarTab"})}get id(){return`${this.options.id}${this._original?"-popout":""}`}get tabName(){return this.constructor.defaultOptions.id??this.id}async getData(e={}){return{cssId:this.id,cssClass:this.options.classes.join(" "),tabName:this.tabName,user:c.user}}async _render(e=!1,t={}){await super._render(e,t),this._popout&&await this._popout._render(e,t)}async _renderInner(e){let t=await super._renderInner(e);return ui.sidebar?.activeTab===this.id&&t.addClass("active"),this.popOut&&t.removeClass("tab"),t}activate(){ui.sidebar.activateTab(this.tabName)}async close(e){if(this.popOut){const t=this._original;return t&&(t._popout=null),super.close(e)}}createPopout(){if(this._popout)return this._popout;const e={...this.options,popOut:!0};delete e.id,delete e.classes;const t=new this.constructor(e);return this._popout=t,t._original=this,t}renderPopout(){this.createPopout().render(!0)}_onLazyLoadImage(e,t){for(let i of e){if(!i.isIntersecting)continue;const e=i.target;e.dataset.backgroundImage&&(e.style["background-image"]=`url("${e.dataset.backgroundImage}")`,delete e.dataset.backgroundImage);const n=e.querySelector("img");n&&n.dataset.src&&(n.src=n.dataset.src,delete n.dataset.src),t.unobserve(i.target)}}}function DirectoryApplicationMixin(e){return class DirectoryApplication extends e{static entryPartial="templates/sidebar/partials/entry-partial.html";static folderPartial="templates/sidebar/folder-partial.html";static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{renderUpdateKeys:["name","sort","sorting","folder"],height:"auto",scrollY:["ol.directory-list"],dragDrop:[{dragSelector:".directory-item",dropSelector:".directory-list"}],filters:[{inputSelector:'input[name="search"]',contentSelector:".directory-list"}],contextMenuSelector:".directory-item.document",entryClickSelector:".entry-name"})}get entryType(){throw new Error("You must implement the entryType getter for this DirectoryTab")}get maxFolderDepth(){return this.collection.maxFolderDepth}get canCreateEntry(){return c.user.isGM}get canCreateFolder(){return this.canCreateEntry}_onSearchFilter(e,t,i,n){const s=!!t;let o=new Set;const r=new Set,a=new Set;if(s){const includeFolder=(e,t=!0)=>{if(!e)return;if("string"==typeof e&&(e=this.collection.folders.get(e)),!e)return;const i=e._id;r.has(i)?t&&!a.has(i)&&a.add(i):(r.add(i),t&&a.add(i),e.folder&&includeFolder(e.folder))};this._matchSearchFolders(i,includeFolder),this._matchSearchEntries(i,o,r,includeFolder)}for(let e of n.querySelectorAll(".directory-item"))if(!e.classList.contains("hidden"))if(e.classList.contains("folder")){let t=s&&r.has(e.dataset.folderId);e.style.display=!s||t?"flex":"none",a.has(e.dataset.folderId)?s&&t&&e.classList.remove("collapsed"):e.classList.toggle("collapsed",!c.folders._expanded[e.dataset.uuid])}else e.style.display=!s||o.has(e.dataset.entryId)?"flex":"none"}_matchSearchFolders(e,t){for(const i of this.collection.folders)e.test(SearchFilter.cleanQuery(i.name))&&t(i,!1)}_matchSearchEntries(e,t,i,n){const s=this.collection.searchMode===CONST.DIRECTORY_SEARCH_MODES.NAME,o=this.collection.index??this.collection.contents,r=new Set(i);for(const i of o){const o=this._getEntryId(i);r.has(i.folder?._id??i.folder)?t.add(o):s&&e.test(SearchFilter.cleanQuery(this._getEntryName(i)))&&(t.add(o),n(i.folder))}if(s)return;const a=this.collection.search({query:e.source,exclude:Array.from(t)});for(const e of a)t.has(e._id)||(t.add(e._id),n(e.folder))}_getEntryName(e){return e.name}_getEntryId(e){return e._id}async getData(e){const t=await super.getData(e);return foundry.utils.mergeObject(t,{tree:this.collection.tree,entryPartial:this.#Ja(),folderPartial:this.constructor.folderPartial,canCreateEntry:this.canCreateEntry,canCreateFolder:this.canCreateFolder,sortIcon:"a"===this.collection.sortingMode?"fa-arrow-down-a-z":"fa-arrow-down-short-wide",sortTooltip:"a"===this.collection.sortingMode?"SIDEBAR.SortModeAlpha":"SIDEBAR.SortModeManual",searchIcon:this.collection.searchMode===CONST.DIRECTORY_SEARCH_MODES.NAME?"fa-search":"fa-file-magnifying-glass",searchTooltip:this.collection.searchMode===CONST.DIRECTORY_SEARCH_MODES.NAME?"SIDEBAR.SearchModeName":"SIDEBAR.SearchModeFull"})}async _render(e,t){return await loadTemplates([this.#Ja(),this.constructor.folderPartial]),super._render(e,t)}#Ja(){return this.constructor.documentPartial?(foundry.utils.logCompatibilityWarning("Your sidebar application defines the documentPartial static property which is deprecated. Please use entryPartial instead.",{since:11,until:13}),this.constructor.documentPartial):this.constructor.entryPartial}activateListeners(e){super.activateListeners(e);const t=e.find(".directory-list"),i=t.find(".directory-item");e.find(`[data-folder-depth="${this.maxFolderDepth}"] .create-folder`).remove(),e.find(".toggle-sort").click(this.#Qa.bind(this)),e.find(".toggle-search-mode").click(this.#Za.bind(this)),e.find(".collapse-all").click(this.collapseAll.bind(this));const n=new IntersectionObserver(this._onLazyLoadImage.bind(this),{root:t[0]});i.each(((e,t)=>n.observe(t))),t.on("click",this.options.entryClickSelector,this._onClickEntryName.bind(this)),t.on("click",".folder-header",this._toggleFolder.bind(this));const s=this._onDragHighlight.bind(this);e.find(".folder").on("dragenter",s).on("dragleave",s),this._contextMenu(e),this.canCreateFolder&&e.find(".create-folder").click(this._onCreateFolder.bind(this)),this.canCreateEntry&&e.find(".create-entry").click(this._onCreateEntry.bind(this))}#Qa(e){e.preventDefault(),this.collection.toggleSortingMode(),this.render()}#Za(e){e.preventDefault(),this.collection.toggleSearchMode(),this.render()}collapseAll(){this.element.find("li.folder").addClass("collapsed");for(let e of this.collection.folders)c.folders._expanded[e.uuid]=!1;this.popOut&&this.setPosition()}_onCreateFolder(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget,i=t.closest(".directory-item"),n={folder:i?.dataset?.folderId||null,type:this.entryType},s={top:t.offsetTop,left:window.innerWidth-310-FolderConfig.defaultOptions.width};this.collection instanceof CompendiumCollection&&(s.pack=this.collection.collection),Folder.createDialog(n,s)}_toggleFolder(e){let t=$(e.currentTarget.parentElement),i=t.hasClass("collapsed");const n=t[0].dataset.uuid;if(c.folders._expanded[n]=i,i)t.removeClass("collapsed");else{t.addClass("collapsed");t.find(".folder").addClass("collapsed").each(((e,t)=>c.folders._expanded[n]=!1))}this.popOut&&this.setPosition()}async _onClickEntryName(e){e.preventDefault();const t=e.currentTarget.parentElement.dataset.entryId;this.collection.get(t).sheet.render(!0)}async _onCreateEntry(e){throw new Error("You must implement the _onCreateEntry method")}_onDragStart(e){ui.context&&ui.context.close({animate:!1});const t=e.currentTarget.closest(".directory-item"),i=t.classList.contains("folder")?this._getFolderDragData(t.dataset.folderId):this._getEntryDragData(t.dataset.entryId);i&&e.dataTransfer.setData("text/plain",JSON.stringify(i))}_getEntryDragData(e){const t=this.collection.get(e);return t?.toDragData()}_getFolderDragData(e){const t=this.collection.folders.get(e);return t?{type:"Folder",uuid:t.uuid}:null}_canDragStart(e){return!0}_onDragHighlight(e){const t=e.currentTarget;if(t.classList.contains("folder")){if(e.stopPropagation(),"dragenter"===e.type)for(let e of t.closest(".directory-list").querySelectorAll(".droptarget"))e.classList.remove("droptarget");if("dragleave"===e.type){if(document.elementFromPoint(e.clientX,e.clientY).closest(".folder")===t)return}t.classList.toggle("droptarget","dragenter"===e.type)}}_onDrop(e){const t=TextEditor$1.getDragEventData(e);if(!t.type)return;const i=e.target.closest(".directory-item")||null;switch(t.type){case"Folder":return this._handleDroppedFolder(i,t);case this.entryType:return this._handleDroppedEntry(i,t)}}async _handleDroppedFolder(e,t){const i=e?e.closest(".folder"):null;i&&i.classList.remove("droptarget");const n=i?i.dataset.folderId:null;let s=await fromUuid(t.uuid);if(!s)return;if(s?.type!==this.entryType){const e=c.i18n.localize(getDocumentClass(this.collection.documentName).metadata.label);return void ui.notifications.warn(c.i18n.format("FOLDER.InvalidDocumentType",{type:e}))}const o={sortKey:"sort",sortBefore:!0};if(e&&e.dataset.folderId){const t=await fromUuid(e.dataset.uuid);e.classList.contains("collapsed")?(o.target=t,o.parentId=t.folder?.id,o.parentUuid=t.folder?.uuid):(o.target=null,o.parentId=t.id,o.parentUuid=t.uuid)}else o.parentId=n,o.parentUuid=i?.dataset?.uuid,o.target=i&&i.classList.contains("collapsed")?i:null;if(o.parentId){const e=await fromUuid(o.parentUuid);if(e===s)return;if(e.ancestors.includes(s))return;const maxDepth=e=>Math.max(e.depth,...e.children.filter((e=>e.folder)).map((e=>maxDepth(e.folder))));if(e.depth+(maxDepth(s)-s.depth+1)>this.maxFolderDepth)return void ui.notifications.error(c.i18n.format("FOLDER.ExceededMaxDepth",{depth:this.maxFolderDepth}),{console:!1})}if(o.siblings=this.collection.folders.filter((e=>e.folder?.id===o.parentId&&e.type===s.type&&e!==s)),this.collection.folders.get(s.id)!==s){const e=await this._handleDroppedForeignFolder(s,n,o);if(!e||!e.sortNeeded)return;s=e.folder}return o.updateData={folder:o.parentId},s.sortRelative(o)}async _handleDroppedForeignFolder(e,t,i){return null}async _handleDroppedEntry(e,t){const i=e?e.closest(".folder"):null;i&&i.classList.remove("droptarget");let n=i?await fromUuid(i.dataset.uuid):null,s=await this._getDroppedEntryFromData(t);if(!s)return;const o=this.collection.index??this.collection,r={sortKey:"sort"};if(e&&e.dataset.entryId){if(s.id===e.dataset.entryId)return;const t=o.get(e.dataset.entryId);r.target=t,n=t?.folder}else r.target=null;if(n instanceof foundry.abstract.Document&&(n=n.id),r.siblings=o.filter((e=>!this._entryIsSelf(e,s)&&this._entryBelongsToFolder(e,n))),!this._entryAlreadyExists(s)){const e=SortingHelpers.performIntegerSort(s,r);if(1===e.length&&(s=s.clone({sort:e[0].update[r.sortKey]},{keepId:!0})),s=await this._createDroppedEntry(s,n),1===e.length)return}return r.updateData={folder:n||null},this._sortRelative(s,r)}_entryIsSelf(e,t){return e._id===t._id}_entryBelongsToFolder(e,t){return!e.folder&&!t||(e.folder instanceof foundry.abstract.Document?e.folder.id===t:e.folder===t)}_entryAlreadyExists(e){return this.collection.get(e.id)===e}async _getDroppedEntryFromData(e){throw new Error("The _getDroppedEntryFromData method must be implemented")}async _createDroppedEntry(e,t){throw new Error("The _createDroppedEntry method must be implemented")}async _sortRelative(e,t){throw new Error("The _sortRelative method must be implemented")}_contextMenu(e){ContextMenu.create(this,e,".folder .folder-header",this._getFolderContextOptions(),{hookName:"FolderContext"}),ContextMenu.create(this,e,this.options.contextMenuSelector,this._getEntryContextOptions())}_getFolderContextOptions(){return[{name:"FOLDER.Edit",icon:'<i class="fas fa-edit"></i>',condition:c.user.isGM,callback:async e=>{const t=e.closest(".directory-item")[0],i=await fromUuid(t.dataset.uuid),n=t.getBoundingClientRect(),s={top:n.top,left:n.left-FolderConfig.defaultOptions.width-10};new FolderConfig(i,s).render(!0)}},{name:"FOLDER.CreateTable",icon:`<i class="${g.RollTable.sidebarIcon}"></i>`,condition:e=>{const t=fromUuidSync(e.closest(".directory-item")[0].dataset.uuid);return CONST.COMPENDIUM_DOCUMENT_TYPES.includes(t.type)},callback:async e=>{const t=e.closest(".directory-item")[0],i=await fromUuid(t.dataset.uuid);return Dialog.confirm({title:`${c.i18n.localize("FOLDER.CreateTable")}: ${i.name}`,content:c.i18n.localize("FOLDER.CreateTableConfirm"),yes:()=>RollTable.fromFolder(i),options:{top:Math.min(t.offsetTop,window.innerHeight-350),left:window.innerWidth-680,width:360}})}},{name:"FOLDER.Remove",icon:'<i class="fas fa-trash"></i>',condition:c.user.isGM,callback:async e=>{const t=e.closest(".directory-item")[0],i=await fromUuid(t.dataset.uuid);return Dialog.confirm({title:`${c.i18n.localize("FOLDER.Remove")} ${i.name}`,content:`<h4>${c.i18n.localize("AreYouSure")}</h4><p>${c.i18n.localize("FOLDER.RemoveWarning")}</p>`,yes:()=>i.delete({deleteSubfolders:!1,deleteContents:!1}),options:{top:Math.min(t.offsetTop,window.innerHeight-350),left:window.innerWidth-720,width:400}})}},{name:"FOLDER.Delete",icon:'<i class="fas fa-dumpster"></i>',condition:c.user.isGM&&"Compendium"!==this.entryType,callback:async e=>{const t=e.closest(".directory-item")[0],i=await fromUuid(t.dataset.uuid);return Dialog.confirm({title:`${c.i18n.localize("FOLDER.Delete")} ${i.name}`,content:`<h4>${c.i18n.localize("AreYouSure")}</h4><p>${c.i18n.localize("FOLDER.DeleteWarning")}</p>`,yes:()=>i.delete({deleteSubfolders:!0,deleteContents:!0}),options:{top:Math.min(t.offsetTop,window.innerHeight-350),left:window.innerWidth-720,width:400}})}}]}_getEntryContextOptions(){return[{name:"FOLDER.Clear",icon:'<i class="fas fa-folder"></i>',condition:e=>{const t=e.closest(".directory-item"),i=this.collection.get(t.data("entryId"));return c.user.isGM&&!!i.folder},callback:e=>{const t=e.closest(".directory-item");this.collection.get(t.data("entryId")).update({folder:null})}},{name:"SIDEBAR.Delete",icon:'<i class="fas fa-trash"></i>',condition:()=>c.user.isGM,callback:e=>{const t=e.closest(".directory-item"),i=this.collection.get(t.data("entryId"));if(i)return i.deleteDialog({top:Math.min(t[0].offsetTop,window.innerHeight-350),left:window.innerWidth-720})}},{name:"SIDEBAR.Duplicate",icon:'<i class="far fa-copy"></i>',condition:()=>c.user.isGM||this.collection.documentClass.canUserCreate(c.user),callback:e=>{const t=e.closest(".directory-item"),i=this.collection.get(t.data("entryId"));return i.clone({name:`${i._source.name} (Copy)`},{save:!0,addSource:!0})}}]}}}class DocumentDirectory extends(DirectoryApplicationMixin(SidebarTab)){constructor(e={}){super(e),this.documents=null,this.folders=null,this.#el=e.collection??this.constructor.collection,this.initialize(),this.options.popOut||this.collection.apps.push(this)}static documentName="Document";static entryPartial="templates/sidebar/partials/document-partial.html";get entryType(){return this.constructor.documentName}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"templates/sidebar/document-directory.html",renderUpdateKeys:["name","img","thumb","ownership","sort","sorting","folder"]})}get title(){const e=getDocumentClass(this.constructor.documentName);return`${c.i18n.localize(e.metadata.labelPlural)} Directory`}get id(){return`${getDocumentClass(this.constructor.documentName).metadata.collection}${this._original?"-popout":""}`}get tabName(){return getDocumentClass(this.constructor.documentName).metadata.collection}static get collection(){return c.collections.get(this.documentName)}get collection(){return this.#el}#el;initialize(){this.folders=this.collection.folders.contents,this.documents=this.collection.filter((e=>e.visible)),this.collection.initializeTree()}async _render(e,t={}){const{renderContext:i,renderData:n}=t;if(i!==`update${this.entryType}`||n?.some((e=>this.options.renderUpdateKeys.some((t=>foundry.utils.hasProperty(e,t))))))return this.initialize(),super._render(e,t)}get canCreateEntry(){return getDocumentClass(this.constructor.documentName).canUserCreate(c.user)}get canCreateFolder(){return this.canCreateEntry}async getData(e={}){const t=await super.getData(e),i=g[this.collection.documentName],n=i.documentClass;return foundry.utils.mergeObject(t,{documentCls:n.documentName.toLowerCase(),tabName:n.metadata.collection,sidebarIcon:i.sidebarIcon,folderIcon:g.Folder.sidebarIcon,label:c.i18n.localize(n.metadata.label),labelPlural:c.i18n.localize(n.metadata.labelPlural),unavailable:c.user.isGM?i.collection?.instance?.invalidDocumentIds?.size:0})}activateListeners(e){super.activateListeners(e),e.find(".show-issues").on("click",(()=>(new SupportDetails).render(!0,{tab:"documents"})))}async _onClickEntryName(e){e.preventDefault();const t=e.currentTarget.parentElement.dataset.documentId;(this.collection.get(t)??await this.collection.getDocument(t)).sheet.render(!0)}async _onCreateEntry(e,{_skipDeprecated:t=!1}={}){if(this._onCreateDocument!==DocumentDirectory.prototype._onCreateDocument&&!t)return foundry.utils.logCompatibilityWarning("DocumentDirectory#_onCreateDocument is deprecated. Please use DocumentDirectory#_onCreateEntry instead.",{since:11,until:13}),this._onCreateDocument(e);e.preventDefault(),e.stopPropagation();const i=e.currentTarget,n=i.closest(".directory-item"),s={folder:n?.dataset?.folderId},o={width:320,left:window.innerWidth-630,top:i.offsetTop};this.collection instanceof CompendiumCollection&&(o.pack=this.collection.collection);return getDocumentClass(this.collection.documentName).createDialog(s,o)}_onDrop(e){const t=TextEditor$1.getDragEventData(e);if(!t.type)return;const i=e.target.closest(".directory-item")||null;switch(t.type){case"Folder":return this._handleDroppedFolder(i,t);case this.collection.documentName:return this._handleDroppedEntry(i,t)}}async _handleDroppedEntry(e,t,{_skipDeprecated:i=!1}={}){return this._handleDroppedDocument===DocumentDirectory.prototype._handleDroppedDocument||i?super._handleDroppedEntry(e,t):(foundry.utils.logCompatibilityWarning("DocumentDirectory#_handleDroppedDocument is deprecated. Please use DocumentDirectory#_handleDroppedEntry instead.",{since:11,until:13}),this._handleDroppedDocument(e,t))}async _getDroppedEntryFromData(e){return this.collection.documentClass.fromDropData(e)}async _sortRelative(e,t){return e.sortRelative(t)}async _createDroppedEntry(e,t){const i=e.toObject();return i.folder=t||null,e.constructor.create(i,{fromCompendium:!!e.compendium})}async _handleDroppedForeignFolder(e,t,i){const n=await this._createDroppedFolderContent(e,this.collection.folders.get(t));return n.length&&(e=n[0]),{sortNeeded:!0,folder:e}}async _createDroppedFolderContent(e,t){const{foldersToCreate:i,documentsToCreate:n}=await this._organizeDroppedFoldersAndDocuments(e,t);let s;try{s=await Folder.createDocuments(i,{pack:this.collection.collection,keepId:!0})}catch(e){throw ui.notifications.error(e.message),e}return await this._createDroppedFolderDocuments(e,n),s}async _organizeDroppedFoldersAndDocuments(e,t){let i=[],n=[],s=!1;const addFolder=(e,o)=>{if(e){if(this.collection.folders.get(e.id)!==e){const n=e.toObject();if(t&&(n.folder=t.id,t=void 0),o>this.maxFolderDepth)return void(s=!0);n.pack=this.collection.collection,i.push(n)}if(e.contents?.length)for(const t of e.contents){const e=t.toObject?t.toObject():foundry.utils.deepClone(t);n.push(e)}for(const t of e.children)addFolder(t.folder,o+1)}},o=(t?.ancestors.length??0)+1;return addFolder(e,o),s&&(ui.notifications.error(c.i18n.format("FOLDER.ExceededMaxDepth",{depth:this.maxFolderDepth}),{console:!1}),i.length=n.length=0),{foldersToCreate:i,documentsToCreate:n}}async _createDroppedFolderDocuments(e,t){if(e.pack){const i=c.packs.get(e.pack);if(i){const e=t.map((e=>e._id));t=await i.getDocuments({_id__in:e})}}try{await this.collection.documentClass.createDocuments(t,{pack:this.collection.collection,keepId:!0})}catch(e){throw ui.notifications.error(e.message),e}}_getFolderContextOptions(){return super._getFolderContextOptions().concat([{name:"OWNERSHIP.Configure",icon:'<i class="fas fa-lock"></i>',condition:()=>c.user.isGM,callback:async e=>{const t=e.closest(".directory-item")[0],i=await fromUuid(t.dataset.uuid);new DocumentOwnershipConfig(i,{top:Math.min(t.offsetTop,window.innerHeight-350),left:window.innerWidth-720}).render(!0)}},{name:"FOLDER.Export",icon:'<i class="fas fa-atlas"></i>',condition:e=>{const t=fromUuidSync(e.parent().data("uuid"));return CONST.COMPENDIUM_DOCUMENT_TYPES.includes(t.type)},callback:async e=>{const t=e.closest(".directory-item")[0];return(await fromUuid(t.dataset.uuid)).exportDialog(null,{top:Math.min(t.offsetTop,window.innerHeight-350),left:window.innerWidth-720,width:400})}}])}_getEntryContextOptions(){const e=super._getEntryContextOptions();return[{name:"OWNERSHIP.Configure",icon:'<i class="fas fa-lock"></i>',condition:()=>c.user.isGM,callback:e=>{const t=e.closest(".directory-item"),i=this.collection.get(t.data("documentId"));new DocumentOwnershipConfig(i,{top:Math.min(t[0].offsetTop,window.innerHeight-350),left:window.innerWidth-720}).render(!0)}},{name:"SIDEBAR.Export",icon:'<i class="fas fa-file-export"></i>',condition:e=>{const t=e.closest(".directory-item");return this.collection.get(t.data("documentId")).isOwner},callback:e=>{const t=e.closest(".directory-item");return this.collection.get(t.data("documentId")).exportToJSON()}},{name:"SIDEBAR.Import",icon:'<i class="fas fa-file-import"></i>',condition:e=>{const t=e.closest(".directory-item");return this.collection.get(t.data("documentId")).isOwner},callback:e=>{const t=e.closest(".directory-item");return this.collection.get(t.data("documentId")).importFromJSONDialog()}}].concat(e)}async _onCreateDocument(e){return foundry.utils.logCompatibilityWarning("DocumentDirectory#_onCreateDocument is deprecated. Please use DocumentDirectory#_onCreateEntry instead.",{since:11,until:13}),this._onCreateEntry(e,{_skipDeprecated:!0})}async _handleDroppedDocument(e,t){return foundry.utils.logCompatibilityWarning("DocumentDirectory#_handleDroppedDocument is deprecated. Please use DocumentDirectory#_handleDroppedEntry instead.",{since:11,until:13}),this._handleDroppedEntry(e,t,{_skipDeprecated:!0})}}Object.defineProperty(globalThis,"SidebarDirectory",{get:()=>(foundry.utils.logCompatibilityWarning("SidebarDirectory has been deprecated. Please use DocumentDirectory instead.",{since:11,until:13}),DocumentDirectory)});class PackageConfiguration extends FormApplication{static get categoryOrder(){return["all","core","system","module","unmapped"]}get activeCategory(){return this._tabs[0].active}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["package-configuration"],template:"templates/sidebar/apps/package-configuration.html",categoryTemplate:void 0,width:780,height:680,resizable:!0,scrollY:[".filters",".categories"],tabs:[{navSelector:".tabs",contentSelector:"form .scrollable",initial:"all"}],filters:[{inputSelector:'input[name="filter"]',contentSelector:".categories"}],submitButton:!1})}getData(e={}){const t=this._prepareCategoryData();return t.categoryTemplate=this.options.categoryTemplate,t.submitButton=this.options.submitButton,t}_prepareCategoryData(){return{categories:[],total:0}}_categorizeEntry(e){if("core"===e)return{id:"core",title:c.i18n.localize("PACKAGECONFIG.Core")};if(e===c.system.id)return{id:"system",title:c.system.title};{const t=c.modules.get(e);return t?{id:t.id,title:t.title}:{id:"unmapped",title:c.i18n.localize("PACKAGECONFIG.Unmapped")}}}_sortCategories(e,t){const i=this.constructor.categoryOrder;let n=i.indexOf(e.id);-1===n&&(n=i.length-2);let s=this.constructor.categoryOrder.indexOf(t.id);return-1===s&&(s=i.length-2),n-s||e.title.localeCompare(t.title,c.i18n.lang)}async _render(e,{activeCategory:t,...i}={}){await loadTemplates([this.options.categoryTemplate]),await super._render(e,i),t&&this._tabs[0].activate(t);const n=this._tabs[0]?.active;n&&this.element[0].querySelector(`.tabs [data-tab="${n}"]`)?.scrollIntoView()}activateListeners(e){super.activateListeners(e),"all"===this.activeCategory&&this._tabs[0]._content.querySelectorAll(".tab").forEach((e=>e.classList.add("active"))),e.find("button.reset-all").click(this._onResetDefaults.bind(this)),e.find("input[name=filter]").focus()}_onChangeTab(e,t,i){"all"===i&&t._content.querySelectorAll(".tab").forEach((e=>e.classList.add("active")))}_onSearchFilter(e,t,i,n){const s=new Set;for(const e of n.querySelectorAll(".form-group")){if(!t){e.classList.remove("hidden");continue}const n=e.querySelector("label")?.textContent,o=e.querySelector(".notes")?.textContent,r=n&&i.test(SearchFilter.cleanQuery(n))||o&&i.test(SearchFilter.cleanQuery(o));e.classList.toggle("hidden",!r),r&&s.add(e.parentElement.dataset.category)}for(const e of n.querySelectorAll(".category"))e.classList.toggle("hidden",t&&!s.has(e.dataset.category))}_onResetDefaults(e){}}class ActorSheet extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{height:720,width:800,template:"templates/sheets/actor-sheet.html",closeOnSubmit:!1,submitOnClose:!0,submitOnChange:!0,resizable:!0,baseApplication:"ActorSheet",dragDrop:[{dragSelector:".item-list .item",dropSelector:null}],secrets:[{parentSelector:".editor"}],token:null})}get title(){return this.actor.isToken?`[${c.i18n.localize(TokenDocument.metadata.label)}] ${this.actor.name}`:this.actor.name}get actor(){return this.object}get token(){return this.object.token||this.options.token||null}async close(e){return this.options.token=null,super.close(e)}getData(e={}){const t=super.getData(e);return t.actor=this.object,t.items=t.data.items,t.items.sort(((e,t)=>(e.sort||0)-(t.sort||0))),t.effects=t.data.effects,t}_getHeaderButtons(){let e=super._getHeaderButtons();const t=c.user.isGM||this.actor.isOwner&&c.user.can("TOKEN_CONFIGURE");if(this.options.editable&&t){const t=e.findIndex((e=>"Close"===e.label));e.splice(t,0,{label:this.token?"Token":"TOKEN.TitlePrototype",class:"configure-token",icon:"fas fa-user-circle",onclick:e=>this._onConfigureToken(e)})}return e}_getSubmitData(e={}){const t=super._getSubmitData(e),i=foundry.utils.flattenObject(this.actor.overrides);for(let e of Object.keys(i))delete t[e];return t}_onConfigureToken(e){e.preventDefault();const t={left:Math.max(this.position.left-560-10,10),top:this.position.top};if(this.token)return this.token.sheet.render(!0,t);new g.Token.prototypeSheetClass(this.actor.prototypeToken,t).render(!0)}_canDragStart(e){return this.isEditable}_canDragDrop(e){return this.isEditable}_onDragStart(e){const t=e.currentTarget;if("link"in e.target.dataset)return;let i;if(t.dataset.itemId){i=this.actor.items.get(t.dataset.itemId).toDragData()}if(t.dataset.effectId){i=this.actor.effects.get(t.dataset.effectId).toDragData()}i&&e.dataTransfer.setData("text/plain",JSON.stringify(i))}async _onDrop(e){const t=TextEditor$1.getDragEventData(e),i=this.actor;if(!1!==Hooks$1.call("dropActorSheetData",i,this,t))switch(t.type){case"ActiveEffect":return this._onDropActiveEffect(e,t);case"Actor":return this._onDropActor(e,t);case"Item":return this._onDropItem(e,t);case"Folder":return this._onDropFolder(e,t)}}async _onDropActiveEffect(e,t){const i=await ActiveEffect.implementation.fromDropData(t);return!(!this.actor.isOwner||!i)&&(i.target!==this.actor&&ActiveEffect.create(i.toObject(),{parent:this.actor}))}async _onDropActor(e,t){if(!this.actor.isOwner)return!1}async _onDropItem(e,t){if(!this.actor.isOwner)return!1;const i=await Item.implementation.fromDropData(t),n=i.toObject();return this.actor.uuid===i.parent?.uuid?this._onSortItem(e,n):this._onDropItemCreate(n,e)}async _onDropFolder(e,t){if(!this.actor.isOwner)return[];const i=await Folder.implementation.fromDropData(t);if("Item"!==i.type)return[];const n=await Promise.all(i.contents.map((async e=>(document instanceof Item||(e=await fromUuid(e.uuid)),e.toObject()))));return this._onDropItemCreate(n,e)}async _onDropItemCreate(e,t){return e=e instanceof Array?e:[e],this.actor.createEmbeddedDocuments("Item",e)}_onSortItem(e,t){const i=this.actor.items,n=i.get(t._id),s=e.target.closest("[data-item-id]");if(!s)return;const o=i.get(s.dataset.itemId);if(n.id===o.id)return;const r=[];for(let e of s.parentElement.children){const t=e.dataset.itemId;t&&t!==n.id&&r.push(i.get(e.dataset.itemId))}const a=SortingHelpers.performIntegerSort(n,{target:o,siblings:r}).map((e=>{const t=e.update;return t._id=e.target._id,t}));return this.actor.updateEmbeddedDocuments("Item",a)}}class AdventureImporter extends DocumentSheet{adventure=this.object;get isEditable(){return c.user.isGM}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"templates/adventure/importer.html",id:"adventure-importer",classes:["sheet","adventure","adventure-importer"],width:800,height:"auto",submitOnClose:!1,closeOnSubmit:!0})}async getData(e={}){return{adventure:this.adventure,contents:this._getContentList(),imported:!!c.settings.get("core","adventureImports")?.[this.adventure.uuid]}}activateListeners(e){super.activateListeners(e),e.find('[value="all"]').on("change",this._onToggleImportAll.bind(this))}_onToggleImportAll(e){const t=e.currentTarget,i=t.closest(".import-controls"),n=t.checked;i.querySelectorAll("input").forEach((e=>{e!==t&&("folders"!==e.value&&(e.disabled=n),n&&(e.checked=!0))}))}_getContentList(){return Object.entries(Adventure.contentFields).reduce(((e,[t,i])=>{const n=this.adventure[t].size;return n?(e.push({icon:g[i.documentName].sidebarIcon,label:c.i18n.localize(n>1?i.metadata.labelPlural:i.metadata.label),count:n,field:t}),e):e}),[])}_getHeaderButtons(){const e=super._getHeaderButtons();return e.findSplice((e=>"import"===e.class)),e}async _updateObject(e,t){const i=foundry.utils.getDefiningClass(this,"_prepareImportData"),n=foundry.utils.getDefiningClass(this,"_importContent");if(i!==AdventureImporter||n!==AdventureImporter){const e=`The ${this.name} class overrides the AdventureImporter#_prepareImportData or \n      AdventureImporter#_importContent methods. As such a legacy import workflow will be used, but this workflow is \n      deprecated. Your importer should now call the new Adventure#import, Adventure#prepareImport, \n      or Adventure#importContent methods.`;return foundry.utils.logCompatibilityWarning(e,{since:11,until:13}),this._importLegacy(t)}return this.adventure.import(t)}async _importLegacy(e){const{toCreate:t,toUpdate:i,documentCount:n}=await this._prepareImportData(e);if(!1===Hooks$1.call("preImportAdventure",this.adventure,e,t,i))return console.log(`"${this.adventure.name}" Adventure import was prevented by the "preImportAdventure" hook`);if(!foundry.utils.isEmpty(i)){if(!await Dialog.confirm({title:c.i18n.localize("ADVENTURE.ImportOverwriteTitle"),content:`<h4><strong>${c.i18n.localize("Warning")}:</strong></h4>\n        <p>${c.i18n.format("ADVENTURE.ImportOverwriteWarning",{name:this.adventure.name})}</p>`}))return}const{created:s,updated:o}=await this._importContent(t,i,n);ui.sidebar.render(),Hooks$1.callAll("importAdventure",this.adventure,e,s,o)}async _prepareImportData(e){return foundry.utils.logCompatibilityWarning("AdventureImporter#_prepareImportData is deprecated. Please use Adventure#prepareImport instead.",{since:11,until:13}),this.adventure.prepareImport(e)}async _importContent(e,t,i){return foundry.utils.logCompatibilityWarning("AdventureImporter#_importContent is deprecated. Please use Adventure#importContent instead.",{since:11,until:13}),this.adventure.importContent({toCreate:e,toUpdate:t,documentCount:i})}}class BaseSheet extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"templates/sheets/base-sheet.html",classes:["sheet","base-sheet"],width:450,height:"auto",resizable:!0,submitOnChange:!0,closeOnSubmit:!1})}async getData(e={}){const t=await super.getData(e);return t.hasName="name"in this.object,t.hasImage="img"in this.object,t.hasDescription="description"in this.object,t.hasDescription&&(t.descriptionHTML=await TextEditor$1.enrichHTML(this.object.description,{secrets:this.object.isOwner,relativeTo:this.object})),t}async _render(e,t){await super._render(e,t),await this._waitForImages(),this.setPosition()}async activateEditor(e,t={},i=""){return t.relativeLinks=!0,t.plugins={menu:ProseMirror.ProseMirrorMenu.build(ProseMirror.defaultSchema,{compact:!0,destroyOnSave:!1,onSave:()=>this.saveEditor(e,{remove:!1})})},super.activateEditor(e,t,i)}}class CardConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","card-config"],template:"templates/cards/card-config.html",width:480,height:"auto",tabs:[{navSelector:".tabs",contentSelector:"form",initial:"details"}]})}getData(e={}){return foundry.utils.mergeObject(super.getData(e),{data:this.document.toObject(),types:g.Card.typeLabels})}activateListeners(e){super.activateListeners(e),e.find(".face-control").click(this._onFaceControl.bind(this))}async _onFaceControl(e){const t=e.currentTarget,i=t.closest(".face"),n=this.object.toObject().faces;switch(await this._onSubmit(e,{preventClose:!0,preventRender:!0}),t.dataset.action){case"addFace":return n.push({}),this.object.update({faces:n});case"deleteFace":return Dialog.confirm({title:c.i18n.localize("CARD.FaceDelete"),content:`<h4>${c.i18n.localize("AreYouSure")}</h4><p>${c.i18n.localize("CARD.FaceDeleteWarning")}</p>`,yes:()=>{const e=Number(i.dataset.face);return n.splice(e,1),this.object.update({faces:n})}})}}}class CardsConfig extends DocumentSheet{constructor(e,t){super(e,t),this.options.classes.push(e.type)}static SORT_TYPES={STANDARD:"standard",SHUFFLED:"shuffled"};static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","cards-config"],template:"templates/cards/cards-deck.html",width:620,height:"auto",closeOnSubmit:!1,viewPermission:CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER,dragDrop:[{dragSelector:"ol.cards li.card",dropSelector:"ol.cards"}],tabs:[{navSelector:".tabs",contentSelector:"form",initial:"cards"}],scrollY:["ol.cards"],sort:this.SORT_TYPES.SHUFFLED})}getData(e={}){const t={standard:this.object.sortStandard,shuffled:this.object.sortShuffled}[e?.sort||"standard"],i=this.object.cards.contents.sort(((e,i)=>t.call(this.object,e,i)));return foundry.utils.mergeObject(super.getData(e),{cards:i,types:g.Cards.typeLabels,inCompendium:!!this.object.pack})}activateListeners(e){super.activateListeners(e),e.find(".card-control").click(this._onCardControl.bind(this));const t=e.find("ol.cards"),i=t.find("li.card"),n=new IntersectionObserver(this._onLazyLoadImage.bind(this),{root:t[0]});i.each(((e,t)=>n.observe(t)))}async _onCardControl(e){const t=e.currentTarget,i=t.closest(".card"),n=i?this.object.cards.get(i.dataset.cardId):null,s=getDocumentClass("Card");switch(await this._onSubmit(e,{preventClose:!0,preventRender:!0}),t.dataset.action){case"create":return s.createDialog({faces:[{}],face:0},{parent:this.object,pack:this.object.pack});case"edit":return n.sheet.render(!0);case"delete":return n.deleteDialog();case"deal":return this.object.dealDialog();case"draw":return this.object.drawDialog();case"pass":return this.object.passDialog();case"play":return this.object.playDialog(n);case"reset":return this.object.resetDialog();case"shuffle":return this.options.sort=this.constructor.SORT_TYPES.SHUFFLED,this.object.shuffle();case"toggleSort":return this.options.sort={standard:"shuffled",shuffled:"standard"}[this.options.sort],this.render();case"nextFace":return n.update({face:null===n.face?0:n.face+1});case"prevFace":return n.update({face:0===n.face?null:n.face-1})}}_onLazyLoadImage(e,t){return ui.cards._onLazyLoadImage.call(this,e,t)}_canDragStart(e){return this.isEditable}_onDragStart(e){const t=e.currentTarget,i=this.object.cards.get(t.dataset.cardId);i&&e.dataTransfer.setData("text/plain",JSON.stringify(i.toDragData()))}_canDragDrop(e){return this.isEditable}async _onDrop(e){const t=TextEditor$1.getDragEventData(e);if("Card"!==t.type)return;const i=await Card.implementation.fromDropData(t);if(i.parent.id===this.object.id)return this._onSortCard(e,i);try{return await i.pass(this.object)}catch(e){Hooks$1.onError("CardsConfig#_onDrop",e,{log:"error",notify:"error"})}}_onSortCard(e,t){let i=null;const n=e.target.closest("[data-card-id]");if(n&&(i=this.object.cards.get(n.dataset.cardId)??null),t===i)return;const s=this.object.cards.filter((e=>e.id!==t.id)),o=SortingHelpers.performIntegerSort(t,{target:i,siblings:s}).map((e=>({_id:e.target.id,sort:e.update.sort})));return this.object.updateEmbeddedDocuments("Card",o)}}class CardsHand extends CardsConfig{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"templates/cards/cards-hand.html"})}}class CardsPile extends CardsConfig{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"templates/cards/cards-pile.html"})}}class CombatTrackerConfig extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"combat-config",title:c.i18n.localize("COMBAT.Settings"),classes:["sheet","combat-sheet"],template:"templates/sheets/combat-config.html",width:420})}async getData(e={}){const t=TokenDocument.implementation.getTrackedAttributes();t.bar.forEach((e=>e.push("value")));const i=c.settings.settings.get("core.combatTheme");return{canConfigure:c.user.can("SETTINGS_MODIFY"),settings:c.settings.get("core",Combat.CONFIG_SETTING),attributeChoices:TokenDocument.implementation.getTrackedAttributeChoices(t),combatTheme:i,selectedTheme:c.settings.get("core","combatTheme"),user:c.user}}async _updateObject(e,t){return c.settings.set("core","combatTheme",t["core.combatTheme"]),c.settings.set("core",Combat.CONFIG_SETTING,{resource:t.resource,skipDefeated:t.skipDefeated})}activateListeners(e){super.activateListeners(e),e.find(".audio-preview").click(this.#tl.bind(this))}#il=0;#tl(e){const t=this.form["core.combatTheme"].value,i=g.Combat.sounds[t];if(!i||"none"===i)return;const n=CONST.COMBAT_ANNOUNCEMENTS,s=i[n[this.#il++%n.length]];if(!s)return;const o=s[Math.floor(Math.random()*s.length)];c.audio.play(o,{context:c.audio.interface})}async _onChangeInput(e){return"core.combatTheme"===e.currentTarget.name&&(this.#il=0),super._onChangeInput(e)}}class CombatantConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"combatant-config",title:c.i18n.localize("COMBAT.CombatantConfig"),classes:["sheet","combat-sheet"],template:"templates/sheets/combatant-config.html",width:420})}get title(){return c.i18n.localize(this.object.id?"COMBAT.CombatantUpdate":"COMBAT.CombatantCreate")}async _updateObject(e,t){if(this.object.id)return this.object.update(t);return getDocumentClass("Combatant").create(t,{parent:c.combat})}}class DefaultSheetsConfig extends PackageConfiguration{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{title:c.i18n.localize("SETTINGS.DefaultSheetsL"),id:"default-sheets-config",categoryTemplate:"templates/sidebar/apps/default-sheets-config.html",submitButton:!0})}_prepareCategoryData(){let e=0;const t=[];for(const i of Object.values(foundry.documents)){const n=i.documentName;if(!i.hasTypeData)continue;const s=c.documentTypes[n].filter((e=>e!==CONST.BASE_DOCUMENT_TYPE));if(!s.length)continue;const o=c.i18n.localize(i.metadata.labelPlural);t.push({title:o,id:n,count:s.length,subTypes:s.map((e=>{const t=g[n].typeLabels?.[e],i=t?c.i18n.localize(t):e,{defaultClasses:s,defaultClass:o}=DocumentSheetConfig.getSheetClassesForSubType(n,e);return{type:e,name:i,defaultClasses:s,defaultClass:o}}))}),e+=s.length}return{categories:t,total:e}}async _updateObject(e,t){const i=c.settings.get("core","sheetClasses"),n=Object.entries(t).reduce(((e,[t,n])=>{const[s,...o]=t.split("."),r=o.join("."),a=g[s].sheetClasses?.[r]?.[n];if(a?.default&&!i[s]?.[r])return e;return(e[s]??={})[r]=n,e}),{});return c.settings.set("core","sheetClasses",n)}async _onResetDefaults(e){return e.preventDefault(),await c.settings.set("core","sheetClasses",{}),SettingsConfig.reloadConfirm({world:!0})}}class ActiveEffectConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","active-effect-sheet"],template:"templates/sheets/active-effect-config.html",width:580,height:"auto",tabs:[{navSelector:".tabs",contentSelector:"form",initial:"details"}]})}async getData(e={}){const t=await super.getData(e);t.descriptionHTML=await TextEditor$1.enrichHTML(this.object.description,{secrets:this.object.isOwner});const i=g.ActiveEffect.legacyTransferral,n={transfer:{name:c.i18n.localize("EFFECT.Transfer"+(i?"Legacy":"")),hint:c.i18n.localize("EFFECT.TransferHint"+(i?"Legacy":""))}},s=g.statusEffects.map((e=>({id:e.id,label:c.i18n.localize(e.name??e.label),selected:t.data.statuses.includes(e.id)?"selected":""})));return foundry.utils.mergeObject(t,{labels:n,effect:this.object,data:this.object,isActorEffect:"Actor"===this.object.parent.documentName,isItemEffect:"Item"===this.object.parent.documentName,submitText:"EFFECT.Submit",statuses:s,modes:Object.entries(CONST.ACTIVE_EFFECT_MODES).reduce(((e,t)=>(e[t[1]]=c.i18n.localize(`EFFECT.MODE_${t[0]}`),e)),{})})}activateListeners(e){super.activateListeners(e),e.find(".effect-control").click(this._onEffectControl.bind(this))}_onEffectControl(e){e.preventDefault();const t=e.currentTarget;switch(t.dataset.action){case"add":return this._addEffectChange();case"delete":return t.closest(".effect-change").remove(),this.submit({preventClose:!0}).then((()=>this.render()))}}async _addEffectChange(){const e=this.document.changes.length;return this.submit({preventClose:!0,updateData:{[`changes.${e}`]:{key:"",mode:CONST.ACTIVE_EFFECT_MODES.ADD,value:""}}})}_getSubmitData(e={}){const t=new FormDataExtended(this.form,{editors:this.editors});let i=foundry.utils.expandObject(t.object);return e&&foundry.utils.mergeObject(i,e),i.changes=Array.from(Object.values(i.changes||{})),i.statuses??=[],i}}class FolderConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","folder-edit"],template:"templates/sidebar/folder-edit.html",width:360})}get id(){return this.object.id?super.id:"folder-create"}get title(){return this.object.id?`${c.i18n.localize("FOLDER.Update")}: ${this.object.name}`:c.i18n.localize("FOLDER.Create")}async close(e={}){return this.options.submitOnClose||this.options.resolve?.(null),super.close(e)}async getData(e={}){const t=this.document.toObject();return{folder:t,name:t._id?t.name:"",newName:Folder.implementation.defaultName({pack:t.pack}),safeColor:t.color?.css??"#000000",sortingModes:{a:"FOLDER.SortAlphabetical",m:"FOLDER.SortManual"},submitText:c.i18n.localize(t._id?"FOLDER.Update":"FOLDER.Create")}}async _updateObject(e,t){let i=this.object;return t.name?.trim()||(t.name=Folder.implementation.defaultName({pack:i.pack})),this.object.id?await this.object.update(t):(this.object.updateSource(t),i=await Folder.create(this.object,{pack:this.object.pack})),this.options.resolve?.(i),i}}class FontConfig extends FormApplication{constructor(e={},t={}){foundry.utils.mergeObject(e,{family:"",weight:400,style:"normal",src:"",preview:c.i18n.localize("FONTS.FontPreview"),type:FontConfig.FONT_TYPES.FILE}),super(e,t)}#nl=!1;#sl=null;#ol({family:e,index:t}){return!!this.#sl&&(e===this.#sl.family&&t===this.#sl.index)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{title:c.i18n.localize("SETTINGS.FontConfigL"),id:"font-config",template:"templates/sidebar/apps/font-config.html",popOut:!0,width:600,height:"auto",closeOnSubmit:!1,submitOnChange:!0})}static FONT_TYPES={FILE:"file",SYSTEM:"system"};getData(e={}){const t=c.settings.get("core",this.constructor.SETTING),i=Object.entries(t).flatMap((([e,t])=>this._getDataForDefinition(e,t)));let n;return null===this.#sl&&i.length&&(i[0].selected=!0,this.#sl={family:i[0].family,index:i[0].index}),i.length&&(n=t[this.#sl.family].fonts[this.#sl.index]),{fonts:i,selected:n,font:this.object,family:this.#sl?.family,weights:Object.entries(CONST.FONT_WEIGHTS).map((([e,t])=>({value:t,label:`${e} ${t}`}))),styles:[{value:"normal",label:"Normal"},{value:"italic",label:"Italic"}]}}_getDataForDefinition(e,t){return(t.fonts.length?t.fonts:[{}]).map(((t,i)=>{const n={family:e,index:i};return this.#ol(n)&&(n.selected=!0),n.font=this.constructor._formatFont(e,t),n}))}activateListeners(e){super.activateListeners(e),e.find("[contenteditable]").on("blur",this._onSubmit.bind(this)),e.find(".control").on("click",this._onClickControl.bind(this))}async _updateObject(e,t){foundry.utils.mergeObject(this.object,t)}async close(e={}){if(await super.close(e),this.#nl)return SettingsConfig.reloadConfirm({world:!0})}_onClickControl(e){switch(e.currentTarget.dataset.action){case"add":return this._onAddFont();case"delete":return this._onDeleteFont(e);case"select":return this._onSelectFont(e)}}async _onChangeInput(e){return this._updateFontFields(),super._onChangeInput(e)}_updateFontFields(){const e=this.form.elements.type.value===this.constructor.FONT_TYPES.SYSTEM;["weight","style","src"].forEach((t=>{const i=this.form.elements[t];i&&i.closest(".form-group")?.classList.toggle("hidden",e)})),this.setPosition()}async _onAddFont(){const{family:e,src:t,weight:i,style:n,type:s}=this._getSubmitData(),o=c.settings.get("core",this.constructor.SETTING);o[e]??={editor:!0,fonts:[]};const r=o[e],a=s===this.constructor.FONT_TYPES.FILE?r.fonts.push({urls:[t],weight:i,style:n}):1;await c.settings.set("core",this.constructor.SETTING,o),await this.constructor.loadFont(e,r),this.#sl={family:e,index:a-1},this.#nl=!0,this.render(!0)}async _onDeleteFont(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget.closest("[data-family]"),{family:i,index:n}=t.dataset,s=c.settings.get("core",this.constructor.SETTING),o=s[i];o&&(this.#nl=!0,o.fonts.splice(Number(n),1),o.fonts.length||delete s[i],await c.settings.set("core",this.constructor.SETTING,s),this.#ol({family:i,index:Number(n)})&&(this.#sl=null),this.render(!0))}_onSelectFont(e){const{family:t,index:i}=e.currentTarget.dataset;this.#sl={family:t,index:Number(i)},this.render(!0)}static SETTING="fonts";static#rl=new Set;static getAvailableFonts(){return Array.from(this.#rl)}static getAvailableFontChoices(){return this.getAvailableFonts().reduce(((e,t)=>(e[t]=t,e)),{})}static async loadFont(e,t){const i=`1rem "${e}"`;try{for(const i of t.fonts){const t=this._createFontFace(e,i);await t.load(),document.fonts.add(t)}await document.fonts.load(i)}catch(t){return console.warn(`Font family "${e}" failed to load: `,t),!1}return document.fonts.check(i)?(t.editor&&this.#rl.add(e),!0):(console.warn(`Font family "${e}" failed to load.`),!1)}static async _loadFonts(e=4500){const t=this._collectDefinitions(),i=[];for(const e of t)for(const[t,n]of Object.entries(e))i.push(this.loadFont(t,n));const n=new Promise((t=>setTimeout(t,e))),s=Promise.all(i).then((()=>document.fonts.ready));return Promise.race([s,n]).then((()=>console.log(`${l} | Fonts loaded and ready.`)))}static _collectDefinitions(){return[g.fontDefinitions,c.settings.get("core",this.SETTING)]}static _createFontFace(e,t){const i=t.urls.map((e=>`url("${e}")`)).join(", ");return new FontFace(e,i,t)}static _formatFont(e,t){if(foundry.utils.isEmpty(t))return e;const{weight:i,style:n}=t;return`\n      ${e},\n      <span style="font-weight: ${i}">${Object.fromEntries(Object.entries(CONST.FONT_WEIGHTS).map((([e,t])=>[t,e])))[i]} ${i}</span>,\n      <span style="font-style: ${n}">${n.toLowerCase()}</span>\n    `}}class GridConfig extends FormApplication{constructor(e,t,...i){super(e,...i),this.sheet=t}#al;#ll;#Ke=null;#Wn=null;#on=null;#es=null;static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"grid-config",template:"templates/scene/grid-config.html",title:c.i18n.localize("SCENES.GridConfigTool"),width:480,height:"auto",closeOnSubmit:!0})}async _render(e,t){const i=Application.RENDER_STATES;e&&[i.CLOSED,i.NONE].includes(this._state)&&(this.object.background.src||ui.notifications.warn("WARNING.GridConfigNoBG",{localize:!0}),this.#Ke=this.object.clone()),await super._render(e,t),await this.#cl()}getData(e={}){const t=getTexture(this.#Ke.background.src);return{gridTypes:SceneConfig._getGridTypes(),scale:this.#Ke.background.src?this.object.width/t.width:1,scene:this.#Ke}}_getSubmitData(e){const t=super._getSubmitData(e),i=getTexture(this.#Ke.background.src),n=i||{width:this.object.width,height:this.object.height};return t.width=n.width*t.scale,t.height=n.height*t.scale,delete t.scale,t}async close(e={}){document.removeEventListener("keydown",this.#al),document.removeEventListener("wheel",this.#ll),this.#al=this.#ll=void 0,await this.sheet.maximize();const t=Application.RENDER_STATES;return(e.force||[t.RENDERED,t.ERROR].includes(this._state))&&(this.#Ke=null,this.#dl()),super.close(e)}activateListeners(e){super.activateListeners(e),this.#al||=this.#Na.bind(this),document.addEventListener("keydown",this.#al),this.#ll||=this.#ul.bind(this),document.addEventListener("wheel",this.#ll,{passive:!1}),e.find('button[name="reset"]').click(this.#hl.bind(this))}#Na(e){const t=e.code,i=["KeyW","ArrowUp"],n=["KeyS","ArrowDown"],s=["KeyA","ArrowLeft"],o=["KeyD","ArrowRight"];if(i.concat(n).concat(s).concat(o).includes(t))if(e.shiftKey){e.preventDefault(),e.stopPropagation();const s=i.includes(t)?1:n.includes(t)?-1:0;this.#pl(s)}else if(e.altKey){e.preventDefault(),e.stopPropagation();const s=i.includes(t)?1:n.includes(t)?-1:0;this.#gl(s)}else c.keyboard.hasFocus||(e.preventDefault(),e.stopPropagation(),i.includes(t)?this.#ml({deltaY:-1}):n.includes(t)?this.#ml({deltaY:1}):s.includes(t)?this.#ml({deltaX:-1}):o.includes(t)&&this.#ml({deltaX:1}))}#ul(e){if(0===e.deltaY)return;const t=-Math.sign(e.deltaY),i=document.activeElement,n=!(e.shiftKey||e.altKey),s=c.keyboard.hasFocus&&document.hasFocus;e.shiftKey||!e.altKey&&s&&"scale"===i.name?(e.preventDefault(),e.stopImmediatePropagation(),this.#pl(t)):e.altKey||s&&"grid.size"===i.name?(e.preventDefault(),e.stopImmediatePropagation(),this.#gl(t)):n&&s&&("background.offsetX"===i.name?(e.preventDefault(),e.stopImmediatePropagation(),this.#ml({deltaX:t})):"background.offsetY"===i.name&&(e.preventDefault(),e.stopImmediatePropagation(),this.#ml({deltaY:t})))}#hl(){this.#Ke&&(this.#Ke=this.object.clone(),this.render())}async _onChangeInput(e){await super._onChangeInput(e);const t=this._getSubmitData();this.#fl(t)}async _updateObject(e,t){const i=foundry.utils.flattenObject(foundry.utils.diffObject(this.object.toObject(),foundry.utils.expandObject(t)));if(["width","height","padding","background.offsetX","background.offsetY","grid.size","grid.type"].some((e=>e in i))){if(await Dialog.confirm({title:c.i18n.localize("SCENES.DimensionChangeTitle"),content:`<p>${c.i18n.localize("SCENES.DimensionChangeWarning")}</p>`}))return this.object.update(t,{fromSheet:!0})}}async#cl(){if(!this.#Ke)return;this.#Wn&&this.#dl(),this.#Wn=canvas.stage.addChild(new PIXI.Container),this.#Wn.eventMode="none";const e=this.#Wn.addChild(new PIXI.Sprite(PIXI.Texture.WHITE));if(e.tint=0,e.eventMode="static",e.hitArea=canvas.app.screen,e.updateTransform=function(){const e=canvas.app.screen;this.width=e.width,this.height=e.height,this._boundsID++,this.transform.updateTransform(PIXI.Transform.IDENTITY),this.worldAlpha=this.alpha},this.#on=this.#Wn.addChild(new PIXI.Sprite),this.#on.eventMode="none",this.#Ke.background.src)try{this.#on.texture=await loadTexture(this.#Ke.background.src)}catch(e){this.#on.texture=PIXI.Texture.WHITE,console.error(e)}else this.#on.texture=PIXI.Texture.WHITE;this.#es=this.#Wn.addChild((new GridMesh).initialize({color:16711680})),this.#Xn()}#fl(e){this.#Ke&&(e&&this.#Ke.updateSource(e),this.#Xn())}#Xn(){if(!this.#Ke||!1!==this.#Wn?.destroyed)return;const e=this.#Ke.dimensions;this.#on.position.set(e.sceneX,e.sceneY),this.#on.width=e.sceneWidth,this.#on.height=e.sceneHeight,this.#es.initialize({type:this.#Ke.grid.type,width:e.width,height:e.height,size:e.size})}#dl(){!1===this.#Wn?.destroyed&&this.#Wn.destroy({children:!0}),this.#Wn=null,this.#on=null,this.#es=null}#pl(e){const t=(parseFloat(this.form.scale.value)+.001*e).toNearest(.001);this.form.scale.value=Math.clamp(t,.25,10),this.form.scale.dispatchEvent(new Event("change",{bubbles:!0}))}#gl(e){const t=this.form.elements["grid.size"];t.value=Math.clamp(t.valueAsNumber+e,50,300),t.dispatchEvent(new Event("change",{bubbles:!0}))}#ml({deltaX:e=0,deltaY:t=0}){const i=this.form["background.offsetX"];i.value=parseInt(this.form["background.offsetX"].value)+e,this.form["background.offsetY"].value=parseInt(this.form["background.offsetY"].value)+t,i.dispatchEvent(new Event("change",{bubbles:!0}))}}class ImagePopout extends FormApplication{#vl;get isVideo(){return VideoHelper.hasVideoExtension(this.object)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"templates/apps/image-popout.html",classes:["image-popout","dark"],resizable:!0,caption:void 0,uuid:null})}get title(){return this.isTitleVisible()?super.title:""}async getData(e={}){return{image:this.object,options:this.options,title:this.title,caption:this.options.caption,showTitle:this.isTitleVisible(),isVideo:this.isVideo}}isTitleVisible(){return this.options.showTitle??this.#vl?.testUserPermission(c.user,"LIMITED")??!0}async getRelatedObject(){return this.options.uuid&&!this.#vl&&(this.#vl=await fromUuid(this.options.uuid)),this.#vl}async _render(...e){return await this.getRelatedObject(),this.position=await this.constructor.getPosition(this.object),super._render(...e)}activateListeners(e){super.activateListeners(e),this.isVideo&&e.find("video")[0]?.play()}_getHeaderButtons(){const e=super._getHeaderButtons();return c.user.isGM&&e.unshift({label:"JOURNAL.ActionShow",class:"share-image",icon:"fas fa-eye",onclick:()=>this.shareImage()}),e}static async getPosition(e){if(!e)return{width:480,height:480};let t,i;try{[t,i]=this.isVideo?await this.getVideoSize(e):await this.getImageSize(e)}catch(e){return{width:480,height:480}}const n={},s=t/i;return s>window.innerWidth/window.innerHeight?(n.width=Math.min(2*t,window.innerWidth-80),n.height=n.width/s):(n.height=Math.min(2*i,window.innerHeight-120),n.width=n.height*s),n}static getImageSize(e){return new Promise(((t,i)=>{const n=new Image;n.onload=function(){t([this.width,this.height])},n.onerror=i,n.src=e}))}static getVideoSize(e){return new Promise(((t,i)=>{const n=document.createElement("video");n.onloadedmetadata=()=>{n.onloadedmetadata=null,t([n.videoWidth,n.videoHeight])},n.onerror=i,n.src=e}))}shareImage(e={}){e=foundry.utils.mergeObject(this.options,e,{inplace:!1}),c.socket.emit("shareImage",{image:this.object,title:e.title,caption:e.caption,uuid:e.uuid,showTitle:e.showTitle,users:Array.isArray(e.users)?e.users:void 0}),ui.notifications.info(c.i18n.format("JOURNAL.ActionShowSuccess",{mode:"image",title:e.title,which:"all"}))}static _handleShareImage({image:e,title:t,caption:i,uuid:n,showTitle:s}={}){const o=new ImagePopout(e,{title:t,caption:i,uuid:n,showTitle:s});return o.render(!0),o}}class ItemSheet extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"templates/sheets/item-sheet.html",width:500,closeOnSubmit:!1,submitOnClose:!0,submitOnChange:!0,resizable:!0,baseApplication:"ItemSheet",id:"item",secrets:[{parentSelector:".editor"}]})}get title(){return this.item.name}get item(){return this.object}get actor(){return this.item.actor}getData(e={}){const t=super.getData(e);return t.item=t.document,t}}class JournalPageSheet extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","journal-sheet","journal-entry-page"],viewClasses:[],width:600,height:680,resizable:!0,closeOnSubmit:!1,submitOnClose:!0,viewPermission:CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER,includeTOC:!0})}get template(){return`templates/journal/page-${this.document.type}-${this.isEditable?"edit":"view"}.html`}get title(){return this.object.permission?this.object.name:""}toc={};getData(e={}){return foundry.utils.mergeObject(super.getData(e),{headingLevels:Object.fromEntries(Array.fromRange(3,1).map((e=>[e,c.i18n.format("JOURNALENTRYPAGE.Level",{level:e})])))})}async _renderInner(...e){await loadTemplates({journalEntryPageHeader:"templates/journal/parts/page-header.html",journalEntryPageFooter:"templates/journal/parts/page-footer.html"});const t=await super._renderInner(...e);return this.options.includeTOC&&(this.toc=JournalEntryPage.implementation.buildTOC(t.get())),t}_closeView(){}_getSecretContent(e){return this.object.text.content}_updateSecret(e,t){return this.object.update({"text.content":t})}async activateEditor(e,t={},i=""){t.fitToSize=!0,t.relativeLinks=!0;const n=await super.activateEditor(e,t,i);return this.form.querySelector('[role="application"]')?.style.removeProperty("height"),n}onAutosave(e){this.object.parent?.sheet?.render(!1)}onNewSteps(){this.form.querySelectorAll('[data-action="save-html"]').forEach((e=>e.disabled=!0))}}class JournalTextPageSheet extends JournalPageSheet{static _converter=(()=>(Object.entries(CONST.SHOWDOWN_OPTIONS).forEach((([e,t])=>showdown.setOption(e,t))),new showdown.Converter))();static get format(){return CONST.JOURNAL_ENTRY_PAGE_FORMATS.HTML}static get defaultOptions(){const e=super.defaultOptions;return e.classes.push("text"),e.secrets.push({parentSelector:"section.journal-page-content"}),e}async getData(e={}){const t=super.getData(e);return this._convertFormats(t),t.editor={engine:"prosemirror",collaborate:!0,content:await TextEditor$1.enrichHTML(t.document.text.content,{relativeTo:this.object,secrets:this.object.isOwner})},t}async close(e={}){return Object.values(this.editors).forEach((e=>{e.instance&&e.instance.destroy()})),super.close(e)}async _render(e,t){return this.#yl(t.resync)?super._render(e,t):this.maximize().then((()=>this.bringToTop()))}#yl(e){return!(!e&&this._state===Application.RENDER_STATES.RENDERED&&this.isEditable)||!this.isEditorDirty()}isEditorDirty(){for(const e of Object.values(this.editors))if(e.active&&e.instance?.isDirty())return!0;return!1}async _updateObject(e,t){return this.constructor.format===CONST.JOURNAL_ENTRY_PAGE_FORMATS.HTML&&this.isEditorDirty()&&(t["text.markdown"]="",t["text.format"]=CONST.JOURNAL_ENTRY_PAGE_FORMATS.HTML),super._updateObject(e,t)}async saveEditor(e,{preventRender:t=!0,...i}={}){return super.saveEditor(e,{...i,preventRender:t})}_convertFormats(e){const t=CONST.JOURNAL_ENTRY_PAGE_FORMATS,i=this.object.text;this.constructor.format===t.MARKDOWN&&i.content?.length&&!i.markdown?.length&&(e.data.text.markdown=this.constructor._converter.makeMarkdown(i.content.trim()))}}class JournalImagePageSheet extends JournalPageSheet{static get defaultOptions(){const e=super.defaultOptions;return e.classes.push("image"),e.height="auto",e}}class JournalVideoPageSheet extends JournalPageSheet{static get defaultOptions(){const e=super.defaultOptions;return e.classes.push("video"),e.height="auto",e}getData(e={}){return foundry.utils.mergeObject(super.getData(e),{flexRatio:!this.object.video.width&&!this.object.video.height,isYouTube:c.video.isYouTubeURL(this.object.src),timestamp:this._timestampToTimeComponents(this.object.video.timestamp),yt:{id:`youtube-${foundry.utils.randomID()}`,url:c.video.getYouTubeEmbedURL(this.object.src,this._getYouTubeVars())}})}activateListeners(e){if(super.activateListeners(e),this.isEditable)return;const t=e.find("iframe")[0];t&&c.video.getYouTubePlayer(t.id,{events:{onStateChange:e=>{e.data===YT.PlayerState.PLAYING&&e.target.setVolume(100*this.object.video.volume)}}}).then((e=>{this.object.video.timestamp&&e.seekTo(this.object.video.timestamp,!0)}));const i=e.parent().find("video")[0];i&&i.addEventListener("loadedmetadata",(()=>{i.volume=this.object.video.volume,this.object.video.timestamp&&(i.currentTime=this.object.video.timestamp)}))}_getYouTubeVars(){const e={playsinline:1,modestbranding:1};return this.isEditable||(e.controls=this.object.video.controls?1:0,e.autoplay=this.object.video.autoplay?1:0,e.loop=this.object.video.loop?1:0,this.object.video.timestamp&&(e.start=this.object.video.timestamp)),e}_getSubmitData(e={}){const t=super._getSubmitData(e);return t["video.timestamp"]=this._timeComponentsToTimestamp(foundry.utils.expandObject(t).timestamp),["h","m","s"].forEach((e=>delete t[`timestamp.${e}`])),t}_timeComponentsToTimestamp({h:e=0,m:t=0,s:i=0}={}){return 3600*e+60*t+i}_timestampToTimeComponents(e){if(!e)return{};const t={},i=Math.floor(e/3600);i&&(t.h=i);const n=Math.floor(e%3600/60);return n&&(t.m=n),t.s=e-3600*i-60*n,t}}class JournalPDFPageSheet extends JournalPageSheet{static get defaultOptions(){const e=super.defaultOptions;return e.classes.push("pdf"),e.height="auto",e}static _sizes={};activateListeners(e){super.activateListeners(e),e.find("> button").on("click",this._onLoadPDF.bind(this))}getData(e={}){return foundry.utils.mergeObject(super.getData(e),{params:this._getViewerParams()})}async _renderInner(...e){const t=await super._renderInner(...e),i=t.closest(".load-pdf")[0];if(this.isEditable||!i)return t;let n=this.constructor._sizes[this.object.src];if(void 0===n){const e=await fetch(this.object.src,{method:"HEAD"}).catch((()=>{}));this.constructor._sizes[this.object.src]=n=Number(e?.headers.get("content-length"))}if(!isNaN(n)){const e=(n/1024/1024).toFixed(2),t=document.createElement("span");t.classList.add("hint"),t.textContent=` (${e} MB)`,i.querySelector("button").appendChild(t)}return t}_onLoadPDF(e){const t=e.currentTarget.parentElement,i=document.createElement("iframe");i.src=`scripts/pdfjs/web/viewer.html?${this._getViewerParams()}`,t.replaceWith(i)}_getViewerParams(){const e=new URLSearchParams;if(this.object.src){const t=URL.parseSafe(this.object.src)?this.object.src:foundry.utils.getRoute(this.object.src);e.append("file",t)}return e}}class MarkdownJournalPageSheet extends JournalTextPageSheet{_isDirty=!1;static get format(){return CONST.JOURNAL_ENTRY_PAGE_FORMATS.MARKDOWN}static get defaultOptions(){const e=super.defaultOptions;return e.dragDrop=[{dropSelector:"textarea"}],e.classes.push("markdown"),e}get template(){return this.isEditable?"templates/journal/page-markdown-edit.html":super.template}async getData(e={}){const t=await super.getData(e);return t.markdownFormat=CONST.JOURNAL_ENTRY_PAGE_FORMATS.MARKDOWN,t}activateListeners(e){super.activateListeners(e),e.find("textarea").on("keypress paste",(()=>this._isDirty=!0))}isEditorDirty(){return this._isDirty}async _updateObject(e,t){return this.isEditorDirty()||(delete t["text.markdown"],delete t["text.format"]),super._updateObject(e,t)}_onDrop(e){e.preventDefault();const t=TextEditor$1.getDragEventData(e);return this._onDropContentLink(t)}async _onDropContentLink(e){const t=await TextEditor$1.getContentLink(e,{relativeTo:this.object});if(!t)return;const i=this.form.elements["text.markdown"],n=i.value;i.value=n.substring(0,i.selectionStart)+t+n.substring(i.selectionStart),this._isDirty=!0}}class JournalTextTinyMCESheet extends JournalTextPageSheet{async getData(e={}){const t=await super.getData(e);return t.editor.engine="tinymce",t.editor.collaborate=!1,t}async close(e={}){return JournalPageSheet.prototype.close.call(this,e)}async _render(e,t){return JournalPageSheet.prototype._render.call(this,e,t)}}class JournalSheet extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","journal-sheet","journal-entry"],template:"templates/journal/sheet.html",width:960,height:800,resizable:!0,submitOnChange:!0,submitOnClose:!0,closeOnSubmit:!1,viewPermission:CONST.DOCUMENT_OWNERSHIP_LEVELS.NONE,scrollY:[".scrollable"],filters:[{inputSelector:'input[name="search"]',contentSelector:".directory-list"}],dragDrop:[{dragSelector:".directory-item, .heading-link",dropSelector:".directory-list"}],pageIndex:void 0,pageId:void 0})}_pages;#bl=new Set;#Sl=[];#Tl=0;#El=!1;#Cl={};#_l=!1;#Il={collapsed:!1};#wl;#Dl=new Map;#Ol=null;get mode(){return this.#Ol??this.document.getFlag("core","viewMode")??this.constructor.VIEW_MODES.SINGLE}get searchMode(){return this.document.getFlag("core","searchMode")||CONST.DIRECTORY_SEARCH_MODES.NAME}toggleSearchMode(){const e=this.document.getFlag("core","searchMode")===CONST.DIRECTORY_SEARCH_MODES.NAME?CONST.DIRECTORY_SEARCH_MODES.FULL:CONST.DIRECTORY_SEARCH_MODES.NAME;this.document.setFlag("core","searchMode",e)}get pagesInView(){return this.#Sl}get pageIndex(){return this.#Tl}get observer(){return this.#wl}get sidebarCollapsed(){return this.#Il.collapsed}static VIEW_MODES={SINGLE:1,MULTIPLE:2};static INTERSECTION_RATIO=.25;static OWNERSHIP_ICONS={[CONST.DOCUMENT_OWNERSHIP_LEVELS.NONE]:"fa-solid fa-eye-slash",[CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER]:"fa-solid fa-eye",[CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER]:"fa-solid fa-feather-pointed"};get title(){const e=c.folders.get(this.object.folder?.id),t=`${e?`${e.name}: `:""}${this.object.name}`;return this.object.permission?t:""}_getHeaderButtons(){const e=super._getHeaderButtons();return c.user.isGM&&e.unshift({label:"JOURNAL.ActionShow",class:"share-image",icon:"fas fa-eye",onclick:e=>this._onShowPlayers(e)}),e}getData(e={}){const t=super.getData(e);return t.mode=this.mode,t.toc=this._pages=this._getPageData(),this._getCurrentPage(e),t.viewMode={},this.mode===this.constructor.VIEW_MODES.SINGLE?(t.pages=[t.toc[this.pageIndex]],t.viewMode={label:"JOURNAL.ViewMultiple",icon:"fa-solid fa-note",cls:"single-page"}):(t.pages=t.toc,t.viewMode={label:"JOURNAL.ViewSingle",icon:"fa-solid fa-notes",cls:"multi-page"}),t.sidebarClass=this.sidebarCollapsed?"collapsed":"",t.collapseMode=this.sidebarCollapsed?{label:"JOURNAL.ViewExpand",icon:"fa-solid fa-caret-left"}:{label:"JOURNAL.ViewCollapse",icon:"fa-solid fa-caret-right"},t.searchIcon=this.searchMode===CONST.DIRECTORY_SEARCH_MODES.NAME?"fa-search":"fa-file-magnifying-glass",t.searchTooltip=this.searchMode===CONST.DIRECTORY_SEARCH_MODES.NAME?"SIDEBAR.SearchModeName":"SIDEBAR.SearchModeFull",t}_getPageData(){const e=!!this._searchFilters[0].query;return this.object.pages.contents.sort(((e,t)=>e.sort-t.sort)).reduce(((t,i)=>{if(!this.isPageVisible(i))return t;const n=i.toObject(),s=this.getPageSheet(i.id),o=[n.type,`level${n.title.level}`];e&&!this.#bl.has(i.id)&&o.push("hidden"),n.tocClass=n.cssClass=o.join(" "),o.push(...s.options.viewClasses||[]),n.viewClass=o.join(" "),n.editable=i.isOwner,i.parent.pack&&(n.editable&&=!c.packs.get(i.parent.pack)?.locked),n.number=t.length,n.icon=this.constructor.OWNERSHIP_ICONS[i.ownership.default];const r=Object.entries(CONST.DOCUMENT_OWNERSHIP_LEVELS),[a]=r.find((([,e])=>e===i.ownership.default));return n.ownershipCls=a.toLowerCase(),t.push(n),t}),[])}_getCurrentPage({pageIndex:e,pageId:t}={}){let i;return"number"==typeof e&&(i=e),t&&(i=this._pages.findIndex((e=>e._id===t))),null!=i&&i!==this.pageIndex&&(this.mode===this.constructor.VIEW_MODES.SINGLE&&this.#xl(this.pageIndex),this.#Tl=i),this.options.pageIndex=this.options.pageId=void 0,this.#Tl=Math.clamp(this.pageIndex,0,this._pages.length-1)}activateListeners(e){super.activateListeners(e),e.on("click","img:not(.nopopout)",this._onClickImage.bind(this)),e.find("button[data-action], a[data-action]").click(this._onAction.bind(this)),this._contextMenu(e)}_activatePageListeners(){const e=this.element;e.find(".editor-edit").click(this._onEditPage.bind(this)),e.find(".page-heading").click(this._onClickPageLink.bind(this))}async _render(e,t={}){"tempOwnership"in t&&(this.#El=t.tempOwnership);const i="mode"in t&&t.mode!==this.mode;if(i&&(this.mode===this.constructor.VIEW_MODES.MULTIPLE&&this.#xl(),this.#Ol=t.mode),"collapsed"in t&&(this.#Il.collapsed=t.collapsed),await super._render(e,t),!this.rendered)return;await this._renderPageViews(),this._activatePageListeners();if(i||("pageIndex"in t||"pageId"in t)){const e=this._pages[this.pageIndex]?._id;this.mode===this.constructor.VIEW_MODES.MULTIPLE?this.goToPage(e,t.anchor):t.anchor&&(this.getPageSheet(e)?.toc[t.anchor]?.element?.scrollIntoView(),this.#_l=!0)}else this._restoreScrollPositions(this.element)}async _renderPageViews(){for(const e of this.element[0].querySelectorAll(".journal-entry-page")){const t=e.dataset.pageId;if(!t)continue;const i=e.querySelector(":scope > .edit-container"),n=this.getPageSheet(t),s=await n.getData(),o=await n._renderInner(s);e.replaceChildren(...o.get()),i&&e.appendChild(i),n._activateCoreListeners(o.parent()),n.activateListeners(o),await this._renderHeadings(e,n.toc),n._callHooks("render",o,s)}this._observePages(),this._observeHeadings()}#xl(e){if(!this._pages?.length||e<0)return;const t=null!=e?[this._pages[e]]:this._pages;for(const e of t){const t=this.getPageSheet(e._id);t._callHooks("close",t.element),t._closeView()}}async _renderHeadings(e,t){const i=e.dataset.pageId,n=this.object.pages.get(i),s=this.element[0].querySelector(`.directory-item[data-page-id="${i}"]`);if(!s||!t)return;const o=Object.values(t);o.sort(((e,t)=>e.order-t.order)),n.title.show&&o.shift();const r=Math.min(...o.map((e=>e.level)));s.querySelector(":scope > ol")?.remove();const a=await renderTemplate("templates/journal/journal-page-toc.html",{headings:o.reduce(((e,{text:t,level:i,slug:n,element:s})=>(s&&(s.dataset.anchor=n),i<r+2&&e.push({text:t,slug:n,level:i-r+2}),e)),[])});s.innerHTML+=a,s.querySelectorAll(".heading-link").forEach((e=>e.addEventListener("click",this._onClickPageLink.bind(this)))),this._dragDrop.forEach((e=>e.bind(s)))}_observePages(){this.#Sl=[],this.#wl=new IntersectionObserver(((e,t)=>{this._onPageScroll(e,t),this._activatePagesInView(),this._updateButtonState()}),{root:this.element.find(".journal-entry-pages .scrollable")[0],threshold:[0,.25,.5,.75,1]}),this.element.find(".journal-entry-page").each(((e,t)=>this.#wl.observe(t)))}_observeHeadings(){const e=this.element[0];this.#Dl=new Map;const t=new IntersectionObserver((e=>e.forEach((e=>{e.isIntersecting?this.#Dl.set(e.target,e):this.#Dl.delete(e.target)}))),{root:e.querySelector(".journal-entry-pages .scrollable"),threshold:1}),i=Array.fromRange(6,1).map((e=>`h${e}`)).join(",");e.querySelectorAll(`.journal-entry-page :is(${i})`).forEach((e=>t.observe(e)))}async close(e={}){return this.#El&&(this.object.ownership=foundry.utils.deepClone(this.object._source.ownership),this.object.pages.forEach((e=>e.ownership=foundry.utils.deepClone(e._source.ownership))),this.#El=!1),super.close(e)}_onAction(e){e.preventDefault();switch(e.currentTarget.dataset.action){case"previous":return this.previousPage();case"next":return this.nextPage();case"createPage":return this.createPage();case"toggleView":const t=this.constructor.VIEW_MODES,i=this.mode===t.SINGLE?t.MULTIPLE:t.SINGLE;return this.#Ol=i,this.render(!0,{mode:i});case"toggleCollapse":return this.toggleSidebar(e);case"toggleSearch":return this.toggleSearchMode(),this.render()}}createPage(){const e=this.element[0].getBoundingClientRect(),t={parent:this.object,width:320,top:e.bottom-200,left:e.left+10},i=(this._pages.at(-1)?.sort??0)+CONST.SORT_INTEGER_DENSITY;return JournalEntryPage.implementation.createDialog({sort:i},t)}previousPage(){if(this.mode===this.constructor.VIEW_MODES.SINGLE)return this.render(!0,{pageIndex:this.pageIndex-1});this.pagesInView[0]?.previousElementSibling?.scrollIntoView()}nextPage(){if(this.mode===this.constructor.VIEW_MODES.SINGLE)return this.render(!0,{pageIndex:this.pageIndex+1});this.pagesInView.length?this.pagesInView.at(-1).nextElementSibling?.scrollIntoView():this.element[0].querySelector(".journal-entry-page")?.scrollIntoView()}goToPage(e,t){if(this.mode===this.constructor.VIEW_MODES.SINGLE){const i=this._pages[this.pageIndex]?._id;if(i!==e)return this.render(!0,{pageId:e,anchor:t})}const i=this.element[0].querySelector(`.journal-entry-page[data-page-id="${e}"]`);if(t){const i=this.getPageSheet(e)?.toc[t]?.element;if(i)return void i.scrollIntoView()}i?.scrollIntoView()}getPageSheet(e){const t=this.object.pages.get(e),i=t._getSheetClass();let n=this.#Cl[e];return n?.constructor!==i&&(n=new i(t,{editable:!1}),this.#Cl[e]=n),n}isPageVisible(e){return this.getPageSheet(e.id)._canUserView(c.user)}toggleSidebar(){const e=this.element[0],t=e.querySelector(".sidebar"),i=t.querySelector(".collapse-toggle");this.#Il.collapsed=!this.sidebarCollapsed,e.style.pointerEvents="none",e.classList.add("collapsing"),e.addEventListener("transitionend",(()=>{e.style.pointerEvents="",e.classList.remove("collapsing")}),{once:!0});const n=getComputedStyle(t),s=Number(n.getPropertyValue("--sidebar-width-expanded").trim().replace("px",""))-Number(n.getPropertyValue("--sidebar-width-collapsed").trim().replace("px",""));this.setPosition({left:this.position.left+(this.sidebarCollapsed?s:-s),width:this.position.width+(this.sidebarCollapsed?-s:s)}),t.classList.toggle("collapsed",this.sidebarCollapsed),i.dataset.tooltip=this.sidebarCollapsed?"JOURNAL.ViewExpand":"JOURNAL.ViewCollapse";i.children[0].setAttribute("class","fa-solid "+(this.sidebarCollapsed?"fa-caret-left":"fa-caret-right")),c.tooltip.deactivate()}_updateButtonState(){if(!this.element?.length)return;const e=this.element[0].querySelector('[data-action="previous"]'),t=this.element[0].querySelector('[data-action="next"]');t&&e&&(this.mode===this.constructor.VIEW_MODES.SINGLE?(e.disabled=this.pageIndex<1,t.disabled=this.pageIndex>=this._pages.length-1):(e.disabled=!this.pagesInView[0]?.previousElementSibling,t.disabled=this.pagesInView.length&&!this.pagesInView.at(-1).nextElementSibling))}_onEditPage(e){e.preventDefault();const t=e.currentTarget.closest("[data-page-id]").dataset.pageId,i=this.object.pages.get(t);return i?.sheet.render(!0)}_onClickPageLink(e){const t=e.currentTarget,i=t.closest("[data-page-id]").dataset.pageId,n=t.closest("[data-anchor]")?.dataset.anchor;this.goToPage(i,n)}_onClickImage(e){const t=e.currentTarget,i=t.closest(".journal-entry-page.image"),n=this.object.pages.get(i?.dataset.pageId),s=n?.name??t.title,o=new ImagePopout(t.getAttribute("src"),{title:s,caption:n?.image.caption});n&&(o.shareImage=()=>Journal.showDialog(n)),o.render(!0)}_onPageScroll(e,t){if(!e.length)return;if(t!==this.observer)return;if(this.mode===this.constructor.VIEW_MODES.SINGLE){const t=e[0];return void(t.isIntersecting&&(this.#Sl=[t.target]))}const i=this.constructor.INTERSECTION_RATIO,n=e.filter((e=>e.isIntersecting&&e.intersectionRatio>=i)).sort(((e,t)=>e.intersectionRect.y-t.intersectionRect.y));if(!n.length){const t=e.find((e=>e.isIntersecting));t&&n.push(t)}if(!this.pagesInView.length)return void(this.#Sl=n.map((e=>e.target)));const s=new Map(e.map((e=>[e.target,e]))),o=[...this.pagesInView];for(const e of this.pagesInView){const t=s.get(e);t&&t.intersectionRatio<i&&o.findSplice((t=>t===e))}for(const e of n)o.includes(e.target)||o.push(e.target);this.#Sl=o.sort(((e,t)=>{const i=this.object.pages.get(e.dataset.pageId),n=this.object.pages.get(t.dataset.pageId);return i.sort-n.sort}))}_activatePagesInView(){if(this.pagesInView.length){const e=this.pagesInView[0].dataset.pageId;this.#Tl=this._pages.findIndex((t=>t._id===e))}let e=!1;const t=new Set(this.pagesInView.map((e=>e.dataset.pageId)));this.element.find(".directory-item").each(((i,n)=>{e||=n.classList.contains("active")!==t.has(n.dataset.pageId),n.classList.toggle("active",t.has(n.dataset.pageId))})),e&&this._synchronizeSidebar()}_synchronizeSidebar(){const e=Array.from(this.#Dl.values()).sort(((e,t)=>e.intersectionRect.y-t.intersectionRect.y));for(const t of e){const e=t.target.closest("[data-page-id]")?.dataset.pageId,i=t.target.dataset.anchor;let n=this.element[0].querySelector(`.directory-item[data-page-id="${e}"]`);if(i&&(n=n.querySelector(`li[data-anchor="${i}"]`)),n){n.scrollIntoView();break}}}_contextMenu(e){ContextMenu.create(this,e,".directory-item",this._getEntryContextOptions(),{onOpen:this._onContextMenuOpen.bind(this),onClose:this._onContextMenuClose.bind(this)})}_onContextMenuOpen(e){this.#Il={position:this.element.find(".directory-list.scrollable").scrollTop(),active:e.classList.contains("active")},e.classList.remove("active")}_onContextMenuClose(e){this.#Il.active&&e.classList.add("active"),this.element.find(".directory-list.scrollable").scrollTop(this.#Il.position)}_getEntryContextOptions(){const getPage=e=>this.object.pages.get(e.data("page-id"));return[{name:"SIDEBAR.Edit",icon:'<i class="fas fa-edit"></i>',condition:e=>this.isEditable&&getPage(e)?.canUserModify(c.user,"update"),callback:e=>getPage(e)?.sheet.render(!0)},{name:"SIDEBAR.Delete",icon:'<i class="fas fa-trash"></i>',condition:e=>this.isEditable&&getPage(e)?.canUserModify(c.user,"delete"),callback:e=>{const t=e[0].getBoundingClientRect();return getPage(e)?.deleteDialog({top:t.top,left:t.right})}},{name:"SIDEBAR.Duplicate",icon:'<i class="far fa-copy"></i>',condition:this.isEditable,callback:e=>{const t=getPage(e);return t.clone({name:c.i18n.format("DOCUMENT.CopyOf",{name:t.name})},{save:!0,addSource:!0})}},{name:"OWNERSHIP.Configure",icon:'<i class="fas fa-lock"></i>',condition:()=>c.user.isGM,callback:e=>{const t=getPage(e),i=e[0].getBoundingClientRect();new DocumentOwnershipConfig(t,{top:i.top,left:i.right}).render(!0)}},{name:"JOURNAL.ActionShow",icon:'<i class="fas fa-eye"></i>',condition:e=>getPage(e)?.isOwner,callback:e=>{const t=getPage(e);if(t)return Journal.showDialog(t)}},{name:"SIDEBAR.JumpPin",icon:'<i class="fa-solid fa-crosshairs"></i>',condition:e=>{const t=getPage(e);return!!t?.sceneNote},callback:e=>{const t=getPage(e);if(t?.sceneNote)return canvas.notes.panToNote(t.sceneNote)}}]}async _updateObject(e,t){return t.content&&(t.content=t.content.replace(/<\s*\/?\s*form(\s+[^>]*)?>/g,"")),super._updateObject(e,t)}async _onShowPlayers(e){return e.preventDefault(),await this.submit(),Journal.showDialog(this.object)}_canDragStart(e){return this.object.testUserPermission(c.user,"OBSERVER")}_canDragDrop(e){return this.isEditable}_onDragStart(e){ui.context&&ui.context.close({animate:!1});const t=e.currentTarget,i=t.closest("[data-page-id]").dataset.pageId,n=t.closest("[data-anchor]")?.dataset.anchor,s={...this.object.pages.get(i).toDragData(),anchor:{slug:n,name:t.innerText}};e.dataTransfer.setData("text/plain",JSON.stringify(s))}async _onDrop(e){const t=TextEditor$1.getDragEventData(e);if("JournalEntryPage"!==t.type)return;const i=await JournalEntryPage.implementation.fromDropData(t);if(!i)return;const n=e.target.closest("[data-page-id]"),s=n?this.object.pages.get(n?.dataset.pageId):null;if(i===s)return;if(i.parent===this.document)return i.sortRelative({sortKey:"sort",target:s,siblings:this.object.pages.filter((e=>e.id!==i.id))});const o=i.toObject();return this.object.pages.has(i.id)&&delete o._id,o.sort=s?s.sort:this.object.pages.reduce(((e,t)=>t.sort>e?t.sort:e),0),this.document.createEmbeddedDocuments("JournalEntryPage",[o],{keepId:!0})}_onSearchFilter(e,t,i,n){this.#bl.clear();const s=this.searchMode===CONST.DIRECTORY_SEARCH_MODES.NAME;let o=[];s||(o=this.object.pages.search({query:t}));for(const e of n.querySelectorAll(".directory-item")){const n=this.object.pages.get(e.dataset.pageId);let r=!t;!r&&s?r=i.test(SearchFilter.cleanQuery(n.name)):r||(r=!!o.find((e=>e._id===n._id))),r&&this.#bl.add(n._id),e.classList.toggle("hidden",!r)}if(this.#_l&&this._scrollPositions){this.#_l=!1;const e=this._scrollPositions[this.options.scrollY[0]]?.[0],t=this.element[0].querySelector(".pages-list .scrollable");e&&t&&(t.scrollTop=e)}}}class MacroConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","macro-sheet"],template:"templates/sheets/macro-config.html",width:560,height:480,resizable:!0})}_hotbarSlot;getData(e={}){const t=super.getData();return t.macroTypes=c.documentTypes.Macro.map((e=>({value:e,label:c.i18n.localize(g.Macro.typeLabels[e]),disabled:"script"===e&&!c.user.can("MACRO_SCRIPT")}))),t.macroScopes=CONST.MACRO_SCOPES.map((e=>({value:e,label:e}))),t}activateListeners(e){super.activateListeners(e),e.find("button.execute").click(this.#Nl.bind(this)),e.find('select[name="type"]').change(this.#Al.bind(this)),this.#Al()}_disableFields(e){super._disableFields(e),this.object.canExecute&&(e.querySelector("button.execute").disabled=!1)}#Al(){const e=this.element[0].querySelector('select[name="type"]').value;this.element[0].querySelector('textarea[name="command"]').disabled="script"===e&&!c.user.can("MACRO_SCRIPT")}async#Nl(e){e.preventDefault(),await this._updateObject(e,this._getSubmitData()),this.object.execute()}async _updateObject(e,t){const i=foundry.utils.expandObject(t);try{if(this.object.id)return this.object.updateSource(i,{dryRun:!0,fallback:!1}),await super._updateObject(e,t);{const e=await Macro.implementation.create(new Macro.implementation(i));if(!e)throw new Error("Failed to create Macro");this.object=e,await c.user.assignHotbarMacro(e,this._hotbarSlot)}}catch(e){throw Hooks$1.onError("MacroConfig#_updateObject",e,{notify:"error"}),e}}}class MeasuredTemplateConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"template-config",classes:["sheet","template-sheet"],title:"TEMPLATE.MeasuredConfig",template:"templates/scene/template-config.html",width:400})}getData(){return foundry.utils.mergeObject(super.getData(),{templateTypes:g.MeasuredTemplate.types,gridUnits:this.document.parent.grid.units||c.i18n.localize("GridUnits"),userColor:c.user.color,submitText:"TEMPLATE.Submit"+(this.options.preview?"Create":"Update")})}async _updateObject(e,t){return this.object.id?(t.id=this.object.id,this.object.update(t)):this.object.constructor.create(t)}}class DocumentOwnershipConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"permission",template:"templates/apps/ownership.html",width:400})}static#Rl=!0;get title(){return`${c.i18n.localize("OWNERSHIP.Title")}: ${this.document.name}`}async getData(e={}){const t=this.document instanceof Folder,i=this.document.isEmbedded,n=this.document.ownership;if(!n&&!t)throw new Error(`The ${this.document.documentName} document does not contain ownership data`);const s=Object.entries(CONST.DOCUMENT_META_OWNERSHIP_LEVELS).map((([e,t])=>({level:t,label:c.i18n.localize(`OWNERSHIP.${e}`)})));t||s.pop();for(let[e,t]of Object.entries(CONST.DOCUMENT_OWNERSHIP_LEVELS))t<0&&!i||s.push({level:t,label:c.i18n.localize(`OWNERSHIP.${e}`)});const o=foundry.utils.deepClone(s);o.shift();const r=c.users.map((e=>({user:e,level:t?CONST.DOCUMENT_META_OWNERSHIP_LEVELS.NOCHANGE:n[e.id],isAuthor:this.document.author===e,cssClass:e.isGM?"gm":"",icon:e.isGM?"fa-solid fa-crown":"",tooltip:e.isGM?c.i18n.localize("USER.RoleGamemaster"):""}))).sort(((e,t)=>e.user.name.localeCompare(t.user.name,c.i18n.lang)));return{currentDefault:n?.default??CONST.DOCUMENT_META_OWNERSHIP_LEVELS.DEFAULT,instructions:c.i18n.localize(t?"OWNERSHIP.HintFolder":"OWNERSHIP.HintDocument"),defaultLevels:o,playerLevels:s,isFolder:t,showGM:!DocumentOwnershipConfig.#Rl,users:r}}activateListeners(e){super.activateListeners(e);e[0].querySelector("input#show-gm-toggle").addEventListener("change",(()=>this.#Pl())),this.#Pl(DocumentOwnershipConfig.#Rl)}async _updateObject(e,t){if(e.preventDefault(),!c.user.isGM)throw new Error("You do not have the ability to configure permissions.");const i=CONST.DOCUMENT_META_OWNERSHIP_LEVELS,n=this.document instanceof Folder?i.NOCHANGE:i.DEFAULT,s={};for(let[e,i]of Object.entries(t))i!==n?s[e]=i:delete s[e];if(this.document instanceof Folder){const e=getDocumentClass(this.document.type),t=this.document.contents.map((e=>{const t=foundry.utils.deepClone(e.ownership);for(let[e,n]of Object.entries(s))n===i.DEFAULT?delete t[e]:t[e]=n;return{_id:e.id,ownership:t}}));return e.updateDocuments(t,{diff:!1,recursive:!1,noHook:!0})}return this.document.update({ownership:s},{diff:!1,recursive:!1,noHook:!0})}#Pl(e){e??=!DocumentOwnershipConfig.#Rl,this.form.classList.toggle("no-gm",e),DocumentOwnershipConfig.#Rl=e,this.setPosition({height:"auto",width:this.options.width})}}class PlaylistConfig extends DocumentSheet{static get defaultOptions(){const e=super.defaultOptions;return e.id="playlist-config",e.template="templates/playlist/playlist-config.html",e.width=360,e}get title(){return`${c.i18n.localize("PLAYLIST.Edit")}: ${this.object.name}`}getData(e={}){const t=super.getData(e);return t.modes=Object.entries(CONST.PLAYLIST_MODES).reduce(((e,t)=>{const[i,n]=t;return e[n]=c.i18n.localize(`PLAYLIST.Mode${i.titleCase()}`),e}),{}),t.sorting=Object.entries(CONST.PLAYLIST_SORT_MODES).reduce(((e,[t,i])=>(e[i]=c.i18n.localize(`PLAYLIST.Sort${t.titleCase()}`),e)),{}),t.channels=CONST.AUDIO_CHANNELS,t}activateListeners(e){super.activateListeners(e),e.find("file-picker").on("change",this._onBulkImport.bind(this))}async _onBulkImport(e){const t=e.target;t.picker.type="audio";const i=await t.picker.browse(t.value);if(t.picker.type="folder",!i?.files?.length)return;const n=this.object,s=new Set(n.sounds.map((e=>e.path))),o=i.files.reduce(((e,t)=>{if(!AudioHelper.hasAudioExtension(t)||s.has(t))return e;const i={name:foundry.audio.AudioHelper.getDefaultSoundName(t),path:t};return e.push(i),e}),[]);if(o.length)return ui.playlists._expanded.add(n.id),n.createEmbeddedDocuments("PlaylistSound",o);{const e=c.i18n.format("PLAYLIST.BulkImportWarning",{path:filePicker.target});return ui.notifications.warn(e)}}}class PlaylistSoundConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"track-config",template:"templates/playlist/sound-config.html",width:360})}get title(){return this.object.id?`${c.i18n.localize("PLAYLIST.SoundEdit")}: ${this.object.name}`:`${c.i18n.localize("PLAYLIST.SoundCreate")}: ${this.object.parent.name}`}getData(e={}){const t=super.getData(e);return this.document.id||(t.data.name=""),t.lvolume=foundry.audio.AudioHelper.volumeToInput(this.document.volume),t.channels=CONST.AUDIO_CHANNELS,t}activateListeners(e){return super.activateListeners(e),e.find('input[name="path"]').change(this._onSourceChange.bind(this)),e}_onSourceChange(e){e.preventDefault();const t=e.target,i=t.form;i.name.value||(i.name.value=foundry.audio.AudioHelper.getDefaultSoundName(t.value))}async _updateObject(e,t){return t.volume=foundry.audio.AudioHelper.inputToVolume(t.lvolume),this.object.id?this.object.update(t):this.object.constructor.create(t,{parent:this.object.parent})}}class RollTableConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","roll-table-config"],template:"templates/sheets/roll-table-config.html",width:720,height:"auto",closeOnSubmit:!1,viewPermission:CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER,scrollY:["table.table-results tbody"],dragDrop:[{dragSelector:null,dropSelector:null}]})}get title(){return`${c.i18n.localize("TABLE.SheetTitle")}: ${this.document.name}`}async getData(e={}){const t=super.getData(e);t.descriptionHTML=await TextEditor$1.enrichHTML(this.object.description,{secrets:this.object.isOwner});const i=this.document.results.map((e=>((e=e.toObject(!1)).isText=e.type===CONST.TABLE_RESULT_TYPES.TEXT,e.isDocument=e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT,e.isCompendium=e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM,e.img=e.img||g.RollTable.resultIcon,e.text=TextEditor$1.decodeHTML(e.text),e)));return i.sort(((e,t)=>e.range[0]-t.range[0])),foundry.utils.mergeObject(t,{results:i,resultTypes:Object.entries(CONST.TABLE_RESULT_TYPES).reduce(((e,t)=>(e[t[1]]=c.i18n.localize(`TABLE.RESULT_TYPES.${t[0]}.label`),e)),{}),documentTypes:CONST.COMPENDIUM_DOCUMENT_TYPES.map((e=>({value:e,label:c.i18n.localize(getDocumentClass(e).metadata.label)}))),compendiumPacks:Array.from(c.packs.keys()).map((e=>({value:e,label:e})))})}activateListeners(e){if(super.activateListeners(e),!this.isEditable&&!this.document.formula)return;const t=e.find("button.roll");t.click(this._onRollTable.bind(this)),t[0].disabled=!1,this.isEditable&&(e.find("button.reset").click(this._onResetTable.bind(this)),e.find('input[type="checkbox"]').change(this._onSubmit.bind(this)),e.find("a.create-result").click(this._onCreateResult.bind(this)),e.find("a.delete-result").click(this._onDeleteResult.bind(this)),e.find("a.lock-result").click(this._onLockResult.bind(this)),e.find(".result-type select").change(this._onChangeResultType.bind(this)),e.find(".normalize-results").click(this._onNormalizeResults.bind(this)))}async _onCreateResult(e,t={}){e.preventDefault(),await this._onSubmit(e);const i=Array.from(this.document.results.values());let n=i[i.length-1],s=n&&n.weight||1,o=i.reduce(((e,t)=>e+t.weight),0)||1,r=i.length?Math.min(...i.map((e=>e.range[0]))):0,a=i.length?Math.max(...i.map((e=>e.range[1]))):0;const l=a-r+1,c=Math.round(l/o),d=[a+1,a+Math.max(1,s*c)];return t=foundry.utils.mergeObject({type:n?n.type:CONST.TABLE_RESULT_TYPES.TEXT,documentCollection:n?n.documentCollection:null,weight:s,range:d,drawn:!1},t),this.document.createEmbeddedDocuments("TableResult",[t])}_onChangeResultType(e){e.preventDefault();const t=CONST.TABLE_RESULT_TYPES,i=e.target,n=parseInt(i.value),s=i.name.replace(".type","");let o="";n===t.DOCUMENT?o="Actor":n===t.COMPENDIUM&&(o=c.packs.keys().next().value);const r={[s]:{documentCollection:o,documentId:null}};return this._onSubmit(e,{updateData:r})}async _onDeleteResult(e){e.preventDefault(),await this._onSubmit(e);const t=e.currentTarget.closest(".table-result");return this.object.results.get(t.dataset.resultId).delete()}async _onDrop(e){const t=TextEditor$1.getDragEventData(e);if(!1===Hooks$1.call("dropRollTableSheetData",this.document,this,t))return;if(!CONST.COMPENDIUM_DOCUMENT_TYPES.includes(t.type))return;const i=getDocumentClass(t.type),n=await i.fromDropData(t);if(!n||n.isEmbedded)return;const s=!!n.compendium;return this._onCreateResult(e,{type:s?CONST.TABLE_RESULT_TYPES.COMPENDIUM:CONST.TABLE_RESULT_TYPES.DOCUMENT,documentCollection:s?n.pack:n.documentName,text:n.name,documentId:n.id,img:n.img||null})}_onEditImage(e){const t=e.currentTarget,i="img"===t.dataset.edit;let n=this.document.img;if(!i){const e=t.closest(".table-result");n=this.document.results.get(e.dataset.resultId).img}return new FilePicker({type:"image",current:n,callback:i=>(t.src=i,this._onSubmit(e)),top:this.position.top+40,left:this.position.left+10}).browse()}async _onNormalizeResults(e){return e.preventDefault(),!(!this.rendered||this._submitting)&&(await this._onSubmit(e),this.document.normalize())}_onLockResult(e){e.preventDefault();const t=e.currentTarget.closest(".table-result"),i=this.document.results.get(t.dataset.resultId);return i.update({drawn:!i.drawn})}_onResetTable(e){return e.preventDefault(),this.document.resetResults()}async _onRollTable(e){e.preventDefault(),await this.submit({preventClose:!0,preventRender:!0}),e.currentTarget.disabled=!0;let t=await this.document.roll();const i=this.document.getResultsForRoll(t.roll.total);i.length&&(c.settings.get("core","animateRollTable")&&await this._animateRoll(i),await this.document.draw(t)),e.currentTarget.disabled=!1}async _updateObject(e,t){const i=foundry.utils.expandObject(t);i.results=i.hasOwnProperty("results")?Object.values(i.results):[];for(let e of i.results)switch(e.range=[e.rangeL,e.rangeH],e.type){case CONST.TABLE_RESULT_TYPES.DOCUMENT:const t=c.collections.get(e.documentCollection);if(!t)continue;const i=e.documentId?t.get(e.documentId):null;if(i&&i.name===e.text)continue;const n=t.find((t=>t.id===e.text||t.name===e.text))||null;e.documentId=n?.id??null,e.text=n?.name??null,e.img=n?.img??null,e.img=n?.thumb||n?.img||null;break;case CONST.TABLE_RESULT_TYPES.COMPENDIUM:const s=c.packs.get(e.documentCollection);if(s){const t=s.index.get(e.documentId)||null;if(t&&t.name===e.text)continue;const i=s.index.find((t=>t._id===e.text||t.name===e.text))||null;e.documentId=i?._id||null,e.text=i?.name||null,e.img=i?.thumb||i?.img||null}break;default:e.type=CONST.TABLE_RESULT_TYPES.TEXT,e.documentCollection=null,e.documentId=null}return this.document.update(i,{diff:!1,recursive:!1})}async _animateRoll(e){const t=this.element[0].querySelector(".table-results > tbody"),i=new Set(e.map((e=>e.id))),n=Array.from(t.children).filter((e=>i.has(e.dataset.resultId))),s=this.object.results.size;let o=50,r=Math.round(t.offsetHeight/(2*t.children[0].offsetHeight));const a=Math.min(Math.ceil(2e3/(o*s)),4);1===a&&(o=2e3/s),await this._animateRoulette(t,i,a,o,r);const l=n.map((e=>this._flashResult(e)));return Promise.all(l)}async _animateRoulette(e,t,i,n,s){let o=0,r=0,a=null;return new Promise((l=>{let c=setInterval((()=>{if(0===r&&o++,a&&a.classList.remove("roulette"),a=e.children[r],e.scrollTop=(r-s)*a.offsetHeight,o===i&&t.has(a.dataset.resultId))return clearInterval(c),l();a.classList.add("roulette"),r=r<e.children.length-1?r+1:0}),n)}))}async _flashResult(e){return new Promise((t=>{let i=0,n=setInterval((()=>{i%2?e.classList.remove("roulette"):e.classList.add("roulette"),7===i&&(clearInterval(n),t()),i++}),50)}))}}class SceneConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"scene-config",classes:["sheet","scene-sheet"],template:"templates/scene/config.html",width:560,height:"auto",tabs:[{navSelector:'.tabs[data-group="main"]',contentSelector:"form",initial:"basic"},{navSelector:'.tabs[data-group="ambience"]',contentSelector:'.tab[data-tab="ambience"]',initial:"basic"}]})}linkedDimensions=!0;get title(){return`${c.i18n.localize("SCENES.ConfigTitle")}: ${this.object.name}`}async close(e={}){return this._resetScenePreview(),super.close(e)}render(e,t={}){return t.renderContext&&!["createScene","updateScene"].includes(t.renderContext)?this:super.render(e,t)}getData(e={}){const t=super.getData(e);return t.data=this.document.toObject(),t.playlistSound=this.document.playlistSound?.id||"",t.foregroundElevation=this.document.foregroundElevation,t.minGrid=CONST.GRID_MIN_SIZE,t.gridTypes=this.constructor._getGridTypes(),t.gridStyles=g.Canvas.gridStyles,t.weatherTypes=this._getWeatherTypes(),t.ownerships=[{value:0,label:"SCENES.AccessibilityGM"},{value:2,label:"SCENES.AccessibilityAll"}],t.playlists=this._getDocuments(c.playlists),t.sounds=this._getDocuments(this.object.playlist?.sounds??[]),t.journals=this._getDocuments(c.journal),t.pages=this.object.journal?.pages.contents.sort(((e,t)=>e.sort-t.sort))??[],t.isEnvironment="ambience"===this._tabs[0].active&&"environment"===this._tabs[1].active,t.baseHueSliderDisabled=0===this.document.environment.base.intensity,t.darknessHueSliderDisabled=0===this.document.environment.dark.intensity,t}static _getGridTypes(){const e={GRIDLESS:"SCENES.GridGridless",SQUARE:"SCENES.GridSquare",HEXODDR:"SCENES.GridHexOddR",HEXEVENR:"SCENES.GridHexEvenR",HEXODDQ:"SCENES.GridHexOddQ",HEXEVENQ:"SCENES.GridHexEvenQ"};return Object.keys(CONST.GRID_TYPES).reduce(((t,i)=>(t[CONST.GRID_TYPES[i]]=e[i],t)),{})}async _renderInner(...e){return await loadTemplates(["templates/scene/parts/scene-ambience.html"]),super._renderInner(...e)}_getWeatherTypes(){const e={};for(let[t,i]of Object.entries(g.weatherEffects))e[t]=c.i18n.localize(i.label);return e}_getDocuments(e){const t=e.map((e=>({id:e.id,name:e.name})));return t.sort(((e,t)=>e.name.localeCompare(t.name,c.i18n.lang))),t}activateListeners(e){super.activateListeners(e),e.find("button.capture-position").click(this._onCapturePosition.bind(this)),e.find("button.grid-config").click(this._onGridConfig.bind(this)),e.find("button.dimension-link").click(this._onLinkDimensions.bind(this)),e.find("select[name='playlist']").change(this._onChangePlaylist.bind(this)),e.find('select[name="journal"]').change(this._onChangeJournal.bind(this)),e.find('button[type="reset"]').click(this._onResetForm.bind(this)),e.find("hue-slider").change(this._onChangeRange.bind(this))}_onCapturePosition(e){if(e.preventDefault(),!canvas.ready)return;const t=e.currentTarget.form;t["initial.x"].value=parseInt(canvas.stage.pivot.x),t["initial.y"].value=parseInt(canvas.stage.pivot.y),t["initial.scale"].value=canvas.stage.scale.x,ui.notifications.info("SCENES.CaptureInitialViewPosition",{localize:!0})}async _onGridConfig(e){return e.preventDefault(),new GridConfig(this.object,this).render(!0),this.minimize()}async _onLinkDimensions(e){e.preventDefault(),this.linkedDimensions=!this.linkedDimensions,this.element.find("button.dimension-link > i").toggleClass("fa-link-simple",this.linkedDimensions),this.element.find("button.dimension-link > i").toggleClass("fa-link-simple-slash",!this.linkedDimensions),this.element.find("button.resize").attr("disabled",!this.linkedDimensions);const t=c.i18n.localize(this.linkedDimensions?"SCENES.DimensionLinked":"SCENES.DimensionUnlinked");this.element.find("button.dimension-link").attr("data-tooltip",t),c.tooltip.activate(this.element.find("button.dimension-link")[0],{text:t})}async _onChangeInput(e){return"width"!==e.target.name&&"height"!==e.target.name||this._onChangeDimensions(e),"environment.darknessLock"===e.target.name&&await this.#kl(e.target.checked),this._previewScene(e.target.name),super._onChangeInput(e)}async#kl(e){const t=this.form["environment.darknessLevel"];t.disabled=e,await this.document.update({environment:{darknessLock:e,darknessLevel:t.valueAsNumber}},{render:!1})}_onChangeColorPicker(e){super._onChangeColorPicker(e),this._previewScene(e.target.dataset.edit)}_onChangeRange(e){super._onChangeRange(e);for(const t of["base","dark"])if(e.target.name===`environment.${t}.intensity`){const e=this.form[`environment.${t}.intensity`].valueAsNumber;this.form[`environment.${t}.hue`].disabled=0===e}this._previewScene(e.target.name)}_onChangeTab(e,t,i){super._onChangeTab(e,t,i);const n="ambience"===this._tabs[0].active&&"environment"===this._tabs[1].active;this.element.find('button[type="reset"]').toggleClass("hidden",!n)}_onResetForm(e){e.preventDefault();const t=Scene.cleanData().environment,i=this.document.toObject().environment,n={base:t.base,dark:t.dark},s={base:i.base,dark:i.dark};for(const e of["base","dark"])this.form[`environment.${e}.hue`].disabled=0===n[e].intensity,this.form[`environment.${e}.intensity`].value=n[e].intensity,this.form[`environment.${e}.luminosity`].value=n[e].luminosity,this.form[`environment.${e}.saturation`].value=n[e].saturation,this.form[`environment.${e}.shadows`].value=n[e].shadows,this.form[`environment.${e}.hue`].value=n[e].hue;this.document.updateSource({environment:n}),this._previewScene("forceEnvironmentPreview"),this.render(),this.document.updateSource({environment:s})}_previewScene(e){if(!this.object.isView||!canvas.ready||!e)return;const t=e.includes("force");(["grid.style","grid.thickness","grid.color","grid.alpha"].includes(e)||t)&&canvas.interface.grid.initializeMesh({style:this.form["grid.style"].value,thickness:Number(this.form["grid.thickness"].value),color:this.form["grid.color"].value,alpha:Number(this.form["grid.alpha"].value)});const i=e.includes("environment.")||e.includes("forceEnvironmentPreview")||t;(["backgroundColor","fog.colors.explored","fog.colors.unexplored"].includes(e)||i)&&canvas.environment.initialize(this.#Ml())}#Ml(){const e=new FormDataExtended(this.form),t=foundry.utils.expandObject(e.object);return{backgroundColor:t.backgroundColor,fogExploredColor:t.fog.colors.explored,fogUnexploredColor:t.fog.colors.unexplored,environment:t.environment}}_resetScenePreview(){this.object.isView&&canvas.ready&&(canvas.scene.reset(),canvas.environment.initialize(),canvas.interface.grid.initializeMesh(canvas.scene.grid))}_onChangePlaylist(e){e.preventDefault();const t=c.playlists.get(e.target.value),i=this._getDocuments(t?.sounds||[]),n=['<option value=""></option>'].concat(i.map((e=>`<option value="${e.id}">${e.name}</option>`)));this.form.querySelector('select[name="playlistSound"]').innerHTML=n.join("")}_onChangeJournal(e){e.preventDefault();const t=c.journal.get(e.currentTarget.value),i=(t?.pages.contents.sort(((e,t)=>e.sort-t.sort))??[]).map((e=>{const i=t.id===this.object.journal?.id&&e.id===this.object.journalEntryPage;return`<option value="${e.id}"${i?" selected":""}>${e.name}</option>`}));this.form.elements.journalEntryPage.innerHTML=`<option></option>${i}`}_onChangeDimensions(e){if(e.preventDefault(),!this.linkedDimensions)return;const t=e.currentTarget.name,i=Number(e.currentTarget.value),n="width"===t?this.object.width:this.object.height,s=i/n,o=this.form.elements["width"===t?"height":"width"];return o.value=o.value*s,Number.isInteger(parseFloat(o.value))?void 0:(ui.notifications.error(c.i18n.localize("SCENES.InvalidDimension")),this.form.elements[t].value=n,void(o.value="width"===t?this.object.height:this.object.width))}async _updateObject(e,t){const i=this.document;""===t["background.src"]&&(t["background.src"]=null),""===t.foreground&&(t.foreground=null),""===t["fog.overlay"]&&(t["fog.overlay"]=null),""===t["fog.colors.unexplored"]&&(t["fog.colors.unexplored"]=null),""===t["fog.colors.explored"]&&(t["fog.colors.explored"]=null);const n=null===i.background.src&&4e3===i.width&&3e3===i.height,s=t["background.src"]||i.background.src,o=void 0!==t["background.src"]&&t["background.src"]!==i.background.src,r=null===t.width||null===t.height,a=o||!i.thumb,l=t["background.src"]&&(r||n),d=s&&(a||l);if(d&&c.settings.get("core","noCanvas"))ui.notifications.warn("SCENES.GenerateThumbNoCanvas",{localize:!0}),t.thumb=null;else if(d){let e={};try{e=await i.createThumbnail({img:t["background.src"]??i.background.src})}catch(e){Hooks$1.onError("SceneConfig#_updateObject",e,{msg:"Thumbnail generation for Scene failed",notify:"error",log:"error",scene:i.id})}a&&(t.thumb=e.thumb||null),l&&(t.width=e.width,t.height=e.height)}const u=foundry.utils.diffObject(i._source,foundry.utils.expandObject(t)),h=foundry.utils.flattenObject(u);if(["grid.size",...["scaleX","scaleY","rotation"].map((e=>`background.${e}`))].some((e=>e in h))){if(!await Dialog.confirm({title:c.i18n.localize("SCENES.DimensionChangeTitle"),content:`<p>${c.i18n.localize("SCENES.DimensionChangeWarning")}</p>`}))return}let p=!1;if((i.background?.src||i.foreground?.src)&&["width","height","padding","background","grid.size"].some((e=>e in h))){p=!0;let e=!1;if("width"in h&&"height"in h){this.object.width/this.object.height!==t.width/t.height&&(e=!0)}else("width"in h||"height"in h)&&(e=!0);if(e){await Dialog.confirm({title:c.i18n.localize("SCENES.DistortedDimensionsTitle"),content:c.i18n.localize("SCENES.DistortedDimensionsWarning"),defaultYes:!1})||(p=!1)}}return delete t["environment.darknessLock"],i.update(t,{autoReposition:p})}}class DocumentSheetConfig extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["form","sheet-config"],template:"templates/sheets/sheet-config.html",width:400})}static#U=[];get title(){return`${this.object.name??c.i18n.localize(this.object.constructor.metadata.label)}: Sheet Configuration`}getData(e={}){const{sheetClasses:t,defaultClasses:i,defaultClass:n}=this.constructor.getSheetClassesForSubType(this.object.documentName,this.object.type||CONST.BASE_DOCUMENT_TYPE);return{isGM:c.user.isGM,object:this.object.toObject(),options:this.options,sheetClass:this.object.getFlag("core","sheetClass")??"",blankLabel:c.i18n.localize("SHEETS.DefaultSheet"),sheetClasses:t,defaultClass:n,defaultClasses:i}}async _updateObject(e,t){e.preventDefault();const i=this.getData({}),n=t.defaultClass!==i.defaultClass,s=t.sheetClass!==i.sheetClass;if(c.user.isGM&&n){const e=c.settings.get("core","sheetClasses")||{},i=this.object.type||CONST.BASE_DOCUMENT_TYPE;if(foundry.utils.mergeObject(e,{[`${this.object.documentName}.${i}`]:t.defaultClass}),await c.settings.set("core","sheetClasses",e),!s)return this.object._onSheetChange({sheetOpen:!0})}if(s)return this.object.setFlag("core","sheetClass",t.sheetClass)}static getSheetClassesForSubType(e,t){const i=g[e],n={};let s=null;return{sheetClasses:Object.values(i.sheetClasses[t]).reduce(((e,t)=>(t.canConfigure&&(e[t.id]=t.label),t.default&&!s&&(s=t.id),t.canConfigure&&t.canBeDefault&&(n[t.id]=t.label),e)),{}),defaultClasses:n,defaultClass:s}}static initializeSheets(){for(let e of Object.values(foundry.documents)){const t=this._getDocumentTypes(e);g[e.documentName].sheetClasses=t.reduce(((e,t)=>(e[t]={},e)),{})}this.#U.forEach((e=>{"register"===e.action?this.#Ll(e):"unregister"===e.action&&this.#Fl(e)})),this.#U=[];const e=c.settings.get("core","sheetClasses");this.updateDefaultSheets(e)}static _getDocumentTypes(e,t=[]){return t.length?t:c.documentTypes[e.documentName]}static registerSheet(e,t,i,{label:n,types:s,makeDefault:o=!1,canBeDefault:r=!0,canConfigure:a=!0}={}){const l={documentClass:e,id:`${t}.${i.name}`,label:n,sheetClass:i,types:s,makeDefault:o,canBeDefault:r,canConfigure:a};c.ready?this.#Ll(l):(l.action="register",this.#U.push(l))}static#Ll({documentClass:e,id:t,label:i,sheetClass:n,types:s,makeDefault:o,canBeDefault:r,canConfigure:a}={}){s=this._getDocumentTypes(e,s);const l=g[e.documentName]?.sheetClasses,d=c.ready?c.settings.get("core","sheetClasses"):{};if("object"==typeof l)for(const u of s){l[u]||={};const s=d[e.documentName]?.[u],h=s?s===t:o;h&&Object.values(l[u]).forEach((e=>e.default=!1)),i=i instanceof Function?i():i?c.i18n.localize(i):t,l[u][t]={id:t,label:i,canBeDefault:r,canConfigure:a,cls:n,default:h}}}static unregisterSheet(e,t,i,{types:n}={}){const s={documentClass:e,id:`${t}.${i.name}`,types:n};c.ready?this.#Fl(s):(s.action="unregister",this.#U.push(s))}static#Fl({documentClass:e,id:t,types:i}={}){i=this._getDocumentTypes(e,i);const n=g[e.documentName]?.sheetClasses;if("object"==typeof n)for(let e of i)delete n[e][t]}static updateDefaultSheets(e={}){if(Object.keys(e).length)for(let t of Object.values(foundry.documents)){const i=t.documentName,n=g[i],s=n.sheetClasses,o=n.collection?.instance??[],r=e[i];if(r){for(let[e,t]of Object.entries(r)){const i=Object.values(s[e]||{});i.find((e=>e.id===t))&&i.forEach((e=>e.default=e.id===t))}for(let e of o){for(const[t,i]of Object.entries(e.apps))i.close(),delete e.apps[t];e._sheet=null}}}}static _registerDefaultSheets(){const e={Actor:ActorSheet,Adventure:AdventureImporter,Folder:FolderConfig,Item:ItemSheet,JournalEntry:JournalSheet,Macro:MacroConfig,Playlist:PlaylistConfig,RollTable:RollTableConfig,Scene:SceneConfig,User:foundry.applications.sheets.UserConfig,ActiveEffect:ActiveEffectConfig,AmbientLight:foundry.applications.sheets.AmbientLightConfig,AmbientSound:foundry.applications.sheets.AmbientSoundConfig,Card:CardConfig,Combatant:CombatantConfig,Drawing:DrawingConfig,MeasuredTemplate:MeasuredTemplateConfig,Note:NoteConfig,PlaylistSound:PlaylistSoundConfig,Region:foundry.applications.sheets.RegionConfig,RegionBehavior:foundry.applications.sheets.RegionBehaviorConfig,Tile:TileConfig,Token:TokenConfig,Wall:WallConfig};Object.values(foundry.documents).forEach((t=>{const i=t.documentName,n=g[i];n.sheetClasses={};const s=e[i];s&&DocumentSheetConfig.registerSheet(n.documentClass,"core",s,{makeDefault:!0,label:()=>c.i18n.format("SHEETS.DefaultDocumentSheet",{document:c.i18n.localize(`DOCUMENT.${i}`)})})})),DocumentSheetConfig.registerSheet(Cards,"core",CardsConfig,{label:"CARDS.CardsDeck",types:["deck"],makeDefault:!0}),DocumentSheetConfig.registerSheet(Cards,"core",CardsHand,{label:"CARDS.CardsHand",types:["hand"],makeDefault:!0}),DocumentSheetConfig.registerSheet(Cards,"core",CardsPile,{label:"CARDS.CardsPile",types:["pile"],makeDefault:!0}),DocumentSheetConfig.registerSheet(JournalEntryPage,"core",JournalTextTinyMCESheet,{types:["text"],label:()=>c.i18n.localize("EDITOR.TinyMCE")}),DocumentSheetConfig.registerSheet(JournalEntryPage,"core",JournalImagePageSheet,{types:["image"],makeDefault:!0,label:()=>c.i18n.format("JOURNALENTRYPAGE.DefaultPageSheet",{page:c.i18n.localize("JOURNALENTRYPAGE.TypeImage")})}),DocumentSheetConfig.registerSheet(JournalEntryPage,"core",JournalVideoPageSheet,{types:["video"],makeDefault:!0,label:()=>c.i18n.format("JOURNALENTRYPAGE.DefaultPageSheet",{page:c.i18n.localize("JOURNALENTRYPAGE.TypeVideo")})}),DocumentSheetConfig.registerSheet(JournalEntryPage,"core",JournalPDFPageSheet,{types:["pdf"],makeDefault:!0,label:()=>c.i18n.format("JOURNALENTRYPAGE.DefaultPageSheet",{page:c.i18n.localize("JOURNALENTRYPAGE.TypePDF")})}),DocumentSheetConfig.registerSheet(JournalEntryPage,"core",JournalTextPageSheet,{types:["text"],makeDefault:!0,label:()=>c.i18n.format("JOURNALENTRYPAGE.DefaultPageSheet",{page:c.i18n.localize("JOURNALENTRYPAGE.TypeText")})}),DocumentSheetConfig.registerSheet(JournalEntryPage,"core",MarkdownJournalPageSheet,{types:["text"],label:()=>c.i18n.localize("EDITOR.Markdown")})}}class ChatBubbles{constructor(){this.template="templates/hud/chat-bubble.html",this.bubbles={},this._panned=null}get container(){return $("#chat-bubbles")}async broadcast(e,t,i={}){if(e instanceof Token&&(e=e.document),!(e instanceof TokenDocument&&t))throw new Error("You must provide a Token instance and a message string");return c.socket.emit("chatBubble",{sceneId:e.parent.id,tokenId:e.id,message:t,options:i}),this.say(e.object,t,i)}async say(e,t,{cssClasses:i=[],requireVisible:n=!1,pan:s=!0}={}){if(!e||!t)return null;if(!c.settings.get("core","chatBubbles"))return null;if(n&&!e.visible)return null;await this._clearBubble(e);const o=ChatMessage.implementation.getSpeakerActor({scene:e.scene.id,token:e.id});t=await TextEditor$1.enrichHTML(t,{rollData:o?.getRollData()});let r=$(await this._renderHTML({token:e,message:t,cssClasses:i.join(" ")}));if(!1===Hooks$1.call("chatBubble",e,r,t,{cssClasses:i,pan:s}))return null;let a=this._getMessageDimensions(t);this._setPosition(e,r,a),this.container.append(r);const l=[];if(c.settings.get("core","chatBubblesPan")&&s&&this._panned!==e){const t=Math.max(1,canvas.stage.scale.x);l.push(canvas.animatePan({x:e.document.x,y:e.document.y,scale:t,duration:1e3})),this._panned=e}const d=this._getDuration(r),u=a.unconstrained-a.height;return l.push(new Promise((e=>{r.fadeIn(250,(()=>{u>0&&r.find(".bubble-content").animate({top:-1*u},d-1e3,"linear",e),setTimeout((()=>r.fadeOut(250,(()=>r.remove()))),d)}))}))),await Promise.all(l),r}static _activateSocketListeners(e){e.on("chatBubble",(({sceneId:e,tokenId:t,message:i,options:n})=>{if(!canvas.ready)return;const s=c.scenes.get(e);if(!s?.isView)return;const o=s.tokens.get(t);return o?canvas.hud.bubbles.say(o.object,i,n):void 0}))}async _clearBubble(e){let t=$(`.chat-bubble[data-token-id="${e.id}"]`);if(t.length)return new Promise((e=>{t.fadeOut(100,(()=>{t.remove(),e()}))}))}async _renderHTML(e){return renderTemplate(this.template,e)}_getMessageDimensions(e){let t=$(`<div class="chat-bubble" style="visibility:hidden">${e}</div>`);$("body").append(t);let i={width:t[0].clientWidth+8,height:t[0].clientHeight};return t.css({maxHeight:"none"}),i.unconstrained=t[0].clientHeight,t.remove(),i}_setPosition(e,t,i){let n=Math.random()>.5?"left":"right";t.addClass(n);const s={height:i.height,width:i.width,top:e.y-i.height-8};s.left="right"===n?e.x-(i.width-e.w):e.x,t.css(s)}_getDuration(e){const t=60*e.text().split(/\s+/).reduce(((e,t)=>e+Number(!!t.trim().length)),0)*1e3/300;return Math.clamp(1e3,t,2e4)}}class HeadsUpDisplay extends Application{token=new g.Token.hudClass;tile=new g.Tile.hudClass;drawing=new g.Drawing.hudClass;bubbles=new g.Canvas.chatBubblesClass;static get defaultOptions(){const e=super.defaultOptions;return e.id="hud",e.template="templates/hud/hud.html",e.popOut=!1,e}getData(e={}){return canvas.ready?{width:canvas.dimensions.width,height:canvas.dimensions.height}:{}}async _render(e,t){await super._render(e,t),this.align()}align(){const e=this.element[0],{x:t,y:i}=canvas.primary.getGlobalPosition(),n=canvas.stage.scale.x;e.style.left=`${t}px`,e.style.top=`${i}px`,e.style.transform=`scale(${n})`}}class BasePlaceableHUD extends Application{object;#Ul=!1;static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["placeable-hud"],popOut:!1})}get document(){return this.object?.document}get layer(){return this.object?.layer}bind(e){const t=this.constructor.RENDER_STATES;if(![t.CLOSING,t.RENDERING].includes(this._state)){if(this.object&&this.clear(),!(e instanceof PlaceableObject)||e.scene!==canvas.scene)throw new Error("You may only bind a HUD instance to a PlaceableObject in the currently viewed Scene.");this.object=e,this.render(!0),this.element.hide().fadeIn(200)}}clear(){let e=this.constructor.RENDER_STATES;this._state<=e.NONE||(this._state=e.CLOSING,this.object=null,this.element.hide(),this._element=null,this._state=e.NONE)}async _render(...e){await super._render(...e),this.setPosition()}getData(e={}){const t=this.object.document.toObject();return foundry.utils.mergeObject(t,{id:this.id,classes:this.options.classes.join(" "),appId:this.appId,isGM:c.user.isGM,isGamePaused:c.paused,icons:g.controlIcons})}setPosition({left:e,top:t,width:i,height:n,scale:s}={}){const o={width:i||this.object.width,height:n||this.object.height,left:e??this.object.x,top:t??this.object.y};this.element.css(o)}activateListeners(e){e.find(".attribute input").click(this._onAttributeClick).keydown(this._onAttributeKeydown.bind(this)).focusout(this._onAttributeUpdate.bind(this)),e.find(".control-icon").mouseleave((()=>this.#Ul=!1)).mouseenter((()=>this.#Ul=!0)).click(this._onClickControl.bind(this))}_onClickControl(e){switch(e.currentTarget.dataset.action){case"visibility":return this._onToggleVisibility(e);case"locked":return this._onToggleLocked(e);case"sort-up":return this._onSort(e,!0);case"sort-down":return this._onSort(e,!1)}}_onAttributeClick(e){e.currentTarget.select()}_onAttributeKeydown(e){"Enter"!==e.code&&"NumpadEnter"!==e.code||e.currentTarget.blur()}_onAttributeUpdate(e){if(e.preventDefault(),!this.object)return;const t=e.currentTarget;this._updateAttribute(t.name,e.currentTarget.value.trim()),this.#Ul||this.clear()}async _updateAttribute(e,t){const i=foundry.utils.getProperty(this.object.document,e),{value:n}=this._parseAttributeInput(e,i,t);await this.object.document.update({[e]:n})}_parseAttributeInput(e,t,i){const n="object"==typeof t&&"max"in t,s=i.startsWith("="),o=i.startsWith("+")||i.startsWith("-"),r=n?t.value:t;let a;if(s&&(i=i.slice(1)),i.endsWith("%")){const e=Number(i.slice(0,-1))/100;a=n?t.max*e:Math.abs(r)*e}else a=Number(i);return{value:o?r+a:a,delta:o?a:void 0,isDelta:o,isBar:n}}async _onToggleVisibility(e){e.preventDefault();const t=this.object.document.hidden,i=this.layer.controlled.map((e=>({_id:e.id,hidden:!t})));return canvas.scene.updateEmbeddedDocuments(this.object.document.documentName,i)}async _onToggleLocked(e){e.preventDefault();const t=this.object.document.locked,i=this.layer.controlled.map((e=>({_id:e.id,locked:!t})));return e.currentTarget.classList.toggle("active",!t),canvas.scene.updateEmbeddedDocuments(this.object.document.documentName,i)}async _onSort(e,t){e.preventDefault(),this.layer._sendToBackOrBringToFront(t)}}class SceneNavigation extends Application{constructor(e){super(e),c.scenes.apps.push(this),this._collapsed=!1}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"navigation",template:"templates/hud/navigation.html",popOut:!1,dragDrop:[{dragSelector:".scene"}]})}get scenes(){const e=c.scenes.filter((e=>e.navigation&&e.visible||e.active||e.isView));return e.sort(((e,t)=>e.navOrder-t.navOrder)),e}render(e,t={}){let{renderContext:i,renderData:n}=t;if(i){if(!["createScene","updateScene","deleteScene"].includes(i))return this;const e=["name","ownership","active","navigation","navName","navOrder"];if("updateScene"===i&&!n.some((t=>e.some((e=>e in t)))))return this}return super.render(e,t)}async _render(e,t){await super._render(e,t);const i=document.getElementById("loading"),n=this.element[0];i.style.top=`${n.offsetTop+n.offsetHeight}px`}getData(e={}){const t=this.scenes.map((e=>({id:e.id,active:e.active,name:TextEditor$1.truncateText(e.navName||e.name,{maxLength:32}),tooltip:e.navName&&c.user.isGM?e.name:null,users:c.users.reduce(((t,i)=>(i.active&&i.viewedScene===e.id&&t.push({letter:i.name[0],color:i.color.css}),t)),[]),visible:c.user.isGM||e.isOwner||e.active,css:[e.isView?"view":null,e.active?"active":null,0===e.ownership.default?"gm":null].filterJoin(" ")})));return{collapsed:this._collapsed,scenes:t}}expand(){if(!this._collapsed)return!0;const e=this.element,t=e.find("#nav-toggle i.fas"),i=e.children("#scene-list");return new Promise((n=>{i.slideDown(200,(()=>(e.removeClass("collapsed"),t.removeClass("fa-caret-down").addClass("fa-caret-up"),this._collapsed=!1,Hooks$1.callAll("collapseSceneNavigation",this,this._collapsed),n(!0))))}))}async collapse(){if(this._collapsed)return!0;const e=this.element,t=e.find("#nav-toggle i.fas"),i=e.children("#scene-list");return new Promise((n=>{i.slideUp(200,(()=>(e.addClass("collapsed"),t.removeClass("fa-caret-up").addClass("fa-caret-down"),this._collapsed=!0,Hooks$1.callAll("collapseSceneNavigation",this,this._collapsed),n(!0))))}))}activateListeners(e){super.activateListeners(e);e.find(".scene").click(this._onClickScene.bind(this)),e.find("#nav-toggle").click(this._onToggleNav.bind(this));const t=this._getContextMenuOptions();Hooks$1.call("getSceneNavigationContext",e,t),t&&new ContextMenu(e,".scene",t)}_getContextMenuOptions(){return[{name:"SCENES.Activate",icon:'<i class="fas fa-bullseye"></i>',condition:e=>c.user.isGM&&!c.scenes.get(e.data("sceneId")).active,callback:e=>{c.scenes.get(e.data("sceneId")).activate()}},{name:"SCENES.Configure",icon:'<i class="fas fa-cogs"></i>',condition:c.user.isGM,callback:e=>{c.scenes.get(e.data("sceneId")).sheet.render(!0)}},{name:"SCENES.Notes",icon:'<i class="fas fa-scroll"></i>',condition:e=>{if(!c.user.isGM)return!1;return!!c.scenes.get(e.data("sceneId")).journal},callback:e=>{const t=c.scenes.get(e.data("sceneId")),i=t.journal;if(i){const e=i.sheet,n={};t.journalEntryPage&&(n.pageId=t.journalEntryPage),e.render(!0,n)}}},{name:"SCENES.Preload",icon:'<i class="fas fa-download"></i>',condition:c.user.isGM,callback:e=>{let t=e.attr("data-scene-id");c.scenes.preload(t,!0)}},{name:"SCENES.ToggleNav",icon:'<i class="fas fa-compass"></i>',condition:e=>{const t=c.scenes.get(e.data("sceneId"));return c.user.isGM&&!t.active},callback:e=>{const t=c.scenes.get(e.data("sceneId"));t.update({navigation:!t.navigation})}}]}_onClickScene(e){e.preventDefault();let t=e.currentTarget.dataset.sceneId;c.scenes.get(t).view()}_onDragStart(e){const t=e.currentTarget.dataset.sceneId,i=c.scenes.get(t);e.dataTransfer.setData("text/plain",JSON.stringify(i.toDragData()))}async _onDrop(e){const t=TextEditor$1.getDragEventData(e);if("Scene"!==t.type)return;const i=await Scene.implementation.fromDropData(t),n=e.target.closest(".scene")||null,s=n?c.scenes.get(n.dataset.sceneId):null;if(s&&s.id===i.id)return;const o=this.scenes.filter((e=>e.id!==i.id));return i.sortRelative({target:s,siblings:o,sortKey:"navOrder"})}_onToggleNav(e){return e.preventDefault(),this._collapsed?this.expand():this.collapse()}static displayProgressBar({label:e,pct:t}={}){const i=document.getElementById("loading");t=Math.clamp(t,0,100),i.querySelector("#context").textContent=e,i.querySelector("#loading-bar").style.width=`${t}%`,i.querySelector("#progress").textContent=`${t}%`,i.style.display="block",100!==t||i.hidden||$(i).fadeOut(2e3)}}class AVConfig extends FormApplication{constructor(e,t){super(e||c.webrtc,t)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{title:c.i18n.localize("WEBRTC.Title"),id:"av-config",template:"templates/sidebar/apps/av-config.html",popOut:!0,width:480,height:"auto",tabs:[{navSelector:".tabs",contentSelector:"form",initial:"general"}]})}async getData(e={}){const t=this.object.settings,i=await this.object.client.getVideoSources(),n=await this.object.client.getAudioSources(),s=await this.object.client.getAudioSinks(),{videoSrc:o,audioSrc:r,audioSink:a}=t.client,l=this._isSourceUnavailable(i,o),d=this._isSourceUnavailable(n,r),u=this._isSourceUnavailable(s,a),h="https:"===window.location.protocol,p={[AVSettings.AV_MODES.DISABLED]:"WEBRTC.ModeDisabled",[AVSettings.AV_MODES.AUDIO]:"WEBRTC.ModeAudioOnly",[AVSettings.AV_MODES.VIDEO]:"WEBRTC.ModeVideoOnly",[AVSettings.AV_MODES.AUDIO_VIDEO]:"WEBRTC.ModeAudioVideo"},g=Object.values(AVSettings.VOICE_MODES).reduce(((e,t)=>(e[t]=c.i18n.localize(`WEBRTC.VoiceMode${t.titleCase()}`),e)),{}),m={[AVSettings.NAMEPLATE_MODES.OFF]:"WEBRTC.NameplatesOff",[AVSettings.NAMEPLATE_MODES.PLAYER_ONLY]:"WEBRTC.NameplatesPlayer",[AVSettings.NAMEPLATE_MODES.CHAR_ONLY]:"WEBRTC.NameplatesCharacter",[AVSettings.NAMEPLATE_MODES.BOTH]:"WEBRTC.NameplatesBoth"},v=Object.fromEntries(Object.values(AVSettings.DOCK_POSITIONS).map((e=>[e,c.i18n.localize(`WEBRTC.DockPosition${e.titleCase()}`)])));return{user:c.user,modes:p,voiceModes:g,serverTypes:{FVTT:"WEBRTC.FVTTSignalingServer",custom:"WEBRTC.CustomSignalingServer"},turnTypes:{server:"WEBRTC.TURNServerProvisioned",custom:"WEBRTC.CustomTURNServer"},settings:t,canSelectMode:c.user.isGM&&h,noSSL:!h,videoSources:i,audioSources:n,audioSinks:!foundry.utils.isEmpty(s)&&s,videoSrcUnavailable:l,audioSrcUnavailable:d,audioSinkUnavailable:u,audioDisabled:"disabled"===r,videoDisabled:"disabled"===o,nameplates:m,nameplateSetting:t.client.nameplates??AVSettings.NAMEPLATE_MODES.BOTH,dockPositions:v,audioSourceOptions:this.#Bl(n,d,"WEBRTC.DisableAudioSource"),audioSinkOptions:this.#Bl(s,u),videoSourceOptions:this.#Bl(i,l,"WEBRTC.DisableVideoSource")}}#Bl(e,t,i){const n=[];let s=!1;for(const[t,i]of Object.entries(e))"default"===t&&(s=!0),n.push({value:t,label:i});return s||n.unshift({value:"default",label:c.i18n.localize("WEBRTC.DefaultSource")}),i&&n.unshift({value:"disabled",label:c.i18n.localize(i)}),t&&n.push({value:t,label:c.i18n.localize("WEBRTC.UnavailableDevice")}),n}activateListeners(e){if(super.activateListeners(e),!c.user.isGM)return;e.find('select[name="world.turn.type"]').change(this._onTurnTypeChanged.bind(this));const t=this.object.settings;this._setConfigSectionEnabled(".webrtc-custom-turn-config","custom"===t.world.turn.type)}_setConfigSectionEnabled(e,t=!0){let i=this.element.find(e);i&&(i.css("opacity",t?1:.5),i.find("input").prop("disabled",!t))}_isSourceUnavailable(e,t){return t&&!["default","disabled"].includes(t)&&!Object.keys(e).includes(t)}_onTurnTypeChanged(e){e.preventDefault();const t=e.currentTarget.value;this._setConfigSectionEnabled(".webrtc-custom-turn-config","custom"===t)}async _updateObject(e,t){const i=c.webrtc.settings;i.client.videoSrc=i.client.videoSrc||null,i.client.audioSrc=i.client.audioSrc||null;const n=foundry.utils.expandObject(t);if(c.user.isGM){i.world.mode!==n.world.mode&&SettingsConfig.reloadConfirm({world:!0});const e=foundry.utils.mergeObject(i.world,n.world);await c.settings.set("core","rtcWorldSettings",e)}const s=foundry.utils.mergeObject(i.client,n.client);await c.settings.set("core","rtcClientSettings",s)}}class CameraPopoutAppWrapper{constructor(e,t,i){this.view=e,this.element=i,this.userId=t,this.popOut=!0,this.options={};let n=c.webrtc.settings.getUser(t);this.setPosition(n),new Draggable(this,i.find(".camera-view"),i.find(".video-container")[0],!0)}get position(){return foundry.utils.mergeObject(this.element.position(),{width:this.element.outerWidth(),height:this.element.outerHeight(),scale:1})}setPosition(e={}){const t=Application.prototype.setPosition.call(this,e);if(this.element[0].style.height="",!foundry.utils.isEmpty(t)){const e=c.webrtc.settings.client.users[this.userId]||{},i=foundry.utils.mergeObject(e,t);c.webrtc.settings.set("client",`users.${this.userId}`,i)}return t}_onResize(e){}bringToTop(){let e=this.element.parent(),t=e.children();t[t.length-1]!==this.element[0]&&(c.webrtc.settings.set("client",`users.${this.userId}.z`,++this.view.maxZ),e.append(this.element))}}class FolderExport extends Dialog{activateListeners(e){super.activateListeners(e),e.find('select[name="pack"]').change(this._onPackChange.bind(this))}_onPackChange(e){const t=this.element.find('select[name="folder"]')[0],i=c.packs.get(e.target.value);if(!i)return void(t.disabled=!0);const n=i._formatFolderSelectOptions();t.disabled=0===n.length,t.innerHTML=HandlebarsHelpers.selectOptions(n,{hash:{blank:"",nameAttr:"id",labelAttr:"name"}})}}class DiceConfig extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"dice-config",template:"templates/dice/config.html",title:"DICE.CONFIG.Title",width:500})}getData(e={}){const t=super.getData(e),{methods:i,dice:n}=g.Dice.fulfillment;c.user.hasPermission("MANUAL_ROLLS")||delete i.manual;const s=c.settings.get("core","diceConfiguration");return t.methods=i,t.dice=Object.entries(n).map((([e,{label:t,icon:i}])=>({label:t,icon:i,denomination:e,method:s[e]||""}))),t}async _updateObject(e,t){const i=c.settings.get("core","diceConfiguration");return foundry.utils.mergeObject(i,t),c.settings.set("core","diceConfiguration",i)}}class DrawingConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"drawing-config",template:"templates/scene/drawing-config.html",width:480,height:"auto",configureDefault:!1,tabs:[{navSelector:".tabs",contentSelector:"form",initial:"position"}]})}get title(){return this.options.configureDefault?c.i18n.localize("DRAWING.ConfigDefaultTitle"):super.title}getData(e={}){let t;return t=this.options.configureDefault?"DRAWING.SubmitDefault":this.document.id?"DRAWING.SubmitUpdate":"DRAWING.SubmitCreate",{author:this.document.author?.name||"",isDefault:this.options.configureDefault,fillTypes:Object.entries(CONST.DRAWING_FILL_TYPES).reduce(((e,t)=>(e[t[1]]=`DRAWING.FillType${t[0].titleCase()}`,e)),{}),scaledBezierFactor:2*this.document.bezierFactor,fontFamilies:FontConfig.getAvailableFontChoices(),drawingRoles:{object:"DRAWING.Object",information:"DRAWING.Information"},currentRole:this.document.interface?"information":"object",object:this.document.toObject(),options:this.options,gridUnits:this.document.parent?.grid.units||canvas.scene.grid.units||c.i18n.localize("GridUnits"),userColor:c.user.color,submitText:t}}async _updateObject(e,t){if(!this.object.isOwner)throw new Error("You do not have the ability to configure this Drawing object.");if(t.bezierFactor/=2,this.options.configureDefault){t=foundry.utils.expandObject(t);const e=DrawingDocument.cleanData(t,{partial:!0});return c.settings.set("core",DrawingsLayer.DEFAULT_CONFIG_SETTING,e)}t.interface="information"===t.drawingRole,delete t.drawingRole;const i=this.object.shape,n=t["shape.width"],s=t["shape.height"];if(i&&(n!==i.width||s!==i.height)){const e=n-i.width,o=s-i.height;(t=foundry.utils.expandObject(t)).shape.width=i.width,t.shape.height=i.height,foundry.utils.mergeObject(t,Drawing.rescaleDimensions(t,e,o))}return this.object.id?this.object.update(t):this.object.constructor.create(t)}async close(e){await super.close(e),this.preview&&(this.preview.removeChildren(),this.preview=null)}activateListeners(e){super.activateListeners(e),e.find('button[name="reset"]').click(this._onResetDefaults.bind(this))}_onResetDefaults(e){e.preventDefault(),this.object=DrawingDocument.fromSource({}),this.render()}}class NoteConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{title:c.i18n.localize("NOTE.ConfigTitle"),template:"templates/scene/note-config.html",width:480})}getData(e={}){const t=super.getData(e);this.object.id||(t.data.global=!canvas.scene.tokenVision);const i=c.journal.get(this.object.entryId),n=i?.pages.contents.sort(((e,t)=>e.sort-t.sort)),s=Object.entries(g.JournalEntry.noteIcons).map((([e,t])=>({label:e,src:t}))).sort(((e,t)=>e.label.localeCompare(t.label,c.i18n.lang)));s.unshift({label:c.i18n.localize("NOTE.Custom"),src:""});const o=!Object.values(g.JournalEntry.noteIcons).includes(this.document.texture.src),r={selected:o?"":this.document.texture.src,custom:o?this.document.texture.src:""};return foundry.utils.mergeObject(t,{icon:r,icons:s,label:this.object.label,entry:i||{},pages:n||[],entries:c.journal.filter((e=>e.isOwner)).sort(((e,t)=>e.name.localeCompare(t.name,c.i18n.lang))),fontFamilies:FontConfig.getAvailableFontChoices(),textAnchors:Object.entries(CONST.TEXT_ANCHOR_POINTS).reduce(((e,t)=>(e[t[1]]=c.i18n.localize(`JOURNAL.Anchor${t[0].titleCase()}`),e)),{}),gridUnits:this.document.parent.grid.units||c.i18n.localize("GridUnits"),submitText:c.i18n.localize(this.id?"NOTE.Update":"NOTE.Create")})}activateListeners(e){super.activateListeners(e),this._updateCustomIcon()}async _onChangeInput(e){return this._updateCustomIcon(),"entryId"===e.currentTarget.name&&this._updatePageList(),super._onChangeInput(e)}_updateCustomIcon(){const e=this.form["icon.selected"];this.form["icon.custom"].disabled=e.value.length}_updatePageList(){const e=this.form.elements.entryId?.value,t=(c.journal.get(e)?.pages.contents.sort(((e,t)=>e.sort-t.sort))??[]).map((t=>{const i=e===this.object.entryId&&t.id===this.object.pageId;return`<option value="${t.id}"${i?" selected":""}>${t.name}</option>`}));this.form.elements.pageId.innerHTML=`<option></option>${t}`}_getSubmitData(e={}){const t=super._getSubmitData(e);return t["texture.src"]=t["icon.selected"]||t["icon.custom"],delete t["icon.selected"],delete t["icon.custom"],t}async _updateObject(e,t){return this.object.id?this.object.update(t):this.object.constructor.create(t,{parent:canvas.scene})}async close(e){return this.object.id||canvas.notes.clearPreviewContainer(),super.close(e)}}class TileConfig extends DocumentSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"tile-config",title:c.i18n.localize("TILE.ConfigTitle"),template:"templates/scene/tile-config.html",width:420,height:"auto",submitOnChange:!0,tabs:[{navSelector:".tabs",contentSelector:"form",initial:"basic"}]})}async close(e={}){e.force||(this.document.reset(),!1===this.document.object?.destroyed&&this.document.object.refresh());return this.object.layer.clearPreviewContainer(),super.close(e)}getData(e={}){const t=super.getData(e);return t.submitText=c.i18n.localize(this.object.id?"TILE.SubmitUpdate":"TILE.SubmitCreate"),t.occlusionModes=Object.entries(CONST.OCCLUSION_MODES).reduce(((e,t)=>(e[t[1]]=c.i18n.localize(`TILE.OcclusionMode${t[0].titleCase()}`),e)),{}),t.gridUnits=this.document.parent.grid.units||c.i18n.localize("GridUnits"),t}async _onChangeInput(e){const t=e.target;"color"===t.type&&t.dataset.edit?this._onChangeColorPicker(e):"range"===t.type&&this._onChangeRange(e);const i=new FormDataExtended(this.form).object;i.width=Math.abs(i.width),i.height=Math.abs(i.height);let n=i["texture.tint"];foundry.data.validators.isColorString(n)||(i["texture.tint"]="#ffffff"),i["texture.tint"]=Color.from(i["texture.tint"]),foundry.utils.mergeObject(this.document,foundry.utils.expandObject(i)),this.document.object.refresh()}async _updateObject(e,t){return this.document.id?this.document.update(t):this.document.constructor.create(t,{parent:this.document.parent,pack:this.document.pack})}}class TokenConfig extends DocumentSheet{constructor(e,t){super(e,t),this.token=this.object,this.actor=this.object.actor,this.isPrototype&&(this.options.sheetConfig=!1)}preview;static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","token-sheet"],template:"templates/scene/token-config.html",width:480,height:"auto",tabs:[{navSelector:'.tabs[data-group="main"]',contentSelector:"form",initial:"character"},{navSelector:'.tabs[data-group="light"]',contentSelector:'.tab[data-tab="light"]',initial:"basic"},{navSelector:'.tabs[data-group="vision"]',contentSelector:'.tab[data-tab="vision"]',initial:"basic"}],viewPermission:CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER,sheetConfig:!0})}get isPrototype(){return this.object instanceof foundry.data.PrototypeToken}get id(){return this.isPrototype?`${this.constructor.name}-${this.actor.uuid}`:super.id}get title(){return this.isPrototype?`${c.i18n.localize("TOKEN.TitlePrototype")}: ${this.actor.name}`:`${c.i18n.localize("TOKEN.Title")}: ${this.token.name}`}render(e=!1,t={}){return this.isPrototype&&(this.object.actor.apps[this.appId]=this),super.render(e,t)}async _render(e,t={}){return await this._handleTokenPreview(e,t),super._render(e,t)}async _handleTokenPreview(e,t={}){const i=Application.RENDER_STATES;if(e&&[i.CLOSED,i.NONE].includes(this._state)){if(this.isPrototype)return void(this.preview=this.object.clone());if(!this.document.object)return void(this.preview=null);if(!this.preview){const e=this.document.object.clone({},{keepId:!0});this.preview=e.document,e.control({releaseOthers:!0})}await this.preview.object.draw(),this.document.object.renderable=!1,this.document.object.initializeSources({deleted:!0}),this.preview.object.layer.preview.addChild(this.preview.object),this._previewChanges()}}_canUserView(e){return super._canUserView(e)&&c.user.can("TOKEN_CONFIGURE")}async getData(e={}){const t=await this._getAlternateTokenImages(),i=!foundry.utils.isEmpty(g.Actor.trackableAttributes),n=this.actor?.system instanceof foundry.abstract.DataModel&&i?this.actor?.type:this.actor?.system,s=TokenDocument.implementation.getTrackedAttributes(n),o=c.user.hasPermission("FILES_BROWSE"),r=this.preview??this.document,a=r.toObject(),l=new Set(a.detectionModes.map((e=>e.id))),d=r.detectionModes.filter((e=>!l.has(e.id)));return{fields:this.document.schema.fields,lightFields:this.document.schema.fields.light.fields,cssClasses:[this.isPrototype?"prototype":null].filter((e=>!!e)).join(" "),isPrototype:this.isPrototype,hasAlternates:!foundry.utils.isEmpty(t),alternateImages:t,object:a,options:this.options,gridUnits:(this.isPrototype?"":this.document.parent?.grid.units)||c.i18n.localize("GridUnits"),barAttributes:TokenDocument.implementation.getTrackedAttributeChoices(s),bar1:r.getBarAttribute?.("bar1"),bar2:r.getBarAttribute?.("bar2"),colorationTechniques:AdaptiveLightingShader.SHADER_TECHNIQUES,visionModes:Object.values(g.Canvas.visionModes).filter((e=>e.tokenConfig)),detectionModes:Object.values(g.Canvas.detectionModes).filter((e=>e.tokenConfig)),preparedDetectionModes:d,displayModes:Object.entries(CONST.TOKEN_DISPLAY_MODES).reduce(((e,t)=>(e[t[1]]=c.i18n.localize(`TOKEN.DISPLAY_${t[0]}`),e)),{}),hexagonalShapes:Object.entries(CONST.TOKEN_HEXAGONAL_SHAPES).reduce(((e,[t,i])=>(e[i]=c.i18n.localize(`TOKEN.HEXAGONAL_SHAPE_${t}`),e)),{}),showHexagonalShapes:this.isPrototype||!r.parent||r.parent.grid.isHexagonal,actors:c.actors.reduce(((e,t)=>t.isOwner?(e.push({_id:t.id,name:t.name}),e):e),[]).sort(((e,t)=>e.name.localeCompare(t.name,c.i18n.lang))),dispositions:Object.entries(CONST.TOKEN_DISPOSITIONS).reduce(((e,t)=>(e[t[1]]=c.i18n.localize(`TOKEN.DISPOSITION.${t[0]}`),e)),{}),lightAnimations:g.Canvas.lightAnimations,isGM:c.user.isGM,randomImgEnabled:this.isPrototype&&(o||r.randomImg),scale:Math.abs(r.texture.scaleX),mirrorX:r.texture.scaleX<0,mirrorY:r.texture.scaleY<0,textureFitModes:CONST.TEXTURE_DATA_FIT_MODES.reduce(((e,t)=>(e[t]=c.i18n.localize(`TEXTURE_DATA.FIT.${t}`),e)),{}),ringEffectsInput:this.#Gl.bind(this)}}async _renderInner(...e){return await loadTemplates(["templates/scene/parts/token-lighting.hbs","templates/scene/parts/token-vision.html","templates/scene/parts/token-resources.html"]),super._renderInner(...e)}#Gl(e,t){const i=[],n=[];for(const[e,s]of Object.entries(g.Token.ring.ringClass.effects)){const o=g.Token.ring.effects[e];"DISABLED"!==e&&"ENABLED"!==e&&o&&(i.push({value:e,label:c.i18n.localize(o)}),t.value&s&&n.push(e))}return Object.assign(t,{name:e.fieldPath,options:i,value:n,type:"checkboxes"}),foundry.applications.fields.createMultiSelectInput(t)}async _getAlternateTokenImages(){if(!this.actor?.prototypeToken.randomImg)return{};return(await this.actor.getTokenImages()).reduce(((e,t)=>(e[t]=t.split("/").pop(),e)),{})}activateListeners(e){super.activateListeners(e),e.find(".action-button").click(this._onClickActionButton.bind(this)),e.find(".bar-attribute").change(this._onBarChange.bind(this)),e.find(".alternate-images").change((e=>e.target.form["texture.src"].value=e.target.value)),e.find("button.assign-token").click(this._onAssignToken.bind(this)),this._disableEditImage()}async close(e={}){const t=Application.RENDER_STATES;(e.force||[t.RENDERED,t.ERROR].includes(this._state))&&this._resetPreview(),await super.close(e),this.isPrototype&&delete this.object.actor.apps?.[this.appId]}_getSubmitData(e={}){const t=foundry.utils.expandObject(super._getSubmitData(e));if(this.document instanceof foundry.data.PrototypeToken&&(Object.assign(t,t.prototypeToken),delete t.prototypeToken),"scale"in t&&(t.texture.scaleX=t.scale*(t.mirrorX?-1:1),t.texture.scaleY=t.scale*(t.mirrorY?-1:1)),["scale","mirrorX","mirrorY"].forEach((e=>delete t[e])),Array.isArray(t.ring?.effects)){const e=g.Token.ring.ringClass.effects;let i=t.ring.enabled?e.ENABLED:e.DISABLED;for(const n of t.ring.effects){i|=e[n]??0}t.ring.effects=i}return t.detectionModes??=[],t.bar1.attribute||=null,t.bar2.attribute||=null,foundry.utils.flattenObject(t)}async _onChangeInput(e){await super._onChangeInput(e),this._disableEditImage();const t=e.target;if("sight.visionMode"===t.name){const e=g.Canvas.visionModes[t.value]?.vision?.defaults||{},update=t=>{const i=this.form.querySelector(`[name="sight.${t}"]`);if(t in e){const n=e[t];if(void 0===n)return;if("checkbox"===i.type)i.checked=n;else if("range"===i.type){i.value=n;const e=i.parentNode.querySelector(".range-value");e&&(e.innerText=n)}else if(i.classList.contains("color")){i.value=n;const e=i.parentNode.querySelector('input[type="color"]');e&&(e.value=n)}else i.value=n}};for(const e of["color","attenuation","brightness","saturation","contrast"])update(e)}const i=this._getSubmitData();this._previewChanges(i)}_previewChanges(e){this.preview&&(e&&(delete(e={...e}).actorId,delete e.actorLink,this.preview.updateSource(e)),this.isPrototype||!1!==this.preview.object?.destroyed||(this.preview.object.initializeSources(),this.preview.object.renderFlags.set({refresh:!0})))}_resetPreview(){if(this.preview){if(this.isPrototype)return this.preview=null;!1===this.preview.object?.destroyed&&this.preview.object.destroy({children:!0}),this.preview.baseActor?._unregisterDependentToken(this.preview),this.preview=null,!1===this.document.object?.destroyed&&(this.document.object.renderable=!0,this.document.object.initializeSources(),this.document.object.control(),this.document.object.renderFlags.set({refresh:!0}))}}async _updateObject(e,t){return this._resetPreview(),this.token.update(t)}async _onAssignToken(e){e.preventDefault();let t=canvas.ready?canvas.tokens.controlled:[];if(1!==t.length)return void ui.notifications.warn("TOKEN.AssignWarn",{localize:!0});const i=t.pop().document.toObject();i.tokenId=i.x=i.y=null,i.randomImg=this.form.elements.randomImg.checked,i.randomImg&&delete i.texture.src,await this.actor.update({prototypeToken:i},{diff:!1,recursive:!1,noHook:!0}),ui.notifications.info(c.i18n.format("TOKEN.AssignSuccess",{name:this.actor.name}))}async _onBarChange(e){const t=e.target.form,i=(this.preview??this.document).getBarAttribute("",{alternative:e.target.value}),n=e.target.name.split(".").shift();t.querySelector(`input.${n}-value`).value=null!==i?i.value:"",t.querySelector(`input.${n}-max`).value=null!==i&&"bar"===i.type?i.max:""}_onClickActionButton(e){e.preventDefault();const t=e.currentTarget,i=t.dataset.action;c.tooltip.deactivate();const n=Object.values(foundry.utils.expandObject(this._getSubmitData())?.detectionModes||{});switch(i){case"addDetectionMode":this._onAddDetectionMode(n);break;case"removeDetectionMode":const e=t.closest(".detection-mode").dataset.index;this._onRemoveDetectionMode(Number(e),n)}this._previewChanges({detectionModes:n}),this.render()}_onAddDetectionMode(e){e.push({id:"",range:0,enabled:!0})}_onRemoveDetectionMode(e,t){t.splice(e,1)}_disableEditImage(){const e=this.form.querySelector('[name="texture.src"]'),t=this.form.querySelector('[name="randomImg"]');t&&(e.disabled=!c.user.hasPermission("FILES_BROWSE")&&t.checked)}}class DefaultTokenConfig extends TokenConfig{constructor(e,t){const i=c.settings.get("core",DefaultTokenConfig.SETTING);super(new(getDocumentClass("Token"))({name:"Default Token",...i},{strict:!1}),t)}static SETTING="defaultToken";static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"templates/scene/default-token-config.html",sheetConfig:!1})}get id(){return"default-token-config"}get title(){return c.i18n.localize("SETTINGS.DefaultTokenN")}get isEditable(){return c.user.can("SETTINGS_MODIFY")}_canUserView(e){return e.can("SETTINGS_MODIFY")}async getData(e={}){const t=await super.getData(e);return Object.assign(t,{object:this.token.toObject(!1),isDefault:!0,barAttributes:TokenDocument.implementation.getTrackedAttributeChoices(),bar1:this.token.bar1,bar2:this.token.bar2})}_getSubmitData(e={}){const t=foundry.utils.expandObject(super._getSubmitData(e));return t.light.color=t.light.color||void 0,t.bar1.attribute=t.bar1.attribute||null,t.bar2.attribute=t.bar2.attribute||null,t}async _updateObject(e,t){try{this.object.updateSource(t),t=foundry.utils.filterObject(this.token.toObject(),t)}catch(e){Hooks$1.onError("DefaultTokenConfig#_updateObject",e,{notify:"error"})}const i=foundry.documents.BaseToken.cleanData(),n=foundry.utils.diffObject(i,t);return await c.settings.set("core",DefaultTokenConfig.SETTING,n),SettingsConfig.reloadConfirm({world:!0})}activateListeners(e){super.activateListeners(e),e.find('button[data-action="reset"]').click(this.reset.bind(this))}async reset(){const e=getDocumentClass("Token");this.object=new e({},{strict:!1}),this.token=this.object,this.render()}async _onBarChange(){}_onAddDetectionMode(e){super._onAddDetectionMode(e),this.document.updateSource({detectionModes:e})}_onRemoveDetectionMode(e,t){super._onRemoveDetectionMode(e,t),this.document.updateSource({detectionModes:t})}}class WallConfig extends DocumentSheet{static get defaultOptions(){const e=super.defaultOptions;return e.classes.push("wall-config"),e.template="templates/scene/wall-config.html",e.width=400,e.height="auto",e}editTargets=[];get title(){return this.editTargets.length>1?c.i18n.localize("WALLS.TitleMany"):super.title}render(e,t){return t?.walls instanceof Array&&(this.editTargets=t.walls.map((e=>e.id))),super.render(e,t)}getData(e={}){const t=super.getData(e);return t.source=this.document.toObject(),t.p0={x:this.object.c[0],y:this.object.c[1]},t.p1={x:this.object.c[2],y:this.object.c[3]},t.gridUnits=this.document.parent.grid.units||c.i18n.localize("GridUnits"),t.moveTypes=Object.keys(CONST.WALL_MOVEMENT_TYPES).reduce(((e,t)=>(e[CONST.WALL_MOVEMENT_TYPES[t]]=c.i18n.localize(`WALLS.SenseTypes.${t}`),e)),{}),t.senseTypes=Object.keys(CONST.WALL_SENSE_TYPES).reduce(((e,t)=>(e[CONST.WALL_SENSE_TYPES[t]]=c.i18n.localize(`WALLS.SenseTypes.${t}`),e)),{}),t.dirTypes=Object.keys(CONST.WALL_DIRECTIONS).reduce(((e,t)=>(e[CONST.WALL_DIRECTIONS[t]]=c.i18n.localize(`WALLS.Directions.${t}`),e)),{}),t.doorTypes=Object.keys(CONST.WALL_DOOR_TYPES).reduce(((e,t)=>(e[CONST.WALL_DOOR_TYPES[t]]=c.i18n.localize(`WALLS.DoorTypes.${t}`),e)),{}),t.doorStates=Object.keys(CONST.WALL_DOOR_STATES).reduce(((e,t)=>(e[CONST.WALL_DOOR_STATES[t]]=c.i18n.localize(`WALLS.DoorStates.${t}`),e)),{}),t.doorSounds=g.Wall.doorSounds,t.isDoor=this.object.isDoor,t}activateListeners(e){return e.find(".audio-preview").click(this.#tl.bind(this)),this.#jl(this.document.door>CONST.WALL_DOOR_TYPES.NONE),this.#$l(),super.activateListeners(e)}#il=0;#tl(e){const t=this.form.doorSound.value,i=g.Wall.doorSounds[t];if(!i)return;const n=CONST.WALL_DOOR_INTERACTIONS;let s=i[n[this.#il++%n.length]];if(!s)return;Array.isArray(s)||(s=[s]);const o=s[Math.floor(Math.random()*s.length)];c.audio.play(o,{context:c.audio.interface})}async _onChangeInput(e){return"door"===e.currentTarget.name?this.#jl(Number(e.currentTarget.value)>CONST.WALL_DOOR_TYPES.NONE):"doorSound"===e.currentTarget.name?this.#il=0:["light","sight","sound"].includes(e.currentTarget.name)&&this.#$l(),super._onChangeInput(e)}#jl(e){const t=this.form.querySelector(".door-options");t.disabled=!e,t.classList.toggle("hidden",!e),this.setPosition({height:"auto"})}#$l(){const e=this.form,t=[CONST.WALL_SENSE_TYPES.PROXIMITY,CONST.WALL_SENSE_TYPES.DISTANCE];for(const i of["light","sight","sound"]){const n=e[i];n.parentElement.querySelector(".proximity").classList.toggle("hidden",!t.includes(Number(n.value)))}}_getSubmitData(e={}){const t=[CONST.WALL_SENSE_TYPES.PROXIMITY,CONST.WALL_SENSE_TYPES.DISTANCE],i=super._getSubmitData(e);for(const e of["light","sight","sound"])t.includes(i[e])||(i[`threshold.${e}`]=null);return i}async _updateObject(e,t){if(this.editTargets.length>1){const e=canvas.scene.walls.reduce(((e,i)=>(this.editTargets.includes(i.id)&&e.push(foundry.utils.mergeObject(i.toJSON(),t)),e)),[]);return canvas.scene.updateEmbeddedDocuments("Wall",e,{sound:!1})}if(this.object.id)return this.object.update(t,{sound:!1})}}class ChatPopout extends Application{constructor(e,t){super(t),this.message=e,this.message.apps[this.appId]=this}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{width:300,height:"auto",classes:["chat-popout"]})}get id(){return`chat-popout-${this.message.id}`}get title(){let e=this.message.flavor??this.message.speaker.alias;return TextEditor$1.previewHTML(e,32)}async _renderInner(e){const t=await this.message.getHTML();return t.find(".message-delete").remove(),t}}class SettingsConfig extends PackageConfiguration{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{title:c.i18n.localize("SETTINGS.Title"),id:"client-settings",categoryTemplate:"templates/sidebar/apps/settings-config-category.html",submitButton:!0})}_prepareCategoryData(){const e=c.settings,t=c.user.can("SETTINGS_MODIFY");let i=new Map,n=0;const getCategory=e=>{let t=i.get(e.id);return t||(t={id:e.id,title:e.title,menus:[],settings:[],count:0},i.set(e.id,t)),t};for(let i of e.menus.values()){if(i.restricted&&!t)continue;if("core.permissions"===i.key&&!c.user.hasRole("GAMEMASTER"))continue;getCategory(this._categorizeEntry(i.namespace)).menus.push(i),n++}for(let i of e.settings.values()){if(!i.config||!t&&"client"!==i.scope)continue;const e=foundry.utils.deepClone(i);e.id=`${e.namespace}.${e.key}`,e.name=c.i18n.localize(e.name),e.hint=c.i18n.localize(e.hint),e.value=c.settings.get(e.namespace,e.key),e.type=i.type instanceof Function?i.type.name:"String",e.isCheckbox=i.type===Boolean,e.isSelect=void 0!==e.choices,e.isRange=i.type===Number&&e.range,e.isNumber=i.type===Number,e.filePickerType=!0===e.filePicker?"any":e.filePicker,e.dataField=i.type instanceof foundry.data.fields.DataField?i.type:null,e.input=i.input;getCategory(this._categorizeEntry(i.namespace)).settings.push(e),n++}for(let e of i.values())e.count=e.menus.length+e.settings.length;return i=Array.from(i.values()).sort(this._sortCategories.bind(this)),{categories:i,total:n,user:c.user,canConfigure:t}}activateListeners(e){super.activateListeners(e),e.find(".submenu button").click(this._onClickSubmenu.bind(this)),e.find('[name="core.fontSize"]').change(this._previewFontScaling.bind(this))}_onClickSubmenu(e){e.preventDefault();const t=c.settings.menus.get(e.currentTarget.dataset.key);if(!t)return ui.notifications.error("No submenu found for the provided key");return(new t.type).render(!0)}_previewFontScaling(e){const t=Number(e.currentTarget.value);c.scaleFonts(t),this.setPosition()}async close(e={}){return c.scaleFonts(),super.close(e)}async _updateObject(e,t){let i=!1,n=!1;for(let[e,s]of Object.entries(foundry.utils.flattenObject(t))){let t=c.settings.settings.get(e);s!==c.settings.get(t.namespace,t.key)&&(i||="client"===t.scope&&t.requiresReload,n||="world"===t.scope&&t.requiresReload,await c.settings.set(t.namespace,t.key,s))}(i||n)&&this.constructor.reloadConfirm({world:n})}_onResetDefaults(e){e.preventDefault();const t=this.element.find("form")[0];for(let[e,i]of c.settings.settings.entries()){if(!i.config)continue;const n=t[e];n&&("checkbox"===n.type?n.checked=i.default:n.value=i.default,$(n).change())}ui.notifications.info("SETTINGS.ResetInfo",{localize:!0})}static async reloadConfirm({world:e=!1}={}){await foundry.applications.api.DialogV2.confirm({id:"reload-world-confirm",modal:!0,rejectClose:!1,window:{title:"SETTINGS.ReloadPromptTitle"},position:{width:400},content:`<p>${c.i18n.localize("SETTINGS.ReloadPromptBody")}</p>`})&&(e&&c.user.can("SETTINGS_MODIFY")&&c.socket.emit("reload"),foundry.utils.debouncedReload())}}class Compendium extends DocumentDirectory{constructor(...e){e[0]instanceof Collection&&(foundry.utils.logCompatibilityWarning("Compendium constructor should now be passed a CompendiumCollection instance via {collection: compendiumCollection}",{since:11,until:13}),e[1]||={},e[1].collection=e.shift()),super(...e)}get entryType(){return this.metadata.type}static entryPartial="templates/sidebar/partials/compendium-index-partial.html";static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"templates/apps/compendium.html",width:350,height:window.innerHeight-100,top:70,left:120,popOut:!0})}get id(){return`compendium-${this.collection.collection}`}get title(){const e=c.i18n.localize(this.collection.title);return this.collection.locked?`${e} [${c.i18n.localize("PACKAGE.Locked")}]`:e}get tabName(){return"Compendium"}get canCreateEntry(){const e=getDocumentClass(this.collection.documentName),t=this.collection.testUserPermission(c.user,"OWNER");return!this.collection.locked&&t&&e.canUserCreate(c.user)}get canCreateFolder(){return this.canCreateEntry}get metadata(){return this.collection.metadata}initialize(){this.collection.initializeTree()}render(e,t){return this.collection.visible?super.render(e,t):(e&&ui.notifications.warn("COMPENDIUM.CannotViewWarning",{localize:!0}),this)}async getData(e={}){const t=await super.getData(e);return foundry.utils.mergeObject(t,{collection:this.collection,index:this.collection.index,name:c.i18n.localize(this.metadata.label),footerButtons:[]})}_entryAlreadyExists(e){return e.pack===this.collection.collection&&this.collection.index.has(e.id)}async _createDroppedEntry(e,t){return e=e.clone({folder:t||null},{keepId:!0}),this.collection.importDocument(e)}_getEntryDragData(e){return{type:this.collection.documentName,uuid:this.collection.getUuid(e)}}_onCreateEntry(e){if("Adventure"===this.collection.documentName){const e=new Adventure({name:"New Adventure"},{pack:this.collection.collection});return new g.Adventure.exporterClass(e).render(!0)}return super._onCreateEntry(e)}_getFolderDragData(e){const t=this.collection.folders.get(e);return t?{type:"Folder",uuid:t.uuid}:null}_getFolderContextOptions(){const e=["OWNERSHIP.Configure","FOLDER.Export"];return super._getFolderContextOptions().filter((t=>!e.includes(t.name)))}_getEntryContextOptions(){const e="Adventure"===this.collection.documentName;return[{name:"COMPENDIUM.ImportEntry",icon:'<i class="fas fa-download"></i>',condition:()=>!e&&this.collection.documentClass.canUserCreate(c.user),callback:e=>{const t=c.collections.get(this.collection.documentName),i=e.data("document-id");return t.importFromCompendium(this.collection,i,{},{renderSheet:!0})}},{name:"ADVENTURE.ExportEdit",icon:'<i class="fa-solid fa-edit"></i>',condition:()=>e&&c.user.isGM&&!this.collection.locked,callback:async e=>{const t=e.data("document-id"),i=await this.collection.getDocument(t);return new g.Adventure.exporterClass(i.clone({},{keepId:!0})).render(!0)}},{name:"SCENES.GenerateThumb",icon:'<i class="fas fa-image"></i>',condition:()=>!this.collection.locked&&"Scene"===this.collection.documentName,callback:async e=>{const t=await this.collection.getDocument(e.data("document-id"));t.createThumbnail().then((e=>{t.update({thumb:e.thumb},{diff:!1}),ui.notifications.info(c.i18n.format("SCENES.GenerateThumbSuccess",{name:t.name}))})).catch((e=>ui.notifications.error(e.message)))}},{name:"COMPENDIUM.DeleteEntry",icon:'<i class="fas fa-trash"></i>',condition:()=>c.user.isGM&&!this.collection.locked,callback:async e=>{const t=e.data("document-id");return(await this.collection.getDocument(t)).deleteDialog()}}]}}class DependencyResolution extends FormApplication{constructor(e,t,i={}){super(t,i),this.#qe=e,this.#Hl.set(t.id,t),i.enabling?this.#zl():this.#Vl()}#Wl=new Set;#Xl=new Map;#qe;#Hl=new Map;#Yl=new Map;get needsResolving(){return this.options.enabling?this.#Wl.size>0:this.#Wl.size>1||!!this.#Kl()}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{enabling:!0,template:"templates/setup/impacted-dependencies.html"})}getData(e={}){const t=[],i=[];let n;if(this.options.enabling){const e=this.#ql();t.push(...e.required),i.push(...e.optional)}else i.push(...this.#Jl()),n=this.#Kl();return{required:t,optional:i,subtypes:n,enabling:this.options.enabling}}activateListeners(e){super.activateListeners(e),e.find('input[type="checkbox"]').on("change",this._onChangeCheckbox.bind(this)),e.find("[data-action]").on("click",this._onAction.bind(this))}async _render(e,t){await super._render(e,t),this.setPosition({height:"auto"})}_onChangeCheckbox(e){const t=e.currentTarget,i=this.#Hl.get(t.name),n=t.checked;this.#Yl.get(i).checked=n,this.render()}_onAction(e){if("cancel"===e.currentTarget.dataset.action)this.close()}_getSubmitData(e={}){const t=new FormDataExtended(this.form,{disabled:!0});return foundry.utils.mergeObject(t.object,e)}async _updateObject(e,t){t[this.object.id]=!0,this.#qe._onSelectDependencies(t,this.options.enabling)}_getRootRequiredBy(){const e=new Set;if(this.options.enabling)return e;const t=this.#Xl.get(this.object);for(const i of t??[])i.relationships.requires.find((({id:e})=>e===this.object.id))&&e.add(i);return e}#Ql(){const addDependent=(e,t)=>{if(!(t=this.#Hl.get(t.id)))return;this.#Xl.has(t)||this.#Xl.set(t,new Set);this.#Xl.get(t).add(e)};for(const e of this.#Hl.values()){for(const t of e.relationships.requires)addDependent(e,t);for(const t of e.relationships.recommends)addDependent(e,t)}}#Zl(e=new Set){const t=new Map,addDependency=(e,{required:i=!1,reason:n,dependent:s}={})=>{t.has(e)||t.set(e,{module:e,checked:!0});const o=t.get(e);o.required||(o.required=i),n&&(o.reason&&(o.reason+="<br>"),o.reason+=`${s.title}: ${n}`)},addDependencies=(i,n,s=!1)=>{for(const{id:o,reason:r}of n){const n=this.#Hl.get(o);if(!n)continue;const a=t.get(n);(!a||!0!==a.required&&a.required!==s)&&(addDependency(n,{reason:r,required:s,dependent:i}),e.has(n)||(addDependencies(n,n.relationships.requires,!0),addDependencies(n,n.relationships.recommends)))}};return addDependencies(this.object,this.object.relationships.requires,!0),addDependencies(this.object,this.object.relationships.recommends),t}#ec(e){const t=new Set;for(const i of this.#Hl.values()){const n=this.#Xl.get(i);if(!n)continue;n.difference(e).size||t.add(i)}return t}#Vl(){const e=new Set([this.object]);for(const e of c.modules)this.#qe._isModuleChecked(e.id)&&this.#Hl.set(e.id,e);this.#Ql();for(let t=0;t<100;t++){const t=this.#ec(e);if(!t.size)break;t.forEach(e.add,e)}this.#Wl=e;for(const t of e)this.#Yl.set(t,{module:t,checked:!0,required:!1})}#zl(){for(const e of c.modules)this.#qe._isModuleChecked(e.id)||this.#Hl.set(e.id,e);this.#Yl=this.#Zl();for(const e of this.#Yl.keys())this.#Wl.add(e)}#tc(){const e=new Set([this.object]);for(const t of this.#Wl){const{checked:i}=this.#Yl.get(t);i&&e.add(t)}return e}#ql(){const e=Array.from(this.#Yl.values()).reduce(((e,t)=>(!1===t.checked&&e.add(t.module),e)),new Set),t=this.#Zl(e),i=[],n=[];for(const e of this.#Wl){if(!t.has(e))continue;const s=this.#Yl.get(e);s.required?i.push(s):n.push(s)}return{required:i,optional:n}}#Jl(){const e=this.#ec(this.#tc()),t=[];for(const i of this.#Wl)e.has(i)&&t.push(this.#Yl.get(i));return t}#Kl(){const e={};for(const t of this.#tc()){const i=c.issues.getSubTypeCountsFor(t);i&&Object.entries(i).forEach((([t,i])=>{const n=e[t]??={};Object.entries(i).forEach((([e,t])=>{n[e]=(n[e]??0)+t}))}))}return this.#qe._formatDocumentSummary(e,!0)}}class InvitationLinks extends Application{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"invitation-links",template:"templates/sidebar/apps/invitation-links.html",title:c.i18n.localize("INVITATIONS.Title"),width:400})}async getData(e={}){let t=c.data.addresses;return void 0===t.remote||(null==t.remoteIsAccessible?(t.remoteClass="unknown-connection",t.remoteTitle=c.i18n.localize("INVITATIONS.UnknownConnection"),t.failedCheck=!0):t.remoteIsAccessible?(t.remoteClass="connection",t.remoteTitle=c.i18n.localize("INVITATIONS.OpenConnection"),t.canConnect=!0):(t.remoteClass="no-connection",t.remoteTitle=c.i18n.localize("INVITATIONS.ClosedConnection"),t.canConnect=!1)),t}activateListeners(e){super.activateListeners(e),e.find(".invite-link").click((e=>{e.preventDefault(),e.target.select(),c.clipboard.copyPlainText(e.currentTarget.value),ui.notifications.info("INVITATIONS.Copied",{localize:!0})})),e.find(".refresh").click((e=>{e.preventDefault();e.currentTarget.className="fas fa-sync fa-pulse";let t=this;setTimeout((function(){c.socket.emit("refreshAddresses",(e=>{c.data.addresses=e,t.render(!0)}))}),250)})),e.find(".show-hide").click((e=>{e.preventDefault();const t=e.currentTarget,i=t.classList.contains("show-link");i?(t.classList.replace("fa-eye","fa-eye-slash"),t.classList.replace("show-link","hide-link")):(t.classList.replace("fa-eye-slash","fa-eye"),t.classList.replace("hide-link","show-link")),t.closest("form").querySelector("#remote-link").type=i?"text":"password"}))}}class KeybindingsConfig extends PackageConfiguration{#ic;#nc=new Map;static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{title:c.i18n.localize("SETTINGS.Keybindings"),id:"keybindings",categoryTemplate:"templates/sidebar/apps/keybindings-config-category.html",scrollY:[".scrollable"]})}static get categoryOrder(){const e=super.categoryOrder;return e.splice(2,0,"core-mouse"),e}_categorizeEntry(e){const t=super._categorizeEntry(e);return"core"===e&&(t.title=c.i18n.localize("KEYBINDINGS.CoreKeybindings")),t}_prepareCategoryData(){if(this.#ic)return this.#ic;let e=new Map,t=0;const i=KeyboardManager.CONTROL_KEY_STRING;for(let[n,s]of c.keybindings.actions){if(s.restricted&&!c.user.isGM)continue;t++;let o=this._categorizeEntry(s.namespace);const r=foundry.utils.deepClone(s);r.category=o.title,r.id=n,r.name=c.i18n.localize(s.name),r.hint=c.i18n.localize(s.hint),r.cssClass=s.restricted?"gm":"",r.notes=[s.restricted?c.i18n.localize("KEYBINDINGS.Restricted"):"",s.reservedModifiers.length>0?c.i18n.format("KEYBINDINGS.ReservedModifiers",{modifiers:s.reservedModifiers.map((e=>"Control"===e?i:e.titleCase())).join(", ")}):"",c.i18n.localize(s.hint)].filterJoin("<br>"),r.uneditable=s.uneditable,r.bindings=(c.keybindings.bindings.get(n)??[]).map(((e,t)=>{const i=s.uneditable.includes(e),o=foundry.utils.deepClone(e);o.id=`${n}.binding.${t}`,o.display=KeybindingsConfig._humanizeBinding(o),o.cssClasses=i?"uneditable":"",o.isEditable=!i,o.isFirst=0===t;const r=this._detectConflictingActions(n,s,o);return o.conflicts=c.i18n.format("KEYBINDINGS.Conflict",{conflicts:r.map((e=>c.i18n.localize(e.name))).join(", ")}),o.hasConflicts=r.length>0,o})),r.noBindings=0===r.bindings.length,e.has(o.id)?e.get(o.id).actions.push(r):e.set(o.id,{id:o.id,title:o.title,actions:[r],count:0})}t+=this._addMouseControlsReference(e);for(let t of e.values())t.actions=t.actions.sort(ClientKeybindings._compareActions),t.count=t.actions.length;return e=Array.from(e.values()).sort(this._sortCategories.bind(this)),this.#ic={categories:e,total:t}}_addMouseControlsReference(e){let t=c.i18n.localize("KEYBINDINGS.CoreMouse");const i=[["canvas-select","CONTROLS.CanvasSelect",["CONTROLS.LeftClick"]],["canvas-select-many","CONTROLS.CanvasSelectMany",["Shift","CONTROLS.LeftClick"]],["canvas-drag","CONTROLS.CanvasLeftDrag",["CONTROLS.LeftClick","CONTROLS.Drag"]],["canvas-select-cancel","CONTROLS.CanvasSelectCancel",["CONTROLS.RightClick"]],["canvas-pan-mouse","CONTROLS.CanvasPan",["CONTROLS.RightClick","CONTROLS.Drag"]],["canvas-zoom","CONTROLS.CanvasSelectCancel",["CONTROLS.MouseWheel"]],["ruler-measure","CONTROLS.RulerMeasure",[KeyboardManager.CONTROL_KEY_STRING,"CONTROLS.LeftDrag"]],["ruler-measure-waypoint","CONTROLS.RulerWaypoint",[KeyboardManager.CONTROL_KEY_STRING,"CONTROLS.LeftClick"]],["object-sheet","CONTROLS.ObjectSheet",[`${c.i18n.localize("CONTROLS.Double")} ${c.i18n.localize("CONTROLS.LeftClick")}`]],["object-hud","CONTROLS.ObjectHUD",["CONTROLS.RightClick"]],["object-config","CONTROLS.ObjectConfig",[`${c.i18n.localize("CONTROLS.Double")} ${c.i18n.localize("CONTROLS.RightClick")}`]],["object-drag","CONTROLS.ObjectDrag",["CONTROLS.LeftClick","CONTROLS.Drag"]],["object-no-snap","CONTROLS.ObjectNoSnap",["CONTROLS.Drag","Shift","CONTROLS.Drop"]],["object-drag-cancel","CONTROLS.ObjectDragCancel",[`${c.i18n.localize("CONTROLS.RightClick")} ${c.i18n.localize("CONTROLS.During")} ${c.i18n.localize("CONTROLS.Drag")}`]],["object-rotate-slow","CONTROLS.ObjectRotateSlow",[KeyboardManager.CONTROL_KEY_STRING,"CONTROLS.MouseWheel"]],["object-rotate-fast","CONTROLS.ObjectRotateFast",["Shift","CONTROLS.MouseWheel"]],["place-hidden-token","CONTROLS.TokenPlaceHidden",["Alt","CONTROLS.Drop"],!0],["token-target-mouse","CONTROLS.TokenTarget",[`${c.i18n.localize("CONTROLS.Double")} ${c.i18n.localize("CONTROLS.RightClick")}`]],["canvas-ping","CONTROLS.CanvasPing",["CONTROLS.LongPress"]],["canvas-ping-alert","CONTROLS.CanvasPingAlert",["Alt","CONTROLS.LongPress"]],["canvas-ping-pull","CONTROLS.CanvasPingPull",["Shift","CONTROLS.LongPress"],!0],["tooltip-lock","CONTROLS.TooltipLock",["CONTROLS.MiddleClick"]],["tooltip-dismiss","CONTROLS.TooltipDismiss",["CONTROLS.RightClick"]]];let n={id:"core-mouse",title:t,actions:i.map((e=>((e,i,n,s=!1)=>({category:t,id:e,name:c.i18n.localize(i),notes:s?c.i18n.localize("KEYBINDINGS.Restricted"):"",bindings:[{display:n.map((e=>c.i18n.localize(e))).join(" + "),cssClasses:"uneditable",isEditable:!1,hasConflicts:!1,isFirst:!1}]}))(...e))),count:0};return n.count=n.actions.length,e.set("core-mouse",n),n.count}_detectConflictingActions(e,t,i){if(e.startsWith("core.")&&t.uneditable.includes(i))return[];const n=KeyboardManager.getKeyboardEventContext({code:i.key,shiftKey:i.modifiers.includes(KeyboardManager.MODIFIER_KEYS.SHIFT),ctrlKey:i.modifiers.includes(KeyboardManager.MODIFIER_KEYS.CONTROL),altKey:i.modifiers.includes(KeyboardManager.MODIFIER_KEYS.ALT),repeat:!1});return KeyboardManager._getMatchingActions(n).filter((t=>t.action!==e))}static _humanizeBinding(e){return e.modifiers.reduce(((t,i)=>(KeyboardManager.MODIFIER_CODES[i]?.includes(e.key)||t.unshift(KeyboardManager.getKeycodeDisplayString(i)),t)),[KeyboardManager.getKeycodeDisplayString(e.key)]).join(" + ")}activateListeners(e){super.activateListeners(e);const t=e.find(".action-bindings");t.on("dblclick",".editable-binding",this._onDoubleClickKey.bind(this)),t.on("click",".control",this._onClickBindingControl.bind(this)),t.on("keydown",".binding-input",this._onKeydownBindingInput.bind(this))}async _onResetDefaults(e){return Dialog.confirm({title:c.i18n.localize("KEYBINDINGS.ResetTitle"),content:`<h4>${c.i18n.localize("AreYouSure")}</h4><p>${c.i18n.localize("KEYBINDINGS.ResetWarning")}</p>`,yes:async()=>{await c.keybindings.resetDefaults(),this.#ic=void 0,this.#nc.clear(),this.render(),ui.notifications.info("KEYBINDINGS.ResetSuccess",{localize:!0})},no:()=>{},defaultYes:!1})}_onClickBindingControl(e){switch(e.currentTarget.dataset.action){case"add":this._onClickAdd(e);break;case"delete":this._onClickDelete(e);break;case"edit":return this._onClickEditableBinding(e);case"save":return this._onClickSaveBinding(e)}}async _onClickAdd(e){const{actionId:t,namespace:i,action:n}=this._getParentAction(e),{bindingHtml:s,bindingId:o}=this._getParentBinding(e),r=`${i}.${n}.binding.${c.keybindings.bindings.get(t).length}`,a=`<li class="binding flexrow inserted" data-binding-id="${r}">\n          <div class="editable-binding">\n              <div class="form-fields binding-fields">\n                  <input type="text" class="binding-input" name="${r}" id="${r}" placeholder="Control + 1">\n                  <i class="far fa-keyboard binding-input-icon"></i>\n              </div>\n          </div>\n          <div class="binding-controls flexrow">\n            <a class="control save-edit" title="${c.i18n.localize("KEYBINDINGS.SaveBinding")}" data-action="save"><i class="fas fa-save"></i></a>\n            <a class="control" title="${c.i18n.localize("KEYBINDINGS.DeleteBinding")}" data-action="delete"><i class="fas fa-trash-alt"></i></a>\n          </div>\n      </li>`;s.closest(".action-bindings").insertAdjacentHTML("beforeend",a),document.getElementById(r).focus(),"empty"===o&&s.remove()}async _onClickDelete(e){const{namespace:t,action:i}=this._getParentAction(e),{bindingId:n}=this._getParentBinding(e),s=Number.parseInt(n.split(".")[3]);this._addPendingEdit(t,i,s,{index:s,key:null}),await this._savePendingEdits()}_addPendingEdit(e,t,i,n){const s=`${e}.${t}`;if(this.#nc.has(s)){let e=this.#nc.get(s).filter((e=>e.index!==i));e.push(n),this.#nc.set(s,e)}else this.#nc.set(s,[n])}_onClickEditableBinding(e){const t=e.currentTarget,i=t.closest("li.binding");t.classList.toggle("hidden"),i.querySelector(".save-edit").classList.toggle("hidden");for(let e of i.querySelectorAll(".editable-binding"))e.classList.toggle("hidden"),e.getElementsByClassName("binding-input")[0]?.focus()}_onDoubleClickKey(e){const t=e.currentTarget;if(t.parentNode.parentNode.classList.contains("inserted"))return;for(let e of t.parentNode.getElementsByClassName("editable-binding"))e.classList.toggle("hidden"),e.getElementsByClassName("binding-input")[0]?.focus();const i=t.closest(".binding");for(let e of i.getElementsByClassName("save-edit"))e.classList.toggle("hidden")}async _onClickSaveBinding(e){await this._savePendingEdits()}_getParentAction(e){const t=e.currentTarget.closest(".action"),i=t.dataset.actionId;let[n,...s]=i.split(".");return s=s.join("."),{actionId:i,actionHtml:t,namespace:n,action:s}}_getParentBinding(e){const t=e.currentTarget.closest(".binding");return{bindingHtml:t,bindingId:t.dataset.bindingId}}async _savePendingEdits(){for(let[e,t]of this.#nc){let[i,...n]=e.split(".");n=n.join(".");const s=c.keybindings.bindings.get(e),o=c.keybindings.actions.get(e),r=[];for(const[e,t]of s.entries()){if(o.uneditable.includes(t))continue;const{key:i,modifiers:n}=t;r[e]={key:i,modifiers:n}}for(const e of t){const{index:t,key:i,modifiers:n}=e;r[t]={key:i,modifiers:n}}try{await c.keybindings.set(i,n,r.filter((e=>!!e?.key)))}catch(e){ui.notifications.error(e)}}this.#ic=void 0,this.#nc.clear(),this.render()}_onKeydownBindingInput(e){const t=KeyboardManager.getKeyboardEventContext(e);e.preventDefault(),e.stopPropagation();const{bindingHtml:i,bindingId:n}=this._getParentBinding(e),{namespace:s,action:o}=this._getParentAction(e),r=n.split("."),a=Number.parseInt(r[r.length-1]),{MODIFIER_KEYS:l,MODIFIER_CODES:d}=KeyboardManager;let u={index:a,key:t.key,modifiers:[]};t.isAlt&&!d[l.ALT].includes(t.key)&&u.modifiers.push(l.ALT),t.isShift&&!d[l.SHIFT].includes(t.key)&&u.modifiers.push(l.SHIFT),t.isControl&&!d[l.CONTROL].includes(t.key)&&u.modifiers.push(l.CONTROL),this._addPendingEdit(s,o,a,u);const h=this._detectConflictingActions(`${s}.${o}`,c.keybindings.actions.get(`${s}.${o}`),u),p=c.i18n.format("KEYBINDINGS.Conflict",{conflicts:h.map((e=>c.i18n.localize(e.name))).join(", ")});for(const e of i.getElementsByClassName("conflicts"))e.remove();if(h.length>0){const e=`<div class="control conflicts" title="${p}"><i class="fas fa-exclamation-triangle"></i></div>`;i.getElementsByClassName("binding-controls")[0].insertAdjacentHTML("afterbegin",e)}e.currentTarget.value=this.constructor._humanizeBinding(u)}}class ModuleManagement extends FormApplication{constructor(...e){super(...e),this._filter=this.isEditable?"all":"active",this._expanded=!0}static CONFIG_SETTING="moduleConfiguration";static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{title:c.i18n.localize("MODMANAGE.Title"),id:"module-management",template:"templates/sidebar/apps/module-management.html",popOut:!0,width:680,height:"auto",scrollY:[".package-list"],closeOnSubmit:!1,filters:[{inputSelector:'input[name="search"]',contentSelector:".package-list"}]})}get isEditable(){return c.user.can("SETTINGS_MODIFY")}getData(e={}){const t=this.isEditable,i={all:c.modules.size,active:0,inactive:0},n=c.modules.reduce(((e,n)=>{const s=n.active;if(s)i.active++;else{if(!t)return e;i.inactive++}const o=n.toObject();o.active=s,o.css=s?" active":"",o.hasPacks=o.packs.length>0,o.hasScripts=o.scripts.length>0,o.hasStyles=o.styles.length>0,o.systemOnly=o.relationships?.systems.find((e=>e.id===c.system.id)),o.systemTag=c.system.id,o.authors=o.authors.map((e=>e.url?`<a href="${e.url}" target="_blank">${e.name}</a>`:e.name)).join(", "),o.tooltip=null;const r=Array.from(c.world.relationships.requires).concat(Array.from(c.system.relationships.requires));o.required=!!r.find((e=>e.id===o.id)),o.required&&(o.tooltip=c.i18n.localize("MODMANAGE.RequiredModule"));const a=c.i18n.localize("Author"+(n.authors.size>1?"Pl":""));o.labels={authors:a},o.badge=n.getVersionBadge();const l=c.issues.getSubTypeCountsFor(o);return l&&(o.documents=this._formatDocumentSummary(l,s)),o.relationships?.systems.size>0&&!o.systemOnly?e:(o.enableable=!0,this._evaluateDependencies(o),this._evaluateSystemCompatibility(o),o.disabled=o.required||!o.enableable,e.concat([o]))}),[]).sort(((e,t)=>e.title.localeCompare(t.title,c.i18n.lang))),s=t?["all","active","inactive"].map((e=>({id:e,label:c.i18n.localize(`MODMANAGE.Filter${e.titleCase()}`),count:i[e]||0}))):[];return{editable:t,filters:s,modules:n,expanded:this._expanded}}_evaluateDependencies(e){for(const t of e.relationships.requires){if("module"!==t.type)continue;const i=c.modules.get(t.id);if(!i){e.enableable=!1,t.class="error",t.message=c.i18n.localize("SETUP.DependencyNotInstalled");continue}const n=t.compatibility;if(!n)continue;const s=i.version;n.minimum&&foundry.utils.isNewerVersion(n.minimum,s)?(e.enableable=!1,t.class="error",t.message=c.i18n.format("SETUP.CompatibilityRequireUpdate",{version:t.compatibility.minimum})):n.maximum&&foundry.utils.isNewerVersion(s,n.maximum)?(e.enableable=!1,t.class="error",t.message=c.i18n.format("SETUP.CompatibilityRequireDowngrade",{version:t.compatibility.maximum})):n.verified&&!foundry.utils.isNewerVersion(s,n.verified)&&(t.class="warning",t.message=c.i18n.format("SETUP.CompatibilityRiskWithVersion",{version:t.compatibility.verified}))}e.enableable||(e.tooltip=c.i18n.localize("MODMANAGE.DependencyIssues"))}_evaluateSystemCompatibility(e){if(!e.relationships.systems?.length)return;const t=e.relationships.systems.find((e=>e.id===c.system.id)),{minimum:i,maximum:n}=t?.compatibility??{},{version:s}=c.system;(i||n)&&(i&&foundry.utils.isNewerVersion(i,s)&&(e.enableable=!1,e.tooltip=c.i18n.format("MODMANAGE.SystemCompatibilityIssueMinimum",{minimum:i,version:s})),n&&foundry.utils.isNewerVersion(s,n)&&(e.enableable=!1,e.tooltip=c.i18n.format("MODMANAGE.SystemCompatibilityIssueMaximum",{maximum:n,version:s})))}activateListeners(e){super.activateListeners(e),e.find('button[name="deactivate"]').click(this._onDeactivateAll.bind(this)),e.find(".filter").click(this._onFilterList.bind(this)),e.find("button.expand").click(this._onExpandCollapse.bind(this)),e.find('input[type="checkbox"]').change(this._onChangeCheckbox.bind(this)),e.find('input[name="search"]').attr("disabled",!1),e.find("button.expand").attr("disabled",!1),e.find(`a[data-filter="${this._filter}"]`).addClass("active"),this._onExpandCollapse()}async _renderInner(...e){return await loadTemplates(["templates/setup/parts/package-tags.hbs"]),super._renderInner(...e)}_getSubmitData(e={}){const t=super._getSubmitData(e);return delete t.search,t}async _updateObject(e,t){const i=c.settings.get("core",this.constructor.CONFIG_SETTING),n=!foundry.utils.isEmpty(foundry.utils.diffObject(i,t)),s=foundry.utils.mergeObject(i,t),o=c.i18n.getListFormatter();for(let[e,t]of Object.entries(s)){if(!1===t)continue;const i=c.modules.get(e);if(!i){delete s[e];continue}if(!i.relationships?.requires?.size)continue;const n=i.relationships.requires.reduce(((e,t)=>(t.type&&"module"!==t.type||s[t.id]||e.push(t.id),e)),[]);if(n.length){const t=c.i18n.format("MODMANAGE.DepMissing",{module:e,missing:o.format(n)});return this.options.closeOnSubmit=!1,ui.notifications.warn(t)}}return n&&SettingsConfig.reloadConfirm({world:!0}),c.settings.set("core",this.constructor.CONFIG_SETTING,s)}_onSelectDependencies(e,t){for(const[i,n]of Object.entries(e))this.form.elements[i].checked=t?n:!n}async _onChangeCheckbox(e){const t=e.target,i=c.modules.get(t.name),n=t.checked,s=new DependencyResolution(this,i,{enabling:n}),o=s._getRootRequiredBy();if(o.size||s.needsResolving)if(this.form.elements[t.name].checked=!n,o.size){const e=c.i18n.getListFormatter().format(Array.from(o).map((e=>e.title)));ui.notifications.error(c.i18n.format("MODMANAGE.RequiredDepError",{dependents:e}),{console:!1})}else s.render(!0)}_onDeactivateAll(e){e.preventDefault();for(let e of this.element[0].querySelectorAll('input[type="checkbox"]'))e.disabled||(e.checked=!1)}_onExpandCollapse(e){e?.preventDefault(),this._expanded=!this._expanded,this.form.querySelectorAll(".package-description").forEach((e=>e.classList.toggle("hidden",!this._expanded)));const t=this.form.querySelector("i.fa");t.classList.toggle("fa-angle-double-down",this._expanded),t.classList.toggle("fa-angle-double-up",!this._expanded),t.parentElement.title=this._expanded?c.i18n.localize("Collapse"):c.i18n.localize("Expand")}_onFilterList(e){e.preventDefault(),this._filter=e.target.dataset.filter,this.form.querySelectorAll("a[data-filter]").forEach((e=>e.classList.toggle("active",e.dataset.filter===this._filter)));const t=c.settings.get("core",this.constructor.CONFIG_SETTING),i=this.form.querySelector("#module-list");for(const e of i.children){const i=!0===t[e.dataset.moduleId],n="active"===this._filter&&!i||"inactive"===this._filter&&i;e.classList.toggle("hidden",n)}const n=this._searchFilters[0];n.filter(null,n._input.value)}_onSearchFilter(e,t,i,n){const s=c.settings.get("core",this.constructor.CONFIG_SETTING);for(let e of n.children){const n=e.dataset.moduleId,o=!0===s[n];if("active"===this._filter&&!o)continue;if("inactive"===this._filter&&o)continue;if(!t){e.classList.remove("hidden");continue}const r=(e.querySelector(".package-title")?.textContent||"").trim(),a=(e.querySelector(".author")?.textContent||"").trim(),l=i.test(SearchFilter.cleanQuery(n))||i.test(SearchFilter.cleanQuery(r))||i.test(SearchFilter.cleanQuery(a));e.classList.toggle("hidden",!l)}}_formatDocumentSummary(e,t){return Object.entries(e).map((([e,i])=>{let n=0;const s=c.i18n.getListFormatter().format(Object.entries(i).map((([t,i])=>{n+=i;return`<strong>${i}</strong> ${c.i18n.localize(g[e].typeLabels?.[t]??t)}`}))),o=getDocumentClass(e),r=1===n?o.metadata.label:o.metadata.labelPlural;return t?`${s} ${c.i18n.localize(r)}`:`<strong>${n}</strong> ${c.i18n.localize(r)}`})).join(" &bull; ")}_isModuleChecked(e){return!!this.form.elements[e]?.checked}}class SupportDetails extends Application{static get defaultOptions(){const e=super.defaultOptions;return e.title="SUPPORT.Title",e.id="support-details",e.template="templates/sidebar/apps/support-details.html",e.width=780,e.height=680,e.resizable=!0,e.classes=["sheet"],e.tabs=[{navSelector:".tabs",contentSelector:"article",initial:"support"}],e}async getData(e={}){const t=super.getData(e);return t.report=await SupportDetails.generateSupportReport(),t.documentIssues=this._getDocumentValidationErrors(),t.moduleIssues=this._getModuleIssues(),t.clientIssues=Object.values(c.issues.usabilityIssues).map((({message:e,severity:t,params:i})=>({severity:t,message:i?c.i18n.format(e,i):c.i18n.localize(e)}))),t}activateListeners(e){super.activateListeners(e),e.find("button[data-action]").on("click",this._onClickAction.bind(this))}async _render(e=!1,t={}){await super._render(e,t),t.tab&&this._tabs[0].activate(t.tab)}async _renderInner(e){return await loadTemplates({supportDetailsReport:"templates/sidebar/apps/parts/support-details-report.html"}),super._renderInner(e)}_onClickAction(e){switch(e.currentTarget.dataset.action){case"copy":this._copyReport();break;case"fullReport":this.#sc()}}async#sc(){let e="";const t=document.getElementById("support-report"),[i]=this.element.find('[data-action="fullReport"]'),n=i.querySelector("i");i.disabled=!0,n.className="fas fa-spinner fa-spin-pulse";const s=await this.#oc(),{worldSizes:o,packSizes:r}=Object.entries(s).reduce(((e,t)=>{const[i]=t;return i.includes(".")?e.packSizes.push(t):e.worldSizes.push(t),e}),{worldSizes:[],packSizes:[]});e+=`\n${this.#rc(c.i18n.localize("SUPPORT.WorldData"))}\n\n`,e+=o.map((([e,t])=>{let i=c[e];return"fog"===e?i=c.collections.get("FogExploration"):"settings"===e&&(i=c.collections.get("Setting")),`${i.name}: ${i.size} | ${foundry.utils.formatFileSize(t,{decimalPlaces:0})}`})).join("\n"),r.length&&(e+=`\n\n${this.#rc(c.i18n.localize("SUPPORT.CompendiumData"))}\n\n`,e+=r.map((([e,t])=>{const i=c.packs.get(e),n=c.i18n.localize(i.documentClass.metadata.labelPlural);return t=foundry.utils.formatFileSize(t,{decimalPlaces:0}),`"${e}": ${i.index.size} ${n} | ${t}`})).join("\n"));const a=c.modules.filter((e=>e.active));a.length&&(e+=`\n\n${this.#rc(c.i18n.localize("SUPPORT.ActiveModules"))}\n\n`,e+=a.map((e=>`${e.id} | ${e.version} | "${e.title}" | "${e.manifest}"`)).join("\n")),n.className="fas fa-check",t.innerText+=e,this.setPosition({height:"auto"})}async#oc(){return new Promise((e=>c.socket.emit("sizeInfo",e)))}#rc(e){const t=`/* ${"-".repeat(44)} */`;return`${t}\n/*  ${e}${" ".repeat(t.length-e.length-6)}*/\n${t}`}_copyReport(){const e=document.getElementById("support-report");c.clipboard.copyPlainText(e.innerText),ui.notifications.info("SUPPORT.ReportCopied",{localize:!0})}_getDocumentValidationErrors(){const e=[];for(const[t,i]of Object.entries(c.issues.validationFailures)){const n=getDocumentClass(t),s=c.i18n.localize(n.metadata.labelPlural);e.push({label:s,documents:Object.entries(i).map((([e,{name:t,error:i}])=>({name:t??e,validationError:i.asHTML()})))})}return e}_getModuleIssues(){const e={label:c.i18n.localize("Errors"),issues:[]},t={label:c.i18n.localize("Warnings"),issues:[]};for(const[i,{error:n,warning:s}]of Object.entries(c.issues.packageCompatibilityIssues)){const o=c.modules.get(i)?.title??i;n.length&&e.issues.push({label:o,issues:n.map((e=>({severity:"error",message:e})))}),s.length&&t.issues.push({label:o,issues:s.map((e=>({severity:"warning",message:e})))})}const i=[];return e.issues.length&&i.push(e),t.issues.length&&i.push(t),i}static async generateSupportReport(){let e=canvas.app?.renderer?.gl;if(!e){const t=document.createElement("canvas");t.getContext&&(e=t.getContext("webgl2")||t.getContext("webgl")||t.getContext("experimental-webgl"))}const t=this.getWebGLRendererInfo(e)??"Unknown Renderer";let i=navigator.oscpu??"Unknown",n=navigator.userAgent;if(navigator.userAgentData){const e=await navigator.userAgentData.getHighEntropyValues(["architecture","model","bitness","platformVersion","fullVersionList"]),{architecture:t,bitness:s,brands:o,platform:r,platformVersion:a,fullVersionList:l}=e;i=[r,a,t,s?`(${s}-bit)`:null].filterJoin(" ");const{brand:c,version:d}=l?.[0]??o?.[0]??{};n=`${c}/${d}`}const s=c.scenes.get(c.user.viewedScene),o={os:i,client:n,coreVersion:`${c.release.display}, ${c.release.version}`,systemVersion:`${c.system.id}, ${c.system.version}`,activeModuleCount:Array.from(c.modules.values()).filter((e=>e.active)).length,performanceMode:c.settings.get("core","performanceMode"),gpu:t,maxTextureSize:e&&e.getParameter?e.getParameter(e.MAX_TEXTURE_SIZE):"Could not detect",hasViewedScene:!!s,packs:c.packs.size,worldScripts:Array.from(c.world.esmodules).concat(...c.world.scripts).map((e=>`"${e}"`)).join(", ")},r=["actors","items","journal","tables","playlists","messages"];for(let e of r){const t=c[e];o[e]=`${t.size}${t.invalidDocumentIds.size>0?` (${t.invalidDocumentIds.size} ${c.i18n.localize("Invalid")})`:""}`}return s&&(o.sceneDimensions=`${s.dimensions.width} x ${s.dimensions.height}`,o.grid=s.grid.size,o.padding=s.padding,o.walls=s.walls.size,o.lights=s.lights.size,o.sounds=s.sounds.size,o.tiles=s.tiles.size,o.tokens=s.tokens.size,o.largestTexture=SupportDetails.#ac()),o}static#ac(){let e={width:0,height:0};return function findTextures(t){if(t instanceof PIXI.Sprite||t instanceof SpriteMesh||t instanceof PrimarySpriteMesh){const i=t.texture?.baseTexture??{},{width:n,height:s,resource:o}=i;Math.max(n,s)>Math.max(e.width,e.height)&&(e={width:n,height:s,src:o?.src})}(t?.children??[]).forEach(findTextures)}(canvas.stage),e}static getWebGLRendererInfo(e){return navigator.userAgent.match(/Firefox\/([0-9]+)\./)?e.getParameter(e.RENDERER):e.getParameter(e.getExtension("WEBGL_debug_renderer_info").UNMASKED_RENDERER_WEBGL)}}class ToursManagement extends PackageConfiguration{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"tours-management",title:c.i18n.localize("SETTINGS.Tours"),categoryTemplate:"templates/sidebar/apps/tours-management-category.html"})}_prepareCategoryData(){let e=new Map,t=0;for(let i of c.tours.values()){if(!i.config.display||i.config.restricted&&!c.user.isGM)continue;t++;let n=this._categorizeEntry(i.namespace);const s={};switch(s.category=n.title,s.id=`${i.namespace}.${i.id}`,s.title=c.i18n.localize(i.title),s.description=c.i18n.localize(i.description),s.cssClass=i.config.restricted?"gm":"",s.notes=[i.config.restricted?c.i18n.localize("KEYBINDINGS.Restricted"):"",i.description].filterJoin("<br>"),i.status){case Tour.STATUS.UNSTARTED:s.status=c.i18n.localize("TOURS.NotStarted"),s.canBePlayed=i.canStart,s.canBeReset=!1,s.startOrResume=c.i18n.localize("TOURS.Start");break;case Tour.STATUS.IN_PROGRESS:s.status=c.i18n.format("TOURS.InProgress",{current:i.stepIndex+1,total:i.steps.length??0}),s.canBePlayed=i.canStart,s.canBeReset=!0,s.startOrResume=c.i18n.localize("TOURS."+(i.config.canBeResumed?"Resume":"Restart"));break;case Tour.STATUS.COMPLETED:s.status=c.i18n.localize("TOURS.Completed"),s.canBeReset=!0,s.cssClass+=" completed"}e.has(n.id)?e.get(n.id).tours.push(s):e.set(n.id,{id:n.id,title:n.title,tours:[s],count:0})}for(let t of e.values())t.count=t.tours.length;return e=Array.from(e.values()).sort(this._sortCategories.bind(this)),{categories:e,total:t}}activateListeners(e){super.activateListeners(e),e.find(".controls").on("click",".control",this._onClickControl.bind(this))}async _onResetDefaults(e){return Dialog.confirm({title:c.i18n.localize("TOURS.ResetTitle"),content:`<p>${c.i18n.localize("TOURS.ResetWarning")}</p>`,yes:async()=>{await Promise.all(c.tours.contents.map((e=>e.reset()))),ui.notifications.info("TOURS.ResetSuccess",{localize:!0}),this.render(!0)},no:()=>{},defaultYes:!1})}_onClickControl(e){const t=e.currentTarget,i=t.closest(".tour"),n=c.tours.get(i.dataset.tour);switch(t.dataset.action){case"play":return this.close(),n.start();case"reset":return n.reset()}}}class WorldConfig extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"world-config",template:"templates/setup/world-config.hbs",width:620,height:"auto",create:!1})}get world(){return this.object}static#lc="https://foundryvtt.com/article/game-worlds/";get title(){return this.options.create?c.i18n.localize("WORLD.TitleCreate"):`${c.i18n.localize("WORLD.TitleEdit")}: ${this.world.title}`}activateListeners(e){super.activateListeners(e),e.find('[name="title"]').on("input",this.#cc.bind(this))}getData(e={}){const t=CONST.PACKAGE_AVAILABILITY_CODES,i=new Date(this.world.nextSession||void 0),n={world:this.world,isCreate:this.options.create,submitText:c.i18n.localize(this.options.create?"WORLD.TitleCreate":"WORLD.SubmitEdit"),nextDate:i.isValid()?i.toDateInputString():"",nextTime:i.isValid()?i.toTimeInputString():"",worldKbUrl:WorldConfig.#lc,inWorld:!!c.world,themes:CONST.WORLD_JOIN_THEMES};return n.showEditFields=!n.isCreate&&!n.inWorld,c.systems&&(n.systems=c.systems.filter((e=>this.world.system===e.id||e.availability<=t.UNVERIFIED_GENERATION)).sort(((e,t)=>e.title.localeCompare(t.title,c.i18n.lang)))),n}_getSubmitData(e={}){const t=super._getSubmitData(e);if(this.options.create?(t.action="createWorld",t.id.length||(t.id=t.title.slugify({strict:!0}))):(t.id=this.world.id,t.resetKeys||delete t.resetKeys,t.safeMode||delete t.safeMode),t.nextSession.some((e=>!!e))){const e=new Date,i=`${t.nextSession[0]||e.toDateString()} ${t.nextSession[1]||e.toTimeString()}`,n=new Date(i);t.nextSession=isNaN(Number(n))?null:n.toISOString()}else t.nextSession=null;return t.joinTheme===CONST.WORLD_JOIN_THEMES.default&&delete t.joinTheme,t}async _updateObject(e,t){t=foundry.utils.expandObject(t);const i=e.target||this.form;i.disable=!0;try{this.world.validate({changes:t,clean:!0}),t.action=this.options.create?"createWorld":"editWorld"}catch(e){throw ui.notifications.error(e.message.replace("\n",". ")),e}let n;try{if(n=await foundry.utils.fetchJsonWithTimeout(foundry.utils.getRoute("setup"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),i.disabled=!1,n.error)return ui.notifications.error(n.error)}catch(e){return ui.notifications.error(e)}if("createWorld"===t.action){const e=new this.world.constructor(n);c.worlds.set(e.id,e)}else this.world.updateSource(n);ui.setup&&ui.setup.refresh(),ui.setupPackages&&ui.setupPackages.render()}#cc(e){let t=this.form.elements.title.value.slugify({strict:!0});t.length||(t="world-name"),this.form.elements.id?.setAttribute("placeholder",t)}async activateEditor(e,t={},i=""){const n=g.TinyMCE.toolbar.split(" ").filter((e=>"save"!==e)).join(" ");return foundry.utils.mergeObject(t,{toolbar:n}),super.activateEditor(e,t,i)}}class ChatLog extends SidebarTab{constructor(e){super(e),this._pendingText="",this._sentMessages=[],this._sentMessageIndex=-1,this._lastMessageTime=0,this._lastId=null,this._lastWhisper=null,this._onChatKeyDownBinding=null,setInterval(this.updateTimestamps.bind(this),15e3)}#dc=!0;#uc;#hc=new foundry.utils.Semaphore(1);#pc=!1;get isAtBottom(){return this.#dc}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"chat",template:"templates/sidebar/chat-log.html",title:c.i18n.localize("CHAT.Title"),stream:!1,scrollY:["#chat-log"]})}static MESSAGE_PATTERNS=(()=>{const e="([^#]+)(?:#(.*))?",t="([^]*)";return{roll:new RegExp(`^(\\/r(?:oll)? )${e}$`,"i"),gmroll:new RegExp(`^(\\/gmr(?:oll)? )${e}$`,"i"),blindroll:new RegExp(`^(\\/b(?:lind)?r(?:oll)? )${e}$`,"i"),selfroll:new RegExp(`^(\\/s(?:elf)?r(?:oll)? )${e}$`,"i"),publicroll:new RegExp(`^(\\/p(?:ublic)?r(?:oll)? )${e}$`,"i"),ic:new RegExp(`^(/ic )${t}`,"i"),ooc:new RegExp(`^(/ooc )${t}`,"i"),emote:new RegExp(`^(/(?:em(?:ote)?|me) )${t}`,"i"),whisper:new RegExp(/^(\/w(?:hisper)?\s)(\[(?:[^\]]+)\]|(?:[^\s]+))\s*([^]*)/,"i"),reply:new RegExp(`^(/reply )${t}`,"i"),gm:new RegExp(`^(/gm )${t}`,"i"),players:new RegExp(`^(/players )${t}`,"i"),macro:new RegExp(`^(\\/m(?:acro)? )${t}`,"i"),invalid:/^(\/[^\s]+)/}})();static MULTILINE_COMMANDS=new Set(["roll","gmroll","blindroll","selfroll","publicroll"]);get collection(){return c.messages}async getData(e={}){const t=await super.getData(e);return foundry.utils.mergeObject(t,{rollMode:c.settings.get("core","rollMode"),rollModes:Object.entries(g.Dice.rollModes).map((([e,t])=>({group:"CHAT.RollDefault",value:e,label:t}))),isStream:!!this.options.stream})}async _render(e,t){if(!this.rendered)return await super._render(e,t),this.scrollBottom({waitImages:!0})}async _renderInner(e){const t=await super._renderInner(e);return await this._renderBatch(t,g.ChatMessage.batchSize),t}async _renderBatch(e,t){if(!this.#pc)return this.#pc=!0,this.#hc.add((async()=>{const i=this.collection.contents,n=e.find("#chat-log, #chat-log-popout");let s=i.findIndex((e=>e.id===this._lastId));s=-1!==s?s:i.length;let o=Math.max(s-t,0),r=null;if(0!==s){let e=[];for(let t=o;t<s;t++)if(r=i[t],r.visible){r.logged=!0;try{e.push(await r.getHTML())}catch(e){e.message=`Chat message ${r.id} failed to render: ${e})`,console.error(e)}}n.prepend(e),this._lastId=i[o].id,this.#pc=!1}}))}deleteMessage(e,{deleteAll:t=!1}={}){return this.#hc.add((async()=>{const i=c.messages.get(e,{strict:!1});i&&(i.logged=!1);let n=this.element.find(`.message[data-message-id="${e}"]`);if(n.length){if(t)this._lastId=null;else if(e===this._lastId){const e=n[0].nextElementSibling;this._lastId=e?e.dataset.messageId:null}n.slideUp(100,(()=>n.remove())),this._popout&&this._popout.deleteMessage(e,{deleteAll:t}),this.popOut&&this.setPosition()}}))}notify(e){if(this._lastMessageTime=Date.now(),!this.rendered)return;let t=$("#chat-notification");t.is(":hidden")&&t.fadeIn(100),setTimeout((()=>{Date.now()-this._lastMessageTime>3e3&&t.is(":visible")&&t.fadeOut(100)}),3001),e.sound&&c.audio.play(e.sound,{context:c.audio.interface})}static parse(e){for(const[t,i]of Object.entries(this.MESSAGE_PATTERNS))if(this.MULTILINE_COMMANDS.has(t)){const n=e.split("\n");if(i.test(n[0]))return[t,n.map((e=>e.match(i)))]}else{const n=e.match(i);if(n)return[t,n]}return["none",[e,"",e]]}async postOne(e,{before:t,notify:i=!1}={}){if(e.visible)return this.#hc.add((async()=>{e.logged=!0,this._lastId||(this._lastId=e.id),(e.whisper||[]).includes(c.user.id)&&!e.isRoll&&(this._lastWhisper=e);const n=await e.getHTML(),s=this.element.find("#chat-log"),o=t?this.element.find(`.message[data-message-id="${t}"]`):[];o.length?o.before(n):(s.append(n),(this.isAtBottom||e.author._id===c.user._id)&&this.scrollBottom({waitImages:!0})),i&&this.notify(e),this._popout&&await this._popout.postOne(e,{before:t,notify:!1}),this.popOut&&this.setPosition()}))}async scrollBottom({popout:e=!1,waitImages:t=!1,scrollOptions:i={}}={}){if(!this.rendered)return;t&&await this._waitForImages();const n=this.element[0].querySelector("#chat-log");n.lastElementChild?.scrollIntoView(i),e&&this._popout?.scrollBottom({waitImages:t,scrollOptions:i})}async updateMessage(e,t=!1){let i=this.element.find(`.message[data-message-id="${e.id}"]`);if(i.length){const t=await e.getHTML();i.replaceWith(t)}else{const t=c.messages.contents;let i;for(let n=t.findIndex((t=>t===e))+1;n<t.length;n++)if(t[n].visible){i=t[n];break}await this.postOne(e,{before:i?.id,notify:!1})}t&&this.notify(e),this._popout&&await this._popout.updateMessage(e,!1),this.popOut&&this.setPosition()}updateTimestamps(){const e=this.element.find("#chat-log .message");for(let t of e){const e=c.messages.get(t.dataset.messageId);if(!e?.timestamp)return;const i=t.querySelector(".message-timestamp");i&&(i.textContent=foundry.utils.timeSince(e.timestamp))}}activateListeners(e){e.find("#chat-log").scroll(this._onScrollLog.bind(this)),this._onChatKeyDownBinding=this._onChatKeyDown.bind(this),e.find("#chat-message").keydown(this._onChatKeyDownBinding),e.on("click",".dice-roll",this._onDiceRollClick.bind(this)),e.find('select[name="rollMode"]').change(this._onChangeRollMode.bind(this)),e.on("click","a.message-delete",this._onDeleteMessage.bind(this)),e.find("a.chat-flush").click(this._onFlushLog.bind(this)),e.find("a.export-log").click(this._onExportLog.bind(this)),e.find(".jump-to-bottom > a").click((()=>this.scrollBottom())),e[0].addEventListener("drop",ChatLog._onDropTextAreaData),this._contextMenu(e)}static async _onDropTextAreaData(e){e.preventDefault();const t=e.target,i=TextEditor$1.getDragEventData(e),n=await TextEditor$1.getContentLink(i);n&&(t.value+=n),this._pendingText=t.value}async processMessage(e,{speaker:t}={}){if(!(e=e.trim()))return;const i=ChatMessage.implementation,n={user:c.user.id,speaker:t??i.getSpeaker()};if(!1===Hooks$1.call("chatMessage",this,e,n))return;let[s,o]=this.constructor.parse(e);if("invalid"===s)throw new Error(c.i18n.format("CHAT.InvalidCommand",{command:o[1]}));"none"===s&&(s=n.speaker.token?"ic":"ooc");const r={};switch(s){case"roll":case"gmroll":case"blindroll":case"selfroll":case"publicroll":await this._processDiceCommand(s,o,n,r);break;case"whisper":case"reply":case"gm":case"players":this._processWhisperCommand(s,o,n,r);break;case"ic":case"emote":case"ooc":this._processChatCommand(s,o,n,r);break;case"macro":return void this._processMacroCommand(s,o)}return i.create(n,r)}async _processDiceCommand(e,t,i,n){const s=ChatMessage.getSpeakerActor(i.speaker)||c.user.character,o=s?s.getRollData():{},r=[],a="roll"===e?c.settings.get("core","rollMode"):e;for(const e of t){if(!e)continue;const[t,n]=e.slice(2,4);n&&!i.flavor&&(i.flavor=n);const s=Roll.create(t,o);await s.evaluate({allowInteractive:a!==CONST.DICE_ROLL_MODES.BLIND}),r.push(s)}i.rolls=r,i.sound=g.sounds.dice,i.content=r.reduce(((e,t)=>e+t.total),0),n.rollMode=a}_processWhisperCommand(e,t,i,n){delete i.speaker;let s=[],o="";switch(e){case"whisper":o=t[3];s=t[2].replace(/[\[\]]/g,"").split(",").map((e=>e.trim())).reduce(((e,t)=>e.concat(ChatMessage.getWhisperRecipients(t))),[]);break;case"reply":o=t[2];const e=this._lastWhisper;if(e){const t=new Set(e.whisper);t.delete(c.user.id),t.add(e.author.id),s=Array.from(t).map((e=>c.users.get(e)))}break;case"gm":o=t[2],s=ChatMessage.getWhisperRecipients("gm");break;case"players":o=t[2],s=ChatMessage.getWhisperRecipients("players")}if(o=o.replace(/\n/g,"<br>"),!s.length)throw new Error(c.i18n.localize("ERROR.NoTargetUsersForWhisper"));if(s.some((e=>!e.isGM))&&!c.user.can("MESSAGE_WHISPER"))throw new Error(c.i18n.localize("ERROR.CantWhisper"));i.whisper=s.map((e=>e.id)),i.content=o,i.sound=g.sounds.notification}_processChatCommand(e,t,i,n){if(["ic","emote"].includes(e)&&!i.speaker.actor&&!i.speaker.token)throw new Error("You cannot chat in-character without an identified speaker");i.content=t[2].replace(/\n/g,"<br>"),"ic"===e?(i.style=CONST.CHAT_MESSAGE_STYLES.IC,n.chatBubble=!0):"emote"===e?(i.style=CONST.CHAT_MESSAGE_STYLES.EMOTE,i.content=`${i.speaker.alias} ${i.content}`,n.chatBubble=!0):(i.style=CONST.CHAT_MESSAGE_STYLES.OOC,delete i.speaker)}_processMacroCommand(e,t){let[i,...n]=t[2].split(" "),s=!0;const o={};let r,a;for(const e of n){const t=e.split("=");2===t.length?(r=t[0],o[r]=t[1],s=!1):s?i+=` ${e}`:r&&(o[r]+=` ${e}`)}if(i=i.trimEnd(),Number.isNumeric(i)){const e=c.user.hotbar[i];a=c.macros.get(e)}if(a||(a=c.macros.getName(i)),!a)throw new Error(`Requested Macro "${i}" was not found as a named macro or hotbar position`);return a.execute(o)}_remember(e){5===this._sentMessages.length&&this._sentMessages.splice(4,1),this._sentMessages.unshift(e),this._sentMessageIndex=-1}_recall(e){if(this._sentMessages.length>0){let t=this._sentMessageIndex+e;this._sentMessageIndex=Math.clamp(t,-1,this._sentMessages.length-1)}return this._sentMessages[this._sentMessageIndex]||""}_contextMenu(e){ContextMenu.create(this,e,".message",this._getEntryContextOptions())}_getEntryContextOptions(){return[{name:"CHAT.PopoutMessage",icon:'<i class="fas fa-external-link-alt fa-rotate-180"></i>',condition:e=>!0===c.messages.get(e.data("messageId")).getFlag("core","canPopout"),callback:e=>{const t=c.messages.get(e.data("messageId"));new ChatPopout(t).render(!0)}},{name:"CHAT.RevealMessage",icon:'<i class="fas fa-eye"></i>',condition:e=>{const t=c.messages.get(e.data("messageId"));return(t.whisper.length||t.blind)&&(c.user.isGM||t.isAuthor)&&t.isContentVisible},callback:e=>c.messages.get(e.data("messageId")).update({whisper:[],blind:!1})},{name:"CHAT.ConcealMessage",icon:'<i class="fas fa-eye-slash"></i>',condition:e=>{const t=c.messages.get(e.data("messageId"));return!(t.whisper.length||t.blind)&&(c.user.isGM||t.isAuthor)&&t.isContentVisible},callback:e=>c.messages.get(e.data("messageId")).update({whisper:ChatMessage.getWhisperRecipients("gm").map((e=>e.id)),blind:!1})},{name:"SIDEBAR.Delete",icon:'<i class="fas fa-trash"></i>',condition:e=>c.messages.get(e.data("messageId")).canUserModify(c.user,"delete"),callback:e=>c.messages.get(e.data("messageId")).delete()}]}_onChatKeyDown(e){const t=e.code,i=e.currentTarget;if(e.originalEvent.isComposing)return;if(["ArrowUp","ArrowDown"].includes(t)){if(this._pendingText)return;return e.preventDefault(),void(i.value=this._recall("ArrowUp"===t?1:-1))}if(("Enter"===t||"NumpadEnter"===t)&&!e.shiftKey){e.preventDefault();const t=i.value;if(!t)return;return e.stopPropagation(),this._pendingText="",this.processMessage(t).then((()=>{i.value="",this._remember(t)})).catch((e=>{throw ui.notifications.error(e),e}))}"Backspace"!==e.key?this._pendingText=i.value+(1===e.key.length?e.key:""):this._pendingText=this._pendingText.slice(0,-1)}_onChangeRollMode(e){e.preventDefault(),c.settings.set("core","rollMode",e.target.value)}_onDeleteMessage(e){e.preventDefault();const t=e.currentTarget.closest(".message").dataset.messageId,i=c.messages.get(t);return i?i.delete():this.deleteMessage(t)}_onDiceRollClick(e){e.preventDefault();let t=e.currentTarget;const i=c.messages.get(t.closest(".message").dataset.messageId);i._rollExpanded=!i._rollExpanded;const n=t.querySelectorAll(".dice-tooltip");for(let e of n)i._rollExpanded?$(e).slideDown(200):$(e).slideUp(200),e.classList.toggle("expanded",i._rollExpanded)}_onExportLog(e){e.preventDefault(),c.messages.export()}_onFlushLog(e){e.preventDefault(),c.messages.flush(this.#uc)}_onScrollLog(e){if(!this.rendered)return;const t=e.target,i=t.scrollTop/(t.scrollHeight-t.clientHeight);return this.#uc||(this.#uc=this.element.find(".jump-to-bottom")[0]),this.#dc=i>.99||Number.isNaN(i),this.#uc.classList.toggle("hidden",this.#dc),i<.01?this._renderBatch(this.element,g.ChatMessage.batchSize):void 0}static _setRollMode(e){for(let t of $(".roll-type-select"))for(let i of t.options)i.selected=i.value===e}}class CompendiumDirectory extends(DirectoryApplicationMixin(SidebarTab)){static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"compendium",template:"templates/sidebar/compendium-directory.html",title:"COMPENDIUM.SidebarTitle",contextMenuSelector:".directory-item.compendium",entryClickSelector:".compendium"})}#gc=[];get activeFilters(){return this.#gc}entryType="Compendium";static entryPartial="templates/sidebar/partials/pack-partial.html";_entryAlreadyExists(e){return this.collection.has(e.collection)}_getEntryDragData(e){return{type:"Compendium",id:this.collection.get(e).collection}}_entryIsSelf(e,t){return e.metadata.id===t.metadata.id}async _sortRelative(e,t){const i=c.settings.get("core","compendiumConfiguration"),n=t.updateData.folder;i[e.collection]=foundry.utils.mergeObject(i[e.collection]||{},{folder:n});const s=SortingHelpers.performIntegerSort(e,t);for(const e of s){(i[e.target.collection]||{}).sort=e.update.sort}await c.settings.set("core","compendiumConfiguration",i)}activateListeners(e){super.activateListeners(e),e.find(".filter").click(this._displayFilterCompendiumMenu.bind(this))}async _displayFilterCompendiumMenu(e){const t=document.getElementsByClassName("dropdown-menu")[0];if(t)return void t.remove();const i=e.currentTarget,n=CONST.COMPENDIUM_DOCUMENT_TYPES.map((e=>{const t=g[e];return{name:c.i18n.localize(t.documentClass.metadata.label),icon:t.sidebarIcon,type:e,callback:t=>this._onToggleCompendiumFilterType(t,e)}}));this.#gc.length&&n.unshift({name:c.i18n.localize("COMPENDIUM.ClearFilters"),icon:"fas fa-times",type:null,callback:e=>this._onToggleCompendiumFilterType(e,null)});const s=document.createElement("div");s.classList.add("dropdown-menu");const o=document.createElement("div");o.classList.add("dropdown-list","flexcol"),s.appendChild(o);for(let e of n){const t=document.createElement("a");t.classList.add("dropdown-item"),this.#gc.includes(e.type)&&t.classList.add("active"),t.innerHTML=`<i class="${e.icon}"></i> ${e.name}`,t.addEventListener("click",e.callback),o.appendChild(t)}const r=i.offsetTop+10,a=i.offsetLeft+10;s.style.top=`${r}px`,s.style.left=`${a}px`,i.parentElement.appendChild(s)}_onToggleCompendiumFilterType(e,t){this.#gc=null===t?[]:this.#gc.includes(t)?this.#gc.filter((e=>e!==t)):this.#gc.concat(t),this.render()}get collection(){return c.packs}async _getDroppedEntryFromData(e){return c.packs.get(e.id)}async _createDroppedEntry(e,t){throw new Error("The _createDroppedEntry shouldn't be called for CompendiumDirectory")}_getEntryName(e){return e.metadata.label}_getEntryId(e){return e.metadata.id}async getData(e={}){let t=await super.getData(e);const i={world:World.icon,system:System.icon,module:Module.icon},n={};for(const e of this.collection)n[e.collection]={locked:e.locked,customOwnership:"ownership"in e.config,collection:e.collection,name:e.metadata.packageName,label:e.metadata.label,icon:g[e.metadata.type].sidebarIcon,hidden:!!this.#gc?.length&&!this.#gc.includes(e.metadata.type),banner:e.banner,sourceIcon:i[e.metadata.packageType]};return t=foundry.utils.mergeObject(t,{folderIcon:g.Folder.sidebarIcon,label:c.i18n.localize("PACKAGE.TagCompendium"),labelPlural:c.i18n.localize("SIDEBAR.TabCompendium"),sidebarIcon:"fas fa-atlas",filtersActive:!!this.#gc.length}),t.packContext=n,t}async render(e=!1,t={}){return c.packs.initializeTree(),super.render(e,t)}_getEntryContextOptions(){return c.user.isGM?[{name:"OWNERSHIP.Configure",icon:'<i class="fa-solid fa-user-lock"></i>',callback:e=>c.packs.get(e.data("pack")).configureOwnershipDialog()},{name:"FOLDER.Clear",icon:'<i class="fas fa-folder"></i>',condition:e=>{const t=e.closest(".directory-item");return!!this.collection.get(t.data("entryId")).folder},callback:e=>{const t=e.closest(".directory-item");this.collection.get(t.data("entryId")).setFolder(null)}},{name:"COMPENDIUM.ToggleLocked",icon:'<i class="fas fa-lock"></i>',callback:e=>{let t=c.packs.get(e.data("pack"));return t.locked&&"world"!==t.metadata.packageType?Dialog.confirm({title:`${c.i18n.localize("COMPENDIUM.ToggleLocked")}: ${t.title}`,content:`<p><strong>${c.i18n.localize("Warning")}:</strong> ${c.i18n.localize("COMPENDIUM.ToggleLockedWarning")}</p>`,yes:()=>t.configure({locked:!t.locked}),options:{top:Math.min(e[0].offsetTop,window.innerHeight-350),left:window.innerWidth-720,width:400}}):t.configure({locked:!t.locked})}},{name:"COMPENDIUM.Duplicate",icon:'<i class="fas fa-copy"></i>',callback:e=>{let t=c.packs.get(e.data("pack"));const i=`<form>\n            <div class="form-group">\n                <label>${c.i18n.localize("COMPENDIUM.DuplicateTitle")}</label>\n                <input type="text" name="label" value="${c.i18n.format("DOCUMENT.CopyOf",{name:t.title})}"/>\n                <p class="notes">${c.i18n.localize("COMPENDIUM.DuplicateHint")}</p>\n            </div>\n          </form>`;return Dialog.confirm({title:`${c.i18n.localize("COMPENDIUM.Duplicate")}: ${t.title}`,content:i,yes:e=>{const i=e.querySelector('input[name="label"]').value;return t.duplicateCompendium({label:i})},options:{top:Math.min(e[0].offsetTop,window.innerHeight-350),left:window.innerWidth-720,width:400,jQuery:!1}})}},{name:"COMPENDIUM.ImportAll",icon:'<i class="fas fa-download"></i>',condition:e=>"Adventure"!==c.packs.get(e.data("pack"))?.documentName,callback:e=>c.packs.get(e.data("pack")).importDialog({top:Math.min(e[0].offsetTop,window.innerHeight-350),left:window.innerWidth-720,width:400})},{name:"COMPENDIUM.Delete",icon:'<i class="fas fa-trash"></i>',condition:e=>"world"===c.packs.get(e.data("pack")).metadata.packageType,callback:e=>{let t=c.packs.get(e.data("pack"));return this._onDeleteCompendium(t)}}]:[]}async _onClickEntryName(e){e.preventDefault();const t=e.currentTarget.closest("[data-pack]").dataset.pack;c.packs.get(t).render(!0)}async _onCreateEntry(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget.closest(".directory-item"),i=t?t.dataset.folderId:null,n=CONST.COMPENDIUM_DOCUMENT_TYPES.map((e=>({value:e,label:c.i18n.localize(getDocumentClass(e).metadata.label)})));c.i18n.sortObjects(n,"label");const s=this.collection._formatFolderSelectOptions(),o=await renderTemplate("templates/sidebar/compendium-create.html",{types:n,folders:s,folder:i,hasFolders:s.length>=1});return Dialog.prompt({title:c.i18n.localize("COMPENDIUM.Create"),content:o,label:c.i18n.localize("COMPENDIUM.Create"),callback:async e=>{const t=e.querySelector("#compendium-create"),i=new FormDataExtended(t).object;let n=i.folder;if(i.folder&&delete i.folder,!i.label){let e=c.i18n.format("DOCUMENT.New",{type:c.i18n.localize("PACKAGE.TagCompendium")});const t=c.packs.size;t>0&&(e+=` (${t+1})`),i.label=e}const s=await CompendiumCollection.createCompendium(i);n&&await s.setFolder(n)},rejectClose:!1,options:{jQuery:!1}})}_onDeleteCompendium(e){return Dialog.confirm({title:`${c.i18n.localize("COMPENDIUM.Delete")}: ${e.title}`,content:`<h4>${c.i18n.localize("AreYouSure")}</h4><p>${c.i18n.localize("COMPENDIUM.DeleteWarning")}</p>`,yes:()=>e.deleteCompendium(),defaultYes:!1})}}class PlaylistDirectory extends DocumentDirectory{constructor(e){super(e),this._expanded=this._createExpandedSet(),this._volumeExpanded=!0,this._playingPlaylists=[],this._playingSounds=[],setInterval(this._updateTimestamps.bind(this),1e3),c.settings.register("core","playlist.playingLocation",{scope:"client",config:!1,default:"top",type:String,onChange:()=>ui.playlists.render()})}static documentName="Playlist";static entryPartial="templates/sidebar/partials/playlist-partial.html";static get defaultOptions(){const e=super.defaultOptions;return e.template="templates/sidebar/playlists-directory.html",e.dragDrop[0].dragSelector=".folder, .playlist-name, .sound-name",e.renderUpdateKeys=["name","playing","mode","sounds","sort","sorting","folder"],e.contextMenuSelector=".document .playlist-header",e}_createExpandedSet(){const e=new Set;for(let t of this.documents)t.playing&&e.add(t.id);return e}get playing(){return this._playingPlaylists}get _playingLocation(){return c.settings.get("core","playlist.playingLocation")}async getData(e={}){this._playingPlaylists=[],this._playingSounds=[],this._playingSoundsData=[],this._prepareTreeData(this.collection.tree);const t=await super.getData(e),i="top"===this._playingLocation;return foundry.utils.mergeObject(t,{playingSounds:this._playingSoundsData,showPlaying:this._playingSoundsData.length>0,playlistModifier:foundry.audio.AudioHelper.volumeToInput(c.settings.get("core","globalPlaylistVolume")),playlistTooltip:PlaylistDirectory.volumeToTooltip(c.settings.get("core","globalPlaylistVolume")),ambientModifier:foundry.audio.AudioHelper.volumeToInput(c.settings.get("core","globalAmbientVolume")),ambientTooltip:PlaylistDirectory.volumeToTooltip(c.settings.get("core","globalAmbientVolume")),interfaceModifier:foundry.audio.AudioHelper.volumeToInput(c.settings.get("core","globalInterfaceVolume")),interfaceTooltip:PlaylistDirectory.volumeToTooltip(c.settings.get("core","globalInterfaceVolume")),volumeExpanded:this._volumeExpanded,currentlyPlaying:{class:"location-"+(i?"top":"bottom"),location:{top:i,bottom:!i},pin:{label:"PLAYLIST.PinTo"+(i?"Bottom":"Top"),caret:i?"down":"up"}}})}static volumeToTooltip(e){return c.i18n.format("PLAYLIST.VOLUME.TOOLTIP",{volume:Math.round(100*foundry.audio.AudioHelper.volumeToInput(e))})}_prepareTreeData(e){e.entries=e.entries.map((e=>this._preparePlaylistData(e)));for(const t of e.children)this._prepareTreeData(t)}_preparePlaylistData(e){e.playing&&this._playingPlaylists.push(e);const t=e.toObject(!1);t.modeTooltip=this._getModeTooltip(t.mode),t.modeIcon=this._getModeIcon(t.mode),t.disabled=t.mode===CONST.PLAYLIST_MODES.DISABLED,t.expanded=this._expanded.has(t._id),t.css=[t.expanded?"":"collapsed",e.playing?"playing":""].filterJoin(" "),t.controlCSS=e.isOwner&&!t.disabled?"":"disabled",t.isOwner=e.isOwner;const i=[];for(const t of e.playbackOrder){const n=e.sounds.get(t);if(!n.isOwner&&!n.playing)continue;const s=n.toObject(!1);s.playlistId=e.id,s.css=s.playing?"playing":"",s.controlCSS=n.isOwner?"":"disabled",s.playIcon=this._getPlayIcon(n),s.playTitle=s.pausedTime?"PLAYLIST.SoundResume":"PLAYLIST.SoundPlay",s.isOwner=n.isOwner,n.sound&&!n.sound.failed&&(n.playing||s.pausedTime)&&(s.isPaused=!n.playing&&s.pausedTime,s.pauseIcon=this._getPauseIcon(n),s.lvolume=foundry.audio.AudioHelper.volumeToInput(s.volume),s.volumeTooltip=this.constructor.volumeToTooltip(s.volume),s.currentTime=this._formatTimestamp(n.playing?n.sound.currentTime:s.pausedTime),s.durationTime=this._formatTimestamp(n.sound.duration),this._playingSounds.push(n),this._playingSoundsData.push(s)),i.push(s)}return t.sounds=i,t}_getPlayIcon(e){return e.playing?"fas fa-square":e.pausedTime?"fas fa-play-circle":"fas fa-play"}_getPauseIcon(e){return e.playing&&!e.sound?.loaded?"fas fa-spinner fa-spin":"fas fa-pause"}_getModeIcon(e){return{[CONST.PLAYLIST_MODES.DISABLED]:"fas fa-ban",[CONST.PLAYLIST_MODES.SEQUENTIAL]:"far fa-arrow-alt-circle-right",[CONST.PLAYLIST_MODES.SHUFFLE]:"fas fa-random",[CONST.PLAYLIST_MODES.SIMULTANEOUS]:"fas fa-compress-arrows-alt"}[e]}_getModeTooltip(e){return{[CONST.PLAYLIST_MODES.DISABLED]:c.i18n.localize("PLAYLIST.ModeDisabled"),[CONST.PLAYLIST_MODES.SEQUENTIAL]:c.i18n.localize("PLAYLIST.ModeSequential"),[CONST.PLAYLIST_MODES.SHUFFLE]:c.i18n.localize("PLAYLIST.ModeShuffle"),[CONST.PLAYLIST_MODES.SIMULTANEOUS]:c.i18n.localize("PLAYLIST.ModeSimultaneous")}[e]}activateListeners(e){super.activateListeners(e),e.find(".global-volume-slider").change(this._onGlobalVolume.bind(this)),e.find(".sound-volume").change(this._onSoundVolume.bind(this)),e.find("#global-volume .playlist-header").click(this._onVolumeCollapse.bind(this)),e.find("#currently-playing .pin").click(this._onPlayingPin.bind(this)),e.on("click","a.sound-control",(e=>{e.preventDefault();const t=e.currentTarget,i=t.dataset.action;if(i&&!t.classList.contains("disabled"))switch(i){case"playlist-mode":return this._onPlaylistToggleMode(e);case"playlist-play":case"playlist-stop":return this._onPlaylistPlay(e,"playlist-play"===i);case"playlist-forward":case"playlist-backward":return this._onPlaylistSkip(e,i);case"sound-create":return this._onSoundCreate(e);case"sound-pause":case"sound-play":case"sound-stop":return this._onSoundPlay(e,i);case"sound-repeat":return this._onSoundToggleMode(e)}}))}_onGlobalVolume(e){e.preventDefault();const t=e.currentTarget,i=foundry.audio.AudioHelper.inputToVolume(t.value),n=PlaylistDirectory.volumeToTooltip(i);return t.setAttribute("data-tooltip",n),c.tooltip.activate(t,{text:n}),c.settings.set("core",t.name,i)}collapseAll(){super.collapseAll();const e=this.element[0];for(let t of e.querySelectorAll("li.playlist"))this._collapse(t,!0);this._expanded.clear(),this._collapse(e.querySelector("#global-volume"),!0),this._volumeExpanded=!1}_onClickEntryName(e){const t=e.currentTarget.closest(".playlist"),i=t.dataset.documentId,n=this._expanded.has(i);this._collapse(t,n),n?this._expanded.delete(i):this._expanded.add(i)}_onVolumeCollapse(e){e.preventDefault();const t=e.currentTarget.parentElement;this._volumeExpanded=!this._volumeExpanded,this._collapse(t,!this._volumeExpanded)}_collapse(e,t,i=250){const n=e.querySelector(".playlist-sounds"),s=e.querySelector("i.collapse");t?$(n).slideUp(i,(()=>{e.classList.add("collapsed"),s.classList.replace("fa-angle-down","fa-angle-up")})):$(n).slideDown(i,(()=>{e.classList.remove("collapsed"),s.classList.replace("fa-angle-up","fa-angle-down")}))}_onPlaylistPlay(e,t){const i=e.currentTarget.closest(".playlist"),n=c.playlists.get(i.dataset.documentId);return t?n.playAll():n.stopAll()}_onPlaylistSkip(e,t){const i=e.currentTarget.closest(".playlist");return c.playlists.get(i.dataset.documentId).playNext(void 0,{direction:"playlist-forward"===t?1:-1})}_onPlaylistToggleMode(e){const t=e.currentTarget.closest(".playlist");return c.playlists.get(t.dataset.documentId).cycleMode()}_onSoundCreate(e){const t=$(e.currentTarget).parents(".playlist"),i=c.playlists.get(t.data("documentId"));new PlaylistSound({name:c.i18n.localize("SOUND.New")},{parent:i}).sheet.render(!0,{top:t[0].offsetTop,left:window.innerWidth-670})}_onSoundPlay(e,t){const i=e.currentTarget.closest(".sound"),n=c.playlists.get(i.dataset.playlistId),s=n.sounds.get(i.dataset.soundId);switch(t){case"sound-play":return n.playSound(s);case"sound-pause":return s.update({playing:!1,pausedTime:s.sound.currentTime});case"sound-stop":return n.stopSound(s)}}_onSoundVolume(e){e.preventDefault();const t=e.currentTarget,i=t.closest(".sound"),n=c.playlists.get(i.dataset.playlistId).sounds.get(i.dataset.soundId),s=foundry.audio.AudioHelper.inputToVolume(t.value);if(s===n.volume)return;n.updateSource({volume:s}),n.sound?.fade(n.volume,{duration:PlaylistSound.VOLUME_DEBOUNCE_MS});const o=PlaylistDirectory.volumeToTooltip(s);t.setAttribute("data-tooltip",o),c.tooltip.activate(t,{text:o}),n.isOwner&&n.debounceVolume(s)}_onSoundToggleMode(e){e.preventDefault();const t=e.currentTarget.closest(".sound"),i=c.playlists.get(t.dataset.playlistId).sounds.get(t.dataset.soundId);return i.update({repeat:!i.repeat})}_onPlayingPin(){const e="top"===this._playingLocation?"bottom":"top";return c.settings.set("core","playlist.playingLocation",e)}_onSearchFilter(e,t,i,n){const s=!!t,o=new Set,r=new Set,a=new Set,l=this.collection.searchMode===CONST.DIRECTORY_SEARCH_MODES.NAME;if(s){let e=[];l||(e=this.collection.search({query:t}));for(let t of this.documents){let n=!1;for(let e of t.sounds)(e.playing||i.test(SearchFilter.cleanQuery(e.name)))&&(r.add(e._id),n=!0);(n||t.playing||l&&i.test(SearchFilter.cleanQuery(t.name))||e.some((e=>e._id===t._id)))&&(o.add(t._id),t.folder&&a.add(t.folder._id))}const n=this.folders.sort(((e,t)=>t.depth-e.depth));for(let e of n)a.has(e.id)&&e.folder&&a.add(e.folder._id)}for(let e of n.querySelectorAll(".directory-item"))if(!e.classList.contains("global-volume"))if(e.classList.contains("document")){const t=e.dataset.documentId;let i=!s||o.has(t);e.style.display=i?"flex":"none";const n=e.querySelector(".playlist-sounds");for(const e of n.children){let t=!s||r.has(e.dataset.soundId);e.style.display=t?"flex":"none",t&&(i=!0)}const a=this._expanded.has(t)||s&&i;e.classList.toggle("collapsed",!a)}else if(e.classList.contains("folder")){const t=s&&!a.has(e.dataset.folderId);e.style.display=t?"none":"flex";const i=e.closest("li.folder").dataset.uuid,n=s&&a.has(e.dataset.folderId)||!s&&c.folders._expanded[i];e.classList.toggle("collapsed",!n)}}_updateTimestamps(){if(!this._playingSounds.length)return;const e=this.element.find("#currently-playing")[0];if(e)for(let t of this._playingSounds){const i=e.querySelector(`.sound[data-sound-id="${t.id}"]`);if(!i)continue;const n=i.querySelector("span.current"),s=t.playing?t.sound.currentTime:t.pausedTime;n&&(n.textContent=this._formatTimestamp(s));const o=i.querySelector("span.duration");o&&(o.textContent=this._formatTimestamp(t.sound.duration));const r=i.querySelector("a.pause");r.classList.contains("fa-spinner")&&(r.classList.remove("fa-spin"),r.classList.replace("fa-spinner","fa-pause"))}}_formatTimestamp(e){if(!Number.isFinite(e))return"âˆž";return e=e??0,`${Math.floor(e/60)}:${(e=Math.round(e%60)).paddedString(2)}`}_contextMenu(e){super._contextMenu(e),ContextMenu.create(this,e,".playlist .sound",this._getSoundContextOptions(),{hookName:"SoundContext"})}_getEntryContextOptions(){const e=super._getEntryContextOptions();return e.unshift({name:"PLAYLIST.Edit",icon:'<i class="fas fa-edit"></i>',callback:e=>{const t=e.closest(".directory-item"),i=c.playlists.get(t.data("document-id")).sheet;i.render(!0,this.popOut?{}:{top:t[0].offsetTop-24,left:window.innerWidth-ui.sidebar.position.width-i.options.width-10})}}),e}_getSoundContextOptions(){return[{name:"PLAYLIST.SoundEdit",icon:'<i class="fas fa-edit"></i>',callback:e=>{const t=e.parents(".playlist").data("document-id"),i=c.playlists.get(t).sounds.get(e.data("sound-id")).sheet;i.render(!0,this.popOut?{}:{top:e[0].offsetTop-24,left:window.innerWidth-ui.sidebar.position.width-i.options.width-10})}},{name:"PLAYLIST.SoundPreload",icon:'<i class="fas fa-download"></i>',callback:e=>{const t=e.parents(".playlist").data("document-id"),i=c.playlists.get(t).sounds.get(e.data("sound-id"));c.audio.preload(i.path)}},{name:"PLAYLIST.SoundDelete",icon:'<i class="fas fa-trash"></i>',callback:e=>{const t=e.parents(".playlist").data("document-id");return c.playlists.get(t).sounds.get(e.data("sound-id")).deleteDialog({top:Math.min(e[0].offsetTop,window.innerHeight-350),left:window.innerWidth-720})}}]}_onDragStart(e){const t=e.currentTarget;if(t.classList.contains("sound-name")){const i=t.closest(".sound"),n=c.playlists.get(i.dataset.playlistId)?.sounds.get(i.dataset.soundId);e.dataTransfer.setData("text/plain",JSON.stringify(n.toDragData()))}else super._onDragStart(e)}async _onDrop(e){const t=TextEditor$1.getDragEventData(e);if("PlaylistSound"!==t.type)return super._onDrop(e);const i=e.target.closest(".sound, .playlist");if(!i)return!1;const n=await PlaylistSound.implementation.fromDropData(t),s=n.parent,o=i.dataset.documentId||i.dataset.playlistId;if(o!==s.id){const e=c.playlists.get(o);return PlaylistSound.implementation.create(n.toObject(),{parent:e})}const r=i.dataset.soundId;if(!r||r===n.id)return!1;n.sortRelative({target:s.sounds.get(r),siblings:s.sounds.filter((e=>e.id!==n.id))})}}class FrameViewer extends Application{constructor(e,t){super(t),this.url=e}static get defaultOptions(){const e=super.defaultOptions,t=.9*window.innerHeight,i=Math.min(.9*window.innerWidth,1200);return e.height=t,e.width=i,e.top=(window.innerHeight-t)/2,e.left=(window.innerWidth-i)/2,e.id="documentation",e.template="templates/apps/documentation.html",e}async getData(e={}){return{src:this.url}}async close(e){return this.element.find("#docs").remove(),super.close(e)}}class AVClient{constructor(e,t){this.master=e,this.settings=t}get isVoicePTT(){return"ptt"===this.settings.client.voice.mode}get isVoiceAlways(){return"always"===this.settings.client.voice.mode}get isVoiceActivated(){return"activity"===this.settings.client.voice.mode}get isMuted(){return this.settings.client.users[c.user.id]?.muted}async initialize(){throw Error("The initialize() method must be defined by an AVClient subclass.")}async connect(){throw Error("The connect() method must be defined by an AVClient subclass.")}async disconnect(){throw Error("The disconnect() method must be defined by an AVClient subclass.")}async getAudioSinks(){return this._getSourcesOfType("audiooutput")}async getAudioSources(){return this._getSourcesOfType("audioinput")}async getVideoSources(){return this._getSourcesOfType("videoinput")}async _getSourcesOfType(e){if(!("mediaDevices"in navigator))return{};return(await navigator.mediaDevices.enumerateDevices()).reduce(((t,i)=>(i.kind===e&&(t[i.deviceId]=i.label||c.i18n.localize("WEBRTC.UnknownDevice")),t)),{})}getConnectedUsers(){throw Error("The getConnectedUsers() method must be defined by an AVClient subclass.")}getMediaStreamForUser(e){throw Error("The getMediaStreamForUser() method must be defined by an AVClient subclass.")}getLevelsStreamForUser(e){throw new Error("An AVClient subclass must define the getLevelsStreamForUser method")}isAudioEnabled(){throw Error("The isAudioEnabled() method must be defined by an AVClient subclass.")}isVideoEnabled(){throw Error("The isVideoEnabled() method must be defined by an AVClient subclass.")}toggleAudio(e){throw Error("The toggleAudio() method must be defined by an AVClient subclass.")}toggleBroadcast(e){throw Error("The toggleBroadcast() method must be defined by an AVClient subclass.")}toggleVideo(e){throw Error("The toggleVideo() method must be defined by an AVClient subclass.")}async setUserVideo(e,t){throw Error("The setUserVideo() method must be defined by an AVClient subclass.")}onSettingsChanged(e){}async updateLocalStream(){throw Error("The updateLocalStream() method must be defined by an AVClient subclass.")}}class AVMaster{constructor(){this.settings=new AVSettings,this.config=new AVConfig(this),this.client=new g.WebRTC.clientClass(this,this.settings),this.broadcasting=!1,this._connected=!1,this._connecting=null,this._reconnecting=!1,this._speakingData={speaking:!1,volumeHistories:[]},this._pttMuteTimeout=0}get mode(){return this.settings.world.mode}async connect(){if(this._connecting)return this._connecting;return this._connecting=(async()=>{if(await this.disconnect(),this.mode===AVSettings.AV_MODES.DISABLED)return!1;await this.client.initialize();const e=await this.client.connect();return!!e&&(console.log(`${l} | Connected to the ${this.client.constructor.name} Audio/Video client.`),this._initialize(),this._connected=e)})().finally((()=>this._connecting=null))}async disconnect(){return!!this._connected&&(this._connected=this._reconnecting=!1,await this.client.disconnect(),console.log(`${l} | Disconnected from the ${this.client.constructor.name} Audio/Video client.`),!0)}async reestablish(){if(this._connected)for(ui.notifications.warn("WEBRTC.ConnectionLostWarning",{localize:!0}),await this.disconnect();this._reconnecting;){if(await this.connect(),this._connected){this._reconnecting=!0;break}await new Promise((e=>setTimeout(e,this._reconnectPeriodMS)))}}_initialize(){const e=this.settings.client,t=e.voice.mode;this._initializeUserVoiceDetection(t),this._resetSpeakingHistory(c.user.id);const i="always"===t;this.client.toggleAudio(i&&e.audioSrc&&this.canUserShareAudio(c.user.id)),this.client.toggleVideo(e.videoSrc&&this.canUserShareVideo(c.user.id)),this.broadcast(i),ui.webrtc.render()}canUserBroadcastAudio(e){if([AVSettings.AV_MODES.DISABLED,AVSettings.AV_MODES.VIDEO].includes(this.mode))return!1;const t=this.settings.getUser(e);return t&&t.canBroadcastAudio}canUserShareAudio(e){if([AVSettings.AV_MODES.DISABLED,AVSettings.AV_MODES.VIDEO].includes(this.mode))return!1;const t=this.settings.getUser(e);return t&&t.canBroadcastAudio&&!(t.muted||t.blocked)}canUserBroadcastVideo(e){if([AVSettings.AV_MODES.DISABLED,AVSettings.AV_MODES.AUDIO].includes(this.mode))return!1;const t=this.settings.getUser(e);return t&&t.canBroadcastVideo}canUserShareVideo(e){if([AVSettings.AV_MODES.DISABLED,AVSettings.AV_MODES.AUDIO].includes(this.mode))return!1;const t=this.settings.getUser(e);return t&&t.canBroadcastVideo&&!(t.hidden||t.blocked)}broadcast(e){this.broadcasting=e&&this.canUserShareAudio(c.user.id),this.client.toggleBroadcast(this.broadcasting);const t=this.settings.activity[c.user.id];return t.speaking!==this.broadcasting&&c.user.broadcastActivity({av:{speaking:this.broadcasting}}),t.speaking=this.broadcasting,ui.webrtc.setUserIsSpeaking(c.user.id,this.broadcasting)}_initializeUserVoiceDetection(e){if(c.audio.stopLevelReports(c.user.id),!["always","activity"].includes(e))return;const t=this.client.getLevelsStreamForUser(c.user.id),i="activity"===e?g.WebRTC.detectSelfVolumeInterval:g.WebRTC.detectPeerVolumeInterval;this.activateVoiceDetection(t,i)}activateVoiceDetection(e,t){if(this.deactivateVoiceDetection(),!e||!e.getAudioTracks().some((e=>e.enabled)))return;t=t||g.WebRTC.detectPeerVolumeInterval;const i=this._onAudioLevel.bind(this);c.audio.startLevelReports(c.userId,e,i,t)}deactivateVoiceDetection(){this._resetSpeakingHistory(),c.audio.stopLevelReports(c.userId)}_onAudioLevel(e){const t=this.settings.client.voice,i=this._speakingData,n=i.speaking;i.volumeHistories.push(e)>g.WebRTC.speakingHistoryLength&&i.volumeHistories.shift();const[s,o,r]=i.volumeHistories.reduce(((e,i)=>(i>=t.activityThreshold&&(e[0]+=1,e[1]=Math.min(e[1],i),e[2]+=i),e)),[0,0,0]),a=s>(n?0:g.WebRTC.speakingThresholdEvents)&&!this.client.isMuted;if(i.speaking=a,a!==n)return this.client.isVoiceActivated?this.broadcast(a):void 0}_resetSpeakingHistory(){ui.webrtc&&ui.webrtc.setUserIsSpeaking(c.userId,!1),this._speakingData.speaking=!1,this._speakingData.volumeHistories=[]}_onPTTStart(e){if(!this._connected)return!1;const t=this.settings.client.voice;return"ptt"===t.mode?(this._pttMuteTimeout>0&&clearTimeout(this._pttMuteTimeout),this._pttMuteTimeout=0,this.broadcast(!0)):this._pttMuteTimeout=setTimeout((()=>this.broadcast(!1)),t.pttDelay),!0}_onPTTEnd(e){if(!this._connected)return!1;const t=this.settings.client.voice;return"ptt"===t.mode?this._pttMuteTimeout=setTimeout((()=>this.broadcast(!1)),t.pttDelay):(this._pttMuteTimeout>0&&clearTimeout(this._pttMuteTimeout),this._pttMuteTimeout=0,this.broadcast(!0)),!0}render(){return ui.webrtc.render()}onRender(){const e=this.client.getConnectedUsers();for(let t of e){const e=ui.webrtc.getUserVideoElement(t);if(!e)continue;const i=this.settings.activity[t]?.speaking||!1;this.client.setUserVideo(t,e),ui.webrtc.setUserIsSpeaking(t,i)}const t=AVSettings.DOCK_POSITIONS,i=[t.RIGHT,t.BOTTOM].includes(this.settings.client.dockPosition),n=document.getElementById("interface"),s=ui.webrtc.element[0];ui.players.render(!0),(this.settings.client.hideDock||ui.webrtc.hidden)&&(s?.style.removeProperty("width"),s?.style.removeProperty("height")),document.body.classList.toggle("av-horizontal-dock",!this.settings.verticalDock),s&&(i&&n.nextElementSibling!==s?document.body.insertBefore(n,s):i||s.nextElementSibling===n||document.body.insertBefore(s,n))}onSettingsChanged(e){const t=Object.keys(foundry.utils.flattenObject(e));if(t.includes("world.turn"))return this.connect();const i=foundry.utils.getProperty(e,`client.users.${c.userId}`)||{};"hidden"in i&&this.client.toggleVideo(this.canUserShareVideo(c.userId)),"muted"in i&&this.client.toggleAudio(this.canUserShareAudio(c.userId));const n=[AVSettings.DOCK_POSITIONS.LEFT,AVSettings.DOCK_POSITIONS.RIGHT].includes(e.client?.dockPosition),s=e.client?.dockWidth??this.settings.client.dockWidth??240;n&&(ui.webrtc.position.width=s),t.includes("client.dockPosition")&&(ui.webrtc.options.resizable.rtl=e.client.dockPosition===AVSettings.DOCK_POSITIONS.RIGHT);["client.borderColors","client.dockPosition","client.nameplates"].some((e=>t.includes(e)))&&ui.webrtc.render(!0),this.client.onSettingsChanged(e)}debug(e){this.settings.debug&&console.debug(e)}}class AVSettings{constructor(){this.initialize(),this._set=foundry.utils.debounce(((e,t)=>c.settings.set("core",e,t)),100),this._change=foundry.utils.debounce(this._onSettingsChanged.bind(this),100),this.activity[c.userId]={}}static AV_MODES={DISABLED:0,AUDIO:1,VIDEO:2,AUDIO_VIDEO:3};static VOICE_MODES={ALWAYS:"always",ACTIVITY:"activity",PTT:"ptt"};static NAMEPLATE_MODES={OFF:0,BOTH:1,PLAYER_ONLY:2,CHAR_ONLY:3};static DOCK_POSITIONS={TOP:"top",RIGHT:"right",BOTTOM:"bottom",LEFT:"left"};static DEFAULT_CLIENT_SETTINGS={videoSrc:"default",audioSrc:"default",audioSink:"default",dockPosition:AVSettings.DOCK_POSITIONS.LEFT,hidePlayerList:!1,hideDock:!1,muteAll:!1,disableVideo:!1,borderColors:!1,dockWidth:240,nameplates:AVSettings.NAMEPLATE_MODES.BOTH,voice:{mode:AVSettings.VOICE_MODES.PTT,pttName:"`",pttDelay:100,activityThreshold:-45},users:{}};static DEFAULT_WORLD_SETTINGS={mode:AVSettings.AV_MODES.DISABLED,turn:{type:"server",url:"",username:"",password:""}};static DEFAULT_USER_SETTINGS={popout:!1,x:100,y:100,z:0,width:320,volume:1,muted:!1,hidden:!1,blocked:!1};activity={};initialize(){this.client=c.settings.get("core","rtcClientSettings"),this.world=c.settings.get("core","rtcWorldSettings"),this._original=foundry.utils.deepClone({client:this.client,world:this.world});const{muted:e,hidden:t}=this._getUserSettings(c.user);c.user.broadcastActivity({av:{muted:e,hidden:t}})}changed(){return this._change()}get(e,t){return foundry.utils.getProperty(this[e],t)}getUser(e){const t=c.users.get(e);return t?this._getUserSettings(t):null}set(e,t,i){foundry.utils.setProperty(this[e],t,i),this._set(`rtc${e.titleCase()}Settings`,this[e])}get users(){const e={};for(let t of c.users)e[t.id]=this._getUserSettings(t);return e}get verticalDock(){const e=this.constructor.DOCK_POSITIONS;return[e.LEFT,e.RIGHT].includes(this.client.dockPosition??e.LEFT)}_getUserSettings(e){const t=this.client.users[e.id]||{},i=this.activity[e.id]||{},n=foundry.utils.mergeObject(AVSettings.DEFAULT_USER_SETTINGS,t,{inplace:!1});return n.canBroadcastAudio=e.can("BROADCAST_AUDIO"),n.canBroadcastVideo=e.can("BROADCAST_VIDEO"),e.isSelf?(n.muted||=!c.webrtc?.client.isAudioEnabled(),n.hidden||=!c.webrtc?.client.isVideoEnabled()):(n.muted||=!!i.muted,n.hidden||=!!i.hidden),n.speaking=i.speaking,n}_onSettingsChanged(){const e=this._original;this.initialize();const t=foundry.utils.diffObject(e,this._original);c.webrtc.onSettingsChanged(t),Hooks$1.callAll("rtcSettingsChanged",this,t)}handleUserActivity(e,t){const i=this.activity[e]||{};if(this.activity[e]=foundry.utils.mergeObject(i,t,{inplace:!1}),!ui.webrtc)return;const n="hidden"in t&&i.hidden!==t.hidden,s="muted"in t&&i.muted!==t.muted;(n||s)&&ui.webrtc.getUserVideoElement(e)&&ui.webrtc._refreshView(e),"speaking"in t&&ui.webrtc.setUserIsSpeaking(e,t.speaking)}}const g=globalThis.CONFIG={debug:{applications:!1,audio:!1,combat:!1,dice:!1,documents:!1,fog:{extractor:!1,manager:!1},hooks:!1,av:!1,avclient:!1,mouseInteraction:!1,time:!1,keybindings:!1,polygons:!1,gamepad:!1,canvas:{primary:{bounds:!1}},rollParsing:!1},compatibility:{mode:CONST.COMPATIBILITY_MODES.WARNING,includePatterns:[],excludePatterns:[]},compendium:{uuidRedirects:{}},DatabaseBackend:new foundry.data.ClientDatabaseBackend,Actor:{documentClass:Actor,collection:class Actors extends WorldCollection{get tokens(){return canvas.ready&&canvas.scene?canvas.scene.tokens.reduce(((e,t)=>(t.actorLink||(e[t.id]=t.actor),e)),{}):{}}static documentName="Actor";fromCompendium(e,t={}){const i=super.fromCompendium(e,t);if(!1!==t.clearPrototypeToken&&"prototypeToken"in i){const e=c.settings.get("core",DefaultTokenConfig.SETTING)??{};foundry.data.PrototypeToken.schema.apply((function(e){"object"!=typeof e&&foundry.utils.setProperty(i.prototypeToken,this.fieldPath,void 0)}),e,{partial:!0})}if(i._id){const e=new Set(i.items.map((e=>e._id)));for(let t of i.effects){if(!t.origin)continue;const n=t.origin.split(".").pop();e.has(n)&&(t.origin=`Actor.${i._id}.Item.${n}`)}}return i}},compendiumIndexFields:[],compendiumBanner:"ui/banners/actor-banner.webp",sidebarIcon:"fas fa-user",dataModels:{},typeLabels:{},typeIcons:{},trackableAttributes:{}},Adventure:{documentClass:Adventure,exporterClass:class AdventureExporter extends DocumentSheet{constructor(e,t={}){if(super(e,t),!e.pack)throw new Error("You may not export an Adventure that does not belong to a Compendium pack")}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"templates/adventure/exporter.html",id:"adventure-exporter",classes:["sheet","adventure","adventure-exporter"],width:560,height:"auto",tabs:[{navSelector:".tabs",contentSelector:"form",initial:"summary"}],dragDrop:[{dropSelector:"form"}],scrollY:[".tab.contents"],submitOnClose:!1,closeOnSubmit:!0})}adventure=this.object;contentTree={};#mc={};#fc=Object.keys(Adventure.contentFields).reduce(((e,t)=>(e[t]=new Set,e)),{});#vc=Object.keys(Adventure.contentFields).reduce(((e,t)=>(e[t]=new Set,e)),{});#yc=new Set;get isEditable(){return c.user.isGM}async getData(e={}){return this.contentTree=this.#bc(),{adventure:this.adventure,contentTree:this.contentTree}}async activateEditor(e,t={},i=""){return t.plugins={menu:ProseMirror.ProseMirrorMenu.build(ProseMirror.defaultSchema),keyMaps:ProseMirror.ProseMirrorKeyMaps.build(ProseMirror.defaultSchema)},super.activateEditor(e,t,i)}_getHeaderButtons(){return super._getHeaderButtons().filter((e=>"Import"!==e.label))}#bc(){const e={};let t=Array.from(this.adventure.folders).concat(Array.from(this.#fc.folders||[]));for(const[i,n]of Object.entries(Adventure.contentFields)){if("folders"===i)continue;let s,o=Array.from(this.adventure[i]).concat(Array.from(this.#fc[i]||[]));if([t,s]=t.partition((e=>e.type===n.documentName)),!o.length&&!s.length)continue;const r=this.#yc.has(n.documentName),a=e[i]={documentName:n.documentName,collection:n.collectionName,id:null,name:c.i18n.localize(n.metadata.labelPlural),icon:g[n.documentName].sidebarIcon,collapseIcon:r?"fa-solid fa-angle-up":"fa-solid fa-angle-down",cssClass:[n.collectionName,r?"collapsed":""].filterJoin(" "),documentCount:o.length-this.#vc[i].size,folder:null,state:"root",children:[],documents:[]};[s,o]=this.#Sc(a,s,o);for(const e of o){const t=this.#Tc(e);a.documents.push({document:e,id:e.id,name:e.name,state:t,stateLabel:`ADVENTURE.Document${t.titleCase()}`})}}return e}#Sc(e,t,i){let n,s;[i,n]=i.partition((t=>t._source.folder===e.id));for(const t of n){const i=this.#Tc(t);e.documents.push({document:t,id:t.id,name:t.name,state:i,stateLabel:`ADVENTURE.Document${i.titleCase()}`})}[t,s]=t.partition((t=>t._source.folder===e.id));for(const n of s){const s=this.#Tc(n),o={folder:n,id:n.id,name:n.name,state:s,stateLabel:`ADVENTURE.Document${s.titleCase()}`,children:[],documents:[]};[t,i]=this.#Sc(o,t,i),e.children.push(o),this.#mc[n.id]=o}return[t,i]}#Tc(e){const t=e.collectionName;if(this.#vc[t].has(e.id))return"remove";if(this.#fc[t].has(e))return"add";return c.collections.get(e.documentName).has(e.id)?"update":"missing"}async close(e={}){return this.adventure.reset(),super.close(e)}activateListeners(e){super.activateListeners(e),e.on("click","a.control",this.#Ec.bind(this))}async _updateObject(e,t){for(const[e,i]of Object.entries(Adventure.contentFields)){const n=c.collections.get(i.documentName);t[e]=[];const addDoc=i=>{if(this.#vc[e].has(i))return;const s=n.get(i);s&&t[e].push(s.toObject())};for(const t of this.adventure[e])addDoc(t.id);for(const t of this.#fc[e])addDoc(t.id)}const i=c.packs.get(this.adventure.pack);if((t.actors?.length||t.items?.length||t.folders?.some((e=>CONST.SYSTEM_SPECIFIC_COMPENDIUM_TYPES.includes(e.type))))&&!i?.metadata.system)return ui.notifications.error("ADVENTURE.ExportPackNoSystem",{localize:!0,permanent:!0});if(this.adventure.id){const e=await this.adventure.update(t,{diff:!1,recursive:!1});i.indexDocument(e),ui.notifications.info(c.i18n.format("ADVENTURE.UpdateSuccess",{name:this.adventure.name}))}else await this.adventure.constructor.createDocuments([t],{pack:this.adventure.pack,keepId:!0,keepEmbeddedIds:!0}),ui.notifications.info(c.i18n.format("ADVENTURE.CreateSuccess",{name:this.adventure.name}))}#Cc(){const e=this._getSubmitData();this.adventure.updateSource(e)}#Ec(e){e.preventDefault();const t=e.currentTarget;switch(t.dataset.action){case"clear":return this.#_c(t);case"collapse":return this.#Ic(t);case"remove":return this.#wc(t)}}#_c(e){const t=getDocumentClass(e.closest(".document-type").dataset.documentType);this.#Dc(this.contentTree[t.collectionName]),this.#Cc(),this.render()}#Ic(e){const t=e.closest(".document-type"),i=e.firstElementChild,n=t.dataset.documentType;this.#yc.has(n)?(this.#yc.delete(n),t.classList.remove("collapsed"),i.classList.replace("fa-angle-up","fa-angle-down")):(this.#yc.add(n),t.classList.add("collapsed"),i.classList.replace("fa-angle-down","fa-angle-up"))}#wc(e){const t=e.closest("h4"),i=t.classList.contains("folder")?"Folder":e.closest(".document-type").dataset.documentType,n=this.#Oc(i,t.dataset.documentId);n&&(this.removeContent(n),this.#Cc(),this.render())}#Oc(e,t){const i=getDocumentClass(e).collectionName,n=this.adventure[i].find((e=>e.id===t));if(n)return n;return this.#fc[i].find((e=>e.id===t))||null}async _onDrop(e){const t=TextEditor$1.getDragEventData(e),i=getDocumentClass(t?.type);if(!i||!(i.collectionName in Adventure.contentFields))return;const n=await i.fromDropData(t);if(n.pack||n.isEmbedded)return ui.notifications.error("ADVENTURE.ExportPrimaryDocumentsOnly",{localize:!0});const s=c.packs.get(this.adventure.pack),o="Folder"===t?.type?n.type:t?.type;if(!s?.metadata.system&&CONST.SYSTEM_SPECIFIC_COMPENDIUM_TYPES.includes(o))return ui.notifications.error("ADVENTURE.ExportPackNoSystem",{localize:!0});this.addContent(n),this.#Cc(),this.render()}addContent(e){e instanceof foundry.documents.BaseFolder&&this.#xc(e),e.folder&&this.#Nc(e.folder),this.#Nc(e)}removeContent(e){if(e instanceof foundry.documents.BaseFolder){const t=this.#mc[e.id];if(!t)return;return this.#vc.folders.has(t.id)?this.#Ac(t):this.#Dc(t)}this.#Rc(e)}#Dc(e){for(const t of e.children)this.#Dc(t);for(const t of e.documents)this.#Rc(t.document);e.folder&&this.#Rc(e.folder)}#Ac(e){for(const t of e.children)this.#Ac(t);for(const t of e.documents)this.#vc[t.document.collectionName].delete(t.id);return this.#vc.folders.delete(e.id)}#Rc(e){const t=e.collectionName;this.#vc[t].has(e.id)?this.#vc[t].delete(e.id):this.#fc[t].has(e)?this.#fc[t].delete(e):this.#vc[t].add(e.id)}#xc(e){this.#Nc(e);for(const t of e.contents)this.#Nc(t);for(const t of e.getSubfolders())this.#xc(t)}#Nc(e){const t=e.collectionName;if(this.#vc[t].has(e.id))return this.#vc[t].delete(e.id);this.adventure[t].find((t=>t.id===e.id))||this.#fc[t].add(e)}},compendiumIndexFields:[],compendiumBanner:"ui/banners/adventure-banner.webp",sidebarIcon:"fa-solid fa-treasure-chest"},Cards:{collection:class CardStacks extends WorldCollection{static documentName="Cards"},compendiumIndexFields:[],compendiumBanner:"ui/banners/cards-banner.webp",documentClass:Cards,sidebarIcon:"fa-solid fa-cards",dataModels:{},presets:{pokerDark:{type:"deck",label:"CARDS.DeckPresetPokerDark",src:"cards/poker-deck-dark.json"},pokerLight:{type:"deck",label:"CARDS.DeckPresetPokerLight",src:"cards/poker-deck-light.json"}},typeLabels:{},typeIcons:{deck:"fas fa-cards",hand:"fa-duotone fa-cards",pile:"fa-duotone fa-layer-group"}},ChatMessage:{documentClass:ChatMessage,collection:class Messages extends WorldCollection{static documentName="ChatMessage";get directory(){return ui.chat}render(e=!1){}sayBubble(e){const{content:t,style:i,speaker:n}=e;if(n.scene===canvas.scene.id){const e=canvas.tokens.get(n.token);e&&canvas.hud.bubbles.say(e,t,{cssClasses:i===CONST.CHAT_MESSAGE_STYLES.EMOTE?["emote"]:[]})}}export(){saveDataToFile(this.contents.map((e=>e.export())).join("\n---------------------------\n"),"text/plain",`fvtt-log-${(new Date).toDateString().replace(/\s/g,"-")}.txt`)}async flush(){return Dialog.confirm({title:c.i18n.localize("CHAT.FlushTitle"),content:`<h4>${c.i18n.localize("AreYouSure")}</h4><p>${c.i18n.localize("CHAT.FlushWarning")}</p>`,yes:async()=>{await this.documentClass.deleteDocuments([],{deleteAll:!0});document.querySelector(".jump-to-bottom").classList.add("hidden")},options:{top:window.innerHeight-150,left:window.innerWidth-720}})}},template:"templates/sidebar/chat-message.html",sidebarIcon:"fas fa-comments",dataModels:{},typeLabels:{},typeIcons:{},batchSize:100},Combat:{documentClass:Combat,collection:CombatEncounters,sidebarIcon:"fas fa-swords",dataModels:{},typeLabels:{},typeIcons:{},initiative:{formula:null,decimals:2},sounds:{epic:{label:"COMBAT.Sounds.Epic",startEncounter:["sounds/combat/epic-start-3hit.ogg","sounds/combat/epic-start-horn.ogg"],nextUp:["sounds/combat/epic-next-horn.ogg"],yourTurn:["sounds/combat/epic-turn-1hit.ogg","sounds/combat/epic-turn-2hit.ogg"]},mc:{label:"COMBAT.Sounds.MC",startEncounter:["sounds/combat/mc-start-battle.ogg","sounds/combat/mc-start-begin.ogg","sounds/combat/mc-start-fight.ogg","sounds/combat/mc-start-fight2.ogg"],nextUp:["sounds/combat/mc-next-itwillbe.ogg","sounds/combat/mc-next-makeready.ogg","sounds/combat/mc-next-youare.ogg"],yourTurn:["sounds/combat/mc-turn-itisyour.ogg","sounds/combat/mc-turn-itsyour.ogg"]}}},Dice:{types:[foundry.dice.terms.Die,foundry.dice.terms.FateDie],rollModes:Object.entries(CONST.DICE_ROLL_MODES).reduce(((e,t)=>{let[i,n]=t;return e[n]=`CHAT.Roll${i.titleCase()}`,e}),{}),rolls:[Roll],termTypes:{DiceTerm:foundry.dice.terms.DiceTerm,FunctionTerm:foundry.dice.terms.FunctionTerm,NumericTerm:foundry.dice.terms.NumericTerm,OperatorTerm:foundry.dice.terms.OperatorTerm,ParentheticalTerm:foundry.dice.terms.ParentheticalTerm,PoolTerm:foundry.dice.terms.PoolTerm,StringTerm:foundry.dice.terms.StringTerm},terms:{c:foundry.dice.terms.Coin,d:foundry.dice.terms.Die,f:foundry.dice.terms.FateDie},randomUniform:foundry.dice.MersenneTwister.random,parser:foundry.dice.RollParser,functions:{},fulfillment:{dice:{d4:{label:"d4",icon:'<i class="fas fa-dice-d4"></i>'},d6:{label:"d6",icon:'<i class="fas fa-dice-d6"></i>'},d8:{label:"d8",icon:'<i class="fas fa-dice-d8"></i>'},d10:{label:"d10",icon:'<i class="fas fa-dice-d10"></i>'},d12:{label:"d12",icon:'<i class="fas fa-dice-d12"></i>'},d20:{label:"d20",icon:'<i class="fas fa-dice-d20"></i>'},d100:{label:"d100",icon:'<i class="fas fa-percent"></i>'}},methods:{mersenne:{label:"DICE.FULFILLMENT.Mersenne",interactive:!1,handler:e=>e.mapRandomFace(foundry.dice.MersenneTwister.random())},manual:{label:"DICE.FULFILLMENT.Manual",icon:'<i class="fas fa-keyboard"></i>',interactive:!0}},defaultMethod:""}},FogExploration:{documentClass:FogExploration,collection:FogExplorations},Folder:{documentClass:Folder,collection:class Folders extends WorldCollection{static documentName="Folder";_expanded={};_onModifyContents(e,t,i,n,s){if(n.render){const n=new Set(t.map((e=>e.type)));for(const t of n)if("Compendium"===t)ui.sidebar.tabs.compendium.render(!1);else{c.collections.get(t).render(!1,{renderContext:`${e}${this.documentName}`,renderData:i})}n.has("JournalEntry")&&this._refreshJournalEntrySheets()}}_refreshJournalEntrySheets(){for(let e of Object.values(ui.windows))e instanceof JournalSheet&&e.submit()}render(e,t={}){console.warn("The Folders collection is not directly rendered")}},sidebarIcon:"fas fa-folder"},Item:{documentClass:Item,collection:class Items extends WorldCollection{static documentName="Item"},compendiumIndexFields:[],compendiumBanner:"ui/banners/item-banner.webp",sidebarIcon:"fas fa-suitcase",dataModels:{},typeLabels:{},typeIcons:{}},JournalEntry:{documentClass:JournalEntry,collection:Journal,compendiumIndexFields:[],compendiumBanner:"ui/banners/journalentry-banner.webp",noteIcons:{Anchor:"icons/svg/anchor.svg",Barrel:"icons/svg/barrel.svg",Book:"icons/svg/book.svg",Bridge:"icons/svg/bridge.svg",Cave:"icons/svg/cave.svg",Castle:"icons/svg/castle.svg",Chest:"icons/svg/chest.svg",City:"icons/svg/city.svg",Coins:"icons/svg/coins.svg",Fire:"icons/svg/fire.svg","Hanging Sign":"icons/svg/hanging-sign.svg",House:"icons/svg/house.svg",Mountain:"icons/svg/mountain.svg","Oak Tree":"icons/svg/oak.svg",Obelisk:"icons/svg/obelisk.svg",Pawprint:"icons/svg/pawprint.svg",Ruins:"icons/svg/ruins.svg",Skull:"icons/svg/skull.svg",Statue:"icons/svg/statue.svg",Sword:"icons/svg/sword.svg",Tankard:"icons/svg/tankard.svg",Temple:"icons/svg/temple.svg",Tower:"icons/svg/tower.svg",Trap:"icons/svg/trap.svg",Village:"icons/svg/village.svg",Waterfall:"icons/svg/waterfall.svg",Windmill:"icons/svg/windmill.svg"},sidebarIcon:"fas fa-book-open"},Macro:{documentClass:Macro,collection:class Macros extends WorldCollection{static documentName="Macro";get directory(){return ui.macros}fromCompendium(e,t={}){const i=super.fromCompendium(e,t);return t.clearOwnership&&(i.author=c.user.id),i}},compendiumIndexFields:[],compendiumBanner:"ui/banners/macro-banner.webp",sidebarIcon:"fas fa-code"},Playlist:{documentClass:Playlist,collection:class Playlists extends WorldCollection{static documentName="Playlist";get playing(){return this.filter((e=>e.playing))}async initialize(){await c.audio.unlock;for(let e of this)for(let t of e.sounds)t.sync();ui.playlists?.render()}async _onChangeScene(e,t){const i=c.scenes.active,n=i?.playlist,s=i?.playlistSound,o="playlist"in t?c.playlists.get(t.playlist):e.playlist,r="playlistSound"in t?o?.sounds.get(t.playlistSound):e.playlistSound;(n!==o||s!==r)&&(s?await s.update({playing:!1}):n&&await n.stopAll(),r?await r.update({playing:!0}):o&&await o.playAll())}},compendiumIndexFields:[],compendiumBanner:"ui/banners/playlist-banner.webp",sidebarIcon:"fas fa-music",autoPreloadSeconds:20},RollTable:{documentClass:RollTable,collection:RollTables,compendiumIndexFields:["formula"],compendiumBanner:"ui/banners/rolltable-banner.webp",sidebarIcon:"fas fa-th-list",resultIcon:"icons/svg/d20-black.svg",resultTemplate:"templates/dice/table-result.html"},Scene:{documentClass:Scene,collection:Scenes,compendiumIndexFields:[],compendiumBanner:"ui/banners/scene-banner.webp",sidebarIcon:"fas fa-map"},Setting:{documentClass:Setting,collection:WorldSettings},User:{documentClass:User,collection:Users},Canvas:{blurStrength:8,blurQuality:4,darknessColor:3158064,daylightColor:15658734,brightestColor:16777215,chatBubblesClass:ChatBubbles,darknessLightPenalty:.25,dispositionColors:{HOSTILE:15147300,NEUTRAL:15849526,FRIENDLY:4448223,INACTIVE:5592405,PARTY:3390542,CONTROLLED:16750633,SECRET:10883796},doorControlClass:DoorControl,exploredColor:0,unexploredColor:0,darknessToDaylightAnimationMS:1e4,daylightToDarknessAnimationMS:1e4,darknessSourceClass:foundry.canvas.sources.PointDarknessSource,lightSourceClass:foundry.canvas.sources.PointLightSource,globalLightSourceClass:foundry.canvas.sources.GlobalLightSource,visionSourceClass:foundry.canvas.sources.PointVisionSource,soundSourceClass:foundry.canvas.sources.PointSoundSource,groups:{hidden:{groupClass:HiddenCanvasGroup,parent:"stage"},rendered:{groupClass:RenderedCanvasGroup,parent:"stage"},environment:{groupClass:EnvironmentCanvasGroup,parent:"rendered"},primary:{groupClass:PrimaryCanvasGroup,parent:"environment"},effects:{groupClass:EffectsCanvasGroup,parent:"environment"},visibility:{groupClass:CanvasVisibility,parent:"rendered"},interface:{groupClass:InterfaceCanvasGroup,parent:"rendered",zIndexDrawings:500,zIndexScrollingText:1100},overlay:{groupClass:OverlayCanvasGroup,parent:"stage"}},layers:{weather:{layerClass:WeatherEffects,group:"primary"},grid:{layerClass:class GridLayer extends CanvasLayer{mesh;highlight;highlightLayers={};static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"grid"})}async _draw(e){this.highlightLayers={},this.highlight=this.addChild(new PIXI.Container),this.highlight.sortableChildren=!0,this.mesh=this.addChild(await this._drawMesh()),this.initializeMesh(canvas.grid)}async _drawMesh(){return(new GridMesh).initialize({type:canvas.grid.type,width:canvas.dimensions.width,height:canvas.dimensions.height,size:canvas.dimensions.size})}initializeMesh({style:e,thickness:t,color:i,alpha:n}){const{shaderClass:s,shaderOptions:o}=g.Canvas.gridStyles[e]??{};this.mesh.initialize({thickness:t,color:i,alpha:n}),this.mesh.setShaderClass(s??GridShader),this.mesh.shader.configure(o??{})}addHighlightLayer(e){const t=this.highlightLayers[e];return t&&!t._destroyed||(this.highlightLayers[e]=this.highlight.addChild(new GridHighlight(e))),this.highlightLayers[e]}clearHighlightLayer(e){const t=this.highlightLayers[e];t&&t.clear()}destroyHighlightLayer(e){const t=this.highlightLayers[e];t&&(this.highlight.removeChild(t),t.destroy())}getHighlightLayer(e){return this.highlightLayers[e]}highlightPosition(e,{x:t,y:i,color:n=3390463,border:s=null,alpha:o=.25,shape:r=null}){const a=this.highlightLayers[e];if(!a)return;const l=canvas.grid;if(l.type!==CONST.GRID_TYPES.GRIDLESS){const e=t+l.sizeX/2,n=i+l.sizeY/2,s=l.getShape();for(const t of s)t.x+=e,t.y+=n;r=new PIXI.Polygon(s)}else if(!r)return;a.highlight(t,i)&&(a.beginFill(n,o),null!==s&&a.lineStyle(2,s,Math.min(1.5*o,1)),a.drawShape(r).endFill())}get type(){return foundry.utils.logCompatibilityWarning("GridLayer#type is deprecated. Use canvas.grid.type instead.",{since:12,until:14,once:!0}),canvas.grid.type}get size(){return foundry.utils.logCompatibilityWarning("GridLayer#size is deprecated. Use canvas.grid.size instead.",{since:12,until:14,once:!0}),canvas.grid.size}get grid(){return foundry.utils.logCompatibilityWarning("GridLayer#grid is deprecated. Use canvas.grid instead.",{since:12,until:14,once:!0}),canvas.grid}isNeighbor(e,t,i,n){return foundry.utils.logCompatibilityWarning("GridLayer#isNeighbor is deprecated. Use canvas.grid.testAdjacency instead.",{since:12,until:14,once:!0}),canvas.grid.testAdjacency({i:e,j:t},{i:i,j:n})}get w(){return foundry.utils.logCompatibilityWarning("GridLayer#w is deprecated in favor of canvas.grid.sizeX.",{since:12,until:14,once:!0}),canvas.grid.sizeX}get h(){return foundry.utils.logCompatibilityWarning("GridLayer#h is deprecated in favor of canvas.grid.sizeY.",{since:12,until:14,once:!0}),canvas.grid.sizeY}get isHex(){return foundry.utils.logCompatibilityWarning("GridLayer#isHex is deprecated. Use canvas.grid.isHexagonal instead.",{since:12,until:14,once:!0}),canvas.grid.isHexagonal}getTopLeft(e,t){return foundry.utils.logCompatibilityWarning("GridLayer#getTopLeft is deprecated. Use canvas.grid.getTopLeftPoint instead.",{since:12,until:14,once:!0}),canvas.grid.getTopLeft(e,t)}getCenter(e,t){return foundry.utils.logCompatibilityWarning("GridLayer#getCenter is deprecated. Use canvas.grid.getCenterPoint instead.",{since:12,until:14,once:!0}),canvas.grid.getCenter(e,t)}getSnappedPosition(e,t,i=1,n={}){return foundry.utils.logCompatibilityWarning("GridLayer#getSnappedPosition is deprecated. Use canvas.grid.getSnappedPoint instead.",{since:12,until:14,once:!0}),0===i?{x:Math.round(e),y:Math.round(t)}:canvas.grid.getSnappedPosition(e,t,i,n)}measureDistance(e,t,i={}){foundry.utils.logCompatibilityWarning("GridLayer#measureDistance is deprecated. Use canvas.grid.measurePath instead for non-Euclidean measurements.",{since:12,until:14,once:!0});const n=[{ray:new Ray(e,t)}];return canvas.grid.measureDistances(n,i)[0]}},group:"interface"},regions:{layerClass:RegionLayer,group:"interface"},drawings:{layerClass:DrawingsLayer,group:"interface"},templates:{layerClass:TemplateLayer,group:"interface"},tiles:{layerClass:TilesLayer,group:"interface"},walls:{layerClass:WallsLayer,group:"interface"},tokens:{layerClass:TokenLayer,group:"interface"},sounds:{layerClass:SoundsLayer,group:"interface"},lighting:{layerClass:LightingLayer,group:"interface"},notes:{layerClass:NotesLayer,group:"interface"},controls:{layerClass:class ControlsLayer extends InteractionLayer{constructor(){super(),this.interactiveChildren=!0,this.doors=this.addChild(new PIXI.Container),this.cursors=this.addChild(new PIXI.Container),this.cursors.eventMode="none",this.cursors.mask=canvas.masks.canvas,this.rulers=this.addChild(new PIXI.Container),this.rulers.eventMode="none",this.debug=this.addChild(new PIXI.Graphics),this.debug.eventMode="none"}select;_cursors={};_rulers={};_offscreenPings={};static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"controls",zIndex:1e3})}get ruler(){return this.getRulerForUser(c.user.id)}getRulerForUser(e){return this._rulers[e]||null}async _draw(e){await super._draw(e),this.drawCursors(),this.drawRulers(),this.drawDoors(),this.select=this.cursors.addChild(new PIXI.Graphics);const t=canvas.dimensions;this.hitArea=t.rect}async _tearDown(e){this._cursors={},this._rulers={},this.doors.removeChildren(),this.cursors.removeChildren(),this.rulers.removeChildren(),this.debug.clear(),this.debug.debugText?.removeChildren().forEach((e=>e.destroy({children:!0})))}drawCursors(){for(let e of c.users.filter((e=>e.active&&!e.isSelf)))this.drawCursor(e)}drawRulers(){const e=g.Canvas.rulerClass;for(let t of c.users){let i=this.getRulerForUser(t.id);i||(i=this._rulers[t.id]=new e(t)),this.rulers.addChild(i)}}drawDoors(){for(const e of canvas.walls.placeables)e.isDoor&&e.createDoorControl()}drawSelect({x:e,y:t,width:i,height:n}){this.select.clear().lineStyle(3,16750633,.9).drawRect(e,t,i,n)}_deactivate(){this.interactiveChildren=!0}_onMouseMove(){c.user.hasPermission("SHOW_CURSOR")&&c.user.broadcastActivity({cursor:canvas.mousePosition})}_onLongPress(e,t){const i=c.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL),n=canvas.activeLayer instanceof TokenLayer;if(c.user.hasPermission("PING_CANVAS")&&!i&&n)return canvas.currentMouseManager.cancel(e),canvas.ping(t)}_onCanvasPan(){for(const[e,t]of Object.entries(this._offscreenPings)){const{ray:i,intersection:n}=this._findViewportIntersection(t);if(n){const{x:t,y:s}=canvas.canvasCoordinatesFromClient(n),o=CanvasAnimation.getAnimation(e).context;o.x=t,o.y=s,o.rotation=Math.normalizeRadians(i.angle+1.5*Math.PI)}else CanvasAnimation.terminateAnimation(e)}}drawCursor(e){return e.id in this._cursors&&(this._cursors[e.id].destroy({children:!0}),delete this._cursors[e.id]),this._cursors[e.id]=this.cursors.addChild(new Cursor(e))}updateCursor(e,t){if(!this.cursors)return;const i=this._cursors[e.id]||this.drawCursor(e);null!==t&&e.viewedScene===canvas.scene.id?(i.refreshVisibility(e),i.target={x:t.x||0,y:t.y||0}):i&&(i.visible=!1)}updateRuler(e,t){if(e===c.user||!e.hasPermission("SHOW_RULER"))return;const i=this.getRulerForUser(e.id);i?.update(t)}async handlePing(e,t,{scene:i,style:n="pulse",pull:s=!1,zoom:o=1,...r}={}){if(canvas.ready&&canvas.scene?.id===i&&t)return s&&(e.isGM||e.isSelf)?await canvas.animatePan({x:t.x,y:t.y,scale:Math.min(g.Canvas.maxZoom,o),duration:g.Canvas.pings.pullSpeed}):canvas.isOffscreen(t)&&this.drawOffscreenPing(t,{style:"arrow",user:e}),c.settings.get("core","photosensitiveMode")&&(n=g.Canvas.pings.types.PULL),this.drawPing(t,{style:n,user:e,...r})}async drawOffscreenPing(e,{style:t="arrow",user:i,...n}={}){const{ray:s,intersection:o}=this._findViewportIntersection(e);if(!o)return;const r=`Ping.${foundry.utils.randomID()}`;this._offscreenPings[r]=e,e=canvas.canvasCoordinatesFromClient(o),c.settings.get("core","photosensitiveMode")&&(n.rings=1);const a=this.drawPing(e,{style:t,user:i,name:r,rotation:s.angle,...n});return a.finally((()=>delete this._offscreenPings[r])),a}async drawPing(e,{style:t="pulse",user:i,...n}={}){const s=g.Canvas.pings.styles[t]??g.Canvas.pings.styles.pulse,o={duration:s.duration,color:s.color??i?.color,size:canvas.dimensions.size*(s.size||1)},r=new s.class(e,foundry.utils.mergeObject(o,n));return this.cursors.addChild(r),r.animate()}_findViewportIntersection(e){let{clientWidth:t,clientHeight:i}=document.documentElement;ui.sidebar._collapsed||(t-=ui.sidebar.options.width+10);const[n,s]=[t/2,i/2],o=new Ray({x:n,y:s},canvas.clientCoordinatesFromCanvas(e)),r=[[0,0,t,0],[t,0,t,i],[t,i,0,i],[0,i,0,0]].map(o.intersectSegment.bind(o));return{ray:o,intersection:r.find((e=>null!==e))}}},group:"interface"}},lightLevels:{dark:0,halfdark:.5,dim:.25,bright:1},fogManager:FogManager,polygonBackends:{sight:ClockwiseSweepPolygon,light:ClockwiseSweepPolygon,sound:ClockwiseSweepPolygon,move:ClockwiseSweepPolygon},darknessSourcePaddingMultiplier:.5,visibilityFilter:VisibilityFilter,visualEffectsMaskingFilter:VisualEffectsMaskingFilter,rulerClass:Ruler,dragSpeedModifier:.8,maxZoom:3,objectBorderThickness:4,gridStyles:{solidLines:{label:"GRID.STYLES.SolidLines",shaderClass:GridShader,shaderOptions:{style:0}},dashedLines:{label:"GRID.STYLES.DashedLines",shaderClass:GridShader,shaderOptions:{style:1}},dottedLines:{label:"GRID.STYLES.DottedLines",shaderClass:GridShader,shaderOptions:{style:2}},squarePoints:{label:"GRID.STYLES.SquarePoints",shaderClass:GridShader,shaderOptions:{style:3}},diamondPoints:{label:"GRID.STYLES.DiamondPoints",shaderClass:GridShader,shaderOptions:{style:4}},roundPoints:{label:"GRID.STYLES.RoundPoints",shaderClass:GridShader,shaderOptions:{style:5}}},lightAnimations:{flame:{label:"LIGHT.AnimationFlame",animation:foundry.canvas.sources.PointLightSource.prototype.animateFlickering,illuminationShader:FlameIlluminationShader,colorationShader:FlameColorationShader},torch:{label:"LIGHT.AnimationTorch",animation:foundry.canvas.sources.PointLightSource.prototype.animateTorch,illuminationShader:TorchIlluminationShader,colorationShader:TorchColorationShader},revolving:{label:"LIGHT.AnimationRevolving",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,colorationShader:RevolvingColorationShader},siren:{label:"LIGHT.AnimationSiren",animation:foundry.canvas.sources.PointLightSource.prototype.animateTorch,illuminationShader:SirenIlluminationShader,colorationShader:SirenColorationShader},pulse:{label:"LIGHT.AnimationPulse",animation:foundry.canvas.sources.PointLightSource.prototype.animatePulse,illuminationShader:PulseIlluminationShader,colorationShader:PulseColorationShader},chroma:{label:"LIGHT.AnimationChroma",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,colorationShader:ChromaColorationShader},wave:{label:"LIGHT.AnimationWave",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,illuminationShader:WaveIlluminationShader,colorationShader:WaveColorationShader},fog:{label:"LIGHT.AnimationFog",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,colorationShader:FogColorationShader},sunburst:{label:"LIGHT.AnimationSunburst",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,illuminationShader:SunburstIlluminationShader,colorationShader:SunburstColorationShader},dome:{label:"LIGHT.AnimationLightDome",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,colorationShader:LightDomeColorationShader},emanation:{label:"LIGHT.AnimationEmanation",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,colorationShader:EmanationColorationShader},hexa:{label:"LIGHT.AnimationHexaDome",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,colorationShader:HexaDomeColorationShader},ghost:{label:"LIGHT.AnimationGhostLight",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,illuminationShader:GhostLightIlluminationShader,colorationShader:GhostLightColorationShader},energy:{label:"LIGHT.AnimationEnergyField",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,colorationShader:EnergyFieldColorationShader},vortex:{label:"LIGHT.AnimationVortex",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,illuminationShader:VortexIlluminationShader,colorationShader:VortexColorationShader},witchwave:{label:"LIGHT.AnimationBewitchingWave",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,illuminationShader:BewitchingWaveIlluminationShader,colorationShader:BewitchingWaveColorationShader},rainbowswirl:{label:"LIGHT.AnimationSwirlingRainbow",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,colorationShader:SwirlingRainbowColorationShader},radialrainbow:{label:"LIGHT.AnimationRadialRainbow",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,colorationShader:RadialRainbowColorationShader},fairy:{label:"LIGHT.AnimationFairyLight",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,illuminationShader:FairyLightIlluminationShader,colorationShader:FairyLightColorationShader},grid:{label:"LIGHT.AnimationForceGrid",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,colorationShader:ForceGridColorationShader},starlight:{label:"LIGHT.AnimationStarLight",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,colorationShader:StarLightColorationShader},smokepatch:{label:"LIGHT.AnimationSmokePatch",animation:foundry.canvas.sources.PointLightSource.prototype.animateTime,illuminationShader:SmokePatchIlluminationShader,colorationShader:SmokePatchColorationShader}},darknessAnimations:{magicalGloom:{label:"LIGHT.AnimationMagicalGloom",animation:foundry.canvas.sources.PointDarknessSource.prototype.animateTime,darknessShader:MagicalGloomDarknessShader},roiling:{label:"LIGHT.AnimationRoilingMass",animation:foundry.canvas.sources.PointDarknessSource.prototype.animateTime,darknessShader:RoilingDarknessShader},hole:{label:"LIGHT.AnimationBlackHole",animation:foundry.canvas.sources.PointDarknessSource.prototype.animateTime,darknessShader:BlackHoleDarknessShader}},managedScenes:{},pings:{types:{PULSE:"pulse",ALERT:"alert",PULL:"chevron",ARROW:"arrow"},styles:{alert:{class:class AlertPing extends PulsePing{constructor(e,{color:t="#ff0000",...i}={}){super(e,{color:t,...i}),this._r=this.options.size}_drawShape(e,t,i,n){e.lineStyle({color:t,alpha:i,width:6,cap:PIXI.LINE_CAP.ROUND,join:PIXI.LINE_JOIN.BEVEL});const s=n/2,o=n/10,r=o/2,a=-s,l=-n/3;e.moveTo(a+o,l).lineTo(a+n-o,l).lineTo(a+n,l+o).lineTo(a+s+r,l+n-o).lineTo(a+s-r,l+n-o).lineTo(a,l+o).lineTo(a+o,l)}},color:"#ff0000",size:1.5,duration:900},arrow:{class:class ArrowPing extends PulsePing{constructor(e,{rotation:t=0,...i}={}){super(e,i),this.rotation=Math.normalizeRadians(t+1.5*Math.PI)}_drawShape(e,t,i,n){e.lineStyle({color:t,alpha:i,width:6,cap:PIXI.LINE_CAP.ROUND,join:PIXI.LINE_JOIN.BEVEL});const s=n/2,o=-s,r=-n;e.moveTo(o,r).lineTo(0,0).lineTo(s,r).lineTo(0,-s).lineTo(o,r)}},size:1,duration:900},chevron:{class:ChevronPing,size:1,duration:2e3},pulse:{class:PulsePing,size:1.5,duration:900}},pullSpeed:700},targeting:{size:.15},hoverFade:{delay:250,duration:750},transcoders:{basis:!1},visionModes:{basic:new VisionMode({id:"basic",label:"VISION.ModeBasicVision",vision:{defaults:{attenuation:0,contrast:0,saturation:0,brightness:0},preferred:!0}}),darkvision:new VisionMode({id:"darkvision",label:"VISION.ModeDarkvision",canvas:{shader:ColorAdjustmentsSamplerShader,uniforms:{contrast:0,saturation:-1,brightness:0}},lighting:{levels:{[VisionMode.LIGHTING_LEVELS.DIM]:VisionMode.LIGHTING_LEVELS.BRIGHT},background:{visibility:VisionMode.LIGHTING_VISIBILITY.REQUIRED}},vision:{darkness:{adaptive:!1},defaults:{attenuation:0,contrast:0,saturation:-1,brightness:0}}}),monochromatic:new VisionMode({id:"monochromatic",label:"VISION.ModeMonochromatic",canvas:{shader:ColorAdjustmentsSamplerShader,uniforms:{contrast:0,saturation:-1,brightness:0}},lighting:{background:{postProcessingModes:["SATURATION"],uniforms:{saturation:-1,tint:[1,1,1]}},illumination:{postProcessingModes:["SATURATION"],uniforms:{saturation:-1,tint:[1,1,1]}},coloration:{postProcessingModes:["SATURATION"],uniforms:{saturation:-1,tint:[1,1,1]}}},vision:{darkness:{adaptive:!1},defaults:{attenuation:0,contrast:0,saturation:-1,brightness:0}}}),blindness:new VisionMode({id:"blindness",label:"VISION.ModeBlindness",tokenConfig:!1,canvas:{shader:ColorAdjustmentsSamplerShader,uniforms:{contrast:-.75,saturation:-1,exposure:-.3}},lighting:{background:{visibility:VisionMode.LIGHTING_VISIBILITY.DISABLED},illumination:{visibility:VisionMode.LIGHTING_VISIBILITY.DISABLED},coloration:{visibility:VisionMode.LIGHTING_VISIBILITY.DISABLED}},vision:{darkness:{adaptive:!1},defaults:{color:null,attenuation:0,contrast:-.5,saturation:-1,brightness:-1}}}),tremorsense:new VisionMode({id:"tremorsense",label:"VISION.ModeTremorsense",canvas:{shader:ColorAdjustmentsSamplerShader,uniforms:{contrast:0,saturation:-.8,exposure:-.65}},lighting:{background:{visibility:VisionMode.LIGHTING_VISIBILITY.DISABLED},illumination:{visibility:VisionMode.LIGHTING_VISIBILITY.DISABLED},coloration:{visibility:VisionMode.LIGHTING_VISIBILITY.DISABLED},darkness:{visibility:VisionMode.LIGHTING_VISIBILITY.DISABLED}},vision:{darkness:{adaptive:!1},defaults:{attenuation:0,contrast:.2,saturation:-.3,brightness:1},background:{shader:WaveBackgroundVisionShader},coloration:{shader:WaveColorationVisionShader}}},{animated:!0}),lightAmplification:new VisionMode({id:"lightAmplification",label:"VISION.ModeLightAmplification",canvas:{shader:AmplificationSamplerShader,uniforms:{saturation:-.5,tint:[.38,.8,.38]}},lighting:{background:{visibility:VisionMode.LIGHTING_VISIBILITY.REQUIRED,postProcessingModes:["SATURATION","EXPOSURE"],uniforms:{saturation:-.5,exposure:1.5,tint:[.38,.8,.38]}},illumination:{postProcessingModes:["SATURATION"],uniforms:{saturation:-.5}},coloration:{postProcessingModes:["SATURATION","EXPOSURE"],uniforms:{saturation:-.5,exposure:1.5,tint:[.38,.8,.38]}},levels:{[VisionMode.LIGHTING_LEVELS.DIM]:VisionMode.LIGHTING_LEVELS.BRIGHT,[VisionMode.LIGHTING_LEVELS.BRIGHT]:VisionMode.LIGHTING_LEVELS.BRIGHTEST}},vision:{darkness:{adaptive:!1},defaults:{attenuation:0,contrast:0,saturation:-.5,brightness:1},background:{shader:AmplificationBackgroundVisionShader}}})},detectionModes:{lightPerception:new class DetectionModeLightPerception extends DetectionMode{_canDetect(e,t){const i=e.object.document;if(i.hasStatusEffect(g.specialStatusEffects.BLIND)||i.hasStatusEffect(g.specialStatusEffects.BURROW))return!1;if(t instanceof Token){const e=t.document;if(e.hasStatusEffect(g.specialStatusEffects.INVISIBLE)||e.hasStatusEffect(g.specialStatusEffects.BURROW))return!1}return!0}_testPoint(e,t,i,n){return!!super._testPoint(e,t,i,n)&&canvas.effects.testInsideLight(n.point,n.elevation)}}({id:"lightPerception",label:"DETECTION.LightPerception",type:DetectionMode.DETECTION_TYPES.SIGHT}),basicSight:new class DetectionModeBasicSight extends DetectionMode{_canDetect(e,t){const i=e.object.document;if(i.hasStatusEffect(g.specialStatusEffects.BLIND)||i.hasStatusEffect(g.specialStatusEffects.BURROW))return!1;if(t instanceof Token){const e=t.document;if(e.hasStatusEffect(g.specialStatusEffects.INVISIBLE)||e.hasStatusEffect(g.specialStatusEffects.BURROW))return!1}return!0}}({id:"basicSight",label:"DETECTION.BasicSight",type:DetectionMode.DETECTION_TYPES.SIGHT}),seeInvisibility:new DetectionModeInvisibility({id:"seeInvisibility",label:"DETECTION.SeeInvisibility",type:DetectionMode.DETECTION_TYPES.SIGHT}),senseInvisibility:new DetectionModeInvisibility({id:"senseInvisibility",label:"DETECTION.SenseInvisibility",walls:!1,angle:!1,type:DetectionMode.DETECTION_TYPES.OTHER}),feelTremor:new class DetectionModeTremor extends DetectionMode{static getDetectionFilter(){return this._detectionFilter??=OutlineOverlayFilter.create({outlineColor:[1,0,1,1],knockout:!0,wave:!0})}_canDetect(e,t){if(!(t instanceof Token))return!1;const i=t.document;return!i.hasStatusEffect(g.specialStatusEffects.FLY)&&!i.hasStatusEffect(g.specialStatusEffects.HOVER)}}({id:"feelTremor",label:"DETECTION.FeelTremor",walls:!1,angle:!1,type:DetectionMode.DETECTION_TYPES.MOVE}),seeAll:new DetectionModeAll({id:"seeAll",label:"DETECTION.SeeAll",type:DetectionMode.DETECTION_TYPES.SIGHT}),senseAll:new DetectionModeAll({id:"senseAll",label:"DETECTION.SenseAll",walls:!1,angle:!1,type:DetectionMode.DETECTION_TYPES.OTHER})}},canvasTextStyle:new PIXI.TextStyle({fontFamily:"Signika",fontSize:36,fill:"#FFFFFF",stroke:"#111111",strokeThickness:1,dropShadow:!0,dropShadowColor:"#000000",dropShadowBlur:2,dropShadowAngle:0,dropShadowDistance:0,align:"center",wordWrap:!1,padding:1}),weatherEffects:{leaves:{id:"leaves",label:"WEATHER.AutumnLeaves",effects:[{id:"leavesParticles",effectClass:AutumnLeavesWeatherEffect}]},rain:{id:"rain",label:"WEATHER.Rain",filter:{enabled:!1},effects:[{id:"rainShader",effectClass:WeatherShaderEffect,shaderClass:RainShader,blendMode:PIXI.BLEND_MODES.SCREEN,config:{opacity:.25,tint:[.7,.9,1],intensity:1,strength:1,rotation:.2618,speed:.2}}]},rainStorm:{id:"rainStorm",label:"WEATHER.RainStorm",filter:{enabled:!1},effects:[{id:"fogShader",effectClass:WeatherShaderEffect,shaderClass:FogShader,blendMode:PIXI.BLEND_MODES.SCREEN,performanceLevel:2,config:{slope:1.5,intensity:.05,speed:-55,scale:25}},{id:"rainShader",effectClass:WeatherShaderEffect,shaderClass:RainShader,blendMode:PIXI.BLEND_MODES.SCREEN,config:{opacity:.45,tint:[.7,.9,1],intensity:1.5,strength:1.5,rotation:.5236,speed:.3}}]},fog:{id:"fog",label:"WEATHER.Fog",filter:{enabled:!1},effects:[{id:"fogShader",effectClass:WeatherShaderEffect,shaderClass:FogShader,blendMode:PIXI.BLEND_MODES.SCREEN,config:{slope:.45,intensity:.4,speed:.4}}]},snow:{id:"snow",label:"WEATHER.Snow",filter:{enabled:!1},effects:[{id:"snowShader",effectClass:WeatherShaderEffect,shaderClass:SnowShader,blendMode:PIXI.BLEND_MODES.SCREEN,config:{tint:[.85,.95,1],direction:.5,speed:2,scale:2.5}}]},blizzard:{id:"blizzard",label:"WEATHER.Blizzard",filter:{enabled:!1},effects:[{id:"snowShader",effectClass:WeatherShaderEffect,shaderClass:SnowShader,blendMode:PIXI.BLEND_MODES.SCREEN,config:{tint:[.95,1,1],direction:.8,speed:8,scale:2.5}},{id:"fogShader",effectClass:WeatherShaderEffect,shaderClass:FogShader,blendMode:PIXI.BLEND_MODES.SCREEN,performanceLevel:2,config:{slope:1,intensity:.15,speed:-4}}]}},controlIcons:{combat:"icons/svg/combat.svg",visibility:"icons/svg/cowled.svg",effects:"icons/svg/aura.svg",lock:"icons/svg/padlock.svg",up:"icons/svg/up.svg",down:"icons/svg/down.svg",defeated:"icons/svg/skull.svg",light:"icons/svg/light.svg",lightOff:"icons/svg/light-off.svg",template:"icons/svg/explosion.svg",sound:"icons/svg/sound.svg",soundOff:"icons/svg/sound-off.svg",doorClosed:"icons/svg/door-closed-outline.svg",doorOpen:"icons/svg/door-open-outline.svg",doorSecret:"icons/svg/door-secret-outline.svg",doorLocked:"icons/svg/door-locked-outline.svg",wallDirection:"icons/svg/wall-direction.svg"},fontDefinitions:{Arial:{editor:!0,fonts:[]},Amiri:{editor:!0,fonts:[{urls:["fonts/amiri/amiri-regular.woff2"]},{urls:["fonts/amiri/amiri-bold.woff2"],weight:700}]},"Bruno Ace":{editor:!0,fonts:[{urls:["fonts/bruno-ace/bruno-ace.woff2"]}]},Courier:{editor:!0,fonts:[]},"Courier New":{editor:!0,fonts:[]},"Modesto Condensed":{editor:!0,fonts:[{urls:["fonts/modesto-condensed/modesto-condensed.woff2"]},{urls:["fonts/modesto-condensed/modesto-condensed-bold.woff2"],weight:700}]},Signika:{editor:!0,fonts:[{urls:["fonts/signika/signika-regular.woff2"]},{urls:["fonts/signika/signika-bold.woff2"],weight:700}]},Times:{editor:!0,fonts:[]},"Times New Roman":{editor:!0,fonts:[]}},defaultFontFamily:"Signika",statusEffects:[{id:"dead",name:"EFFECT.StatusDead",img:"icons/svg/skull.svg"},{id:"unconscious",name:"EFFECT.StatusUnconscious",img:"icons/svg/unconscious.svg"},{id:"sleep",name:"EFFECT.StatusAsleep",img:"icons/svg/sleep.svg"},{id:"stun",name:"EFFECT.StatusStunned",img:"icons/svg/daze.svg"},{id:"prone",name:"EFFECT.StatusProne",img:"icons/svg/falling.svg"},{id:"restrain",name:"EFFECT.StatusRestrained",img:"icons/svg/net.svg"},{id:"paralysis",name:"EFFECT.StatusParalysis",img:"icons/svg/paralysis.svg"},{id:"fly",name:"EFFECT.StatusFlying",img:"icons/svg/wing.svg"},{id:"blind",name:"EFFECT.StatusBlind",img:"icons/svg/blind.svg"},{id:"deaf",name:"EFFECT.StatusDeaf",img:"icons/svg/deaf.svg"},{id:"silence",name:"EFFECT.StatusSilenced",img:"icons/svg/silenced.svg"},{id:"fear",name:"EFFECT.StatusFear",img:"icons/svg/terror.svg"},{id:"burning",name:"EFFECT.StatusBurning",img:"icons/svg/fire.svg"},{id:"frozen",name:"EFFECT.StatusFrozen",img:"icons/svg/frozen.svg"},{id:"shock",name:"EFFECT.StatusShocked",img:"icons/svg/lightning.svg"},{id:"corrode",name:"EFFECT.StatusCorrode",img:"icons/svg/acid.svg"},{id:"bleeding",name:"EFFECT.StatusBleeding",img:"icons/svg/blood.svg"},{id:"disease",name:"EFFECT.StatusDisease",img:"icons/svg/biohazard.svg"},{id:"poison",name:"EFFECT.StatusPoison",img:"icons/svg/poison.svg"},{id:"curse",name:"EFFECT.StatusCursed",img:"icons/svg/sun.svg"},{id:"regen",name:"EFFECT.StatusRegen",img:"icons/svg/regen.svg"},{id:"degen",name:"EFFECT.StatusDegen",img:"icons/svg/degen.svg"},{id:"hover",name:"EFFECT.StatusHover",img:"icons/svg/wingfoot.svg"},{id:"burrow",name:"EFFECT.StatusBurrow",img:"icons/svg/mole.svg"},{id:"upgrade",name:"EFFECT.StatusUpgrade",img:"icons/svg/upgrade.svg"},{id:"downgrade",name:"EFFECT.StatusDowngrade",img:"icons/svg/downgrade.svg"},{id:"invisible",name:"EFFECT.StatusInvisible",img:"icons/svg/invisible.svg"},{id:"target",name:"EFFECT.StatusTarget",img:"icons/svg/target.svg"},{id:"eye",name:"EFFECT.StatusMarked",img:"icons/svg/eye.svg"},{id:"bless",name:"EFFECT.StatusBlessed",img:"icons/svg/angel.svg"},{id:"fireShield",name:"EFFECT.StatusFireShield",img:"icons/svg/fire-shield.svg"},{id:"coldShield",name:"EFFECT.StatusIceShield",img:"icons/svg/ice-shield.svg"},{id:"magicShield",name:"EFFECT.StatusMagicShield",img:"icons/svg/mage-shield.svg"},{id:"holyShield",name:"EFFECT.StatusHolyShield",img:"icons/svg/holy-shield.svg"}].map((e=>{for(const[t,i]of Object.entries({label:"name",icon:"img"})){const n=`StatusEffectConfig#${t} has been deprecated in favor of StatusEffectConfig#${i}`;Object.defineProperty(e,t,{get(){return foundry.utils.logCompatibilityWarning(n,{since:12,until:14,once:!0}),this[i]},set(e){foundry.utils.logCompatibilityWarning(n,{since:12,until:14,once:!0}),this[i]=e},enumerable:!1,configurable:!0})}return e})),specialStatusEffects:{DEFEATED:"dead",INVISIBLE:"invisible",BLIND:"blind",BURROW:"burrow",HOVER:"hover",FLY:"fly"},sounds:{dice:"sounds/dice.wav",lock:"sounds/lock.wav",notification:"sounds/notify.wav",combat:"sounds/drums.wav"},supportedLanguages:{en:"English"},i18n:{searchMinimumCharacterLength:4},time:{turnTime:0,roundTime:0},ActiveEffect:{documentClass:ActiveEffect,dataModels:{},typeLabels:{},typeIcons:{},legacyTransferral:!0},ActorDelta:{documentClass:ActorDelta},Card:{documentClass:Card,dataModels:{},typeLabels:{},typeIcons:{}},TableResult:{documentClass:TableResult},JournalEntryPage:{documentClass:JournalEntryPage,dataModels:{},typeLabels:{},typeIcons:{image:"fas fa-file-image",pdf:"fas fa-file-pdf",text:"fas fa-file-lines",video:"fas fa-file-video"},defaultType:"text",sidebarIcon:"fas fa-book-open"},PlaylistSound:{documentClass:PlaylistSound,sidebarIcon:"fas fa-music"},AmbientLight:{documentClass:AmbientLightDocument,objectClass:class AmbientLight extends PlaceableObject{field;lightSource;static embeddedName="AmbientLight";static RENDER_FLAGS={redraw:{propagate:["refresh"]},refresh:{propagate:["refreshState","refreshField","refreshElevation"],alias:!0},refreshField:{propagate:["refreshPosition"]},refreshPosition:{},refreshState:{},refreshElevation:{}};get bounds(){const{x:e,y:t}=this.document,i=Math.max(this.dimRadius,this.brightRadius);return new PIXI.Rectangle(e-i,t-i,2*i,2*i)}get sourceId(){let e=`${this.document.documentName}.${this.document.id}`;return this.isPreview&&(e+=".preview"),e}get config(){return this.document.config}get global(){return this.document.isGlobal}get radius(){return Math.max(Math.abs(this.dimRadius),Math.abs(this.brightRadius))}get dimRadius(){let e=canvas.dimensions;return this.config.dim/e.distance*e.size}get brightRadius(){let e=canvas.dimensions;return this.config.bright/e.distance*e.size}get isVisible(){return!this._isLightSourceDisabled()}get isLightSource(){return this.lightSource instanceof g.Canvas.lightSourceClass}get isDarknessSource(){return this.lightSource instanceof g.Canvas.darknessSourceClass}_isLightSourceDisabled(){const{hidden:e,config:t}=this.document;if(e)return!0;if(!this.radius||!t.angle)return!0;return!canvas.darknessLevel.between(t.darkness.min,t.darkness.max)}get emitsDarkness(){return this.document.config.negative&&!this._isLightSourceDisabled()}get emitsLight(){return!this.document.config.negative&&!this._isLightSourceDisabled()}_destroy(e){this.#Yo()}async _draw(e){this.field=this.addChild(new PIXI.Graphics),this.field.eventMode="none",this.controlIcon=this.addChild(this.#Pc()),this.initializeLightSource()}#Pc(){const e=Math.max(20*Math.round(.5*canvas.dimensions.size/20),40);let t=new ControlIcon({texture:g.controlIcons.light,size:e});return t.x-=.5*e,t.y-=.5*e,t}_applyRenderFlags(e){e.refreshState&&this._refreshState(),e.refreshPosition&&this._refreshPosition(),e.refreshField&&this._refreshField(),e.refreshElevation&&this._refreshElevation()}_refreshField(){this.field.clear(),this.lightSource?.shape&&(this.field.lineStyle(2,15658734,.4).drawShape(this.lightSource.shape),this.field.position.set(-this.lightSource.x,-this.lightSource.y))}_refreshPosition(){const{x:e,y:t}=this.document;this.position.x===e&&this.position.y===t||MouseInteractionManager.emulateMoveEvent(),this.position.set(e,t)}_refreshElevation(){this.controlIcon.elevation=this.document.elevation}_refreshState(){this.alpha=this._getTargetAlpha(),this.zIndex=this.hover?1:0,this.refreshControl()}refreshControl(){const e=this.id&&this.document.hidden;this.controlIcon.texture=getTexture(this.isVisible?g.controlIcons.light:g.controlIcons.lightOff),this.controlIcon.tintColor=e?16724736:16777215,this.controlIcon.borderColor=e?16724736:16733440,this.controlIcon.elevation=this.document.elevation,this.controlIcon.refresh({visible:this.layer.active,borderVisible:this.hover||this.layer.highlightObjects}),this.controlIcon.draw()}initializeLightSource({deleted:e=!1}={}){const t=this.sourceId,i=canvas.effects.lightSources.has(t),n=canvas.effects.darknessSources.has(t),s=this.document.config.negative,o={refreshEdges:n||s,initializeVision:n||s,initializeLighting:n||s,refreshLighting:!0,refreshVision:!0};if(e){if(!this.lightSource?.active)return;return this.#Yo(),void canvas.perception.update(o)}(i&&s||n&&!s)&&this.#Yo(),this.lightSource??=this.#Ko(),this.lightSource.initialize(this._getLightSourceData()),this.lightSource.add(),canvas.perception.update(o),this.layer.active&&this.renderFlags.set({refreshField:!0})}_getLightSourceData(){const{x:e,y:t,elevation:i,rotation:n,walls:s,vision:o}=this.document,r=canvas.dimensions;return foundry.utils.mergeObject(this.config.toObject(!1),{x:e,y:t,elevation:i,rotation:n,walls:s,vision:o,dim:Math.clamp(this.dimRadius,0,r.maxR),bright:Math.clamp(this.brightRadius,0,r.maxR),seed:this.document.getFlag("core","animationSeed"),disabled:this._isLightSourceDisabled(),preview:this.isPreview})}#Ko(){return new(this.config.negative?g.Canvas.darknessSourceClass:g.Canvas.lightSourceClass)({sourceId:this.sourceId,object:this})}#Yo(){this.lightSource?.destroy(),this.lightSource=void 0}_onCreate(e,t,i){super._onCreate(e,t,i),this.initializeLightSource()}_onUpdate(e,t,i){super._onUpdate(e,t,i),this.initializeLightSource(),this.renderFlags.set({refreshState:"hidden"in e||"config"in e&&["dim","bright","angle","darkness"].some((t=>t in e.config)),refreshElevation:"elevation"in e})}_onDelete(e,t){this.initializeLightSource({deleted:!0}),super._onDelete(e,t)}_canHUD(e,t){return e.isGM}_canConfigure(e,t){return!1}_canDragLeftStart(e,t){return this.layer?.preview?.children.length?(ui.notifications.warn("CONTROLS.ObjectConfigured",{localize:!0}),!1):super._canDragLeftStart(e,t)}_onClickRight(e){this.document.update({hidden:!this.document.hidden}),this._propagateRightClick(e)||e.stopPropagation()}_onDragLeftMove(e){super._onDragLeftMove(e),this.initializeLightSource({deleted:!0});const t=e.interactionData.clones||[];for(const e of t)e.initializeLightSource()}_onDragEnd(){this.initializeLightSource({deleted:!0}),this._original?.initializeLightSource(),super._onDragEnd()}updateSource({deleted:e=!1}={}){foundry.utils.logCompatibilityWarning("AmbientLight#updateSource has been deprecated in favor of AmbientLight#initializeLightSource",{since:12,until:14,once:!0}),this.initializeLightSource({deleted:e})}get source(){return foundry.utils.logCompatibilityWarning("AmbientLight#source has been deprecated in favor of AmbientLight#lightSource",{since:12,until:14,once:!0}),this.lightSource}},layerClass:LightingLayer},AmbientSound:{documentClass:AmbientSoundDocument,objectClass:class AmbientSound extends PlaceableObject{sound;#kc;#Mc;#Lc=!1;#Fc=!1;source;field;static embeddedName="AmbientSound";static RENDER_FLAGS={redraw:{propagate:["refresh"]},refresh:{propagate:["refreshState","refreshField","refreshElevation"],alias:!0},refreshField:{propagate:["refreshPosition"]},refreshPosition:{},refreshState:{},refreshElevation:{}};_createSound(){const e=this.document.path;return this.id&&e?c.audio.create({src:e,context:c.audio.environment,singleton:!0}):null}#Uc(){const e=g.soundEffects,{base:t,muffled:i}=this.document.effects;if(this.#kc=this.#Mc=void 0,t.type in e){const i=e[t.type];this.#kc=new i.effectClass(this.sound.context,t)}if(i.type in e){const t=e[i.type];this.#Mc=new t.effectClass(this.sound.context,i)}this.#Lc=!0}applyEffects({muffled:e=!1}={}){const t=[];if(e){const e=this.#Mc||this.#kc;e&&t.push(e)}else this.#kc&&t.push(this.#kc);this.sound.applyEffects(t)}get isAudible(){return!(this.document.hidden||!this.document.radius)&&canvas.darknessLevel.between(this.document.darkness.min??0,this.document.darkness.max??1)}get bounds(){const{x:e,y:t}=this.document,i=this.radius;return new PIXI.Rectangle(e-i,t-i,2*i,2*i)}get radius(){let e=canvas.dimensions;return this.document.radius/e.distance*e.size}async sync(e,t,{fade:i=250,muffled:n=!1}={}){if(!e){if(!this.sound)return;return this.sound._manager=null,await this.sound.stop({volume:0,fade:i}),void(this.#Fc=!1)}if(this.sound||=this._createSound(),null===this.sound)return;const s=this.sound,o=s._manager!==this,r=!s.loaded&&!s._manager;if(s._manager=this,r&&await s.load(),!s.loaded)return;const a=this.#Fc!==n;if(this.#Fc=n,o&&!this.#Lc&&this.#Uc(),(o||a)&&this.applyEffects({muffled:n}),s.playing)await s.fade(t,{duration:i});else{const e=s.context.currentTime%s.duration;await s.play({volume:t,offset:e,fade:i,loop:!0})}}clear(){return this.controlIcon&&(this.controlIcon.parent.removeChild(this.controlIcon).destroy(),this.controlIcon=null),super.clear()}async _draw(e){this.field=this.addChild(new PIXI.Graphics),this.field.eventMode="none",this.controlIcon=this.addChild(this.#Pc())}_destroy(e){this.#Bc()}#Pc(){const e=Math.max(20*Math.round(.5*canvas.dimensions.size/20),40);let t=new ControlIcon({texture:g.controlIcons.sound,size:e});return t.x-=.5*e,t.y-=.5*e,t}_applyRenderFlags(e){e.refreshState&&this._refreshState(),e.refreshPosition&&this._refreshPosition(),e.refreshField&&this._refreshField(),e.refreshElevation&&this._refreshElevation()}_refreshField(){this.field.clear(),this.source?.shape&&(this.field.lineStyle(1,16777215,.5).beginFill(11197951,.15).drawShape(this.source.shape).endFill(),this.field.position.set(-this.source.x,-this.source.y))}_refreshPosition(){const{x:e,y:t}=this.document;this.position.x===e&&this.position.y===t||MouseInteractionManager.emulateMoveEvent(),this.position.set(e,t)}_refreshState(){this.alpha=this._getTargetAlpha(),this.zIndex=this.hover?1:0,this.refreshControl()}refreshControl(){const e=this.id&&(this.document.hidden||!this.document.path);this.controlIcon.tintColor=e?16724736:16777215,this.controlIcon.borderColor=e?16724736:16733440,this.controlIcon.texture=getTexture(this.isAudible?g.controlIcons.sound:g.controlIcons.soundOff),this.controlIcon.elevation=this.document.elevation,this.controlIcon.refresh({visible:this.layer.active,borderVisible:this.hover||this.layer.highlightObjects}),this.controlIcon.draw()}_refreshElevation(){this.controlIcon.elevation=this.document.elevation}initializeSoundSource({deleted:e=!1}={}){const t=this.layer.sources.has(this.sourceId),i={refreshSounds:!0};if(e){if(!t)return;return this.#Bc(),void canvas.perception.update(i)}this.source??=this.#Gc(),this.source.initialize(this._getSoundSourceData()),this.source.add(),canvas.perception.update(i),this.layer.active&&this.renderFlags.set({refreshField:!0})}#Gc(){return new(0,g.Canvas.soundSourceClass)({sourceId:this.sourceId,object:this})}#Bc(){this.source?.destroy(),this.source=void 0}_getSoundSourceData(){return{x:this.document.x,y:this.document.y,elevation:this.document.elevation,radius:Math.clamp(this.radius,0,canvas.dimensions.maxR),walls:this.document.walls,disabled:!this.isAudible}}_onCreate(e,t,i){super._onCreate(e,t,i),this.initializeSoundSource()}_onUpdate(e,t,i){super._onUpdate(e,t,i),"path"in e&&(this.sound&&this.sound.stop(),this.sound=this._createSound()),"effects"in e&&(this.#Lc=!1,this.sound?._manager===this&&(this.sound._manager=null)),this.initializeSoundSource(),this.renderFlags.set({refreshState:"hidden"in e||"path"in e||"darkness"in e,refreshElevation:"elevation"in e})}_onDelete(e,t){this.sound?.stop(),this.initializeSoundSource({deleted:!0}),super._onDelete(e,t)}_canHUD(e,t){return e.isGM}_canConfigure(e,t){return!1}_onClickRight(e){this.document.update({hidden:!this.document.hidden}),this._propagateRightClick(e)||e.stopPropagation()}_onDragLeftMove(e){super._onDragLeftMove(e);const t=e.interactionData.clones||[];for(let e of t)e.initializeSoundSource()}_onDragEnd(){this.initializeSoundSource({deleted:!0}),this._original?.initializeSoundSource(),super._onDragEnd()}updateSource({defer:e=!1,deleted:t=!1}={}){foundry.utils.logCompatibilityWarning("AmbientSound#updateSource has been deprecated in favor of AmbientSound#initializeSoundSource",{since:12,until:14,once:!0}),this.initializeSoundSource({defer:e,deleted:t})}},layerClass:SoundsLayer},Combatant:{documentClass:Combatant,dataModels:{},typeLabels:{},typeIcons:{}},Drawing:{documentClass:DrawingDocument,objectClass:Drawing,layerClass:DrawingsLayer,hudClass:class DrawingHUD extends BasePlaceableHUD{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"drawing-hud",template:"templates/hud/drawing-hud.html"})}getData(e={}){const{locked:t,hidden:i}=this.object.document;return foundry.utils.mergeObject(super.getData(e),{lockedClass:t?"active":"",visibilityClass:i?"active":""})}setPosition(e){let{x:t,y:i,width:n,height:s}=this.object.frame.bounds;const o={width:n+140+20,height:s+20,left:t+this.object.x-70-10,top:i+this.object.y-10};this.element.css(o)}}},MeasuredTemplate:{defaults:{angle:53.13,width:1},types:{circle:"Circle",cone:"Cone",rect:"Rectangle",ray:"Ray"},documentClass:MeasuredTemplateDocument,objectClass:class MeasuredTemplate extends PlaceableObject{shape;texture;template;ruler;_borderThickness=3;static embeddedName="MeasuredTemplate";static RENDER_FLAGS={redraw:{propagate:["refresh"]},refresh:{propagate:["refreshState","refreshPosition","refreshShape","refreshElevation"],alias:!0},refreshState:{},refreshPosition:{propagate:["refreshGrid"]},refreshShape:{propagate:["refreshTemplate","refreshGrid","refreshText"]},refreshTemplate:{},refreshGrid:{},refreshText:{},refreshElevation:{}};get isAuthor(){return this.document.isAuthor}get bounds(){const{x:e,y:t}=this.document,i=canvas.dimensions,n=this.document.distance*(i.size/i.distance);return new PIXI.Rectangle(e-n,t-n,2*n,2*n)}get isVisible(){return!this.document.hidden||this.isAuthor||c.user.isGM}get highlightId(){return this.objectId}async _draw(e){this.document.texture?this.texture=await loadTexture(this.document.texture,{fallback:"icons/svg/hazard.svg"}):this.texture=null,this.template=this.addChild(new PIXI.Graphics),this.controlIcon=this.addChild(this.#jc()),await this.controlIcon.draw(),this.ruler=this.addChild(this.#$c()),canvas.interface.grid.addHighlightLayer(this.highlightId)}#jc(){const e=Math.max(20*Math.round(.5*canvas.dimensions.size/20),40);let t=new ControlIcon({texture:g.controlIcons.template,size:e});return t.x-=.5*e,t.y-=.5*e,t}#$c(){const e=g.canvasTextStyle.clone();e.fontSize=Math.max(Math.round(.36*canvas.dimensions.size*12)/12,36);const t=new PreciseText(null,e);return t.anchor.set(0,1),t}_destroy(e){canvas.interface.grid.destroyHighlightLayer(this.highlightId),this.texture?.destroy()}_applyRenderFlags(e){e.refreshState&&this._refreshState(),e.refreshPosition&&this._refreshPosition(),e.refreshShape&&this._refreshShape(),e.refreshTemplate&&this._refreshTemplate(),e.refreshGrid&&this.highlightGrid(),e.refreshText&&this._refreshRulerText(),e.refreshElevation&&this._refreshElevation()}_refreshState(){const e=this.visible;this.visible=this.isVisible&&!this.hasPreview,this.visible!==e&&MouseInteractionManager.emulateMoveEvent(),this.zIndex=this.hover?1:0;const t=this.document.hidden;this.controlIcon.refresh({visible:this.visible&&this.layer.active&&this.document.isOwner,iconColor:t?16724736:16777215,borderColor:t?16724736:16733440,borderVisible:this.hover||this.layer.highlightObjects});const i=t?.5:1;this.template.alpha=i,this.ruler.alpha=i;const n=canvas.interface.grid.getHighlightLayer(this.highlightId);n.visible=this.visible,n.zIndex=this.document.sort,n.alpha=i,this.alpha=this._getTargetAlpha(),this.ruler.visible=this.visible&&this.layer.active}_refreshElevation(){this.controlIcon.elevation=this.document.elevation}_getTargetAlpha(){return this.isPreview?.8:1}_refreshPosition(){const{x:e,y:t}=this.document;this.position.x===e&&this.position.y===t||MouseInteractionManager.emulateMoveEvent(),this.position.set(e,t)}_refreshShape(){let{x:e,y:t,direction:i,distance:n}=this.document;c.settings.get("core","gridTemplates")?this.ray=new Ray({x:e,y:t},canvas.grid.getTranslatedPoint({x:e,y:t},i,n)):this.ray=Ray.fromAngle(e,t,Math.toRadians(i),n*canvas.dimensions.distancePixels),this.shape=this._computeShape()}_computeShape(){const{t:e,distance:t,direction:i,angle:n,width:s}=this.document;switch(e){case"circle":return this.constructor.getCircleShape(t);case"cone":return this.constructor.getConeShape(t,i,n);case"rect":return this.constructor.getRectShape(t,i);case"ray":return this.constructor.getRayShape(t,i,s)}}_refreshTemplate(){const e=this.template.clear();e.lineStyle(this._borderThickness,this.document.borderColor,.75).beginFill(0,0),this.texture?e.beginTextureFill({texture:this.texture}):e.beginFill(0,0),e.drawShape(this.shape),e.lineStyle(this._borderThickness,0).beginFill(0,.5).drawCircle(0,0,6).drawCircle(this.ray.dx,this.ray.dy,6).endFill()}static getCircleShape(e){return c.settings.get("core","gridTemplates")?new PIXI.Polygon(canvas.grid.getCircle({x:0,y:0},e)):new PIXI.Circle(0,0,e*canvas.dimensions.distancePixels)}static getConeShape(e,t,i){if(c.settings.get("core","gridTemplates"))return new PIXI.Polygon(canvas.grid.getCone({x:0,y:0},e,t,i));if(e<=0||i<=0)return new PIXI.Polygon;e*=canvas.dimensions.distancePixels;let n;if("round"===c.settings.get("core","coneTemplateType")){if(i>=360)return new PIXI.Circle(0,0,e);const t=Math.min(i,3);n=Array.fromRange(Math.floor(i/t)).map((e=>i/-2+e*t)).concat([i/2])}else n=[(i=Math.min(i,179))/-2,i/2],e/=Math.cos(Math.toRadians(i/2));const s=n.map((i=>Ray.fromAngle(0,0,Math.toRadians(t+i),e))).reduce(((e,t)=>e.concat([t.B.x,t.B.y])),[0,0]).concat([0,0]);return new PIXI.Polygon(s)}static getRectShape(e,t){let i;return i=c.settings.get("core","gridTemplates")?canvas.grid.getTranslatedPoint({x:0,y:0},t,e):Ray.fromAngle(0,0,Math.toRadians(t),e*canvas.dimensions.distancePixels).B,new PIXI.Rectangle(0,0,i.x,i.y).normalize()}static getRayShape(e,t,i){const n=canvas.dimensions;i*=n.distancePixels;const s=Ray.fromAngle(0,0,Math.toRadians(t-90),i/2).B,o=Ray.fromAngle(0,0,Math.toRadians(t+90),i/2).B;let r,a;return c.settings.get("core","gridTemplates")?(r=canvas.grid.getTranslatedPoint(s,t,e),a=canvas.grid.getTranslatedPoint(o,t,e)):(e*=n.distancePixels,t=Math.toRadians(t),r=Ray.fromAngle(s.x,s.y,t,e).B,a=Ray.fromAngle(o.x,o.y,t,e).B),new PIXI.Polygon(s.x,s.y,r.x,r.y,a.x,a.y,o.x,o.y)}_refreshRulerText(){const{distance:e,t:t}=this.document,i=canvas.grid;if("rect"===t){const{A:{x:e,y:t},B:{x:n,y:s}}=this.ray,o=i.measurePath([{x:e,y:t},{x:n,y:t}]).distance,r=i.measurePath([{x:e,y:t},{x:e,y:s}]).distance,a=Math.round(10*o)/10,l=Math.round(10*r)/10;this.ruler.text=`${a}${i.units} x ${l}${i.units}`}else{const t=Math.round(10*e)/10;this.ruler.text=`${t}${i.units}`}this.ruler.position.set(this.ray.dx+10,this.ray.dy+5)}highlightGrid(){canvas.interface.grid.clearHighlightLayer(this.highlightId);const e=this.document.borderColor,t=this.document.fillColor;if(canvas.grid.type===CONST.GRID_TYPES.GRIDLESS){const i=this._getGridHighlightShape();canvas.interface.grid.highlightPosition(this.highlightId,{border:e,color:t,shape:i})}else{const i=this._getGridHighlightPositions();for(const{x:n,y:s}of i)canvas.interface.grid.highlightPosition(this.highlightId,{x:n,y:s,border:e,color:t})}}_getGridHighlightShape(){const e=this.shape.clone();return"points"in e?e.points=e.points.map(((e,t)=>t%2?this.y+e:this.x+e)):(e.x+=this.x,e.y+=this.y),e}_getGridHighlightPositions(){const e=canvas.grid,{x:t,y:i}=this.document,n=this.shape,s=n.getBounds();s.x+=t,s.y+=i,s.fit(canvas.dimensions.rect),s.pad(1);const o=[],[r,a,l,c]=e.getOffsetRange(s);for(let s=r;s<l;s++)for(let r=a;r<c;r++){const a={i:s,j:r},{x:l,y:c}=e.getCenterPoint(a);let d=Math.max(Math.abs(l-t),Math.abs(c-i))<1;if(!d)for(let e=-.5;e<=.5;e+=.5)for(let s=-.5;s<=.5;s+=.5)if(n.contains(l-t+e,c-i+s)){d=!0;break}d&&o.push(e.getTopLeftPoint(a))}return o}async rotate(e,t){if(c.paused&&!c.user.isGM)return ui.notifications.warn("GAME.PausedWarning",{localize:!0}),this;const i=this._updateRotation({angle:e,snap:t});return await this.document.update({direction:i}),this}_onUpdate(e,t,i){super._onUpdate(e,t,i),this.renderFlags.set({redraw:"texture"in e,refreshState:"sort"in e||"hidden"in e,refreshPosition:"x"in e||"y"in e,refreshElevation:"elevation"in e,refreshShape:["t","angle","direction","distance","width"].some((t=>t in e)),refreshTemplate:"borderColor"in e,refreshGrid:"borderColor"in e||"fillColor"in e})}_canControl(e,t){return!(!this.layer.active||this.isPreview)&&(e.isGM||e===this.document.author)}_canHUD(e,t){return this.isOwner}_canConfigure(e,t){return!1}_canView(e,t){return this._canControl(e,t)}_onClickRight(e){this.document.update({hidden:!this.document.hidden}),this._propagateRightClick(e)||e.stopPropagation()}get borderColor(){return foundry.utils.logCompatibilityWarning("MeasuredTemplate#borderColor has been deprecated. Use MeasuredTemplate#document#borderColor instead.",{since:12,until:14}),this.document.borderColor.valueOf()}get fillColor(){return foundry.utils.logCompatibilityWarning("MeasuredTemplate#fillColor has been deprecated. Use MeasuredTemplate#document#fillColor instead.",{since:12,until:14}),this.document.fillColor.valueOf()}get owner(){return foundry.utils.logCompatibilityWarning("MeasuredTemplate#owner has been deprecated. Use MeasuredTemplate#isOwner instead.",{since:12,until:14}),this.isOwner}},layerClass:TemplateLayer},Note:{documentClass:NoteDocument,objectClass:class Note extends PlaceableObject{static embeddedName="Note";static RENDER_FLAGS={redraw:{propagate:["refresh"]},refresh:{propagate:["refreshState","refreshPosition","refreshTooltip","refreshElevation"],alias:!0},refreshState:{propagate:["refreshVisibility"]},refreshVisibility:{},refreshPosition:{},refreshTooltip:{},refreshElevation:{propagate:["refreshVisibility"]},refreshText:{propagate:["refreshTooltip"],deprecated:{since:12,until:14},alias:!0}};controlIcon;tooltip;get bounds(){const{x:e,y:t,iconSize:i}=this.document,n=i/2;return new PIXI.Rectangle(e-n,t-n,2*n,2*n)}get entry(){return this.document.entry}get page(){return this.document.page}get isVisible(){const e=this.document.page??this.document.entry,t=e?.testUserPermission(c.user,"LIMITED")??!0;if(!1===t||!canvas.visibility.tokenVision||this.document.global)return t;const i={x:this.document.x,y:this.document.y},n=this.document.iconSize/4;return canvas.visibility.testVisibility(i,{tolerance:n,object:this})}async _draw(e){this.controlIcon=this.addChild(this._drawControlIcon()),this.tooltip=this.addChild(this._drawTooltip())}_drawControlIcon(){const{texture:e,iconSize:t}=this.document,i=new ControlIcon({texture:e.src,size:t,tint:e.tint});return i.x-=t/2,i.y-=t/2,i}_drawTooltip(){const e=new PreciseText(this.document.label,this._getTextStyle());return e.eventMode="none",e}_refreshTooltip(){this.tooltip.text=this.document.label,this.tooltip.style=this._getTextStyle();const e=.5*this.document.iconSize+12;switch(this.document.textAnchor){case CONST.TEXT_ANCHOR_POINTS.CENTER:this.tooltip.anchor.set(.5,.5),this.tooltip.position.set(0,0);break;case CONST.TEXT_ANCHOR_POINTS.BOTTOM:this.tooltip.anchor.set(.5,0),this.tooltip.position.set(0,e);break;case CONST.TEXT_ANCHOR_POINTS.TOP:this.tooltip.anchor.set(.5,1),this.tooltip.position.set(0,-e);break;case CONST.TEXT_ANCHOR_POINTS.LEFT:this.tooltip.anchor.set(1,.5),this.tooltip.position.set(-e,0);break;case CONST.TEXT_ANCHOR_POINTS.RIGHT:this.tooltip.anchor.set(0,.5),this.tooltip.position.set(e,0)}}_getTextStyle(){const e=g.canvasTextStyle.clone();this.document.textAnchor===CONST.TEXT_ANCHOR_POINTS.LEFT?e.align="right":this.document.textAnchor===CONST.TEXT_ANCHOR_POINTS.RIGHT&&(e.align="left"),e.fontFamily=this.document.fontFamily||g.defaultFontFamily,e.fontSize=this.document.fontSize;const t=this.document.textColor;return e.fill=t,e.stroke=t.hsv[2]>.6?0:16777215,e.strokeThickness=4,e}_applyRenderFlags(e){e.refreshState&&this._refreshState(),e.refreshVisibility&&this._refreshVisibility(),e.refreshPosition&&this._refreshPosition(),e.refreshTooltip&&this._refreshTooltip(),e.refreshElevation&&this._refreshElevation()}_refreshVisibility(){const e=this.visible;this.visible=this.isVisible,this.controlIcon&&this.controlIcon.refresh({visible:this.visible,borderVisible:this.hover||this.layer.highlightObjects}),e!==this.visible&&(this.layer.hintMapNotes(),MouseInteractionManager.emulateMoveEvent())}_refreshState(){this.alpha=this._getTargetAlpha(),this.tooltip.visible=this.hover||this.layer.highlightObjects,this.zIndex=this.hover?1:0}_refreshPosition(){const{x:e,y:t}=this.document;this.position.x===e&&this.position.y===t||MouseInteractionManager.emulateMoveEvent(),this.position.set(this.document.x,this.document.y)}_refreshElevation(){this.controlIcon.elevation=this.document.elevation}_onUpdate(e,t,i){super._onUpdate(e,t,i);const n="x"in e||"y"in e;this.renderFlags.set({redraw:"texture"in e||"iconSize"in e,refreshVisibility:n||["entryId","pageId","global"].some((t=>t in e)),refreshPosition:n,refreshTooltip:["text","fontFamily","fontSize","textAnchor","textColor","iconSize"].some((t=>t in e)),refreshElevation:"elevation"in e})}_canHover(e){return!0}_canView(e){const{entry:t,page:i}=this.document;if(!t)return!1;if(c.user.isGM)return!0;if(i?.testUserPermission(c.user,"LIMITED",{exact:!0}))return"image"===i.type;return(i??t).testUserPermission(c.user,"OBSERVER")}_canConfigure(e){return canvas.notes.active&&this.document.canUserModify(c.user,"update")}_onClickLeft2(e){const{entry:t,page:i}=this.document;if(!t)return;const n={};i&&(n.mode=JournalSheet.VIEW_MODES.SINGLE,n.pageId=i.id);return!1!==Hooks$1.call("activateNote",this,n)?"image"===i?.type?new ImagePopout(i.src,{uuid:i.uuid,title:i.name,caption:i.image.caption}).render(!0):void t.sheet.render(!0,n):void 0}get text(){return foundry.utils.logCompatibilityWarning("Note#text has been deprecated. Use Note#document#label instead.",{since:12,until:14,once:!0}),this.document.label}get size(){return foundry.utils.logCompatibilityWarning("Note#size has been deprecated. Use Note#document#iconSize instead.",{since:12,until:14,once:!0}),this.document.iconSize}},layerClass:NotesLayer},Region:{documentClass:RegionDocument,objectClass:Region,layerClass:RegionLayer},RegionBehavior:{documentClass:RegionBehavior,dataModels:{adjustDarknessLevel:foundry.data.regionBehaviors.AdjustDarknessLevelRegionBehaviorType,displayScrollingText:foundry.data.regionBehaviors.DisplayScrollingTextRegionBehaviorType,executeMacro:foundry.data.regionBehaviors.ExecuteMacroRegionBehaviorType,executeScript:foundry.data.regionBehaviors.ExecuteScriptRegionBehaviorType,pauseGame:foundry.data.regionBehaviors.PauseGameRegionBehaviorType,suppressWeather:foundry.data.regionBehaviors.SuppressWeatherRegionBehaviorType,teleportToken:foundry.data.regionBehaviors.TeleportTokenRegionBehaviorType,toggleBehavior:foundry.data.regionBehaviors.ToggleBehaviorRegionBehaviorType},typeLabels:{},typeIcons:{adjustDarknessLevel:"fa-solid fa-circle-half-stroke",displayScrollingText:"fa-solid fa-message-arrow-up",executeMacro:"fa-solid fa-code",executeScript:"fa-brands fa-js",pauseGame:"fa-solid fa-pause",suppressWeather:"fa-solid fa-cloud-slash",teleportToken:"fa-solid fa-transporter-1",toggleBehavior:"fa-solid fa-sliders"}},Tile:{documentClass:TileDocument,objectClass:Tile,layerClass:TilesLayer,hudClass:class TileHUD extends BasePlaceableHUD{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"tile-hud",template:"templates/hud/tile-hud.html"})}getData(e={}){const{locked:t,hidden:i}=this.document,{isVideo:n,sourceElement:s}=this.object,o=n&&!s.paused&&!s.ended;return foundry.utils.mergeObject(super.getData(e),{isVideo:n,lockedClass:t?"active":"",visibilityClass:i?"active":"",videoIcon:o?"fas fa-pause":"fas fa-play",videoTitle:c.i18n.localize(o?"HUD.TilePause":"HUD.TilePlay")})}setPosition(e){let{x:t,y:i,width:n,height:s}=this.object.frame.bounds;const o={width:n+140+20,height:s+20,left:t+this.object.x-70-10,top:i+this.object.y-10};this.element.css(o)}_onClickControl(e){if(super._onClickControl(e),e.defaultPrevented)return;return"video"===e.currentTarget.dataset.action?this.#Hc(e):void 0}#Hc(e){const t=this.object.sourceElement,i=e.currentTarget.children[0],n=!t.paused&&!t.ended;if(!t.loop&&!n){const e=this;t.onpause=()=>{e.object?.sourceElement&&(i.classList.replace("fa-pause","fa-play"),e.render()),t.onpause=null}}return this.object.document.update({"video.autoplay":!1},{diff:!1,playVideo:!n,offset:t.ended?0:null})}}},Token:{documentClass:TokenDocument,objectClass:Token,layerClass:TokenLayer,prototypeSheetClass:TokenConfig,hudClass:class TokenHUD extends BasePlaceableHUD{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"token-hud",template:"templates/hud/token-hud.html"})}#zc=!1;get actor(){return this.document?.actor}bind(e){return this.#zc=!1,super.bind(e)}setPosition(e){const t=this.object.bounds,{width:i,height:n}=this.document,s=canvas.dimensions.size/100,o={width:100*i,height:100*n,left:t.left,top:t.top};1!==s&&(o.transform=`scale(${s})`),this.element.css(o),this.element[0].classList.toggle("large",n>=2)}getData(e={}){let t=super.getData(e);const i=this.document.getBarAttribute("bar1"),n=this.document.getBarAttribute("bar2");return t=foundry.utils.mergeObject(t,{canConfigure:c.user.can("TOKEN_CONFIGURE"),canToggleCombat:null!==ui.combat,displayBar1:i&&"none"!==i.type,bar1Data:i,displayBar2:n&&"none"!==n.type,bar2Data:n,visibilityClass:t.hidden?"active":"",effectsClass:this.#zc?"active":"",combatClass:this.object.inCombat?"active":"",targetClass:this.object.targeted.has(c.user)?"active":""}),t.statusEffects=this._getStatusEffectChoices(),t}_getStatusEffectChoices(){const e={};for(const t of g.statusEffects)!1===t.hud||"Object"===foundry.utils.getType(t.hud)&&!1===t.hud.actorTypes?.includes(this.document.actor.type)||(e[t.id]={_id:t._id,id:t.id,title:c.i18n.localize(t.name??t.label),src:t.img??t.icon,isActive:!1,isOverlay:!1});const t=this.actor?.effects||[];for(const i of t)for(const t of i.statuses){const n=e[t];if(n){if(n._id){if(n._id!==i.id)continue}else if(1!==i.statuses.size)continue;n.isActive=!0,i.getFlag("core","overlay")&&(n.isOverlay=!0);break}}for(const t of Object.values(e))t.cssClass=[t.isActive?"active":null,t.isOverlay?"overlay":null].filterJoin(" ");return e}toggleStatusTray(e){e??=!this.#zc,this.#zc=e;this.element.find('.control-icon[data-action="effects"]')[0].classList.toggle("active",e);this.element[0].querySelector(".status-effects").classList.toggle("active",e)}activateListeners(e){super.activateListeners(e),this.toggleStatusTray(this.#zc);const t=e.find(".status-effects");t.on("click",".effect-control",this.#Vc.bind(this)),t.on("contextmenu",".effect-control",(e=>this.#Vc(e,{overlay:!0})))}_onClickControl(e){if(super._onClickControl(e),e.defaultPrevented)return;switch(e.currentTarget.dataset.action){case"config":return this.#Wc(e);case"combat":return this.#Xc(e);case"target":return this.#Yc(e);case"effects":return this.#Kc(e)}}async _updateAttribute(e,t){const i=this.document.getBarAttribute(e);if(!i)return super._updateAttribute(e,t);const{value:n,delta:s,isDelta:o,isBar:r}=this._parseAttributeInput(e,i,t);await(this.actor?.modifyTokenAttribute(i.attribute,o?s:n,o,r))}async#Xc(e){e.preventDefault();const t=canvas.tokens.controlled.map((e=>e.document));this.object.controlled||t.push(this.document);try{this.document.inCombat?await TokenDocument.implementation.deleteCombatants(t):await TokenDocument.implementation.createCombatants(t)}catch(e){ui.notifications.warn(e.message)}}#Wc(e){e.preventDefault(),this.object.sheet.render(!0)}#Kc(e){e.preventDefault(),this.toggleStatusTray(!this.#zc)}#Vc(e,{overlay:t=!1}={}){if(e.preventDefault(),e.stopPropagation(),!this.actor)return ui.notifications.warn("HUD.WarningEffectNoActor",{localize:!0});const i=e.currentTarget.dataset.statusId;this.actor.toggleStatusEffect(i,{overlay:t})}#Yc(e){e.preventDefault();const t=e.currentTarget,i=this.object,n=!i.isTargeted;i.setTarget(n,{releaseOthers:!1}),t.classList.toggle("active",n)}},adjectivesPrefix:"TOKEN.Adjectives"},Wall:{documentClass:WallDocument,objectClass:Wall,layerClass:WallsLayer,thresholdAttenuationMultiplier:1,doorSounds:{futuristicFast:{label:"WALLS.DoorSound.FuturisticFast",close:"sounds/doors/futuristic/close-fast.ogg",lock:"sounds/doors/futuristic/lock.ogg",open:"sounds/doors/futuristic/open-fast.ogg",test:"sounds/doors/futuristic/test.ogg",unlock:"sounds/doors/futuristic/unlock.ogg"},futuristicHydraulic:{label:"WALLS.DoorSound.FuturisticHydraulic",close:"sounds/doors/futuristic/close-hydraulic.ogg",lock:"sounds/doors/futuristic/lock.ogg",open:"sounds/doors/futuristic/open-hydraulic.ogg",test:"sounds/doors/futuristic/test.ogg",unlock:"sounds/doors/futuristic/unlock.ogg"},futuristicForcefield:{label:"WALLS.DoorSound.FuturisticForcefield",close:"sounds/doors/futuristic/close-forcefield.ogg",lock:"sounds/doors/futuristic/lock.ogg",open:"sounds/doors/futuristic/open-forcefield.ogg",test:"sounds/doors/futuristic/test-forcefield.ogg",unlock:"sounds/doors/futuristic/unlock.ogg"},industrial:{label:"WALLS.DoorSound.Industrial",close:"sounds/doors/industrial/close.ogg",lock:"sounds/doors/industrial/lock.ogg",open:"sounds/doors/industrial/open.ogg",test:"sounds/doors/industrial/test.ogg",unlock:"sounds/doors/industrial/unlock.ogg"},industrialCreaky:{label:"WALLS.DoorSound.IndustrialCreaky",close:"sounds/doors/industrial/close-creaky.ogg",lock:"sounds/doors/industrial/lock.ogg",open:"sounds/doors/industrial/open-creaky.ogg",test:"sounds/doors/industrial/test.ogg",unlock:"sounds/doors/industrial/unlock.ogg"},jail:{label:"WALLS.DoorSound.Jail",close:"sounds/doors/jail/close.ogg",lock:"sounds/doors/jail/lock.ogg",open:"sounds/doors/jail/open.ogg",test:"sounds/doors/jail/test.ogg",unlock:"sounds/doors/jail/unlock.ogg"},magicDoor:{label:"WALLS.DoorSound.MagicDoor",close:"sounds/doors/magic/door-close.ogg",lock:"sounds/doors/magic/lock.ogg",open:"sounds/doors/magic/door-open.ogg",test:"sounds/doors/magic/test.ogg",unlock:"sounds/doors/magic/unlock.ogg"},magicWall:{label:"WALLS.DoorSound.MagicWall",close:"sounds/doors/magic/wall-close.ogg",lock:"sounds/doors/magic/lock.ogg",open:"sounds/doors/magic/wall-open.ogg",test:"sounds/doors/magic/test.ogg",unlock:"sounds/doors/magic/unlock.ogg"},metal:{label:"WALLS.DoorSound.Metal",close:"sounds/doors/metal/close.ogg",lock:"sounds/doors/metal/lock.ogg",open:"sounds/doors/metal/open.ogg",test:"sounds/doors/metal/test.ogg",unlock:"sounds/doors/metal/unlock.ogg"},slidingMetal:{label:"WALLS.DoorSound.SlidingMetal",close:"sounds/doors/shutter/close.ogg",lock:"sounds/doors/shutter/lock.ogg",open:"sounds/doors/shutter/open.ogg",test:"sounds/doors/shutter/test.ogg",unlock:"sounds/doors/shutter/unlock.ogg"},slidingModern:{label:"WALLS.DoorSound.SlidingModern",close:"sounds/doors/sliding/close.ogg",lock:"sounds/doors/sliding/lock.ogg",open:"sounds/doors/sliding/open.ogg",test:"sounds/doors/sliding/test.ogg",unlock:"sounds/doors/sliding/unlock.ogg"},slidingWood:{label:"WALLS.DoorSound.SlidingWood",close:"sounds/doors/sliding/close-wood.ogg",lock:"sounds/doors/sliding/lock.ogg",open:"sounds/doors/sliding/open-wood.ogg",test:"sounds/doors/sliding/test.ogg",unlock:"sounds/doors/sliding/unlock.ogg"},stoneBasic:{label:"WALLS.DoorSound.StoneBasic",close:"sounds/doors/stone/close.ogg",lock:"sounds/doors/stone/lock.ogg",open:"sounds/doors/stone/open.ogg",test:"sounds/doors/stone/test.ogg",unlock:"sounds/doors/stone/unlock.ogg"},stoneRocky:{label:"WALLS.DoorSound.StoneRocky",close:"sounds/doors/stone/close-rocky.ogg",lock:"sounds/doors/stone/lock.ogg",open:"sounds/doors/stone/open-rocky.ogg",test:"sounds/doors/stone/test.ogg",unlock:"sounds/doors/stone/unlock.ogg"},stoneSandy:{label:"WALLS.DoorSound.StoneSandy",close:"sounds/doors/stone/close-sandy.ogg",lock:"sounds/doors/stone/lock.ogg",open:"sounds/doors/stone/open-sandy.ogg",test:"sounds/doors/stone/test.ogg",unlock:"sounds/doors/stone/unlock.ogg"},woodBasic:{label:"WALLS.DoorSound.WoodBasic",close:"sounds/doors/wood/close.ogg",lock:"sounds/doors/wood/lock.ogg",open:"sounds/doors/wood/open.ogg",test:"sounds/doors/wood/test.ogg",unlock:"sounds/doors/wood/unlock.ogg"},woodCreaky:{label:"WALLS.DoorSound.WoodCreaky",close:"sounds/doors/wood/close-creaky.ogg",lock:"sounds/doors/wood/lock.ogg",open:"sounds/doors/wood/open-creaky.ogg",test:"sounds/doors/wood/test.ogg",unlock:"sounds/doors/wood/unlock.ogg"},woodHeavy:{label:"WALLS.DoorSound.WoodHeavy",close:"sounds/doors/wood/close-heavy.ogg",lock:"sounds/doors/wood/lock.ogg",open:"sounds/doors/wood/open-heavy.ogg",test:"sounds/doors/wood/test.ogg",unlock:"sounds/doors/wood/unlock.ogg"}}},soundEffects:{lowpass:{label:"SOUND.EFFECTS.LOWPASS",effectClass:foundry.audio.BiquadFilterEffect},highpass:{label:"SOUND.EFFECTS.HIGHPASS",effectClass:foundry.audio.BiquadFilterEffect},reverb:{label:"SOUND.EFFECTS.REVERB",effectClass:foundry.audio.ConvolverEffect}},TinyMCE:{branding:!1,menubar:!1,statusbar:!1,content_css:["/css/mce.css"],plugins:"lists image table code save link",toolbar:"styles bullist numlist image table hr link removeformat code save",save_enablewhendirty:!0,table_default_styles:{},style_formats:[{title:"Custom",items:[{title:"Secret",block:"section",classes:"secret",wrapper:!0}]}],style_formats_merge:!0},TextEditor:{enrichers:[]},WebRTC:{clientClass:class SimplePeerAVClient extends AVClient{localStream=null;levelsStream=null;peers=new Map;remoteStreams=new Map;_initialized=!1;audioBroadcastEnabled=!1;_connectionPoll=null;async connect(){return await this._connect(),clearInterval(this._connectionPoll),this._connectionPoll=setInterval(this._connect.bind(this),1e3*g.WebRTC.connectedUserPollIntervalS),!0}_connect(){const e=[];for(let t of c.users)!t.isSelf&&t.active&&e.push(this.initializePeerStream(t.id));return Promise.all(e)}async disconnect(){return clearInterval(this._connectionPoll),this._connectionPoll=null,await this.disconnectAll(),!0}async initialize(){this._initialized||(console.debug("Initializing SimplePeer client connection"),await this.initializeLocalStream(),this.activateSocketListeners(),window.addEventListener("beforeunload",(e=>this.disconnectAll())),this._initialized=!0)}getConnectedUsers(){return[...Array.from(this.peers.keys()),c.userId]}getMediaStreamForUser(e){return e===c.user.id?this.localStream:this.remoteStreams.get(e)}getLevelsStreamForUser(e){return e===c.userId?this.levelsStream:this.getMediaStreamForUser(e)}isAudioEnabled(){return!!this.localStream?.getAudioTracks().length}isVideoEnabled(){return!!this.localStream?.getVideoTracks().length}toggleAudio(e){if(this.localStream&&this.audioBroadcastEnabled&&!this.isVoicePTT)return this.toggleBroadcast(e)}toggleBroadcast(e){const t=this.localStream;if(t){console.debug(`[SimplePeer] Toggling broadcast of outbound audio: ${e}`),this.audioBroadcastEnabled=e;for(let i of t.getAudioTracks())i.enabled=e}}toggleVideo(e){const t=this.localStream;if(t){console.debug(`[SimplePeer] Toggling broadcast of outbound video: ${e}`);for(const i of t.getVideoTracks())i.enabled=e}}async setUserVideo(e,t){const i=this.getMediaStreamForUser(e);if("srcObject"in t?t.srcObject=i:t.src=window.URL.createObjectURL(i),void 0===t.sinkId)return console.warn("[SimplePeer] Your web browser does not support output audio sink selection");const n=this.settings.get("client","audioSink");await t.setSinkId(n).catch((e=>{console.warn(`[SimplePeer] An error occurred when requesting the output audio device: ${n}`)}))}async initializeLocalStream(){console.debug("[SimplePeer] Initializing local media stream for current User"),this.localStream&&this.localStream.getTracks().forEach((e=>e.stop())),this.localStream=null,this.levelsStream&&this.levelsStream.getTracks().forEach((e=>e.stop())),this.levelsStream=null;const e=this.settings.get("client","audioSrc"),t=this.master.canUserBroadcastAudio(c.user.id),i=!(!e||"disabled"===e||!t)&&{deviceId:{ideal:e}},n=this.settings.get("client","videoSrc"),s=this.master.canUserBroadcastVideo(c.user.id),o=!(!n||"disabled"===n||!s)&&{deviceId:{ideal:n},width:{ideal:320},height:{ideal:240}};if(navigator.userAgent.match(/Firefox/)&&delete o.deviceId,!o&&!i)return null;let r=await this._createMediaStream({video:o,audio:i});if(o&&i&&r instanceof Error&&(i&&(r=await this._createMediaStream({video:!1,audio:i})),r instanceof Error&&o&&(r=await this._createMediaStream({video:o,audio:!1}))),r instanceof Error){const e=new Error(`[SimplePeer] Unable to acquire user media stream: ${r.message}`);return e.stack=r.stack,console.error(e),null}return this.localStream=r,this.levelsStream=r.clone(),this.levelsStream.getVideoTracks().forEach((e=>this.levelsStream.removeTrack(e))),r}async _createMediaStream(e){try{return await navigator.mediaDevices.getUserMedia(e)}catch(e){return e}}activateSocketListeners(){c.socket.on("av",((e,t)=>{if(e.userId===c.user.id)switch(e.action){case"peer-signal":return e.activity&&this.master.settings.handleUserActivity(t,e.activity),this.receiveSignal(t,e.data);case"peer-close":return this.disconnectPeer(t)}}))}async initializePeerStream(e){const t=this.peers.get(e);return t?.connected||t?._connecting?t:this.connectPeer(e,!0)}receiveSignal(e,t){console.debug(`[SimplePeer] Receiving signal from User [${e}] to establish initial connection`);let i=this.peers.get(e);i||(i=this.connectPeer(e,!1)),i.signal(t)}connectPeer(e,t=!1){const i=this._createPeerConnection(e,t);return this.peers.set(e,i),i.on("signal",(t=>{console.debug(`[SimplePeer] Sending signal to User [${e}] to establish initial connection`),c.socket.emit("av",{action:"peer-signal",userId:e,data:t,activity:this.master.settings.getUser(c.userId)},{recipients:[e]})})),i.on("stream",(t=>{console.debug(`[SimplePeer] Received media stream from User [${e}]`),this.remoteStreams.set(e,t),this.master.render()})),i.on("close",(()=>(console.debug(`[SimplePeer] Closed connection with remote User [${e}]`),this.disconnectPeer(e)))),i.on("error",(t=>{if("ERR_DATA_CHANNEL"!==t.code){const i=new Error(`[SimplePeer] An unexpected error occurred with User [${e}]: ${t.message}`);i.stack=t.stack,console.error(i)}if(i.connected)return this.disconnectPeer(e)})),this.master.render(),i}_createPeerConnection(e,t){const i={initiator:t,stream:this.localStream};return this._setupCustomTURN(i),new SimplePeer(i)}_setupCustomTURN(e){const{url:t,type:i,username:n,password:s}=this.settings.world.turn;if("custom"!==i||!t||!n||!s)return;const o={username:n,urls:t,credential:s};e.config={iceServers:[o]}}async disconnectPeer(e){const t=this.remoteStreams.get(e);if(t){this.remoteStreams.delete(e);for(let e of t.getTracks())await e.stop()}const i=this.peers.get(e);i&&(this.peers.delete(e),await i.destroy()),this.master.render()}async disconnectAll(){const e=[];for(let t of this.peers.keys())e.push(this.disconnectPeer(t));return Promise.all(e)}async onSettingsChanged(e){const t=new Set(Object.keys(foundry.utils.flattenObject(e))),i=["client.videoSrc","client.audioSrc"].some((e=>t.has(e)));i&&await this.updateLocalStream();if(["client.voice.mode",`client.users.${c.user.id}.muted`].some((e=>t.has(e)))){const t="always"===this.settings.client.voice.mode;this.toggleAudio(t&&this.master.canUserShareAudio(c.user.id)),this.master.broadcast(t),this.master._initializeUserVoiceDetection(e.client.voice?.mode),ui.webrtc.setUserIsSpeaking(c.user.id,this.master.broadcasting)}const n=["client.audioSink","client.muteAll","client.disableVideo"].some((e=>t.has(e)));(i||n)&&this.master.render()}async updateLocalStream(){const e=this.localStream;await this.initializeLocalStream();for(let t of this.peers.values())e&&t.removeStream(e),this.localStream&&t.addStream(this.localStream);this.master._initializeUserVoiceDetection(this.settings.client.voice.mode)}},detectPeerVolumeInterval:50,detectSelfVolumeInterval:20,emitVolumeInterval:25,speakingThresholdEvents:2,speakingHistoryLength:10,connectedUserPollIntervalS:8},ui:{menu:class MainMenu extends Application{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"menu",template:"templates/hud/menu.html",popOut:!1})}get items(){return{reload:{label:"MENU.Reload",icon:'<i class="fas fa-redo"></i>',enabled:!0,onClick:()=>window.location.reload()},logout:{label:"MENU.Logout",icon:'<i class="fas fa-user"></i>',enabled:!0,onClick:()=>c.logOut()},players:{label:"MENU.Players",icon:'<i class="fas fa-users"></i>',enabled:c.user.isGM&&!c.data.demoMode,onClick:()=>window.location.href="./players"},world:{label:"GAME.ReturnSetup",icon:'<i class="fas fa-globe"></i>',enabled:c.user.hasRole("GAMEMASTER")&&!c.data.demoMode,onClick:()=>{this.close(),c.shutDown()}}}}getData(e={}){return{items:this.items}}activateListeners(e){for(let[t,i]of Object.entries(this.items))e.find(`.menu-${t}`).click(i.onClick)}toggle(){let e=this.element;this.rendered?e.slideToggle(150):this.render(!0)}},sidebar:class Sidebar extends Application{tabs={};_collapsed=!1;static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"sidebar",template:"templates/sidebar/sidebar.html",popOut:!1,width:300,tabs:[{navSelector:".tabs",contentSelector:"#sidebar",initial:"chat"}]})}get activeTab(){return this._tabs[0].active}get popouts(){const e={};for(let[t,i]of Object.entries(this.tabs))i._popout&&(e[t]=i._popout);return e}getData(e={}){const t=c.user.isGM,i={chat:{tooltip:ChatMessage.metadata.labelPlural,icon:g.ChatMessage.sidebarIcon,notification:'<i id="chat-notification" class="notification-pip fas fa-exclamation-circle"></i>'},combat:{tooltip:Combat.metadata.labelPlural,icon:g.Combat.sidebarIcon},scenes:{tooltip:Scene.metadata.labelPlural,icon:g.Scene.sidebarIcon},actors:{tooltip:Actor.metadata.labelPlural,icon:g.Actor.sidebarIcon},items:{tooltip:Item.metadata.labelPlural,icon:g.Item.sidebarIcon},journal:{tooltip:"SIDEBAR.TabJournal",icon:g.JournalEntry.sidebarIcon},tables:{tooltip:RollTable.metadata.labelPlural,icon:g.RollTable.sidebarIcon},cards:{tooltip:Cards.metadata.labelPlural,icon:g.Cards.sidebarIcon},playlists:{tooltip:Playlist.metadata.labelPlural,icon:g.Playlist.sidebarIcon},compendium:{tooltip:"SIDEBAR.TabCompendium",icon:"fas fa-atlas"},settings:{tooltip:"SIDEBAR.TabSettings",icon:"fas fa-cogs"}};return t||delete i.scenes,t&&(c.data.coreUpdate.hasUpdate||c.data.systemUpdate.hasUpdate)&&(i.settings.notification='<i class="notification-pip fas fa-exclamation-circle"></i>'),{tabs:i}}async _render(e,t){this.rendered||await super._render(e,t);const i=[];for(let[e,t]of Object.entries(this.tabs))i.push(t._render(!0).catch((t=>{Hooks$1.onError("Sidebar#_render",t,{msg:`Failed to render Sidebar tab ${e}`,log:"error",name:e})})));Promise.all(i).then((()=>this.activateTab(this.activeTab)))}expand(){if(!this._collapsed)return;const e=this.element,t=e.find(".sidebar-tab.active"),i=e.find("#sidebar-tabs"),n=i.find("a.collapse i");t.hide(),e.animate({width:this.options.width,height:this.position.height},150,(()=>{e.css({width:"",height:""}),e.removeClass("collapsed"),i[0].dataset.tooltipDirection=TooltipManager.TOOLTIP_DIRECTIONS.DOWN,t.fadeIn(250,(()=>{t.css({display:"",height:""})})),n.removeClass("fa-caret-left").addClass("fa-caret-right"),this._collapsed=!1,Hooks$1.callAll("collapseSidebar",this,this._collapsed)}))}collapse(){if(this._collapsed)return;const e=this.element,t=e.find(".sidebar-tab.active"),i=e.find("#sidebar-tabs"),n=i.find("a.collapse i");t.fadeOut(250,(()=>{e.animate({width:32,height:36*(Object.values(this.tabs).length+1)},150,(()=>{e.css("height",""),e.addClass("collapsed"),i[0].dataset.tooltipDirection=TooltipManager.TOOLTIP_DIRECTIONS.LEFT,t.css("display",""),n.removeClass("fa-caret-right").addClass("fa-caret-left"),this._collapsed=!0,Hooks$1.callAll("collapseSidebar",this,this._collapsed)}))}))}activateListeners(e){super.activateListeners(e);const t=this._tabs[0]._nav;t.addEventListener("contextmenu",this._onRightClickTab.bind(this));t.querySelector(".collapse").addEventListener("click",this._onToggleCollapse.bind(this));t.querySelectorAll(".item").forEach((e=>e.addEventListener("click",this._onLeftClickTab.bind(this))))}_onChangeTab(e,t,i){const n=ui[i];Hooks$1.callAll("changeSidebarTab",n)}_onLeftClickTab(e){const t=ui[e.currentTarget.dataset.tab];t&&this._collapsed&&t.renderPopout(t)}_onRightClickTab(e){const t=e.target.closest(".item");if(!t)return;e.preventDefault();const i=ui[t.dataset.tab];i.renderPopout(i)}_onToggleCollapse(e){e.preventDefault(),this._collapsed?this.expand():this.collapse()}},pause:class Pause extends Application{static get defaultOptions(){const e=super.defaultOptions;return e.id="pause",e.template="templates/hud/pause.html",e.popOut=!1,e}getData(e={}){return{paused:c.paused}}},nav:SceneNavigation,notifications:class Notifications extends Application{#y=1;constructor(e){super(e),this.queue=[],this.active=[],this.initialize()}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{popOut:!1,id:"notifications",template:"templates/hud/notifications.html"})}initialize(){for(let e of globalThis.MESSAGES)this.notify(c.i18n.localize(e.message),e.type,e.options)}async _renderInner(...e){return $('<ol id="notifications"></ol>')}async _render(...e){for(await super._render(...e);this.queue.length&&this.active.length<3;)this.fetch()}notify(e,t="info",{localize:i=!1,permanent:n=!1,console:s=!0}={}){i&&(e=c.i18n.localize(e));let o={id:this.#y++,message:e,type:["info","warning","error"].includes(t)?t:"info",timestamp:(new Date).getTime(),permanent:n,console:s};return this.queue.push(o),this.rendered&&this.fetch(),o.id}info(e,t){return this.notify(e,"info",t)}warn(e,t){return this.notify(e,"warning",t)}error(e,t){return this.notify(e,"error",t)}remove(e){if(!(e>0))return;if(this.queue.findSplice((t=>t.id===e)))return;const t=this.active.findSplice((t=>t.data("id")===e));t&&(t.fadeOut(66,(()=>t.remove())),this.fetch())}clear(){this.queue.length=0;for(const e of this.active)e.fadeOut(66,(()=>e.remove()));this.active.length=0}fetch(){if(!this.queue.length||this.active.length>=3)return;const e=this.queue.pop(),t=Date.now(),_remove=e=>{e.fadeOut(66,(()=>e.remove()));const t=this.active.indexOf(e);return t>=0&&this.active.splice(t,1),this.fetch()},i=["notification",e.type,e.permanent?"permanent":null].filterJoin(" "),n=$(`<li class="${i}" data-id="${e.id}">${e.message}<i class="close fas fa-times-circle"></i></li>`);n.click((e=>{Date.now()-t>250&&_remove(n)})),this.element.prepend(n),n.hide().slideDown(132),this.active.push(n),e.console&&console["warning"===e.type?"warn":e.type](e.message),e.permanent||window.setTimeout((()=>_remove(n)),5e3)}},actors:class ActorDirectory extends DocumentDirectory{constructor(...e){super(...e),this._dragDrop[0].permissions.dragstart=()=>c.user.can("TOKEN_CREATE"),this._dragDrop[0].permissions.drop=()=>c.user.can("ACTOR_CREATE")}static documentName="Actor";_canDragStart(e){return c.user.can("TOKEN_CREATE")}_onDragStart(e){const t=e.currentTarget.closest(".directory-item");let i=null;if(t.dataset.documentId&&(i=c.actors.get(t.dataset.documentId),!i||!i.visible))return!1;if(super._onDragStart(e),i&&canvas.ready){const n=t.querySelector("img"),s=i.prototypeToken,o=s.width*canvas.dimensions.size*Math.abs(s.texture.scaleX)*canvas.stage.scale.x,r=s.height*canvas.dimensions.size*Math.abs(s.texture.scaleY)*canvas.stage.scale.y,a=DragDrop.createDragImage(n,o,r);e.dataTransfer.setDragImage(a,o/2,r/2)}}_canDragDrop(e){return c.user.can("ACTOR_CREATE")}_getEntryContextOptions(){const e=super._getEntryContextOptions();return[{name:"SIDEBAR.CharArt",icon:'<i class="fas fa-image"></i>',condition:e=>c.actors.get(e.data("documentId")).img!==CONST.DEFAULT_TOKEN,callback:e=>{const t=c.actors.get(e.data("documentId"));new ImagePopout(t.img,{title:t.name,uuid:t.uuid}).render(!0)}},{name:"SIDEBAR.TokenArt",icon:'<i class="fas fa-image"></i>',condition:e=>{const t=c.actors.get(e.data("documentId"));return!t.prototypeToken.randomImg&&![null,void 0,CONST.DEFAULT_TOKEN].includes(t.prototypeToken.texture.src)},callback:e=>{const t=c.actors.get(e.data("documentId"));new ImagePopout(t.prototypeToken.texture.src,{title:t.name,uuid:t.uuid}).render(!0)}}].concat(e)}},cards:class CardsDirectory extends DocumentDirectory{static documentName="Cards";_getEntryContextOptions(){const e=super._getEntryContextOptions();return e.find((e=>"SIDEBAR.Duplicate"===e.name)).condition=e=>{if(!c.user.isGM)return!1;return this.constructor.collection.get(e.data("documentId")).canClone},e}},chat:ChatLog,combat:class CombatTracker extends SidebarTab{constructor(e){super(e),this.popOut||c.combats.apps.push(this),this._highlighted=null,this.viewed=null,this.initialize({render:!1})}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"combat",template:"templates/sidebar/combat-tracker.html",title:"COMBAT.SidebarTitle",scrollY:[".directory-list"]})}get combats(){return c.combats.combats}createPopout(){const e=super.createPopout();return e.initialize({combat:this.viewed,render:!0}),e}initialize({combat:e=null,render:t=!0}={}){if(null===e){const t=this.combats;e=t.length?t.find((e=>e.active))||t[0]:null,e?.updateCombatantActors()}e&&!e.turns&&(e.turns=e.setupTurns()),this.viewed=e,this._highlighted=null,this._popout&&(this._popout.viewed=e,this._popout._highlighted=null),t&&this.render()}scrollToTurn(){const e=this.viewed;if(!e||null===e.turn)return;let t=this.element.find(".active")[0];if(!t)return;let i=t.parentElement;const n=Math.floor(i.offsetHeight/t.offsetHeight);i.scrollTop=e.turn*t.offsetHeight-n/2*t.offsetHeight}async getData(e={}){let t=await super.getData(e);const i=this.viewed,n=null!==i,s=this.combats,o=s.findIndex((e=>e===i)),r=o>0?s[o-1].id:null,a=o<s.length-1?s[o+1].id:null,l=c.settings.get("core",Combat.CONFIG_SETTING);if(t=foundry.utils.mergeObject(t,{combats:s,currentIndex:o+1,combatCount:s.length,hasCombat:n,combat:i,turns:[],previousId:r,nextId:a,started:this.started,control:!1,settings:l,linked:null!==i?.scene,labels:{}}),t.labels.scope=c.i18n.localize("COMBAT."+(t.linked?"Linked":"Unlinked")),!n)return t;let d=!1;const u=[];for(let[e,t]of i.turns.entries()){if(!t.visible)continue;const n=t.permission>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER?t.resource:null,s={id:t.id,name:t.name,img:await this._getCombatantThumbnail(t),active:e===i.turn,owner:t.isOwner,defeated:t.isDefeated,hidden:t.hidden,initiative:t.initiative,hasRolled:null!==t.initiative,hasResource:null!==n,resource:n,canPing:t.sceneId===canvas.scene?.id&&c.user.hasPermission("PING_CANVAS")};null===s.initiative||Number.isInteger(s.initiative)||(d=!0),s.css=[s.active?"active":"",s.hidden?"hidden":"",s.defeated?"defeated":""].join(" ").trim(),s.effects=new Set;for(const e of t.actor?.temporaryEffects||[])e.statuses.has(g.specialStatusEffects.DEFEATED)?s.defeated=!0:e.img&&s.effects.add(e.img);u.push(s)}const h=g.Combat.initiative.decimals;u.forEach((e=>{null!==e.initiative&&(e.initiative=e.initiative.toFixed(d?h:0))}));const p=i.combatant?.players?.includes(c.user),m=i.turn&&i.turn.between(1,i.turns.length-2)?i.canUserModify(c.user,"update",{turn:0}):i.canUserModify(c.user,"update",{round:0});return foundry.utils.mergeObject(t,{round:i.round,turn:i.turn,turns:u,control:p&&m})}async _getCombatantThumbnail(e){return e._videoSrc&&!e.img?e._thumb?e._thumb:e._thumb=await c.video.createThumbnail(e._videoSrc,{width:100,height:100}):e.img??CONST.DEFAULT_TOKEN}activateListeners(e){super.activateListeners(e);const t=e.find("#combat-tracker"),i=t.find(".combatant");e.find(".combat-create").click((e=>this._onCombatCreate(e))),e.find(".combat-settings").click((e=>{e.preventDefault(),(new CombatTrackerConfig).render(!0)})),e.find(".combat-cycle").click((e=>this._onCombatCycle(e))),e.find(".combat-control").click((e=>this._onCombatControl(e))),e.find(".combatant-control").click((e=>this._onCombatantControl(e))),i.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),i.click(this._onCombatantMouseDown.bind(this)),c.user.isGM&&this._contextMenu(e);const n=new IntersectionObserver(this._onLazyLoadImage.bind(this),{root:t[0]});i.each(((e,t)=>n.observe(t)))}async _onCombatCreate(e){e.preventDefault();let t=c.scenes.current;const i=getDocumentClass("Combat");await i.create({scene:t?.id,active:!0})}async _onCombatCycle(e){e.preventDefault();const t=e.currentTarget,i=c.combats.get(t.dataset.documentId);i&&await i.activate({render:!1})}async _onCombatControl(e){e.preventDefault();const t=this.viewed,i=e.currentTarget;if(!i.getAttribute("disabled")){i.setAttribute("disabled",!0);try{const e=t[i.dataset.control];e&&await e.bind(t)()}finally{i.removeAttribute("disabled")}}}async _onCombatantControl(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget,i=t.closest(".combatant"),n=this.viewed,s=n.combatants.get(i.dataset.combatantId);switch(t.dataset.control){case"toggleHidden":return s.update({hidden:!s.hidden});case"toggleDefeated":return this._onToggleDefeatedStatus(s);case"rollInitiative":return n.rollInitiative([s.id]);case"pingCombatant":return this._onPingCombatant(s);case"panToCombatant":return this._onPanToCombatant(s)}}async _onToggleDefeatedStatus(e){const t=!e.isDefeated;await e.update({defeated:t});const i=g.specialStatusEffects.DEFEATED;await(e.actor?.toggleStatusEffect(i,{overlay:!0,active:t}))}async _onPingCombatant(e){if(canvas.ready&&e.sceneId===canvas.scene.id)return e.token.object.visible?void await canvas.ping(e.token.object.center):ui.notifications.warn(c.i18n.localize("COMBAT.WarnNonVisibleToken"))}async _onPanToCombatant(e){if(!canvas.ready||e.sceneId!==canvas.scene.id)return;if(!e.token.object.visible)return ui.notifications.warn(c.i18n.localize("COMBAT.WarnNonVisibleToken"));const{x:t,y:i}=e.token.object.center;await canvas.animatePan({x:t,y:i,scale:Math.max(canvas.stage.scale.x,.5)})}async _onCombatantMouseDown(e){e.preventDefault();const t=e.currentTarget,i=this.viewed.combatants.get(t.dataset.combatantId),n=i.token;if(!i.actor?.testUserPermission(c.user,"OBSERVER"))return;const s=Date.now(),o=s-this._clickTime;return this._clickTime=s,o<=250?i.actor?.sheet.render(!0):n?.object?(n.object?.control({releaseOthers:!0}),canvas.animatePan(n.object.center)):void 0}_onCombatantHoverIn(e){if(e.preventDefault(),!canvas.ready)return;const t=e.currentTarget,i=this.viewed.combatants.get(t.dataset.combatantId),n=i.token?.object;n?.isVisible&&(n.controlled||n._onHoverIn(e,{hoverOutOthers:!0}),this._highlighted=n)}_onCombatantHoverOut(e){e.preventDefault(),this._highlighted&&this._highlighted._onHoverOut(e),this._highlighted=null}hoverCombatant(e,t){const i=[this.element[0]];this._popout&&i.push(this._popout.element[0]);for(const n of i){const i=n.querySelector(`.combatant[data-combatant-id="${e.id}"]`);i&&(t?i.classList.add("hover"):i.classList.remove("hover"))}}_contextMenu(e){ContextMenu.create(this,e,".directory-item",this._getEntryContextOptions())}_getEntryContextOptions(){return[{name:"COMBAT.CombatantUpdate",icon:'<i class="fas fa-edit"></i>',callback:this._onConfigureCombatant.bind(this)},{name:"COMBAT.CombatantClear",icon:'<i class="fas fa-undo"></i>',condition:e=>{const t=this.viewed.combatants.get(e.data("combatant-id"));return Number.isNumeric(t?.initiative)},callback:e=>{const t=this.viewed.combatants.get(e.data("combatant-id"));if(t)return t.update({initiative:null})}},{name:"COMBAT.CombatantReroll",icon:'<i class="fas fa-dice-d20"></i>',callback:e=>{const t=this.viewed.combatants.get(e.data("combatant-id"));if(t)return this.viewed.rollInitiative([t.id])}},{name:"COMBAT.CombatantRemove",icon:'<i class="fas fa-trash"></i>',callback:e=>{const t=this.viewed.combatants.get(e.data("combatant-id"));if(t)return t.delete()}}]}_onConfigureCombatant(e){const t=this.viewed.combatants.get(e.data("combatant-id"));new CombatantConfig(t,{top:Math.min(e[0].offsetTop,window.innerHeight-350),left:window.innerWidth-720,width:400}).render(!0)}},compendium:CompendiumDirectory,controls:class SceneControls extends Application{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{width:100,id:"controls",template:"templates/hud/controls.html",popOut:!1})}controls=this._getControlButtons();get activeControl(){return this.#qc}#qc="token";get activeTool(){return this.#Jc[this.#qc]}#Jc={};get control(){return this.controls&&this.controls.find((e=>e.name===this.#qc))||null}get tool(){const e=this.control;return e&&this.#Jc[e.name]||null}initialize({control:e,layer:t,tool:i}={}){let n=e?this.controls.find((t=>t.name===e)):null;if(!n&&t&&(n=this.controls.find((e=>e.layer===t))),n||(n=this.control),i||=this.#Jc[n.name]||n.activeTool||null,this.#qc=n?.name||null,n&&this.#Jc[this.#qc]!==i&&(this.#Jc[this.#qc]=i,canvas.ready)){const e=canvas[n.layer];if(e instanceof PlaceablesLayer)for(const t of e.placeables)t.renderFlags.set({refreshState:!0})}this.controls=this._getControlButtons(),this.render(!0)}async getData(e={}){const t=c.settings.get("core","showToolclips"),i=!!canvas.scene,n=[],s=navigator.appVersion.includes("Mac"),o=s?"âŒ˜":c.i18n.localize("CONTROLS.CtrlAbbr"),r=s?"âŒ¥":c.i18n.localize("CONTROLS.Alt");for(const e of this.controls){if(!1===e.visible)continue;const s=foundry.utils.deepClone(e);s.isActive=i&&this.#qc===s.name,s.css=s.isActive?"active":"",s.tools=[];for(const n of e.tools){if(!1===n.visible)continue;const e=foundry.utils.deepClone(n);e.isActive=i&&(this.#Jc[s.name]===e.name||e.toggle&&e.active),e.css=[e.toggle?"toggle":null,e.isActive?"active":null].filterJoin(" "),e.tooltip=t&&e.toolclip?await renderTemplate("templates/hud/toolclip.html",{...e.toolclip,alt:r,mod:o}):e.title,s.tools.push(e)}s.tools.length&&n.push(s)}return{controls:n,active:i,cssClass:i?"":"disabled"}}activateListeners(e){e.find(".scene-control").click(this._onClickLayer.bind(this)),e.find(".control-tool").click(this._onClickTool.bind(this)),canvas.notes?.hintMapNotes()}_onClickLayer(e){if(e.preventDefault(),!canvas.ready)return;const t=e.currentTarget.dataset.control;if(this.#qc===t)return;this.#qc=t;const i=this.controls.find((e=>e.name===t));i&&canvas[i.layer].activate()}_onClickTool(e){if(e.preventDefault(),!canvas.ready)return;const t=e.currentTarget,i=this.control,n=t.dataset.tool,s=i.tools.find((e=>e.name===n));if(s.toggle)s.active=!s.active,s.onClick instanceof Function&&s.onClick(s.active);else if(s.button)s.onClick instanceof Function&&s.onClick();else if(this.#Jc[i.name]!==n){this.#Jc[i.name]=n;const e=canvas[i.layer];if(e instanceof PlaceablesLayer)for(const t of e.placeables)t.renderFlags.set({refreshState:!0});s.onClick instanceof Function&&s.onClick()}this.render()}_getControlButtons(){const e=[],t=c.user.isGM,i=c.settings.get("core","showToolclips")?"Clip":"",n={create:{heading:"CONTROLS.CommonCreate",reference:"CONTROLS.ClickDrag"},move:{heading:"CONTROLS.CommonMove",reference:"CONTROLS.Drag"},edit:{heading:"CONTROLS.CommonEdit",reference:"CONTROLS.DoubleClick"},editAlt:{heading:"CONTROLS.CommonEdit",reference:"CONTROLS.DoubleRightClick"},sheet:{heading:"CONTROLS.CommonOpenSheet",reference:"CONTROLS.DoubleClick"},hide:{heading:"CONTROLS.CommonHide",reference:"CONTROLS.RightClick"},delete:{heading:"CONTROLS.CommonDelete",reference:"CONTROLS.Delete"},rotate:{heading:"CONTROLS.CommonRotate",content:"CONTROLS.ShiftOrCtrlScroll"},select:{heading:"CONTROLS.CommonSelect",reference:"CONTROLS.Click"},selectAlt:{heading:"CONTROLS.CommonSelect",content:"CONTROLS.ClickOrClickDrag"},selectMultiple:{heading:"CONTROLS.CommonSelectMultiple",reference:"CONTROLS.ShiftClick"},hud:{heading:"CONTROLS.CommonToggleHUD",reference:"CONTROLS.RightClick"},draw:{heading:"CONTROLS.CommonDraw",reference:"CONTROLS.ClickDrag"},drawProportionally:{heading:"CONTROLS.CommonDrawProportional",reference:"CONTROLS.AltClickDrag"},place:{heading:"CONTROLS.CommonPlace",reference:"CONTROLS.ClickDrag"},chain:{heading:"CONTROLS.CommonChain",content:"CONTROLS.ChainCtrlClick"},movePoint:{heading:"CONTROLS.CommonMovePoint",reference:"CONTROLS.ClickDrag"},openClose:{heading:"CONTROLS.CommonOpenClose",reference:"CONTROLS.Click"},openCloseSilently:{heading:"CONTROLS.CommonOpenCloseSilently",reference:"CONTROLS.AltClick"},lock:{heading:"CONTROLS.CommonLock",reference:"CONTROLS.RightClick"},lockSilently:{heading:"CONTROLS.CommonLockSilently",reference:"CONTROLS.AltRightClick"},onOff:{heading:"CONTROLS.CommonOnOff",reference:"CONTROLS.RightClick"}},buildItems=(...e)=>e.map((e=>n[e]));return e.push({name:"token",title:"CONTROLS.GroupToken",layer:"tokens",icon:"fa-solid fa-user-alt",tools:[{name:"select",title:"CONTROLS.BasicSelect",icon:"fa-solid fa-expand",toolclip:{src:"toolclips/tools/token-select.webm",heading:"CONTROLS.BasicSelect",items:[{paragraph:"CONTROLS.BasicSelectP"},...buildItems("selectAlt","selectMultiple","move","rotate","hud","sheet"),...c.user.isGM?buildItems("editAlt","delete"):[],{heading:"CONTROLS.BasicMeasureStart",reference:"CONTROLS.CtrlClickDrag"},{heading:"CONTROLS.BasicMeasureWaypoints",reference:"CONTROLS.CtrlClick"},{heading:"CONTROLS.BasicMeasureFollow",reference:"CONTROLS.Spacebar"}]}},{name:"target",title:"CONTROLS.TargetSelect",icon:"fa-solid fa-bullseye",toolclip:{src:"toolclips/tools/token-target.webm",heading:"CONTROLS.TargetSelect",items:[{paragraph:"CONTROLS.TargetSelectP"},...buildItems("selectAlt","selectMultiple")]}},{name:"ruler",title:"CONTROLS.BasicMeasure",icon:"fa-solid fa-ruler",toolclip:{src:"toolclips/tools/token-measure.webm",heading:"CONTROLS.BasicMeasure",items:[{heading:"CONTROLS.BasicMeasureStart",reference:"CONTROLS.ClickDrag"},{heading:"CONTROLS.BasicMeasureWaypoints",reference:"CONTROLS.CtrlClick"},{heading:"CONTROLS.BasicMeasureFollow",reference:"CONTROLS.Spacebar"}]}}],activeTool:"select"}),e.push({name:"measure",title:"CONTROLS.GroupMeasure",layer:"templates",icon:"fa-solid fa-ruler-combined",visible:c.user.can("TEMPLATE_CREATE"),tools:[{name:"circle",title:"CONTROLS.MeasureCircle",icon:"fa-regular fa-circle",toolclip:{src:"toolclips/tools/measure-circle.webm",heading:"CONTROLS.MeasureCircle",items:buildItems("create","move","edit","hide","delete")}},{name:"cone",title:"CONTROLS.MeasureCone",icon:"fa-solid fa-angle-left",toolclip:{src:"toolclips/tools/measure-cone.webm",heading:"CONTROLS.MeasureCone",items:buildItems("create","move","edit","hide","delete","rotate")}},{name:"rect",title:"CONTROLS.MeasureRect",icon:"fa-regular fa-square",toolclip:{src:"toolclips/tools/measure-rect.webm",heading:"CONTROLS.MeasureRect",items:buildItems("create","move","edit","hide","delete","rotate")}},{name:"ray",title:"CONTROLS.MeasureRay",icon:"fa-solid fa-arrows-alt-v",toolclip:{src:"toolclips/tools/measure-ray.webm",heading:"CONTROLS.MeasureRay",items:buildItems("create","move","edit","hide","delete","rotate")}},{name:"clear",title:"CONTROLS.MeasureClear",icon:"fa-solid fa-trash",visible:t,onClick:()=>canvas.templates.deleteAll(),button:!0}],activeTool:"circle"}),e.push({name:"tiles",title:"CONTROLS.GroupTile",layer:"tiles",icon:"fa-solid fa-cubes",visible:t,tools:[{name:"select",title:"CONTROLS.TileSelect",icon:"fa-solid fa-expand",toolclip:{src:"toolclips/tools/tile-select.webm",heading:"CONTROLS.TileSelect",items:buildItems("selectAlt","selectMultiple","move","rotate","hud","edit","delete")}},{name:"tile",title:"CONTROLS.TilePlace",icon:"fa-solid fa-cube",toolclip:{src:"toolclips/tools/tile-place.webm",heading:"CONTROLS.TilePlace",items:buildItems("create","move","rotate","hud","edit","delete")}},{name:"browse",title:"CONTROLS.TileBrowser",icon:"fa-solid fa-folder",button:!0,onClick:()=>{new FilePicker({type:"imagevideo",displayMode:"tiles",tileSize:!0}).render(!0)},toolclip:{src:"toolclips/tools/tile-browser.webm",heading:"CONTROLS.TileBrowser",items:buildItems("place","move","rotate","hud","edit","delete")}},{name:"foreground",title:"CONTROLS.TileForeground",icon:"fa-solid fa-home",toggle:!0,active:!1,onClick:e=>{this.control.foreground=e;for(const e of canvas.tiles.placeables)e.renderFlags.set({refreshState:!0}),e.controlled&&e.release()}},{name:"snap",title:"CONTROLS.CommonForceSnap",icon:"fa-solid fa-plus",toggle:!0,active:canvas.forceSnapVertices,onClick:e=>canvas.forceSnapVertices=e}],activeTool:"select"}),e.push({name:"drawings",title:"CONTROLS.GroupDrawing",layer:"drawings",icon:"fa-solid fa-pencil-alt",visible:c.user.can("DRAWING_CREATE"),tools:[{name:"select",title:"CONTROLS.DrawingSelect",icon:"fa-solid fa-expand",toolclip:{src:"toolclips/tools/drawing-select.webm",heading:"CONTROLS.DrawingSelect",items:buildItems("selectAlt","selectMultiple","move","hud","edit","delete","rotate")}},{name:"rect",title:"CONTROLS.DrawingRect",icon:"fa-solid fa-square",toolclip:{src:"toolclips/tools/drawing-rect.webm",heading:"CONTROLS.DrawingRect",items:buildItems("draw","move","hud","edit","delete","rotate")}},{name:"ellipse",title:"CONTROLS.DrawingEllipse",icon:"fa-solid fa-circle",toolclip:{src:"toolclips/tools/drawing-ellipse.webm",heading:"CONTROLS.DrawingEllipse",items:buildItems("draw","move","hud","edit","delete","rotate")}},{name:"polygon",title:"CONTROLS.DrawingPoly",icon:"fa-solid fa-draw-polygon",toolclip:{src:"toolclips/tools/drawing-polygon.webm",heading:"CONTROLS.DrawingPoly",items:[{heading:"CONTROLS.CommonDraw",content:"CONTROLS.DrawingPolyP"},...buildItems("move","hud","edit","delete","rotate")]}},{name:"freehand",title:"CONTROLS.DrawingFree",icon:"fa-solid fa-signature",toolclip:{src:"toolclips/tools/drawing-free.webm",heading:"CONTROLS.DrawingFree",items:buildItems("draw","move","hud","edit","delete","rotate")}},{name:"text",title:"CONTROLS.DrawingText",icon:"fa-solid fa-font",onClick:()=>{const e=canvas.drawings.controlled;1===e.length&&e[0].enableTextEditing()},toolclip:{src:"toolclips/tools/drawing-text.webm",heading:"CONTROLS.DrawingText",items:buildItems("draw","move","hud","edit","delete","rotate")}},{name:"role",title:"CONTROLS.DrawingRole",icon:"fa-solid fa-circle-info",toggle:!0,active:!1},{name:"snap",title:"CONTROLS.CommonForceSnap",icon:"fa-solid fa-plus",toggle:!0,active:canvas.forceSnapVertices,onClick:e=>canvas.forceSnapVertices=e},{name:"configure",title:"CONTROLS.DrawingConfig",icon:"fa-solid fa-cog",onClick:()=>canvas.drawings.configureDefault(),button:!0},{name:"clear",title:"CONTROLS.DrawingClear",icon:"fa-solid fa-trash",visible:t,onClick:()=>canvas.drawings.deleteAll(),button:!0}],activeTool:"select"}),e.push({name:"walls",title:"CONTROLS.GroupWall",layer:"walls",icon:"fa-solid fa-block-brick",visible:t,tools:[{name:"select",title:"CONTROLS.WallSelect",icon:"fa-solid fa-expand",toolclip:{src:"toolclips/tools/wall-select.webm",heading:"CONTROLS.WallSelect",items:[...buildItems("selectAlt","selectMultiple","move"),{heading:"CONTROLS.CommonMoveWithoutSnapping",reference:"CONTROLS.ShiftDrag"},{heading:"CONTROLS.CommonEdit",content:"CONTROLS.WallSelectEdit"},...buildItems("delete")]}},{name:"walls",title:"CONTROLS.WallDraw",icon:"fa-solid fa-bars",toolclip:{src:"toolclips/tools/wall-basic.webm",heading:"CONTROLS.WallBasic",items:[{heading:"CONTROLS.CommonBlocks",content:"CONTROLS.WallBasicBlocks"},...buildItems("place","chain","movePoint","edit","delete")]}},{name:"terrain",title:"CONTROLS.WallTerrain",icon:"fa-solid fa-mountain",toolclip:{src:"toolclips/tools/wall-terrain.webm",heading:"CONTROLS.WallTerrain",items:[{heading:"CONTROLS.CommonBlocks",content:"CONTROLS.WallTerrainBlocks"},...buildItems("place","chain","movePoint","edit","delete")]}},{name:"invisible",title:"CONTROLS.WallInvisible",icon:"fa-solid fa-eye-slash",toolclip:{src:"toolclips/tools/wall-invisible.webm",heading:"CONTROLS.WallInvisible",items:[{heading:"CONTROLS.CommonBlocks",content:"CONTROLS.WallInvisibleBlocks"},...buildItems("place","chain","movePoint","edit","delete")]}},{name:"ethereal",title:"CONTROLS.WallEthereal",icon:"fa-solid fa-mask",toolclip:{src:"toolclips/tools/wall-ethereal.webm",heading:"CONTROLS.WallEthereal",items:[{heading:"CONTROLS.CommonBlocks",content:"CONTROLS.WallEtherealBlocks"},...buildItems("place","chain","movePoint","edit","delete")]}},{name:"doors",title:"CONTROLS.WallDoors",icon:"fa-solid fa-door-open",toolclip:{src:"toolclips/tools/wall-door.webm",heading:"CONTROLS.WallDoors",items:[{heading:"CONTROLS.CommonBlocks",content:"CONTROLS.DoorBlocks"},...buildItems("openClose","openCloseSilently","lock","lockSilently","place","chain","movePoint","edit")]}},{name:"secret",title:"CONTROLS.WallSecret",icon:"fa-solid fa-user-secret",toolclip:{src:"toolclips/tools/wall-secret-door.webm",heading:"CONTROLS.WallSecret",items:[{heading:"CONTROLS.WallSecretHidden",content:"CONTROLS.WallSecretHiddenP"},{heading:"CONTROLS.CommonBlocks",content:"CONTROLS.DoorBlocks"},...buildItems("openClose","openCloseSilently","lock","lockSilently","place","chain","movePoint","edit")]}},{name:"window",title:"CONTROLS.WallWindow",icon:"fa-solid fa-window-frame",toolclip:{src:"toolclips/tools/wall-window.webm",heading:"CONTROLS.WallWindow",items:[{heading:"CONTROLS.CommonBlocks",content:"CONTROLS.WallWindowBlocks"},...buildItems("place","chain","movePoint","edit","delete")]}},{name:"clone",title:"CONTROLS.WallClone",icon:"fa-regular fa-clone"},{name:"snap",title:"CONTROLS.CommonForceSnap",icon:"fa-solid fa-plus",toggle:!0,active:canvas.forceSnapVertices,onClick:e=>canvas.forceSnapVertices=e,toolclip:{src:"toolclips/tools/wall-snap.webm",heading:"CONTROLS.CommonForceSnap",items:[{paragraph:"CONTROLS.WallSnapP"}]}},{name:"close-doors",title:"CONTROLS.WallCloseDoors",icon:"fa-regular fa-door-closed",onClick:()=>{let e=canvas.walls.placeables.reduce(((e,t)=>(t.isDoor&&t.document.ds===CONST.WALL_DOOR_STATES.OPEN&&e.push({_id:t.id,ds:CONST.WALL_DOOR_STATES.CLOSED}),e)),[]);e.length&&(canvas.scene.updateEmbeddedDocuments("Wall",e,{sound:!1}),ui.notifications.info(c.i18n.format("CONTROLS.WallDoorsClosed",{number:e.length})))}},{name:"clear",title:"CONTROLS.WallClear",icon:"fa-solid fa-trash",onClick:()=>canvas.walls.deleteAll(),button:!0}],activeTool:"walls"}),e.push({name:"lighting",title:"CONTROLS.GroupLighting",layer:"lighting",icon:"fa-regular fa-lightbulb",visible:t,tools:[{name:"light",title:"CONTROLS.LightDraw",icon:"fa-solid fa-lightbulb",toolclip:{src:"toolclips/tools/light-draw.webm",heading:"CONTROLS.LightDraw",items:buildItems("create","edit","rotate","onOff")}},{name:"day",title:"CONTROLS.LightDay",icon:"fa-solid fa-sun",visible:!canvas.scene?.environment.darknessLock,onClick:()=>canvas.scene.update({environment:{darknessLevel:0}},{animateDarkness:g.Canvas.darknessToDaylightAnimationMS}),button:!0,toolclip:{src:"toolclips/tools/light-day.webm",heading:"CONTROLS.LightDay",items:[{heading:"CONTROLS.MakeDayH",content:"CONTROLS.MakeDayP"},{heading:"CONTROLS.AutoLightToggleH",content:"CONTROLS.AutoLightToggleP"}]}},{name:"night",title:"CONTROLS.LightNight",icon:"fa-solid fa-moon",visible:!canvas.scene?.environment.darknessLock,onClick:()=>canvas.scene.update({environment:{darknessLevel:1}},{animateDarkness:g.Canvas.daylightToDarknessAnimationMS}),button:!0,toolclip:{src:"toolclips/tools/light-night.webm",heading:"CONTROLS.LightNight",items:[{heading:"CONTROLS.MakeNightH",content:"CONTROLS.MakeNightP"},{heading:"CONTROLS.AutoLightToggleH",content:"CONTROLS.AutoLightToggleP"}]}},{name:"reset",title:"CONTROLS.LightReset",icon:"fa-solid fa-cloud",onClick:()=>{new Dialog({title:c.i18n.localize("CONTROLS.FOWResetTitle"),content:`<p>${c.i18n.localize("CONTROLS.FOWResetDesc")}</p>`,buttons:{yes:{icon:'<i class="fa-solid fa-check"></i>',label:"Yes",callback:()=>canvas.fog.reset()},no:{icon:'<i class="fa-solid fa-times"></i>',label:"No"}}}).render(!0)},button:!0,toolclip:{src:"toolclips/tools/light-reset.webm",heading:"CONTROLS.LightReset",items:[{paragraph:"CONTROLS.LightResetP"}]}},{name:"clear",title:"CONTROLS.LightClear",icon:"fa-solid fa-trash",onClick:()=>canvas.lighting.deleteAll(),button:!0}],activeTool:"light"}),e.push({name:"sounds",title:"CONTROLS.GroupSound",layer:"sounds",icon:"fa-solid fa-music",visible:t,tools:[{name:"sound",title:"CONTROLS.SoundDraw",icon:"fa-solid fa-volume-up",toolclip:{src:"toolclips/tools/sound-draw.webm",heading:"CONTROLS.SoundDraw",items:buildItems("create","edit","rotate","onOff")}},{name:"preview",title:`CONTROLS.SoundPreview${i}`,icon:"fa-solid fa-headphones",toggle:!0,active:canvas.sounds?.livePreview??!1,onClick:e=>{canvas.sounds.livePreview=e,canvas.sounds.refresh()},toolclip:{src:"toolclips/tools/sound-preview.webm",heading:"CONTROLS.SoundPreview",items:[{paragraph:"CONTROLS.SoundPreviewP"}]}},{name:"clear",title:"CONTROLS.SoundClear",icon:"fa-solid fa-trash",onClick:()=>canvas.sounds.deleteAll(),button:!0}],activeTool:"sound"}),e.push({name:"regions",title:"CONTROLS.GroupRegion",layer:"regions",icon:"fa-regular fa-game-board",visible:c.user.isGM,tools:[{name:"select",title:"CONTROLS.RegionSelect",icon:"fa-solid fa-expand",toolclip:{src:"toolclips/tools/region-select.webm",heading:"CONTROLS.RegionSelect",items:[{paragraph:"CONTROLS.RegionSelectP"},...buildItems("selectAlt","selectMultiple","edit","delete")]}},{name:"rectangle",title:"CONTROLS.RegionRectangle",icon:"fa-solid fa-square",toolclip:{src:"toolclips/tools/region-rectangle.webm",heading:"CONTROLS.RegionRectangle",items:[{paragraph:"CONTROLS.RegionShape"},...buildItems("draw","drawProportionally"),{paragraph:"CONTROLS.RegionPerformance"}]}},{name:"ellipse",title:"CONTROLS.RegionEllipse",icon:"fa-solid fa-circle",toolclip:{src:"toolclips/tools/region-ellipse.webm",heading:"CONTROLS.RegionEllipse",items:[{paragraph:"CONTROLS.RegionShape"},...buildItems("draw","drawProportionally"),{paragraph:"CONTROLS.RegionPerformance"}]}},{name:"polygon",title:"CONTROLS.RegionPolygon",icon:"fa-solid fa-draw-polygon",toolclip:{src:"toolclips/tools/region-polygon.webm",heading:"CONTROLS.RegionPolygon",items:[{paragraph:"CONTROLS.RegionShape"},...buildItems("draw","drawProportionally"),{paragraph:"CONTROLS.RegionPerformance"}]}},{name:"hole",title:"CONTROLS.RegionHole",icon:"fa-duotone fa-object-subtract",toggle:!0,active:canvas.regions?._holeMode??!1,onClick:e=>canvas.regions._holeMode=e,toolclip:{src:"toolclips/tools/region-hole.webm",heading:"CONTROLS.RegionHole",items:[{paragraph:"CONTROLS.RegionHoleP"},...buildItems("draw","drawProportionally")]}},{name:"snap",title:"CONTROLS.CommonForceSnap",icon:"fa-solid fa-plus",toggle:!0,active:canvas.forceSnapVertices,onClick:e=>canvas.forceSnapVertices=e,toolclip:{src:"toolclips/tools/region-snap.webm",heading:"CONTROLS.CommonForceSnap",items:[{paragraph:"CONTROLS.RegionSnap"},...buildItems("draw","drawProportionally")]}},{name:"clear",title:"CONTROLS.RegionClear",icon:"fa-solid fa-trash",onClick:()=>canvas.regions.deleteAll(),button:!0}],activeTool:"select"}),e.push({name:"notes",title:"CONTROLS.GroupNotes",layer:"notes",icon:"fa-solid fa-bookmark",tools:[{name:"select",title:"CONTROLS.NoteSelect",icon:"fa-solid fa-expand"},{name:"journal",title:"NOTE.Create",visible:c.user.hasPermission("NOTE_CREATE"),icon:g.JournalEntry.sidebarIcon},{name:"toggle",title:"CONTROLS.NoteToggle",icon:"fa-solid fa-map-pin",toggle:!0,active:c.settings.get("core",NotesLayer.TOGGLE_SETTING),onClick:e=>c.settings.set("core",NotesLayer.TOGGLE_SETTING,e)},{name:"clear",title:"CONTROLS.NoteClear",icon:"fa-solid fa-trash",visible:t,onClick:()=>canvas.notes.deleteAll(),button:!0}],activeTool:"select"}),Hooks$1.callAll("getSceneControlButtons",e),e}},hotbar:class Hotbar extends Application{constructor(e){super(e),c.macros.apps.push(this),this.page=1,this.macros=[],this._collapsed=!1,this._hover=null}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"hotbar",template:"templates/hud/hotbar.html",popOut:!1,dragDrop:[{dragSelector:".macro-icon",dropSelector:"#macro-list"}]})}get locked(){return c.settings.get("core","hotbarLock")}getData(e={}){return this.macros=this._getMacrosByPage(this.page),{page:this.page,macros:this.macros,barClass:this._collapsed?"collapsed":"",locked:this.locked}}_getMacrosByPage(e){const t=c.user.getHotbarMacros(e);for(let[e,i]of t.entries())i.key=e<9?e+1:0,i.icon=i.macro?i.macro.img:null,i.cssClass=i.macro?"active":"inactive",i.tooltip=i.macro?i.macro.name:null;return t}async collapse(){if(this._collapsed)return!0;const e=this.element.find("#bar-toggle").children("i"),t=this.element.find("#action-bar");return new Promise((i=>{t.slideUp(200,(()=>{t.addClass("collapsed"),e.removeClass("fa-caret-down").addClass("fa-caret-up"),this._collapsed=!0,i(!0)}))}))}async expand(){if(!this._collapsed)return!0;const e=this.element.find("#bar-toggle").children("i"),t=this.element.find("#action-bar");return new Promise((i=>{t.slideDown(200,(()=>{t.css("display",""),t.removeClass("collapsed"),e.removeClass("fa-caret-up").addClass("fa-caret-down"),this._collapsed=!1,i(!0)}))}))}changePage(e){this.page=Math.clamp(e??1,1,5),this.render()}cyclePage(e){e=Number.isNumeric(e)?Math.sign(e):1,this.page=e>0?this.page<5?this.page+1:1:this.page>1?this.page-1:5,this.render()}activateListeners(e){super.activateListeners(e),e.find("#bar-toggle").click(this._onToggleBar.bind(this)),e.find("#macro-directory").click((e=>ui.macros.renderPopout(!0))),e.find(".macro").click(this._onClickMacro.bind(this)),e.find(".page-control").click(this._onClickPageControl.bind(this)),this._contextMenu(e)}_contextMenu(e){ContextMenu.create(this,e,".macro",this._getEntryContextOptions())}_getEntryContextOptions(){return[{name:"MACRO.Edit",icon:'<i class="fas fa-edit"></i>',condition:e=>{const t=c.macros.get(e.data("macro-id"));return!!t&&t.isOwner},callback:e=>{c.macros.get(e.data("macro-id")).sheet.render(!0)}},{name:"MACRO.Remove",icon:'<i class="fas fa-times"></i>',condition:e=>!!e.data("macro-id"),callback:e=>c.user.assignHotbarMacro(null,Number(e.data("slot")))},{name:"MACRO.Delete",icon:'<i class="fas fa-trash"></i>',condition:e=>{const t=c.macros.get(e.data("macro-id"));return!!t&&t.isOwner},callback:e=>{const t=c.macros.get(e.data("macro-id"));return Dialog.confirm({title:`${c.i18n.localize("MACRO.Delete")} ${t.name}`,content:`<h4>${c.i18n.localize("AreYouSure")}</h4><p>${c.i18n.localize("MACRO.DeleteWarning")}</p>`,yes:t.delete.bind(t)})}}]}async _onClickMacro(e){e.preventDefault();const t=e.currentTarget;if(!t.classList.contains("inactive")){return c.macros.get(t.dataset.macroId).execute()}{const e=getDocumentClass("Macro"),i=new e({name:e.defaultName({type:"chat"}),type:"chat",scope:"global"});i.sheet._hotbarSlot=t.dataset.slot,i.sheet.render(!0)}}_onClickPageControl(e){switch(e.currentTarget.dataset.action){case"page-up":this.cyclePage(1);break;case"page-down":this.cyclePage(-1);break;case"lock":this._toggleHotbarLock()}}_canDragStart(e){return!this.locked}_onDragStart(e){const t=e.currentTarget.closest(".macro"),i=c.macros.get(t.dataset.macroId);if(!i)return!1;const n=foundry.utils.mergeObject(i.toDragData(),{slot:t.dataset.slot});e.dataTransfer.setData("text/plain",JSON.stringify(n))}_canDragDrop(e){return!0}async _onDrop(e){e.preventDefault();const t=e.target.closest(".macro"),i=Number(t.dataset.slot),n=TextEditor$1.getDragEventData(e);if(!1===Hooks$1.call("hotbarDrop",this,n,i))return;if(c.macros.get(c.user.hotbar[i])&&this.locked)return ui.notifications.warn("MACRO.CannotOverwrite",{localize:!0});const s=getDocumentClass(n.type),o=await(s?.fromDropData(n));if(!o)return;let r;return r="Macro"===n.type?c.macros.has(o.id)?o:await s.create(o.toObject()):"RollTable"===n.type?await this._createRollTableRollMacro(o):await this._createDocumentSheetToggle(o),r?c.user.assignHotbarMacro(r,i,{fromSlot:n.slot}):void 0}async _createRollTableRollMacro(e){const t=`const table = await fromUuid("${e.uuid}");\nawait table.draw();`;return Macro.implementation.create({name:`${c.i18n.localize("TABLE.Roll")} ${e.name}`,type:"script",img:e.img,command:t})}async _createDocumentSheetToggle(e){const t=e.name||`${c.i18n.localize(e.constructor.metadata.label)} ${e.id}`;return Macro.implementation.create({name:`${c.i18n.localize("Display")} ${t}`,type:CONST.MACRO_TYPES.SCRIPT,img:"icons/svg/book.svg",command:`await Hotbar.toggleDocumentSheet("${e.uuid}");`})}_onToggleBar(e){return e.preventDefault(),this._collapsed?this.expand():this.collapse()}async _toggleHotbarLock(){return await c.settings.set("core","hotbarLock",!this.locked),this.render()}static async toggleDocumentSheet(e){const t=await fromUuid(e);if(!t)return ui.notifications.warn(c.i18n.format("WARNING.ObjectDoesNotExist",{name:c.i18n.localize("Document"),identifier:e}));const i=t.sheet;return i.rendered?i.close():i.render(!0)}},items:class ItemDirectory extends DocumentDirectory{static documentName="Item";_canDragDrop(e){return c.user.can("ITEM_CREATE")}_getEntryContextOptions(){const e=super._getEntryContextOptions();return[{name:"ITEM.ViewArt",icon:'<i class="fas fa-image"></i>',condition:e=>c.items.get(e.data("documentId")).img!==CONST.DEFAULT_TOKEN,callback:e=>{const t=c.items.get(e.data("documentId"));new ImagePopout(t.img,{title:t.name,uuid:t.uuid}).render(!0)}}].concat(e)}},journal:class JournalDirectory extends DocumentDirectory{static documentName="JournalEntry";_getEntryContextOptions(){return super._getEntryContextOptions().concat([{name:"SIDEBAR.JumpPin",icon:'<i class="fas fa-crosshairs"></i>',condition:e=>!!c.journal.get(e.data("document-id")).sceneNote,callback:e=>c.journal.get(e.data("document-id")).panToNote()}])}},macros:class MacroDirectory extends DocumentDirectory{constructor(e={}){e.popOut=!0,super(e),delete ui.sidebar.tabs.macros,c.macros.apps.push(this)}static documentName="Macro"},players:class PlayerList extends Application{constructor(e){super(e),c.users.apps.push(this),this._showOffline=!1}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"players",template:"templates/user/players.html",popOut:!1})}get isHidden(){if(c.webrtc.mode===AVSettings.AV_MODES.DISABLED)return!1;const{client:e,verticalDock:t}=c.webrtc.settings;return t&&e.hidePlayerList&&!e.hideDock&&!ui.webrtc.hidden}render(e,t={}){this._positionInDOM();const{renderContext:i,renderData:n}=t;if(i){if(!["createUser","updateUser","deleteUser"].includes(i))return this;if("updateUser"===i){const e=["name","pronouns","ownership","ownership.default","active","navigation"];if(!n.some((t=>e.some((e=>e in t)))))return this}}return super.render(e,t)}getData(e={}){return{users:c.users.filter((e=>this._showOffline||e.active)).map((e=>{const t=e.toObject(!1);return t.active=e.active,t.isGM=e.isGM,t.isSelf=e.isSelf,t.charname=e.character?.name.split(" ")[0]||"",t.color=t.active?t.color.css:"#333333",t.border=t.active?e.border.css:"#000000",t.displayName=this._getDisplayName(t),t})).sort(((e,t)=>t.role>=CONST.USER_ROLES.ASSISTANT&&t.role>e.role?1:e.name.localeCompare(t.name,c.i18n.lang))),hide:this.isHidden,showOffline:this._showOffline}}_getDisplayName(e){const t=[e.name];return e.pronouns&&t.push(`(${e.pronouns})`),e.isGM?t.push(`[${c.i18n.localize("USER.GM")}]`):e.charname&&t.push(`[${e.charname}]`),t.join(" ")}_positionInDOM(){if(document.body.classList.toggle("players-hidden",this.isHidden),c.webrtc.mode===AVSettings.AV_MODES.DISABLED||this.isHidden||!this.element.length)return;const e=this.element[0],t=ui.webrtc.element[0],i=document.getElementById("ui-top"),n=document.getElementById("ui-left"),{client:s,verticalDock:o}=c.webrtc.settings,r=o&&!s.hideDock&&!ui.webrtc.hidden;r&&!t?.contains(e)?(t.appendChild(e),i.classList.remove("offset")):r||n.contains(e)||(n.appendChild(e),i.classList.add("offset"))}activateListeners(e){e.find("h3").click(this._onToggleOfflinePlayers.bind(this));const t=this._getUserContextOptions();Hooks$1.call("getUserContextOptions",e,t),new ContextMenu(e,".player",t)}_getUserContextOptions(){return[{name:c.i18n.localize("PLAYERS.ConfigTitle"),icon:'<i class="fas fa-male"></i>',condition:e=>c.user.isGM||e[0].dataset.userId===c.user.id,callback:e=>{const t=c.users.get(e[0].dataset.userId);t?.sheet.render(!0)}},{name:c.i18n.localize("PLAYERS.ViewAvatar"),icon:'<i class="fas fa-image"></i>',condition:e=>c.users.get(e[0].dataset.userId).avatar!==CONST.DEFAULT_TOKEN,callback:e=>{let t=c.users.get(e.data("user-id"));new ImagePopout(t.avatar,{title:t.name,uuid:t.uuid}).render(!0)}},{name:c.i18n.localize("PLAYERS.PullToScene"),icon:'<i class="fas fa-directions"></i>',condition:e=>c.user.isGM&&e[0].dataset.userId!==c.user.id,callback:e=>c.socket.emit("pullToScene",canvas.scene.id,e.data("user-id"))},{name:c.i18n.localize("PLAYERS.Kick"),icon:'<i class="fas fa-door-open"></i>',condition:e=>{const t=c.users.get(e[0].dataset.userId);return c.user.isGM&&t.active&&!t.isSelf},callback:e=>{const t=c.users.get(e[0].dataset.userId);return this.#Qc(t)}},{name:c.i18n.localize("PLAYERS.Ban"),icon:'<i class="fas fa-ban"></i>',condition:e=>{const t=c.users.get(e[0].dataset.userId);return c.user.isGM&&!t.isSelf&&t.role!==CONST.USER_ROLES.NONE},callback:e=>{const t=c.users.get(e[0].dataset.userId);return this.#Zc(t)}},{name:c.i18n.localize("PLAYERS.UnBan"),icon:'<i class="fas fa-ban"></i>',condition:e=>{const t=c.users.get(e[0].dataset.userId);return c.user.isGM&&!t.isSelf&&t.role===CONST.USER_ROLES.NONE},callback:e=>{const t=c.users.get(e[0].dataset.userId);return this.#ed(t)}},{name:c.i18n.localize("WEBRTC.TooltipShowUser"),icon:'<i class="fas fa-eye"></i>',condition:e=>{const t=e.data("userId");return c.webrtc.settings.client.users[t]?.blocked},callback:async e=>{const t=e.data("userId");await c.webrtc.settings.set("client",`users.${t}.blocked`,!1),ui.webrtc.render()}}]}_onToggleOfflinePlayers(e){e.preventDefault(),this._showOffline=!this._showOffline,this.render()}async#Qc(e){const t=e.role;await e.update({role:CONST.USER_ROLES.NONE}),await e.update({role:t},{diff:!1}),ui.notifications.info(`${e.name} has been <strong>kicked</strong> from the World.`)}async#Zc(e){e.role!==CONST.USER_ROLES.NONE&&(await e.update({role:CONST.USER_ROLES.NONE}),ui.notifications.info(`${e.name} has been <strong>banned</strong> from the World.`))}async#ed(e){e.role===CONST.USER_ROLES.NONE&&(await e.update({role:CONST.USER_ROLES.PLAYER}),ui.notifications.info(`${e.name} has been <strong>unbanned</strong> from the World.`))}},playlists:PlaylistDirectory,scenes:class SceneDirectory extends DocumentDirectory{static documentName="Scene";static entryPartial="templates/sidebar/scene-partial.html";static get defaultOptions(){const e=super.defaultOptions;return e.renderUpdateKeys.push("background"),e}async _render(e,t){if(c.user.isGM)return super._render(e,t)}_getEntryContextOptions(){let e=super._getEntryContextOptions();return e=[{name:"SCENES.View",icon:'<i class="fas fa-eye"></i>',condition:e=>!canvas.ready||e.data("documentId")!==canvas.scene.id,callback:e=>{c.scenes.get(e.data("documentId")).view()}},{name:"SCENES.Activate",icon:'<i class="fas fa-bullseye"></i>',condition:e=>c.user.isGM&&!c.scenes.get(e.data("documentId")).active,callback:e=>{c.scenes.get(e.data("documentId")).activate()}},{name:"SCENES.Configure",icon:'<i class="fas fa-cogs"></i>',callback:e=>{c.scenes.get(e.data("documentId")).sheet.render(!0)}},{name:"SCENES.Notes",icon:'<i class="fas fa-scroll"></i>',condition:e=>!!c.scenes.get(e.data("documentId")).journal,callback:e=>{const t=c.scenes.get(e.data("documentId")),i=t.journal;if(i){const e=i.sheet,n={};t.journalEntryPage&&(n.pageId=t.journalEntryPage),e.render(!0,n)}}},{name:"SCENES.ToggleNav",icon:'<i class="fas fa-compass"></i>',condition:e=>{const t=c.scenes.get(e.data("documentId"));return c.user.isGM&&!t.active},callback:e=>{const t=c.scenes.get(e.data("documentId"));t.update({navigation:!t.navigation})}},{name:"SCENES.GenerateThumb",icon:'<i class="fas fa-image"></i>',condition:e=>{const t=c.scenes.get(e[0].dataset.documentId);return(t.background.src||t.tiles.size)&&!c.settings.get("core","noCanvas")},callback:e=>{const t=c.scenes.get(e[0].dataset.documentId);t.createThumbnail().then((e=>{t.update({thumb:e.thumb},{diff:!1}),ui.notifications.info(c.i18n.format("SCENES.GenerateThumbSuccess",{name:t.name}))})).catch((e=>ui.notifications.error(e.message)))}}].concat(e),e.findSplice((e=>"OWNERSHIP.Configure"===e.name)),e}_getFolderContextOptions(){const e=super._getFolderContextOptions();return e.findSplice((e=>"OWNERSHIP.Configure"===e.name)),e}},settings:class Settings extends SidebarTab{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"settings",template:"templates/sidebar/settings.html",title:"Settings"})}async getData(e={}){const t=await super.getData(e);let i,n;c.user.isGM&&c.data.coreUpdate.hasUpdate&&(i=c.i18n.format("SETUP.UpdateAvailable",{type:c.i18n.localize("Software"),channel:c.data.coreUpdate.channel,version:c.data.coreUpdate.version})),c.user.isGM&&c.data.systemUpdate.hasUpdate&&(n=c.i18n.format("SETUP.UpdateAvailable",{type:c.i18n.localize("System"),channel:c.data.system.title,version:c.data.systemUpdate.version}));const s=CONST.WORLD_DOCUMENT_TYPES.reduce(((e,t)=>e+g[t].collection.instance.invalidDocumentIds.size),0)+Object.values(c.issues.packageCompatibilityIssues).reduce(((e,{error:t})=>e+t.length),0)+Object.keys(c.issues.usabilityIssues).length,o=c.data.demoMode;return foundry.utils.mergeObject(t,{system:c.system,release:c.data.release,versionDisplay:c.release.display,canConfigure:c.user.can("SETTINGS_MODIFY")&&!o,canEditWorld:c.user.hasRole("GAMEMASTER")&&!o,canManagePlayers:c.user.isGM&&!o,canReturnSetup:c.user.hasRole("GAMEMASTER")&&!o,modules:c.modules.reduce(((e,t)=>e+(t.active?1:0)),0),issues:s,isDemo:o,coreUpdate:i,systemUpdate:n})}activateListeners(e){e.find("button[data-action]").click(this._onSettingsButton.bind(this)),e.find(".notification-pip.update").click(this._onUpdateNotificationClick.bind(this))}_onSettingsButton(e){e.preventDefault();switch(e.currentTarget.dataset.action){case"configure":c.settings.sheet.render(!0);break;case"modules":(new ModuleManagement).render(!0);break;case"world":new WorldConfig(c.world).render(!0);break;case"players":return ui.menu.items.players.onClick();case"setup":return c.shutDown();case"support":(new SupportDetails).render(!0);break;case"controls":(new KeybindingsConfig).render(!0);break;case"tours":(new ToursManagement).render(!0);break;case"docs":new FrameViewer("https://foundryvtt.com/kb",{title:"SIDEBAR.Documentation"}).render(!0);break;case"wiki":new FrameViewer("https://foundryvtt.wiki/",{title:"SIDEBAR.Wiki"}).render(!0);break;case"invitations":(new InvitationLinks).render(!0);break;case"logout":return ui.menu.items.logout.onClick()}}_onUpdateNotificationClick(e){e.preventDefault();const t="core-update"===e.target.dataset.action?"CoreUpdateInstructions":"SystemUpdateInstructions";ui.notifications.notify(c.i18n.localize(`SETUP.${t}`))}},tables:class RollTableDirectory extends DocumentDirectory{static documentName="RollTable";_getEntryContextOptions(){let e=super._getEntryContextOptions();return e=[{name:"TABLE.Roll",icon:'<i class="fas fa-dice-d20"></i>',callback:e=>{c.tables.get(e.data("documentId")).draw({roll:!0,displayChat:!0})}}].concat(e),e}},webrtc:class CameraViews extends Application{constructor(e={}){"width"in e||(e.width=c.webrtc?.settings.client.dockWidth||240),super(e),c.webrtc?.settings.client.dockPosition===AVSettings.DOCK_POSITIONS.RIGHT&&(this.options.resizable.rtl=!0)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"camera-views",template:"templates/hud/camera-views.html",popOut:!1,width:240,resizable:{selector:".camera-view-width-control",resizeY:!1}})}get webrtc(){return c.webrtc}get hidden(){return this.webrtc.client.getConnectedUsers().reduce(((e,t)=>{const i=this.webrtc.settings.users[t];return e&&(i.blocked||i.popout)}),!0)}getUserCameraView(e){return this.element.find(`.camera-view[data-user=${e}]`)[0]||null}getUserVideoElement(e){return this.element.find(`.camera-view[data-user=${e}] video.user-camera`)[0]||null}setUserIsSpeaking(e,t){const i=this.getUserCameraView(e);i&&i.classList.toggle("speaking",t)}render(e,t={}){const{renderContext:i,renderData:n}=t;if(this.webrtc.mode===AVSettings.AV_MODES.DISABLED)return this;if(i){if("updateUser"!==i)return this;if(!["name","permissions","role","active","color","sort","character","avatar"].some((e=>n.hasOwnProperty(e))))return this}return super.render(e,t)}async _render(e=!1,t={}){await super._render(e,t),this.webrtc.onRender()}setPosition({left:e,top:t,width:i,scale:n}={}){const s=super.setPosition({left:e,top:t,width:i,height:"auto",scale:n});if(foundry.utils.isEmpty(s))return s;const o=c.webrtc.settings.client;return c.webrtc.settings.verticalDock&&(o.dockWidth=i,c.webrtc.settings.set("client","dockWidth",i)),s}getData(e={}){const t=this.webrtc.settings,i=t.users,n=this.webrtc.client.getConnectedUsers().reduce(((e,t)=>{const n=this._getDataForUser(t,i[t]);return n&&!i[t].blocked&&e.push(n),e}),[]);n.sort(this.constructor._sortUsers),this.maxZ=Math.max(...n.map((e=>i[e.user.id].z)));const s=[`camera-position-${t.client.dockPosition}`];n.some((e=>!e.settings.popout))||s.push("webrtc-dock-empty"),t.client.hideDock&&s.push("webrtc-dock-minimized"),this.hidden&&s.push("hidden");const o=!t.client.hidePlayerList||t.client.hideDock;document.body.classList.toggle("players-hidden",o);const r=AVSettings.NAMEPLATE_MODES,a=t.client.nameplates??r.BOTH,l={cssClass:[a===r.OFF?"hidden":"",[r.PLAYER_ONLY,r.CHAR_ONLY].includes(a)?"noanimate":""].filterJoin(" "),playerName:[r.BOTH,r.PLAYER_ONLY].includes(a),charname:[r.BOTH,r.CHAR_ONLY].includes(a)};return{self:c.user,muteAll:t.muteAll,borderColors:t.client.borderColors,dockClass:s.join(" "),hidden:this.hidden,users:n,nameplates:l}}_getDataForUser(e,t){const i=c.users.get(e);if(!i||!i.active)return null;const n=i.character?i.character.name.split(" ")[0]:"",s=t.popout?"camera-box-popout":"camera-box-dock",o=this.webrtc.canUserShareAudio(e)?null:"no-audio",r=this.webrtc.canUserShareVideo(e)?null:"no-video";return{user:i,settings:t,local:i.isSelf,charname:i.isGM?c.i18n.localize("USER.GM"):n,volume:foundry.audio.AudioHelper.volumeToInput(t.volume),cameraViewClass:[s,r,o].filterJoin(" ")}}static _sortUsers(e,t){const i=e.settings,n=t.settings;return i.popout&&n.popout?i.z-n.z:i.popout?-1:n.popout?1:e.user.isSelf?-1:t.user.isSelf?1:e.hasVideo&&!t.hasVideo?-1:t.hasVideo&&!e.hasVideo?1:e.user.sort-t.user.sort}activateListeners(e){let t=this._onCameraViewHover.bind(this);e.find(".camera-view").hover(t,t),e.find(".av-control").click(this._onClickControl.bind(this)),e.find(".webrtc-volume-slider").change(this._onVolumeChange.bind(this)),this._refreshView(e.find(".user-controls")[0]?.dataset.user);const i=this.webrtc.mode;i===AVSettings.AV_MODES.VIDEO&&e.find('[data-action="toggle-audio"]').hide(),i===AVSettings.AV_MODES.AUDIO&&e.find('[data-action="toggle-video"]').hide();for(let e of this.element.find(".app.camera-view-popout")){let t=e.querySelector(".camera-view");new CameraPopoutAppWrapper(this,t.dataset.user,$(e))}for(let e of this.element.find("video")){const t=e.closest(".camera-view");this._refreshView(t.dataset.user),e.addEventListener("webrtcVideoSet",(t=>{const i=e.closest(".camera-view");i.dataset.user===t.detail&&this._refreshView(i.dataset.user)}))}}_onCameraViewHover(e){this._toggleControlVisibility(e.currentTarget,"mouseenter"===e.type,null)}async _onClickControl(e){e.preventDefault();const t=e.currentTarget,i=t.dataset.action,n=t.closest(".camera-view, .user-controls")?.dataset.user,s=c.users.get(n),o=this.webrtc.settings,r=o.getUser(s.id);switch(i){case"block-video":if(!c.user.isGM)return;return await s.update({"permissions.BROADCAST_VIDEO":!r.canBroadcastVideo}),this._refreshView(n);case"block-audio":if(!c.user.isGM)return;return await s.update({"permissions.BROADCAST_AUDIO":!r.canBroadcastAudio}),this._refreshView(n);case"hide-user":if(s.isSelf)return;return await o.set("client",`users.${s.id}.blocked`,!r.blocked),this.render();case"toggle-video":if(!s.isSelf)return;return r.hidden&&!r.canBroadcastVideo?ui.notifications.warn("WEBRTC.WarningCannotEnableVideo",{localize:!0}):(await o.set("client",`users.${s.id}.hidden`,!r.hidden),this._refreshView(n));case"toggle-audio":if(!s.isSelf)return;return r.muted&&!r.canBroadcastAudio?ui.notifications.warn("WEBRTC.WarningCannotEnableAudio",{localize:!0}):(await o.set("client",`users.${s.id}.muted`,!r.muted),this._refreshView(n));case"mute-peers":if(!s.isSelf)return;return await o.set("client","muteAll",!o.client.muteAll),this._refreshView(n);case"disable-video":if(!s.isSelf)return;return await o.set("client","disableVideo",!o.client.disableVideo),this._refreshView(n);case"configure":return this.webrtc.config.render(!0);case"toggle-popout":return await o.set("client",`users.${s.id}.popout`,!r.popout),this.render();case"toggle-players":return await o.set("client","hidePlayerList",!o.client.hidePlayerList),this.render();case"toggle-dock":return await o.set("client","hideDock",!o.client.hideDock),this.render()}}_onVolumeChange(e){const t=e.currentTarget,i=t.closest(".camera-view"),n=i.dataset.user;let s=foundry.audio.AudioHelper.inputToVolume(t.value);i.getElementsByTagName("video")[0].volume=s,this.webrtc.settings.set("client",`users.${n}.volume`,s)}_refreshView(e){const t=this.element[0].querySelector(`.camera-view[data-user="${e}"]`),i=c.user.id===e,n=c.webrtc.settings.client,s=c.webrtc.settings.getUser(e),o=n.hideDock,r=c.webrtc.settings.verticalDock,a=c.webrtc.canUserBroadcastVideo(e),l=c.webrtc.canUserShareVideo(e),d=c.webrtc.canUserBroadcastAudio(e),u=c.webrtc.canUserShareAudio(e),h=t.querySelector("video.user-camera"),p=t.querySelector("img.user-avatar");if(h&&p){const e=l&&(i||!n.disableVideo)&&(!o||s.popout);h.style.visibility=e?"visible":"hidden",h.style.display=e?"block":"none",p.style.display=e?"none":"unset"}t.querySelector(".status-hidden")?.classList.toggle("hidden",l),t.querySelector(".status-muted")?.classList.toggle("hidden",u),h&&(h.volume=s.volume,h.muted=i||n.muteAll);const g=this.element[0].querySelector(`[data-user="${e}"] .volume-bar`);if(g){const t=e!==c.user.id&&d;g.style.display=t?"block":"none",g.disabled=!t}const m={"block-video":{state:!a,display:c.user.isGM&&!i},"block-audio":{state:!d,display:c.user.isGM&&!i},"hide-user":{state:!s.blocked,display:!i},"toggle-video":{state:!l,display:i&&!o},"toggle-audio":{state:!u,display:i},"mute-peers":{state:n.muteAll,display:i},"disable-video":{state:n.disableVideo,display:i&&!o},"toggle-players":{state:!n.hidePlayerList,display:i&&!o&&r},"toggle-dock":{state:!n.hideDock,display:i}},v=this.element[0].querySelectorAll(`[data-user="${e}"] .av-control.toggle`);for(let e of v){const t=e.dataset.action;if(!(t in m))continue;const i=m[t].state,n=m[t].display;e.style.display=n?"block":"none",e.enabled=n,e.children[0].classList.remove(this._getToggleIcon(t,!i)),e.children[0].classList.add(this._getToggleIcon(t,i)),e.dataset.tooltip=this._getToggleTooltip(t,i)}}_setPlayerListVisibility(){const e=this.webrtc.settings.client.hidePlayerList,t=document.getElementById("players"),i=document.getElementById("ui-top");t&&t.classList.toggle("hidden",e),i&&i.classList.toggle("offset",!e)}_getToggleIcon(e,t){const i=c.webrtc.settings.client,n=AVSettings.DOCK_POSITIONS,s={[n.TOP]:{collapse:"down",expand:"up"},[n.RIGHT]:{collapse:"left",expand:"right"},[n.BOTTOM]:{collapse:"up",expand:"down"},[n.LEFT]:{collapse:"right",expand:"left"}}[i.dockPosition],o={"block-video":["fa-video","fa-video-slash"],"block-audio":["fa-microphone","fa-microphone-slash"],"hide-user":["fa-eye","fa-eye-slash"],"toggle-video":["fa-camera-web","fa-camera-web-slash"],"toggle-audio":["fa-microphone","fa-microphone-slash"],"mute-peers":["fa-volume-up","fa-volume-mute"],"disable-video":["fa-video","fa-video-slash"],"toggle-players":["fa-caret-square-right","fa-caret-square-left"],"toggle-dock":[`fa-caret-square-${s.collapse}`,`fa-caret-square-${s.expand}`]}[e];return o?o[t?1:0]:null}_getToggleTooltip(e,t){const i={"block-video":["BlockUserVideo","AllowUserVideo"],"block-audio":["BlockUserAudio","AllowUserAudio"],"hide-user":["ShowUser","HideUser"],"toggle-video":["DisableMyVideo","EnableMyVideo"],"toggle-audio":["DisableMyAudio","EnableMyAudio"],"mute-peers":["MutePeers","UnmutePeers"],"disable-video":["DisableAllVideo","EnableVideo"],"toggle-players":["ShowPlayers","HidePlayers"],"toggle-dock":["ExpandDock","MinimizeDock"]}[e];return c.i18n.localize(`WEBRTC.Tooltip${i?i[t?1:0]:""}`)}_toggleControlVisibility(e,t,i){i=i||".control-bar",e.querySelectorAll(i).forEach((e=>e.classList.toggle("hidden",!t)))}}}};Object.defineProperty(g.Token,"ring",{value:new foundry.canvas.tokens.TokenRingConfig,enumerable:!0}),["Actor","Item","JournalEntryPage","Cards","Card"].forEach((e=>{const t=`You are accessing CONFIG.${e}.systemDataModels which is deprecated. Please use CONFIG.${e}.dataModels instead.`;Object.defineProperty(g[e],"systemDataModels",{enumerable:!1,get:()=>(foundry.utils.logCompatibilityWarning(t,{since:11,until:13}),g[e].dataModels),set(i){foundry.utils.logCompatibilityWarning(t,{since:11,until:13}),g[e].dataModels=i}})})),Object.defineProperty(g.Canvas,"losBackend",{get:()=>(foundry.utils.logCompatibilityWarning("You are accessing CONFIG.Canvas.losbackend, which is deprecated. Use CONFIG.Canvas.polygonBackends.sight instead.",{since:11,until:13}),g.Canvas.polygonBackends.sight),set(e){foundry.utils.logCompatibilityWarning("You are setting CONFIG.Canvas.losbackend, which is deprecated. Use CONFIG.Canvas.polygonBackends[type] instead.",{since:11,until:13});for(const t of Object.keys(g.Canvas.polygonBackends))g.Canvas.polygonBackends[t]=e}}),console.log(CONST.ASCII),globalThis.Hooks=Hooks$1,globalThis.TextEditor=TextEditor$1,globalThis.SortingHelpers=SortingHelpers,DocumentSheetConfig._registerDefaultSheets(),window.addEventListener("DOMContentLoaded",(async function(){const e=new URL(window.location.href).pathname.split("/").pop(),t=Game.getCookies().session??null;if(!t)return window.location.href=foundry.utils.getRoute("join");console.log(`${l} | Reestablishing existing session ${t}`);const i=globalThis.ROUTE_PREFIX?.replace(/(^[/]+)|([/]+$)/g,""),n=i?`${window.location.origin}/${i}`:window.location.origin;return await PIXI.Assets.init({basePath:n,preferences:{defaultAutoPlay:!1}}),CONST.SETUP_VIEWS.includes(e)?c=globalThis.game=await Setup.create(e,t):CONST.GAME_VIEWS.includes(e)&&(c=globalThis.game=await Game.create(e,t)),globalThis.game.initialize()}),{once:!0,passive:!0});class CanvasTour extends Tour{async start(){c.togglePause(!1),await super.start()}get canStart(){return!!canvas.scene}async _preStep(){await super._preStep(),this.#td()}#td(){if("layer"in this.currentStep&&canvas.scene){const e=canvas[this.currentStep.layer];e.active?ui.controls.initialize({tool:this.currentStep.tool}):e.activate({tool:this.currentStep.tool})}}}class SetupTour extends Tour{focusedApp;get canStart(){return"setup"===c.view}get steps(){return this.config.steps}async _preStep(){if(await super._preStep(),0===this.stepIndex&&!1!==this.config.closeWindows)for(const e of Object.values(ui.windows))e.close();switch(this.id){case"installingASystem":return this._installingASystem();case"creatingAWorld":return this._creatingAWorld()}}async _installingASystem(){"systemsTab"===this.currentStep.id?(ui.setupPackages.activateTab("systems"),Setup.warmPackages({type:"system"})):"searching"===this.currentStep.id&&await Setup.browsePackages("system",{search:"Simple Worldbuilding"})}async _creatingAWorld(){if("worldTab"===this.currentStep.id)ui.setupPackages.activateTab("world");else if("worldTitle"===this.currentStep.id){let e=new World({name:"my-first-world",title:"My First World",system:Array.from(c.systems)[0].id,coreVersion:c.release.version,description:c.i18n.localize("SETUP.NueWorldDescription")});const t={create:!0};this.focusedApp=new WorldConfig(e,t),await this.focusedApp._render(!0)}else"launching"===this.currentStep.id&&await this.focusedApp.submit()}}class SidebarTour extends Tour{async start(){c.togglePause(!1),await super.start()}async _preStep(){await super._preStep(),"sidebar"!==this.id&&"welcome"!==this.id||await this._updateSidebarTab()}async _updateSidebarTab(){this.currentStep.sidebarTab&&ui.sidebar.activateTab(this.currentStep.sidebarTab)}}let m=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{m=class RollHandler extends e.api.RollHandler{async handleActionClick(e,t){const[i,n]=t.split("|");if(["item"].includes(i)&&this.isRenderItem())return this.doRenderItem(this.actor,n);const s=["character"];if(this.actor)return void await this.#id(e,this.actor,this.token,i,n);const o=canvas.tokens.controlled.filter((e=>s.includes(e.actor?.type)));for(const t of o){const s=t.actor;await this.#id(e,s,t,i,n)}}async handleActionHover(e,t){}async handleGroupClick(e,t){}async#id(e,t,i,n,s){switch(n){case"item":this.#nd(e,t,s);break;case"utility":this.#sd(i,s)}}#nd(e,t,i){t.items.get(i).toChat(e)}async#sd(e,t){if("endTurn"===t)game.combat?.current?.tokenId===e.id&&await(game.combat?.nextTurn())}}}));let v=null;function register(t){game.settings.register(e.ID,"displayUnequipped",{name:game.i18n.localize("tokenActionHud.template.settings.displayUnequipped.name"),hint:game.i18n.localize("tokenActionHud.template.settings.displayUnequipped.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{t(e)}})}Hooks.once("tokenActionHudCoreApiReady",(async e=>{const t=s;Object.values(t).forEach((t=>{t.name=e.api.Utils.i18n(t.name),t.listName=`Group: ${e.api.Utils.i18n(t.listName??t.name)}`}));const i=Object.values(t);v={layout:[{nestId:"abilities",id:"abilities",name:e.api.Utils.i18n("tokenActionHud.abfalter.abilities"),groups:[{...t.abilities,nestId:"abilities_regular"},{...t["fav-abilities"],nestId:"abilities_fav"}]}],groups:i}}));let y=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{y=class SystemManager extends t.api.SystemManager{getActionHandler(){return console.log("DEV: returns actionhandler"),new a}getAvailableRollHandlers(){return{core:"Core abfalter"}}getRollHandler(e){let t;return t=new m,t}async registerDefaults(){return v}registerSettings(e){register(e)}registerStyles(){return{template:{class:"tah-style-template-style",file:"tah-template-style",moduleId:e.ID,name:"Template Style"}}}}})),Hooks.on("tokenActionHudCoreApiReady",(async()=>{console.log("DEV: hooks action HUD core api ready");const t=game.modules.get(e.ID);t.api={requiredCoreModuleVersion:"2.0",SystemManager:y},Hooks.call("tokenActionHudSystemReady",t)}));export{n as ACTION_TYPE,a as ActionHandler,t as CORE_MODULE,v as DEFAULTS,s as GROUP,o as ITEM_TYPE,e as MODULE,i as REQUIRED_CORE_MODULE_VERSION,m as RollHandler,y as SystemManager,r as Utils,register};
//# sourceMappingURL=token-action-hud-abfalter.min.js.map
